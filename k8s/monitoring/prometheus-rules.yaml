apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: prometheus-rules
spec:
  groups:
  - name: pgben-alerts
    rules:
    - alert: HighErrorRate
      expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.05
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "High error rate detected"
        description: "Error rate is above 5% for 5 minutes"
        
    - alert: DeploymentReplicasMismatch
      expr: |
        kube_deployment_spec_replicas{deployment="pgben-server"}
          !=
        kube_deployment_status_replicas_available{deployment="pgben-server"}
      for: 5m
      labels:
        severity: critical
        team: devops
      annotations:
        summary: "Deployment replicas mismatch"
        description: "Deployment {{ $labels.deployment }} has not matched the expected number of replicas for 5 minutes."
        runbook_url: "https://wiki.semtas.local/ops/alerts/deployment-replicas-mismatch"

    - alert: DeploymentNotProgressing
      expr: |
        kube_deployment_status_condition{
          deployment="pgben-server",
          condition="Progressing",
          status="false"
        } == 1
      for: 10m
      labels:
        severity: critical
        team: devops
      annotations:
        summary: "Deployment not progressing"
        description: "Deployment {{ $labels.deployment }} is not progressing for more than 10 minutes."
        runbook_url: "https://wiki.semtas.local/ops/alerts/deployment-not-progressing"

    - alert: PodCrashLooping
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="pgben"}[5m]) > 0.2
      for: 5m
      labels:
        severity: critical
        team: devops
      annotations:
        summary: "Pod is crash looping"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping."
        runbook_url: "https://wiki.semtas.local/ops/alerts/pod-crash-looping"

    - alert: PodNotReady
      expr: |
        sum by (namespace, pod) (kube_pod_status_phase{namespace="pgben", phase=~"Pending|Unknown"}) > 0
      for: 15m
      labels:
        severity: critical
        team: devops
      annotations:
        summary: "Pod not ready"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been in a non-ready state for more than 15 minutes."
        runbook_url: "https://wiki.semtas.local/ops/alerts/pod-not-ready"

    - alert: ContainerHighCpuUsage
      expr: |
        sum by (namespace, pod, container) (
          rate(container_cpu_usage_seconds_total{namespace="pgben", container="pgben-server"}[5m])
        ) > 0.8
      for: 10m
      labels:
        severity: warning
        team: devops
      annotations:
        summary: "Container high CPU usage"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} has high CPU usage (> 80%) for more than 10 minutes."
        runbook_url: "https://wiki.semtas.local/ops/alerts/container-high-cpu-usage"

    - alert: ContainerHighMemoryUsage
      expr: |
        sum by (namespace, pod, container) (
          container_memory_usage_bytes{namespace="pgben", container="pgben-server"}
        ) / sum by (namespace, pod, container) (
          container_spec_memory_limit_bytes{namespace="pgben", container="pgben-server"}
        ) > 0.8
      for: 10m
      labels:
        severity: warning
        team: devops
      annotations:
        summary: "Container high memory usage"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} has high memory usage (> 80%) for more than 10 minutes."
        runbook_url: "https://wiki.semtas.local/ops/alerts/container-high-memory-usage"
        
    # Alerta para latência alta na API
      - alert: ApiHighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="pgben-api"}[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Latência alta na API"
          description: "O percentil 95 da latência da API está acima de 2 segundos nos últimos 5 minutos."
          
      # Alerta para muitas requisições em andamento
      - alert: ApiTooManyRequests
        expr: sum(http_requests_in_progress{job="pgben-api"}) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Muitas requisições em andamento"
          description: "Há mais de 100 requisições em andamento na API."

  security_alerts.yml: |
    groups:
    - name: security_alerts
      rules:
      # Alerta para alto número de falhas de autenticação
      - alert: HighAuthenticationFailures
        expr: sum(rate(authentication_attempts_total{job="pgben-security-metrics", success="false"}[15m])) > 10
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Alto número de falhas de autenticação"
          description: "Foram detectadas mais de 10 falhas de autenticação por minuto nos últimos 15 minutos."
          
      # Alerta para alto número de falhas de autorização
      - alert: HighAuthorizationFailures
        expr: sum(rate(authorization_failures_total{job="pgben-security-metrics"}[15m])) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Alto número de falhas de autorização"
          description: "Foram detectadas mais de 5 falhas de autorização por minuto nos últimos 15 minutos."
          
      # Alerta para acessos não autorizados a dados LGPD
      - alert: UnauthorizedLgpdDataAccess
        expr: sum(rate(lgpd_data_access_total{job="pgben-security-metrics", authorized="false"}[5m])) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Acessos não autorizados a dados LGPD"
          description: "Foram detectados acessos não autorizados a dados protegidos pela LGPD."

  document_alerts.yml: |
    groups:
    - name: document_alerts
      rules:
      # Alerta para falhas em operações com documentos sensíveis
      - alert: SensitiveDocumentOperationFailures
        expr: sum(rate(document_operations_total{job="pgben-document-metrics", sensitive="true", operation=~"upload|download|delete"}[5m])) - sum(rate(document_operations_total{job="pgben-document-metrics", sensitive="true", operation=~"upload_success|download_success|delete_success"}[5m])) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Falhas em operações com documentos sensíveis"
          description: "Foram detectadas falhas em operações com documentos sensíveis."
          
      # Alerta para alto tempo de upload de documentos
      - alert: HighDocumentUploadTime
        expr: histogram_quantile(0.95, sum(rate(document_upload_duration_seconds_bucket{job="pgben-document-metrics"}[5m])) by (le)) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto tempo de upload de documentos"
          description: "O percentil 95 do tempo de upload de documentos está acima de 10 segundos."

  system_alerts.yml: |
    groups:
    - name: system_alerts
      rules:
      # Alerta para alto uso de memória
      - alert: HighMemoryUsage
        expr: sum(system_memory_usage_bytes{job="pgben-system-metrics", type="heapUsed"}) / sum(system_memory_usage_bytes{job="pgben-system-metrics", type="heapTotal"}) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto uso de memória"
          description: "O uso de memória heap está acima de 85%."
          
      # Alerta para alto uso de CPU
      - alert: HighCpuUsage
        expr: system_cpu_usage_percent{job="pgben-system-metrics"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto uso de CPU"
          description: "O uso de CPU está acima de 80%."
          
      # Alerta para alto uso de disco
      - alert: HighDiskUsage
        expr: node_filesystem_avail_bytes{job="node-exporter", mountpoint="/"} / node_filesystem_size_bytes{job="node-exporter", mountpoint="/"} < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Alto uso de disco"
          description: "O espaço disponível em disco está abaixo de 10%."

  database_alerts.yml: |
    groups:
    - name: database_alerts
      rules:
      # Alerta para alto número de conexões com o banco de dados
      - alert: HighDatabaseConnections
        expr: pg_stat_activity_count{job="postgres-exporter"} > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto número de conexões com o banco de dados"
          description: "O número de conexões ativas com o banco de dados está acima de 100."
          
      # Alerta para consultas lentas
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, sum(rate(database_query_duration_seconds_bucket{job="pgben-api"}[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Consultas lentas ao banco de dados"
          description: "O percentil 95 do tempo de consulta ao banco de dados está acima de 1 segundo."
