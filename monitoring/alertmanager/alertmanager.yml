# =============================================================================
# CONFIGURA√á√ÉO DO ALERTMANAGER - SISTEMA SEMTAS
# =============================================================================
# Configura√ß√£o para gerenciamento e roteamento de alertas de resili√™ncia.
# Inclui notifica√ß√µes por email, Slack e webhook para diferentes severidades.
# =============================================================================

global:
  # Configura√ß√µes SMTP para notifica√ß√µes por email
  smtp_smarthost: '${SMTP_HOST:-localhost:587}'
  smtp_from: '${SMTP_FROM:-alertas@semtas.local}'
  smtp_auth_username: '${SMTP_USERNAME:-}'
  smtp_auth_password: '${SMTP_PASSWORD:-}'
  smtp_require_tls: true
  
  # URLs de resolu√ß√£o
  resolve_timeout: 5m
  
  # Headers HTTP globais
  http_config:
    tls_config:
      insecure_skip_verify: false

# =============================================================================
# TEMPLATES DE NOTIFICA√á√ÉO
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# CONFIGURA√á√ÉO DE ROTEAMENTO
# =============================================================================
route:
  # Configura√ß√µes padr√£o
  group_by: ['alertname', 'component', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default-receiver'
  
  # Rotas espec√≠ficas por severidade e componente
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 30m
      continue: true
    
    # Alertas de cache - equipe de infraestrutura
    - match:
        component: cache
      receiver: 'cache-alerts'
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 2h
    
    # Alertas de auditoria - equipe de seguran√ßa
    - match:
        component: auditoria
      receiver: 'auditoria-alerts'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 1h
    
    # Alertas de Redis - equipe de banco de dados
    - match:
        component: redis
      receiver: 'redis-alerts'
      group_wait: 2m
      group_interval: 10m
      repeat_interval: 2h
    
    # Alertas de aplica√ß√£o - equipe de desenvolvimento
    - match:
        component: application
      receiver: 'app-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h
    
    # Alertas durante hor√°rio de manuten√ß√£o - silenciar
    - match:
        severity: warning
      active_time_intervals:
        - maintenance-window
      receiver: 'null-receiver'

# =============================================================================
# CONFIGURA√á√ÉO DE INIBI√á√ÉO
# =============================================================================
inhibit_rules:
  # Se a aplica√ß√£o est√° down, inibir outros alertas relacionados
  - source_match:
      alertname: SemtasAppDown
    target_match_re:
      component: (cache|auditoria|health_check)
    equal: ['instance']
  
  # Se o Redis est√° indispon√≠vel, inibir alertas de cache L2
  - source_match:
      alertname: CacheL2Unavailable
    target_match:
      component: cache
      layer: l2
    equal: ['instance']
  
  # Alertas cr√≠ticos inibem warnings do mesmo componente
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ['component', 'instance']

# =============================================================================
# CONFIGURA√á√ÉO DE RECEIVERS
# =============================================================================
receivers:
  # Receiver padr√£o
  - name: 'default-receiver'
    email_configs:
      - to: '${DEFAULT_EMAIL:-admin@semtas.local}'
        subject: '[SEMTAS] Alerta: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          **Alerta:** {{ .Annotations.summary }}
          **Descri√ß√£o:** {{ .Annotations.description }}
          **Severidade:** {{ .Labels.severity }}
          **Componente:** {{ .Labels.component }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
        headers:
          Subject: '[SEMTAS] Alerta de Resili√™ncia'
  
  # Alertas cr√≠ticos - m√∫ltiplos canais
  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_EMAIL:-admin@semtas.local,ops@semtas.local}'
        subject: 'üö® [SEMTAS CR√çTICO] {{ .GroupLabels.alertname }}'
        body: |
          üö® **ALERTA CR√çTICO NO SISTEMA SEMTAS** üö®
          
          {{ range .Alerts }}
          **Alerta:** {{ .Annotations.summary }}
          **Descri√ß√£o:** {{ .Annotations.description }}
          **Componente:** {{ .Labels.component }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **Status:** {{ .Status }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          
          **A√ß√£o Requerida:** Investiga√ß√£o imediata necess√°ria!
          {{ end }}
        headers:
          Priority: 'high'
          X-Priority: '1'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL:-}'
        channel: '#alerts-critical'
        title: 'üö® Alerta Cr√≠tico SEMTAS'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          
          *Componente:* {{ .Labels.component }}
          *Severidade:* {{ .Labels.severity }}
          {{ if .Annotations.runbook_url }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
        color: 'danger'
        send_resolved: true
  
  # Alertas de cache
  - name: 'cache-alerts'
    email_configs:
      - to: '${INFRA_EMAIL:-infra@semtas.local}'
        subject: '[SEMTAS Cache] {{ .GroupLabels.alertname }}'
        body: |
          **Alerta de Cache - Sistema SEMTAS**
          
          {{ range .Alerts }}
          **Problema:** {{ .Annotations.summary }}
          **Detalhes:** {{ .Annotations.description }}
          **Layer:** {{ .Labels.layer | default "N/A" }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
  
  # Alertas de auditoria
  - name: 'auditoria-alerts'
    email_configs:
      - to: '${SECURITY_EMAIL:-security@semtas.local}'
        subject: '[SEMTAS Auditoria] {{ .GroupLabels.alertname }}'
        body: |
          **Alerta de Auditoria - Sistema SEMTAS**
          
          ‚ö†Ô∏è **ATEN√á√ÉO:** Poss√≠vel impacto na trilha de auditoria!
          
          {{ range .Alerts }}
          **Problema:** {{ .Annotations.summary }}
          **Detalhes:** {{ .Annotations.description }}
          **Tipo:** {{ .Labels.type | default "N/A" }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
          
          **Impacto:** Logs de auditoria podem estar sendo perdidos ou atrasados.
        headers:
          X-Priority: '2'
  
  # Alertas de Redis
  - name: 'redis-alerts'
    email_configs:
      - to: '${DBA_EMAIL:-dba@semtas.local}'
        subject: '[SEMTAS Redis] {{ .GroupLabels.alertname }}'
        body: |
          **Alerta de Redis - Sistema SEMTAS**
          
          {{ range .Alerts }}
          **Problema:** {{ .Annotations.summary }}
          **Detalhes:** {{ .Annotations.description }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
  
  # Alertas de aplica√ß√£o
  - name: 'app-alerts'
    email_configs:
      - to: '${DEV_EMAIL:-dev@semtas.local}'
        subject: '[SEMTAS App] {{ .GroupLabels.alertname }}'
        body: |
          **Alerta de Aplica√ß√£o - Sistema SEMTAS**
          
          {{ range .Alerts }}
          **Problema:** {{ .Annotations.summary }}
          **Detalhes:** {{ .Annotations.description }}
          **Hor√°rio:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
    
    webhook_configs:
      - url: '${WEBHOOK_URL:-http://localhost:3000/api/v1/webhooks/alerts}'
        http_config:
          basic_auth:
            username: '${WEBHOOK_USERNAME:-semtas}'
            password: '${WEBHOOK_PASSWORD:-}'
        send_resolved: true
  
  # Receiver nulo para silenciar alertas
  - name: 'null-receiver'

# =============================================================================
# INTERVALOS DE TEMPO ATIVOS
# =============================================================================
time_intervals:
  # Janela de manuten√ß√£o (s√°bados 02:00-06:00)
  - name: maintenance-window
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '06:00'
        weekdays: ['saturday']
        location: 'America/Sao_Paulo'
  
  # Hor√°rio comercial (segunda a sexta, 08:00-18:00)
  - name: business-hours
    time_intervals:
      - times:
          - start_time: '08:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'America/Sao_Paulo'

# =============================================================================
# CONFIGURA√á√ïES GLOBAIS DE NOTIFICA√á√ÉO
# =============================================================================
# Vari√°veis de ambiente esperadas:
# - SMTP_HOST: Servidor SMTP
# - SMTP_FROM: Email remetente
# - SMTP_USERNAME: Usu√°rio SMTP
# - SMTP_PASSWORD: Senha SMTP
# - DEFAULT_EMAIL: Email padr√£o para alertas
# - CRITICAL_EMAIL: Emails para alertas cr√≠ticos
# - INFRA_EMAIL: Email da equipe de infraestrutura
# - SECURITY_EMAIL: Email da equipe de seguran√ßa
# - DBA_EMAIL: Email da equipe de banco de dados
# - DEV_EMAIL: Email da equipe de desenvolvimento
# - SLACK_WEBHOOK_URL: URL do webhook do Slack
# - WEBHOOK_URL: URL do webhook personalizado
# - WEBHOOK_USERNAME: Usu√°rio do webhook
# - WEBHOOK_PASSWORD: Senha do webhook
# =============================================================================