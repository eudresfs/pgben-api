
name: Build and Deploy
on:
  push:
    branches: [ "main" ]
env:
  CPR_ADDR: cpr.kemosoft.com.br
  K8S_NAMESPACE: consigmais
  DEPLOYMENT_NAME: ${{ github.event.repository.name }}
  CONTAINER_PATH: cpr.kemosoft.com.br/${{ github.event.repository.name }}:${{ github.sha }}
jobs:
  build:
    runs-on: arc-runner-set
    container:
      image: gcr.io/kaniko-project/executor:v1.20.0-debug
    permissions:
      contents: read
    steps:
      - name: build and push image to cpr
        id: build
        run: |
          cat <<EOF > /kaniko/.docker/config.json
          {
            "auths": {
              "$CPR_ADDR": {
                "auth": "$(echo -n "$CPR_USERNAME:$CPR_PASSWORD" | base64 -w0)"
              }
            }
          }
          EOF
          /kaniko/executor --dockerfile="/Dockerfile" \
            --context="${{ github.repositoryUrl }}#${{ github.ref }}#${{ github.sha }}"  \
            --destination="${{ env.CONTAINER_PATH }}" \
            ${{ env.KANIKO_CACHE_ARGS }} \
            --push-retry 5 
        env:
          GIT_USERNAME: ${{ github.actor }}
          GIT_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          CPR_USERNAME: ${{ secrets.CPR_USERNAME }}
          CPR_PASSWORD: ${{ secrets.CPR_PASSWORD }}
      
      - name: Notify Discord - Build
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üî® Build: ${{ github.event.repository.name }}"
          description: |
            **Status:** ${{ job.status }}
            **Branch:** ${{ github.ref_name }}
            **Image:** ${{ env.CONTAINER_PATH }}
            **Commit:** ${{ github.event.head_commit.message }}
          color: ${{ job.status == 'success' && '0x43B581' || '0xF04747' }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
  
  deploy:
    needs:
      - build
    runs-on: k8s
    steps:
      - name: patch deployment
        id: deploy
        run: |
          kubectl -n $K8S_NAMESPACE set image deployment/$DEPLOYMENT_NAME $DEPLOYMENT_NAME=$CONTAINER_PATH --record
          kubectl -n $K8S_NAMESPACE rollout status deployment/$DEPLOYMENT_NAME
        continue-on-error: true
      
      - name: Check deployment success
        id: check
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "::set-output name=status::success"
          else
            echo "::set-output name=status::failure"
            exit 1
          fi
      
      - name: Notify Discord - Deploy
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üöÄ Deploy: ${{ github.event.repository.name }}"
          description: |
            **Status:** ${{ steps.check.outputs.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
            **Namespace:** ${{ env.K8S_NAMESPACE }}
            **Deployment:** ${{ env.DEPLOYMENT_NAME }}
            **Image:** ${{ env.CONTAINER_PATH }}
            **Commit:** ${{ github.event.head_commit.message }}
            **By:** ${{ github.actor }}
          color: ${{ steps.check.outputs.status == 'success' && '0x43B581' || '0xF04747' }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
