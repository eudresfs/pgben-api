# Prompt para Refatoração do Módulo de Benefícios - SEMTAS

## Contexto

Estamos desenvolvendo o Sistema de Gestão de Benefícios Eventuais para a Secretaria Municipal do Trabalho e Assistência Social (SEMTAS) de Natal/RN. O módulo de "beneficio" atual precisa ser refatorado para focar em sua responsabilidade específica: definir a estrutura de informações dos tipos de benefícios eventuais conforme a Lei Municipal 7.205/2021 e Decreto Municipal 12.346/2021.

## Esclarecer Responsabilidades

O Módulo de Benefício é responsável apenas por:
- Definir os tipos de benefícios disponíveis (catálogo)
- Estruturar os formulários e campos específicos para cada tipo
- Gerenciar regras associadas a cada benefício (critérios, valores, duração)
- Definir requisitos documentais por tipo de benefício
- Configurar fluxos de aprovação específicos por tipo

**IMPORTANTE**: O ciclo de vida das solicitações (workflow, status, aprovações) é gerenciado pelo Módulo de Solicitação já existente.

## Objetivo

Refatorar o módulo de Benefícios para suportar inicialmente dois tipos conforme MVP (Auxílio Natalidade e Aluguel Social), mas com arquitetura extensível para incorporar posteriormente os outros tipos (Auxílio Funeral e Cesta Básica). O módulo deve fornecer toda a estrutura necessária para que o módulo de Solicitação possa operar o fluxo completo de concessão.

## Tecnologias Atuais do Projeto

- Backend: Nest JS com TypeScript
- Banco de dados: PostgreSQL
- ORM: TypeORM
- Frontend: Quasar Framework (Vue 3 com TypeScript e Pinia)
- APIs RESTful com documentação Swagger

## Estrutura de Dados

### Entidades Principais

1. **TipoBeneficio**
```typescript
interface TipoBeneficio {
  id: string;
  nome: string;
  descricao: string;
  base_legal: string;
  periodicidade: Periodicidade; // Enum (UNICO, MENSAL)
  periodo_maximo: number; // em meses, quando aplicável
  permite_renovacao: boolean;
  permite_prorrogacao: boolean;
  valor: number; // valor padrão, quando aplicável
  valor_maximo: number; // quando aplicável
  ativo: boolean;
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

2. **RequisitoDocumento**
```typescript
interface RequisitoDocumento {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício
  nome: string;
  descricao: string;
  fase: FaseRequisito; // Enum (SOLICITACAO, ANALISE, LIBERACAO)
  obrigatorio: boolean;
  ordem: number; // para controlar a ordem de exibição no formulário
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

3. **FluxoBeneficio**
```typescript
interface FluxoBeneficio {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício
  setor_id: string; // Referência ao setor que participa do fluxo
  ordem: number; // Ordem do setor no fluxo
  tipo_acao: TipoAcao; // Enum (CADASTRO, ANALISE, APROVACAO, LIBERACAO)
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

4. **FormularioEspecifico**
```typescript
interface FormularioEspecifico {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício
  nome_campo: string;
  descricao_campo: string;
  tipo_campo: TipoCampo; // Enum (TEXTO, NUMERO, DATA, BOOLEANO, SELECAO, MULTIPLA_ESCOLHA)
  opcoes?: string[]; // Para campos de seleção ou múltipla escolha
  obrigatorio: boolean;
  validacao?: string; // Regra de validação em formato JSON
  ordem: number;
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

5. **EspecificacaoNatalidade**
```typescript
interface EspecificacaoNatalidade {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício natalidade
  itens_kit: string[]; // Itens incluídos no kit enxoval
  tempo_gestacao_minimo?: number; // Tempo mínimo de gestação para solicitação
  prazo_maximo_apos_nascimento: number; // Dias após nascimento para solicitar
  requer_pre_natal: boolean;
  valor_pecunia: number; // Caso seja concedido em dinheiro
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

6. **EspecificacaoAluguelSocial**
```typescript
interface EspecificacaoAluguelSocial {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício aluguel social
  valor_maximo_mensal: number;
  tempo_residencia_minimo: number; // Em meses
  duracao_inicial: number; // Em meses
  duracao_maxima_com_renovacao: number; // Em meses
  motivos_concessao: MotivoConcessao[]; // Array com motivos válidos
  documentos_adicionais: string[]; // Documentos específicos para este tipo
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}
```

## Endpoints da API

### 1. Tipos de Benefício
```
GET /api/beneficios/tipos - Listar todos os tipos de benefícios
GET /api/beneficios/tipos/:id - Obter tipo de benefício específico
POST /api/beneficios/tipos - Criar novo tipo de benefício
PUT /api/beneficios/tipos/:id - Atualizar tipo de benefício
DELETE /api/beneficios/tipos/:id - Inativar tipo de benefício (soft delete)
```

### 2. Requisitos Documentais
```
GET /api/beneficios/tipos/:id/requisitos - Listar requisitos documentais de um tipo de benefício
POST /api/beneficios/tipos/:id/requisitos - Adicionar requisito documental
PUT /api/beneficios/requisitos/:id - Atualizar requisito documental
DELETE /api/beneficios/requisitos/:id - Remover requisito documental
```

### 3. Fluxos de Benefício
```
GET /api/beneficios/tipos/:id/fluxo - Obter fluxo configurado para um tipo de benefício
POST /api/beneficios/tipos/:id/fluxo - Configurar fluxo para tipo de benefício
PUT /api/beneficios/fluxo/:id - Atualizar etapa do fluxo
DELETE /api/beneficios/fluxo/:id - Remover etapa do fluxo
```

### 4. Formulários Específicos
```
GET /api/beneficios/tipos/:id/formulario - Obter estrutura de formulário para um tipo de benefício
POST /api/beneficios/tipos/:id/campos - Adicionar campo ao formulário
PUT /api/beneficios/campos/:id - Atualizar campo do formulário
DELETE /api/beneficios/campos/:id - Remover campo do formulário
```

### 5. Configurações Específicas por Tipo
```
GET /api/beneficios/tipos/:id/configuracao - Obter configuração específica (natalidade/aluguel)
POST /api/beneficios/tipos/:id/configuracao - Criar configuração específica
PUT /api/beneficios/tipos/:id/configuracao - Atualizar configuração específica
```

### 6. Validações e Regras
```
GET /api/beneficios/tipos/:id/regras - Listar regras de validação específicas
POST /api/beneficios/tipos/:id/regras - Adicionar regra de validação
PUT /api/beneficios/regras/:id - Atualizar regra de validação
DELETE /api/beneficios/regras/:id - Remover regra de validação
```

## Requisitos Específicos

1. **Configurações de Auxílio Natalidade**
   - Estruturar formulário específico conforme Art. 9º-16 da Lei 7.205/2021
   - Configurar requisitos documentais conforme Art. 16
   - Definir composição padrão do kit enxoval
   - Configurar prazo máximo para requerimento (até 90 dias antes do parto)
   - Configurar validações para idade da criança (0 a 3 meses)

2. **Configurações de Aluguel Social**
   - Estruturar formulário específico conforme Art. 32-34 da Lei 7.205/2021
   - Configurar requisitos documentais conforme Art. 34
   - Configurar validação para tempo mínimo de residência em Natal (2 anos)
   - Definir regras para período de concessão (6 meses, renovável por igual período)
   - Configurar motivos válidos conforme Art. 32

3. **Futuras Configurações (preparar estrutura)**
   - Preparar entidades para futura implementação de Auxílio Funeral
   - Preparar entidades para futura implementação de Cesta Básica

## Aspectos Técnicos Importantes

1. **Extensibilidade**
   - Projetar o módulo para facilmente acomodar novos tipos de benefícios
   - Implementar sistema de formulários dinâmicos baseado em configuração
   - Permitir personalização de fluxos e requisitos por tipo de benefício

2. **Validações**
   - Criar sistema de validação de regras de negócio por tipo de benefício
   - Permitir definição de validações específicas para cada campo do formulário
   - Implementar validação de elegibilidade conforme critérios legais

3. **Interoperabilidade**
   - Fornecer interfaces claras para o módulo de Solicitação consumir
   - Implementar endpoints que forneçam todas as regras e validações para o frontend
   - Garantir que o módulo de Solicitação possa facilmente obter a estrutura de formulários

4. **Arquitetura**
   - Seguir o padrão de Clean Architecture já utilizado no projeto
   - Organizar o código em controllers, services e repositories
   - Utilizar DTOs para transferência de dados entre camadas

## Entregáveis Esperados

1. Código-fonte do módulo refatorado
2. Migrations para estrutura de banco de dados
3. Documentação das APIs com Swagger
4. Testes unitários para regras de negócio
5. Documentação de integração com o módulo de Solicitação
6. Seeds para os tipos de benefícios iniciais (Natalidade e Aluguel Social)

## Observações Finais

Esta refatoração deve focar exclusivamente nas responsabilidades do módulo de Benefícios, que é definir a estrutura e regras dos tipos de benefícios disponíveis. Todas as funcionalidades relacionadas ao processo de solicitação, aprovação e concessão devem ser deixadas para o módulo de Solicitação.

O módulo refatorado deve proporcionar uma interface clara para o módulo de Solicitação consumir as definições dos benefícios, permitindo assim que o sistema como um todo funcione corretamente, com cada módulo cumprindo sua responsabilidade específica.

---

# Explicação Detalhada: FormularioEspecifico

O `FormularioEspecifico` é uma das entidades centrais do módulo de Benefícios refatorado, e seu propósito é permitir a definição dinâmica e flexível de formulários personalizados para cada tipo de benefício. Vamos explorar em detalhes:

## Conceito e Propósito

Cada tipo de benefício (Auxílio Natalidade, Aluguel Social, etc.) requer informações específicas que precisam ser coletadas durante a solicitação. Por exemplo:
- Para Auxílio Natalidade precisamos de data prevista para o parto, comprovação de pré-natal, etc.
- Para Aluguel Social precisamos de motivo da solicitação, valor do aluguel, etc.

Em vez de criar entidades rígidas no código para cada tipo de benefício, o `FormularioEspecifico` permite uma abordagem configurável onde administradores podem:
1. Definir quais campos cada formulário terá
2. Especificar o tipo de cada campo (texto, data, seleção, etc.)
3. Controlar validações específicas por campo
4. Reorganizar a ordem dos campos quando necessário

## Estrutura Detalhada

```typescript
interface FormularioEspecifico {
  id: string;
  tipo_beneficio_id: string; // Referência ao tipo de benefício
  nome_campo: string;        // Nome técnico do campo (ex: "dataPrevistaParto")
  descricao_campo: string;   // Label exibida ao usuário (ex: "Data Prevista para o Parto")
  tipo_campo: TipoCampo;     // Tipo de dado (texto, número, data, etc.)
  opcoes?: string[];         // Opções para seleção em campos do tipo SELECAO ou MULTIPLA_ESCOLHA
  obrigatorio: boolean;      // Se o campo é de preenchimento obrigatório
  validacao?: string;        // Regras de validação específicas em formato JSON
  ordem: number;             // Ordem de exibição no formulário
  created_at: Date;
  updated_at: Date;
  removed_at?: Date;
}

enum TipoCampo {
  TEXTO = 'texto',
  TEXTO_LONGO = 'texto_longo',
  NUMERO = 'numero',
  MONETARIO = 'monetario',
  DATA = 'data',
  BOOLEANO = 'booleano',
  SELECAO = 'selecao',
  MULTIPLA_ESCOLHA = 'multipla_escolha',
  ARQUIVO = 'arquivo',
  CPF = 'cpf',
  EMAIL = 'email',
  TELEFONE = 'telefone'
}
```

## Exemplo Prático: Auxílio Natalidade

Para um Auxílio Natalidade, poderíamos configurar os seguintes campos:

1. **Campo: Data Prevista para o Parto**
   ```json
   {
     "tipo_beneficio_id": "id-do-auxilio-natalidade",
     "nome_campo": "dataPrevistaParto",
     "descricao_campo": "Data Prevista para o Parto",
     "tipo_campo": "DATA",
     "obrigatorio": true,
     "validacao": {
       "minDate": "today",
       "maxDate": "today+270" 
     },
     "ordem": 1
   }
   ```

2. **Campo: Realiza Pré-Natal**
   ```json
   {
     "tipo_beneficio_id": "id-do-auxilio-natalidade",
     "nome_campo": "realizaPreNatal",
     "descricao_campo": "Realiza acompanhamento pré-natal?",
     "tipo_campo": "BOOLEANO",
     "obrigatorio": true,
     "ordem": 2
   }
   ```

3. **Campo: Local do Pré-Natal**
   ```json
   {
     "tipo_beneficio_id": "id-do-auxilio-natalidade",
     "nome_campo": "localPreNatal",
     "descricao_campo": "Onde realiza o pré-natal?",
     "tipo_campo": "SELECAO",
     "opcoes": ["UBS", "PSF", "Hospital Público", "Clínica Particular", "Não realiza"],
     "obrigatorio": true,
     "validacao": {
       "dependsOn": {
         "field": "realizaPreNatal",
         "value": true,
         "action": "show"
       }
     },
     "ordem": 3
   }
   ```

## Funcionamento e Fluxo de Dados

Quando o sistema precisa exibir um formulário para um tipo de benefício:

1. O frontend solicita a estrutura do formulário via API:
   ```
   GET /api/beneficios/tipos/id-do-auxilio-natalidade/formulario
   ```

2. O backend retorna a lista de campos configurados, ordenados pelo campo `ordem`

3. O frontend renderiza dinamicamente os campos conforme suas configurações:
   - Para campos do tipo `TEXTO`, exibe inputs de texto
   - Para campos do tipo `DATA`, exibe datepickers
   - Para campos do tipo `SELECAO`, exibe dropdowns com as opções definidas
   - Etc.

4. Ao enviar o formulário, o frontend aplica as validações conforme regras definidas no campo `validacao`

5. Os dados capturados são enviados junto com a solicitação e armazenados em formato estruturado (geralmente JSON) pelo módulo de Solicitação

## Vantagens desta Abordagem

1. **Flexibilidade**: Novos campos podem ser adicionados sem mudar o código
2. **Manutenibilidade**: Mudanças nos requisitos não exigem alterações no código, apenas configuração
3. **Extensibilidade**: Facilita a adição de novos tipos de benefícios no futuro
4. **Consistência**: Interface unificada para definição de formulários
5. **Separação de Responsabilidades**: O módulo de Benefícios define a estrutura, o módulo de Solicitação captura e armazena os dados

## Implementação Técnica

No backend, você precisará:

1. **Repository**: Para acesso aos dados dos campos configurados
2. **Service**: Para lógica de negócio relacionada à configuração de formulários
3. **Controllers**: Endpoints para gerenciar os campos
4. **DTO**: Para validação e transferência de dados

No frontend, você precisará:

1. **Componente de Formulário Dinâmico**: Que renderiza campos baseados na configuração
2. **Validadores Dinâmicos**: Que aplicam regras conforme configurado
3. **Store/State**: Para gerenciar o estado do formulário conforme interação do usuário

## Considerações Adicionais

- As validações podem se tornar bastante complexas (dependências entre campos, regras condicionais, etc.)
- Considere usar um esquema JSON para definir validações que seja expressivo o suficiente para suas necessidades
- Garanta que o frontend e backend interpretem as regras da mesma maneira
- Pense em caching para melhorar performance ao buscar configurações de formulários frequentemente usados

Esta abordagem de formulários dinâmicos é poderosa, mas requer um bom design inicial para garantir que todas as necessidades futuras possam ser atendidas sem grandes refatorações.