b663ef4a4c73fd27f8089db3fd5a15c1
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricasExportacaoController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const express_1 = require("express");
const jwt_auth_guard_1 = require("../../../shared/guards/jwt-auth.guard");
const roles_guard_1 = require("../../../auth/guards/roles.guard");
const role_decorator_1 = require("../../../auth/decorators/role.decorator");
const roles_constants_1 = require("../../../shared/constants/roles.constants");
const metricas_service_1 = require("../services/metricas.service");
/**
 * Controlador para exportação de dados de métricas
 *
 * Este controlador fornece endpoints para:
 * 1. Exportar dados de uma métrica específica em formato CSV ou JSON
 * 2. Gerar relatório completo de métricas para análise externa
 */
let MetricasExportacaoController = class MetricasExportacaoController {
    metricasService;
    constructor(metricasService) {
        this.metricasService = metricasService;
    }
    /**
     * Exporta dados de uma métrica específica em formato CSV ou JSON
     */
    async exportarDadosMetrica(codigo, dataInicio, dataFim, formato = 'csv', incluirMetadados = false, res) {
        // Implementação temporária até que o método seja adicionado ao serviço
        const dados = [
            {
                codigo,
                nome: `Métrica ${codigo}`,
                valor: 0,
                data_coleta: new Date(),
                unidade: 'un',
            },
        ];
        if (formato === 'json') {
            return res
                .setHeader('Content-Type', 'application/json')
                .setHeader('Content-Disposition', `attachment; filename=${codigo}_${new Date().toISOString().split('T')[0]}.json`)
                .send(JSON.stringify(dados, null, 2));
        }
        else {
            // Converter para CSV
            const csvData = this.converterParaCSV(dados);
            return res
                .setHeader('Content-Type', 'text/csv')
                .setHeader('Content-Disposition', `attachment; filename=${codigo}_${new Date().toISOString().split('T')[0]}.csv`)
                .send(csvData);
        }
    }
    /**
     * Gera relatório completo de métricas para análise externa
     */
    async gerarRelatorioCompleto(res, formato = 'pdf', categorias, periodo) {
        // Implementação temporária até que o método seja adicionado ao serviço
        const relatorio = {
            titulo: 'Relatório Completo de Métricas',
            periodo: {
                inicio: new Date(),
                fim: new Date(),
                descricao: periodo || 'último mês',
            },
            categorias: categorias || 'todas',
            total_metricas: 0,
            data_geracao: new Date(),
            metricas: [],
        };
        let contentType = 'application/pdf';
        let filename = `relatorio_metricas_${new Date().toISOString().split('T')[0]}.pdf`;
        if (formato === 'json') {
            contentType = 'application/json';
            filename = `relatorio_metricas_${new Date().toISOString().split('T')[0]}.json`;
            return res
                .setHeader('Content-Type', contentType)
                .setHeader('Content-Disposition', `attachment; filename=${filename}`)
                .send(JSON.stringify(relatorio, null, 2));
        }
        else if (formato === 'csv') {
            contentType = 'text/csv';
            filename = `relatorio_metricas_${new Date().toISOString().split('T')[0]}.csv`;
            // Converter o objeto para array para poder usar o método converterParaCSV
            const relatorioArray = [relatorio];
            const csvData = this.converterParaCSV(relatorioArray);
            return res
                .setHeader('Content-Type', contentType)
                .setHeader('Content-Disposition', `attachment; filename=${filename}`)
                .send(csvData);
        }
        else {
            // PDF
            return res
                .setHeader('Content-Type', contentType)
                .setHeader('Content-Disposition', `attachment; filename=${filename}`)
                .send(relatorio);
        }
    }
    /**
     * Converte dados para formato CSV
     * @private
     */
    converterParaCSV(dados) {
        if (!dados || !dados.length) {
            return '';
        }
        // Obter cabeçalhos
        const headers = Object.keys(dados[0]);
        // Criar linha de cabeçalho
        let csv = headers.join(',') + '\n';
        // Adicionar linhas de dados
        dados.forEach((item) => {
            const values = headers.map((header) => {
                const value = item[header];
                // Tratar valores especiais
                if (value === null || value === undefined) {
                    return '';
                }
                if (typeof value === 'string') {
                    // Escapar aspas e envolver em aspas se contiver vírgulas
                    const escaped = value.replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                }
                if (value instanceof Date) {
                    return value.toISOString();
                }
                if (typeof value === 'object') {
                    // Converter objetos para JSON e envolver em aspas
                    return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                }
                return value;
            });
            csv += values.join(',') + '\n';
        });
        return csv;
    }
};
exports.MetricasExportacaoController = MetricasExportacaoController;
__decorate([
    (0, common_1.Get)(':codigo'),
    (0, role_decorator_1.Roles)(roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR, roles_constants_1.ROLES.TECNICO),
    (0, swagger_1.ApiOperation)({ summary: 'Exporta dados de uma métrica (CSV/JSON)' }),
    (0, swagger_1.ApiResponse)({ status: 200, description: 'Dados exportados com sucesso' }),
    (0, swagger_1.ApiResponse)({ status: 404, description: 'Métrica não encontrada' }),
    __param(0, (0, common_1.Param)('codigo')),
    __param(1, (0, common_1.Query)('dataInicio')),
    __param(2, (0, common_1.Query)('dataFim')),
    __param(3, (0, common_1.Query)('formato')),
    __param(4, (0, common_1.Query)('incluirMetadados')),
    __param(5, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, typeof (_b = typeof Date !== "undefined" && Date) === "function" ? _b : Object, typeof (_c = typeof Date !== "undefined" && Date) === "function" ? _c : Object, String, Boolean, typeof (_d = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _d : Object]),
    __metadata("design:returntype", Promise)
], MetricasExportacaoController.prototype, "exportarDadosMetrica", null);
__decorate([
    (0, common_1.Get)('relatorio'),
    (0, role_decorator_1.Roles)(roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR),
    (0, swagger_1.ApiOperation)({ summary: 'Gera relatório completo de métricas' }),
    (0, swagger_1.ApiResponse)({ status: 200, description: 'Relatório gerado com sucesso' }),
    __param(0, (0, common_1.Res)()),
    __param(1, (0, common_1.Query)('formato')),
    __param(2, (0, common_1.Query)('categorias')),
    __param(3, (0, common_1.Query)('periodo')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_e = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _e : Object, String, Array, String]),
    __metadata("design:returntype", Promise)
], MetricasExportacaoController.prototype, "gerarRelatorioCompleto", null);
exports.MetricasExportacaoController = MetricasExportacaoController = __decorate([
    (0, swagger_1.ApiTags)('Métricas e Dashboard'),
    (0, swagger_1.ApiBearerAuth)(),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard, roles_guard_1.RolesGuard),
    (0, common_1.Controller)('metricas/exportacao'),
    __metadata("design:paramtypes", [typeof (_a = typeof metricas_service_1.MetricasService !== "undefined" && metricas_service_1.MetricasService) === "function" ? _a : Object])
], MetricasExportacaoController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXG1ldHJpY2FzXFxjb250cm9sbGVyc1xcbWV0cmljYXMtZXhwb3J0YWNhby5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBK0U7QUFDL0UsNkNBS3lCO0FBQ3pCLHFDQUFtQztBQUNuQywwRUFBcUU7QUFDckUsa0VBQThEO0FBQzlELDRFQUFnRTtBQUNoRSwrRUFBa0U7QUFFbEUsbUVBQStEO0FBRS9EOzs7Ozs7R0FNRztBQUtJLElBQU0sNEJBQTRCLEdBQWxDLE1BQU0sNEJBQTRCO0lBQ1Y7SUFBN0IsWUFBNkIsZUFBZ0M7UUFBaEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQUcsQ0FBQztJQUVqRTs7T0FFRztJQU1HLEFBQU4sS0FBSyxDQUFDLG9CQUFvQixDQUNQLE1BQWMsRUFDVixVQUFnQixFQUNuQixPQUFhLEVBQ2IsVUFBMEIsS0FBSyxFQUN0QixtQkFBNEIsS0FBSyxFQUNyRCxHQUFhO1FBRXBCLHVFQUF1RTtRQUN2RSxNQUFNLEtBQUssR0FBRztZQUNaO2dCQUNFLE1BQU07Z0JBQ04sSUFBSSxFQUFFLFdBQVcsTUFBTSxFQUFFO2dCQUN6QixLQUFLLEVBQUUsQ0FBQztnQkFDUixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7Z0JBQ3ZCLE9BQU8sRUFBRSxJQUFJO2FBQ2Q7U0FDRixDQUFDO1FBRUYsSUFBSSxPQUFPLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDdkIsT0FBTyxHQUFHO2lCQUNQLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUM7aUJBQzdDLFNBQVMsQ0FDUixxQkFBcUIsRUFDckIsd0JBQXdCLE1BQU0sSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUNoRjtpQkFD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ekIsV0FBQSxJQUFBLFlBQUcsR0FBRSxDQUFBOztpRUFKMkIsSUFBSSxvQkFBSixJQUFJLG9EQUNWLElBQUksb0JBQUosSUFBSSxxRUFHbkIsa0JBQVEsb0JBQVIsa0JBQVE7O3dFQWdDckI7QUFTSztJQUpMLElBQUEsWUFBRyxFQUFDLFdBQVcsQ0FBQztJQUNoQixJQUFBLHNCQUFLLEVBQUMsdUJBQUssQ0FBQyxLQUFLLEVBQUUsdUJBQUssQ0FBQyxNQUFNLENBQUM7SUFDaEMsSUFBQSxzQkFBWSxFQUFDLEVBQUUsT0FBTyxFQUFFLHFDQUFxQyxFQUFFLENBQUM7SUFDaEUsSUFBQSxxQkFBVyxFQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsOEJBQThCLEVBQUUsQ0FBQztJQUV2RSxXQUFBLElBQUEsWUFBRyxHQUFFLENBQUE7SUFDTCxXQUFBLElBQUEsY0FBSyxFQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ2hCLFdBQUEsSUFBQSxjQUFLLEVBQUMsWUFBWSxDQUFDLENBQUE7SUFDbkIsV0FBQSxJQUFBLGNBQUssRUFBQyxTQUFTLENBQUMsQ0FBQTs7eURBSEwsa0JBQVEsb0JBQVIsa0JBQVE7OzBFQThDckI7dUNBekdVLDRCQUE0QjtJQUp4QyxJQUFBLGlCQUFPLEVBQUMsc0JBQXNCLENBQUM7SUFDL0IsSUFBQSx1QkFBYSxHQUFFO0lBQ2YsSUFBQSxrQkFBUyxFQUFDLDZCQUFZLEVBQUUsd0JBQVUsQ0FBQztJQUNuQyxJQUFBLG1CQUFVLEVBQUMscUJBQXFCLENBQUM7eURBRWMsa0NBQWUsb0JBQWYsa0NBQWU7R0FEbEQsNEJBQTRCLENBc0p4QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcbWV0cmljYXNcXGNvbnRyb2xsZXJzXFxtZXRyaWNhcy1leHBvcnRhY2FvLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udHJvbGxlciwgR2V0LCBQYXJhbSwgUXVlcnksIFJlcywgVXNlR3VhcmRzIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHtcbiAgQXBpVGFncyxcbiAgQXBpT3BlcmF0aW9uLFxuICBBcGlSZXNwb25zZSxcbiAgQXBpQmVhcmVyQXV0aCxcbn0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcbmltcG9ydCB7IFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBKd3RBdXRoR3VhcmQgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IFJvbGVzR3VhcmQgfSBmcm9tICcuLi8uLi8uLi9hdXRoL2d1YXJkcy9yb2xlcy5ndWFyZCc7XG5pbXBvcnQgeyBSb2xlcyB9IGZyb20gJy4uLy4uLy4uL2F1dGgvZGVjb3JhdG9ycy9yb2xlLmRlY29yYXRvcic7XG5pbXBvcnQgeyBST0xFUyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9jb25zdGFudHMvcm9sZXMuY29uc3RhbnRzJztcblxuaW1wb3J0IHsgTWV0cmljYXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbWV0cmljYXMuc2VydmljZSc7XG5cbi8qKlxuICogQ29udHJvbGFkb3IgcGFyYSBleHBvcnRhw6fDo28gZGUgZGFkb3MgZGUgbcOpdHJpY2FzXG4gKlxuICogRXN0ZSBjb250cm9sYWRvciBmb3JuZWNlIGVuZHBvaW50cyBwYXJhOlxuICogMS4gRXhwb3J0YXIgZGFkb3MgZGUgdW1hIG3DqXRyaWNhIGVzcGVjw61maWNhIGVtIGZvcm1hdG8gQ1NWIG91IEpTT05cbiAqIDIuIEdlcmFyIHJlbGF0w7NyaW8gY29tcGxldG8gZGUgbcOpdHJpY2FzIHBhcmEgYW7DoWxpc2UgZXh0ZXJuYVxuICovXG5AQXBpVGFncygnTcOpdHJpY2FzIGUgRGFzaGJvYXJkJylcbkBBcGlCZWFyZXJBdXRoKClcbkBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkLCBSb2xlc0d1YXJkKVxuQENvbnRyb2xsZXIoJ21ldHJpY2FzL2V4cG9ydGFjYW8nKVxuZXhwb3J0IGNsYXNzIE1ldHJpY2FzRXhwb3J0YWNhb0NvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IG1ldHJpY2FzU2VydmljZTogTWV0cmljYXNTZXJ2aWNlKSB7fVxuXG4gIC8qKlxuICAgKiBFeHBvcnRhIGRhZG9zIGRlIHVtYSBtw6l0cmljYSBlc3BlY8OtZmljYSBlbSBmb3JtYXRvIENTViBvdSBKU09OXG4gICAqL1xuICBAR2V0KCc6Y29kaWdvJylcbiAgQFJvbGVzKFJPTEVTLkFETUlOLCBST0xFUy5HRVNUT1IsIFJPTEVTLlRFQ05JQ08pXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnRXhwb3J0YSBkYWRvcyBkZSB1bWEgbcOpdHJpY2EgKENTVi9KU09OKScgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiAyMDAsIGRlc2NyaXB0aW9uOiAnRGFkb3MgZXhwb3J0YWRvcyBjb20gc3VjZXNzbycgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDQsIGRlc2NyaXB0aW9uOiAnTcOpdHJpY2EgbsOjbyBlbmNvbnRyYWRhJyB9KVxuICBhc3luYyBleHBvcnRhckRhZG9zTWV0cmljYShcbiAgICBAUGFyYW0oJ2NvZGlnbycpIGNvZGlnbzogc3RyaW5nLFxuICAgIEBRdWVyeSgnZGF0YUluaWNpbycpIGRhdGFJbmljaW86IERhdGUsXG4gICAgQFF1ZXJ5KCdkYXRhRmltJykgZGF0YUZpbTogRGF0ZSxcbiAgICBAUXVlcnkoJ2Zvcm1hdG8nKSBmb3JtYXRvOiAnY3N2JyB8ICdqc29uJyA9ICdjc3YnLFxuICAgIEBRdWVyeSgnaW5jbHVpck1ldGFkYWRvcycpIGluY2x1aXJNZXRhZGFkb3M6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBAUmVzKCkgcmVzOiBSZXNwb25zZSxcbiAgKSB7XG4gICAgLy8gSW1wbGVtZW50YcOnw6NvIHRlbXBvcsOhcmlhIGF0w6kgcXVlIG8gbcOpdG9kbyBzZWphIGFkaWNpb25hZG8gYW8gc2VydmnDp29cbiAgICBjb25zdCBkYWRvcyA9IFtcbiAgICAgIHtcbiAgICAgICAgY29kaWdvLFxuICAgICAgICBub21lOiBgTcOpdHJpY2EgJHtjb2RpZ299YCxcbiAgICAgICAgdmFsb3I6IDAsXG4gICAgICAgIGRhdGFfY29sZXRhOiBuZXcgRGF0ZSgpLFxuICAgICAgICB1bmlkYWRlOiAndW4nLFxuICAgICAgfSxcbiAgICBdO1xuXG4gICAgaWYgKGZvcm1hdG8gPT09ICdqc29uJykge1xuICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG4gICAgICAgIC5zZXRIZWFkZXIoXG4gICAgICAgICAgJ0NvbnRlbnQtRGlzcG9zaXRpb24nLFxuICAgICAgICAgIGBhdHRhY2htZW50OyBmaWxlbmFtZT0ke2NvZGlnb31fJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXX0uanNvbmAsXG4gICAgICAgIClcbiAgICAgICAgLnNlbmQoSlNPTi5zdHJpbmdpZnkoZGFkb3MsIG51bGwsIDIpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ29udmVydGVyIHBhcmEgQ1NWXG4gICAgICBjb25zdCBjc3ZEYXRhID0gdGhpcy5jb252ZXJ0ZXJQYXJhQ1NWKGRhZG9zKTtcbiAgICAgIHJldHVybiByZXNcbiAgICAgICAgLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvY3N2JylcbiAgICAgICAgLnNldEhlYWRlcihcbiAgICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbicsXG4gICAgICAgICAgYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSR7Y29kaWdvfV8ke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdfS5jc3ZgLFxuICAgICAgICApXG4gICAgICAgIC5zZW5kKGNzdkRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXJhIHJlbGF0w7NyaW8gY29tcGxldG8gZGUgbcOpdHJpY2FzIHBhcmEgYW7DoWxpc2UgZXh0ZXJuYVxuICAgKi9cbiAgQEdldCgncmVsYXRvcmlvJylcbiAgQFJvbGVzKFJPTEVTLkFETUlOLCBST0xFUy5HRVNUT1IpXG4gIEBBcGlPcGVyYXRpb24oeyBzdW1tYXJ5OiAnR2VyYSByZWxhdMOzcmlvIGNvbXBsZXRvIGRlIG3DqXRyaWNhcycgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiAyMDAsIGRlc2NyaXB0aW9uOiAnUmVsYXTDs3JpbyBnZXJhZG8gY29tIHN1Y2Vzc28nIH0pXG4gIGFzeW5jIGdlcmFyUmVsYXRvcmlvQ29tcGxldG8oXG4gICAgQFJlcygpIHJlczogUmVzcG9uc2UsXG4gICAgQFF1ZXJ5KCdmb3JtYXRvJykgZm9ybWF0bzogJ2NzdicgfCAnanNvbicgfCAncGRmJyA9ICdwZGYnLFxuICAgIEBRdWVyeSgnY2F0ZWdvcmlhcycpIGNhdGVnb3JpYXM/OiBzdHJpbmdbXSxcbiAgICBAUXVlcnkoJ3BlcmlvZG8nKSBwZXJpb2RvPzogc3RyaW5nLFxuICApIHtcbiAgICAvLyBJbXBsZW1lbnRhw6fDo28gdGVtcG9yw6FyaWEgYXTDqSBxdWUgbyBtw6l0b2RvIHNlamEgYWRpY2lvbmFkbyBhbyBzZXJ2acOnb1xuICAgIGNvbnN0IHJlbGF0b3JpbyA9IHtcbiAgICAgIHRpdHVsbzogJ1JlbGF0w7NyaW8gQ29tcGxldG8gZGUgTcOpdHJpY2FzJyxcbiAgICAgIHBlcmlvZG86IHtcbiAgICAgICAgaW5pY2lvOiBuZXcgRGF0ZSgpLFxuICAgICAgICBmaW06IG5ldyBEYXRlKCksXG4gICAgICAgIGRlc2NyaWNhbzogcGVyaW9kbyB8fCAnw7psdGltbyBtw6pzJyxcbiAgICAgIH0sXG4gICAgICBjYXRlZ29yaWFzOiBjYXRlZ29yaWFzIHx8ICd0b2RhcycsXG4gICAgICB0b3RhbF9tZXRyaWNhczogMCxcbiAgICAgIGRhdGFfZ2VyYWNhbzogbmV3IERhdGUoKSxcbiAgICAgIG1ldHJpY2FzOiBbXSxcbiAgICB9O1xuXG4gICAgbGV0IGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3BkZic7XG4gICAgbGV0IGZpbGVuYW1lID0gYHJlbGF0b3Jpb19tZXRyaWNhc18ke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdfS5wZGZgO1xuXG4gICAgaWYgKGZvcm1hdG8gPT09ICdqc29uJykge1xuICAgICAgY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgICBmaWxlbmFtZSA9IGByZWxhdG9yaW9fbWV0cmljYXNfJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXX0uanNvbmA7XG4gICAgICByZXR1cm4gcmVzXG4gICAgICAgIC5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGNvbnRlbnRUeXBlKVxuICAgICAgICAuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSR7ZmlsZW5hbWV9YClcbiAgICAgICAgLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVsYXRvcmlvLCBudWxsLCAyKSk7XG4gICAgfSBlbHNlIGlmIChmb3JtYXRvID09PSAnY3N2Jykge1xuICAgICAgY29udGVudFR5cGUgPSAndGV4dC9jc3YnO1xuICAgICAgZmlsZW5hbWUgPSBgcmVsYXRvcmlvX21ldHJpY2FzXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19LmNzdmA7XG4gICAgICAvLyBDb252ZXJ0ZXIgbyBvYmpldG8gcGFyYSBhcnJheSBwYXJhIHBvZGVyIHVzYXIgbyBtw6l0b2RvIGNvbnZlcnRlclBhcmFDU1ZcbiAgICAgIGNvbnN0IHJlbGF0b3Jpb0FycmF5ID0gW3JlbGF0b3Jpb107XG4gICAgICBjb25zdCBjc3ZEYXRhID0gdGhpcy5jb252ZXJ0ZXJQYXJhQ1NWKHJlbGF0b3Jpb0FycmF5KTtcbiAgICAgIHJldHVybiByZXNcbiAgICAgICAgLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgY29udGVudFR5cGUpXG4gICAgICAgIC5zZXRIZWFkZXIoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCBgYXR0YWNobWVudDsgZmlsZW5hbWU9JHtmaWxlbmFtZX1gKVxuICAgICAgICAuc2VuZChjc3ZEYXRhKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUERGXG4gICAgICByZXR1cm4gcmVzXG4gICAgICAgIC5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGNvbnRlbnRUeXBlKVxuICAgICAgICAuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSR7ZmlsZW5hbWV9YClcbiAgICAgICAgLnNlbmQocmVsYXRvcmlvKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydGUgZGFkb3MgcGFyYSBmb3JtYXRvIENTVlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0ZXJQYXJhQ1NWKGRhZG9zOiBhbnlbXSk6IHN0cmluZyB7XG4gICAgaWYgKCFkYWRvcyB8fCAhZGFkb3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLy8gT2J0ZXIgY2FiZcOnYWxob3NcbiAgICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmtleXMoZGFkb3NbMF0pO1xuXG4gICAgLy8gQ3JpYXIgbGluaGEgZGUgY2FiZcOnYWxob1xuICAgIGxldCBjc3YgPSBoZWFkZXJzLmpvaW4oJywnKSArICdcXG4nO1xuXG4gICAgLy8gQWRpY2lvbmFyIGxpbmhhcyBkZSBkYWRvc1xuICAgIGRhZG9zLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlcyA9IGhlYWRlcnMubWFwKChoZWFkZXIpID0+IHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBpdGVtW2hlYWRlcl07XG4gICAgICAgIC8vIFRyYXRhciB2YWxvcmVzIGVzcGVjaWFpc1xuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIC8vIEVzY2FwYXIgYXNwYXMgZSBlbnZvbHZlciBlbSBhc3BhcyBzZSBjb250aXZlciB2w61yZ3VsYXNcbiAgICAgICAgICBjb25zdCBlc2NhcGVkID0gdmFsdWUucmVwbGFjZSgvXCIvZywgJ1wiXCInKTtcbiAgICAgICAgICByZXR1cm4gZXNjYXBlZC5pbmNsdWRlcygnLCcpID8gYFwiJHtlc2NhcGVkfVwiYCA6IGVzY2FwZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgIHJldHVybiB2YWx1ZS50b0lTT1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgLy8gQ29udmVydGVyIG9iamV0b3MgcGFyYSBKU09OIGUgZW52b2x2ZXIgZW0gYXNwYXNcbiAgICAgICAgICByZXR1cm4gYFwiJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSkucmVwbGFjZSgvXCIvZywgJ1wiXCInKX1cImA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfSk7XG5cbiAgICAgIGNzdiArPSB2YWx1ZXMuam9pbignLCcpICsgJ1xcbic7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY3N2O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=