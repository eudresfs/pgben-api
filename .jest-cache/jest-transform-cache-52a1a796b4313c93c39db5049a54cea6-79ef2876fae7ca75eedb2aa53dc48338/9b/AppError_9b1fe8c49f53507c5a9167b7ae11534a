d8030d1dc2a5221aa34c3a5f7b04dfac
"use strict";
/**
 * Classe base para erros padronizados do sistema SEMTAS
 *
 * Implementa o padrão de erro estruturado conforme definido
 * no catálogo de erros, com suporte a contexto dinâmico,
 * localização e observabilidade.
 *
 * @see docs/ADRs/catalogo-erros.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppError = void 0;
const common_1 = require("@nestjs/common");
const catalog_1 = require("./catalog");
/**
 * Classe principal para erros padronizados do sistema
 */
class AppError extends common_1.HttpException {
    /** Código único do erro conforme catálogo */
    errorCode;
    /** Definição completa do erro do catálogo */
    definition;
    /** Contexto dinâmico do erro */
    context;
    /** Timestamp de quando o erro ocorreu */
    timestamp;
    /** Mensagem localizada (se disponível) */
    localizedMessage;
    constructor(errorCode, context = {}, acceptedLanguage = 'pt-BR') {
        const definition = catalog_1.ERROR_CATALOG[errorCode];
        if (!definition) {
            throw new Error(`Código de erro não encontrado no catálogo: ${errorCode}`);
        }
        // Interpolar dados na mensagem se fornecidos
        const message = context.data
            ? AppError.interpolateMessage(definition.message, context.data)
            : definition.message;
        super(message, definition.httpStatus);
        this.name = 'AppError';
        this.errorCode = errorCode;
        this.definition = definition;
        this.context = context;
        this.timestamp = new Date();
        // Definir mensagem localizada
        if (definition.localizedMessages?.[acceptedLanguage]) {
            this.localizedMessage = context.data
                ? AppError.interpolateMessage(definition.localizedMessages[acceptedLanguage], context.data)
                : definition.localizedMessages[acceptedLanguage];
        }
        // Preservar stack trace da causa raiz
        if (context.cause) {
            this.stack = context.cause.stack;
        }
    }
    /**
     * Interpola dados dinâmicos na mensagem usando placeholders
     * Formato: "Erro no campo {fieldName} com valor {value}"
     */
    static interpolateMessage(template, data) {
        return template.replace(/\{([^}]+)\}/g, (match, key) => {
            return data[key]?.toString() || match;
        });
    }
    /**
     * Retorna representação JSON estruturada do erro
     */
    toJSON() {
        return {
            errorCode: this.errorCode,
            message: this.message,
            localizedMessage: this.localizedMessage,
            httpStatus: this.getStatus(),
            category: this.definition.category,
            severity: this.definition.severity,
            timestamp: this.timestamp.toISOString(),
            context: {
                data: this.context.data,
                metadata: this.context.metadata,
                requestId: this.context.requestId,
                userId: this.context.userId,
                operationalContext: this.context.operationalContext,
            },
            legalReference: this.definition.legalReference,
        };
    }
    /**
     * Retorna dados estruturados para logging
     */
    getLogData() {
        return {
            errorCode: this.errorCode,
            category: this.definition.category,
            severity: this.definition.severity,
            httpStatus: this.getStatus(),
            message: this.message,
            localizedMessage: this.localizedMessage,
            timestamp: this.timestamp.toISOString(),
            requestId: this.context.requestId,
            userId: this.context.userId,
            operationalContext: this.context.operationalContext,
            metadata: this.context.metadata,
            legalReference: this.definition.legalReference,
            causedBy: this.context.cause?.message,
        };
    }
    /**
     * Retorna dados seguros para resposta da API (sem informações sensíveis)
     */
    getApiResponse(includeDetails = false) {
        const response = {
            code: this.errorCode,
            message: this.localizedMessage || this.message,
            category: this.definition.category,
            timestamp: this.timestamp.toISOString(),
        };
        if (includeDetails && this.context.data) {
            // Filtrar dados sensíveis antes de incluir
            const safeData = this.filterSensitiveData(this.context.data);
            if (Object.keys(safeData).length > 0) {
                response.details = safeData;
            }
        }
        if (this.definition.legalReference) {
            response.legalReference = this.definition.legalReference;
        }
        return response;
    }
    /**
     * Remove dados sensíveis do contexto para exposição segura
     */
    filterSensitiveData(data) {
        const sensitiveKeys = [
            'password',
            'senha',
            'token',
            'secret',
            'key',
            'cpf',
            'rg',
            'email',
            'telefone',
            'endereco',
            'address',
            'phone',
        ];
        const filtered = {};
        for (const [key, value] of Object.entries(data)) {
            const isSensitive = sensitiveKeys.some((sensitiveKey) => key.toLowerCase().includes(sensitiveKey.toLowerCase()));
            if (!isSensitive) {
                filtered[key] = value;
            }
        }
        return filtered;
    }
    /**
     * Verifica se o erro é crítico baseado na severidade
     */
    isCritical() {
        return this.definition.severity === catalog_1.ErrorSeverity.CRITICAL;
    }
    /**
     * Verifica se o erro é de alta severidade
     */
    isHighSeverity() {
        return this.definition.severity === catalog_1.ErrorSeverity.HIGH || this.isCritical();
    }
    /**
     * Verifica se o erro pertence a uma categoria específica
     */
    isCategory(category) {
        return this.definition.category === category;
    }
    /**
     * Cria uma nova instância do erro com contexto adicional
     */
    withContext(additionalContext) {
        const mergedContext = {
            ...this.context,
            ...additionalContext,
            data: { ...this.context.data, ...additionalContext.data },
            metadata: { ...this.context.metadata, ...additionalContext.metadata },
        };
        return new AppError(this.errorCode, mergedContext);
    }
    /**
     * Factory method para criar erro a partir de código PostgreSQL
     */
    static fromPostgresError(postgresCode, context = {}, acceptedLanguage = 'pt-BR') {
        // Importar o mapa aqui para evitar dependência circular
        const { POSTGRES_ERROR_MAP } = require('./catalog');
        const errorCode = POSTGRES_ERROR_MAP[postgresCode];
        if (!errorCode) {
            // Fallback para erro genérico de sistema
            return new AppError('SYSTEM_DATABASE_ERROR', {
                ...context,
                metadata: {
                    ...context.metadata,
                    postgresCode,
                },
            }, acceptedLanguage);
        }
        return new AppError(errorCode, {
            ...context,
            metadata: {
                ...context.metadata,
                postgresCode,
            },
        }, acceptedLanguage);
    }
}
exports.AppError = AppError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZXhjZXB0aW9uc1xcZXJyb3ItY2F0YWxvZ1xcQXBwRXJyb3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7OztHQVFHOzs7QUFFSCwyQ0FBK0M7QUFDL0MsdUNBS21CO0FBeUJuQjs7R0FFRztBQUNILE1BQWEsUUFBUyxTQUFRLHNCQUFhO0lBQ3pDLDZDQUE2QztJQUM3QixTQUFTLENBQVM7SUFFbEMsNkNBQTZDO0lBQzdCLFVBQVUsQ0FBa0I7SUFFNUMsZ0NBQWdDO0lBQ2hCLE9BQU8sQ0FBZTtJQUV0Qyx5Q0FBeUM7SUFDekIsU0FBUyxDQUFPO0lBRWhDLDBDQUEwQztJQUMxQixnQkFBZ0IsQ0FBVTtJQUUxQyxZQUNFLFNBQWlCLEVBQ2pCLFVBQXdCLEVBQUUsRUFDMUIsbUJBQTJCLE9BQU87UUFFbEMsTUFBTSxVQUFVLEdBQUcsdUJBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FDYiw4Q0FBOEMsU0FBUyxFQUFFLENBQzFELENBQUM7UUFDSixDQUFDO1FBRUQsNkNBQTZDO1FBQzdDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJO1lBQzFCLENBQUMsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQy9ELENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDO1FBRXZCLEtBQUssQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUks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LENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRTtTQUN0RSxDQUFDO1FBRUYsT0FBTyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRDs7T0FFRztJQUNJLE1BQU0sQ0FBQyxpQkFBaUIsQ0FDN0IsWUFBb0IsRUFDcEIsVUFBd0IsRUFBRSxFQUMxQixtQkFBMkIsT0FBTztRQUVsQyx3REFBd0Q7UUFDeEQsTUFBTSxFQUFFLGtCQUFrQixFQUFFLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXBELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRW5ELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLHlDQUF5QztZQUN6QyxPQUFPLElBQUksUUFBUSxDQUNqQix1QkFBdUIsRUFDdkI7Z0JBQ0UsR0FBRyxPQUFPO2dCQUNWLFFBQVEsRUFBRTtvQkFDUixHQUFHLE9BQU8sQ0FBQyxRQUFRO29CQUNuQixZQUFZO2lCQUNiO2FBQ0YsRUFDRCxnQkFBZ0IsQ0FDakIsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPLElBQUksUUFBUSxDQUNqQixTQUFTLEVBQ1Q7WUFDRSxHQUFHLE9BQU87WUFDVixRQUFRLEVBQUU7Z0JBQ1IsR0FBRyxPQUFPLENBQUMsUUFBUTtnQkFDbkIsWUFBWTthQUNiO1NBQ0YsRUFDRCxnQkFBZ0IsQ0FDakIsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTFQRCw0QkEwUEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZXhjZXB0aW9uc1xcZXJyb3ItY2F0YWxvZ1xcQXBwRXJyb3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDbGFzc2UgYmFzZSBwYXJhIGVycm9zIHBhZHJvbml6YWRvcyBkbyBzaXN0ZW1hIFNFTVRBU1xuICpcbiAqIEltcGxlbWVudGEgbyBwYWRyw6NvIGRlIGVycm8gZXN0cnV0dXJhZG8gY29uZm9ybWUgZGVmaW5pZG9cbiAqIG5vIGNhdMOhbG9nbyBkZSBlcnJvcywgY29tIHN1cG9ydGUgYSBjb250ZXh0byBkaW7Dom1pY28sXG4gKiBsb2NhbGl6YcOnw6NvIGUgb2JzZXJ2YWJpbGlkYWRlLlxuICpcbiAqIEBzZWUgZG9jcy9BRFJzL2NhdGFsb2dvLWVycm9zLm1kXG4gKi9cblxuaW1wb3J0IHsgSHR0cEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7XG4gIEVSUk9SX0NBVEFMT0csXG4gIEVycm9yRGVmaW5pdGlvbixcbiAgRXJyb3JDYXRlZ29yeSxcbiAgRXJyb3JTZXZlcml0eSxcbn0gZnJvbSAnLi9jYXRhbG9nJztcblxuLyoqXG4gKiBDb250ZXh0byBkaW7Dom1pY28gcGFyYSBwZXJzb25hbGl6YcOnw6NvIGRlIGVycm9zXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXJyb3JDb250ZXh0IHtcbiAgLyoqIERhZG9zIGVzcGVjw61maWNvcyBkbyBlcnJvIHBhcmEgaW50ZXJwb2xhw6fDo28gbmEgbWVuc2FnZW0gKi9cbiAgZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIC8qKiBDYXVzYSByYWl6IGRvIGVycm8gKHBhcmEgZW5jYWRlYW1lbnRvKSAqL1xuICBjYXVzZT86IEVycm9yO1xuICAvKiogTWV0YWRhZG9zIGFkaWNpb25haXMgcGFyYSBsb2dnaW5nIGUgZGVidWdnaW5nICovXG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgLyoqIElEIGRhIHJlcXVpc2nDp8OjbyBwYXJhIHJhc3RyZWFiaWxpZGFkZSAqL1xuICByZXF1ZXN0SWQ/OiBzdHJpbmc7XG4gIC8qKiBJRCBkbyB1c3XDoXJpbyBxdWUgY2F1c291IG8gZXJybyAqL1xuICB1c2VySWQ/OiBzdHJpbmc7XG4gIC8qKiBDb250ZXh0byBvcGVyYWNpb25hbCBhZGljaW9uYWwgKi9cbiAgb3BlcmF0aW9uYWxDb250ZXh0Pzoge1xuICAgIG1vZHVsZT86IHN0cmluZztcbiAgICBvcGVyYXRpb24/OiBzdHJpbmc7XG4gICAgZW50aXR5SWQ/OiBzdHJpbmc7XG4gICAgZW50aXR5VHlwZT86IHN0cmluZztcbiAgfTtcbn1cblxuLyoqXG4gKiBDbGFzc2UgcHJpbmNpcGFsIHBhcmEgZXJyb3MgcGFkcm9uaXphZG9zIGRvIHNpc3RlbWFcbiAqL1xuZXhwb3J0IGNsYXNzIEFwcEVycm9yIGV4dGVuZHMgSHR0cEV4Y2VwdGlvbiB7XG4gIC8qKiBDw7NkaWdvIMO6bmljbyBkbyBlcnJvIGNvbmZvcm1lIGNhdMOhbG9nbyAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZXJyb3JDb2RlOiBzdHJpbmc7XG5cbiAgLyoqIERlZmluacOnw6NvIGNvbXBsZXRhIGRvIGVycm8gZG8gY2F0w6Fsb2dvICovXG4gIHB1YmxpYyByZWFkb25seSBkZWZpbml0aW9uOiBFcnJvckRlZmluaXRpb247XG5cbiAgLyoqIENvbnRleHRvIGRpbsOibWljbyBkbyBlcnJvICovXG4gIHB1YmxpYyByZWFkb25seSBjb250ZXh0OiBFcnJvckNvbnRleHQ7XG5cbiAgLyoqIFRpbWVzdGFtcCBkZSBxdWFuZG8gbyBlcnJvIG9jb3JyZXUgKi9cbiAgcHVibGljIHJlYWRvbmx5IHRpbWVzdGFtcDogRGF0ZTtcblxuICAvKiogTWVuc2FnZW0gbG9jYWxpemFkYSAoc2UgZGlzcG9uw612ZWwpICovXG4gIHB1YmxpYyByZWFkb25seSBsb2NhbGl6ZWRNZXNzYWdlPzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGVycm9yQ29kZTogc3RyaW5nLFxuICAgIGNvbnRleHQ6IEVycm9yQ29udGV4dCA9IHt9LFxuICAgIGFjY2VwdGVkTGFuZ3VhZ2U6IHN0cmluZyA9ICdwdC1CUicsXG4gICkge1xuICAgIGNvbnN0IGRlZmluaXRpb24gPSBFUlJPUl9DQVRBTE9HW2Vycm9yQ29kZV07XG5cbiAgICBpZiAoIWRlZmluaXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEPDs2RpZ28gZGUgZXJybyBuw6NvIGVuY29udHJhZG8gbm8gY2F0w6Fsb2dvOiAke2Vycm9yQ29kZX1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBJbnRlcnBvbGFyIGRhZG9zIG5hIG1lbnNhZ2VtIHNlIGZvcm5lY2lkb3NcbiAgICBjb25zdCBtZXNzYWdlID0gY29udGV4dC5kYXRhXG4gICAgICA/IEFwcEVycm9yLmludGVycG9sYXRlTWVzc2FnZShkZWZpbml0aW9uLm1lc3NhZ2UsIGNvbnRleHQuZGF0YSlcbiAgICAgIDogZGVmaW5pdGlvbi5tZXNzYWdlO1xuXG4gICAgc3VwZXIobWVzc2FnZSwgZGVmaW5pdGlvbi5odHRwU3RhdHVzKTtcblxuICAgIHRoaXMubmFtZSA9ICdBcHBFcnJvcic7XG4gICAgdGhpcy5lcnJvckNvZGUgPSBlcnJvckNvZGU7XG4gICAgdGhpcy5kZWZpbml0aW9uID0gZGVmaW5pdGlvbjtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMudGltZXN0YW1wID0gbmV3IERhdGUoKTtcblxuICAgIC8vIERlZmluaXIgbWVuc2FnZW0gbG9jYWxpemFkYVxuICAgIGlmIChkZWZpbml0aW9uLmxvY2FsaXplZE1lc3NhZ2VzPy5bYWNjZXB0ZWRMYW5ndWFnZV0pIHtcbiAgICAgIHRoaXMubG9jYWxpemVkTWVzc2FnZSA9IGNvbnRleHQuZGF0YVxuICAgICAgICA/IEFwcEVycm9yLmludGVycG9sYXRlTWVzc2FnZShcbiAgICAgICAgICAgIGRlZmluaXRpb24ubG9jYWxpemVkTWVzc2FnZXNbYWNjZXB0ZWRMYW5ndWFnZV0sXG4gICAgICAgICAgICBjb250ZXh0LmRhdGEsXG4gICAgICAgICAgKVxuICAgICAgICA6IGRlZmluaXRpb24ubG9jYWxpemVkTWVzc2FnZXNbYWNjZXB0ZWRMYW5ndWFnZV07XG4gICAgfVxuXG4gICAgLy8gUHJlc2VydmFyIHN0YWNrIHRyYWNlIGRhIGNhdXNhIHJhaXpcbiAgICBpZiAoY29udGV4dC5jYXVzZSkge1xuICAgICAgdGhpcy5zdGFjayA9IGNvbnRleHQuY2F1c2Uuc3RhY2s7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEludGVycG9sYSBkYWRvcyBkaW7Dom1pY29zIG5hIG1lbnNhZ2VtIHVzYW5kbyBwbGFjZWhvbGRlcnNcbiAgICogRm9ybWF0bzogXCJFcnJvIG5vIGNhbXBvIHtmaWVsZE5hbWV9IGNvbSB2YWxvciB7dmFsdWV9XCJcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGludGVycG9sYXRlTWVzc2FnZShcbiAgICB0ZW1wbGF0ZTogc3RyaW5nLFxuICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRlbXBsYXRlLnJlcGxhY2UoL1xceyhbXn1dKylcXH0vZywgKG1hdGNoLCBrZXkpID0+IHtcbiAgICAgIHJldHVybiBkYXRhW2tleV0/LnRvU3RyaW5nKCkgfHwgbWF0Y2g7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSByZXByZXNlbnRhw6fDo28gSlNPTiBlc3RydXR1cmFkYSBkbyBlcnJvXG4gICAqL1xuICBwdWJsaWMgdG9KU09OKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB7XG4gICAgICBlcnJvckNvZGU6IHRoaXMuZXJyb3JDb2RlLFxuICAgICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLFxuICAgICAgbG9jYWxpemVkTWVzc2FnZTogdGhpcy5sb2NhbGl6ZWRNZXNzYWdlLFxuICAgICAgaHR0cFN0YXR1czogdGhpcy5nZXRTdGF0dXMoKSxcbiAgICAgIGNhdGVnb3J5OiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnksXG4gICAgICBzZXZlcml0eTogdGhpcy5kZWZpbml0aW9uLnNldmVyaXR5LFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcC50b0lTT1N0cmluZygpLFxuICAgICAgY29udGV4dDoge1xuICAgICAgICBkYXRhOiB0aGlzLmNvbnRleHQuZGF0YSxcbiAgICAgICAgbWV0YWRhdGE6IHRoaXMuY29udGV4dC5tZXRhZGF0YSxcbiAgICAgICAgcmVxdWVzdElkOiB0aGlzLmNvbnRleHQucmVxdWVzdElkLFxuICAgICAgICB1c2VySWQ6IHRoaXMuY29udGV4dC51c2VySWQsXG4gICAgICAgIG9wZXJhdGlvbmFsQ29udGV4dDogdGhpcy5jb250ZXh0Lm9wZXJhdGlvbmFsQ29udGV4dCxcbiAgICAgIH0sXG4gICAgICBsZWdhbFJlZmVyZW5jZTogdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBkYWRvcyBlc3RydXR1cmFkb3MgcGFyYSBsb2dnaW5nXG4gICAqL1xuICBwdWJsaWMgZ2V0TG9nRGF0YSgpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgZXJyb3JDb2RlOiB0aGlzLmVycm9yQ29kZSxcbiAgICAgIGNhdGVnb3J5OiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnksXG4gICAgICBzZXZlcml0eTogdGhpcy5kZWZpbml0aW9uLnNldmVyaXR5LFxuICAgICAgaHR0cFN0YXR1czogdGhpcy5nZXRTdGF0dXMoKSxcbiAgICAgIG1lc3NhZ2U6IHRoaXMubWVzc2FnZSxcbiAgICAgIGxvY2FsaXplZE1lc3NhZ2U6IHRoaXMubG9jYWxpemVkTWVzc2FnZSxcbiAgICAgIHRpbWVzdGFtcDogdGhpcy50aW1lc3RhbXAudG9JU09TdHJpbmcoKSxcbiAgICAgIHJlcXVlc3RJZDogdGhpcy5jb250ZXh0LnJlcXVlc3RJZCxcbiAgICAgIHVzZXJJZDogdGhpcy5jb250ZXh0LnVzZXJJZCxcbiAgICAgIG9wZXJhdGlvbmFsQ29udGV4dDogdGhpcy5jb250ZXh0Lm9wZXJhdGlvbmFsQ29udGV4dCxcbiAgICAgIG1ldGFkYXRhOiB0aGlzLmNvbnRleHQubWV0YWRhdGEsXG4gICAgICBsZWdhbFJlZmVyZW5jZTogdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlLFxuICAgICAgY2F1c2VkQnk6IHRoaXMuY29udGV4dC5jYXVzZT8ubWVzc2FnZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgZGFkb3Mgc2VndXJvcyBwYXJhIHJlc3Bvc3RhIGRhIEFQSSAoc2VtIGluZm9ybWHDp8O1ZXMgc2Vuc8OtdmVpcylcbiAgICovXG4gIHB1YmxpYyBnZXRBcGlSZXNwb25zZShpbmNsdWRlRGV0YWlsczogYm9vbGVhbiA9IGZhbHNlKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICBjb2RlOiB0aGlzLmVycm9yQ29kZSxcbiAgICAgIG1lc3NhZ2U6IHRoaXMubG9jYWxpemVkTWVzc2FnZSB8fCB0aGlzLm1lc3NhZ2UsXG4gICAgICBjYXRlZ29yeTogdGhpcy5kZWZpbml0aW9uLmNhdGVnb3J5LFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcC50b0lTT1N0cmluZygpLFxuICAgIH07XG5cbiAgICBpZiAoaW5jbHVkZURldGFpbHMgJiYgdGhpcy5jb250ZXh0LmRhdGEpIHtcbiAgICAgIC8vIEZpbHRyYXIgZGFkb3Mgc2Vuc8OtdmVpcyBhbnRlcyBkZSBpbmNsdWlyXG4gICAgICBjb25zdCBzYWZlRGF0YSA9IHRoaXMuZmlsdGVyU2Vuc2l0aXZlRGF0YSh0aGlzLmNvbnRleHQuZGF0YSk7XG4gICAgICBpZiAoT2JqZWN0LmtleXMoc2FmZURhdGEpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgKHJlc3BvbnNlIGFzIGFueSkuZGV0YWlscyA9IHNhZmVEYXRhO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmRlZmluaXRpb24ubGVnYWxSZWZlcmVuY2UpIHtcbiAgICAgIChyZXNwb25zZSBhcyBhbnkpLmxlZ2FsUmVmZXJlbmNlID0gdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlO1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgZGFkb3Mgc2Vuc8OtdmVpcyBkbyBjb250ZXh0byBwYXJhIGV4cG9zacOnw6NvIHNlZ3VyYVxuICAgKi9cbiAgcHJpdmF0ZSBmaWx0ZXJTZW5zaXRpdmVEYXRhKGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICBjb25zdCBzZW5zaXRpdmVLZXlzID0gW1xuICAgICAgJ3Bhc3N3b3JkJyxcbiAgICAgICdzZW5oYScsXG4gICAgICAndG9rZW4nLFxuICAgICAgJ3NlY3JldCcsXG4gICAgICAna2V5JyxcbiAgICAgICdjcGYnLFxuICAgICAgJ3JnJyxcbiAgICAgICdlbWFpbCcsXG4gICAgICAndGVsZWZvbmUnLFxuICAgICAgJ2VuZGVyZWNvJyxcbiAgICAgICdhZGRyZXNzJyxcbiAgICAgICdwaG9uZScsXG4gICAgXTtcblxuICAgIGNvbnN0IGZpbHRlcmVkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkYXRhKSkge1xuICAgICAgY29uc3QgaXNTZW5zaXRpdmUgPSBzZW5zaXRpdmVLZXlzLnNvbWUoKHNlbnNpdGl2ZUtleSkgPT5cbiAgICAgICAga2V5LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2Vuc2l0aXZlS2V5LnRvTG93ZXJDYXNlKCkpLFxuICAgICAgKTtcblxuICAgICAgaWYgKCFpc1NlbnNpdGl2ZSkge1xuICAgICAgICBmaWx0ZXJlZFtrZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbHRlcmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gZXJybyDDqSBjcsOtdGljbyBiYXNlYWRvIG5hIHNldmVyaWRhZGVcbiAgICovXG4gIHB1YmxpYyBpc0NyaXRpY2FsKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuQ1JJVElDQUw7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyBlcnJvIMOpIGRlIGFsdGEgc2V2ZXJpZGFkZVxuICAgKi9cbiAgcHVibGljIGlzSGlnaFNldmVyaXR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuSElHSCB8fCB0aGlzLmlzQ3JpdGljYWwoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIGVycm8gcGVydGVuY2UgYSB1bWEgY2F0ZWdvcmlhIGVzcGVjw61maWNhXG4gICAqL1xuICBwdWJsaWMgaXNDYXRlZ29yeShjYXRlZ29yeTogRXJyb3JDYXRlZ29yeSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnkgPT09IGNhdGVnb3J5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyaWEgdW1hIG5vdmEgaW5zdMOibmNpYSBkbyBlcnJvIGNvbSBjb250ZXh0byBhZGljaW9uYWxcbiAgICovXG4gIHB1YmxpYyB3aXRoQ29udGV4dChhZGRpdGlvbmFsQ29udGV4dDogUGFydGlhbDxFcnJvckNvbnRleHQ+KTogQXBwRXJyb3Ige1xuICAgIGNvbnN0IG1lcmdlZENvbnRleHQ6IEVycm9yQ29udGV4dCA9IHtcbiAgICAgIC4uLnRoaXMuY29udGV4dCxcbiAgICAgIC4uLmFkZGl0aW9uYWxDb250ZXh0LFxuICAgICAgZGF0YTogeyAuLi50aGlzLmNvbnRleHQuZGF0YSwgLi4uYWRkaXRpb25hbENvbnRleHQuZGF0YSB9LFxuICAgICAgbWV0YWRhdGE6IHsgLi4udGhpcy5jb250ZXh0Lm1ldGFkYXRhLCAuLi5hZGRpdGlvbmFsQ29udGV4dC5tZXRhZGF0YSB9LFxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IEFwcEVycm9yKHRoaXMuZXJyb3JDb2RlLCBtZXJnZWRDb250ZXh0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGYWN0b3J5IG1ldGhvZCBwYXJhIGNyaWFyIGVycm8gYSBwYXJ0aXIgZGUgY8OzZGlnbyBQb3N0Z3JlU1FMXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21Qb3N0Z3Jlc0Vycm9yKFxuICAgIHBvc3RncmVzQ29kZTogc3RyaW5nLFxuICAgIGNvbnRleHQ6IEVycm9yQ29udGV4dCA9IHt9LFxuICAgIGFjY2VwdGVkTGFuZ3VhZ2U6IHN0cmluZyA9ICdwdC1CUicsXG4gICk6IEFwcEVycm9yIHtcbiAgICAvLyBJbXBvcnRhciBvIG1hcGEgYXF1aSBwYXJhIGV2aXRhciBkZXBlbmTDqm5jaWEgY2lyY3VsYXJcbiAgICBjb25zdCB7IFBPU1RHUkVTX0VSUk9SX01BUCB9ID0gcmVxdWlyZSgnLi9jYXRhbG9nJyk7XG5cbiAgICBjb25zdCBlcnJvckNvZGUgPSBQT1NUR1JFU19FUlJPUl9NQVBbcG9zdGdyZXNDb2RlXTtcblxuICAgIGlmICghZXJyb3JDb2RlKSB7XG4gICAgICAvLyBGYWxsYmFjayBwYXJhIGVycm8gZ2Vuw6lyaWNvIGRlIHNpc3RlbWFcbiAgICAgIHJldHVybiBuZXcgQXBwRXJyb3IoXG4gICAgICAgICdTWVNURU1fREFUQUJBU0VfRVJST1InLFxuICAgICAgICB7XG4gICAgICAgICAgLi4uY29udGV4dCxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgLi4uY29udGV4dC5tZXRhZGF0YSxcbiAgICAgICAgICAgIHBvc3RncmVzQ29kZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBhY2NlcHRlZExhbmd1YWdlLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEFwcEVycm9yKFxuICAgICAgZXJyb3JDb2RlLFxuICAgICAge1xuICAgICAgICAuLi5jb250ZXh0LFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIC4uLmNvbnRleHQubWV0YWRhdGEsXG4gICAgICAgICAgcG9zdGdyZXNDb2RlLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGFjY2VwdGVkTGFuZ3VhZ2UsXG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9