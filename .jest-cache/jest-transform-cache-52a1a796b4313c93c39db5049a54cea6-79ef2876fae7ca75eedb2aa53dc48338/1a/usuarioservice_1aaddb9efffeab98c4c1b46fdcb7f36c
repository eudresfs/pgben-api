15d596f8c23155ca7005724a79bb81c1
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var UsuarioService_1;
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UsuarioService = void 0;
const common_1 = require("@nestjs/common");
const usuario_errors_1 = require("../../../shared/exceptions/error-catalog/domains/usuario.errors");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const bcrypt = __importStar(require("bcrypt"));
const usuario_repository_1 = require("../repositories/usuario.repository");
const usuario_entity_1 = require("../../../entities/usuario.entity");
const role_entity_1 = require("../../../entities/role.entity");
const status_enum_1 = require("../../../enums/status.enum");
const notification_manager_service_1 = require("../../notificacao/services/notification-manager.service");
const notification_template_entity_1 = require("../../../entities/notification-template.entity");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
/**
 * Serviço de usuários
 *
 * Responsável pela lógica de negócio relacionada a usuários
 */
let UsuarioService = UsuarioService_1 = class UsuarioService {
    dataSource;
    usuarioRepository;
    notificationManager;
    templateRepository;
    roleRepository;
    logger = new common_1.Logger(UsuarioService_1.name);
    SALT_ROUNDS = 12; // Aumentando a segurança do hash
    MAX_LOGIN_ATTEMPTS = 5; // Máximo de tentativas de login
    LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutos em ms
    constructor(dataSource, usuarioRepository, notificationManager, templateRepository, roleRepository) {
        this.dataSource = dataSource;
        this.usuarioRepository = usuarioRepository;
        this.notificationManager = notificationManager;
        this.templateRepository = templateRepository;
        this.roleRepository = roleRepository;
    }
    /**
     * Gera uma senha aleatória segura que atende aos critérios de validação
     * @returns Senha aleatória de 12 caracteres
     */
    generateRandomPassword() {
        const lowercase = 'abcdefghijklmnopqrstuvwxyz';
        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const numbers = '0123456789';
        const symbols = '@$!%*?&#';
        // Garantir pelo menos um caractere de cada tipo obrigatório
        let password = '';
        password += lowercase[Math.floor(Math.random() * lowercase.length)];
        password += uppercase[Math.floor(Math.random() * uppercase.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];
        password += symbols[Math.floor(Math.random() * symbols.length)];
        // Completar com caracteres aleatórios até 12 caracteres
        const allChars = lowercase + uppercase + numbers + symbols;
        for (let i = 4; i < 12; i++) {
            password += allChars[Math.floor(Math.random() * allChars.length)];
        }
        // Embaralhar a senha para evitar padrões previsíveis
        return password.split('').sort(() => Math.random() - 0.5).join('');
    }
    /**
     * Envia credenciais por email para usuário recém-criado
     * @param usuario Usuário criado
     * @param senha Senha em texto plano
     */
    async enviarCredenciaisPorEmail(usuario, senha) {
        try {
            // Buscar template de credenciais
            const template = await this.templateRepository.findOne({
                where: { nome: 'Credenciais de Acesso - Novo Usuário' }
            });
            if (!template) {
                this.logger.error('Template de credenciais não encontrado');
                return;
            }
            // Dados para o template
            const dadosTemplate = {
                nome: usuario.nome,
                email: usuario.email,
                senha: senha,
                matricula: usuario.matricula,
                sistema_url: process.env.FRONTEND_URL || 'https://pgben.natal.rn.gov.br',
                data_criacao: new Date().toLocaleDateString('pt-BR')
            };
            // Criar notificação
            await this.notificationManager.criarNotificacao({
                template_id: template.id,
                destinatario_id: usuario.id,
                dados_contexto: dadosTemplate
            });
            this.logger.log(`Credenciais enviadas por email para: ${usuario.email}`);
        }
        catch (error) {
            this.logger.error(`Erro ao enviar credenciais por email: ${error.message}`);
            // Não falhar a criação do usuário por erro no envio do email
        }
    }
    /**
     * Busca todos os usuários com filtros e paginação
     * @param options Opções de filtro e paginação
     * @returns Lista de usuários paginada
     */
    async findAll(options) {
        const { page = 1, limit = 10, search, role, status, unidade_id, } = options || {};
        // Construir filtros
        const where = {};
        if (search) {
            where.nome = { $iLike: `%${search}%` };
        }
        if (role) {
            where.role = role;
        }
        if (status) {
            where.status = status;
        }
        if (unidade_id) {
            where.unidade_id = unidade_id;
        }
        // Calcular skip para paginação
        const skip = (page - 1) * limit;
        // Buscar usuários
        const [usuarios, total] = await this.usuarioRepository.findAll({
            skip,
            take: limit,
            where,
        });
        // Remover campos sensíveis
        const usuariosSemSenha = usuarios.map((usuario) => {
            const { senhaHash, ...usuarioSemSenha } = usuario;
            return usuarioSemSenha;
        });
        return {
            items: usuariosSemSenha,
            meta: {
                total,
                page,
                limit,
                totalPages: Math.ceil(total / limit),
            },
        };
    }
    /**
     * Busca um usuário pelo ID
     * @param id ID do usuário
     * @returns Usuário encontrado
     */
    async findById(id) {
        const usuario = await this.usuarioRepository.findById(id);
        if (!usuario) {
            (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id });
        }
        // Remover campos sensíveis
        const { senhaHash, ...usuarioSemSenha } = usuario;
        return usuarioSemSenha;
    }
    /**
     * Cria um novo usuário
     * @param createUsuarioDto Dados do usuário
     * @returns Usuário criado
     */
    async create(createUsuarioDto) {
        this.logger.log(`Iniciando criação de usuário: ${createUsuarioDto.email}`);
        try {
            // Usar transação para garantir consistência
            return await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository('usuario');
                const unidadeRepo = manager.getRepository('unidade');
                const setorRepo = manager.getRepository('setor');
                // Verificar se email já existe
                const emailExistente = await usuarioRepo.findOne({
                    where: { email: createUsuarioDto.email },
                });
                if (emailExistente) {
                    this.logger.warn(`Email já está em uso: ${createUsuarioDto.email}`);
                    (0, usuario_errors_1.throwUsuarioEmailDuplicated)({ email: createUsuarioDto.email });
                }
                // Verificar se CPF já existe
                const cpfExistente = await usuarioRepo.findOne({
                    where: { cpf: createUsuarioDto.cpf },
                });
                if (cpfExistente) {
                    this.logger.warn(`CPF já está em uso: ${createUsuarioDto.cpf}`);
                    (0, usuario_errors_1.throwUsuarioCpfDuplicated)({ cpf: createUsuarioDto.cpf });
                }
                // Verificar se matrícula já existe
                const matriculaExistente = await usuarioRepo.findOne({
                    where: { matricula: createUsuarioDto.matricula },
                });
                if (matriculaExistente) {
                    this.logger.warn(`Matrícula já está em uso: ${createUsuarioDto.matricula}`);
                    (0, usuario_errors_1.throwUsuarioMatriculaDuplicated)({ matricula: createUsuarioDto.matricula });
                }
                // Verificar se a unidade existe
                if (createUsuarioDto.unidade_id) {
                    const unidade = await unidadeRepo.findOne({
                        where: { id: createUsuarioDto.unidade_id },
                    });
                    if (!unidade) {
                        this.logger.warn(`Unidade não encontrada: ${createUsuarioDto.unidade_id}`);
                        (0, usuario_errors_1.throwUsuarioUnidadeNotFound)({ unidadeId: createUsuarioDto.unidade_id });
                    }
                    // Verificar se o setor existe e pertence à unidade
                    if (createUsuarioDto.setor_id) {
                        const setor = await setorRepo.findOne({
                            where: {
                                id: createUsuarioDto.setor_id,
                                unidade_id: createUsuarioDto.unidade_id
                            },
                        });
                        if (!setor) {
                            this.logger.warn(`Setor não encontrado para a unidade: ${createUsuarioDto.setor_id}`);
                            (0, usuario_errors_1.throwUsuarioSetorNotFound)({ setorId: createUsuarioDto.setor_id });
                        }
                    }
                }
                // Determinar senha a ser usada
                let senhaParaUso;
                let senhaGerada = false;
                if (createUsuarioDto.senha) {
                    senhaParaUso = createUsuarioDto.senha;
                }
                else {
                    senhaParaUso = this.generateRandomPassword();
                    senhaGerada = true;
                    this.logger.log(`Senha gerada automaticamente para usuário: ${createUsuarioDto.email}`);
                }
                // Gerar hash da senha com maior segurança
                const senhaHash = await bcrypt.hash(senhaParaUso, this.SALT_ROUNDS);
                // Normalizar campos de enum antes de criar
                const normalizedData = (0, enum_normalizer_util_1.normalizeEnumFields)({
                    nome: createUsuarioDto.nome,
                    email: createUsuarioDto.email.toLowerCase(), // Normalizar email para minúsculas
                    senhaHash,
                    cpf: createUsuarioDto.cpf,
                    telefone: createUsuarioDto.telefone,
                    matricula: createUsuarioDto.matricula,
                    role_id: createUsuarioDto.role_id,
                    unidade_id: createUsuarioDto.unidade_id,
                    setor_id: createUsuarioDto.setor_id,
                    primeiro_acesso: true, // Sempre true para novos usuários
                    ultimo_login: null,
                    tentativas_login: 0,
                });
                // Criar usuário
                const novoUsuario = usuarioRepo.create(normalizedData);
                const usuarioSalvo = await usuarioRepo.save(novoUsuario);
                // Enviar credenciais por email se senha foi gerada
                if (senhaGerada) {
                    await this.enviarCredenciaisPorEmail(usuarioSalvo, senhaParaUso);
                }
                this.logger.log(`Usuário criado com sucesso: ${usuarioSalvo.id}`);
                // Remover campos sensíveis
                const { senhaHash: _, ...usuarioSemSenha } = usuarioSalvo;
                return {
                    data: usuarioSemSenha,
                    meta: null,
                    message: senhaGerada
                        ? 'Usuário criado com sucesso. Credenciais enviadas por email.'
                        : 'Usuário criado com sucesso.'
                };
            });
        }
        catch (error) {
            this.logger.error(`Erro ao criar usuário: ${error.message}`, error.stack);
            if (error instanceof UsuarioError) {
                throw error;
            }
            (0, usuario_errors_1.throwUsuarioInternalError)({ operation: 'create', originalError: error.message });
        }
    }
    /**
     * Atualiza um usuário existente
     * @param id ID do usuário
     * @param updateUsuarioDto Dados a serem atualizados
     * @returns Usuário atualizado
     */
    async update(id, updateUsuarioDto) {
        this.logger.log(`Iniciando atualização do usuário ${id}`);
        try {
            // Usar transação para garantir consistência
            return await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository('usuario');
                // Verificar se usuário existe
                const usuario = await usuarioRepo.findOne({ where: { id } });
                if (!usuario) {
                    this.logger.warn(`Usuário não encontrado: ${id}`);
                    (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id });
                }
                // Verificar se email já existe (se fornecido)
                if (updateUsuarioDto.email &&
                    updateUsuarioDto.email.toLowerCase() !== usuario.email.toLowerCase()) {
                    const emailExistente = await usuarioRepo.findOne({
                        where: { email: updateUsuarioDto.email.toLowerCase() },
                    });
                    if (emailExistente) {
                        this.logger.warn(`Email já está em uso: ${updateUsuarioDto.email}`);
                        (0, usuario_errors_1.throwUsuarioEmailDuplicated)({ email: updateUsuarioDto.email });
                    }
                    // Normalizar email para minúsculas
                    updateUsuarioDto.email = updateUsuarioDto.email.toLowerCase();
                }
                // Verificar se CPF já existe (se fornecido)
                if (updateUsuarioDto.cpf && updateUsuarioDto.cpf !== usuario.cpf) {
                    const cpfExistente = await usuarioRepo.findOne({
                        where: { cpf: updateUsuarioDto.cpf },
                    });
                    if (cpfExistente) {
                        this.logger.warn(`CPF já está em uso: ${updateUsuarioDto.cpf}`);
                        (0, usuario_errors_1.throwUsuarioCpfDuplicated)({ cpf: updateUsuarioDto.cpf });
                    }
                }
                // Verificar se matrícula já existe (se fornecida)
                if (updateUsuarioDto.matricula &&
                    updateUsuarioDto.matricula !== usuario.matricula) {
                    const matriculaExistente = await usuarioRepo.findOne({
                        where: { matricula: updateUsuarioDto.matricula },
                    });
                    if (matriculaExistente) {
                        this.logger.warn(`Matrícula já está em uso: ${updateUsuarioDto.matricula}`);
                        (0, usuario_errors_1.throwUsuarioMatriculaDuplicated)({ matricula: updateUsuarioDto.matricula });
                    }
                }
                // Normalizar campos de enum antes de atualizar
                const normalizedData = (0, enum_normalizer_util_1.normalizeEnumFields)(updateUsuarioDto);
                // Atualizar usuário
                await usuarioRepo.update(id, normalizedData);
                // Buscar usuário atualizado
                const usuarioAtualizado = await usuarioRepo.findOne({ where: { id } });
                if (!usuarioAtualizado) {
                    (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id, operation: 'update_verification' });
                }
                this.logger.log(`Usuário ${id} atualizado com sucesso`);
                // Remover campos sensíveis
                const { senhaHash, ...usuarioSemSenha } = usuarioAtualizado;
                return usuarioSemSenha;
            });
        }
        catch (error) {
            this.logger.error(`Erro ao atualizar usuário ${id}: ${error.message}`, error.stack);
            if (error instanceof UsuarioError) {
                throw error;
            }
            (0, usuario_errors_1.throwUsuarioInternalError)({ operation: 'update', originalError: error.message });
        }
    }
    /**
     * Atualiza o status de um usuário
     * @param id ID do usuário
     * @param updateStatusUsuarioDto Novo status
     * @returns Usuário atualizado
     */
    async updateStatus(id, updateStatusUsuarioDto) {
        // Verificar se usuário existe
        const usuario = await this.usuarioRepository.findById(id);
        if (!usuario) {
            (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id });
        }
        // Atualizar status
        const usuarioAtualizado = await this.usuarioRepository.updateStatus(id, updateStatusUsuarioDto.status);
        // Remover campos sensíveis
        const { senhaHash, ...usuarioSemSenha } = usuarioAtualizado;
        return usuarioSemSenha;
    }
    /**
     * Atualiza a senha de um usuário
     * @param id ID do usuário
     * @param updateSenhaDto Dados da nova senha
     * @returns Mensagem de sucesso
     */
    async updateSenha(id, updateSenhaDto) {
        this.logger.log(`Iniciando atualização de senha do usuário ${id}`);
        try {
            // Usar transação para garantir consistência
            return await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository('usuario');
                // Verificar se usuário existe
                const usuario = await usuarioRepo.findOne({ where: { id } });
                if (!usuario) {
                    this.logger.warn(`Usuário não encontrado: ${id}`);
                    (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id });
                }
                // Verificar se a senha atual está correta
                const senhaCorreta = await bcrypt.compare(updateSenhaDto.senhaAtual, usuario.senhaHash);
                if (!senhaCorreta) {
                    this.logger.warn(`Tentativa de alteração de senha com senha atual incorreta: ${id}`);
                    // Incrementar contador de tentativas falhas para prevenção de ataques de força bruta
                    await usuarioRepo.update(id, {
                        tentativas_login: () => '"tentativas_login" + 1',
                    });
                    (0, usuario_errors_1.throwUsuarioCredentialsInvalid)({ email: usuario.email });
                }
                // Verificar se a nova senha e a confirmação coincidem
                if (updateSenhaDto.novaSenha !== updateSenhaDto.confirmacaoSenha) {
                    this.logger.warn(`Nova senha e confirmação não coincidem: ${id}`);
                    (0, usuario_errors_1.throwUsuarioPasswordMismatch)();
                }
                // Verificar se a nova senha é diferente da atual
                if (updateSenhaDto.novaSenha === updateSenhaDto.senhaAtual) {
                    (0, usuario_errors_1.throwUsuarioPasswordSameAsCurrent)();
                }
                // Gerar hash da nova senha com maior segurança
                const senhaHash = await bcrypt.hash(updateSenhaDto.novaSenha, this.SALT_ROUNDS);
                // Atualizar senha e resetar contador de tentativas
                await usuarioRepo.update(id, {
                    senhaHash,
                    tentativas_login: 0,
                    primeiro_acesso: false,
                    ultimo_login: new Date(),
                });
                this.logger.log(`Senha do usuário ${id} atualizada com sucesso`);
                return { message: 'Senha atualizada com sucesso' };
            });
        }
        catch (error) {
            this.logger.error(`Erro ao atualizar senha do usuário ${id}: ${error.message}`, error.stack);
            if (error instanceof UsuarioError) {
                throw error;
            }
            (0, usuario_errors_1.throwUsuarioInternalError)({ operation: 'updatePassword', originalError: error.message });
        }
    }
    /**
     * Obtém o perfil do usuário atual
     * @param userId ID do usuário atual
     * @returns Perfil do usuário
     */
    async getProfile(userId) {
        return this.findById(userId);
    }
    /**
     * Busca um usuário pelo email (para autenticação)
     * @param email Email do usuário
     * @returns Usuário encontrado ou null
     */
    async findByEmail(email) {
        this.logger.log(`Buscando usuário por email: ${email}`);
        try {
            // Normalizar email para minúsculas para evitar problemas de case sensitivity
            const normalizedEmail = email.toLowerCase();
            const usuario = await this.usuarioRepository.findByEmail(normalizedEmail);
            if (!usuario) {
                this.logger.warn(`Tentativa de login com email inexistente: ${normalizedEmail}`, { context: 'SECURITY_LOGIN_ATTEMPT', email: normalizedEmail });
            }
            return usuario;
        }
        catch (error) {
            this.logger.error(`Erro ao buscar usuário por email: ${error.message}`, error.stack);
            return null;
        }
    }
    /**
     * Verifica se o usuário está bloqueado por excesso de tentativas
     * @param usuario Usuário a ser verificado
     * @returns true se estiver bloqueado
     */
    isUserLocked(usuario) {
        if (!usuario.tentativas_login || usuario.tentativas_login < this.MAX_LOGIN_ATTEMPTS) {
            return false;
        }
        const lastAttempt = usuario.ultimo_login || new Date(0);
        const timeSinceLastAttempt = Date.now() - lastAttempt.getTime();
        return timeSinceLastAttempt < this.LOCKOUT_DURATION;
    }
    /**
     * Incrementa o contador de tentativas de login
     * @param userId ID do usuário
     */
    async incrementLoginAttempts(userId) {
        try {
            await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository(usuario_entity_1.Usuario);
                await usuarioRepo.increment({ id: userId }, 'tentativas_login', 1);
                await usuarioRepo.update(userId, {
                    ultimo_login: new Date()
                });
            });
            this.logger.warn(`Tentativa de login falhada incrementada para usuário: ${userId}`, { context: 'SECURITY_LOGIN_FAILED', userId });
        }
        catch (error) {
            this.logger.error(`Erro ao incrementar tentativas de login: ${error.message}`, error.stack);
        }
    }
    /**
     * Reseta o contador de tentativas de login
     * @param userId ID do usuário
     */
    async resetLoginAttempts(userId) {
        try {
            await this.usuarioRepository.updateStatus(userId, status_enum_1.Status.ATIVO);
            await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository(usuario_entity_1.Usuario);
                await usuarioRepo.update(userId, {
                    tentativas_login: 0,
                    ultimo_login: new Date()
                });
            });
            this.logger.log(`Login bem-sucedido - tentativas resetadas para usuário: ${userId}`, { context: 'SECURITY_LOGIN_SUCCESS', userId });
        }
        catch (error) {
            this.logger.error(`Erro ao resetar tentativas de login: ${error.message}`, error.stack);
        }
    }
    /**
     * Valida credenciais de login com controle de tentativas
     * @param email Email do usuário
     * @param senha Senha do usuário
     * @returns Usuário se credenciais válidas, null caso contrário
     */
    async validateUserCredentials(email, senha) {
        const usuario = await this.findByEmail(email);
        if (!usuario) {
            return null;
        }
        // Verificar se usuário está bloqueado
        if (this.isUserLocked(usuario)) {
            this.logger.warn(`Tentativa de login em conta bloqueada: ${usuario.id}`, {
                context: 'SECURITY_BLOCKED_LOGIN_ATTEMPT',
                userId: usuario.id,
                email: usuario.email,
                attempts: usuario.tentativas_login
            });
            (0, usuario_errors_1.throwUsuarioAccountBlocked)({ email });
        }
        // Verificar senha
        const senhaValida = await bcrypt.compare(senha, usuario.senhaHash);
        if (!senhaValida) {
            await this.incrementLoginAttempts(usuario.id);
            this.logger.warn(`Tentativa de login com senha incorreta: ${usuario.id}`, {
                context: 'SECURITY_INVALID_PASSWORD',
                userId: usuario.id,
                email: usuario.email,
                attempts: (usuario.tentativas_login || 0) + 1
            });
            (0, usuario_errors_1.throwUsuarioCredentialsInvalid)({ email });
        }
        // Login bem-sucedido - resetar tentativas
        await this.resetLoginAttempts(usuario.id);
        return usuario;
    }
    /**
     * Remove um usuário (soft delete)
     * @param id - ID do usuário a ser removido
     * @returns Promise<void>
     */
    async remove(id) {
        this.logger.log(`Iniciando remoção do usuário: ${id}`);
        try {
            // Verifica se o usuário existe
            const usuario = await this.usuarioRepository.findById(id);
            if (!usuario) {
                this.logger.warn(`Usuário não encontrado para remoção: ${id}`);
                (0, usuario_errors_1.throwUsuarioNotFound)({ userId: id });
            }
            // Realiza o soft delete
            await this.usuarioRepository.remove(id);
            this.logger.log(`Usuário removido com sucesso: ${id}`);
        }
        catch (error) {
            this.logger.error(`Erro ao remover usuário ${id}: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Altera a senha do usuário no primeiro acesso
     * @param userId ID do usuário
     * @param alterarSenhaDto Dados da nova senha
     * @returns Resultado da operação
     */
    /**
     * Busca todas as roles disponíveis no sistema
     * @returns Lista de roles com id, nome e descrição
     */
    async findAllRoles() {
        this.logger.log('Buscando todas as roles disponíveis');
        try {
            const roles = await this.roleRepository.find({
                select: ['id', 'nome', 'descricao', 'status'],
                where: { status: status_enum_1.Status.ATIVO },
                order: { nome: 'ASC' }
            });
            return {
                data: roles,
                meta: { total: roles.length },
                message: 'Roles retornadas com sucesso'
            };
        }
        catch (error) {
            this.logger.error(`Erro ao buscar roles: ${error.message}`, error.stack);
            (0, usuario_errors_1.throwUsuarioInternalError)({ operation: 'findAllRoles', originalError: error.message });
        }
    }
    async alterarSenhaPrimeiroAcesso(userId, alterarSenhaDto) {
        this.logger.log(`Iniciando alteração de senha no primeiro acesso para usuário ${userId}`);
        try {
            // Verificar se as senhas coincidem
            if (alterarSenhaDto.novaSenha !== alterarSenhaDto.confirmarSenha) {
                (0, usuario_errors_1.throwUsuarioPasswordMismatch)();
            }
            // Usar transação para garantir consistência
            return await this.dataSource.transaction(async (manager) => {
                const usuarioRepo = manager.getRepository('usuario');
                // Buscar usuário
                const usuario = await usuarioRepo.findOne({ where: { id: userId } });
                if (!usuario) {
                    this.logger.warn(`Usuário não encontrado: ${userId}`);
                    (0, usuario_errors_1.throwUsuarioNotFound)({ userId });
                }
                // Verificar se está em primeiro acesso
                if (!usuario.primeiro_acesso) {
                    this.logger.warn(`Usuário ${userId} não está em primeiro acesso`);
                    (0, usuario_errors_1.throwUsuarioNotInFirstAccess)({ userId });
                }
                // Gerar hash da nova senha
                const novoHash = await bcrypt.hash(alterarSenhaDto.novaSenha, 12);
                // Atualizar senha e marcar como não sendo mais primeiro acesso
                await usuarioRepo.update(userId, {
                    senhaHash: novoHash,
                    primeiro_acesso: false,
                    updatedAt: new Date(),
                });
                this.logger.log(`Senha alterada com sucesso no primeiro acesso para usuário ${userId}`);
                return {
                    data: null,
                    meta: null,
                    message: 'Senha alterada com sucesso. Você pode agora acessar o sistema normalmente.',
                };
            });
        }
        catch (error) {
            this.logger.error(`Erro ao alterar senha no primeiro acesso para usuário ${userId}: ${error.message}`, error.stack);
            if (error instanceof UsuarioError) {
                throw error;
            }
            (0, usuario_errors_1.throwUsuarioInternalError)({ operation: 'alterarSenhaPrimeiroAcesso', originalError: error.message });
        }
    }
};
exports.UsuarioService = UsuarioService;
exports.UsuarioService = UsuarioService = UsuarioService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(3, (0, typeorm_1.InjectRepository)(notification_template_entity_1.NotificationTemplate)),
    __param(4, (0, typeorm_1.InjectRepository)(role_entity_1.Role)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _a : Object, typeof (_b = typeof usuario_repository_1.UsuarioRepository !== "undefined" && usuario_repository_1.UsuarioRepository) === "function" ? _b : Object, typeof (_c = typeof notification_manager_service_1.NotificationManagerService !== "undefined" && notification_manager_service_1.NotificationManagerService) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _e : Object])
], UsuarioService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHNlcnZpY2VzXFx1c3VhcmlvLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FHd0I7QUFDeEIsb0dBYXlFO0FBQ3pFLDZDQUFtRDtBQUNuRCxxQ0FBOEQ7QUFDOUQsK0NBQWlDO0FBQ2pDLDJFQUF1RTtBQU12RSxxRUFBMkQ7QUFDM0QsK0RBQXFEO0FBQ3JELDREQUFvRDtBQUNwRCwwR0FBcUc7QUFDckcsaUdBQXNGO0FBQ3RGLHFGQUFpRjtBQUVqRjs7OztHQUlHO0FBRUksSUFBTSxjQUFjLHNCQUFwQixNQUFNLGNBQWM7SUFPTjtJQUNBO0lBQ0E7SUFFQTtJQUVBO0lBWkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGdCQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDLGlDQUFpQztJQUNuRCxrQkFBa0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxnQ0FBZ0M7SUFDeEQsZ0JBQWdCLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxtQkFBbUI7SUFFdkUsWUFDbUIsVUFBc0IsRUFDdEIsaUJBQW9DLEVBQ3BDLG1CQUErQyxFQUUvQyxrQkFBb0QsRUFFcEQsY0FBZ0M7UUFOaEMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBNEI7UUFFL0MsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFrQztRQUVwRCxtQkFBYyxHQUFkLGNBQWMsQ0FBa0I7SUFDaEQsQ0FBQztJQUVKOzs7T0FHRztJQUNLLHNCQUFzQjtRQUM1QixNQUFNLFNBQVMsR0FBRyw0QkFBNEIsQ0FBQztR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QUEwQixvQkFBMUIseURBQTBCLG9EQUUzQixvQkFBVSxvQkFBVixvQkFBVSxvREFFZCxvQkFBVSxvQkFBVixvQkFBVTtHQWJsQyxjQUFjLENBdXhCMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHNlcnZpY2VzXFx1c3VhcmlvLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBcbiAgdGhyb3dVc3VhcmlvTm90Rm91bmQsXG4gIHRocm93VXN1YXJpb0VtYWlsRHVwbGljYXRlZCxcbiAgdGhyb3dVc3VhcmlvQ3BmRHVwbGljYXRlZCxcbiAgdGhyb3dVc3VhcmlvTWF0cmljdWxhRHVwbGljYXRlZCxcbiAgdGhyb3dVc3VhcmlvVW5pZGFkZU5vdEZvdW5kLFxuICB0aHJvd1VzdWFyaW9TZXRvck5vdEZvdW5kLFxuICB0aHJvd1VzdWFyaW9QYXNzd29yZE1pc21hdGNoLFxuICB0aHJvd1VzdWFyaW9QYXNzd29yZFNhbWVBc0N1cnJlbnQsXG4gIHRocm93VXN1YXJpb0NyZWRlbnRpYWxzSW52YWxpZCxcbiAgdGhyb3dVc3VhcmlvQWNjb3VudEJsb2NrZWQsXG4gIHRocm93VXN1YXJpb05vdEluRmlyc3RBY2Nlc3MsXG4gIHRocm93VXN1YXJpb0ludGVybmFsRXJyb3Jcbn0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL2V4Y2VwdGlvbnMvZXJyb3ItY2F0YWxvZy9kb21haW5zL3VzdWFyaW8uZXJyb3JzJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgRGF0YVNvdXJjZSwgRGVlcFBhcnRpYWwsIFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IHsgVXN1YXJpb1JlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3JpZXMvdXN1YXJpby5yZXBvc2l0b3J5JztcbmltcG9ydCB7IENyZWF0ZVVzdWFyaW9EdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLXVzdWFyaW8uZHRvJztcbmltcG9ydCB7IFVwZGF0ZVVzdWFyaW9EdG8gfSBmcm9tICcuLi9kdG8vdXBkYXRlLXVzdWFyaW8uZHRvJztcbmltcG9ydCB7IFVwZGF0ZVN0YXR1c1VzdWFyaW9EdG8gfSBmcm9tICcuLi9kdG8vdXBkYXRlLXN0YXR1cy11c3VhcmlvLmR0byc7XG5pbXBvcnQgeyBVcGRhdGVTZW5oYUR0byB9IGZyb20gJy4uL2R0by91cGRhdGUtc2VuaGEuZHRvJztcbmltcG9ydCB7IEFsdGVyYXJTZW5oYVByaW1laXJvQWNlc3NvRHRvIH0gZnJvbSAnLi4vZHRvL2FsdGVyYXItc2VuaGEtcHJpbWVpcm8tYWNlc3NvLmR0byc7XG5pbXBvcnQgeyBVc3VhcmlvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvdXN1YXJpby5lbnRpdHknO1xuaW1wb3J0IHsgUm9sZSB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3JvbGUuZW50aXR5JztcbmltcG9ydCB7IFN0YXR1cyB9IGZyb20gJy4uLy4uLy4uL2VudW1zL3N0YXR1cy5lbnVtJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbk1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbm90aWZpY2FjYW8vc2VydmljZXMvbm90aWZpY2F0aW9uLW1hbmFnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25UZW1wbGF0ZSB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL25vdGlmaWNhdGlvbi10ZW1wbGF0ZS5lbnRpdHknO1xuaW1wb3J0IHsgbm9ybWFsaXplRW51bUZpZWxkcyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC91dGlscy9lbnVtLW5vcm1hbGl6ZXIudXRpbCc7XG5cbi8qKlxuICogU2VydmnDp28gZGUgdXN1w6FyaW9zXG4gKlxuICogUmVzcG9uc8OhdmVsIHBlbGEgbMOzZ2ljYSBkZSBuZWfDs2NpbyByZWxhY2lvbmFkYSBhIHVzdcOhcmlvc1xuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVXN1YXJpb1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoVXN1YXJpb1NlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgU0FMVF9ST1VORFMgPSAxMjsgLy8gQXVtZW50YW5kbyBhIHNlZ3VyYW7Dp2EgZG8gaGFzaFxuICBwcml2YXRlIHJlYWRvbmx5IE1BWF9MT0dJTl9BVFRFTVBUUyA9IDU7IC8vIE3DoXhpbW8gZGUgdGVudGF0aXZhcyBkZSBsb2dpblxuICBwcml2YXRlIHJlYWRvbmx5IExPQ0tPVVRfRFVSQVRJT04gPSAxNSAqIDYwICogMTAwMDsgLy8gMTUgbWludXRvcyBlbSBtc1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzdWFyaW9SZXBvc2l0b3J5OiBVc3VhcmlvUmVwb3NpdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5vdGlmaWNhdGlvbk1hbmFnZXI6IE5vdGlmaWNhdGlvbk1hbmFnZXJTZXJ2aWNlLFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KE5vdGlmaWNhdGlvblRlbXBsYXRlKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGVtcGxhdGVSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PE5vdGlmaWNhdGlvblRlbXBsYXRlPixcbiAgICBASW5qZWN0UmVwb3NpdG9yeShSb2xlKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm9sZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Um9sZT4sXG4gICkge31cblxuICAvKipcbiAgICogR2VyYSB1bWEgc2VuaGEgYWxlYXTDs3JpYSBzZWd1cmEgcXVlIGF0ZW5kZSBhb3MgY3JpdMOpcmlvcyBkZSB2YWxpZGHDp8Ojb1xuICAgKiBAcmV0dXJucyBTZW5oYSBhbGVhdMOzcmlhIGRlIDEyIGNhcmFjdGVyZXNcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVSYW5kb21QYXNzd29yZCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGxvd2VyY2FzZSA9ICdhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eic7XG4gICAgY29uc3QgdXBwZXJjYXNlID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaJztcbiAgICBjb25zdCBudW1iZXJzID0gJzAxMjM0NTY3ODknO1xuICAgIGNvbnN0IHN5bWJvbHMgPSAnQCQhJSo/JiMnO1xuICAgIFxuICAgIC8vIEdhcmFudGlyIHBlbG8gbWVub3MgdW0gY2FyYWN0ZXJlIGRlIGNhZGEgdGlwbyBvYnJpZ2F0w7NyaW9cbiAgICBsZXQgcGFzc3dvcmQgPSAnJztcbiAgICBwYXNzd29yZCArPSBsb3dlcmNhc2VbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbG93ZXJjYXNlLmxlbmd0aCldO1xuICAgIHBhc3N3b3JkICs9IHVwcGVyY2FzZVtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB1cHBlcmNhc2UubGVuZ3RoKV07XG4gICAgcGFzc3dvcmQgKz0gbnVtYmVyc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBudW1iZXJzLmxlbmd0aCldO1xuICAgIHBhc3N3b3JkICs9IHN5bWJvbHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogc3ltYm9scy5sZW5ndGgpXTtcbiAgICBcbiAgICAvLyBDb21wbGV0YXIgY29tIGNhcmFjdGVyZXMgYWxlYXTDs3Jpb3MgYXTDqSAxMiBjYXJhY3RlcmVzXG4gICAgY29uc3QgYWxsQ2hhcnMgPSBsb3dlcmNhc2UgKyB1cHBlcmNhc2UgKyBudW1iZXJzICsgc3ltYm9scztcbiAgICBmb3IgKGxldCBpID0gNDsgaSA8IDEyOyBpKyspIHtcbiAgICAgIHBhc3N3b3JkICs9IGFsbENoYXJzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGFsbENoYXJzLmxlbmd0aCldO1xuICAgIH1cbiAgICBcbiAgICAvLyBFbWJhcmFsaGFyIGEgc2VuaGEgcGFyYSBldml0YXIgcGFkcsO1ZXMgcHJldmlzw612ZWlzXG4gICAgcmV0dXJuIHBhc3N3b3JkLnNwbGl0KCcnKS5zb3J0KCgpID0+IE1hdGgucmFuZG9tKCkgLSAwLjUpLmpvaW4oJycpO1xuICB9XG5cbiAgLyoqXG4gICAqIEVudmlhIGNyZWRlbmNpYWlzIHBvciBlbWFpbCBwYXJhIHVzdcOhcmlvIHJlY8OpbS1jcmlhZG9cbiAgICogQHBhcmFtIHVzdWFyaW8gVXN1w6FyaW8gY3JpYWRvXG4gICAqIEBwYXJhbSBzZW5oYSBTZW5oYSBlbSB0ZXh0byBwbGFub1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBlbnZpYXJDcmVkZW5jaWFpc1BvckVtYWlsKHVzdWFyaW86IFVzdWFyaW8sIHNlbmhhOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQnVzY2FyIHRlbXBsYXRlIGRlIGNyZWRlbmNpYWlzXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBub21lOiAnQ3JlZGVuY2lhaXMgZGUgQWNlc3NvIC0gTm92byBVc3XDoXJpbycgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ1RlbXBsYXRlIGRlIGNyZWRlbmNpYWlzIG7Do28gZW5jb250cmFkbycpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIERhZG9zIHBhcmEgbyB0ZW1wbGF0ZVxuICAgICAgY29uc3QgZGFkb3NUZW1wbGF0ZSA9IHtcbiAgICAgICAgbm9tZTogdXN1YXJpby5ub21lLFxuICAgICAgICBlbWFpbDogdXN1YXJpby5lbWFpbCxcbiAgICAgICAgc2VuaGE6IHNlbmhhLFxuICAgICAgICBtYXRyaWN1bGE6IHVzdWFyaW8ubWF0cmljdWxhLFxuICAgICAgICBzaXN0ZW1hX3VybDogcHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMIHx8ICdodHRwczovL3BnYmVuLm5hdGFsLnJuLmdvdi5icicsXG4gICAgICAgIGRhdGFfY3JpYWNhbzogbmV3IERhdGUoKS50b0xvY2FsZURhdGVTdHJpbmcoJ3B0LUJSJylcbiAgICAgIH07XG5cbiAgICAgIC8vIENyaWFyIG5vdGlmaWNhw6fDo29cbiAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uTWFuYWdlci5jcmlhck5vdGlmaWNhY2FvKHtcbiAgICAgICAgdGVtcGxhdGVfaWQ6IHRlbXBsYXRlLmlkLFxuICAgICAgICBkZXN0aW5hdGFyaW9faWQ6IHVzdWFyaW8uaWQsXG4gICAgICAgIGRhZG9zX2NvbnRleHRvOiBkYWRvc1RlbXBsYXRlXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBDcmVkZW5jaWFpcyBlbnZpYWRhcyBwb3IgZW1haWwgcGFyYTogJHt1c3VhcmlvLmVtYWlsfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBhbyBlbnZpYXIgY3JlZGVuY2lhaXMgcG9yIGVtYWlsOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAvLyBOw6NvIGZhbGhhciBhIGNyaWHDp8OjbyBkbyB1c3XDoXJpbyBwb3IgZXJybyBubyBlbnZpbyBkbyBlbWFpbFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RvcyBvcyB1c3XDoXJpb3MgY29tIGZpbHRyb3MgZSBwYWdpbmHDp8Ojb1xuICAgKiBAcGFyYW0gb3B0aW9ucyBPcMOnw7VlcyBkZSBmaWx0cm8gZSBwYWdpbmHDp8Ojb1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSB1c3XDoXJpb3MgcGFnaW5hZGFcbiAgICovXG4gIGFzeW5jIGZpbmRBbGwob3B0aW9ucz86IHtcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICAgIHNlYXJjaD86IHN0cmluZztcbiAgICByb2xlPzogc3RyaW5nO1xuICAgIHN0YXR1cz86IHN0cmluZztcbiAgICB1bmlkYWRlX2lkPzogc3RyaW5nO1xuICB9KSB7XG4gICAgY29uc3Qge1xuICAgICAgcGFnZSA9IDEsXG4gICAgICBsaW1pdCA9IDEwLFxuICAgICAgc2VhcmNoLFxuICAgICAgcm9sZSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIHVuaWRhZGVfaWQsXG4gICAgfSA9IG9wdGlvbnMgfHwge307XG5cbiAgICAvLyBDb25zdHJ1aXIgZmlsdHJvc1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChzZWFyY2gpIHtcbiAgICAgIHdoZXJlLm5vbWUgPSB7ICRpTGlrZTogYCUke3NlYXJjaH0lYCB9O1xuICAgIH1cblxuICAgIGlmIChyb2xlKSB7XG4gICAgICB3aGVyZS5yb2xlID0gcm9sZTtcbiAgICB9XG5cbiAgICBpZiAoc3RhdHVzKSB7XG4gICAgICB3aGVyZS5zdGF0dXMgPSBzdGF0dXM7XG4gICAgfVxuXG4gICAgaWYgKHVuaWRhZGVfaWQpIHtcbiAgICAgIHdoZXJlLnVuaWRhZGVfaWQgPSB1bmlkYWRlX2lkO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGFyIHNraXAgcGFyYSBwYWdpbmHDp8Ojb1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICAvLyBCdXNjYXIgdXN1w6FyaW9zXG4gICAgY29uc3QgW3VzdWFyaW9zLCB0b3RhbF0gPSBhd2FpdCB0aGlzLnVzdWFyaW9SZXBvc2l0b3J5LmZpbmRBbGwoe1xuICAgICAgc2tpcCxcbiAgICAgIHRha2U6IGxpbWl0LFxuICAgICAgd2hlcmUsXG4gICAgfSk7XG5cbiAgICAvLyBSZW1vdmVyIGNhbXBvcyBzZW5zw612ZWlzXG4gICAgY29uc3QgdXN1YXJpb3NTZW1TZW5oYSA9IHVzdWFyaW9zLm1hcCgodXN1YXJpbykgPT4ge1xuICAgICAgY29uc3QgeyBzZW5oYUhhc2gsIC4uLnVzdWFyaW9TZW1TZW5oYSB9ID0gdXN1YXJpbztcbiAgICAgIHJldHVybiB1c3VhcmlvU2VtU2VuaGE7XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXRlbXM6IHVzdWFyaW9zU2VtU2VuaGEsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIHRvdGFsLFxuICAgICAgICBwYWdlLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gbGltaXQpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbG8gSURcbiAgICogQHBhcmFtIGlkIElEIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGVuY29udHJhZG9cbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG5cbiAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgIHRocm93VXN1YXJpb05vdEZvdW5kKHsgdXNlcklkOiBpZCB9KTtcbiAgICB9XG5cbiAgICAvLyBSZW1vdmVyIGNhbXBvcyBzZW5zw612ZWlzXG4gICAgY29uc3QgeyBzZW5oYUhhc2gsIC4uLnVzdWFyaW9TZW1TZW5oYSB9ID0gdXN1YXJpbztcblxuICAgIHJldHVybiB1c3VhcmlvU2VtU2VuaGE7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBub3ZvIHVzdcOhcmlvXG4gICAqIEBwYXJhbSBjcmVhdGVVc3VhcmlvRHRvIERhZG9zIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGNyaWFkb1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlKGNyZWF0ZVVzdWFyaW9EdG86IENyZWF0ZVVzdWFyaW9EdG8pIHtcbiAgICB0aGlzLmxvZ2dlci5sb2coYEluaWNpYW5kbyBjcmlhw6fDo28gZGUgdXN1w6FyaW86ICR7Y3JlYXRlVXN1YXJpb0R0by5lbWFpbH1gKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBVc2FyIHRyYW5zYcOnw6NvIHBhcmEgZ2FyYW50aXIgY29uc2lzdMOqbmNpYVxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgICBjb25zdCB1c3VhcmlvUmVwbyA9IG1hbmFnZXIuZ2V0UmVwb3NpdG9yeSgndXN1YXJpbycpO1xuICAgICAgICBjb25zdCB1bmlkYWRlUmVwbyA9IG1hbmFnZXIuZ2V0UmVwb3NpdG9yeSgndW5pZGFkZScpO1xuICAgICAgICBjb25zdCBzZXRvclJlcG8gPSBtYW5hZ2VyLmdldFJlcG9zaXRvcnkoJ3NldG9yJyk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGVtYWlsIGrDoSBleGlzdGVcbiAgICAgICAgY29uc3QgZW1haWxFeGlzdGVudGUgPSBhd2FpdCB1c3VhcmlvUmVwby5maW5kT25lKHtcbiAgICAgICAgICB3aGVyZTogeyBlbWFpbDogY3JlYXRlVXN1YXJpb0R0by5lbWFpbCB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGVtYWlsRXhpc3RlbnRlKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgRW1haWwgasOhIGVzdMOhIGVtIHVzbzogJHtjcmVhdGVVc3VhcmlvRHRvLmVtYWlsfWApO1xuICAgICAgICAgIHRocm93VXN1YXJpb0VtYWlsRHVwbGljYXRlZCh7IGVtYWlsOiBjcmVhdGVVc3VhcmlvRHRvLmVtYWlsIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIENQRiBqw6EgZXhpc3RlXG4gICAgICAgIGNvbnN0IGNwZkV4aXN0ZW50ZSA9IGF3YWl0IHVzdWFyaW9SZXBvLmZpbmRPbmUoe1xuICAgICAgICAgIHdoZXJlOiB7IGNwZjogY3JlYXRlVXN1YXJpb0R0by5jcGYgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChjcGZFeGlzdGVudGUpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBDUEYgasOhIGVzdMOhIGVtIHVzbzogJHtjcmVhdGVVc3VhcmlvRHRvLmNwZn1gKTtcbiAgICAgICAgICB0aHJvd1VzdWFyaW9DcGZEdXBsaWNhdGVkKHsgY3BmOiBjcmVhdGVVc3VhcmlvRHRvLmNwZiB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBtYXRyw61jdWxhIGrDoSBleGlzdGVcbiAgICAgICAgY29uc3QgbWF0cmljdWxhRXhpc3RlbnRlID0gYXdhaXQgdXN1YXJpb1JlcG8uZmluZE9uZSh7XG4gICAgICAgICAgd2hlcmU6IHsgbWF0cmljdWxhOiBjcmVhdGVVc3VhcmlvRHRvLm1hdHJpY3VsYSB9LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKG1hdHJpY3VsYUV4aXN0ZW50ZSkge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICBgTWF0csOtY3VsYSBqw6EgZXN0w6EgZW0gdXNvOiAke2NyZWF0ZVVzdWFyaW9EdG8ubWF0cmljdWxhfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aHJvd1VzdWFyaW9NYXRyaWN1bGFEdXBsaWNhdGVkKHsgbWF0cmljdWxhOiBjcmVhdGVVc3VhcmlvRHRvLm1hdHJpY3VsYSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBhIHVuaWRhZGUgZXhpc3RlXG4gICAgICAgIGlmIChjcmVhdGVVc3VhcmlvRHRvLnVuaWRhZGVfaWQpIHtcbiAgICAgICAgICBjb25zdCB1bmlkYWRlID0gYXdhaXQgdW5pZGFkZVJlcG8uZmluZE9uZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBpZDogY3JlYXRlVXN1YXJpb0R0by51bmlkYWRlX2lkIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKCF1bmlkYWRlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBVbmlkYWRlIG7Do28gZW5jb250cmFkYTogJHtjcmVhdGVVc3VhcmlvRHRvLnVuaWRhZGVfaWR9YCk7XG4gICAgICAgICAgICB0aHJvd1VzdWFyaW9VbmlkYWRlTm90Rm91bmQoeyB1bmlkYWRlSWQ6IGNyZWF0ZVVzdWFyaW9EdG8udW5pZGFkZV9pZCB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyBzZXRvciBleGlzdGUgZSBwZXJ0ZW5jZSDDoCB1bmlkYWRlXG4gICAgICAgICAgaWYgKGNyZWF0ZVVzdWFyaW9EdG8uc2V0b3JfaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNldG9yID0gYXdhaXQgc2V0b3JSZXBvLmZpbmRPbmUoe1xuICAgICAgICAgICAgICB3aGVyZTogeyBcbiAgICAgICAgICAgICAgICBpZDogY3JlYXRlVXN1YXJpb0R0by5zZXRvcl9pZCxcbiAgICAgICAgICAgICAgICB1bmlkYWRlX2lkOiBjcmVhdGVVc3VhcmlvRHRvLnVuaWRhZGVfaWQgXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICghc2V0b3IpIHtcbiAgICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgU2V0b3IgbsOjbyBlbmNvbnRyYWRvIHBhcmEgYSB1bmlkYWRlOiAke2NyZWF0ZVVzdWFyaW9EdG8uc2V0b3JfaWR9YCk7XG4gICAgICAgICAgICAgIHRocm93VXN1YXJpb1NldG9yTm90Rm91bmQoeyBzZXRvcklkOiBjcmVhdGVVc3VhcmlvRHRvLnNldG9yX2lkIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERldGVybWluYXIgc2VuaGEgYSBzZXIgdXNhZGFcbiAgICAgICAgbGV0IHNlbmhhUGFyYVVzbzogc3RyaW5nO1xuICAgICAgICBsZXQgc2VuaGFHZXJhZGEgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGlmIChjcmVhdGVVc3VhcmlvRHRvLnNlbmhhKSB7XG4gICAgICAgICAgc2VuaGFQYXJhVXNvID0gY3JlYXRlVXN1YXJpb0R0by5zZW5oYTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzZW5oYVBhcmFVc28gPSB0aGlzLmdlbmVyYXRlUmFuZG9tUGFzc3dvcmQoKTtcbiAgICAgICAgICBzZW5oYUdlcmFkYSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5sb2dnZXIubG9nKGBTZW5oYSBnZXJhZGEgYXV0b21hdGljYW1lbnRlIHBhcmEgdXN1w6FyaW86ICR7Y3JlYXRlVXN1YXJpb0R0by5lbWFpbH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdlcmFyIGhhc2ggZGEgc2VuaGEgY29tIG1haW9yIHNlZ3VyYW7Dp2FcbiAgICAgICAgY29uc3Qgc2VuaGFIYXNoID0gYXdhaXQgYmNyeXB0Lmhhc2goXG4gICAgICAgICAgc2VuaGFQYXJhVXNvLFxuICAgICAgICAgIHRoaXMuU0FMVF9ST1VORFMsXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gTm9ybWFsaXphciBjYW1wb3MgZGUgZW51bSBhbnRlcyBkZSBjcmlhclxuICAgICAgICBjb25zdCBub3JtYWxpemVkRGF0YSA9IG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAgIG5vbWU6IGNyZWF0ZVVzdWFyaW9EdG8ubm9tZSxcbiAgICAgICAgICBlbWFpbDogY3JlYXRlVXN1YXJpb0R0by5lbWFpbC50b0xvd2VyQ2FzZSgpLCAvLyBOb3JtYWxpemFyIGVtYWlsIHBhcmEgbWluw7pzY3VsYXNcbiAgICAgICAgICBzZW5oYUhhc2gsXG4gICAgICAgICAgY3BmOiBjcmVhdGVVc3VhcmlvRHRvLmNwZixcbiAgICAgICAgICB0ZWxlZm9uZTogY3JlYXRlVXN1YXJpb0R0by50ZWxlZm9uZSxcbiAgICAgICAgICBtYXRyaWN1bGE6IGNyZWF0ZVVzdWFyaW9EdG8ubWF0cmljdWxhLFxuICAgICAgICAgIHJvbGVfaWQ6IGNyZWF0ZVVzdWFyaW9EdG8ucm9sZV9pZCxcbiAgICAgICAgICB1bmlkYWRlX2lkOiBjcmVhdGVVc3VhcmlvRHRvLnVuaWRhZGVfaWQsXG4gICAgICAgICAgc2V0b3JfaWQ6IGNyZWF0ZVVzdWFyaW9EdG8uc2V0b3JfaWQsXG4gICAgICAgICAgcHJpbWVpcm9fYWNlc3NvOiB0cnVlLCAvLyBTZW1wcmUgdHJ1ZSBwYXJhIG5vdm9zIHVzdcOhcmlvc1xuICAgICAgICAgIHVsdGltb19sb2dpbjogbnVsbCxcbiAgICAgICAgICB0ZW50YXRpdmFzX2xvZ2luOiAwLFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIENyaWFyIHVzdcOhcmlvXG4gICAgICAgIGNvbnN0IG5vdm9Vc3VhcmlvID0gdXN1YXJpb1JlcG8uY3JlYXRlKG5vcm1hbGl6ZWREYXRhKTtcblxuICAgICAgICBjb25zdCB1c3VhcmlvU2Fsdm8gPSBhd2FpdCB1c3VhcmlvUmVwby5zYXZlKG5vdm9Vc3VhcmlvKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEVudmlhciBjcmVkZW5jaWFpcyBwb3IgZW1haWwgc2Ugc2VuaGEgZm9pIGdlcmFkYVxuICAgICAgICBpZiAoc2VuaGFHZXJhZGEpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmVudmlhckNyZWRlbmNpYWlzUG9yRW1haWwodXN1YXJpb1NhbHZvIGFzIFVzdWFyaW8sIHNlbmhhUGFyYVVzbyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZ2dlci5sb2coYFVzdcOhcmlvIGNyaWFkbyBjb20gc3VjZXNzbzogJHt1c3VhcmlvU2Fsdm8uaWR9YCk7XG5cbiAgICAgICAgLy8gUmVtb3ZlciBjYW1wb3Mgc2Vuc8OtdmVpc1xuICAgICAgICBjb25zdCB7IHNlbmhhSGFzaDogXywgLi4udXN1YXJpb1NlbVNlbmhhIH0gPSB1c3VhcmlvU2Fsdm87XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBkYXRhOiB1c3VhcmlvU2VtU2VuaGEsXG4gICAgICAgICAgbWV0YTogbnVsbCxcbiAgICAgICAgICBtZXNzYWdlOiBzZW5oYUdlcmFkYSBcbiAgICAgICAgICAgID8gJ1VzdcOhcmlvIGNyaWFkbyBjb20gc3VjZXNzby4gQ3JlZGVuY2lhaXMgZW52aWFkYXMgcG9yIGVtYWlsLidcbiAgICAgICAgICAgIDogJ1VzdcOhcmlvIGNyaWFkbyBjb20gc3VjZXNzby4nXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gY3JpYXIgdXN1w6FyaW86ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjayk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc3VhcmlvRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvd1VzdWFyaW9JbnRlcm5hbEVycm9yKHsgb3BlcmF0aW9uOiAnY3JlYXRlJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW0gdXN1w6FyaW8gZXhpc3RlbnRlXG4gICAqIEBwYXJhbSBpZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gdXBkYXRlVXN1YXJpb0R0byBEYWRvcyBhIHNlcmVtIGF0dWFsaXphZG9zXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGF0dWFsaXphZG9cbiAgICovXG4gIGFzeW5jIHVwZGF0ZShpZDogc3RyaW5nLCB1cGRhdGVVc3VhcmlvRHRvOiBVcGRhdGVVc3VhcmlvRHRvKSB7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBJbmljaWFuZG8gYXR1YWxpemHDp8OjbyBkbyB1c3XDoXJpbyAke2lkfWApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFVzYXIgdHJhbnNhw6fDo28gcGFyYSBnYXJhbnRpciBjb25zaXN0w6puY2lhXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzdWFyaW9SZXBvID0gbWFuYWdlci5nZXRSZXBvc2l0b3J5KCd1c3VhcmlvJyk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIHVzdcOhcmlvIGV4aXN0ZVxuICAgICAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdXN1YXJpb1JlcG8uZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSk7XG4gICAgICAgIGlmICghdXN1YXJpbykge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFVzdcOhcmlvIG7Do28gZW5jb250cmFkbzogJHtpZH1gKTtcbiAgICAgICAgICB0aHJvd1VzdWFyaW9Ob3RGb3VuZCh7IHVzZXJJZDogaWQgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgZW1haWwgasOhIGV4aXN0ZSAoc2UgZm9ybmVjaWRvKVxuICAgICAgICBpZiAoXG4gICAgICAgICAgdXBkYXRlVXN1YXJpb0R0by5lbWFpbCAmJlxuICAgICAgICAgIHVwZGF0ZVVzdWFyaW9EdG8uZW1haWwudG9Mb3dlckNhc2UoKSAhPT0gdXN1YXJpby5lbWFpbC50b0xvd2VyQ2FzZSgpXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnN0IGVtYWlsRXhpc3RlbnRlID0gYXdhaXQgdXN1YXJpb1JlcG8uZmluZE9uZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBlbWFpbDogdXBkYXRlVXN1YXJpb0R0by5lbWFpbC50b0xvd2VyQ2FzZSgpIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKGVtYWlsRXhpc3RlbnRlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBFbWFpbCBqw6EgZXN0w6EgZW0gdXNvOiAke3VwZGF0ZVVzdWFyaW9EdG8uZW1haWx9YCk7XG4gICAgICAgICAgICB0aHJvd1VzdWFyaW9FbWFpbER1cGxpY2F0ZWQoeyBlbWFpbDogdXBkYXRlVXN1YXJpb0R0by5lbWFpbCB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gTm9ybWFsaXphciBlbWFpbCBwYXJhIG1pbsO6c2N1bGFzXG4gICAgICAgICAgdXBkYXRlVXN1YXJpb0R0by5lbWFpbCA9IHVwZGF0ZVVzdWFyaW9EdG8uZW1haWwudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBDUEYgasOhIGV4aXN0ZSAoc2UgZm9ybmVjaWRvKVxuICAgICAgICBpZiAodXBkYXRlVXN1YXJpb0R0by5jcGYgJiYgdXBkYXRlVXN1YXJpb0R0by5jcGYgIT09IHVzdWFyaW8uY3BmKSB7XG4gICAgICAgICAgY29uc3QgY3BmRXhpc3RlbnRlID0gYXdhaXQgdXN1YXJpb1JlcG8uZmluZE9uZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBjcGY6IHVwZGF0ZVVzdWFyaW9EdG8uY3BmIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKGNwZkV4aXN0ZW50ZSkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgQ1BGIGrDoSBlc3TDoSBlbSB1c286ICR7dXBkYXRlVXN1YXJpb0R0by5jcGZ9YCk7XG4gICAgICAgICAgICB0aHJvd1VzdWFyaW9DcGZEdXBsaWNhdGVkKHsgY3BmOiB1cGRhdGVVc3VhcmlvRHRvLmNwZiB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgbWF0csOtY3VsYSBqw6EgZXhpc3RlIChzZSBmb3JuZWNpZGEpXG4gICAgICAgIGlmIChcbiAgICAgICAgICB1cGRhdGVVc3VhcmlvRHRvLm1hdHJpY3VsYSAmJlxuICAgICAgICAgIHVwZGF0ZVVzdWFyaW9EdG8ubWF0cmljdWxhICE9PSB1c3VhcmlvLm1hdHJpY3VsYVxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zdCBtYXRyaWN1bGFFeGlzdGVudGUgPSBhd2FpdCB1c3VhcmlvUmVwby5maW5kT25lKHtcbiAgICAgICAgICAgIHdoZXJlOiB7IG1hdHJpY3VsYTogdXBkYXRlVXN1YXJpb0R0by5tYXRyaWN1bGEgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpZiAobWF0cmljdWxhRXhpc3RlbnRlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICBgTWF0csOtY3VsYSBqw6EgZXN0w6EgZW0gdXNvOiAke3VwZGF0ZVVzdWFyaW9EdG8ubWF0cmljdWxhfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhyb3dVc3VhcmlvTWF0cmljdWxhRHVwbGljYXRlZCh7IG1hdHJpY3VsYTogdXBkYXRlVXN1YXJpb0R0by5tYXRyaWN1bGEgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gTm9ybWFsaXphciBjYW1wb3MgZGUgZW51bSBhbnRlcyBkZSBhdHVhbGl6YXJcbiAgICAgICAgY29uc3Qgbm9ybWFsaXplZERhdGEgPSBub3JtYWxpemVFbnVtRmllbGRzKHVwZGF0ZVVzdWFyaW9EdG8pO1xuICAgICAgICBcbiAgICAgICAgLy8gQXR1YWxpemFyIHVzdcOhcmlvXG4gICAgICAgIGF3YWl0IHVzdWFyaW9SZXBvLnVwZGF0ZShpZCwgbm9ybWFsaXplZERhdGEpO1xuXG4gICAgICAgIC8vIEJ1c2NhciB1c3XDoXJpbyBhdHVhbGl6YWRvXG4gICAgICAgIGNvbnN0IHVzdWFyaW9BdHVhbGl6YWRvID0gYXdhaXQgdXN1YXJpb1JlcG8uZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSk7XG4gICAgICAgIGlmICghdXN1YXJpb0F0dWFsaXphZG8pIHtcbiAgICAgICAgICB0aHJvd1VzdWFyaW9Ob3RGb3VuZCh7IHVzZXJJZDogaWQsIG9wZXJhdGlvbjogJ3VwZGF0ZV92ZXJpZmljYXRpb24nIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc3XDoXJpbyAke2lkfSBhdHVhbGl6YWRvIGNvbSBzdWNlc3NvYCk7XG5cbiAgICAgICAgLy8gUmVtb3ZlciBjYW1wb3Mgc2Vuc8OtdmVpc1xuICAgICAgICBjb25zdCB7IHNlbmhhSGFzaCwgLi4udXN1YXJpb1NlbVNlbmhhIH0gPSB1c3VhcmlvQXR1YWxpemFkbztcblxuICAgICAgICByZXR1cm4gdXN1YXJpb1NlbVNlbmhhO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhdHVhbGl6YXIgdXN1w6FyaW8gJHtpZH06ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc3VhcmlvRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvd1VzdWFyaW9JbnRlcm5hbEVycm9yKHsgb3BlcmF0aW9uOiAndXBkYXRlJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgbyBzdGF0dXMgZGUgdW0gdXN1w6FyaW9cbiAgICogQHBhcmFtIGlkIElEIGRvIHVzdcOhcmlvXG4gICAqIEBwYXJhbSB1cGRhdGVTdGF0dXNVc3VhcmlvRHRvIE5vdm8gc3RhdHVzXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGF0dWFsaXphZG9cbiAgICovXG4gIGFzeW5jIHVwZGF0ZVN0YXR1cyhcbiAgICBpZDogc3RyaW5nLFxuICAgIHVwZGF0ZVN0YXR1c1VzdWFyaW9EdG86IFVwZGF0ZVN0YXR1c1VzdWFyaW9EdG8sXG4gICkge1xuICAgIC8vIFZlcmlmaWNhciBzZSB1c3XDoXJpbyBleGlzdGVcbiAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG4gICAgaWYgKCF1c3VhcmlvKSB7XG4gICAgICB0aHJvd1VzdWFyaW9Ob3RGb3VuZCh7IHVzZXJJZDogaWQgfSk7XG4gICAgfVxuXG4gICAgLy8gQXR1YWxpemFyIHN0YXR1c1xuICAgIGNvbnN0IHVzdWFyaW9BdHVhbGl6YWRvID0gYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS51cGRhdGVTdGF0dXMoXG4gICAgICBpZCxcbiAgICAgIHVwZGF0ZVN0YXR1c1VzdWFyaW9EdG8uc3RhdHVzLFxuICAgICk7XG5cbiAgICAvLyBSZW1vdmVyIGNhbXBvcyBzZW5zw612ZWlzXG4gICAgY29uc3QgeyBzZW5oYUhhc2gsIC4uLnVzdWFyaW9TZW1TZW5oYSB9ID0gdXN1YXJpb0F0dWFsaXphZG87XG5cbiAgICByZXR1cm4gdXN1YXJpb1NlbVNlbmhhO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIGEgc2VuaGEgZGUgdW0gdXN1w6FyaW9cbiAgICogQHBhcmFtIGlkIElEIGRvIHVzdcOhcmlvXG4gICAqIEBwYXJhbSB1cGRhdGVTZW5oYUR0byBEYWRvcyBkYSBub3ZhIHNlbmhhXG4gICAqIEByZXR1cm5zIE1lbnNhZ2VtIGRlIHN1Y2Vzc29cbiAgICovXG4gIGFzeW5jIHVwZGF0ZVNlbmhhKGlkOiBzdHJpbmcsIHVwZGF0ZVNlbmhhRHRvOiBVcGRhdGVTZW5oYUR0bykge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgSW5pY2lhbmRvIGF0dWFsaXphw6fDo28gZGUgc2VuaGEgZG8gdXN1w6FyaW8gJHtpZH1gKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBVc2FyIHRyYW5zYcOnw6NvIHBhcmEgZ2FyYW50aXIgY29uc2lzdMOqbmNpYVxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgICBjb25zdCB1c3VhcmlvUmVwbyA9IG1hbmFnZXIuZ2V0UmVwb3NpdG9yeSgndXN1YXJpbycpO1xuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSB1c3XDoXJpbyBleGlzdGVcbiAgICAgICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHVzdWFyaW9SZXBvLmZpbmRPbmUoeyB3aGVyZTogeyBpZCB9IH0pO1xuICAgICAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBVc3XDoXJpbyBuw6NvIGVuY29udHJhZG86ICR7aWR9YCk7XG4gICAgICAgICAgdGhyb3dVc3VhcmlvTm90Rm91bmQoeyB1c2VySWQ6IGlkIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgc2VuaGEgYXR1YWwgZXN0w6EgY29ycmV0YVxuICAgICAgICBjb25zdCBzZW5oYUNvcnJldGEgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShcbiAgICAgICAgICB1cGRhdGVTZW5oYUR0by5zZW5oYUF0dWFsLFxuICAgICAgICAgIHVzdWFyaW8uc2VuaGFIYXNoLFxuICAgICAgICApO1xuICAgICAgICBpZiAoIXNlbmhhQ29ycmV0YSkge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICBgVGVudGF0aXZhIGRlIGFsdGVyYcOnw6NvIGRlIHNlbmhhIGNvbSBzZW5oYSBhdHVhbCBpbmNvcnJldGE6ICR7aWR9YCxcbiAgICAgICAgICApO1xuICAgICAgICAgIC8vIEluY3JlbWVudGFyIGNvbnRhZG9yIGRlIHRlbnRhdGl2YXMgZmFsaGFzIHBhcmEgcHJldmVuw6fDo28gZGUgYXRhcXVlcyBkZSBmb3LDp2EgYnJ1dGFcbiAgICAgICAgICBhd2FpdCB1c3VhcmlvUmVwby51cGRhdGUoaWQsIHtcbiAgICAgICAgICAgIHRlbnRhdGl2YXNfbG9naW46ICgpID0+ICdcInRlbnRhdGl2YXNfbG9naW5cIiArIDEnLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRocm93VXN1YXJpb0NyZWRlbnRpYWxzSW52YWxpZCh7IGVtYWlsOiB1c3VhcmlvLmVtYWlsIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgbm92YSBzZW5oYSBlIGEgY29uZmlybWHDp8OjbyBjb2luY2lkZW1cbiAgICAgICAgaWYgKHVwZGF0ZVNlbmhhRHRvLm5vdmFTZW5oYSAhPT0gdXBkYXRlU2VuaGFEdG8uY29uZmlybWFjYW9TZW5oYSkge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE5vdmEgc2VuaGEgZSBjb25maXJtYcOnw6NvIG7Do28gY29pbmNpZGVtOiAke2lkfWApO1xuICAgICAgICAgIHRocm93VXN1YXJpb1Bhc3N3b3JkTWlzbWF0Y2goKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBhIG5vdmEgc2VuaGEgw6kgZGlmZXJlbnRlIGRhIGF0dWFsXG4gICAgICAgIGlmICh1cGRhdGVTZW5oYUR0by5ub3ZhU2VuaGEgPT09IHVwZGF0ZVNlbmhhRHRvLnNlbmhhQXR1YWwpIHtcbiAgICAgICAgICB0aHJvd1VzdWFyaW9QYXNzd29yZFNhbWVBc0N1cnJlbnQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdlcmFyIGhhc2ggZGEgbm92YSBzZW5oYSBjb20gbWFpb3Igc2VndXJhbsOnYVxuICAgICAgICBjb25zdCBzZW5oYUhhc2ggPSBhd2FpdCBiY3J5cHQuaGFzaChcbiAgICAgICAgICB1cGRhdGVTZW5oYUR0by5ub3ZhU2VuaGEsXG4gICAgICAgICAgdGhpcy5TQUxUX1JPVU5EUyxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBBdHVhbGl6YXIgc2VuaGEgZSByZXNldGFyIGNvbnRhZG9yIGRlIHRlbnRhdGl2YXNcbiAgICAgICAgYXdhaXQgdXN1YXJpb1JlcG8udXBkYXRlKGlkLCB7XG4gICAgICAgICAgc2VuaGFIYXNoLFxuICAgICAgICAgIHRlbnRhdGl2YXNfbG9naW46IDAsXG4gICAgICAgICAgcHJpbWVpcm9fYWNlc3NvOiBmYWxzZSxcbiAgICAgICAgICB1bHRpbW9fbG9naW46IG5ldyBEYXRlKCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgU2VuaGEgZG8gdXN1w6FyaW8gJHtpZH0gYXR1YWxpemFkYSBjb20gc3VjZXNzb2ApO1xuXG4gICAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICdTZW5oYSBhdHVhbGl6YWRhIGNvbSBzdWNlc3NvJyB9O1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhdHVhbGl6YXIgc2VuaGEgZG8gdXN1w6FyaW8gJHtpZH06ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVc3VhcmlvRXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvd1VzdWFyaW9JbnRlcm5hbEVycm9yKHsgb3BlcmF0aW9uOiAndXBkYXRlUGFzc3dvcmQnLCBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gbyBwZXJmaWwgZG8gdXN1w6FyaW8gYXR1YWxcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpbyBhdHVhbFxuICAgKiBAcmV0dXJucyBQZXJmaWwgZG8gdXN1w6FyaW9cbiAgICovXG4gIGFzeW5jIGdldFByb2ZpbGUodXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5maW5kQnlJZCh1c2VySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbG8gZW1haWwgKHBhcmEgYXV0ZW50aWNhw6fDo28pXG4gICAqIEBwYXJhbSBlbWFpbCBFbWFpbCBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyBVc3XDoXJpbyBlbmNvbnRyYWRvIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGZpbmRCeUVtYWlsKGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPFVzdWFyaW8gfCBudWxsPiB7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBCdXNjYW5kbyB1c3XDoXJpbyBwb3IgZW1haWw6ICR7ZW1haWx9YCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gTm9ybWFsaXphciBlbWFpbCBwYXJhIG1pbsO6c2N1bGFzIHBhcmEgZXZpdGFyIHByb2JsZW1hcyBkZSBjYXNlIHNlbnNpdGl2aXR5XG4gICAgICBjb25zdCBub3JtYWxpemVkRW1haWwgPSBlbWFpbC50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHRoaXMudXN1YXJpb1JlcG9zaXRvcnkuZmluZEJ5RW1haWwobm9ybWFsaXplZEVtYWlsKTtcblxuICAgICAgaWYgKCF1c3VhcmlvKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYFRlbnRhdGl2YSBkZSBsb2dpbiBjb20gZW1haWwgaW5leGlzdGVudGU6ICR7bm9ybWFsaXplZEVtYWlsfWAsXG4gICAgICAgICAgeyBjb250ZXh0OiAnU0VDVVJJVFlfTE9HSU5fQVRURU1QVCcsIGVtYWlsOiBub3JtYWxpemVkRW1haWwgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdXN1YXJpbztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIGJ1c2NhciB1c3XDoXJpbyBwb3IgZW1haWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyB1c3XDoXJpbyBlc3TDoSBibG9xdWVhZG8gcG9yIGV4Y2Vzc28gZGUgdGVudGF0aXZhc1xuICAgKiBAcGFyYW0gdXN1YXJpbyBVc3XDoXJpbyBhIHNlciB2ZXJpZmljYWRvXG4gICAqIEByZXR1cm5zIHRydWUgc2UgZXN0aXZlciBibG9xdWVhZG9cbiAgICovXG4gIHByaXZhdGUgaXNVc2VyTG9ja2VkKHVzdWFyaW86IFVzdWFyaW8pOiBib29sZWFuIHtcbiAgICBpZiAoIXVzdWFyaW8udGVudGF0aXZhc19sb2dpbiB8fCB1c3VhcmlvLnRlbnRhdGl2YXNfbG9naW4gPCB0aGlzLk1BWF9MT0dJTl9BVFRFTVBUUykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGxhc3RBdHRlbXB0ID0gdXN1YXJpby51bHRpbW9fbG9naW4gfHwgbmV3IERhdGUoMCk7XG4gICAgY29uc3QgdGltZVNpbmNlTGFzdEF0dGVtcHQgPSBEYXRlLm5vdygpIC0gbGFzdEF0dGVtcHQuZ2V0VGltZSgpO1xuICAgIFxuICAgIHJldHVybiB0aW1lU2luY2VMYXN0QXR0ZW1wdCA8IHRoaXMuTE9DS09VVF9EVVJBVElPTjtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmNyZW1lbnRhIG8gY29udGFkb3IgZGUgdGVudGF0aXZhcyBkZSBsb2dpblxuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGluY3JlbWVudExvZ2luQXR0ZW1wdHModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5kYXRhU291cmNlLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzdWFyaW9SZXBvID0gbWFuYWdlci5nZXRSZXBvc2l0b3J5KFVzdWFyaW8pO1xuICAgICAgICBhd2FpdCB1c3VhcmlvUmVwby5pbmNyZW1lbnQoXG4gICAgICAgICAgeyBpZDogdXNlcklkIH0sXG4gICAgICAgICAgJ3RlbnRhdGl2YXNfbG9naW4nLFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgdXN1YXJpb1JlcG8udXBkYXRlKHVzZXJJZCwge1xuICAgICAgICAgIHVsdGltb19sb2dpbjogbmV3IERhdGUoKVxuICAgICAgICB9IGFzIERlZXBQYXJ0aWFsPFVzdWFyaW8+KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgVGVudGF0aXZhIGRlIGxvZ2luIGZhbGhhZGEgaW5jcmVtZW50YWRhIHBhcmEgdXN1w6FyaW86ICR7dXNlcklkfWAsXG4gICAgICAgIHsgY29udGV4dDogJ1NFQ1VSSVRZX0xPR0lOX0ZBSUxFRCcsIHVzZXJJZCB9XG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gaW5jcmVtZW50YXIgdGVudGF0aXZhcyBkZSBsb2dpbjogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldGEgbyBjb250YWRvciBkZSB0ZW50YXRpdmFzIGRlIGxvZ2luXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW9cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcmVzZXRMb2dpbkF0dGVtcHRzKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMudXN1YXJpb1JlcG9zaXRvcnkudXBkYXRlU3RhdHVzKHVzZXJJZCwgU3RhdHVzLkFUSVZPKTtcbiAgICAgIGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgICBjb25zdCB1c3VhcmlvUmVwbyA9IG1hbmFnZXIuZ2V0UmVwb3NpdG9yeShVc3VhcmlvKTtcbiAgICAgICAgYXdhaXQgdXN1YXJpb1JlcG8udXBkYXRlKHVzZXJJZCwge1xuICAgICAgICAgIHRlbnRhdGl2YXNfbG9naW46IDAsXG4gICAgICAgICAgdWx0aW1vX2xvZ2luOiBuZXcgRGF0ZSgpXG4gICAgICAgIH0gYXMgRGVlcFBhcnRpYWw8VXN1YXJpbz4pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYExvZ2luIGJlbS1zdWNlZGlkbyAtIHRlbnRhdGl2YXMgcmVzZXRhZGFzIHBhcmEgdXN1w6FyaW86ICR7dXNlcklkfWAsXG4gICAgICAgIHsgY29udGV4dDogJ1NFQ1VSSVRZX0xPR0lOX1NVQ0NFU1MnLCB1c2VySWQgfVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIHJlc2V0YXIgdGVudGF0aXZhcyBkZSBsb2dpbjogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgY3JlZGVuY2lhaXMgZGUgbG9naW4gY29tIGNvbnRyb2xlIGRlIHRlbnRhdGl2YXNcbiAgICogQHBhcmFtIGVtYWlsIEVtYWlsIGRvIHVzdcOhcmlvXG4gICAqIEBwYXJhbSBzZW5oYSBTZW5oYSBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyBVc3XDoXJpbyBzZSBjcmVkZW5jaWFpcyB2w6FsaWRhcywgbnVsbCBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlVXNlckNyZWRlbnRpYWxzKGVtYWlsOiBzdHJpbmcsIHNlbmhhOiBzdHJpbmcpOiBQcm9taXNlPFVzdWFyaW8gfCBudWxsPiB7XG4gICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHRoaXMuZmluZEJ5RW1haWwoZW1haWwpO1xuICAgIFxuICAgIGlmICghdXN1YXJpbykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIHVzdcOhcmlvIGVzdMOhIGJsb3F1ZWFkb1xuICAgIGlmICh0aGlzLmlzVXNlckxvY2tlZCh1c3VhcmlvKSkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgYFRlbnRhdGl2YSBkZSBsb2dpbiBlbSBjb250YSBibG9xdWVhZGE6ICR7dXN1YXJpby5pZH1gLFxuICAgICAgICB7IFxuICAgICAgICAgIGNvbnRleHQ6ICdTRUNVUklUWV9CTE9DS0VEX0xPR0lOX0FUVEVNUFQnLCBcbiAgICAgICAgICB1c2VySWQ6IHVzdWFyaW8uaWQsIFxuICAgICAgICAgIGVtYWlsOiB1c3VhcmlvLmVtYWlsLFxuICAgICAgICAgIGF0dGVtcHRzOiB1c3VhcmlvLnRlbnRhdGl2YXNfbG9naW5cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRocm93VXN1YXJpb0FjY291bnRCbG9ja2VkKHsgZW1haWwgfSk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlbmhhXG4gICAgY29uc3Qgc2VuaGFWYWxpZGEgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShzZW5oYSwgdXN1YXJpby5zZW5oYUhhc2gpO1xuICAgIFxuICAgIGlmICghc2VuaGFWYWxpZGEpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5jcmVtZW50TG9naW5BdHRlbXB0cyh1c3VhcmlvLmlkKTtcbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgYFRlbnRhdGl2YSBkZSBsb2dpbiBjb20gc2VuaGEgaW5jb3JyZXRhOiAke3VzdWFyaW8uaWR9YCxcbiAgICAgICAgeyBcbiAgICAgICAgICBjb250ZXh0OiAnU0VDVVJJVFlfSU5WQUxJRF9QQVNTV09SRCcsIFxuICAgICAgICAgIHVzZXJJZDogdXN1YXJpby5pZCwgXG4gICAgICAgICAgZW1haWw6IHVzdWFyaW8uZW1haWwsXG4gICAgICAgICAgYXR0ZW1wdHM6ICh1c3VhcmlvLnRlbnRhdGl2YXNfbG9naW4gfHwgMCkgKyAxXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBcbiAgICAgIHRocm93VXN1YXJpb0NyZWRlbnRpYWxzSW52YWxpZCh7IGVtYWlsIH0pO1xuICAgIH1cblxuICAgIC8vIExvZ2luIGJlbS1zdWNlZGlkbyAtIHJlc2V0YXIgdGVudGF0aXZhc1xuICAgIGF3YWl0IHRoaXMucmVzZXRMb2dpbkF0dGVtcHRzKHVzdWFyaW8uaWQpO1xuICAgIFxuICAgIHJldHVybiB1c3VhcmlvO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bSB1c3XDoXJpbyAoc29mdCBkZWxldGUpXG4gICAqIEBwYXJhbSBpZCAtIElEIGRvIHVzdcOhcmlvIGEgc2VyIHJlbW92aWRvXG4gICAqIEByZXR1cm5zIFByb21pc2U8dm9pZD5cbiAgICovXG4gIGFzeW5jIHJlbW92ZShpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBJbmljaWFuZG8gcmVtb8Onw6NvIGRvIHVzdcOhcmlvOiAke2lkfWApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFZlcmlmaWNhIHNlIG8gdXN1w6FyaW8gZXhpc3RlXG4gICAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG4gICAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgVXN1w6FyaW8gbsOjbyBlbmNvbnRyYWRvIHBhcmEgcmVtb8Onw6NvOiAke2lkfWApO1xuICAgICAgICB0aHJvd1VzdWFyaW9Ob3RGb3VuZCh7IHVzZXJJZDogaWQgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlYWxpemEgbyBzb2Z0IGRlbGV0ZVxuICAgICAgYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS5yZW1vdmUoaWQpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzdcOhcmlvIHJlbW92aWRvIGNvbSBzdWNlc3NvOiAke2lkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gcmVtb3ZlciB1c3XDoXJpbyAke2lkfTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBbHRlcmEgYSBzZW5oYSBkbyB1c3XDoXJpbyBubyBwcmltZWlybyBhY2Vzc29cbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gYWx0ZXJhclNlbmhhRHRvIERhZG9zIGRhIG5vdmEgc2VuaGFcbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIG9wZXJhw6fDo29cbiAgICovXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RhcyBhcyByb2xlcyBkaXNwb27DrXZlaXMgbm8gc2lzdGVtYVxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSByb2xlcyBjb20gaWQsIG5vbWUgZSBkZXNjcmnDp8Ojb1xuICAgKi9cbiAgYXN5bmMgZmluZEFsbFJvbGVzKCkge1xuICAgIHRoaXMubG9nZ2VyLmxvZygnQnVzY2FuZG8gdG9kYXMgYXMgcm9sZXMgZGlzcG9uw612ZWlzJyk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJvbGVzID0gYXdhaXQgdGhpcy5yb2xlUmVwb3NpdG9yeS5maW5kKHtcbiAgICAgICAgc2VsZWN0OiBbJ2lkJywgJ25vbWUnLCAnZGVzY3JpY2FvJywgJ3N0YXR1cyddLFxuICAgICAgICB3aGVyZTogeyBzdGF0dXM6IFN0YXR1cy5BVElWTyB9LFxuICAgICAgICBvcmRlcjogeyBub21lOiAnQVNDJyB9XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGF0YTogcm9sZXMsXG4gICAgICAgIG1ldGE6IHsgdG90YWw6IHJvbGVzLmxlbmd0aCB9LFxuICAgICAgICBtZXNzYWdlOiAnUm9sZXMgcmV0b3JuYWRhcyBjb20gc3VjZXNzbydcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBidXNjYXIgcm9sZXM6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvd1VzdWFyaW9JbnRlcm5hbEVycm9yKHsgb3BlcmF0aW9uOiAnZmluZEFsbFJvbGVzJywgb3JpZ2luYWxFcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBhbHRlcmFyU2VuaGFQcmltZWlyb0FjZXNzbyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBhbHRlcmFyU2VuaGFEdG86IEFsdGVyYXJTZW5oYVByaW1laXJvQWNlc3NvRHRvLFxuICApIHtcbiAgICB0aGlzLmxvZ2dlci5sb2coYEluaWNpYW5kbyBhbHRlcmHDp8OjbyBkZSBzZW5oYSBubyBwcmltZWlybyBhY2Vzc28gcGFyYSB1c3XDoXJpbyAke3VzZXJJZH1gKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZmljYXIgc2UgYXMgc2VuaGFzIGNvaW5jaWRlbVxuICAgICAgaWYgKGFsdGVyYXJTZW5oYUR0by5ub3ZhU2VuaGEgIT09IGFsdGVyYXJTZW5oYUR0by5jb25maXJtYXJTZW5oYSkge1xuICAgICAgICB0aHJvd1VzdWFyaW9QYXNzd29yZE1pc21hdGNoKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVzYXIgdHJhbnNhw6fDo28gcGFyYSBnYXJhbnRpciBjb25zaXN0w6puY2lhXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzdWFyaW9SZXBvID0gbWFuYWdlci5nZXRSZXBvc2l0b3J5KCd1c3VhcmlvJyk7XG5cbiAgICAgICAgLy8gQnVzY2FyIHVzdcOhcmlvXG4gICAgICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB1c3VhcmlvUmVwby5maW5kT25lKHsgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9IH0pO1xuICAgICAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBVc3XDoXJpbyBuw6NvIGVuY29udHJhZG86ICR7dXNlcklkfWApO1xuICAgICAgICAgIHRocm93VXN1YXJpb05vdEZvdW5kKHsgdXNlcklkIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGVzdMOhIGVtIHByaW1laXJvIGFjZXNzb1xuICAgICAgICBpZiAoIXVzdWFyaW8ucHJpbWVpcm9fYWNlc3NvKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgVXN1w6FyaW8gJHt1c2VySWR9IG7Do28gZXN0w6EgZW0gcHJpbWVpcm8gYWNlc3NvYCk7XG4gICAgICAgICAgdGhyb3dVc3VhcmlvTm90SW5GaXJzdEFjY2Vzcyh7IHVzZXJJZCB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdlcmFyIGhhc2ggZGEgbm92YSBzZW5oYVxuICAgICAgICBjb25zdCBub3ZvSGFzaCA9IGF3YWl0IGJjcnlwdC5oYXNoKGFsdGVyYXJTZW5oYUR0by5ub3ZhU2VuaGEsIDEyKTtcblxuICAgICAgICAvLyBBdHVhbGl6YXIgc2VuaGEgZSBtYXJjYXIgY29tbyBuw6NvIHNlbmRvIG1haXMgcHJpbWVpcm8gYWNlc3NvXG4gICAgICAgIGF3YWl0IHVzdWFyaW9SZXBvLnVwZGF0ZSh1c2VySWQsIHtcbiAgICAgICAgICBzZW5oYUhhc2g6IG5vdm9IYXNoLFxuICAgICAgICAgIHByaW1laXJvX2FjZXNzbzogZmFsc2UsXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmxvZ2dlci5sb2coYFNlbmhhIGFsdGVyYWRhIGNvbSBzdWNlc3NvIG5vIHByaW1laXJvIGFjZXNzbyBwYXJhIHVzdcOhcmlvICR7dXNlcklkfWApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICBtZXRhOiBudWxsLFxuICAgICAgICAgIG1lc3NhZ2U6ICdTZW5oYSBhbHRlcmFkYSBjb20gc3VjZXNzby4gVm9jw6ogcG9kZSBhZ29yYSBhY2Vzc2FyIG8gc2lzdGVtYSBub3JtYWxtZW50ZS4nLFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhbHRlcmFyIHNlbmhhIG5vIHByaW1laXJvIGFjZXNzbyBwYXJhIHVzdcOhcmlvICR7dXNlcklkfTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFVzdWFyaW9FcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93VXN1YXJpb0ludGVybmFsRXJyb3IoeyBvcGVyYXRpb246ICdhbHRlcmFyU2VuaGFQcmltZWlyb0FjZXNzbycsIG9yaWdpbmFsRXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=