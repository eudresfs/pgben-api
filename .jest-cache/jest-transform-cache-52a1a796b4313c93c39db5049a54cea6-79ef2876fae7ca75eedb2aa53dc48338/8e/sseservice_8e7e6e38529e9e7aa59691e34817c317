7b5f302a5c3d87dc32d0f1602601de55
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var SseService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SseService = void 0;
const common_1 = require("@nestjs/common");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
/**
 * Serviço SSE (Server-Sent Events)
 *
 * Responsável por gerenciar conexões SSE e envio de notificações em tempo real.
 * Mantém um mapa de conexões ativas por usuário e fornece métodos para
 * envio de notificações individuais ou em massa.
 */
let SseService = SseService_1 = class SseService {
    isUserConnected(userId) {
        throw new Error('Method not implemented.');
    }
    getUserConnectionCount(userId) {
        throw new Error('Method not implemented.');
    }
    logger = new common_1.Logger(SseService_1.name);
    /** Mapa de conexões ativas: userId -> Map<connectionId, Subject> */
    connections = new Map();
    /** Intervalo de heartbeat em milissegundos (30 segundos) */
    heartbeatInterval = 30000;
    /** Máximo de conexões por usuário */
    maxConnectionsPerUser = 5;
    /**
     * Cria uma nova conexão SSE para o usuário
     * @param userId ID do usuário
     * @param clientInfo Informações do cliente (opcional)
     * @returns Observable de MessageEvent para a conexão SSE
     */
    createConnection(userId, clientInfo) {
        const connectionId = this.generateConnectionId();
        const subject = new rxjs_1.Subject();
        // Inicializa mapa do usuário se não existir
        if (!this.connections.has(userId)) {
            this.connections.set(userId, new Map());
        }
        const userConnections = this.connections.get(userId);
        // Verifica limite de conexões por usuário
        if (userConnections.size >= this.maxConnectionsPerUser) {
            this.logger.warn(`Usuário ${userId} atingiu o limite de ${this.maxConnectionsPerUser} conexões`);
            // Remove a conexão mais antiga
            const oldestConnectionId = userConnections.keys().next().value;
            this.removeConnection(userId, oldestConnectionId);
        }
        userConnections.set(connectionId, subject);
        this.logger.log(`Nova conexão SSE: ${userId}:${connectionId}`);
        if (clientInfo) {
            this.logger.debug(`Cliente conectado: ${clientInfo.userAgent} - IP: ${clientInfo.ip}`);
        }
        // Configura heartbeat
        const heartbeat$ = (0, rxjs_1.interval)(this.heartbeatInterval).pipe((0, operators_1.map)(() => {
            const heartbeatEvent = {
                type: 'heartbeat',
                timestamp: new Date(),
                connectionId
            };
            return {
                data: JSON.stringify(heartbeatEvent)
            };
        }));
        // Combina notificações com heartbeat
        return new rxjs_1.Observable(observer => {
            // Envia evento de conexão estabelecida
            observer.next({
                data: JSON.stringify({
                    type: 'connection_established',
                    connectionId,
                    timestamp: new Date()
                })
            });
            const subscription = subject.asObservable().subscribe(observer);
            const heartbeatSub = heartbeat$.subscribe(observer);
            // Cleanup na desconexão
            return () => {
                subscription.unsubscribe();
                heartbeatSub.unsubscribe();
                this.removeConnection(userId, connectionId);
            };
        });
    }
    /**
     * Envia notificação para usuário específico
     * @param userId ID do usuário destinatário
     * @param notification Dados da notificação
     */
    sendToUser(userId, notification) {
        const userConnections = this.connections.get(userId);
        if (!userConnections || userConnections.size === 0) {
            this.logger.warn(`Usuário ${userId} não tem conexões ativas`);
            return;
        }
        const messageEvent = {
            data: JSON.stringify({
                ...notification,
                timestamp: notification.timestamp.toISOString()
            })
        };
        // Envia para todas as conexões do usuário
        let successCount = 0;
        userConnections.forEach((subject, connectionId) => {
            try {
                subject.next(messageEvent);
                successCount++;
                this.logger.debug(`Notificação enviada: ${userId}:${connectionId}`);
            }
            catch (error) {
                this.logger.error(`Erro ao enviar notificação para ${userId}:${connectionId}: ${error.message}`);
                this.removeConnection(userId, connectionId);
            }
        });
        this.logger.log(`Notificação enviada para ${successCount}/${userConnections.size} conexões do usuário ${userId}`);
    }
    /**
     * Envia notificação para múltiplos usuários
     * @param userIds Lista de IDs dos usuários
     * @param notification Dados da notificação (sem userId)
     */
    sendToUsers(userIds, notification) {
        this.logger.log(`Enviando notificação em massa para ${userIds.length} usuários`);
        userIds.forEach(userId => {
            this.sendToUser(userId, { ...notification, userId });
        });
    }
    /**
     * Envia notificação broadcast para todos os usuários conectados
     * @param notification Dados da notificação
     */
    broadcastToAll(notification) {
        const connectedUserIds = Array.from(this.connections.keys());
        this.logger.log(`Enviando broadcast para ${connectedUserIds.length} usuários conectados`);
        this.sendToUsers(connectedUserIds, notification);
    }
    /**
     * Remove uma conexão específica
     * @param userId ID do usuário
     * @param connectionId ID da conexão
     */
    removeConnection(userId, connectionId) {
        const userConnections = this.connections.get(userId);
        if (userConnections) {
            const subject = userConnections.get(connectionId);
            if (subject) {
                subject.complete();
            }
            userConnections.delete(connectionId);
            // Remove mapa do usuário se não houver mais conexões
            if (userConnections.size === 0) {
                this.connections.delete(userId);
            }
            this.logger.log(`Conexão removida: ${userId}:${connectionId}`);
        }
    }
    /**
     * Remove todas as conexões de um usuário
     * @param userId ID do usuário
     */
    removeUserConnections(userId) {
        const userConnections = this.connections.get(userId);
        if (userConnections) {
            userConnections.forEach((subject, connectionId) => {
                subject.complete();
                this.logger.log(`Conexão removida: ${userId}:${connectionId}`);
            });
            this.connections.delete(userId);
            this.logger.log(`Todas as conexões do usuário ${userId} foram removidas`);
        }
    }
    /**
     * Verifica se um usuário tem conexões ativas
     * @param userId ID do usuário
     * @returns true se o usuário tem conexões ativas
     */
    hasActiveConnections(userId) {
        const userConnections = this.connections.get(userId);
        return userConnections ? userConnections.size > 0 : false;
    }
    /**
     * Retorna estatísticas das conexões
     * @returns Estatísticas detalhadas das conexões SSE
     */
    getConnectionStats() {
        let totalConnections = 0;
        const connectionsPerUser = {};
        this.connections.forEach((userConns, userId) => {
            const connectionCount = userConns.size;
            totalConnections += connectionCount;
            connectionsPerUser[userId] = connectionCount;
        });
        return {
            totalUsers: this.connections.size,
            totalConnections,
            connectionsPerUser,
            lastUpdated: new Date()
        };
    }
    /**
     * Retorna lista de usuários conectados
     * @returns Array com IDs dos usuários conectados
     */
    getConnectedUsers() {
        return Array.from(this.connections.keys());
    }
    /**
     * Limpa todas as conexões (usado para shutdown graceful)
     */
    clearAllConnections() {
        this.logger.log('Limpando todas as conexões SSE');
        this.connections.forEach((userConns, userId) => {
            userConns.forEach((subject, connectionId) => {
                subject.complete();
            });
        });
        this.connections.clear();
        this.logger.log('Todas as conexões SSE foram limpas');
    }
    /**
     * Gera um ID único para a conexão
     * @returns ID único da conexão
     */
    generateConnectionId() {
        return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }
};
exports.SseService = SseService;
exports.SseService = SseService = SseService_1 = __decorate([
    (0, common_1.Injectable)()
], SseService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXG5vdGlmaWNhY2FvXFxzZXJ2aWNlc1xcc3NlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDJDQUFvRDtBQUNwRCwrQkFBcUQ7QUFDckQsOENBQWdEO0FBR2hEOzs7Ozs7R0FNRztBQUVJLElBQU0sVUFBVSxrQkFBaEIsTUFBTSxVQUFVO0lBQ3JCLGVBQWUsQ0FBQyxNQUFjO1FBQzVCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBQ0Qsc0JBQXNCLENBQUMsTUFBYztRQUNuQyxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUNnQixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsWUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRELG9FQUFvRTtJQUNuRCxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQThDLENBQUM7SUFFckYsNERBQTREO0lBQzNDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztJQUUzQyxxQ0FBcUM7SUFDcEIscUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0lBRTNDOzs7OztPQUtHO0lBQ0gsZ0JBQWdCLENBQUMsTUFBYyxFQUFFLFVBQWdEO1FBQy9FLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQ2pELE1BQU0sT0FBTyxHQUFHLElBQUksY0FBTyxFQUFnQixDQUFDO1FBRTVDLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzFDLENBQUM7UUFFRCxNQUFNLGVBQWUsR0FBRyxJQUFJ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QztJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSCxpQkFBaUI7UUFDZixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRDs7T0FFRztJQUNILG1CQUFtQjtRQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRWxELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzdDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLEVBQUU7Z0JBQzFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNyQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRDs7O09BR0c7SUFDSyxvQkFBb0I7UUFDMUIsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNwRSxDQUFDO0NBQ0YsQ0FBQTtBQTVQWSxnQ0FBVTtxQkFBVixVQUFVO0lBRHRCLElBQUEsbUJBQVUsR0FBRTtHQUNBLFVBQVUsQ0E0UHRCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxub3RpZmljYWNhb1xcc2VydmljZXNcXHNzZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIGludGVydmFsIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFNzZU5vdGlmaWNhdGlvbiwgU3NlQ29ubmVjdGlvbiwgU3NlQ29ubmVjdGlvblN0YXRzLCBIZWFydGJlYXRFdmVudCB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3NlLW5vdGlmaWNhdGlvbi5pbnRlcmZhY2UnO1xuXG4vKipcbiAqIFNlcnZpw6dvIFNTRSAoU2VydmVyLVNlbnQgRXZlbnRzKVxuICogXG4gKiBSZXNwb25zw6F2ZWwgcG9yIGdlcmVuY2lhciBjb25leMO1ZXMgU1NFIGUgZW52aW8gZGUgbm90aWZpY2HDp8O1ZXMgZW0gdGVtcG8gcmVhbC5cbiAqIE1hbnTDqW0gdW0gbWFwYSBkZSBjb25leMO1ZXMgYXRpdmFzIHBvciB1c3XDoXJpbyBlIGZvcm5lY2UgbcOpdG9kb3MgcGFyYVxuICogZW52aW8gZGUgbm90aWZpY2HDp8O1ZXMgaW5kaXZpZHVhaXMgb3UgZW0gbWFzc2EuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTc2VTZXJ2aWNlIHtcbiAgaXNVc2VyQ29ubmVjdGVkKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIGdldFVzZXJDb25uZWN0aW9uQ291bnQodXNlcklkOiBzdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBub3QgaW1wbGVtZW50ZWQuJyk7XG4gIH1cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFNzZVNlcnZpY2UubmFtZSk7XG4gIFxuICAvKiogTWFwYSBkZSBjb25leMO1ZXMgYXRpdmFzOiB1c2VySWQgLT4gTWFwPGNvbm5lY3Rpb25JZCwgU3ViamVjdD4gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBjb25uZWN0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBTdWJqZWN0PE1lc3NhZ2VFdmVudD4+PigpO1xuICBcbiAgLyoqIEludGVydmFsbyBkZSBoZWFydGJlYXQgZW0gbWlsaXNzZWd1bmRvcyAoMzAgc2VndW5kb3MpICovXG4gIHByaXZhdGUgcmVhZG9ubHkgaGVhcnRiZWF0SW50ZXJ2YWwgPSAzMDAwMDtcbiAgXG4gIC8qKiBNw6F4aW1vIGRlIGNvbmV4w7VlcyBwb3IgdXN1w6FyaW8gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBtYXhDb25uZWN0aW9uc1BlclVzZXIgPSA1O1xuXG4gIC8qKlxuICAgKiBDcmlhIHVtYSBub3ZhIGNvbmV4w6NvIFNTRSBwYXJhIG8gdXN1w6FyaW9cbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gY2xpZW50SW5mbyBJbmZvcm1hw6fDtWVzIGRvIGNsaWVudGUgKG9wY2lvbmFsKVxuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIGRlIE1lc3NhZ2VFdmVudCBwYXJhIGEgY29uZXjDo28gU1NFXG4gICAqL1xuICBjcmVhdGVDb25uZWN0aW9uKHVzZXJJZDogc3RyaW5nLCBjbGllbnRJbmZvPzogeyB1c2VyQWdlbnQ/OiBzdHJpbmc7IGlwPzogc3RyaW5nIH0pOiBPYnNlcnZhYmxlPE1lc3NhZ2VFdmVudD4ge1xuICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRoaXMuZ2VuZXJhdGVDb25uZWN0aW9uSWQoKTtcbiAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3Q8TWVzc2FnZUV2ZW50PigpO1xuICAgIFxuICAgIC8vIEluaWNpYWxpemEgbWFwYSBkbyB1c3XDoXJpbyBzZSBuw6NvIGV4aXN0aXJcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbnMuaGFzKHVzZXJJZCkpIHtcbiAgICAgIHRoaXMuY29ubmVjdGlvbnMuc2V0KHVzZXJJZCwgbmV3IE1hcCgpKTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgdXNlckNvbm5lY3Rpb25zID0gdGhpcy5jb25uZWN0aW9ucy5nZXQodXNlcklkKSE7XG4gICAgXG4gICAgLy8gVmVyaWZpY2EgbGltaXRlIGRlIGNvbmV4w7VlcyBwb3IgdXN1w6FyaW9cbiAgICBpZiAodXNlckNvbm5lY3Rpb25zLnNpemUgPj0gdGhpcy5tYXhDb25uZWN0aW9uc1BlclVzZXIpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFVzdcOhcmlvICR7dXNlcklkfSBhdGluZ2l1IG8gbGltaXRlIGRlICR7dGhpcy5tYXhDb25uZWN0aW9uc1BlclVzZXJ9IGNvbmV4w7Vlc2ApO1xuICAgICAgLy8gUmVtb3ZlIGEgY29uZXjDo28gbWFpcyBhbnRpZ2FcbiAgICAgIGNvbnN0IG9sZGVzdENvbm5lY3Rpb25JZCA9IHVzZXJDb25uZWN0aW9ucy5rZXlzKCkubmV4dCgpLnZhbHVlO1xuICAgICAgdGhpcy5yZW1vdmVDb25uZWN0aW9uKHVzZXJJZCwgb2xkZXN0Q29ubmVjdGlvbklkKTtcbiAgICB9XG4gICAgXG4gICAgdXNlckNvbm5lY3Rpb25zLnNldChjb25uZWN0aW9uSWQsIHN1YmplY3QpO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgTm92YSBjb25leMOjbyBTU0U6ICR7dXNlcklkfToke2Nvbm5lY3Rpb25JZH1gKTtcbiAgICBcbiAgICBpZiAoY2xpZW50SW5mbykge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYENsaWVudGUgY29uZWN0YWRvOiAke2NsaWVudEluZm8udXNlckFnZW50fSAtIElQOiAke2NsaWVudEluZm8uaXB9YCk7XG4gICAgfVxuXG4gICAgLy8gQ29uZmlndXJhIGhlYXJ0YmVhdFxuICAgIGNvbnN0IGhlYXJ0YmVhdCQgPSBpbnRlcnZhbCh0aGlzLmhlYXJ0YmVhdEludGVydmFsKS5waXBlKFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgY29uc3QgaGVhcnRiZWF0RXZlbnQ6IEhlYXJ0YmVhdEV2ZW50ID0ge1xuICAgICAgICAgIHR5cGU6ICdoZWFydGJlYXQnLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICBjb25uZWN0aW9uSWRcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoaGVhcnRiZWF0RXZlbnQpXG4gICAgICAgIH0gYXMgTWVzc2FnZUV2ZW50O1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gQ29tYmluYSBub3RpZmljYcOnw7VlcyBjb20gaGVhcnRiZWF0XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPE1lc3NhZ2VFdmVudD4ob2JzZXJ2ZXIgPT4ge1xuICAgICAgLy8gRW52aWEgZXZlbnRvIGRlIGNvbmV4w6NvIGVzdGFiZWxlY2lkYVxuICAgICAgb2JzZXJ2ZXIubmV4dCh7XG4gICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICB0eXBlOiAnY29ubmVjdGlvbl9lc3RhYmxpc2hlZCcsXG4gICAgICAgICAgY29ubmVjdGlvbklkLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgICB9KVxuICAgICAgfSBhcyBNZXNzYWdlRXZlbnQpO1xuICAgICAgXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBzdWJqZWN0LmFzT2JzZXJ2YWJsZSgpLnN1YnNjcmliZShvYnNlcnZlcik7XG4gICAgICBjb25zdCBoZWFydGJlYXRTdWIgPSBoZWFydGJlYXQkLnN1YnNjcmliZShvYnNlcnZlcik7XG5cbiAgICAgIC8vIENsZWFudXAgbmEgZGVzY29uZXjDo29cbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICBoZWFydGJlYXRTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgdGhpcy5yZW1vdmVDb25uZWN0aW9uKHVzZXJJZCwgY29ubmVjdGlvbklkKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRW52aWEgbm90aWZpY2HDp8OjbyBwYXJhIHVzdcOhcmlvIGVzcGVjw61maWNvXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW8gZGVzdGluYXTDoXJpb1xuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uIERhZG9zIGRhIG5vdGlmaWNhw6fDo29cbiAgICovXG4gIHNlbmRUb1VzZXIodXNlcklkOiBzdHJpbmcsIG5vdGlmaWNhdGlvbjogU3NlTm90aWZpY2F0aW9uKTogdm9pZCB7XG4gICAgY29uc3QgdXNlckNvbm5lY3Rpb25zID0gdGhpcy5jb25uZWN0aW9ucy5nZXQodXNlcklkKTtcbiAgICBcbiAgICBpZiAoIXVzZXJDb25uZWN0aW9ucyB8fCB1c2VyQ29ubmVjdGlvbnMuc2l6ZSA9PT0gMCkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgVXN1w6FyaW8gJHt1c2VySWR9IG7Do28gdGVtIGNvbmV4w7VlcyBhdGl2YXNgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlRXZlbnQ6IE1lc3NhZ2VFdmVudCA9IHtcbiAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgLi4ubm90aWZpY2F0aW9uLFxuICAgICAgICB0aW1lc3RhbXA6IG5vdGlmaWNhdGlvbi50aW1lc3RhbXAudG9JU09TdHJpbmcoKVxuICAgICAgfSlcbiAgICB9IGFzIE1lc3NhZ2VFdmVudDtcblxuICAgIC8vIEVudmlhIHBhcmEgdG9kYXMgYXMgY29uZXjDtWVzIGRvIHVzdcOhcmlvXG4gICAgbGV0IHN1Y2Nlc3NDb3VudCA9IDA7XG4gICAgdXNlckNvbm5lY3Rpb25zLmZvckVhY2goKHN1YmplY3QsIGNvbm5lY3Rpb25JZCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgc3ViamVjdC5uZXh0KG1lc3NhZ2VFdmVudCk7XG4gICAgICAgIHN1Y2Nlc3NDb3VudCsrO1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgTm90aWZpY2HDp8OjbyBlbnZpYWRhOiAke3VzZXJJZH06JHtjb25uZWN0aW9uSWR9YCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBhbyBlbnZpYXIgbm90aWZpY2HDp8OjbyBwYXJhICR7dXNlcklkfToke2Nvbm5lY3Rpb25JZH06ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgdGhpcy5yZW1vdmVDb25uZWN0aW9uKHVzZXJJZCwgY29ubmVjdGlvbklkKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICB0aGlzLmxvZ2dlci5sb2coYE5vdGlmaWNhw6fDo28gZW52aWFkYSBwYXJhICR7c3VjY2Vzc0NvdW50fS8ke3VzZXJDb25uZWN0aW9ucy5zaXplfSBjb25leMO1ZXMgZG8gdXN1w6FyaW8gJHt1c2VySWR9YCk7XG4gIH1cblxuICAvKipcbiAgICogRW52aWEgbm90aWZpY2HDp8OjbyBwYXJhIG3Dumx0aXBsb3MgdXN1w6FyaW9zXG4gICAqIEBwYXJhbSB1c2VySWRzIExpc3RhIGRlIElEcyBkb3MgdXN1w6FyaW9zXG4gICAqIEBwYXJhbSBub3RpZmljYXRpb24gRGFkb3MgZGEgbm90aWZpY2HDp8OjbyAoc2VtIHVzZXJJZClcbiAgICovXG4gIHNlbmRUb1VzZXJzKHVzZXJJZHM6IHN0cmluZ1tdLCBub3RpZmljYXRpb246IE9taXQ8U3NlTm90aWZpY2F0aW9uLCAndXNlcklkJz4pOiB2b2lkIHtcbiAgICB0aGlzLmxvZ2dlci5sb2coYEVudmlhbmRvIG5vdGlmaWNhw6fDo28gZW0gbWFzc2EgcGFyYSAke3VzZXJJZHMubGVuZ3RofSB1c3XDoXJpb3NgKTtcbiAgICBcbiAgICB1c2VySWRzLmZvckVhY2godXNlcklkID0+IHtcbiAgICAgIHRoaXMuc2VuZFRvVXNlcih1c2VySWQsIHsgLi4ubm90aWZpY2F0aW9uLCB1c2VySWQgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRW52aWEgbm90aWZpY2HDp8OjbyBicm9hZGNhc3QgcGFyYSB0b2RvcyBvcyB1c3XDoXJpb3MgY29uZWN0YWRvc1xuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uIERhZG9zIGRhIG5vdGlmaWNhw6fDo29cbiAgICovXG4gIGJyb2FkY2FzdFRvQWxsKG5vdGlmaWNhdGlvbjogT21pdDxTc2VOb3RpZmljYXRpb24sICd1c2VySWQnPik6IHZvaWQge1xuICAgIGNvbnN0IGNvbm5lY3RlZFVzZXJJZHMgPSBBcnJheS5mcm9tKHRoaXMuY29ubmVjdGlvbnMua2V5cygpKTtcbiAgICB0aGlzLmxvZ2dlci5sb2coYEVudmlhbmRvIGJyb2FkY2FzdCBwYXJhICR7Y29ubmVjdGVkVXNlcklkcy5sZW5ndGh9IHVzdcOhcmlvcyBjb25lY3RhZG9zYCk7XG4gICAgXG4gICAgdGhpcy5zZW5kVG9Vc2Vycyhjb25uZWN0ZWRVc2VySWRzLCBub3RpZmljYXRpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bWEgY29uZXjDo28gZXNwZWPDrWZpY2FcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gY29ubmVjdGlvbklkIElEIGRhIGNvbmV4w6NvXG4gICAqL1xuICByZW1vdmVDb25uZWN0aW9uKHVzZXJJZDogc3RyaW5nLCBjb25uZWN0aW9uSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJDb25uZWN0aW9ucyA9IHRoaXMuY29ubmVjdGlvbnMuZ2V0KHVzZXJJZCk7XG4gICAgaWYgKHVzZXJDb25uZWN0aW9ucykge1xuICAgICAgY29uc3Qgc3ViamVjdCA9IHVzZXJDb25uZWN0aW9ucy5nZXQoY29ubmVjdGlvbklkKTtcbiAgICAgIGlmIChzdWJqZWN0KSB7XG4gICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdXNlckNvbm5lY3Rpb25zLmRlbGV0ZShjb25uZWN0aW9uSWQpO1xuICAgICAgXG4gICAgICAvLyBSZW1vdmUgbWFwYSBkbyB1c3XDoXJpbyBzZSBuw6NvIGhvdXZlciBtYWlzIGNvbmV4w7Vlc1xuICAgICAgaWYgKHVzZXJDb25uZWN0aW9ucy5zaXplID09PSAwKSB7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbnMuZGVsZXRlKHVzZXJJZCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ29uZXjDo28gcmVtb3ZpZGE6ICR7dXNlcklkfToke2Nvbm5lY3Rpb25JZH1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHRvZGFzIGFzIGNvbmV4w7VlcyBkZSB1bSB1c3XDoXJpb1xuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvXG4gICAqL1xuICByZW1vdmVVc2VyQ29ubmVjdGlvbnModXNlcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB1c2VyQ29ubmVjdGlvbnMgPSB0aGlzLmNvbm5lY3Rpb25zLmdldCh1c2VySWQpO1xuICAgIGlmICh1c2VyQ29ubmVjdGlvbnMpIHtcbiAgICAgIHVzZXJDb25uZWN0aW9ucy5mb3JFYWNoKChzdWJqZWN0LCBjb25uZWN0aW9uSWQpID0+IHtcbiAgICAgICAgc3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coYENvbmV4w6NvIHJlbW92aWRhOiAke3VzZXJJZH06JHtjb25uZWN0aW9uSWR9YCk7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdGhpcy5jb25uZWN0aW9ucy5kZWxldGUodXNlcklkKTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVG9kYXMgYXMgY29uZXjDtWVzIGRvIHVzdcOhcmlvICR7dXNlcklkfSBmb3JhbSByZW1vdmlkYXNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgdW0gdXN1w6FyaW8gdGVtIGNvbmV4w7VlcyBhdGl2YXNcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIG8gdXN1w6FyaW8gdGVtIGNvbmV4w7VlcyBhdGl2YXNcbiAgICovXG4gIGhhc0FjdGl2ZUNvbm5lY3Rpb25zKHVzZXJJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdXNlckNvbm5lY3Rpb25zID0gdGhpcy5jb25uZWN0aW9ucy5nZXQodXNlcklkKTtcbiAgICByZXR1cm4gdXNlckNvbm5lY3Rpb25zID8gdXNlckNvbm5lY3Rpb25zLnNpemUgPiAwIDogZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBlc3RhdMOtc3RpY2FzIGRhcyBjb25leMO1ZXNcbiAgICogQHJldHVybnMgRXN0YXTDrXN0aWNhcyBkZXRhbGhhZGFzIGRhcyBjb25leMO1ZXMgU1NFXG4gICAqL1xuICBnZXRDb25uZWN0aW9uU3RhdHMoKTogU3NlQ29ubmVjdGlvblN0YXRzIHtcbiAgICBsZXQgdG90YWxDb25uZWN0aW9ucyA9IDA7XG4gICAgY29uc3QgY29ubmVjdGlvbnNQZXJVc2VyOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG4gICAgXG4gICAgdGhpcy5jb25uZWN0aW9ucy5mb3JFYWNoKCh1c2VyQ29ubnMsIHVzZXJJZCkgPT4ge1xuICAgICAgY29uc3QgY29ubmVjdGlvbkNvdW50ID0gdXNlckNvbm5zLnNpemU7XG4gICAgICB0b3RhbENvbm5lY3Rpb25zICs9IGNvbm5lY3Rpb25Db3VudDtcbiAgICAgIGNvbm5lY3Rpb25zUGVyVXNlclt1c2VySWRdID0gY29ubmVjdGlvbkNvdW50O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsVXNlcnM6IHRoaXMuY29ubmVjdGlvbnMuc2l6ZSxcbiAgICAgIHRvdGFsQ29ubmVjdGlvbnMsXG4gICAgICBjb25uZWN0aW9uc1BlclVzZXIsXG4gICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBsaXN0YSBkZSB1c3XDoXJpb3MgY29uZWN0YWRvc1xuICAgKiBAcmV0dXJucyBBcnJheSBjb20gSURzIGRvcyB1c3XDoXJpb3MgY29uZWN0YWRvc1xuICAgKi9cbiAgZ2V0Q29ubmVjdGVkVXNlcnMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY29ubmVjdGlvbnMua2V5cygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaW1wYSB0b2RhcyBhcyBjb25leMO1ZXMgKHVzYWRvIHBhcmEgc2h1dGRvd24gZ3JhY2VmdWwpXG4gICAqL1xuICBjbGVhckFsbENvbm5lY3Rpb25zKCk6IHZvaWQge1xuICAgIHRoaXMubG9nZ2VyLmxvZygnTGltcGFuZG8gdG9kYXMgYXMgY29uZXjDtWVzIFNTRScpO1xuICAgIFxuICAgIHRoaXMuY29ubmVjdGlvbnMuZm9yRWFjaCgodXNlckNvbm5zLCB1c2VySWQpID0+IHtcbiAgICAgIHVzZXJDb25ucy5mb3JFYWNoKChzdWJqZWN0LCBjb25uZWN0aW9uSWQpID0+IHtcbiAgICAgICAgc3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgXG4gICAgdGhpcy5jb25uZWN0aW9ucy5jbGVhcigpO1xuICAgIHRoaXMubG9nZ2VyLmxvZygnVG9kYXMgYXMgY29uZXjDtWVzIFNTRSBmb3JhbSBsaW1wYXMnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXJhIHVtIElEIMO6bmljbyBwYXJhIGEgY29uZXjDo29cbiAgICogQHJldHVybnMgSUQgw7puaWNvIGRhIGNvbmV4w6NvXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlQ29ubmVjdGlvbklkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=