2785a06ebecc5d586638524590ae3482
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var HybridCacheService_1;
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.HybridCacheService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const schedule_1 = require("@nestjs/schedule");
const health_check_service_1 = require("./health-check.service");
const cache_service_1 = require("../cache/cache.service");
/**
 * Serviço de Cache Híbrido Resiliente
 *
 * Implementa um sistema de cache em múltiplas camadas com estratégias de resiliência:
 *
 * L1 Cache (Memória Local):
 * - Cache em memória ultra-rápido
 * - Limitado por tamanho configurável
 * - Algoritmo LRU com prioridades
 * - Sempre disponível
 *
 * L2 Cache (Redis):
 * - Cache distribuído persistente
 * - Compartilhado entre instâncias
 * - Fallback automático para L1 em caso de falha
 * - Circuit breaker integrado
 *
 * Funcionalidades de Resiliência:
 * - Cache warming automático
 * - Prevenção de cache stampede
 * - Métricas detalhadas
 * - Recuperação automática
 */
let HybridCacheService = HybridCacheService_1 = class HybridCacheService {
    configService;
    healthCheckService;
    cacheService;
    logger = new common_1.Logger(HybridCacheService_1.name);
    // L1 Cache (Memória Local)
    l1Cache = new Map();
    maxL1Size;
    defaultTtl;
    // Configurações
    enableL2Cache;
    enableCacheWarming;
    warmingInterval;
    // Métricas
    metrics = {
        l1Hits: 0,
        l1Misses: 0,
        l2Hits: 0,
        l2Misses: 0,
        evictions: 0,
        warmingOperations: 0,
        failovers: 0
    };
    // Cache warming - chaves críticas que devem estar sempre em cache
    criticalKeys = new Set();
    warmingCallbacks = new Map();
    // Prevenção de cache stampede
    pendingOperations = new Map();
    constructor(configService, healthCheckService, cacheService) {
        this.configService = configService;
        this.healthCheckService = healthCheckService;
        this.cacheService = cacheService;
        this.maxL1Size = this.configService.get('CACHE_L1_MAX_SIZE', 1000);
        this.defaultTtl = this.configService.get('CACHE_DEFAULT_TTL', 300000); // 5 minutos
        this.enableL2Cache = this.configService.get('CACHE_ENABLE_L2', 'true') === 'true';
        this.enableCacheWarming = this.configService.get('CACHE_ENABLE_WARMING', 'true') === 'true';
        this.warmingInterval = this.configService.get('CACHE_WARMING_INTERVAL', 60000); // 1 minuto
    }
    async onModuleInit() {
        this.logger.log('Inicializando Hybrid Cache Service');
        // TEMPORÁRIO: Desabilitando inicialização para evitar travamento
        this.logger.warn('⚠️ Inicialização do HybridCacheService desabilitada temporariamente');
        // TODO: Reabilitar após resolver problemas de conectividade com Redis
        /*
        if (this.enableCacheWarming) {
          this.logger.log('Cache warming habilitado');
        }
        
        // Registrar chaves críticas padrão
        this.registerCriticalKey('system:config', async () => {
          // Exemplo: carregar configurações do sistema
          return { loaded: true, timestamp: Date.now() };
        });
        */
    }
    /**
     * Obtém valor do cache com estratégia híbrida
     *
     * Fluxo:
     * 1. Verifica L1 Cache (memória local)
     * 2. Se não encontrar, verifica L2 Cache (Redis)
     * 3. Se encontrar no L2, promove para L1
     * 4. Se não encontrar em nenhum, retorna null
     *
     * @param key Chave do cache
     * @returns Valor do cache ou null
     */
    async get(key) {
        const startTime = Date.now();
        try {
            // L1 Cache (Memória Local)
            const l1Result = this.getFromL1(key);
            if (l1Result !== null) {
                this.metrics.l1Hits++;
                this.logger.debug(`L1 Cache HIT para '${key}' em ${Date.now() - startTime}ms`);
                return l1Result;
            }
            this.metrics.l1Misses++;
            // L2 Cache (Redis) - apenas se habilitado e disponível
            if (this.enableL2Cache && await this.isL2Available()) {
                const l2Result = await this.getFromL2(key);
                if (l2Result !== null) {
                    this.metrics.l2Hits++;
                    // Promover para L1 Cache
                    this.setToL1(key, l2Result, this.defaultTtl, 'medium');
                    this.logger.debug(`L2 Cache HIT para '${key}' em ${Date.now() - startTime}ms`);
                    return l2Result;
                }
                this.metrics.l2Misses++;
            }
            this.logger.debug(`Cache MISS para '${key}' em ${Date.now() - startTime}ms`);
            return null;
        }
        catch (error) {
            this.logger.error(`Erro ao obter cache para '${key}': ${error.message}`);
            return null;
        }
    }
    /**
     * Define valor no cache com estratégia híbrida
     *
     * @param key Chave do cache
     * @param value Valor a ser armazenado
     * @param ttl TTL em milissegundos (opcional)
     * @param priority Prioridade do cache (opcional)
     */
    async set(key, value, ttl = this.defaultTtl, priority = 'medium') {
        try {
            // Sempre armazenar no L1 Cache
            this.setToL1(key, value, ttl, priority);
            // Armazenar no L2 Cache se disponível
            if (this.enableL2Cache && await this.isL2Available()) {
                await this.setToL2(key, value, ttl);
            }
            this.logger.debug(`Cache SET para '${key}' com TTL ${ttl}ms e prioridade ${priority}`);
        }
        catch (error) {
            this.logger.error(`Erro ao definir cache para '${key}': ${error.message}`);
            // Não propagar erro - cache não deve quebrar a aplicação
        }
    }
    /**
     * Remove valor do cache
     */
    async del(key) {
        try {
            // Remover do L1 Cache
            this.l1Cache.delete(key);
            // Remover do L2 Cache se disponível
            if (this.enableL2Cache && await this.isL2Available()) {
                await this.cacheService.del(key);
            }
            this.logger.debug(`Cache DEL para '${key}'`);
        }
        catch (error) {
            this.logger.error(`Erro ao remover cache para '${key}': ${error.message}`);
        }
    }
    /**
     * Verifica se uma chave existe no cache
     */
    async has(key) {
        try {
            // Verificar L1 Cache
            if (this.hasInL1(key)) {
                return true;
            }
            // Verificar L2 Cache se disponível
            if (this.enableL2Cache && await this.isL2Available()) {
                return await this.cacheService.has(key);
            }
            return false;
        }
        catch (error) {
            this.logger.error(`Erro ao verificar cache para '${key}': ${error.message}`);
            return false;
        }
    }
    /**
     * Obtém ou define valor no cache com prevenção de cache stampede
     *
     * @param key Chave do cache
     * @param factory Função para gerar o valor se não estiver em cache
     * @param ttl TTL em milissegundos
     * @param priority Prioridade do cache
     */
    async getOrSet(key, factory, ttl = this.defaultTtl, priority = 'medium') {
        // Verificar se já existe no cache
        const cached = await this.get(key);
        if (cached !== null) {
            return cached;
        }
        // Prevenção de cache stampede
        const pendingKey = `pending:${key}`;
        if (this.pendingOperations.has(pendingKey)) {
            this.logger.debug(`Aguardando operação pendente para '${key}'`);
            return await this.pendingOperations.get(pendingKey);
        }
        // Criar nova operação
        const operation = this.executeFactory(key, factory, ttl, priority);
        this.pendingOperations.set(pendingKey, operation);
        try {
            const result = await operation;
            return result;
        }
        finally {
            this.pendingOperations.delete(pendingKey);
        }
    }
    /**
     * Executa factory e armazena resultado no cache
     */
    async executeFactory(key, factory, ttl, priority) {
        try {
            const result = await factory();
            await this.set(key, result, ttl, priority);
            return result;
        }
        catch (error) {
            this.logger.error(`Erro ao executar factory para '${key}': ${error.message}`);
            throw error;
        }
    }
    /**
     * Registra chave crítica para cache warming
     */
    registerCriticalKey(key, factory) {
        this.criticalKeys.add(key);
        this.warmingCallbacks.set(key, factory);
        this.logger.debug(`Chave crítica registrada: ${key}`);
    }
    /**
     * Remove chave crítica
     */
    unregisterCriticalKey(key) {
        this.criticalKeys.delete(key);
        this.warmingCallbacks.delete(key);
        this.logger.debug(`Chave crítica removida: ${key}`);
    }
    /**
     * Job de cache warming - executa periodicamente
     */
    async performCacheWarming() {
        if (!this.enableCacheWarming || this.criticalKeys.size === 0) {
            return;
        }
        this.logger.debug('Iniciando cache warming');
        let warmedCount = 0;
        for (const key of this.criticalKeys) {
            try {
                const factory = this.warmingCallbacks.get(key);
                if (!factory) {
                    continue;
                }
                // Verificar se precisa de warming (não existe ou está próximo do vencimento)
                const needsWarming = await this.needsCacheWarming(key);
                if (needsWarming) {
                    await this.getOrSet(key, factory, this.defaultTtl * 2, 'critical'); // TTL maior para chaves críticas
                    warmedCount++;
                    this.metrics.warmingOperations++;
                }
            }
            catch (error) {
                this.logger.warn(`Erro no cache warming para '${key}': ${error.message}`);
            }
        }
        if (warmedCount > 0) {
            this.logger.debug(`Cache warming concluído: ${warmedCount} chaves aquecidas`);
        }
    }
    /**
     * Verifica se uma chave precisa de cache warming
     */
    async needsCacheWarming(key) {
        const entry = this.l1Cache.get(key);
        if (!entry) {
            return true; // Não existe, precisa de warming
        }
        const now = Date.now();
        const timeToExpire = (entry.createdAt + entry.ttl) - now;
        const warmingThreshold = entry.ttl * 0.2; // 20% do TTL
        return timeToExpire <= warmingThreshold;
    }
    /**
     * Limpa cache expirado - executa periodicamente
     */
    async cleanupExpiredCache() {
        const now = Date.now();
        let cleanedCount = 0;
        for (const [key, entry] of this.l1Cache.entries()) {
            if (now > entry.createdAt + entry.ttl) {
                this.l1Cache.delete(key);
                cleanedCount++;
            }
        }
        if (cleanedCount > 0) {
            this.logger.debug(`Limpeza de cache: ${cleanedCount} entradas removidas`);
        }
    }
    // Métodos privados para L1 Cache
    getFromL1(key) {
        const entry = this.l1Cache.get(key);
        if (!entry) {
            return null;
        }
        const now = Date.now();
        // Verificar se expirou
        if (now > entry.createdAt + entry.ttl) {
            this.l1Cache.delete(key);
            return null;
        }
        // Atualizar estatísticas de acesso
        entry.accessCount++;
        entry.lastAccessed = now;
        return entry.value;
    }
    setToL1(key, value, ttl, priority) {
        // Verificar se precisa fazer eviction
        if (this.l1Cache.size >= this.maxL1Size) {
            this.evictL1Cache();
        }
        const now = Date.now();
        this.l1Cache.set(key, {
            value,
            ttl,
            createdAt: now,
            accessCount: 0,
            lastAccessed: now,
            priority
        });
    }
    hasInL1(key) {
        const entry = this.l1Cache.get(key);
        if (!entry) {
            return false;
        }
        const now = Date.now();
        // Verificar se expirou
        if (now > entry.createdAt + entry.ttl) {
            this.l1Cache.delete(key);
            return false;
        }
        return true;
    }
    /**
     * Algoritmo de eviction LRU com prioridades
     */
    evictL1Cache() {
        const priorityOrder = ['low', 'medium', 'high', 'critical'];
        for (const priority of priorityOrder) {
            const candidates = Array.from(this.l1Cache.entries())
                .filter(([_, entry]) => entry.priority === priority)
                .sort((a, b) => a[1].lastAccessed - b[1].lastAccessed); // LRU
            if (candidates.length > 0) {
                const [keyToEvict] = candidates[0];
                this.l1Cache.delete(keyToEvict);
                this.metrics.evictions++;
                this.logger.debug(`Cache eviction: removida chave '${keyToEvict}' com prioridade ${priority}`);
                return;
            }
        }
    }
    // Métodos privados para L2 Cache
    async getFromL2(key) {
        try {
            return await this.cacheService.get(key);
        }
        catch (error) {
            this.logger.warn(`Erro ao acessar L2 Cache para '${key}': ${error.message}`);
            this.metrics.failovers++;
            return null;
        }
    }
    async setToL2(key, value, ttl) {
        try {
            await this.cacheService.set(key, value, ttl);
        }
        catch (error) {
            this.logger.warn(`Erro ao definir L2 Cache para '${key}': ${error.message}`);
            this.metrics.failovers++;
        }
    }
    async isL2Available() {
        try {
            return await this.healthCheckService.isRedisAvailable();
        }
        catch {
            return false;
        }
    }
    /**
     * Retorna métricas detalhadas do cache
     */
    getMetrics() {
        const totalL1Operations = this.metrics.l1Hits + this.metrics.l1Misses;
        const totalL2Operations = this.metrics.l2Hits + this.metrics.l2Misses;
        return {
            ...this.metrics,
            l1Size: this.l1Cache.size,
            l1MaxSize: this.maxL1Size,
            l1HitRate: totalL1Operations > 0 ? (this.metrics.l1Hits / totalL1Operations) * 100 : 0,
            l2HitRate: totalL2Operations > 0 ? (this.metrics.l2Hits / totalL2Operations) * 100 : 0,
            overallHitRate: (totalL1Operations + totalL2Operations) > 0
                ? ((this.metrics.l1Hits + this.metrics.l2Hits) / (totalL1Operations + totalL2Operations)) * 100
                : 0,
            criticalKeysCount: this.criticalKeys.size,
            pendingOperations: this.pendingOperations.size
        };
    }
    /**
     * Reseta métricas (útil para testes)
     */
    resetMetrics() {
        this.metrics = {
            l1Hits: 0,
            l1Misses: 0,
            l2Hits: 0,
            l2Misses: 0,
            evictions: 0,
            warmingOperations: 0,
            failovers: 0
        };
    }
    /**
     * Limpa todo o cache (útil para testes)
     */
    async clear() {
        this.l1Cache.clear();
        if (this.enableL2Cache && await this.isL2Available()) {
            try {
                // Implementar clear no CacheService se necessário
                this.logger.debug('L2 Cache cleared');
            }
            catch (error) {
                this.logger.warn(`Erro ao limpar L2 Cache: ${error.message}`);
            }
        }
        this.logger.debug('Cache híbrido limpo');
    }
};
exports.HybridCacheService = HybridCacheService;
__decorate([
    (0, schedule_1.Cron)('0 * * * * *') // A cada minuto
    ,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_d = typeof Promise !== "undefined" && Promise) === "function" ? _d : Object)
], HybridCacheService.prototype, "performCacheWarming", null);
__decorate([
    (0, schedule_1.Cron)('0 */5 * * * *') // A cada 5 minutos
    ,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_e = typeof Promise !== "undefined" && Promise) === "function" ? _e : Object)
], HybridCacheService.prototype, "cleanupExpiredCache", null);
exports.HybridCacheService = HybridCacheService = HybridCacheService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof health_check_service_1.HealthCheckService !== "undefined" && health_check_service_1.HealthCheckService) === "function" ? _b : Object, typeof (_c = typeof cache_service_1.CacheService !== "undefined" && cache_service_1.CacheService) === "function" ? _c : Object])
], HybridCacheService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcc2VydmljZXNcXGh5YnJpZC1jYWNoZS5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWtFO0FBQ2xFLDJDQUErQztBQUMvQywrQ0FBd0M7QUFDeEMsaUVBQTREO0FBQzVELDBEQUFzRDtBQXFCdEQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FzQkc7QUFFSSxJQUFNLGtCQUFrQiwwQkFBeEIsTUFBTSxrQkFBa0I7SUFnQ1Y7SUFDQTtJQUNBO0lBakNGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxvQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU5RCwyQkFBMkI7SUFDVixPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7SUFDeEMsU0FBUyxDQUFTO0lBQ2xCLFVBQVUsQ0FBUztJQUVwQyxnQkFBZ0I7SUFDQyxhQUFhLENBQVU7SUFDdkIsa0JBQWtCLENBQVU7SUFDNUIsZUFBZSxDQUFTO0lBRXpDLFdBQVc7SUFDSCxPQUFPLEdBQWlCO1FBQzlCLE1BQU0sRUFBRSxDQUFDO1FBQ1QsUUFBUSxFQUFFLENBQUM7UUFDWCxNQUFNLEVBQUUsQ0FBQztRQUNULFFBQVEsRUFBRSxDQUFDO1FBQ1gsU0FBUyxFQUFFLENBQUM7UUFDWixpQkFBaUIsRUFBRSxDQUFDO1FBQ3BCLFNBQVMsRUFBRSxDQUFDO0tBQ2IsQ0FBQztJQUVGLGtFQUFrRTtJQUNqRCxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztJQUNqQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBOEIsQ0FBQztJQUUxRSw4QkFBOEI7SUFDYixpQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztJQUVyRSxZQUNtQixhQUE0QixFQUM1QixrQkFBc0MsRUFDdEMsWUFBMEI7UUFGMUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsdUJB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QUFTLEVBQUUsQ0FBQztTQUNiLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsS0FBSztRQUNULElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFckIsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLE1BQU0sSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUM7WUFDckQsSUFBSSxDQUFDO2dCQUNILGtEQUFrRDtnQkFDbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUN4QyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDaEUsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQzNDLENBQUM7Q0FDRixDQUFBO0FBNWZZLGdEQUFrQjtBQTRRdkI7SUFETCxJQUFBLGVBQUksRUFBQyxhQUFhLENBQUMsQ0FBQyxnQkFBZ0I7Ozs7d0RBQ1IsT0FBTyxvQkFBUCxPQUFPOzZEQWlDbkM7QUF1Qks7SUFETCxJQUFBLGVBQUksRUFBQyxlQUFlLENBQUMsQ0FBQyxtQkFBbUI7Ozs7d0RBQ2IsT0FBTyxvQkFBUCxPQUFPOzZEQWNuQzs2QkFsVlUsa0JBQWtCO0lBRDlCLElBQUEsbUJBQVUsR0FBRTt5REFpQ3VCLHNCQUFhLG9CQUFiLHNCQUFhLG9EQUNSLHlDQUFrQixvQkFBbEIseUNBQWtCLG9EQUN4Qiw0QkFBWSxvQkFBWiw0QkFBWTtHQWxDbEMsa0JBQWtCLENBNGY5QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcc2hhcmVkXFxzZXJ2aWNlc1xcaHlicmlkLWNhY2hlLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyLCBPbk1vZHVsZUluaXQgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgQ3JvbiB9IGZyb20gJ0BuZXN0anMvc2NoZWR1bGUnO1xuaW1wb3J0IHsgSGVhbHRoQ2hlY2tTZXJ2aWNlIH0gZnJvbSAnLi9oZWFsdGgtY2hlY2suc2VydmljZSc7XG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICcuLi9jYWNoZS9jYWNoZS5zZXJ2aWNlJztcblxuaW50ZXJmYWNlIENhY2hlRW50cnkge1xuICB2YWx1ZTogYW55O1xuICB0dGw6IG51bWJlcjtcbiAgY3JlYXRlZEF0OiBudW1iZXI7XG4gIGFjY2Vzc0NvdW50OiBudW1iZXI7XG4gIGxhc3RBY2Nlc3NlZDogbnVtYmVyO1xuICBwcmlvcml0eTogJ2xvdycgfCAnbWVkaXVtJyB8ICdoaWdoJyB8ICdjcml0aWNhbCc7XG59XG5cbmludGVyZmFjZSBDYWNoZU1ldHJpY3Mge1xuICBsMUhpdHM6IG51bWJlcjtcbiAgbDFNaXNzZXM6IG51bWJlcjtcbiAgbDJIaXRzOiBudW1iZXI7XG4gIGwyTWlzc2VzOiBudW1iZXI7XG4gIGV2aWN0aW9uczogbnVtYmVyO1xuICB3YXJtaW5nT3BlcmF0aW9uczogbnVtYmVyO1xuICBmYWlsb3ZlcnM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBTZXJ2acOnbyBkZSBDYWNoZSBIw61icmlkbyBSZXNpbGllbnRlXG4gKiBcbiAqIEltcGxlbWVudGEgdW0gc2lzdGVtYSBkZSBjYWNoZSBlbSBtw7psdGlwbGFzIGNhbWFkYXMgY29tIGVzdHJhdMOpZ2lhcyBkZSByZXNpbGnDqm5jaWE6XG4gKiBcbiAqIEwxIENhY2hlIChNZW3Ds3JpYSBMb2NhbCk6XG4gKiAtIENhY2hlIGVtIG1lbcOzcmlhIHVsdHJhLXLDoXBpZG9cbiAqIC0gTGltaXRhZG8gcG9yIHRhbWFuaG8gY29uZmlndXLDoXZlbFxuICogLSBBbGdvcml0bW8gTFJVIGNvbSBwcmlvcmlkYWRlc1xuICogLSBTZW1wcmUgZGlzcG9uw612ZWxcbiAqIFxuICogTDIgQ2FjaGUgKFJlZGlzKTpcbiAqIC0gQ2FjaGUgZGlzdHJpYnXDrWRvIHBlcnNpc3RlbnRlXG4gKiAtIENvbXBhcnRpbGhhZG8gZW50cmUgaW5zdMOibmNpYXNcbiAqIC0gRmFsbGJhY2sgYXV0b23DoXRpY28gcGFyYSBMMSBlbSBjYXNvIGRlIGZhbGhhXG4gKiAtIENpcmN1aXQgYnJlYWtlciBpbnRlZ3JhZG9cbiAqIFxuICogRnVuY2lvbmFsaWRhZGVzIGRlIFJlc2lsacOqbmNpYTpcbiAqIC0gQ2FjaGUgd2FybWluZyBhdXRvbcOhdGljb1xuICogLSBQcmV2ZW7Dp8OjbyBkZSBjYWNoZSBzdGFtcGVkZVxuICogLSBNw6l0cmljYXMgZGV0YWxoYWRhc1xuICogLSBSZWN1cGVyYcOnw6NvIGF1dG9tw6F0aWNhXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBIeWJyaWRDYWNoZVNlcnZpY2UgaW1wbGVtZW50cyBPbk1vZHVsZUluaXQge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoSHlicmlkQ2FjaGVTZXJ2aWNlLm5hbWUpO1xuICBcbiAgLy8gTDEgQ2FjaGUgKE1lbcOzcmlhIExvY2FsKVxuICBwcml2YXRlIHJlYWRvbmx5IGwxQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgQ2FjaGVFbnRyeT4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhMMVNpemU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0VHRsOiBudW1iZXI7XG4gIFxuICAvLyBDb25maWd1cmHDp8O1ZXNcbiAgcHJpdmF0ZSByZWFkb25seSBlbmFibGVMMkNhY2hlOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IGVuYWJsZUNhY2hlV2FybWluZzogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSB3YXJtaW5nSW50ZXJ2YWw6IG51bWJlcjtcbiAgXG4gIC8vIE3DqXRyaWNhc1xuICBwcml2YXRlIG1ldHJpY3M6IENhY2hlTWV0cmljcyA9IHtcbiAgICBsMUhpdHM6IDAsXG4gICAgbDFNaXNzZXM6IDAsXG4gICAgbDJIaXRzOiAwLFxuICAgIGwyTWlzc2VzOiAwLFxuICAgIGV2aWN0aW9uczogMCxcbiAgICB3YXJtaW5nT3BlcmF0aW9uczogMCxcbiAgICBmYWlsb3ZlcnM6IDBcbiAgfTtcbiAgXG4gIC8vIENhY2hlIHdhcm1pbmcgLSBjaGF2ZXMgY3LDrXRpY2FzIHF1ZSBkZXZlbSBlc3RhciBzZW1wcmUgZW0gY2FjaGVcbiAgcHJpdmF0ZSByZWFkb25seSBjcml0aWNhbEtleXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSB3YXJtaW5nQ2FsbGJhY2tzID0gbmV3IE1hcDxzdHJpbmcsICgpID0+IFByb21pc2U8YW55Pj4oKTtcbiAgXG4gIC8vIFByZXZlbsOnw6NvIGRlIGNhY2hlIHN0YW1wZWRlXG4gIHByaXZhdGUgcmVhZG9ubHkgcGVuZGluZ09wZXJhdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgUHJvbWlzZTxhbnk+PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGhlYWx0aENoZWNrU2VydmljZTogSGVhbHRoQ2hlY2tTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5tYXhMMVNpemUgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0KCdDQUNIRV9MMV9NQVhfU0laRScsIDEwMDApO1xuICAgIHRoaXMuZGVmYXVsdFR0bCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQoJ0NBQ0hFX0RFRkFVTFRfVFRMJywgMzAwMDAwKTsgLy8gNSBtaW51dG9zXG4gICAgdGhpcy5lbmFibGVMMkNhY2hlID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldCgnQ0FDSEVfRU5BQkxFX0wyJywgJ3RydWUnKSA9PT0gJ3RydWUnO1xuICAgIHRoaXMuZW5hYmxlQ2FjaGVXYXJtaW5nID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldCgnQ0FDSEVfRU5BQkxFX1dBUk1JTkcnLCAndHJ1ZScpID09PSAndHJ1ZSc7XG4gICAgdGhpcy53YXJtaW5nSW50ZXJ2YWwgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0KCdDQUNIRV9XQVJNSU5HX0lOVEVSVkFMJywgNjAwMDApOyAvLyAxIG1pbnV0b1xuICB9XG5cbiAgYXN5bmMgb25Nb2R1bGVJbml0KCkge1xuICAgIHRoaXMubG9nZ2VyLmxvZygnSW5pY2lhbGl6YW5kbyBIeWJyaWQgQ2FjaGUgU2VydmljZScpO1xuICAgIFxuICAgIC8vIFRFTVBPUsOBUklPOiBEZXNhYmlsaXRhbmRvIGluaWNpYWxpemHDp8OjbyBwYXJhIGV2aXRhciB0cmF2YW1lbnRvXG4gICAgdGhpcy5sb2dnZXIud2Fybign4pqg77iPIEluaWNpYWxpemHDp8OjbyBkbyBIeWJyaWRDYWNoZVNlcnZpY2UgZGVzYWJpbGl0YWRhIHRlbXBvcmFyaWFtZW50ZScpO1xuICAgIFxuICAgIC8vIFRPRE86IFJlYWJpbGl0YXIgYXDDs3MgcmVzb2x2ZXIgcHJvYmxlbWFzIGRlIGNvbmVjdGl2aWRhZGUgY29tIFJlZGlzXG4gICAgLypcbiAgICBpZiAodGhpcy5lbmFibGVDYWNoZVdhcm1pbmcpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnQ2FjaGUgd2FybWluZyBoYWJpbGl0YWRvJyk7XG4gICAgfVxuICAgIFxuICAgIC8vIFJlZ2lzdHJhciBjaGF2ZXMgY3LDrXRpY2FzIHBhZHLDo29cbiAgICB0aGlzLnJlZ2lzdGVyQ3JpdGljYWxLZXkoJ3N5c3RlbTpjb25maWcnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBFeGVtcGxvOiBjYXJyZWdhciBjb25maWd1cmHDp8O1ZXMgZG8gc2lzdGVtYVxuICAgICAgcmV0dXJuIHsgbG9hZGVkOiB0cnVlLCB0aW1lc3RhbXA6IERhdGUubm93KCkgfTtcbiAgICB9KTtcbiAgICAqL1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSB2YWxvciBkbyBjYWNoZSBjb20gZXN0cmF0w6lnaWEgaMOtYnJpZGFcbiAgICogXG4gICAqIEZsdXhvOlxuICAgKiAxLiBWZXJpZmljYSBMMSBDYWNoZSAobWVtw7NyaWEgbG9jYWwpXG4gICAqIDIuIFNlIG7Do28gZW5jb250cmFyLCB2ZXJpZmljYSBMMiBDYWNoZSAoUmVkaXMpXG4gICAqIDMuIFNlIGVuY29udHJhciBubyBMMiwgcHJvbW92ZSBwYXJhIEwxXG4gICAqIDQuIFNlIG7Do28gZW5jb250cmFyIGVtIG5lbmh1bSwgcmV0b3JuYSBudWxsXG4gICAqIFxuICAgKiBAcGFyYW0ga2V5IENoYXZlIGRvIGNhY2hlXG4gICAqIEByZXR1cm5zIFZhbG9yIGRvIGNhY2hlIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGdldDxUID0gYW55PihrZXk6IHN0cmluZyk6IFByb21pc2U8VCB8IG51bGw+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBMMSBDYWNoZSAoTWVtw7NyaWEgTG9jYWwpXG4gICAgICBjb25zdCBsMVJlc3VsdCA9IHRoaXMuZ2V0RnJvbUwxPFQ+KGtleSk7XG4gICAgICBpZiAobDFSZXN1bHQgIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5tZXRyaWNzLmwxSGl0cysrO1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgTDEgQ2FjaGUgSElUIHBhcmEgJyR7a2V5fScgZW0gJHtEYXRlLm5vdygpIC0gc3RhcnRUaW1lfW1zYCk7XG4gICAgICAgIHJldHVybiBsMVJlc3VsdDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdGhpcy5tZXRyaWNzLmwxTWlzc2VzKys7XG4gICAgICBcbiAgICAgIC8vIEwyIENhY2hlIChSZWRpcykgLSBhcGVuYXMgc2UgaGFiaWxpdGFkbyBlIGRpc3BvbsOtdmVsXG4gICAgICBpZiAodGhpcy5lbmFibGVMMkNhY2hlICYmIGF3YWl0IHRoaXMuaXNMMkF2YWlsYWJsZSgpKSB7XG4gICAgICAgIGNvbnN0IGwyUmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRGcm9tTDI8VD4oa2V5KTtcbiAgICAgICAgaWYgKGwyUmVzdWx0ICE9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5tZXRyaWNzLmwySGl0cysrO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIFByb21vdmVyIHBhcmEgTDEgQ2FjaGVcbiAgICAgICAgICB0aGlzLnNldFRvTDEoa2V5LCBsMlJlc3VsdCwgdGhpcy5kZWZhdWx0VHRsLCAnbWVkaXVtJyk7XG4gICAgICAgICAgXG4gICAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEwyIENhY2hlIEhJVCBwYXJhICcke2tleX0nIGVtICR7RGF0ZS5ub3coKSAtIHN0YXJ0VGltZX1tc2ApO1xuICAgICAgICAgIHJldHVybiBsMlJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5tZXRyaWNzLmwyTWlzc2VzKys7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDYWNoZSBNSVNTIHBhcmEgJyR7a2V5fScgZW0gJHtEYXRlLm5vdygpIC0gc3RhcnRUaW1lfW1zYCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBhbyBvYnRlciBjYWNoZSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVmaW5lIHZhbG9yIG5vIGNhY2hlIGNvbSBlc3RyYXTDqWdpYSBow61icmlkYVxuICAgKiBcbiAgICogQHBhcmFtIGtleSBDaGF2ZSBkbyBjYWNoZVxuICAgKiBAcGFyYW0gdmFsdWUgVmFsb3IgYSBzZXIgYXJtYXplbmFkb1xuICAgKiBAcGFyYW0gdHRsIFRUTCBlbSBtaWxpc3NlZ3VuZG9zIChvcGNpb25hbClcbiAgICogQHBhcmFtIHByaW9yaXR5IFByaW9yaWRhZGUgZG8gY2FjaGUgKG9wY2lvbmFsKVxuICAgKi9cbiAgYXN5bmMgc2V0PFQgPSBhbnk+KFxuICAgIGtleTogc3RyaW5nLCBcbiAgICB2YWx1ZTogVCwgXG4gICAgdHRsOiBudW1iZXIgPSB0aGlzLmRlZmF1bHRUdGwsXG4gICAgcHJpb3JpdHk6ICdsb3cnIHwgJ21lZGl1bScgfCAnaGlnaCcgfCAnY3JpdGljYWwnID0gJ21lZGl1bSdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFNlbXByZSBhcm1hemVuYXIgbm8gTDEgQ2FjaGVcbiAgICAgIHRoaXMuc2V0VG9MMShrZXksIHZhbHVlLCB0dGwsIHByaW9yaXR5KTtcbiAgICAgIFxuICAgICAgLy8gQXJtYXplbmFyIG5vIEwyIENhY2hlIHNlIGRpc3BvbsOtdmVsXG4gICAgaWYgKHRoaXMuZW5hYmxlTDJDYWNoZSAmJiBhd2FpdCB0aGlzLmlzTDJBdmFpbGFibGUoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLnNldFRvTDIoa2V5LCB2YWx1ZSwgdHRsKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYENhY2hlIFNFVCBwYXJhICcke2tleX0nIGNvbSBUVEwgJHt0dGx9bXMgZSBwcmlvcmlkYWRlICR7cHJpb3JpdHl9YCk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gZGVmaW5pciBjYWNoZSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAvLyBOw6NvIHByb3BhZ2FyIGVycm8gLSBjYWNoZSBuw6NvIGRldmUgcXVlYnJhciBhIGFwbGljYcOnw6NvXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB2YWxvciBkbyBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZGVsKGtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFJlbW92ZXIgZG8gTDEgQ2FjaGVcbiAgICAgIHRoaXMubDFDYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgIFxuICAgICAgLy8gUmVtb3ZlciBkbyBMMiBDYWNoZSBzZSBkaXNwb27DrXZlbFxuICAgICAgaWYgKHRoaXMuZW5hYmxlTDJDYWNoZSAmJiBhd2FpdCB0aGlzLmlzTDJBdmFpbGFibGUoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5kZWwoa2V5KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYENhY2hlIERFTCBwYXJhICcke2tleX0nYCk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gcmVtb3ZlciBjYWNoZSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtYSBjaGF2ZSBleGlzdGUgbm8gY2FjaGVcbiAgICovXG4gIGFzeW5jIGhhcyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZmljYXIgTDEgQ2FjaGVcbiAgICAgIGlmICh0aGlzLmhhc0luTDEoa2V5KSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gVmVyaWZpY2FyIEwyIENhY2hlIHNlIGRpc3BvbsOtdmVsXG4gICAgICBpZiAodGhpcy5lbmFibGVMMkNhY2hlICYmIGF3YWl0IHRoaXMuaXNMMkF2YWlsYWJsZSgpKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5oYXMoa2V5KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIGFvIHZlcmlmaWNhciBjYWNoZSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBvdSBkZWZpbmUgdmFsb3Igbm8gY2FjaGUgY29tIHByZXZlbsOnw6NvIGRlIGNhY2hlIHN0YW1wZWRlXG4gICAqIFxuICAgKiBAcGFyYW0ga2V5IENoYXZlIGRvIGNhY2hlXG4gICAqIEBwYXJhbSBmYWN0b3J5IEZ1bsOnw6NvIHBhcmEgZ2VyYXIgbyB2YWxvciBzZSBuw6NvIGVzdGl2ZXIgZW0gY2FjaGVcbiAgICogQHBhcmFtIHR0bCBUVEwgZW0gbWlsaXNzZWd1bmRvc1xuICAgKiBAcGFyYW0gcHJpb3JpdHkgUHJpb3JpZGFkZSBkbyBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZ2V0T3JTZXQ8VCA9IGFueT4oXG4gICAga2V5OiBzdHJpbmcsXG4gICAgZmFjdG9yeTogKCkgPT4gUHJvbWlzZTxUPixcbiAgICB0dGw6IG51bWJlciA9IHRoaXMuZGVmYXVsdFR0bCxcbiAgICBwcmlvcml0eTogJ2xvdycgfCAnbWVkaXVtJyB8ICdoaWdoJyB8ICdjcml0aWNhbCcgPSAnbWVkaXVtJ1xuICApOiBQcm9taXNlPFQ+IHtcbiAgICAvLyBWZXJpZmljYXIgc2UgasOhIGV4aXN0ZSBubyBjYWNoZVxuICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHRoaXMuZ2V0PFQ+KGtleSk7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG4gICAgXG4gICAgLy8gUHJldmVuw6fDo28gZGUgY2FjaGUgc3RhbXBlZGVcbiAgICBjb25zdCBwZW5kaW5nS2V5ID0gYHBlbmRpbmc6JHtrZXl9YDtcbiAgICBpZiAodGhpcy5wZW5kaW5nT3BlcmF0aW9ucy5oYXMocGVuZGluZ0tleSkpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBBZ3VhcmRhbmRvIG9wZXJhw6fDo28gcGVuZGVudGUgcGFyYSAnJHtrZXl9J2ApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucGVuZGluZ09wZXJhdGlvbnMuZ2V0KHBlbmRpbmdLZXkpO1xuICAgIH1cbiAgICBcbiAgICAvLyBDcmlhciBub3ZhIG9wZXJhw6fDo29cbiAgICBjb25zdCBvcGVyYXRpb24gPSB0aGlzLmV4ZWN1dGVGYWN0b3J5KGtleSwgZmFjdG9yeSwgdHRsLCBwcmlvcml0eSk7XG4gICAgdGhpcy5wZW5kaW5nT3BlcmF0aW9ucy5zZXQocGVuZGluZ0tleSwgb3BlcmF0aW9uKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgb3BlcmF0aW9uO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5wZW5kaW5nT3BlcmF0aW9ucy5kZWxldGUocGVuZGluZ0tleSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGEgZmFjdG9yeSBlIGFybWF6ZW5hIHJlc3VsdGFkbyBubyBjYWNoZVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlRmFjdG9yeTxUPihcbiAgICBrZXk6IHN0cmluZyxcbiAgICBmYWN0b3J5OiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIHR0bDogbnVtYmVyLFxuICAgIHByaW9yaXR5OiAnbG93JyB8ICdtZWRpdW0nIHwgJ2hpZ2gnIHwgJ2NyaXRpY2FsJ1xuICApOiBQcm9taXNlPFQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmFjdG9yeSgpO1xuICAgICAgYXdhaXQgdGhpcy5zZXQoa2V5LCByZXN1bHQsIHR0bCwgcHJpb3JpdHkpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gZXhlY3V0YXIgZmFjdG9yeSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0cmEgY2hhdmUgY3LDrXRpY2EgcGFyYSBjYWNoZSB3YXJtaW5nXG4gICAqL1xuICByZWdpc3RlckNyaXRpY2FsS2V5KGtleTogc3RyaW5nLCBmYWN0b3J5OiAoKSA9PiBQcm9taXNlPGFueT4pOiB2b2lkIHtcbiAgICB0aGlzLmNyaXRpY2FsS2V5cy5hZGQoa2V5KTtcbiAgICB0aGlzLndhcm1pbmdDYWxsYmFja3Muc2V0KGtleSwgZmFjdG9yeSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYENoYXZlIGNyw610aWNhIHJlZ2lzdHJhZGE6ICR7a2V5fWApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBjaGF2ZSBjcsOtdGljYVxuICAgKi9cbiAgdW5yZWdpc3RlckNyaXRpY2FsS2V5KGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5jcml0aWNhbEtleXMuZGVsZXRlKGtleSk7XG4gICAgdGhpcy53YXJtaW5nQ2FsbGJhY2tzLmRlbGV0ZShrZXkpO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDaGF2ZSBjcsOtdGljYSByZW1vdmlkYTogJHtrZXl9YCk7XG4gIH1cblxuICAvKipcbiAgICogSm9iIGRlIGNhY2hlIHdhcm1pbmcgLSBleGVjdXRhIHBlcmlvZGljYW1lbnRlXG4gICAqL1xuICBAQ3JvbignMCAqICogKiAqIConKSAvLyBBIGNhZGEgbWludXRvXG4gIGFzeW5jIHBlcmZvcm1DYWNoZVdhcm1pbmcoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZUNhY2hlV2FybWluZyB8fCB0aGlzLmNyaXRpY2FsS2V5cy5zaXplID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdJbmljaWFuZG8gY2FjaGUgd2FybWluZycpO1xuICAgIFxuICAgIGxldCB3YXJtZWRDb3VudCA9IDA7XG4gICAgXG4gICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5jcml0aWNhbEtleXMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLndhcm1pbmdDYWxsYmFja3MuZ2V0KGtleSk7XG4gICAgICAgIGlmICghZmFjdG9yeSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgcHJlY2lzYSBkZSB3YXJtaW5nIChuw6NvIGV4aXN0ZSBvdSBlc3TDoSBwcsOzeGltbyBkbyB2ZW5jaW1lbnRvKVxuICAgICAgICBjb25zdCBuZWVkc1dhcm1pbmcgPSBhd2FpdCB0aGlzLm5lZWRzQ2FjaGVXYXJtaW5nKGtleSk7XG4gICAgICAgIFxuICAgICAgICBpZiAobmVlZHNXYXJtaW5nKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5nZXRPclNldChrZXksIGZhY3RvcnksIHRoaXMuZGVmYXVsdFR0bCAqIDIsICdjcml0aWNhbCcpOyAvLyBUVEwgbWFpb3IgcGFyYSBjaGF2ZXMgY3LDrXRpY2FzXG4gICAgICAgICAgd2FybWVkQ291bnQrKztcbiAgICAgICAgICB0aGlzLm1ldHJpY3Mud2FybWluZ09wZXJhdGlvbnMrKztcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEVycm8gbm8gY2FjaGUgd2FybWluZyBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGlmICh3YXJtZWRDb3VudCA+IDApIHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDYWNoZSB3YXJtaW5nIGNvbmNsdcOtZG86ICR7d2FybWVkQ291bnR9IGNoYXZlcyBhcXVlY2lkYXNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgdW1hIGNoYXZlIHByZWNpc2EgZGUgY2FjaGUgd2FybWluZ1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBuZWVkc0NhY2hlV2FybWluZyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5sMUNhY2hlLmdldChrZXkpO1xuICAgIFxuICAgIGlmICghZW50cnkpIHtcbiAgICAgIHJldHVybiB0cnVlOyAvLyBOw6NvIGV4aXN0ZSwgcHJlY2lzYSBkZSB3YXJtaW5nXG4gICAgfVxuICAgIFxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgdGltZVRvRXhwaXJlID0gKGVudHJ5LmNyZWF0ZWRBdCArIGVudHJ5LnR0bCkgLSBub3c7XG4gICAgY29uc3Qgd2FybWluZ1RocmVzaG9sZCA9IGVudHJ5LnR0bCAqIDAuMjsgLy8gMjAlIGRvIFRUTFxuICAgIFxuICAgIHJldHVybiB0aW1lVG9FeHBpcmUgPD0gd2FybWluZ1RocmVzaG9sZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaW1wYSBjYWNoZSBleHBpcmFkbyAtIGV4ZWN1dGEgcGVyaW9kaWNhbWVudGVcbiAgICovXG4gIEBDcm9uKCcwICovNSAqICogKiAqJykgLy8gQSBjYWRhIDUgbWludXRvc1xuICBhc3luYyBjbGVhbnVwRXhwaXJlZENhY2hlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgbGV0IGNsZWFuZWRDb3VudCA9IDA7XG4gICAgXG4gICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5sMUNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKG5vdyA+IGVudHJ5LmNyZWF0ZWRBdCArIGVudHJ5LnR0bCkge1xuICAgICAgICB0aGlzLmwxQ2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICAgIGNsZWFuZWRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBpZiAoY2xlYW5lZENvdW50ID4gMCkge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYExpbXBlemEgZGUgY2FjaGU6ICR7Y2xlYW5lZENvdW50fSBlbnRyYWRhcyByZW1vdmlkYXNgKTtcbiAgICB9XG4gIH1cblxuICAvLyBNw6l0b2RvcyBwcml2YWRvcyBwYXJhIEwxIENhY2hlXG4gIFxuICBwcml2YXRlIGdldEZyb21MMTxUPihrZXk6IHN0cmluZyk6IFQgfCBudWxsIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMubDFDYWNoZS5nZXQoa2V5KTtcbiAgICBcbiAgICBpZiAoIWVudHJ5KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBWZXJpZmljYXIgc2UgZXhwaXJvdVxuICAgIGlmIChub3cgPiBlbnRyeS5jcmVhdGVkQXQgKyBlbnRyeS50dGwpIHtcbiAgICAgIHRoaXMubDFDYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBcbiAgICAvLyBBdHVhbGl6YXIgZXN0YXTDrXN0aWNhcyBkZSBhY2Vzc29cbiAgICBlbnRyeS5hY2Nlc3NDb3VudCsrO1xuICAgIGVudHJ5Lmxhc3RBY2Nlc3NlZCA9IG5vdztcbiAgICBcbiAgICByZXR1cm4gZW50cnkudmFsdWU7XG4gIH1cbiAgXG4gIHByaXZhdGUgc2V0VG9MMTxUPihcbiAgICBrZXk6IHN0cmluZywgXG4gICAgdmFsdWU6IFQsIFxuICAgIHR0bDogbnVtYmVyLCBcbiAgICBwcmlvcml0eTogJ2xvdycgfCAnbWVkaXVtJyB8ICdoaWdoJyB8ICdjcml0aWNhbCdcbiAgKTogdm9pZCB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIHByZWNpc2EgZmF6ZXIgZXZpY3Rpb25cbiAgICBpZiAodGhpcy5sMUNhY2hlLnNpemUgPj0gdGhpcy5tYXhMMVNpemUpIHtcbiAgICAgIHRoaXMuZXZpY3RMMUNhY2hlKCk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdGhpcy5sMUNhY2hlLnNldChrZXksIHtcbiAgICAgIHZhbHVlLFxuICAgICAgdHRsLFxuICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICBhY2Nlc3NDb3VudDogMCxcbiAgICAgIGxhc3RBY2Nlc3NlZDogbm93LFxuICAgICAgcHJpb3JpdHlcbiAgICB9KTtcbiAgfVxuICBcbiAgcHJpdmF0ZSBoYXNJbkwxKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmwxQ2FjaGUuZ2V0KGtleSk7XG4gICAgXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIC8vIFZlcmlmaWNhciBzZSBleHBpcm91XG4gICAgaWYgKG5vdyA+IGVudHJ5LmNyZWF0ZWRBdCArIGVudHJ5LnR0bCkge1xuICAgICAgdGhpcy5sMUNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIEFsZ29yaXRtbyBkZSBldmljdGlvbiBMUlUgY29tIHByaW9yaWRhZGVzXG4gICAqL1xuICBwcml2YXRlIGV2aWN0TDFDYWNoZSgpOiB2b2lkIHtcbiAgICBjb25zdCBwcmlvcml0eU9yZGVyID0gWydsb3cnLCAnbWVkaXVtJywgJ2hpZ2gnLCAnY3JpdGljYWwnXTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IHByaW9yaXR5IG9mIHByaW9yaXR5T3JkZXIpIHtcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBBcnJheS5mcm9tKHRoaXMubDFDYWNoZS5lbnRyaWVzKCkpXG4gICAgICAgIC5maWx0ZXIoKFtfLCBlbnRyeV0pID0+IGVudHJ5LnByaW9yaXR5ID09PSBwcmlvcml0eSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IGFbMV0ubGFzdEFjY2Vzc2VkIC0gYlsxXS5sYXN0QWNjZXNzZWQpOyAvLyBMUlVcbiAgICAgIFxuICAgICAgaWYgKGNhbmRpZGF0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBba2V5VG9FdmljdF0gPSBjYW5kaWRhdGVzWzBdO1xuICAgICAgICB0aGlzLmwxQ2FjaGUuZGVsZXRlKGtleVRvRXZpY3QpO1xuICAgICAgICB0aGlzLm1ldHJpY3MuZXZpY3Rpb25zKys7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDYWNoZSBldmljdGlvbjogcmVtb3ZpZGEgY2hhdmUgJyR7a2V5VG9FdmljdH0nIGNvbSBwcmlvcmlkYWRlICR7cHJpb3JpdHl9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIC8vIE3DqXRvZG9zIHByaXZhZG9zIHBhcmEgTDIgQ2FjaGVcbiAgXG4gIHByaXZhdGUgYXN5bmMgZ2V0RnJvbUwyPFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0PFQ+KGtleSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEVycm8gYW8gYWNlc3NhciBMMiBDYWNoZSBwYXJhICcke2tleX0nOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB0aGlzLm1ldHJpY3MuZmFpbG92ZXJzKys7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgXG4gIHByaXZhdGUgYXN5bmMgc2V0VG9MMjxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChrZXksIHZhbHVlLCB0dGwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBFcnJvIGFvIGRlZmluaXIgTDIgQ2FjaGUgcGFyYSAnJHtrZXl9JzogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgdGhpcy5tZXRyaWNzLmZhaWxvdmVycysrO1xuICAgIH1cbiAgfVxuICBcbiAgcHJpdmF0ZSBhc3luYyBpc0wyQXZhaWxhYmxlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5oZWFsdGhDaGVja1NlcnZpY2UuaXNSZWRpc0F2YWlsYWJsZSgpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIG3DqXRyaWNhcyBkZXRhbGhhZGFzIGRvIGNhY2hlXG4gICAqL1xuICBnZXRNZXRyaWNzKCkge1xuICAgIGNvbnN0IHRvdGFsTDFPcGVyYXRpb25zID0gdGhpcy5tZXRyaWNzLmwxSGl0cyArIHRoaXMubWV0cmljcy5sMU1pc3NlcztcbiAgICBjb25zdCB0b3RhbEwyT3BlcmF0aW9ucyA9IHRoaXMubWV0cmljcy5sMkhpdHMgKyB0aGlzLm1ldHJpY3MubDJNaXNzZXM7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRoaXMubWV0cmljcyxcbiAgICAgIGwxU2l6ZTogdGhpcy5sMUNhY2hlLnNpemUsXG4gICAgICBsMU1heFNpemU6IHRoaXMubWF4TDFTaXplLFxuICAgICAgbDFIaXRSYXRlOiB0b3RhbEwxT3BlcmF0aW9ucyA+IDAgPyAodGhpcy5tZXRyaWNzLmwxSGl0cyAvIHRvdGFsTDFPcGVyYXRpb25zKSAqIDEwMCA6IDAsXG4gICAgICBsMkhpdFJhdGU6IHRvdGFsTDJPcGVyYXRpb25zID4gMCA/ICh0aGlzLm1ldHJpY3MubDJIaXRzIC8gdG90YWxMMk9wZXJhdGlvbnMpICogMTAwIDogMCxcbiAgICAgIG92ZXJhbGxIaXRSYXRlOiAodG90YWxMMU9wZXJhdGlvbnMgKyB0b3RhbEwyT3BlcmF0aW9ucykgPiAwIFxuICAgICAgICA/ICgodGhpcy5tZXRyaWNzLmwxSGl0cyArIHRoaXMubWV0cmljcy5sMkhpdHMpIC8gKHRvdGFsTDFPcGVyYXRpb25zICsgdG90YWxMMk9wZXJhdGlvbnMpKSAqIDEwMCBcbiAgICAgICAgOiAwLFxuICAgICAgY3JpdGljYWxLZXlzQ291bnQ6IHRoaXMuY3JpdGljYWxLZXlzLnNpemUsXG4gICAgICBwZW5kaW5nT3BlcmF0aW9uczogdGhpcy5wZW5kaW5nT3BlcmF0aW9ucy5zaXplXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldGEgbcOpdHJpY2FzICjDunRpbCBwYXJhIHRlc3RlcylcbiAgICovXG4gIHJlc2V0TWV0cmljcygpOiB2b2lkIHtcbiAgICB0aGlzLm1ldHJpY3MgPSB7XG4gICAgICBsMUhpdHM6IDAsXG4gICAgICBsMU1pc3NlczogMCxcbiAgICAgIGwySGl0czogMCxcbiAgICAgIGwyTWlzc2VzOiAwLFxuICAgICAgZXZpY3Rpb25zOiAwLFxuICAgICAgd2FybWluZ09wZXJhdGlvbnM6IDAsXG4gICAgICBmYWlsb3ZlcnM6IDBcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIExpbXBhIHRvZG8gbyBjYWNoZSAow7p0aWwgcGFyYSB0ZXN0ZXMpXG4gICAqL1xuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmwxQ2FjaGUuY2xlYXIoKTtcbiAgICBcbiAgICBpZiAodGhpcy5lbmFibGVMMkNhY2hlICYmIGF3YWl0IHRoaXMuaXNMMkF2YWlsYWJsZSgpKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBJbXBsZW1lbnRhciBjbGVhciBubyBDYWNoZVNlcnZpY2Ugc2UgbmVjZXNzw6FyaW9cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ0wyIENhY2hlIGNsZWFyZWQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEVycm8gYW8gbGltcGFyIEwyIENhY2hlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdDYWNoZSBow61icmlkbyBsaW1wbycpO1xuICB9XG59Il0sInZlcnNpb24iOjN9