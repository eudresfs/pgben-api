{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\metricas\\controllers\\metricas-anomalias.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\metricas\\controllers\\metricas-anomalias.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  Param,\n  Query,\n  UseGuards,\n  HttpStatus,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiParam,\n  ApiQuery,\n  ApiBearerAuth,\n} from '@nestjs/swagger';\n\nimport { MetricasAnomaliasService, NivelConfiancaAnomalia } from '../services';\nimport { JwtAuthGuard } from '../../../auth/guards/jwt-auth.guard';\nimport { RolesGuard } from '../../../auth/guards/roles.guard';\nimport { ROLES } from '../../../shared/constants/roles.constants';\nimport { Roles } from '../../../auth/decorators/role.decorator';\n\n/**\n * Controlador para detecção de anomalias e análise de tendências\n */\n@ApiTags('Métricas e Dashboard')\n@Controller('metricas/analise')\n@UseGuards(JwtAuthGuard, RolesGuard)\n@ApiBearerAuth()\nexport class MetricasAnomaliasController {\n  constructor(private readonly anomaliasService: MetricasAnomaliasService) {}\n\n  /**\n   * Detecta anomalias para um snapshot específico\n   */\n  @Post('anomalias/snapshot/:id')\n  @Roles(ROLES.ADMIN, ROLES.GESTOR, ROLES.COORDENADOR)\n  @ApiOperation({ summary: 'Detectar anomalias para um snapshot específico' })\n  @ApiParam({ name: 'id', description: 'ID do snapshot' })\n  @ApiQuery({\n    name: 'nivel_confianca',\n    description: 'Nível de confiança para detecção',\n    enum: NivelConfiancaAnomalia,\n    required: false,\n  })\n  @ApiQuery({\n    name: 'janela_temporal',\n    description: 'Número de dias a considerar para o histórico',\n    required: false,\n  })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Resultado da detecção de anomalias',\n  })\n  @ApiResponse({\n    status: HttpStatus.NOT_FOUND,\n    description: 'Snapshot não encontrado',\n  })\n  @ApiResponse({\n    status: HttpStatus.UNAUTHORIZED,\n    description: 'Não autorizado',\n  })\n  @ApiResponse({ status: HttpStatus.FORBIDDEN, description: 'Acesso negado' })\n  async detectarAnomalias(\n    @Param('id') id: string,\n    @Query('nivel_confianca') nivelConfianca?: NivelConfiancaAnomalia,\n    @Query('janela_temporal') janelaTemporal?: number,\n  ) {\n    return this.anomaliasService.detectarAnomaliasPorSnapshot(\n      id,\n      nivelConfianca || NivelConfiancaAnomalia.MEDIO,\n      janelaTemporal ? Number(janelaTemporal) : 30,\n    );\n  }\n\n  /**\n   * Executa detecção de anomalias em lote para todas as métricas\n   */\n  @Post('anomalias/batch')\n  @Roles(ROLES.ADMIN, ROLES.COORDENADOR)\n  @ApiOperation({\n    summary: 'Detectar anomalias em lote para todas as métricas',\n  })\n  @ApiQuery({\n    name: 'nivel_confianca',\n    description: 'Nível de confiança para detecção',\n    enum: NivelConfiancaAnomalia,\n    required: false,\n  })\n  @ApiQuery({\n    name: 'janela_temporal',\n    description: 'Número de dias a considerar para o histórico',\n    required: false,\n  })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Lista de anomalias detectadas',\n  })\n  @ApiResponse({\n    status: HttpStatus.UNAUTHORIZED,\n    description: 'Não autorizado',\n  })\n  @ApiResponse({ status: HttpStatus.FORBIDDEN, description: 'Acesso negado' })\n  async detectarAnomaliasBatch(\n    @Query('nivel_confianca') nivelConfianca?: NivelConfiancaAnomalia,\n    @Query('janela_temporal') janelaTemporal?: number,\n  ) {\n    return this.anomaliasService.detectarAnomaliasBatch(\n      janelaTemporal ? Number(janelaTemporal) : 7,\n      nivelConfianca || NivelConfiancaAnomalia.MEDIO,\n    );\n  }\n\n  /**\n   * Analisa tendências para uma métrica\n   */\n  @Post('tendencias/metrica/:id')\n  @Roles(ROLES.ADMIN, ROLES.GESTOR, ROLES.COORDENADOR)\n  @ApiOperation({ summary: 'Analisar tendências para uma métrica' })\n  @ApiParam({ name: 'id', description: 'ID da métrica' })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Resultado da análise de tendências',\n  })\n  @ApiResponse({\n    status: HttpStatus.NOT_FOUND,\n    description: 'Métrica não encontrada',\n  })\n  @ApiResponse({\n    status: HttpStatus.UNAUTHORIZED,\n    description: 'Não autorizado',\n  })\n  @ApiResponse({ status: HttpStatus.FORBIDDEN, description: 'Acesso negado' })\n  async analisarTendencias(\n    @Param('id') id: string,\n    @Body()\n    body: {\n      data_inicial: string;\n      data_final: string;\n      dimensoes?: Record<string, any>;\n    },\n  ) {\n    return this.anomaliasService.analisarTendencias(\n      id,\n      new Date(body.data_inicial),\n      new Date(body.data_final),\n      body.dimensoes || {},\n    );\n  }\n}\n"],"version":3}