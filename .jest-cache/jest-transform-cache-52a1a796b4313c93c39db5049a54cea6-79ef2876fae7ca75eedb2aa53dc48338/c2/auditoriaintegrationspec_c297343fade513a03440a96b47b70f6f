5f2ecb3d5a3e68b3b3dd4afc2b84f8ab
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const request = __importStar(require("supertest"));
const app_module_1 = require("../../src/app.module");
const typeorm_1 = require("@nestjs/typeorm");
const log_auditoria_entity_1 = require("../../src/modules/auditoria/entities/log-auditoria.entity");
const tipo_operacao_enum_1 = require("../../src/modules/auditoria/enums/tipo-operacao.enum");
const jwt_1 = require("@nestjs/jwt");
describe('Auditoria (Integração)', () => {
    let app;
    let logAuditoriaRepository;
    let jwtService;
    let authToken;
    beforeAll(async () => {
        const moduleFixture = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        }).compile();
        app = moduleFixture.createNestApplication();
        await app.init();
        logAuditoriaRepository = moduleFixture.get((0, typeorm_1.getRepositoryToken)(log_auditoria_entity_1.LogAuditoria));
        jwtService = moduleFixture.get(jwt_1.JwtService);
        // Gerar token de autenticação para testes
        authToken = jwtService.sign({
            id: 'test-user-id',
            nome: 'Usuário de Teste',
            email: 'teste@exemplo.com',
            roles: ['admin'],
        });
    });
    beforeEach(async () => {
        // Limpar logs de auditoria antes de cada teste
        await logAuditoriaRepository.clear();
    });
    afterAll(async () => {
        await app.close();
    });
    describe('Auditoria de operações CRUD', () => {
        it('deve registrar log ao criar um documento', async () => {
            // Arrange
            const documentoDto = {
                nome: 'Documento de Teste',
                tipo: 'PDF',
                solicitacao_id: '550e8400-e29b-41d4-a716-446655440000',
            };
            // Act
            await request(app.getHttpServer())
                .post('/api/documentos')
                .set('Authorization', `Bearer ${authToken}`)
                .send(documentoDto)
                .expect(201);
            // Assert
            const logs = await logAuditoriaRepository.find();
            expect(logs).toHaveLength(1);
            expect(logs[0].tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.CREATE);
            expect(logs[0].entidade_afetada).toBe('documentos');
            expect(logs[0].usuario_id).toBe('test-user-id');
            expect(logs[0].dados_novos).toEqual(expect.objectContaining(documentoDto));
        });
        it('deve registrar log ao consultar um documento', async () => {
            // Act
            await request(app.getHttpServer())
                .get('/api/documentos/documento-123')
                .set('Authorization', `Bearer ${authToken}`)
                .expect(200);
            // Assert
            const logs = await logAuditoriaRepository.find();
            expect(logs).toHaveLength(1);
            expect(logs[0].tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.READ);
            expect(logs[0].entidade_afetada).toBe('documentos');
            expect(logs[0].entidade_id).toBe('documento-123');
            expect(logs[0].usuario_id).toBe('test-user-id');
        });
        it('deve registrar log ao atualizar um documento', async () => {
            // Arrange
            const documentoDto = {
                nome: 'Documento Atualizado',
                tipo: 'DOCX',
            };
            // Act
            await request(app.getHttpServer())
                .put('/api/documentos/documento-123')
                .set('Authorization', `Bearer ${authToken}`)
                .send(documentoDto)
                .expect(200);
            // Assert
            const logs = await logAuditoriaRepository.find();
            expect(logs).toHaveLength(1);
            expect(logs[0].tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.UPDATE);
            expect(logs[0].entidade_afetada).toBe('documentos');
            expect(logs[0].entidade_id).toBe('documento-123');
            expect(logs[0].usuario_id).toBe('test-user-id');
            expect(logs[0].dados_novos).toEqual(expect.objectContaining(documentoDto));
        });
        it('deve registrar log ao excluir um documento', async () => {
            // Act
            await request(app.getHttpServer())
                .delete('/api/documentos/documento-123')
                .set('Authorization', `Bearer ${authToken}`)
                .expect(200);
            // Assert
            const logs = await logAuditoriaRepository.find();
            expect(logs).toHaveLength(1);
            expect(logs[0].tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.DELETE);
            expect(logs[0].entidade_afetada).toBe('documentos');
            expect(logs[0].entidade_id).toBe('documento-123');
            expect(logs[0].usuario_id).toBe('test-user-id');
        });
    });
    describe('API de Auditoria', () => {
        it('deve permitir consulta de logs de auditoria', async () => {
            // Arrange
            const log1 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Criação de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            const log2 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.UPDATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Atualização de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            await logAuditoriaRepository.save([log1, log2]);
            // Act
            const response = await request(app.getHttpServer())
                .get('/api/auditoria')
                .set('Authorization', `Bearer ${authToken}`)
                .query({ entidade_afetada: 'documentos' })
                .expect(200);
            // Assert
            expect(response.body.data).toHaveLength(2);
            expect(response.body.total).toBe(2);
        });
        it('deve permitir consulta de logs por tipo de operação', async () => {
            // Arrange
            const log1 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Criação de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            const log2 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.UPDATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Atualização de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            await logAuditoriaRepository.save([log1, log2]);
            // Act
            const response = await request(app.getHttpServer())
                .get('/api/auditoria')
                .set('Authorization', `Bearer ${authToken}`)
                .query({ tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE })
                .expect(200);
            // Assert
            expect(response.body.data).toHaveLength(1);
            expect(response.body.data[0].tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.CREATE);
        });
        it('deve permitir geração de relatório de auditoria', async () => {
            // Arrange
            const log1 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Criação de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            const log2 = logAuditoriaRepository.create({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.UPDATE,
                entidade_afetada: 'documentos',
                entidade_id: 'doc-1',
                descricao: 'Atualização de documento',
                usuario_id: 'test-user-id',
                ip_origem: '127.0.0.1',
            });
            await logAuditoriaRepository.save([log1, log2]);
            // Act
            const response = await request(app.getHttpServer())
                .get('/api/auditoria/relatorio')
                .set('Authorization', `Bearer ${authToken}`)
                .query({ formato: 'json' })
                .expect(200);
            // Assert
            expect(response.body).toHaveLength(2);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxpbnRlZ3JhdGlvblxcYXVkaXRvcmlhLmludGVncmF0aW9uLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FBc0Q7QUFFdEQsbURBQXFDO0FBQ3JDLHFEQUFpRDtBQUNqRCw2Q0FBcUQ7QUFFckQsb0dBQXlGO0FBQ3pGLDZGQUFvRjtBQUNwRixxQ0FBeUM7QUFFekMsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtJQUN0QyxJQUFJLEdBQXFCLENBQUM7SUFDMUIsSUFBSSxzQkFBZ0QsQ0FBQztJQUNyRCxJQUFJLFVBQXNCLENBQUM7SUFDM0IsSUFBSSxTQUFpQixDQUFDO0lBRXRCLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLGFBQWEsR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDbEUsT0FBTyxFQUFFLENBQUMsc0JBQVMsQ0FBQztTQUNyQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixHQUFHLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDNUMsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFakIsc0JBQXNCLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FDeEMsSUFBQSw0QkFBa0IsRUFBQyxtQ0FBWSxDQUFDLENBQ2pDLENBQUM7UUFDRixVQUFVLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBYSxnQkFBVSxDQUFDLENBQUM7UUFFdkQsMENBQTBDO1FBQzFDLFNBQVMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQzFCLEVBQUUsRUFBRSxjQUFjO1lBQ2xCLElBQUksRUFBRSxrQkFBa0I7WUFDeEIsS0FBSyxFQUFFLG1CQUFtQjtZQUMxQixLQUFLLEVBQUUsQ0FBQyxPQUFPLENBQUM7U0FDakIsQ0FBQyxD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XFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcdGVzdFxcaW50ZWdyYXRpb25cXGF1ZGl0b3JpYS5pbnRlZ3JhdGlvbi5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgSU5lc3RBcHBsaWNhdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCAqIGFzIHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCB7IEFwcE1vZHVsZSB9IGZyb20gJy4uLy4uL3NyYy9hcHAubW9kdWxlJztcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBMb2dBdWRpdG9yaWEgfSBmcm9tICcuLi8uLi9zcmMvbW9kdWxlcy9hdWRpdG9yaWEvZW50aXRpZXMvbG9nLWF1ZGl0b3JpYS5lbnRpdHknO1xuaW1wb3J0IHsgVGlwb09wZXJhY2FvIH0gZnJvbSAnLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL2VudW1zL3RpcG8tb3BlcmFjYW8uZW51bSc7XG5pbXBvcnQgeyBKd3RTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9qd3QnO1xuXG5kZXNjcmliZSgnQXVkaXRvcmlhIChJbnRlZ3Jhw6fDo28pJywgKCkgPT4ge1xuICBsZXQgYXBwOiBJTmVzdEFwcGxpY2F0aW9uO1xuICBsZXQgbG9nQXVkaXRvcmlhUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxMb2dBdWRpdG9yaWE+O1xuICBsZXQgand0U2VydmljZTogSnd0U2VydmljZTtcbiAgbGV0IGF1dGhUb2tlbjogc3RyaW5nO1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9kdWxlRml4dHVyZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQXBwTW9kdWxlXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhcHAgPSBtb2R1bGVGaXh0dXJlLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuICAgIGF3YWl0IGFwcC5pbml0KCk7XG5cbiAgICBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5ID0gbW9kdWxlRml4dHVyZS5nZXQ8UmVwb3NpdG9yeTxMb2dBdWRpdG9yaWE+PihcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihMb2dBdWRpdG9yaWEpLFxuICAgICk7XG4gICAgand0U2VydmljZSA9IG1vZHVsZUZpeHR1cmUuZ2V0PEp3dFNlcnZpY2U+KEp3dFNlcnZpY2UpO1xuXG4gICAgLy8gR2VyYXIgdG9rZW4gZGUgYXV0ZW50aWNhw6fDo28gcGFyYSB0ZXN0ZXNcbiAgICBhdXRoVG9rZW4gPSBqd3RTZXJ2aWNlLnNpZ24oe1xuICAgICAgaWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgbm9tZTogJ1VzdcOhcmlvIGRlIFRlc3RlJyxcbiAgICAgIGVtYWlsOiAndGVzdGVAZXhlbXBsby5jb20nLFxuICAgICAgcm9sZXM6IFsnYWRtaW4nXSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gTGltcGFyIGxvZ3MgZGUgYXVkaXRvcmlhIGFudGVzIGRlIGNhZGEgdGVzdGVcbiAgICBhd2FpdCBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LmNsZWFyKCk7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhcHAuY2xvc2UoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0F1ZGl0b3JpYSBkZSBvcGVyYcOnw7VlcyBDUlVEJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgYW8gY3JpYXIgdW0gZG9jdW1lbnRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgZG9jdW1lbnRvRHRvID0ge1xuICAgICAgICBub21lOiAnRG9jdW1lbnRvIGRlIFRlc3RlJyxcbiAgICAgICAgdGlwbzogJ1BERicsXG4gICAgICAgIHNvbGljaXRhY2FvX2lkOiAnNTUwZTg0MDAtZTI5Yi00MWQ0LWE3MTYtNDQ2NjU1NDQwMDAwJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIEFjdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdCgnL2FwaS9kb2N1bWVudG9zJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthdXRoVG9rZW59YClcbiAgICAgICAgLnNlbmQoZG9jdW1lbnRvRHRvKVxuICAgICAgICAuZXhwZWN0KDIwMSk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgY29uc3QgbG9ncyA9IGF3YWl0IGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkuZmluZCgpO1xuICAgICAgZXhwZWN0KGxvZ3MpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChsb2dzWzBdLnRpcG9fb3BlcmFjYW8pLnRvQmUoVGlwb09wZXJhY2FvLkNSRUFURSk7XG4gICAgICBleHBlY3QobG9nc1swXS5lbnRpZGFkZV9hZmV0YWRhKS50b0JlKCdkb2N1bWVudG9zJyk7XG4gICAgICBleHBlY3QobG9nc1swXS51c3VhcmlvX2lkKS50b0JlKCd0ZXN0LXVzZXItaWQnKTtcbiAgICAgIGV4cGVjdChsb2dzWzBdLmRhZG9zX25vdm9zKS50b0VxdWFsKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyhkb2N1bWVudG9EdG8pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgYW8gY29uc3VsdGFyIHVtIGRvY3VtZW50bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFjdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAuZ2V0KCcvYXBpL2RvY3VtZW50b3MvZG9jdW1lbnRvLTEyMycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBjb25zdCBsb2dzID0gYXdhaXQgbG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5maW5kKCk7XG4gICAgICBleHBlY3QobG9ncykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0udGlwb19vcGVyYWNhbykudG9CZShUaXBvT3BlcmFjYW8uUkVBRCk7XG4gICAgICBleHBlY3QobG9nc1swXS5lbnRpZGFkZV9hZmV0YWRhKS50b0JlKCdkb2N1bWVudG9zJyk7XG4gICAgICBleHBlY3QobG9nc1swXS5lbnRpZGFkZV9pZCkudG9CZSgnZG9jdW1lbnRvLTEyMycpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0udXN1YXJpb19pZCkudG9CZSgndGVzdC11c2VyLWlkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGFvIGF0dWFsaXphciB1bSBkb2N1bWVudG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBkb2N1bWVudG9EdG8gPSB7XG4gICAgICAgIG5vbWU6ICdEb2N1bWVudG8gQXR1YWxpemFkbycsXG4gICAgICAgIHRpcG86ICdET0NYJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIEFjdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucHV0KCcvYXBpL2RvY3VtZW50b3MvZG9jdW1lbnRvLTEyMycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5zZW5kKGRvY3VtZW50b0R0bylcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LmZpbmQoKTtcbiAgICAgIGV4cGVjdChsb2dzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QobG9nc1swXS50aXBvX29wZXJhY2FvKS50b0JlKFRpcG9PcGVyYWNhby5VUERBVEUpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0uZW50aWRhZGVfYWZldGFkYSkudG9CZSgnZG9jdW1lbnRvcycpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0uZW50aWRhZGVfaWQpLnRvQmUoJ2RvY3VtZW50by0xMjMnKTtcbiAgICAgIGV4cGVjdChsb2dzWzBdLnVzdWFyaW9faWQpLnRvQmUoJ3Rlc3QtdXNlci1pZCcpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0uZGFkb3Nfbm92b3MpLnRvRXF1YWwoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKGRvY3VtZW50b0R0byksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBhbyBleGNsdWlyIHVtIGRvY3VtZW50bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFjdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAuZGVsZXRlKCcvYXBpL2RvY3VtZW50b3MvZG9jdW1lbnRvLTEyMycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBjb25zdCBsb2dzID0gYXdhaXQgbG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5maW5kKCk7XG4gICAgICBleHBlY3QobG9ncykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KGxvZ3NbMF0udGlwb19vcGVyYWNhbykudG9CZShUaXBvT3BlcmFjYW8uREVMRVRFKTtcbiAgICAgIGV4cGVjdChsb2dzWzBdLmVudGlkYWRlX2FmZXRhZGEpLnRvQmUoJ2RvY3VtZW50b3MnKTtcbiAgICAgIGV4cGVjdChsb2dzWzBdLmVudGlkYWRlX2lkKS50b0JlKCdkb2N1bWVudG8tMTIzJyk7XG4gICAgICBleHBlY3QobG9nc1swXS51c3VhcmlvX2lkKS50b0JlKCd0ZXN0LXVzZXItaWQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSSBkZSBBdWRpdG9yaWEnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcGVybWl0aXIgY29uc3VsdGEgZGUgbG9ncyBkZSBhdWRpdG9yaWEnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBsb2cxID0gbG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICB0aXBvX29wZXJhY2FvOiBUaXBvT3BlcmFjYW8uQ1JFQVRFLFxuICAgICAgICBlbnRpZGFkZV9hZmV0YWRhOiAnZG9jdW1lbnRvcycsXG4gICAgICAgIGVudGlkYWRlX2lkOiAnZG9jLTEnLFxuICAgICAgICBkZXNjcmljYW86ICdDcmlhw6fDo28gZGUgZG9jdW1lbnRvJyxcbiAgICAgICAgdXN1YXJpb19pZDogJ3Rlc3QtdXNlci1pZCcsXG4gICAgICAgIGlwX29yaWdlbTogJzEyNy4wLjAuMScsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgbG9nMiA9IGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkuY3JlYXRlKHtcbiAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLlVQREFURSxcbiAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ2RvY3VtZW50b3MnLFxuICAgICAgICBlbnRpZGFkZV9pZDogJ2RvYy0xJyxcbiAgICAgICAgZGVzY3JpY2FvOiAnQXR1YWxpemHDp8OjbyBkZSBkb2N1bWVudG8nLFxuICAgICAgICB1c3VhcmlvX2lkOiAndGVzdC11c2VyLWlkJyxcbiAgICAgICAgaXBfb3JpZ2VtOiAnMTI3LjAuMC4xJyxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LnNhdmUoW2xvZzEsIGxvZzJdKTtcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLmdldCgnL2FwaS9hdWRpdG9yaWEnKVxuICAgICAgICAuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke2F1dGhUb2tlbn1gKVxuICAgICAgICAucXVlcnkoeyBlbnRpZGFkZV9hZmV0YWRhOiAnZG9jdW1lbnRvcycgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmRhdGEpLnRvSGF2ZUxlbmd0aCgyKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnRvdGFsKS50b0JlKDIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcGVybWl0aXIgY29uc3VsdGEgZGUgbG9ncyBwb3IgdGlwbyBkZSBvcGVyYcOnw6NvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgbG9nMSA9IGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkuY3JlYXRlKHtcbiAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLkNSRUFURSxcbiAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ2RvY3VtZW50b3MnLFxuICAgICAgICBlbnRpZGFkZV9pZDogJ2RvYy0xJyxcbiAgICAgICAgZGVzY3JpY2FvOiAnQ3JpYcOnw6NvIGRlIGRvY3VtZW50bycsXG4gICAgICAgIHVzdWFyaW9faWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgICBpcF9vcmlnZW06ICcxMjcuMC4wLjEnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGxvZzIgPSBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAgIHRpcG9fb3BlcmFjYW86IFRpcG9PcGVyYWNhby5VUERBVEUsXG4gICAgICAgIGVudGlkYWRlX2FmZXRhZGE6ICdkb2N1bWVudG9zJyxcbiAgICAgICAgZW50aWRhZGVfaWQ6ICdkb2MtMScsXG4gICAgICAgIGRlc2NyaWNhbzogJ0F0dWFsaXphw6fDo28gZGUgZG9jdW1lbnRvJyxcbiAgICAgICAgdXN1YXJpb19pZDogJ3Rlc3QtdXNlci1pZCcsXG4gICAgICAgIGlwX29yaWdlbTogJzEyNy4wLjAuMScsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgbG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5zYXZlKFtsb2cxLCBsb2cyXSk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5nZXQoJy9hcGkvYXVkaXRvcmlhJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthdXRoVG9rZW59YClcbiAgICAgICAgLnF1ZXJ5KHsgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLkNSRUFURSB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGF0YSkudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGF0YVswXS50aXBvX29wZXJhY2FvKS50b0JlKFRpcG9PcGVyYWNhby5DUkVBVEUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcGVybWl0aXIgZ2VyYcOnw6NvIGRlIHJlbGF0w7NyaW8gZGUgYXVkaXRvcmlhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgbG9nMSA9IGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkuY3JlYXRlKHtcbiAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLkNSRUFURSxcbiAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ2RvY3VtZW50b3MnLFxuICAgICAgICBlbnRpZGFkZV9pZDogJ2RvYy0xJyxcbiAgICAgICAgZGVzY3JpY2FvOiAnQ3JpYcOnw6NvIGRlIGRvY3VtZW50bycsXG4gICAgICAgIHVzdWFyaW9faWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgICBpcF9vcmlnZW06ICcxMjcuMC4wLjEnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGxvZzIgPSBsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAgIHRpcG9fb3BlcmFjYW86IFRpcG9PcGVyYWNhby5VUERBVEUsXG4gICAgICAgIGVudGlkYWRlX2FmZXRhZGE6ICdkb2N1bWVudG9zJyxcbiAgICAgICAgZW50aWRhZGVfaWQ6ICdkb2MtMScsXG4gICAgICAgIGRlc2NyaWNhbzogJ0F0dWFsaXphw6fDo28gZGUgZG9jdW1lbnRvJyxcbiAgICAgICAgdXN1YXJpb19pZDogJ3Rlc3QtdXNlci1pZCcsXG4gICAgICAgIGlwX29yaWdlbTogJzEyNy4wLjAuMScsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgbG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5zYXZlKFtsb2cxLCBsb2cyXSk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5nZXQoJy9hcGkvYXVkaXRvcmlhL3JlbGF0b3JpbycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5xdWVyeSh7IGZvcm1hdG86ICdqc29uJyB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZUxlbmd0aCgyKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==