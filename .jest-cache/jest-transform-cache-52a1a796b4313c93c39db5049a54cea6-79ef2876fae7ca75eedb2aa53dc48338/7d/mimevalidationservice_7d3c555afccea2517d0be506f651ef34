e139bde9c80cf160e4abc1fd8f806198
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MimeValidationService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const unified_logger_service_1 = require("../../../shared/logging/unified-logger.service");
const crypto = __importStar(require("crypto"));
const path = __importStar(require("path"));
const mime_validation_config_1 = require("../config/mime-validation.config");
/**
 * Serviço de Validação MIME Avançada
 *
 * Implementa validação rigorosa de tipos MIME, extensões de arquivo,
 * detecção de ameaças e verificação de integridade para uploads
 */
let MimeValidationService = class MimeValidationService {
    configService;
    logger;
    maxRetries;
    enableStrictValidation;
    constructor(configService, logger) {
        this.configService = configService;
        this.logger = logger;
        this.logger.setContext('MimeValidationService');
        this.maxRetries = this.configService.get('MIME_VALIDATION_RETRIES', 3);
        this.enableStrictValidation = this.configService.get('ENABLE_STRICT_MIME_VALIDATION', true);
    }
    /**
     * Valida arquivo completo incluindo MIME type, extensão e segurança
     */
    async validateFile(file, tipoBeneficio, validationId) {
        const startTime = Date.now();
        const vId = validationId || crypto.randomUUID().substring(0, 8);
        this.logger.info('Iniciando validação MIME completa', {
            validationId: vId,
            filename: file.originalname,
            size: file.size,
            detectedMimeType: file.mimetype,
            tipoBeneficio,
        });
        try {
            const config = (0, mime_validation_config_1.getMimeConfigForBenefit)(tipoBeneficio);
            const result = await this.performValidation(file, config, vId);
            const processingTime = Date.now() - startTime;
            this.logger.info('Validação MIME concluída', {
                validationId: vId,
                isValid: result.isValid,
                processingTime,
                errorsCount: result.validationErrors.length,
                warningsCount: result.securityWarnings.length,
            });
            return result;
        }
        catch (error) {
            const processingTime = Date.now() - startTime;
            this.logger.error('Erro durante validação MIME', {
                validationId: vId,
                error: error.message,
                processingTime,
                filename: file.originalname,
            });
            throw new common_1.BadRequestException(`Falha na validação do arquivo: ${error.message}`);
        }
    }
    /**
     * Executa a validação completa do arquivo
     */
    async performValidation(file, config, validationId) {
        const validationErrors = [];
        const securityWarnings = [];
        // Extrair informações básicas do arquivo
        const fileExtension = path.extname(file.originalname).toLowerCase();
        const detectedMimeType = file.mimetype;
        const expectedMimeType = (0, mime_validation_config_1.getExpectedMimeType)(file.originalname);
        const fileHash = this.calculateFileHash(file.buffer);
        this.logger.debug('Informações do arquivo extraídas', {
            validationId,
            fileExtension,
            detectedMimeType,
            expectedMimeType,
            fileHash: fileHash.substring(0, 16) + '...',
        });
        // 1. Validar tamanho do arquivo
        if (file.size > config.maxFileSize) {
            validationErrors.push(`Arquivo muito grande: ${this.formatFileSize(file.size)} (máximo: ${this.formatFileSize(config.maxFileSize)})`);
        }
        // 2. Verificar tipos MIME perigosos
        if (mime_validation_config_1.DANGEROUS_MIME_TYPES.includes(detectedMimeType)) {
            validationErrors.push(`Tipo de arquivo perigoso detectado: ${detectedMimeType}`);
            securityWarnings.push('Arquivo contém tipo MIME potencialmente malicioso');
        }
        // 3. Validar extensão do arquivo
        if (!(0, mime_validation_config_1.isExtensionAllowed)(file.originalname, config)) {
            validationErrors.push(`Extensão de arquivo não permitida: ${fileExtension}`);
        }
        // 4. Validar tipo MIME
        if (!(0, mime_validation_config_1.isMimeTypeAllowed)(detectedMimeType, config)) {
            validationErrors.push(`Tipo MIME não permitido: ${detectedMimeType}`);
        }
        // 5. Validação cruzada MIME vs Extensão (se habilitada)
        if (config.strictValidation && expectedMimeType) {
            if (detectedMimeType !== expectedMimeType) {
                const warning = `Inconsistência entre extensão e tipo MIME: esperado ${expectedMimeType}, detectado ${detectedMimeType}`;
                if (this.enableStrictValidation) {
                    validationErrors.push(warning);
                }
                else {
                    securityWarnings.push(warning);
                }
            }
        }
        // 6. Verificar assinatura do arquivo (magic numbers)
        const magicNumberValidation = this.validateMagicNumbers(file.buffer, detectedMimeType);
        if (!magicNumberValidation.isValid) {
            if (magicNumberValidation.error) {
                if (this.enableStrictValidation) {
                    validationErrors.push(magicNumberValidation.error);
                }
                else {
                    securityWarnings.push(magicNumberValidation.error);
                }
            }
        }
        // 7. Verificar nome do arquivo
        const filenameValidation = this.validateFilename(file.originalname);
        if (!filenameValidation.isValid && filenameValidation.error) {
            validationErrors.push(filenameValidation.error);
        }
        const isValid = validationErrors.length === 0;
        if (!isValid) {
            this.logger.warn('Arquivo rejeitado na validação', {
                validationId,
                filename: file.originalname,
                errors: validationErrors,
                warnings: securityWarnings,
            });
        }
        return {
            isValid,
            detectedMimeType,
            expectedMimeType,
            fileExtension,
            fileSize: file.size,
            validationErrors,
            securityWarnings,
            fileHash,
        };
    }
    /**
     * Valida magic numbers (assinatura do arquivo)
     */
    validateMagicNumbers(buffer, mimeType) {
        if (buffer.length < 4) {
            return { isValid: false, error: 'Arquivo muito pequeno para validação' };
        }
        const header = buffer.subarray(0, 8);
        // Verificações específicas por tipo MIME
        switch (mimeType) {
            case 'application/pdf':
                if (!header.subarray(0, 4).equals(Buffer.from([0x25, 0x50, 0x44, 0x46]))) {
                    // %PDF
                    return { isValid: false, error: 'Arquivo não é um PDF válido' };
                }
                break;
            case 'image/jpeg':
            case 'image/jpg':
                if (!header.subarray(0, 2).equals(Buffer.from([0xff, 0xd8]))) {
                    return { isValid: false, error: 'Arquivo não é um JPEG válido' };
                }
                break;
            case 'image/png':
                if (!header.equals(Buffer.from([0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a]))) {
                    return { isValid: false, error: 'Arquivo não é um PNG válido' };
                }
                break;
            case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
            case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':
                if (!header.subarray(0, 2).equals(Buffer.from([0x50, 0x4b]))) {
                    // PK (ZIP)
                    return { isValid: false, error: 'Arquivo Office não é válido' };
                }
                break;
        }
        return { isValid: true };
    }
    /**
     * Valida nome do arquivo
     */
    validateFilename(filename) {
        // Verificar caracteres perigosos
        const dangerousChars = /[<>:"|?*\x00-\x1f]/;
        if (dangerousChars.test(filename)) {
            return {
                isValid: false,
                error: 'Nome do arquivo contém caracteres inválidos',
            };
        }
        // Verificar tamanho do nome
        if (filename.length > 255) {
            return { isValid: false, error: 'Nome do arquivo muito longo' };
        }
        // Verificar nomes reservados do Windows
        const reservedNames = /^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i;
        const nameWithoutExt = path.parse(filename).name;
        if (reservedNames.test(nameWithoutExt)) {
            return {
                isValid: false,
                error: 'Nome do arquivo é reservado pelo sistema',
            };
        }
        return { isValid: true };
    }
    /**
     * Calcula hash SHA-256 do arquivo
     */
    calculateFileHash(buffer) {
        return crypto.createHash('sha256').update(buffer).digest('hex');
    }
    /**
     * Formata tamanho do arquivo para exibição
     */
    formatFileSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size.toFixed(2)} ${units[unitIndex]}`;
    }
    /**
     * Obtém configuração MIME para um tipo de benefício
     */
    getMimeConfig(tipoBeneficio) {
        return (0, mime_validation_config_1.getMimeConfigForBenefit)(tipoBeneficio);
    }
    /**
     * Verifica se um tipo MIME é permitido
     */
    isMimeTypeAllowed(mimeType, tipoBeneficio) {
        const config = (0, mime_validation_config_1.getMimeConfigForBenefit)(tipoBeneficio);
        return (0, mime_validation_config_1.isMimeTypeAllowed)(mimeType, config);
    }
};
exports.MimeValidationService = MimeValidationService;
exports.MimeValidationService = MimeValidationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof unified_logger_service_1.UnifiedLoggerService !== "undefined" && unified_logger_service_1.UnifiedLoggerService) === "function" ? _b : Object])
], MimeValidationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGRvY3VtZW50b1xcc2VydmljZXNcXG1pbWUtdmFsaWRhdGlvbi5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBaUU7QUFDakUsMkNBQStDO0FBQy9DLDJGQUFzRjtBQUN0RiwrQ0FBaUM7QUFFakMsMkNBQTZCO0FBRzdCLDZFQU8wQztBQWdCMUM7Ozs7O0dBS0c7QUFFSSxJQUFNLHFCQUFxQixHQUEzQixNQUFNLHFCQUFxQjtJQUtiO0lBQ0E7SUFMRixVQUFVLENBQVM7SUFDbkIsc0JBQXNCLENBQVU7SUFFakQsWUFDbUIsYUFBNEIsRUFDNUIsTUFBNEI7UUFENUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsV0FBTSxHQUFOLE1BQU0sQ0FBc0I7UUFFN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUN0Qyx5QkFBeUIsRUFDekIsQ0FBQyxDQUNGLENBQUM7UUFDRixJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQ2xELCtCQUErQixFQUMvQixJQUFJLENBQ0wsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxZQUFZLENBQ2hCLElBQWlCLEVBQ2pCLGFBQXNCLEVBQ3RCLFlBQXFCO1FBRXJCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixNQUFNLEdBQUcsR0FBRyxZQUFZLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFaEUsSUFB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UUFDdEQsT0FBTyxJQUFBLDBDQUFpQixFQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM3QyxDQUFDO0NBQ0YsQ0FBQTtBQWhUWSxzREFBcUI7Z0NBQXJCLHFCQUFxQjtJQURqQyxJQUFBLG1CQUFVLEdBQUU7eURBTXVCLHNCQUFhLG9CQUFiLHNCQUFhLG9EQUNwQiw2Q0FBb0Isb0JBQXBCLDZDQUFvQjtHQU5wQyxxQkFBcUIsQ0FnVGpDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxkb2N1bWVudG9cXHNlcnZpY2VzXFxtaW1lLXZhbGlkYXRpb24uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IFVuaWZpZWRMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL2xvZ2dpbmcvdW5pZmllZC1sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBFeHByZXNzIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgKiBhcyBtdWx0ZXIgZnJvbSAnbXVsdGVyJztcbmltcG9ydCB7XG4gIE1pbWVWYWxpZGF0aW9uQ29uZmlnLFxuICBnZXRNaW1lQ29uZmlnRm9yQmVuZWZpdCxcbiAgaXNNaW1lVHlwZUFsbG93ZWQsXG4gIGlzRXh0ZW5zaW9uQWxsb3dlZCxcbiAgZ2V0RXhwZWN0ZWRNaW1lVHlwZSxcbiAgREFOR0VST1VTX01JTUVfVFlQRVMsXG59IGZyb20gJy4uL2NvbmZpZy9taW1lLXZhbGlkYXRpb24uY29uZmlnJztcblxuLyoqXG4gKiBSZXN1bHRhZG8gZGEgdmFsaWRhw6fDo28gTUlNRVxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1pbWVWYWxpZGF0aW9uUmVzdWx0IHtcbiAgaXNWYWxpZDogYm9vbGVhbjtcbiAgZGV0ZWN0ZWRNaW1lVHlwZTogc3RyaW5nO1xuICBleHBlY3RlZE1pbWVUeXBlOiBzdHJpbmcgfCBudWxsO1xuICBmaWxlRXh0ZW5zaW9uOiBzdHJpbmc7XG4gIGZpbGVTaXplOiBudW1iZXI7XG4gIHZhbGlkYXRpb25FcnJvcnM6IHN0cmluZ1tdO1xuICBzZWN1cml0eVdhcm5pbmdzOiBzdHJpbmdbXTtcbiAgZmlsZUhhc2g6IHN0cmluZztcbn1cblxuLyoqXG4gKiBTZXJ2acOnbyBkZSBWYWxpZGHDp8OjbyBNSU1FIEF2YW7Dp2FkYVxuICpcbiAqIEltcGxlbWVudGEgdmFsaWRhw6fDo28gcmlnb3Jvc2EgZGUgdGlwb3MgTUlNRSwgZXh0ZW5zw7VlcyBkZSBhcnF1aXZvLFxuICogZGV0ZWPDp8OjbyBkZSBhbWVhw6dhcyBlIHZlcmlmaWNhw6fDo28gZGUgaW50ZWdyaWRhZGUgcGFyYSB1cGxvYWRzXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNaW1lVmFsaWRhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IG1heFJldHJpZXM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBlbmFibGVTdHJpY3RWYWxpZGF0aW9uOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogVW5pZmllZExvZ2dlclNlcnZpY2UsXG4gICkge1xuICAgIHRoaXMubG9nZ2VyLnNldENvbnRleHQoJ01pbWVWYWxpZGF0aW9uU2VydmljZScpO1xuICAgIHRoaXMubWF4UmV0cmllcyA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPihcbiAgICAgICdNSU1FX1ZBTElEQVRJT05fUkVUUklFUycsXG4gICAgICAzLFxuICAgICk7XG4gICAgdGhpcy5lbmFibGVTdHJpY3RWYWxpZGF0aW9uID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxib29sZWFuPihcbiAgICAgICdFTkFCTEVfU1RSSUNUX01JTUVfVkFMSURBVElPTicsXG4gICAgICB0cnVlLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIGFycXVpdm8gY29tcGxldG8gaW5jbHVpbmRvIE1JTUUgdHlwZSwgZXh0ZW5zw6NvIGUgc2VndXJhbsOnYVxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVGaWxlKFxuICAgIGZpbGU6IG11bHRlci5GaWxlLFxuICAgIHRpcG9CZW5lZmljaW8/OiBzdHJpbmcsXG4gICAgdmFsaWRhdGlvbklkPzogc3RyaW5nLFxuICApOiBQcm9taXNlPE1pbWVWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB2SWQgPSB2YWxpZGF0aW9uSWQgfHwgY3J5cHRvLnJhbmRvbVVVSUQoKS5zdWJzdHJpbmcoMCwgOCk7XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdJbmljaWFuZG8gdmFsaWRhw6fDo28gTUlNRSBjb21wbGV0YScsIHtcbiAgICAgIHZhbGlkYXRpb25JZDogdklkLFxuICAgICAgZmlsZW5hbWU6IGZpbGUub3JpZ2luYWxuYW1lLFxuICAgICAgc2l6ZTogZmlsZS5zaXplLFxuICAgICAgZGV0ZWN0ZWRNaW1lVHlwZTogZmlsZS5taW1ldHlwZSxcbiAgICAgIHRpcG9CZW5lZmljaW8sXG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgY29uZmlnID0gZ2V0TWltZUNvbmZpZ0ZvckJlbmVmaXQodGlwb0JlbmVmaWNpbyk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBlcmZvcm1WYWxpZGF0aW9uKGZpbGUsIGNvbmZpZywgdklkKTtcblxuICAgICAgY29uc3QgcHJvY2Vzc2luZ1RpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuXG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKCdWYWxpZGHDp8OjbyBNSU1FIGNvbmNsdcOtZGEnLCB7XG4gICAgICAgIHZhbGlkYXRpb25JZDogdklkLFxuICAgICAgICBpc1ZhbGlkOiByZXN1bHQuaXNWYWxpZCxcbiAgICAgICAgcHJvY2Vzc2luZ1RpbWUsXG4gICAgICAgIGVycm9yc0NvdW50OiByZXN1bHQudmFsaWRhdGlvbkVycm9ycy5sZW5ndGgsXG4gICAgICAgIHdhcm5pbmdzQ291bnQ6IHJlc3VsdC5zZWN1cml0eVdhcm5pbmdzLmxlbmd0aCxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIGR1cmFudGUgdmFsaWRhw6fDo28gTUlNRScsIHtcbiAgICAgICAgdmFsaWRhdGlvbklkOiB2SWQsXG4gICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICBwcm9jZXNzaW5nVGltZSxcbiAgICAgICAgZmlsZW5hbWU6IGZpbGUub3JpZ2luYWxuYW1lLFxuICAgICAgfSk7XG5cbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgRmFsaGEgbmEgdmFsaWRhw6fDo28gZG8gYXJxdWl2bzogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRhIGEgdmFsaWRhw6fDo28gY29tcGxldGEgZG8gYXJxdWl2b1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwZXJmb3JtVmFsaWRhdGlvbihcbiAgICBmaWxlOiBtdWx0ZXIuRmlsZSxcbiAgICBjb25maWc6IE1pbWVWYWxpZGF0aW9uQ29uZmlnLFxuICAgIHZhbGlkYXRpb25JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPE1pbWVWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgY29uc3QgdmFsaWRhdGlvbkVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBzZWN1cml0eVdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gRXh0cmFpciBpbmZvcm1hw6fDtWVzIGLDoXNpY2FzIGRvIGFycXVpdm9cbiAgICBjb25zdCBmaWxlRXh0ZW5zaW9uID0gcGF0aC5leHRuYW1lKGZpbGUub3JpZ2luYWxuYW1lKS50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IGRldGVjdGVkTWltZVR5cGUgPSBmaWxlLm1pbWV0eXBlO1xuICAgIGNvbnN0IGV4cGVjdGVkTWltZVR5cGUgPSBnZXRFeHBlY3RlZE1pbWVUeXBlKGZpbGUub3JpZ2luYWxuYW1lKTtcbiAgICBjb25zdCBmaWxlSGFzaCA9IHRoaXMuY2FsY3VsYXRlRmlsZUhhc2goZmlsZS5idWZmZXIpO1xuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ0luZm9ybWHDp8O1ZXMgZG8gYXJxdWl2byBleHRyYcOtZGFzJywge1xuICAgICAgdmFsaWRhdGlvbklkLFxuICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgIGRldGVjdGVkTWltZVR5cGUsXG4gICAgICBleHBlY3RlZE1pbWVUeXBlLFxuICAgICAgZmlsZUhhc2g6IGZpbGVIYXNoLnN1YnN0cmluZygwLCAxNikgKyAnLi4uJyxcbiAgICB9KTtcblxuICAgIC8vIDEuIFZhbGlkYXIgdGFtYW5obyBkbyBhcnF1aXZvXG4gICAgaWYgKGZpbGUuc2l6ZSA+IGNvbmZpZy5tYXhGaWxlU2l6ZSkge1xuICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKFxuICAgICAgICBgQXJxdWl2byBtdWl0byBncmFuZGU6ICR7dGhpcy5mb3JtYXRGaWxlU2l6ZShmaWxlLnNpemUpfSAobcOheGltbzogJHt0aGlzLmZvcm1hdEZpbGVTaXplKGNvbmZpZy5tYXhGaWxlU2l6ZSl9KWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIDIuIFZlcmlmaWNhciB0aXBvcyBNSU1FIHBlcmlnb3Nvc1xuICAgIGlmIChEQU5HRVJPVVNfTUlNRV9UWVBFUy5pbmNsdWRlcyhkZXRlY3RlZE1pbWVUeXBlIGFzIGFueSkpIHtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChcbiAgICAgICAgYFRpcG8gZGUgYXJxdWl2byBwZXJpZ29zbyBkZXRlY3RhZG86ICR7ZGV0ZWN0ZWRNaW1lVHlwZX1gLFxuICAgICAgKTtcbiAgICAgIHNlY3VyaXR5V2FybmluZ3MucHVzaChcbiAgICAgICAgJ0FycXVpdm8gY29udMOpbSB0aXBvIE1JTUUgcG90ZW5jaWFsbWVudGUgbWFsaWNpb3NvJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gMy4gVmFsaWRhciBleHRlbnPDo28gZG8gYXJxdWl2b1xuICAgIGlmICghaXNFeHRlbnNpb25BbGxvd2VkKGZpbGUub3JpZ2luYWxuYW1lLCBjb25maWcpKSB7XG4gICAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2goXG4gICAgICAgIGBFeHRlbnPDo28gZGUgYXJxdWl2byBuw6NvIHBlcm1pdGlkYTogJHtmaWxlRXh0ZW5zaW9ufWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIDQuIFZhbGlkYXIgdGlwbyBNSU1FXG4gICAgaWYgKCFpc01pbWVUeXBlQWxsb3dlZChkZXRlY3RlZE1pbWVUeXBlLCBjb25maWcpKSB7XG4gICAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2goYFRpcG8gTUlNRSBuw6NvIHBlcm1pdGlkbzogJHtkZXRlY3RlZE1pbWVUeXBlfWApO1xuICAgIH1cblxuICAgIC8vIDUuIFZhbGlkYcOnw6NvIGNydXphZGEgTUlNRSB2cyBFeHRlbnPDo28gKHNlIGhhYmlsaXRhZGEpXG4gICAgaWYgKGNvbmZpZy5zdHJpY3RWYWxpZGF0aW9uICYmIGV4cGVjdGVkTWltZVR5cGUpIHtcbiAgICAgIGlmIChkZXRlY3RlZE1pbWVUeXBlICE9PSBleHBlY3RlZE1pbWVUeXBlKSB7XG4gICAgICAgIGNvbnN0IHdhcm5pbmcgPSBgSW5jb25zaXN0w6puY2lhIGVudHJlIGV4dGVuc8OjbyBlIHRpcG8gTUlNRTogZXNwZXJhZG8gJHtleHBlY3RlZE1pbWVUeXBlfSwgZGV0ZWN0YWRvICR7ZGV0ZWN0ZWRNaW1lVHlwZX1gO1xuXG4gICAgICAgIGlmICh0aGlzLmVuYWJsZVN0cmljdFZhbGlkYXRpb24pIHtcbiAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2god2FybmluZyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VjdXJpdHlXYXJuaW5ncy5wdXNoKHdhcm5pbmcpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gNi4gVmVyaWZpY2FyIGFzc2luYXR1cmEgZG8gYXJxdWl2byAobWFnaWMgbnVtYmVycylcbiAgICBjb25zdCBtYWdpY051bWJlclZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlTWFnaWNOdW1iZXJzKFxuICAgICAgZmlsZS5idWZmZXIsXG4gICAgICBkZXRlY3RlZE1pbWVUeXBlLFxuICAgICk7XG4gICAgaWYgKCFtYWdpY051bWJlclZhbGlkYXRpb24uaXNWYWxpZCkge1xuICAgICAgaWYgKG1hZ2ljTnVtYmVyVmFsaWRhdGlvbi5lcnJvcikge1xuICAgICAgICBpZiAodGhpcy5lbmFibGVTdHJpY3RWYWxpZGF0aW9uKSB7XG4gICAgICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKG1hZ2ljTnVtYmVyVmFsaWRhdGlvbi5lcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VjdXJpdHlXYXJuaW5ncy5wdXNoKG1hZ2ljTnVtYmVyVmFsaWRhdGlvbi5lcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyA3LiBWZXJpZmljYXIgbm9tZSBkbyBhcnF1aXZvXG4gICAgY29uc3QgZmlsZW5hbWVWYWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUZpbGVuYW1lKGZpbGUub3JpZ2luYWxuYW1lKTtcbiAgICBpZiAoIWZpbGVuYW1lVmFsaWRhdGlvbi5pc1ZhbGlkICYmIGZpbGVuYW1lVmFsaWRhdGlvbi5lcnJvcikge1xuICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKGZpbGVuYW1lVmFsaWRhdGlvbi5lcnJvcik7XG4gICAgfVxuXG4gICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRpb25FcnJvcnMubGVuZ3RoID09PSAwO1xuXG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKCdBcnF1aXZvIHJlamVpdGFkbyBuYSB2YWxpZGHDp8OjbycsIHtcbiAgICAgICAgdmFsaWRhdGlvbklkLFxuICAgICAgICBmaWxlbmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgIGVycm9yczogdmFsaWRhdGlvbkVycm9ycyxcbiAgICAgICAgd2FybmluZ3M6IHNlY3VyaXR5V2FybmluZ3MsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNWYWxpZCxcbiAgICAgIGRldGVjdGVkTWltZVR5cGUsXG4gICAgICBleHBlY3RlZE1pbWVUeXBlLFxuICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgIGZpbGVTaXplOiBmaWxlLnNpemUsXG4gICAgICB2YWxpZGF0aW9uRXJyb3JzLFxuICAgICAgc2VjdXJpdHlXYXJuaW5ncyxcbiAgICAgIGZpbGVIYXNoLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIG1hZ2ljIG51bWJlcnMgKGFzc2luYXR1cmEgZG8gYXJxdWl2bylcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVNYWdpY051bWJlcnMoXG4gICAgYnVmZmVyOiBCdWZmZXIsXG4gICAgbWltZVR5cGU6IHN0cmluZyxcbiAgKTogeyBpc1ZhbGlkOiBib29sZWFuOyBlcnJvcj86IHN0cmluZyB9IHtcbiAgICBpZiAoYnVmZmVyLmxlbmd0aCA8IDQpIHtcbiAgICAgIHJldHVybiB7IGlzVmFsaWQ6IGZhbHNlLCBlcnJvcjogJ0FycXVpdm8gbXVpdG8gcGVxdWVubyBwYXJhIHZhbGlkYcOnw6NvJyB9O1xuICAgIH1cblxuICAgIGNvbnN0IGhlYWRlciA9IGJ1ZmZlci5zdWJhcnJheSgwLCA4KTtcblxuICAgIC8vIFZlcmlmaWNhw6fDtWVzIGVzcGVjw61maWNhcyBwb3IgdGlwbyBNSU1FXG4gICAgc3dpdGNoIChtaW1lVHlwZSkge1xuICAgICAgY2FzZSAnYXBwbGljYXRpb24vcGRmJzpcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFoZWFkZXIuc3ViYXJyYXkoMCwgNCkuZXF1YWxzKEJ1ZmZlci5mcm9tKFsweDI1LCAweDUwLCAweDQ0LCAweDQ2XSkpXG4gICAgICAgICkge1xuICAgICAgICAgIC8vICVQREZcbiAgICAgICAgICByZXR1cm4geyBpc1ZhbGlkOiBmYWxzZSwgZXJyb3I6ICdBcnF1aXZvIG7Do28gw6kgdW0gUERGIHbDoWxpZG8nIH07XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2ltYWdlL2pwZWcnOlxuICAgICAgY2FzZSAnaW1hZ2UvanBnJzpcbiAgICAgICAgaWYgKCFoZWFkZXIuc3ViYXJyYXkoMCwgMikuZXF1YWxzKEJ1ZmZlci5mcm9tKFsweGZmLCAweGQ4XSkpKSB7XG4gICAgICAgICAgcmV0dXJuIHsgaXNWYWxpZDogZmFsc2UsIGVycm9yOiAnQXJxdWl2byBuw6NvIMOpIHVtIEpQRUcgdsOhbGlkbycgfTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnaW1hZ2UvcG5nJzpcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFoZWFkZXIuZXF1YWxzKFxuICAgICAgICAgICAgQnVmZmVyLmZyb20oWzB4ODksIDB4NTAsIDB4NGUsIDB4NDcsIDB4MGQsIDB4MGEsIDB4MWEsIDB4MGFdKSxcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiB7IGlzVmFsaWQ6IGZhbHNlLCBlcnJvcjogJ0FycXVpdm8gbsOjbyDDqSB1bSBQTkcgdsOhbGlkbycgfTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LndvcmRwcm9jZXNzaW5nbWwuZG9jdW1lbnQnOlxuICAgICAgY2FzZSAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQnOlxuICAgICAgICBpZiAoIWhlYWRlci5zdWJhcnJheSgwLCAyKS5lcXVhbHMoQnVmZmVyLmZyb20oWzB4NTAsIDB4NGJdKSkpIHtcbiAgICAgICAgICAvLyBQSyAoWklQKVxuICAgICAgICAgIHJldHVybiB7IGlzVmFsaWQ6IGZhbHNlLCBlcnJvcjogJ0FycXVpdm8gT2ZmaWNlIG7Do28gw6kgdsOhbGlkbycgfTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4geyBpc1ZhbGlkOiB0cnVlIH07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIG5vbWUgZG8gYXJxdWl2b1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZUZpbGVuYW1lKGZpbGVuYW1lOiBzdHJpbmcpOiB7XG4gICAgaXNWYWxpZDogYm9vbGVhbjtcbiAgICBlcnJvcj86IHN0cmluZztcbiAgfSB7XG4gICAgLy8gVmVyaWZpY2FyIGNhcmFjdGVyZXMgcGVyaWdvc29zXG4gICAgY29uc3QgZGFuZ2Vyb3VzQ2hhcnMgPSAvWzw+OlwifD8qXFx4MDAtXFx4MWZdLztcbiAgICBpZiAoZGFuZ2Vyb3VzQ2hhcnMudGVzdChmaWxlbmFtZSkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ05vbWUgZG8gYXJxdWl2byBjb250w6ltIGNhcmFjdGVyZXMgaW52w6FsaWRvcycsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciB0YW1hbmhvIGRvIG5vbWVcbiAgICBpZiAoZmlsZW5hbWUubGVuZ3RoID4gMjU1KSB7XG4gICAgICByZXR1cm4geyBpc1ZhbGlkOiBmYWxzZSwgZXJyb3I6ICdOb21lIGRvIGFycXVpdm8gbXVpdG8gbG9uZ28nIH07XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIG5vbWVzIHJlc2VydmFkb3MgZG8gV2luZG93c1xuICAgIGNvbnN0IHJlc2VydmVkTmFtZXMgPSAvXihDT058UFJOfEFVWHxOVUx8Q09NWzEtOV18TFBUWzEtOV0pJC9pO1xuICAgIGNvbnN0IG5hbWVXaXRob3V0RXh0ID0gcGF0aC5wYXJzZShmaWxlbmFtZSkubmFtZTtcbiAgICBpZiAocmVzZXJ2ZWROYW1lcy50ZXN0KG5hbWVXaXRob3V0RXh0KSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnTm9tZSBkbyBhcnF1aXZvIMOpIHJlc2VydmFkbyBwZWxvIHNpc3RlbWEnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBpc1ZhbGlkOiB0cnVlIH07XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBoYXNoIFNIQS0yNTYgZG8gYXJxdWl2b1xuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVGaWxlSGFzaChidWZmZXI6IEJ1ZmZlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoYnVmZmVyKS5kaWdlc3QoJ2hleCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvcm1hdGEgdGFtYW5obyBkbyBhcnF1aXZvIHBhcmEgZXhpYmnDp8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBmb3JtYXRGaWxlU2l6ZShieXRlczogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCB1bml0cyA9IFsnQicsICdLQicsICdNQicsICdHQiddO1xuICAgIGxldCBzaXplID0gYnl0ZXM7XG4gICAgbGV0IHVuaXRJbmRleCA9IDA7XG5cbiAgICB3aGlsZSAoc2l6ZSA+PSAxMDI0ICYmIHVuaXRJbmRleCA8IHVuaXRzLmxlbmd0aCAtIDEpIHtcbiAgICAgIHNpemUgLz0gMTAyNDtcbiAgICAgIHVuaXRJbmRleCsrO1xuICAgIH1cblxuICAgIHJldHVybiBgJHtzaXplLnRvRml4ZWQoMil9ICR7dW5pdHNbdW5pdEluZGV4XX1gO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBjb25maWd1cmHDp8OjbyBNSU1FIHBhcmEgdW0gdGlwbyBkZSBiZW5lZsOtY2lvXG4gICAqL1xuICBnZXRNaW1lQ29uZmlnKHRpcG9CZW5lZmljaW8/OiBzdHJpbmcpOiBNaW1lVmFsaWRhdGlvbkNvbmZpZyB7XG4gICAgcmV0dXJuIGdldE1pbWVDb25maWdGb3JCZW5lZml0KHRpcG9CZW5lZmljaW8pO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtIHRpcG8gTUlNRSDDqSBwZXJtaXRpZG9cbiAgICovXG4gIGlzTWltZVR5cGVBbGxvd2VkKG1pbWVUeXBlOiBzdHJpbmcsIHRpcG9CZW5lZmljaW8/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBjb25maWcgPSBnZXRNaW1lQ29uZmlnRm9yQmVuZWZpdCh0aXBvQmVuZWZpY2lvKTtcbiAgICByZXR1cm4gaXNNaW1lVHlwZUFsbG93ZWQobWltZVR5cGUsIGNvbmZpZyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==