e5e48bd74912209e6f4fd8594f5ef690
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var SolicitacaoService_1;
var _a, _b, _c, _d, _e, _f, _g;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SolicitacaoService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const entities_1 = require("../../../entities");
const update_solicitacao_dto_1 = require("../dto/update-solicitacao.dto");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
const processo_judicial_repository_1 = require("../../judicial/repositories/processo-judicial.repository");
const roles_constants_1 = require("../../../shared/constants/roles.constants");
const validacao_exclusividade_service_1 = require("./validacao-exclusividade.service");
/**
 * Serviço de Solicitações
 *
 * Responsável pela lógica de negócio relacionada às solicitações de benefícios
 */
let SolicitacaoService = SolicitacaoService_1 = class SolicitacaoService {
    solicitacaoRepository;
    historicoRepository;
    pendenciaRepository;
    processoJudicialRepository;
    determinacaoJudicialRepository;
    connection;
    validacaoExclusividadeService;
    logger = new common_1.Logger(SolicitacaoService_1.name);
    constructor(solicitacaoRepository, historicoRepository, pendenciaRepository, processoJudicialRepository, determinacaoJudicialRepository, connection, validacaoExclusividadeService) {
        this.solicitacaoRepository = solicitacaoRepository;
        this.historicoRepository = historicoRepository;
        this.pendenciaRepository = pendenciaRepository;
        this.processoJudicialRepository = processoJudicialRepository;
        this.determinacaoJudicialRepository = determinacaoJudicialRepository;
        this.connection = connection;
        this.validacaoExclusividadeService = validacaoExclusividadeService;
    }
    /**
     * Lista todas as solicitações com paginação e filtros
     */
    async findAll(options) {
        const { page = 1, limit = 10, status, unidade_id, beneficio_id, protocolo, data_inicio, data_fim, user, } = options;
        const queryBuilder = this.solicitacaoRepository.createQueryBuilder('solicitacao');
        // Joins necessários
        queryBuilder
            .leftJoinAndSelect('solicitacao.beneficiario', 'beneficiario')
            .leftJoinAndSelect('solicitacao.tipo_beneficio', 'tipo_beneficio')
            .leftJoinAndSelect('solicitacao.unidade', 'unidade')
            .leftJoinAndSelect('solicitacao.tecnico', 'tecnico');
        // Aplicar filtros
        if (status) {
            queryBuilder.andWhere('solicitacao.status = :status', { status });
        }
        // Filtro por unidade com verificação de permissão
        if (unidade_id) {
            queryBuilder.andWhere('solicitacao.unidade_id = :unidade_id', {
                unidade_id,
            });
        }
        else if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR].includes(user.role)) {
            // Usuários que não são admin ou gestor SEMTAS só podem ver solicitações da sua unidade
            queryBuilder.andWhere('solicitacao.unidade_id = :unidade_id', {
                unidade_id: user.unidade_id,
            });
        }
        if (beneficio_id) {
            queryBuilder.andWhere('solicitacao.tipo_beneficio_id = :beneficio_id', {
                beneficio_id,
            });
        }
        if (protocolo) {
            queryBuilder.andWhere('solicitacao.protocolo ILIKE :protocolo', {
                protocolo: `%${protocolo}%`,
            });
        }
        // Filtro por período
        if (data_inicio && data_fim) {
            const inicio = new Date(data_inicio);
            const fim = new Date(data_fim);
            fim.setHours(23, 59, 59, 999); // Ajusta para o final do dia
            queryBuilder.andWhere('solicitacao.data_abertura BETWEEN :inicio AND :fim', {
                inicio,
                fim,
            });
        }
        else if (data_inicio) {
            const inicio = new Date(data_inicio);
            queryBuilder.andWhere('solicitacao.data_abertura >= :inicio', { inicio });
        }
        else if (data_fim) {
            const fim = new Date(data_fim);
            fim.setHours(23, 59, 59, 999); // Ajusta para o final do dia
            queryBuilder.andWhere('solicitacao.data_abertura <= :fim', { fim });
        }
        // Calcular paginação
        const skip = (page - 1) * limit;
        queryBuilder.skip(skip).take(limit);
        // Ordenação padrão
        queryBuilder.orderBy('solicitacao.data_abertura', 'DESC');
        // Executar consulta
        const [items, total] = await queryBuilder.getManyAndCount();
        return {
            items,
            meta: {
                currentPage: page,
                itemsPerPage: limit,
                totalItems: total,
                totalPages: Math.ceil(total / limit),
            },
        };
    }
    /**
     * Busca uma solicitação pelo ID
     */
    async findById(id) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id },
            relations: ['beneficiario', 'tipo_beneficio', 'unidade', 'tecnico'],
        });
        if (!solicitacao) {
            throw new common_1.NotFoundException(`Solicitação com ID ${id} não encontrada`);
        }
        return solicitacao;
    }
    /**
     * Cria uma nova solicitação
     */
    async create(createSolicitacaoDto, user) {
        // Validar exclusividade de papel para o beneficiário
        await this.validacaoExclusividadeService.validarExclusividadeBeneficiario(createSolicitacaoDto.beneficiario_id);
        // Se tiver composição familiar, validar para cada membro
        if (createSolicitacaoDto.dados_complementares &&
            createSolicitacaoDto.dados_complementares.composicao_familiar &&
            Array.isArray(createSolicitacaoDto.dados_complementares.composicao_familiar) &&
            createSolicitacaoDto.dados_complementares.composicao_familiar.length > 0) {
            const composicaoFamiliar = createSolicitacaoDto.dados_complementares.composicao_familiar.map((membro) => membro.cidadao_id);
            await this.validacaoExclusividadeService.validarComposicaoFamiliarCompleta(composicaoFamiliar);
        }
        return this.connection.transaction(async (manager) => {
            // Criar uma nova instância de Solicitacao
            const solicitacao = new entities_1.Solicitacao();
            // Determinar a unidade: se usuário não tem unidade, usar do DTO (obrigatório)
            let unidadeId;
            if (!user.unidade_id) {
                if (!createSolicitacaoDto.unidade_id) {
                    throw new common_1.BadRequestException('Usuário não possui unidade vinculada. O campo unidade_id é obrigatório.');
                }
                unidadeId = createSolicitacaoDto.unidade_id;
            }
            else {
                unidadeId = user.unidade_id;
            }
            // Preencher os dados básicos
            solicitacao.beneficiario_id = createSolicitacaoDto.beneficiario_id;
            solicitacao.tipo_beneficio_id = createSolicitacaoDto.tipo_beneficio_id;
            solicitacao.unidade_id = unidadeId;
            solicitacao.tecnico_id = user.id;
            solicitacao.status = entities_1.StatusSolicitacao.RASCUNHO;
            solicitacao.data_abertura = new Date();
            // Normalizar enums nos dados complementares antes de salvar
            const dadosComplementares = createSolicitacaoDto.dados_complementares || {};
            solicitacao.dados_complementares =
                (0, enum_normalizer_util_1.normalizeEnumFields)(dadosComplementares);
            // Salvar a solicitação
            const savedSolicitacao = await manager.save(solicitacao);
            // Registrar no histórico
            const historico = new entities_1.HistoricoSolicitacao();
            historico.solicitacao_id = savedSolicitacao.id;
            historico.usuario_id = user.id;
            historico.status_anterior = entities_1.StatusSolicitacao.ABERTA;
            historico.status_atual = entities_1.StatusSolicitacao.ABERTA;
            historico.observacao = 'Solicitação criada';
            historico.dados_alterados = { acao: 'criacao' };
            historico.ip_usuario = user.ip || '0.0.0.0';
            await manager.save(historico);
            // Buscar a solicitação criada dentro da transação com relações essenciais
            const solicitacaoCompleta = await manager.findOne(entities_1.Solicitacao, {
                where: { id: savedSolicitacao.id },
                relations: [
                    'beneficiario',
                    'tipo_beneficio',
                    'unidade',
                    'tecnico',
                    'historico',
                ],
            });
            if (!solicitacaoCompleta) {
                throw new common_1.NotFoundException(`Solicitação com ID ${savedSolicitacao.id} não encontrada após criação`);
            }
            return solicitacaoCompleta;
        });
    }
    /**
     * Atualiza uma solicitação existente
     */
    async update(id, updateSolicitacaoDto, user) {
        return this.connection.transaction(async (manager) => {
            // Buscar a solicitação
            const solicitacao = await this.findById(id);
            // Check if request status allows editing based on business rules
            const EDITABLE_STATUSES = [
                entities_1.StatusSolicitacao.ABERTA,
                entities_1.StatusSolicitacao.PENDENTE,
            ];
            if (!EDITABLE_STATUSES.includes(solicitacao.status)) {
                const statusMessage = `Status atual: ${solicitacao.status}`;
                const allowedMessage = `Status disponíveis: ${EDITABLE_STATUSES.join(', ')}`;
                throw new common_1.BadRequestException({
                    message: 'A solicitação não pode ser editado neste status.',
                    detalhes: {
                        statusAtual: solicitacao.status,
                        statusPossiveis: EDITABLE_STATUSES,
                    },
                    contexto: `${statusMessage}. ${allowedMessage}`,
                });
            }
            // Atualizar os dados
            // Nota: beneficiario_id não pode ser atualizado conforme definido no DTO
            if (updateSolicitacaoDto.tipo_beneficio_id) {
                solicitacao.tipo_beneficio_id = updateSolicitacaoDto.tipo_beneficio_id;
            }
            if (updateSolicitacaoDto.dados_complementares) {
                // Normalizar enums nos dados complementares antes de salvar
                solicitacao.dados_complementares = (0, enum_normalizer_util_1.normalizeEnumFields)(updateSolicitacaoDto.dados_complementares);
            }
            // Salvar a solicitação
            await manager.save(solicitacao);
            // Registrar no histórico
            const historico = new entities_1.HistoricoSolicitacao();
            historico.solicitacao_id = id;
            historico.usuario_id = user.id;
            historico.status_anterior = solicitacao.status;
            historico.status_atual = solicitacao.status;
            historico.observacao = 'Solicitação atualizada';
            historico.dados_alterados = {
                campos_alterados: Object.keys(updateSolicitacaoDto),
            };
            historico.ip_usuario = user.ip || '0.0.0.0';
            await manager.save(historico);
            return this.findById(id);
        });
    }
    /**
     * Submete uma solicitação para análise
     */
    async submeterSolicitacao(id, user) {
        return this.connection.transaction(async (manager) => {
            // Buscar a solicitação
            const solicitacao = await this.findById(id);
            // Verificar se a solicitação está em estado que permite submissão
            if (solicitacao.status !== entities_1.StatusSolicitacao.RASCUNHO) {
                throw new common_1.BadRequestException(`Não é possível submeter uma solicitação com status ${solicitacao.status}`);
            }
            // Atualizar o status usando o método preparar
            solicitacao.prepararAlteracaoStatus(entities_1.StatusSolicitacao.EM_ANALISE, user.id, 'Solicitação submetida para análise', user.ip || '0.0.0.0');
            await manager.save(solicitacao);
            // Register in history
            const historico = new entities_1.HistoricoSolicitacao();
            historico.solicitacao_id = id;
            historico.usuario_id = user.id;
            historico.status_anterior = entities_1.StatusSolicitacao.RASCUNHO;
            historico.status_atual = solicitacao.status;
            historico.observacao = 'Solicitação submetida para análise';
            historico.dados_alterados = {
                campos_alterados: Object.keys(update_solicitacao_dto_1.UpdateSolicitacaoDto),
            };
            historico.ip_usuario = user.ip || '0.0.0.0';
            await manager.save(historico);
            return this.findById(id);
        });
    }
    /**
     * Avalia uma solicitação (aprovar/pendenciar)
     */
    async avaliarSolicitacao(id, avaliarSolicitacaoDto, user) {
        return this.connection.transaction(async (manager) => {
            // Buscar a solicitação
            const solicitacao = await this.findById(id);
            // Verificar se a solicitação está em estado que permite avaliação
            if (solicitacao.status !== entities_1.StatusSolicitacao.PENDENTE &&
                solicitacao.status !== entities_1.StatusSolicitacao.EM_ANALISE) {
                throw new common_1.BadRequestException(`Não é possível avaliar uma solicitação com status ${solicitacao.status}`);
            }
            // Determinar o novo status
            const novoStatus = avaliarSolicitacaoDto.aprovado
                ? entities_1.StatusSolicitacao.APROVADA
                : entities_1.StatusSolicitacao.AGUARDANDO_DOCUMENTOS;
            // Atualizar o status usando o método preparar
            solicitacao.prepararAlteracaoStatus(novoStatus, user.id, avaliarSolicitacaoDto.parecer, user.ip || '0.0.0.0');
            if (avaliarSolicitacaoDto.aprovado) {
                solicitacao.aprovador_id = user.id;
                solicitacao.data_aprovacao = new Date();
                solicitacao.parecer_semtas = avaliarSolicitacaoDto.parecer;
            }
            else {
                // Registrar pendências
                if (avaliarSolicitacaoDto.pendencias &&
                    avaliarSolicitacaoDto.pendencias.length > 0) {
                    for (const descricaoTexto of avaliarSolicitacaoDto.pendencias) {
                        // Criar uma nova instância de Pendencia diretamente para evitar problemas de tipagem
                        const pendencia = new entities_1.Pendencia();
                        pendencia.solicitacao_id = id;
                        pendencia.descricao = descricaoTexto;
                        pendencia.status = entities_1.StatusPendencia.ABERTA;
                        pendencia.registrado_por_id = user.id; // Usando registrado_por_id conforme definido na entidade
                        await manager.save(pendencia);
                    }
                }
            }
            // Salvar a solicitação com o manager da transação
            await manager.save(solicitacao);
            // Não é mais necessário registrar manualmente no histórico
            // O método logStatusChange fará isso automaticamente através do listener @AfterUpdate
            return this.findById(id);
        });
    }
    /**
     * Libera um benefício aprovado
     */
    async liberarBeneficio(id, user) {
        return this.connection.transaction(async (manager) => {
            // Buscar a solicitação
            const solicitacao = await this.findById(id);
            // Verificar se o usuário tem permissão
            if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR].includes(user.role)) {
                throw new common_1.UnauthorizedException('Você não tem permissão para liberar benefícios');
            }
            // Verificar se a solicitação está aprovada
            if (solicitacao.status !== entities_1.StatusSolicitacao.APROVADA) {
                throw new common_1.BadRequestException('Apenas solicitações aprovadas podem ser liberadas');
            }
            // Atualizar o status usando o método preparar
            solicitacao.prepararAlteracaoStatus(entities_1.StatusSolicitacao.LIBERADA, user.id, 'Benefício liberado para pagamento/entrega', user.ip || '0.0.0.0');
            solicitacao.liberador_id = user.id;
            solicitacao.data_liberacao = new Date();
            // Salvar a solicitação com o manager da transação
            await manager.save(solicitacao);
            // Não é mais necessário registrar manualmente no histórico
            // O método logStatusChange fará isso automaticamente através do listener @AfterUpdate
            return this.findById(id);
        });
    }
    /**
     * Cancela uma solicitação
     */
    async cancelarSolicitacao(id, user) {
        return this.connection.transaction(async (manager) => {
            // Buscar a solicitação
            const solicitacao = await this.findById(id);
            // Verificar se o usuário tem permissão
            if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR, roles_constants_1.ROLES.TECNICO].includes(user.role)) {
                throw new common_1.UnauthorizedException('Você não tem permissão para cancelar solicitações');
            }
            // Verificar se a solicitação pode ser cancelada
            if (solicitacao.status === entities_1.StatusSolicitacao.LIBERADA) {
                throw new common_1.BadRequestException('Não é possível cancelar uma solicitação já liberada');
            }
            // Atualizar o status usando o método preparar
            solicitacao.prepararAlteracaoStatus(entities_1.StatusSolicitacao.CANCELADA, user.id, 'Solicitação cancelada pelo usuário', user.ip || '0.0.0.0');
            // Salvar a solicitação com o manager da transação
            await manager.save(solicitacao);
            // Não é mais necessário registrar manualmente no histórico
            // O método logStatusChange fará isso automaticamente através do listener @AfterUpdate
            return this.findById(id);
        });
    }
    /**
     * Lista o histórico de uma solicitação
     */
    async getHistorico(solicitacaoId) {
        // Verificar se a solicitação existe
        await this.findById(solicitacaoId);
        // Buscar o histórico
        return this.historicoRepository.find({
            where: { solicitacao_id: solicitacaoId },
            order: { created_at: 'DESC' },
            relations: ['usuario'],
        });
    }
    /**
     * Lista as pendências de uma solicitação
     */
    async getPendencias(solicitacaoId) {
        // Verificar se a solicitação existe
        await this.findById(solicitacaoId);
        // Buscar as pendências
        return this.pendenciaRepository.find({
            where: { solicitacao_id: solicitacaoId },
            order: { created_at: 'DESC' },
        });
    }
    /**
     * Vincula um processo judicial a uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param vincularDto Dados do vínculo
     * @param user Usuário que está realizando a operação
     * @returns Solicitação atualizada
     */
    async vincularProcessoJudicial(solicitacaoId, vincularDto, user) {
        return this.connection.transaction(async (manager) => {
            try {
                // Verificar se a solicitação existe
                const solicitacao = await this.findById(solicitacaoId);
                // Verificar se o usuário tem permissão
                if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR, roles_constants_1.ROLES.TECNICO].includes(user.role)) {
                    throw new common_1.UnauthorizedException('Você não tem permissão para vincular processos judiciais');
                }
                // Verificar se o processo judicial existe
                const processoJudicial = await this.processoJudicialRepository.findOne({
                    where: { id: vincularDto.processo_judicial_id },
                });
                if (!processoJudicial) {
                    throw new common_1.NotFoundException('Processo judicial não encontrado');
                }
                // Verificar se a solicitação já tem este processo vinculado
                if (solicitacao.processo_judicial_id === vincularDto.processo_judicial_id) {
                    throw new common_1.ConflictException('Este processo judicial já está vinculado à solicitação');
                }
                // Atualizar a solicitação
                solicitacao.processo_judicial_id = vincularDto.processo_judicial_id;
                // Registrar no histórico
                const historicoEntry = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: solicitacaoId,
                    status_anterior: solicitacao.status,
                    status_atual: solicitacao.status,
                    usuario_id: user.id,
                    observacao: vincularDto.observacao || 'Processo judicial vinculado',
                    dados_alterados: {
                        processo_judicial: {
                            id: vincularDto.processo_judicial_id,
                            numero: processoJudicial.numero_processo,
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                // Salvar as alterações
                await manager.save(solicitacao);
                await manager.save(historicoEntry);
                return this.findById(solicitacaoId);
            }
            catch (error) {
                if (error instanceof common_1.NotFoundException ||
                    error instanceof common_1.UnauthorizedException ||
                    error instanceof common_1.ConflictException) {
                    throw error;
                }
                this.logger.error(`Erro ao vincular processo judicial: ${error.message}`, error.stack);
                throw new common_1.InternalServerErrorException('Erro ao vincular processo judicial à solicitação');
            }
        });
    }
    /**
     * Desvincula um processo judicial de uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param user Usuário que está realizando a operação
     * @returns Solicitação atualizada
     */
    async desvincularProcessoJudicial(solicitacaoId, user) {
        return this.connection.transaction(async (manager) => {
            try {
                // Verificar se a solicitação existe
                const solicitacao = await this.findById(solicitacaoId);
                // Verificar se o usuário tem permissão
                if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR].includes(user.role)) {
                    throw new common_1.UnauthorizedException('Você não tem permissão para desvincular processos judiciais');
                }
                // Verificar se a solicitação tem processo vinculado
                if (!solicitacao.processo_judicial_id) {
                    throw new common_1.BadRequestException('Esta solicitação não possui processo judicial vinculado');
                }
                // Guardar informação do processo para o histórico
                const processoJudicialId = solicitacao.processo_judicial_id;
                const processoJudicial = await this.processoJudicialRepository.findOne({
                    where: { id: processoJudicialId },
                });
                // Atualizar a solicitação
                solicitacao.processo_judicial_id = null;
                // Registrar no histórico
                const historicoEntry = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: solicitacaoId,
                    status_anterior: solicitacao.status,
                    status_atual: solicitacao.status,
                    usuario_id: user.id,
                    observacao: 'Processo judicial desvinculado',
                    dados_alterados: {
                        processo_judicial: {
                            id: processoJudicialId,
                            numero: processoJudicial
                                ? processoJudicial.numero_processo
                                : 'Desconhecido',
                            acao: 'removido',
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                // Salvar as alterações
                await manager.save(solicitacao);
                await manager.save(historicoEntry);
                return this.findById(solicitacaoId);
            }
            catch (error) {
                if (error instanceof common_1.NotFoundException ||
                    error instanceof common_1.UnauthorizedException ||
                    error instanceof common_1.BadRequestException) {
                    throw error;
                }
                this.logger.error(`Erro ao desvincular processo judicial: ${error.message}`, error.stack);
                throw new common_1.InternalServerErrorException('Erro ao desvincular processo judicial da solicitação');
            }
        });
    }
    /**
     * Vincula uma determinação judicial a uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param vincularDto Dados do vínculo
     * @param user Usuário que está realizando a operação
     * @returns Solicitação atualizada
     */
    async vincularDeterminacaoJudicial(solicitacaoId, vincularDto, user) {
        return this.connection.transaction(async (manager) => {
            try {
                // Verificar se a solicitação existe
                const solicitacao = await this.findById(solicitacaoId);
                // Verificar se o usuário tem permissão
                if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR, roles_constants_1.ROLES.TECNICO].includes(user.role)) {
                    throw new common_1.UnauthorizedException('Você não tem permissão para vincular determinações judiciais');
                }
                // Verificar se a determinação judicial existe
                const determinacaoJudicial = await this.determinacaoJudicialRepository.findOne({
                    where: { id: vincularDto.determinacao_judicial_id },
                });
                if (!determinacaoJudicial) {
                    throw new common_1.NotFoundException('Determinação judicial não encontrada');
                }
                // Verificar se a solicitação já tem esta determinação vinculada
                if (solicitacao.determinacao_judicial_id ===
                    vincularDto.determinacao_judicial_id) {
                    throw new common_1.ConflictException('Esta determinação judicial já está vinculada à solicitação');
                }
                // Atualizar a solicitação
                solicitacao.determinacao_judicial_id =
                    vincularDto.determinacao_judicial_id;
                // Registrar no histórico
                const historicoEntry = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: solicitacaoId,
                    status_anterior: solicitacao.status,
                    status_atual: solicitacao.status,
                    usuario_id: user.id,
                    observacao: vincularDto.observacao || 'Determinação judicial vinculada',
                    dados_alterados: {
                        determinacao_judicial: {
                            id: vincularDto.determinacao_judicial_id,
                            numero: determinacaoJudicial.numero_determinacao,
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                // Salvar as alterações
                await manager.save(solicitacao);
                await manager.save(historicoEntry);
                return this.findById(solicitacaoId);
            }
            catch (error) {
                if (error instanceof common_1.NotFoundException ||
                    error instanceof common_1.UnauthorizedException ||
                    error instanceof common_1.ConflictException) {
                    throw error;
                }
                this.logger.error(`Erro ao vincular determinação judicial: ${error.message}`, error.stack);
                throw new common_1.InternalServerErrorException('Erro ao vincular determinação judicial à solicitação');
            }
        });
    }
    /**
     * Desvincula uma determinação judicial de uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param user Usuário que está realizando a operação
     * @returns Solicitação atualizada
     */
    /**
     * Converte um cidadão da composição familiar para beneficiário principal de uma nova solicitação
     * @param converterPapelDto Dados para conversão de papel
     * @param user Usuário que está realizando a operação
     * @returns Nova solicitação criada
     */
    async converterPapel(converterPapelDto, user) {
        this.logger.log(`Iniciando conversão de papel para cidadão ${converterPapelDto.cidadao_id}`);
        return this.connection.transaction(async (manager) => {
            try {
                // Buscar a solicitação de origem
                const solicitacaoOrigem = await this.findById(converterPapelDto.solicitacao_origem_id);
                if (!solicitacaoOrigem) {
                    throw new common_1.NotFoundException('Solicitação de origem não encontrada');
                }
                // Verificar se o cidadão está na composição familiar da solicitação
                const composicaoFamiliar = solicitacaoOrigem.dados_complementares?.composicao_familiar || [];
                const membroIndex = composicaoFamiliar.findIndex((membro) => membro.cidadao_id === converterPapelDto.cidadao_id);
                if (membroIndex === -1) {
                    throw new common_1.BadRequestException('Cidadão não encontrado na composição familiar da solicitação de origem');
                }
                // Obter o membro e remover da composição familiar
                const membro = { ...composicaoFamiliar[membroIndex] };
                composicaoFamiliar.splice(membroIndex, 1);
                // Atualizar a solicitação de origem com a nova composição familiar
                solicitacaoOrigem.dados_complementares = {
                    ...solicitacaoOrigem.dados_complementares,
                    composicao_familiar: composicaoFamiliar,
                };
                await manager.save(solicitacaoOrigem);
                // Criar uma nova solicitação com o cidadão como beneficiário principal
                const novaSolicitacao = new entities_1.Solicitacao();
                novaSolicitacao.beneficiario_id = converterPapelDto.cidadao_id;
                novaSolicitacao.tipo_beneficio_id = converterPapelDto.tipo_beneficio_id;
                novaSolicitacao.unidade_id = converterPapelDto.unidade_id;
                novaSolicitacao.tecnico_id = user.id;
                novaSolicitacao.status = entities_1.StatusSolicitacao.RASCUNHO;
                novaSolicitacao.data_abertura = new Date();
                novaSolicitacao.solicitacao_original_id =
                    converterPapelDto.solicitacao_origem_id;
                novaSolicitacao.dados_complementares =
                    converterPapelDto.dados_complementares || {};
                // Adicionar observação sobre a conversão de papel
                novaSolicitacao.observacoes = `Solicitação criada a partir da conversão de papel. Justificativa: ${converterPapelDto.justificativa}`;
                await manager.save(novaSolicitacao);
                // Registrar no histórico da solicitação de origem
                const historicoOrigem = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: solicitacaoOrigem.id,
                    status_anterior: solicitacaoOrigem.status,
                    status_atual: solicitacaoOrigem.status,
                    usuario_id: user.id,
                    observacao: `Cidadão removido da composição familiar para se tornar beneficiário principal em nova solicitação (${novaSolicitacao.protocolo})`,
                    dados_alterados: {
                        composicao_familiar: {
                            acao: 'remocao_membro',
                            cidadao_id: converterPapelDto.cidadao_id,
                            nova_solicitacao_id: novaSolicitacao.id,
                            nova_solicitacao_protocolo: novaSolicitacao.protocolo,
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                await manager.save(historicoOrigem);
                // Registrar no histórico da nova solicitação
                const historicoNova = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: novaSolicitacao.id,
                    status_anterior: entities_1.StatusSolicitacao.RASCUNHO,
                    status_atual: entities_1.StatusSolicitacao.RASCUNHO,
                    usuario_id: user.id,
                    observacao: `Solicitação criada a partir da conversão de papel do cidadão que estava na composição familiar da solicitação ${solicitacaoOrigem.protocolo}`,
                    dados_alterados: {
                        conversao_papel: {
                            solicitacao_origem_id: solicitacaoOrigem.id,
                            solicitacao_origem_protocolo: solicitacaoOrigem.protocolo,
                            justificativa: converterPapelDto.justificativa,
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                await manager.save(historicoNova);
                this.logger.log(`Conversão de papel concluída com sucesso. Nova solicitação: ${novaSolicitacao.id}`);
                return this.findById(novaSolicitacao.id);
            }
            catch (error) {
                if (error instanceof common_1.NotFoundException ||
                    error instanceof common_1.UnauthorizedException ||
                    error instanceof common_1.BadRequestException) {
                    throw error;
                }
                this.logger.error(`Erro ao converter papel do cidadão: ${error.message}`, error.stack);
                throw new common_1.InternalServerErrorException('Erro ao converter papel do cidadão para beneficiário principal');
            }
        });
    }
    async desvincularDeterminacaoJudicial(solicitacaoId, user) {
        return this.connection.transaction(async (manager) => {
            try {
                // Verificar se a solicitação existe
                const solicitacao = await this.findById(solicitacaoId);
                // Verificar se o usuário tem permissão
                if (![roles_constants_1.ROLES.ADMIN, roles_constants_1.ROLES.GESTOR].includes(user.role)) {
                    throw new common_1.UnauthorizedException('Você não tem permissão para desvincular determinações judiciais');
                }
                // Verificar se a solicitação tem determinação vinculada
                if (!solicitacao.determinacao_judicial_id) {
                    throw new common_1.BadRequestException('Esta solicitação não possui determinação judicial vinculada');
                }
                // Guardar informação da determinação para o histórico
                const determinacaoJudicialId = solicitacao.determinacao_judicial_id;
                const determinacaoJudicial = await this.determinacaoJudicialRepository.findOne({
                    where: { id: determinacaoJudicialId },
                });
                // Atualizar a solicitação
                solicitacao.determinacao_judicial_id = null;
                // Registrar no histórico
                const historicoEntry = this.historicoRepository.create((0, enum_normalizer_util_1.normalizeEnumFields)({
                    solicitacao_id: solicitacaoId,
                    status_anterior: solicitacao.status,
                    status_atual: solicitacao.status,
                    usuario_id: user.id,
                    observacao: 'Determinação judicial desvinculada',
                    dados_alterados: {
                        determinacao_judicial: {
                            id: determinacaoJudicialId,
                            numero: determinacaoJudicial
                                ? determinacaoJudicial.numero_determinacao
                                : 'Desconhecida',
                            acao: 'removida',
                        },
                    },
                    ip_usuario: user.ip || '0.0.0.0',
                }));
                // Salvar as alterações
                await manager.save(solicitacao);
                await manager.save(historicoEntry);
                return this.findById(solicitacaoId);
            }
            catch (error) {
                if (error instanceof common_1.NotFoundException ||
                    error instanceof common_1.UnauthorizedException ||
                    error instanceof common_1.BadRequestException) {
                    throw error;
                }
                this.logger.error(`Erro ao desvincular determinação judicial: ${error.message}`, error.stack);
                throw new common_1.InternalServerErrorException('Erro ao desvincular determinação judicial da solicitação');
            }
        });
    }
};
exports.SolicitacaoService = SolicitacaoService;
exports.SolicitacaoService = SolicitacaoService = SolicitacaoService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(entities_1.Solicitacao)),
    __param(1, (0, typeorm_1.InjectRepository)(entities_1.HistoricoSolicitacao)),
    __param(2, (0, typeorm_1.InjectRepository)(entities_1.Pendencia)),
    __param(4, (0, typeorm_1.InjectRepository)(entities_1.DeterminacaoJudicial)),
    __param(6, (0, common_1.Inject)((0, common_1.forwardRef)(() => validacao_exclusividade_service_1.ValidacaoExclusividadeService))),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof processo_judicial_repository_1.ProcessoJudicialRepository !== "undefined" && processo_judicial_repository_1.ProcessoJudicialRepository) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _e : Object, typeof (_f = typeof typeorm_2.Connection !== "undefined" && typeorm_2.Connection) === "function" ? _f : Object, typeof (_g = typeof validacao_exclusividade_service_1.ValidacaoExclusividadeService !== "undefined" && validacao_exclusividade_service_1.ValidacaoExclusividadeService) === "function" ? _g : Object])
], SolicitacaoService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcc29saWNpdGFjYW8uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVV3QjtBQUN4Qiw2Q0FBbUQ7QUFDbkQscUNBQWlFO0FBQ2pFLGdEQVEyQjtBQUUzQiwwRUFBcUU7QUFHckUscUZBQWlGO0FBR2pGLDJHQUFzRztBQUN0RywrRUFBa0U7QUFDbEUsdUZBQWtGO0FBRWxGOzs7O0dBSUc7QUFFSSxJQUFNLGtCQUFrQiwwQkFBeEIsTUFBTSxrQkFBa0I7SUFLbkI7SUFHQTtJQUdBO0lBRUE7SUFHQTtJQUVBO0lBR0E7SUFwQk8sTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLG9CQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTlELFlBRVUscUJBQThDLEVBRzlDLG1CQUFxRCxFQUdyRCxtQkFBMEMsRUFFMUMsMEJBQXNELEVBR3RELDhCQUFnRSxFQUVoRSxVQUFzQixFQUd0Qiw2QkFBNEQ7UUFoQjVELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBeUI7UUFHOUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFrQztRQUdyRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXVCO1FBRTFDLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7UUFHdEQsbUNBQThCLEdBQTlCLDhCQUE4QixDQUFrQztRQUVoRSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBR3RCLGtDQUE2QixHQUE3Qiw2QkFBNkIsQ0FBK0I7SUFDbkUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQVViO1FBQ0MsTUFBTSxFQUNKLElBQUksR0FBRyxDQUFDLEVBQ1IsS0FBSyxHQUFHLEVBQUUsRUFDVixNQUFNLEVBQ04sVUFBVSxFQUNWLFlBQVksRUFDWixTQUFTLEVBQ1QsV0FBVyxFQUNYLFFB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QTBCLG9CQUExQix5REFBMEIsb0RBR3RCLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUU5QixvQkFBVSxvQkFBVixvQkFBVSxvREFHUywrREFBNkIsb0JBQTdCLCtEQUE2QjtHQXJCM0Qsa0JBQWtCLENBMC9COUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcc29saWNpdGFjYW8uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgVW5hdXRob3JpemVkRXhjZXB0aW9uLFxuICBDb25mbGljdEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbiAgTG9nZ2VyLFxuICBmb3J3YXJkUmVmLFxuICBJbmplY3QsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSwgQmV0d2VlbiwgSUxpa2UsIENvbm5lY3Rpb24gfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7XG4gIFNvbGljaXRhY2FvLFxuICBTdGF0dXNTb2xpY2l0YWNhbyxcbiAgSGlzdG9yaWNvU29saWNpdGFjYW8sXG4gIFByb2Nlc3NvSnVkaWNpYWwsXG4gIERldGVybWluYWNhb0p1ZGljaWFsLFxuICBTdGF0dXNQZW5kZW5jaWEsXG4gIFBlbmRlbmNpYSxcbn0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMnO1xuaW1wb3J0IHsgQ3JlYXRlU29saWNpdGFjYW9EdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLXNvbGljaXRhY2FvLmR0byc7XG5pbXBvcnQgeyBVcGRhdGVTb2xpY2l0YWNhb0R0byB9IGZyb20gJy4uL2R0by91cGRhdGUtc29saWNpdGFjYW8uZHRvJztcbmltcG9ydCB7IEF2YWxpYXJTb2xpY2l0YWNhb0R0byB9IGZyb20gJy4uL2R0by9hdmFsaWFyLXNvbGljaXRhY2FvLmR0byc7XG5pbXBvcnQgeyBWaW5jdWxhclByb2Nlc3NvSnVkaWNpYWxEdG8gfSBmcm9tICcuLi9kdG8vdmluY3VsYXItcHJvY2Vzc28tanVkaWNpYWwuZHRvJztcbmltcG9ydCB7IG5vcm1hbGl6ZUVudW1GaWVsZHMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvZW51bS1ub3JtYWxpemVyLnV0aWwnO1xuaW1wb3J0IHsgVmluY3VsYXJEZXRlcm1pbmFjYW9KdWRpY2lhbER0byB9IGZyb20gJy4uL2R0by92aW5jdWxhci1kZXRlcm1pbmFjYW8tanVkaWNpYWwuZHRvJztcbmltcG9ydCB7IENvbnZlcnRlclBhcGVsRHRvIH0gZnJvbSAnLi4vZHRvL2NvbnZlcnRlci1wYXBlbC5kdG8nO1xuaW1wb3J0IHsgUHJvY2Vzc29KdWRpY2lhbFJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9qdWRpY2lhbC9yZXBvc2l0b3JpZXMvcHJvY2Vzc28tanVkaWNpYWwucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBST0xFUyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9jb25zdGFudHMvcm9sZXMuY29uc3RhbnRzJztcbmltcG9ydCB7IFZhbGlkYWNhb0V4Y2x1c2l2aWRhZGVTZXJ2aWNlIH0gZnJvbSAnLi92YWxpZGFjYW8tZXhjbHVzaXZpZGFkZS5zZXJ2aWNlJztcblxuLyoqXG4gKiBTZXJ2acOnbyBkZSBTb2xpY2l0YcOnw7Vlc1xuICpcbiAqIFJlc3BvbnPDoXZlbCBwZWxhIGzDs2dpY2EgZGUgbmVnw7NjaW8gcmVsYWNpb25hZGEgw6BzIHNvbGljaXRhw6fDtWVzIGRlIGJlbmVmw61jaW9zXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTb2xpY2l0YWNhb1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoU29saWNpdGFjYW9TZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFNvbGljaXRhY2FvKVxuICAgIHByaXZhdGUgc29saWNpdGFjYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFNvbGljaXRhY2FvPixcblxuICAgIEBJbmplY3RSZXBvc2l0b3J5KEhpc3Rvcmljb1NvbGljaXRhY2FvKVxuICAgIHByaXZhdGUgaGlzdG9yaWNvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxIaXN0b3JpY29Tb2xpY2l0YWNhbz4sXG5cbiAgICBASW5qZWN0UmVwb3NpdG9yeShQZW5kZW5jaWEpXG4gICAgcHJpdmF0ZSBwZW5kZW5jaWFSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFBlbmRlbmNpYT4sXG5cbiAgICBwcml2YXRlIHByb2Nlc3NvSnVkaWNpYWxSZXBvc2l0b3J5OiBQcm9jZXNzb0p1ZGljaWFsUmVwb3NpdG9yeSxcblxuICAgIEBJbmplY3RSZXBvc2l0b3J5KERldGVybWluYWNhb0p1ZGljaWFsKVxuICAgIHByaXZhdGUgZGV0ZXJtaW5hY2FvSnVkaWNpYWxSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PERldGVybWluYWNhb0p1ZGljaWFsPixcblxuICAgIHByaXZhdGUgY29ubmVjdGlvbjogQ29ubmVjdGlvbixcblxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBWYWxpZGFjYW9FeGNsdXNpdmlkYWRlU2VydmljZSkpXG4gICAgcHJpdmF0ZSB2YWxpZGFjYW9FeGNsdXNpdmlkYWRlU2VydmljZTogVmFsaWRhY2FvRXhjbHVzaXZpZGFkZVNlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogTGlzdGEgdG9kYXMgYXMgc29saWNpdGHDp8O1ZXMgY29tIHBhZ2luYcOnw6NvIGUgZmlsdHJvc1xuICAgKi9cbiAgYXN5bmMgZmluZEFsbChvcHRpb25zOiB7XG4gICAgcGFnZT86IG51bWJlcjtcbiAgICBsaW1pdD86IG51bWJlcjtcbiAgICBzdGF0dXM/OiBTdGF0dXNTb2xpY2l0YWNhbztcbiAgICB1bmlkYWRlX2lkPzogc3RyaW5nO1xuICAgIGJlbmVmaWNpb19pZD86IHN0cmluZztcbiAgICBwcm90b2NvbG8/OiBzdHJpbmc7XG4gICAgZGF0YV9pbmljaW8/OiBzdHJpbmc7XG4gICAgZGF0YV9maW0/OiBzdHJpbmc7XG4gICAgdXNlcjogYW55O1xuICB9KSB7XG4gICAgY29uc3Qge1xuICAgICAgcGFnZSA9IDEsXG4gICAgICBsaW1pdCA9IDEwLFxuICAgICAgc3RhdHVzLFxuICAgICAgdW5pZGFkZV9pZCxcbiAgICAgIGJlbmVmaWNpb19pZCxcbiAgICAgIHByb3RvY29sbyxcbiAgICAgIGRhdGFfaW5pY2lvLFxuICAgICAgZGF0YV9maW0sXG4gICAgICB1c2VyLFxuICAgIH0gPSBvcHRpb25zO1xuXG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID1cbiAgICAgIHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmNyZWF0ZVF1ZXJ5QnVpbGRlcignc29saWNpdGFjYW8nKTtcblxuICAgIC8vIEpvaW5zIG5lY2Vzc8Ohcmlvc1xuICAgIHF1ZXJ5QnVpbGRlclxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby5iZW5lZmljaWFyaW8nLCAnYmVuZWZpY2lhcmlvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8udGlwb19iZW5lZmljaW8nLCAndGlwb19iZW5lZmljaW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby51bmlkYWRlJywgJ3VuaWRhZGUnKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby50ZWNuaWNvJywgJ3RlY25pY28nKTtcblxuICAgIC8vIEFwbGljYXIgZmlsdHJvc1xuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnc29saWNpdGFjYW8uc3RhdHVzID0gOnN0YXR1cycsIHsgc3RhdHVzIH0pO1xuICAgIH1cblxuICAgIC8vIEZpbHRybyBwb3IgdW5pZGFkZSBjb20gdmVyaWZpY2HDp8OjbyBkZSBwZXJtaXNzw6NvXG4gICAgaWYgKHVuaWRhZGVfaWQpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnc29saWNpdGFjYW8udW5pZGFkZV9pZCA9IDp1bmlkYWRlX2lkJywge1xuICAgICAgICB1bmlkYWRlX2lkLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICghW1JPTEVTLkFETUlOLCBST0xFUy5HRVNUT1JdLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcbiAgICAgIC8vIFVzdcOhcmlvcyBxdWUgbsOjbyBzw6NvIGFkbWluIG91IGdlc3RvciBTRU1UQVMgc8OzIHBvZGVtIHZlciBzb2xpY2l0YcOnw7VlcyBkYSBzdWEgdW5pZGFkZVxuICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKCdzb2xpY2l0YWNhby51bmlkYWRlX2lkID0gOnVuaWRhZGVfaWQnLCB7XG4gICAgICAgIHVuaWRhZGVfaWQ6IHVzZXIudW5pZGFkZV9pZCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChiZW5lZmljaW9faWQpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnc29saWNpdGFjYW8udGlwb19iZW5lZmljaW9faWQgPSA6YmVuZWZpY2lvX2lkJywge1xuICAgICAgICBiZW5lZmljaW9faWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocHJvdG9jb2xvKSB7XG4gICAgICBxdWVyeUJ1aWxkZXIuYW5kV2hlcmUoJ3NvbGljaXRhY2FvLnByb3RvY29sbyBJTElLRSA6cHJvdG9jb2xvJywge1xuICAgICAgICBwcm90b2NvbG86IGAlJHtwcm90b2NvbG99JWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBGaWx0cm8gcG9yIHBlcsOtb2RvXG4gICAgaWYgKGRhdGFfaW5pY2lvICYmIGRhdGFfZmltKSB7XG4gICAgICBjb25zdCBpbmljaW8gPSBuZXcgRGF0ZShkYXRhX2luaWNpbyk7XG4gICAgICBjb25zdCBmaW0gPSBuZXcgRGF0ZShkYXRhX2ZpbSk7XG4gICAgICBmaW0uc2V0SG91cnMoMjMsIDU5LCA1OSwgOTk5KTsgLy8gQWp1c3RhIHBhcmEgbyBmaW5hbCBkbyBkaWFcblxuICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKFxuICAgICAgICAnc29saWNpdGFjYW8uZGF0YV9hYmVydHVyYSBCRVRXRUVOIDppbmljaW8gQU5EIDpmaW0nLFxuICAgICAgICB7XG4gICAgICAgICAgaW5pY2lvLFxuICAgICAgICAgIGZpbSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChkYXRhX2luaWNpbykge1xuICAgICAgY29uc3QgaW5pY2lvID0gbmV3IERhdGUoZGF0YV9pbmljaW8pO1xuICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKCdzb2xpY2l0YWNhby5kYXRhX2FiZXJ0dXJhID49IDppbmljaW8nLCB7IGluaWNpbyB9KTtcbiAgICB9IGVsc2UgaWYgKGRhdGFfZmltKSB7XG4gICAgICBjb25zdCBmaW0gPSBuZXcgRGF0ZShkYXRhX2ZpbSk7XG4gICAgICBmaW0uc2V0SG91cnMoMjMsIDU5LCA1OSwgOTk5KTsgLy8gQWp1c3RhIHBhcmEgbyBmaW5hbCBkbyBkaWFcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnc29saWNpdGFjYW8uZGF0YV9hYmVydHVyYSA8PSA6ZmltJywgeyBmaW0gfSk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXIgcGFnaW5hw6fDo29cbiAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuICAgIHF1ZXJ5QnVpbGRlci5za2lwKHNraXApLnRha2UobGltaXQpO1xuXG4gICAgLy8gT3JkZW5hw6fDo28gcGFkcsOjb1xuICAgIHF1ZXJ5QnVpbGRlci5vcmRlckJ5KCdzb2xpY2l0YWNhby5kYXRhX2FiZXJ0dXJhJywgJ0RFU0MnKTtcblxuICAgIC8vIEV4ZWN1dGFyIGNvbnN1bHRhXG4gICAgY29uc3QgW2l0ZW1zLCB0b3RhbF0gPSBhd2FpdCBxdWVyeUJ1aWxkZXIuZ2V0TWFueUFuZENvdW50KCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXRlbXMsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIGN1cnJlbnRQYWdlOiBwYWdlLFxuICAgICAgICBpdGVtc1BlclBhZ2U6IGxpbWl0LFxuICAgICAgICB0b3RhbEl0ZW1zOiB0b3RhbCxcbiAgICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gbGltaXQpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtYSBzb2xpY2l0YcOnw6NvIHBlbG8gSURcbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICByZWxhdGlvbnM6IFsnYmVuZWZpY2lhcmlvJywgJ3RpcG9fYmVuZWZpY2lvJywgJ3VuaWRhZGUnLCAndGVjbmljbyddLFxuICAgIH0pO1xuXG4gICAgaWYgKCFzb2xpY2l0YWNhbykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTb2xpY2l0YcOnw6NvIGNvbSBJRCAke2lkfSBuw6NvIGVuY29udHJhZGFgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc29saWNpdGFjYW87XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bWEgbm92YSBzb2xpY2l0YcOnw6NvXG4gICAqL1xuICBhc3luYyBjcmVhdGUoXG4gICAgY3JlYXRlU29saWNpdGFjYW9EdG86IENyZWF0ZVNvbGljaXRhY2FvRHRvLFxuICAgIHVzZXI6IGFueSxcbiAgKTogUHJvbWlzZTxTb2xpY2l0YWNhbz4ge1xuICAgIC8vIFZhbGlkYXIgZXhjbHVzaXZpZGFkZSBkZSBwYXBlbCBwYXJhIG8gYmVuZWZpY2nDoXJpb1xuICAgIGF3YWl0IHRoaXMudmFsaWRhY2FvRXhjbHVzaXZpZGFkZVNlcnZpY2UudmFsaWRhckV4Y2x1c2l2aWRhZGVCZW5lZmljaWFyaW8oXG4gICAgICBjcmVhdGVTb2xpY2l0YWNhb0R0by5iZW5lZmljaWFyaW9faWQsXG4gICAgKTtcblxuICAgIC8vIFNlIHRpdmVyIGNvbXBvc2nDp8OjbyBmYW1pbGlhciwgdmFsaWRhciBwYXJhIGNhZGEgbWVtYnJvXG4gICAgaWYgKFxuICAgICAgY3JlYXRlU29saWNpdGFjYW9EdG8uZGFkb3NfY29tcGxlbWVudGFyZXMgJiZcbiAgICAgIGNyZWF0ZVNvbGljaXRhY2FvRHRvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLmNvbXBvc2ljYW9fZmFtaWxpYXIgJiZcbiAgICAgIEFycmF5LmlzQXJyYXkoXG4gICAgICAgIGNyZWF0ZVNvbGljaXRhY2FvRHRvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLmNvbXBvc2ljYW9fZmFtaWxpYXIsXG4gICAgICApICYmXG4gICAgICBjcmVhdGVTb2xpY2l0YWNhb0R0by5kYWRvc19jb21wbGVtZW50YXJlcy5jb21wb3NpY2FvX2ZhbWlsaWFyLmxlbmd0aCA+IDBcbiAgICApIHtcbiAgICAgIGNvbnN0IGNvbXBvc2ljYW9GYW1pbGlhciA9XG4gICAgICAgIGNyZWF0ZVNvbGljaXRhY2FvRHRvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLmNvbXBvc2ljYW9fZmFtaWxpYXIubWFwKFxuICAgICAgICAgIChtZW1icm8pID0+IG1lbWJyby5jaWRhZGFvX2lkLFxuICAgICAgICApO1xuICAgICAgYXdhaXQgdGhpcy52YWxpZGFjYW9FeGNsdXNpdmlkYWRlU2VydmljZS52YWxpZGFyQ29tcG9zaWNhb0ZhbWlsaWFyQ29tcGxldGEoXG4gICAgICAgIGNvbXBvc2ljYW9GYW1pbGlhcixcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb24udHJhbnNhY3Rpb24oYXN5bmMgKG1hbmFnZXIpID0+IHtcbiAgICAgIC8vIENyaWFyIHVtYSBub3ZhIGluc3TDom5jaWEgZGUgU29saWNpdGFjYW9cbiAgICAgIGNvbnN0IHNvbGljaXRhY2FvID0gbmV3IFNvbGljaXRhY2FvKCk7XG5cbiAgICAgIC8vIERldGVybWluYXIgYSB1bmlkYWRlOiBzZSB1c3XDoXJpbyBuw6NvIHRlbSB1bmlkYWRlLCB1c2FyIGRvIERUTyAob2JyaWdhdMOzcmlvKVxuICAgICAgbGV0IHVuaWRhZGVJZDogc3RyaW5nO1xuICAgICAgaWYgKCF1c2VyLnVuaWRhZGVfaWQpIHtcbiAgICAgICAgaWYgKCFjcmVhdGVTb2xpY2l0YWNhb0R0by51bmlkYWRlX2lkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICAnVXN1w6FyaW8gbsOjbyBwb3NzdWkgdW5pZGFkZSB2aW5jdWxhZGEuIE8gY2FtcG8gdW5pZGFkZV9pZCDDqSBvYnJpZ2F0w7NyaW8uJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHVuaWRhZGVJZCA9IGNyZWF0ZVNvbGljaXRhY2FvRHRvLnVuaWRhZGVfaWQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1bmlkYWRlSWQgPSB1c2VyLnVuaWRhZGVfaWQ7XG4gICAgICB9XG5cbiAgICAgIC8vIFByZWVuY2hlciBvcyBkYWRvcyBiw6FzaWNvc1xuICAgICAgc29saWNpdGFjYW8uYmVuZWZpY2lhcmlvX2lkID0gY3JlYXRlU29saWNpdGFjYW9EdG8uYmVuZWZpY2lhcmlvX2lkO1xuICAgICAgc29saWNpdGFjYW8udGlwb19iZW5lZmljaW9faWQgPSBjcmVhdGVTb2xpY2l0YWNhb0R0by50aXBvX2JlbmVmaWNpb19pZDtcbiAgICAgIHNvbGljaXRhY2FvLnVuaWRhZGVfaWQgPSB1bmlkYWRlSWQ7XG4gICAgICBzb2xpY2l0YWNhby50ZWNuaWNvX2lkID0gdXNlci5pZDtcbiAgICAgIHNvbGljaXRhY2FvLnN0YXR1cyA9IFN0YXR1c1NvbGljaXRhY2FvLlJBU0NVTkhPO1xuICAgICAgc29saWNpdGFjYW8uZGF0YV9hYmVydHVyYSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIC8vIE5vcm1hbGl6YXIgZW51bXMgbm9zIGRhZG9zIGNvbXBsZW1lbnRhcmVzIGFudGVzIGRlIHNhbHZhclxuICAgICAgY29uc3QgZGFkb3NDb21wbGVtZW50YXJlcyA9XG4gICAgICAgIGNyZWF0ZVNvbGljaXRhY2FvRHRvLmRhZG9zX2NvbXBsZW1lbnRhcmVzIHx8IHt9O1xuICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMgPVxuICAgICAgICBub3JtYWxpemVFbnVtRmllbGRzKGRhZG9zQ29tcGxlbWVudGFyZXMpO1xuXG4gICAgICAvLyBTYWx2YXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgICBjb25zdCBzYXZlZFNvbGljaXRhY2FvID0gYXdhaXQgbWFuYWdlci5zYXZlKHNvbGljaXRhY2FvKTtcblxuICAgICAgLy8gUmVnaXN0cmFyIG5vIGhpc3TDs3JpY29cbiAgICAgIGNvbnN0IGhpc3RvcmljbyA9IG5ldyBIaXN0b3JpY29Tb2xpY2l0YWNhbygpO1xuICAgICAgaGlzdG9yaWNvLnNvbGljaXRhY2FvX2lkID0gc2F2ZWRTb2xpY2l0YWNhby5pZDtcbiAgICAgIGhpc3Rvcmljby51c3VhcmlvX2lkID0gdXNlci5pZDtcbiAgICAgIGhpc3Rvcmljby5zdGF0dXNfYW50ZXJpb3IgPSBTdGF0dXNTb2xpY2l0YWNhby5BQkVSVEE7XG4gICAgICBoaXN0b3JpY28uc3RhdHVzX2F0dWFsID0gU3RhdHVzU29saWNpdGFjYW8uQUJFUlRBO1xuICAgICAgaGlzdG9yaWNvLm9ic2VydmFjYW8gPSAnU29saWNpdGHDp8OjbyBjcmlhZGEnO1xuICAgICAgaGlzdG9yaWNvLmRhZG9zX2FsdGVyYWRvcyA9IHsgYWNhbzogJ2NyaWFjYW8nIH07XG4gICAgICBoaXN0b3JpY28uaXBfdXN1YXJpbyA9IHVzZXIuaXAgfHwgJzAuMC4wLjAnO1xuXG4gICAgICBhd2FpdCBtYW5hZ2VyLnNhdmUoaGlzdG9yaWNvKTtcblxuICAgICAgLy8gQnVzY2FyIGEgc29saWNpdGHDp8OjbyBjcmlhZGEgZGVudHJvIGRhIHRyYW5zYcOnw6NvIGNvbSByZWxhw6fDtWVzIGVzc2VuY2lhaXNcbiAgICAgIGNvbnN0IHNvbGljaXRhY2FvQ29tcGxldGEgPSBhd2FpdCBtYW5hZ2VyLmZpbmRPbmUoU29saWNpdGFjYW8sIHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHNhdmVkU29saWNpdGFjYW8uaWQgfSxcbiAgICAgICAgcmVsYXRpb25zOiBbXG4gICAgICAgICAgJ2JlbmVmaWNpYXJpbycsXG4gICAgICAgICAgJ3RpcG9fYmVuZWZpY2lvJyxcbiAgICAgICAgICAndW5pZGFkZScsXG4gICAgICAgICAgJ3RlY25pY28nLFxuICAgICAgICAgICdoaXN0b3JpY28nLFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghc29saWNpdGFjYW9Db21wbGV0YSkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgICAgYFNvbGljaXRhw6fDo28gY29tIElEICR7c2F2ZWRTb2xpY2l0YWNhby5pZH0gbsOjbyBlbmNvbnRyYWRhIGFww7NzIGNyaWHDp8Ojb2AsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzb2xpY2l0YWNhb0NvbXBsZXRhO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIHVtYSBzb2xpY2l0YcOnw6NvIGV4aXN0ZW50ZVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlU29saWNpdGFjYW9EdG86IFVwZGF0ZVNvbGljaXRhY2FvRHRvLFxuICAgIHVzZXI6IGFueSxcbiAgKTogUHJvbWlzZTxTb2xpY2l0YWNhbz4ge1xuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb24udHJhbnNhY3Rpb24oYXN5bmMgKG1hbmFnZXIpID0+IHtcbiAgICAgIC8vIEJ1c2NhciBhIHNvbGljaXRhw6fDo29cbiAgICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5maW5kQnlJZChpZCk7XG5cbiAgICAgIC8vIENoZWNrIGlmIHJlcXVlc3Qgc3RhdHVzIGFsbG93cyBlZGl0aW5nIGJhc2VkIG9uIGJ1c2luZXNzIHJ1bGVzXG4gICAgICBjb25zdCBFRElUQUJMRV9TVEFUVVNFUyA9IFtcbiAgICAgICAgU3RhdHVzU29saWNpdGFjYW8uQUJFUlRBLFxuICAgICAgICBTdGF0dXNTb2xpY2l0YWNhby5QRU5ERU5URSxcbiAgICAgIF07XG5cbiAgICAgIGlmICghRURJVEFCTEVfU1RBVFVTRVMuaW5jbHVkZXMoc29saWNpdGFjYW8uc3RhdHVzKSkge1xuICAgICAgICBjb25zdCBzdGF0dXNNZXNzYWdlID0gYFN0YXR1cyBhdHVhbDogJHtzb2xpY2l0YWNhby5zdGF0dXN9YDtcbiAgICAgICAgY29uc3QgYWxsb3dlZE1lc3NhZ2UgPSBgU3RhdHVzIGRpc3BvbsOtdmVpczogJHtFRElUQUJMRV9TVEFUVVNFUy5qb2luKCcsICcpfWA7XG5cbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBIHNvbGljaXRhw6fDo28gbsOjbyBwb2RlIHNlciBlZGl0YWRvIG5lc3RlIHN0YXR1cy4nLFxuICAgICAgICAgIGRldGFsaGVzOiB7XG4gICAgICAgICAgICBzdGF0dXNBdHVhbDogc29saWNpdGFjYW8uc3RhdHVzLFxuICAgICAgICAgICAgc3RhdHVzUG9zc2l2ZWlzOiBFRElUQUJMRV9TVEFUVVNFUyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbnRleHRvOiBgJHtzdGF0dXNNZXNzYWdlfS4gJHthbGxvd2VkTWVzc2FnZX1gLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQXR1YWxpemFyIG9zIGRhZG9zXG4gICAgICAvLyBOb3RhOiBiZW5lZmljaWFyaW9faWQgbsOjbyBwb2RlIHNlciBhdHVhbGl6YWRvIGNvbmZvcm1lIGRlZmluaWRvIG5vIERUT1xuXG4gICAgICBpZiAodXBkYXRlU29saWNpdGFjYW9EdG8udGlwb19iZW5lZmljaW9faWQpIHtcbiAgICAgICAgc29saWNpdGFjYW8udGlwb19iZW5lZmljaW9faWQgPSB1cGRhdGVTb2xpY2l0YWNhb0R0by50aXBvX2JlbmVmaWNpb19pZDtcbiAgICAgIH1cblxuICAgICAgaWYgKHVwZGF0ZVNvbGljaXRhY2FvRHRvLmRhZG9zX2NvbXBsZW1lbnRhcmVzKSB7XG4gICAgICAgIC8vIE5vcm1hbGl6YXIgZW51bXMgbm9zIGRhZG9zIGNvbXBsZW1lbnRhcmVzIGFudGVzIGRlIHNhbHZhclxuICAgICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcyA9IG5vcm1hbGl6ZUVudW1GaWVsZHMoXG4gICAgICAgICAgdXBkYXRlU29saWNpdGFjYW9EdG8uZGFkb3NfY29tcGxlbWVudGFyZXMsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNhbHZhciBhIHNvbGljaXRhw6fDo29cbiAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShzb2xpY2l0YWNhbyk7XG5cbiAgICAgIC8vIFJlZ2lzdHJhciBubyBoaXN0w7NyaWNvXG4gICAgICBjb25zdCBoaXN0b3JpY28gPSBuZXcgSGlzdG9yaWNvU29saWNpdGFjYW8oKTtcbiAgICAgIGhpc3Rvcmljby5zb2xpY2l0YWNhb19pZCA9IGlkO1xuICAgICAgaGlzdG9yaWNvLnVzdWFyaW9faWQgPSB1c2VyLmlkO1xuICAgICAgaGlzdG9yaWNvLnN0YXR1c19hbnRlcmlvciA9IHNvbGljaXRhY2FvLnN0YXR1cztcbiAgICAgIGhpc3Rvcmljby5zdGF0dXNfYXR1YWwgPSBzb2xpY2l0YWNhby5zdGF0dXM7XG4gICAgICBoaXN0b3JpY28ub2JzZXJ2YWNhbyA9ICdTb2xpY2l0YcOnw6NvIGF0dWFsaXphZGEnO1xuICAgICAgaGlzdG9yaWNvLmRhZG9zX2FsdGVyYWRvcyA9IHtcbiAgICAgICAgY2FtcG9zX2FsdGVyYWRvczogT2JqZWN0LmtleXModXBkYXRlU29saWNpdGFjYW9EdG8pLFxuICAgICAgfTtcbiAgICAgIGhpc3Rvcmljby5pcF91c3VhcmlvID0gdXNlci5pcCB8fCAnMC4wLjAuMCc7XG5cbiAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShoaXN0b3JpY28pO1xuXG4gICAgICByZXR1cm4gdGhpcy5maW5kQnlJZChpZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU3VibWV0ZSB1bWEgc29saWNpdGHDp8OjbyBwYXJhIGFuw6FsaXNlXG4gICAqL1xuICBhc3luYyBzdWJtZXRlclNvbGljaXRhY2FvKGlkOiBzdHJpbmcsIHVzZXI6IGFueSk6IFByb21pc2U8U29saWNpdGFjYW8+IHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAvLyBCdXNjYXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoaWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGVzdMOhIGVtIGVzdGFkbyBxdWUgcGVybWl0ZSBzdWJtaXNzw6NvXG4gICAgICBpZiAoc29saWNpdGFjYW8uc3RhdHVzICE9PSBTdGF0dXNTb2xpY2l0YWNhby5SQVNDVU5ITykge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICBgTsOjbyDDqSBwb3Nzw612ZWwgc3VibWV0ZXIgdW1hIHNvbGljaXRhw6fDo28gY29tIHN0YXR1cyAke3NvbGljaXRhY2FvLnN0YXR1c31gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBBdHVhbGl6YXIgbyBzdGF0dXMgdXNhbmRvIG8gbcOpdG9kbyBwcmVwYXJhclxuICAgICAgc29saWNpdGFjYW8ucHJlcGFyYXJBbHRlcmFjYW9TdGF0dXMoXG4gICAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkVNX0FOQUxJU0UsXG4gICAgICAgIHVzZXIuaWQsXG4gICAgICAgICdTb2xpY2l0YcOnw6NvIHN1Ym1ldGlkYSBwYXJhIGFuw6FsaXNlJyxcbiAgICAgICAgdXNlci5pcCB8fCAnMC4wLjAuMCcsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBtYW5hZ2VyLnNhdmUoc29saWNpdGFjYW8pO1xuXG4gICAgICAvLyBSZWdpc3RlciBpbiBoaXN0b3J5XG4gICAgICBjb25zdCBoaXN0b3JpY28gPSBuZXcgSGlzdG9yaWNvU29saWNpdGFjYW8oKTtcbiAgICAgIGhpc3Rvcmljby5zb2xpY2l0YWNhb19pZCA9IGlkO1xuICAgICAgaGlzdG9yaWNvLnVzdWFyaW9faWQgPSB1c2VyLmlkO1xuICAgICAgaGlzdG9yaWNvLnN0YXR1c19hbnRlcmlvciA9IFN0YXR1c1NvbGljaXRhY2FvLlJBU0NVTkhPO1xuICAgICAgaGlzdG9yaWNvLnN0YXR1c19hdHVhbCA9IHNvbGljaXRhY2FvLnN0YXR1cztcbiAgICAgIGhpc3Rvcmljby5vYnNlcnZhY2FvID0gJ1NvbGljaXRhw6fDo28gc3VibWV0aWRhIHBhcmEgYW7DoWxpc2UnO1xuICAgICAgaGlzdG9yaWNvLmRhZG9zX2FsdGVyYWRvcyA9IHtcbiAgICAgICAgY2FtcG9zX2FsdGVyYWRvczogT2JqZWN0LmtleXMoVXBkYXRlU29saWNpdGFjYW9EdG8pLFxuICAgICAgfTtcbiAgICAgIGhpc3Rvcmljby5pcF91c3VhcmlvID0gdXNlci5pcCB8fCAnMC4wLjAuMCc7XG5cbiAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShoaXN0b3JpY28pO1xuXG4gICAgICByZXR1cm4gdGhpcy5maW5kQnlJZChpZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQXZhbGlhIHVtYSBzb2xpY2l0YcOnw6NvIChhcHJvdmFyL3BlbmRlbmNpYXIpXG4gICAqL1xuICBhc3luYyBhdmFsaWFyU29saWNpdGFjYW8oXG4gICAgaWQ6IHN0cmluZyxcbiAgICBhdmFsaWFyU29saWNpdGFjYW9EdG86IEF2YWxpYXJTb2xpY2l0YWNhb0R0byxcbiAgICB1c2VyOiBhbnksXG4gICk6IFByb21pc2U8U29saWNpdGFjYW8+IHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAvLyBCdXNjYXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoaWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGVzdMOhIGVtIGVzdGFkbyBxdWUgcGVybWl0ZSBhdmFsaWHDp8Ojb1xuICAgICAgaWYgKFxuICAgICAgICBzb2xpY2l0YWNhby5zdGF0dXMgIT09IFN0YXR1c1NvbGljaXRhY2FvLlBFTkRFTlRFICYmXG4gICAgICAgIHNvbGljaXRhY2FvLnN0YXR1cyAhPT0gU3RhdHVzU29saWNpdGFjYW8uRU1fQU5BTElTRVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgIGBOw6NvIMOpIHBvc3PDrXZlbCBhdmFsaWFyIHVtYSBzb2xpY2l0YcOnw6NvIGNvbSBzdGF0dXMgJHtzb2xpY2l0YWNhby5zdGF0dXN9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gRGV0ZXJtaW5hciBvIG5vdm8gc3RhdHVzXG4gICAgICBjb25zdCBub3ZvU3RhdHVzID0gYXZhbGlhclNvbGljaXRhY2FvRHRvLmFwcm92YWRvXG4gICAgICAgID8gU3RhdHVzU29saWNpdGFjYW8uQVBST1ZBREFcbiAgICAgICAgOiBTdGF0dXNTb2xpY2l0YWNhby5BR1VBUkRBTkRPX0RPQ1VNRU5UT1M7XG5cbiAgICAgIC8vIEF0dWFsaXphciBvIHN0YXR1cyB1c2FuZG8gbyBtw6l0b2RvIHByZXBhcmFyXG4gICAgICBzb2xpY2l0YWNhby5wcmVwYXJhckFsdGVyYWNhb1N0YXR1cyhcbiAgICAgICAgbm92b1N0YXR1cyxcbiAgICAgICAgdXNlci5pZCxcbiAgICAgICAgYXZhbGlhclNvbGljaXRhY2FvRHRvLnBhcmVjZXIsXG4gICAgICAgIHVzZXIuaXAgfHwgJzAuMC4wLjAnLFxuICAgICAgKTtcblxuICAgICAgaWYgKGF2YWxpYXJTb2xpY2l0YWNhb0R0by5hcHJvdmFkbykge1xuICAgICAgICBzb2xpY2l0YWNhby5hcHJvdmFkb3JfaWQgPSB1c2VyLmlkO1xuICAgICAgICBzb2xpY2l0YWNhby5kYXRhX2Fwcm92YWNhbyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHNvbGljaXRhY2FvLnBhcmVjZXJfc2VtdGFzID0gYXZhbGlhclNvbGljaXRhY2FvRHRvLnBhcmVjZXI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBSZWdpc3RyYXIgcGVuZMOqbmNpYXNcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGF2YWxpYXJTb2xpY2l0YWNhb0R0by5wZW5kZW5jaWFzICYmXG4gICAgICAgICAgYXZhbGlhclNvbGljaXRhY2FvRHRvLnBlbmRlbmNpYXMubGVuZ3RoID4gMFxuICAgICAgICApIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGRlc2NyaWNhb1RleHRvIG9mIGF2YWxpYXJTb2xpY2l0YWNhb0R0by5wZW5kZW5jaWFzKSB7XG4gICAgICAgICAgICAvLyBDcmlhciB1bWEgbm92YSBpbnN0w6JuY2lhIGRlIFBlbmRlbmNpYSBkaXJldGFtZW50ZSBwYXJhIGV2aXRhciBwcm9ibGVtYXMgZGUgdGlwYWdlbVxuICAgICAgICAgICAgY29uc3QgcGVuZGVuY2lhID0gbmV3IFBlbmRlbmNpYSgpO1xuICAgICAgICAgICAgcGVuZGVuY2lhLnNvbGljaXRhY2FvX2lkID0gaWQ7XG4gICAgICAgICAgICBwZW5kZW5jaWEuZGVzY3JpY2FvID0gZGVzY3JpY2FvVGV4dG87XG4gICAgICAgICAgICBwZW5kZW5jaWEuc3RhdHVzID0gU3RhdHVzUGVuZGVuY2lhLkFCRVJUQTtcbiAgICAgICAgICAgIHBlbmRlbmNpYS5yZWdpc3RyYWRvX3Bvcl9pZCA9IHVzZXIuaWQ7IC8vIFVzYW5kbyByZWdpc3RyYWRvX3Bvcl9pZCBjb25mb3JtZSBkZWZpbmlkbyBuYSBlbnRpZGFkZVxuXG4gICAgICAgICAgICBhd2FpdCBtYW5hZ2VyLnNhdmUocGVuZGVuY2lhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gU2FsdmFyIGEgc29saWNpdGHDp8OjbyBjb20gbyBtYW5hZ2VyIGRhIHRyYW5zYcOnw6NvXG4gICAgICBhd2FpdCBtYW5hZ2VyLnNhdmUoc29saWNpdGFjYW8pO1xuXG4gICAgICAvLyBOw6NvIMOpIG1haXMgbmVjZXNzw6FyaW8gcmVnaXN0cmFyIG1hbnVhbG1lbnRlIG5vIGhpc3TDs3JpY29cbiAgICAgIC8vIE8gbcOpdG9kbyBsb2dTdGF0dXNDaGFuZ2UgZmFyw6EgaXNzbyBhdXRvbWF0aWNhbWVudGUgYXRyYXbDqXMgZG8gbGlzdGVuZXIgQEFmdGVyVXBkYXRlXG5cbiAgICAgIHJldHVybiB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaWJlcmEgdW0gYmVuZWbDrWNpbyBhcHJvdmFkb1xuICAgKi9cbiAgYXN5bmMgbGliZXJhckJlbmVmaWNpbyhpZDogc3RyaW5nLCB1c2VyOiBhbnkpOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbi50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgLy8gQnVzY2FyIGEgc29saWNpdGHDp8Ojb1xuICAgICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gdXN1w6FyaW8gdGVtIHBlcm1pc3PDo29cbiAgICAgIGlmICghW1JPTEVTLkFETUlOLCBST0xFUy5HRVNUT1JdLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgICAnVm9jw6ogbsOjbyB0ZW0gcGVybWlzc8OjbyBwYXJhIGxpYmVyYXIgYmVuZWbDrWNpb3MnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGVzdMOhIGFwcm92YWRhXG4gICAgICBpZiAoc29saWNpdGFjYW8uc3RhdHVzICE9PSBTdGF0dXNTb2xpY2l0YWNhby5BUFJPVkFEQSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnQXBlbmFzIHNvbGljaXRhw6fDtWVzIGFwcm92YWRhcyBwb2RlbSBzZXIgbGliZXJhZGFzJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXR1YWxpemFyIG8gc3RhdHVzIHVzYW5kbyBvIG3DqXRvZG8gcHJlcGFyYXJcbiAgICAgIHNvbGljaXRhY2FvLnByZXBhcmFyQWx0ZXJhY2FvU3RhdHVzKFxuICAgICAgICBTdGF0dXNTb2xpY2l0YWNhby5MSUJFUkFEQSxcbiAgICAgICAgdXNlci5pZCxcbiAgICAgICAgJ0JlbmVmw61jaW8gbGliZXJhZG8gcGFyYSBwYWdhbWVudG8vZW50cmVnYScsXG4gICAgICAgIHVzZXIuaXAgfHwgJzAuMC4wLjAnLFxuICAgICAgKTtcbiAgICAgIHNvbGljaXRhY2FvLmxpYmVyYWRvcl9pZCA9IHVzZXIuaWQ7XG4gICAgICBzb2xpY2l0YWNhby5kYXRhX2xpYmVyYWNhbyA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIC8vIFNhbHZhciBhIHNvbGljaXRhw6fDo28gY29tIG8gbWFuYWdlciBkYSB0cmFuc2HDp8Ojb1xuICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKHNvbGljaXRhY2FvKTtcblxuICAgICAgLy8gTsOjbyDDqSBtYWlzIG5lY2Vzc8OhcmlvIHJlZ2lzdHJhciBtYW51YWxtZW50ZSBubyBoaXN0w7NyaWNvXG4gICAgICAvLyBPIG3DqXRvZG8gbG9nU3RhdHVzQ2hhbmdlIGZhcsOhIGlzc28gYXV0b21hdGljYW1lbnRlIGF0cmF2w6lzIGRvIGxpc3RlbmVyIEBBZnRlclVwZGF0ZVxuXG4gICAgICByZXR1cm4gdGhpcy5maW5kQnlJZChpZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FuY2VsYSB1bWEgc29saWNpdGHDp8Ojb1xuICAgKi9cbiAgYXN5bmMgY2FuY2VsYXJTb2xpY2l0YWNhbyhpZDogc3RyaW5nLCB1c2VyOiBhbnkpOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbi50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgLy8gQnVzY2FyIGEgc29saWNpdGHDp8Ojb1xuICAgICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gdXN1w6FyaW8gdGVtIHBlcm1pc3PDo29cbiAgICAgIGlmICghW1JPTEVTLkFETUlOLCBST0xFUy5HRVNUT1IsIFJPTEVTLlRFQ05JQ09dLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgICAnVm9jw6ogbsOjbyB0ZW0gcGVybWlzc8OjbyBwYXJhIGNhbmNlbGFyIHNvbGljaXRhw6fDtWVzJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgc29saWNpdGHDp8OjbyBwb2RlIHNlciBjYW5jZWxhZGFcbiAgICAgIGlmIChzb2xpY2l0YWNhby5zdGF0dXMgPT09IFN0YXR1c1NvbGljaXRhY2FvLkxJQkVSQURBKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICdOw6NvIMOpIHBvc3PDrXZlbCBjYW5jZWxhciB1bWEgc29saWNpdGHDp8OjbyBqw6EgbGliZXJhZGEnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBBdHVhbGl6YXIgbyBzdGF0dXMgdXNhbmRvIG8gbcOpdG9kbyBwcmVwYXJhclxuICAgICAgc29saWNpdGFjYW8ucHJlcGFyYXJBbHRlcmFjYW9TdGF0dXMoXG4gICAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkNBTkNFTEFEQSxcbiAgICAgICAgdXNlci5pZCxcbiAgICAgICAgJ1NvbGljaXRhw6fDo28gY2FuY2VsYWRhIHBlbG8gdXN1w6FyaW8nLFxuICAgICAgICB1c2VyLmlwIHx8ICcwLjAuMC4wJyxcbiAgICAgICk7XG5cbiAgICAgIC8vIFNhbHZhciBhIHNvbGljaXRhw6fDo28gY29tIG8gbWFuYWdlciBkYSB0cmFuc2HDp8Ojb1xuICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKHNvbGljaXRhY2FvKTtcblxuICAgICAgLy8gTsOjbyDDqSBtYWlzIG5lY2Vzc8OhcmlvIHJlZ2lzdHJhciBtYW51YWxtZW50ZSBubyBoaXN0w7NyaWNvXG4gICAgICAvLyBPIG3DqXRvZG8gbG9nU3RhdHVzQ2hhbmdlIGZhcsOhIGlzc28gYXV0b21hdGljYW1lbnRlIGF0cmF2w6lzIGRvIGxpc3RlbmVyIEBBZnRlclVwZGF0ZVxuXG4gICAgICByZXR1cm4gdGhpcy5maW5kQnlJZChpZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdGEgbyBoaXN0w7NyaWNvIGRlIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqL1xuICBhc3luYyBnZXRIaXN0b3JpY28oc29saWNpdGFjYW9JZDogc3RyaW5nKSB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIGEgc29saWNpdGHDp8OjbyBleGlzdGVcbiAgICBhd2FpdCB0aGlzLmZpbmRCeUlkKHNvbGljaXRhY2FvSWQpO1xuXG4gICAgLy8gQnVzY2FyIG8gaGlzdMOzcmljb1xuICAgIHJldHVybiB0aGlzLmhpc3Rvcmljb1JlcG9zaXRvcnkuZmluZCh7XG4gICAgICB3aGVyZTogeyBzb2xpY2l0YWNhb19pZDogc29saWNpdGFjYW9JZCB9LFxuICAgICAgb3JkZXI6IHsgY3JlYXRlZF9hdDogJ0RFU0MnIH0sXG4gICAgICByZWxhdGlvbnM6IFsndXN1YXJpbyddLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RhIGFzIHBlbmTDqm5jaWFzIGRlIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqL1xuICBhc3luYyBnZXRQZW5kZW5jaWFzKHNvbGljaXRhY2FvSWQ6IHN0cmluZykge1xuICAgIC8vIFZlcmlmaWNhciBzZSBhIHNvbGljaXRhw6fDo28gZXhpc3RlXG4gICAgYXdhaXQgdGhpcy5maW5kQnlJZChzb2xpY2l0YWNhb0lkKTtcblxuICAgIC8vIEJ1c2NhciBhcyBwZW5kw6puY2lhc1xuICAgIHJldHVybiB0aGlzLnBlbmRlbmNpYVJlcG9zaXRvcnkuZmluZCh7XG4gICAgICB3aGVyZTogeyBzb2xpY2l0YWNhb19pZDogc29saWNpdGFjYW9JZCB9LFxuICAgICAgb3JkZXI6IHsgY3JlYXRlZF9hdDogJ0RFU0MnIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVmluY3VsYSB1bSBwcm9jZXNzbyBqdWRpY2lhbCBhIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHZpbmN1bGFyRHRvIERhZG9zIGRvIHbDrW5jdWxvXG4gICAqIEBwYXJhbSB1c2VyIFVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIGEgb3BlcmHDp8Ojb1xuICAgKiBAcmV0dXJucyBTb2xpY2l0YcOnw6NvIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHZpbmN1bGFyUHJvY2Vzc29KdWRpY2lhbChcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdmluY3VsYXJEdG86IFZpbmN1bGFyUHJvY2Vzc29KdWRpY2lhbER0byxcbiAgICB1c2VyOiBhbnksXG4gICk6IFByb21pc2U8U29saWNpdGFjYW8+IHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGV4aXN0ZVxuICAgICAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoc29saWNpdGFjYW9JZCk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gdXN1w6FyaW8gdGVtIHBlcm1pc3PDo29cbiAgICAgICAgaWYgKCFbUk9MRVMuQURNSU4sIFJPTEVTLkdFU1RPUiwgUk9MRVMuVEVDTklDT10uaW5jbHVkZXModXNlci5yb2xlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICAgICAnVm9jw6ogbsOjbyB0ZW0gcGVybWlzc8OjbyBwYXJhIHZpbmN1bGFyIHByb2Nlc3NvcyBqdWRpY2lhaXMnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyBwcm9jZXNzbyBqdWRpY2lhbCBleGlzdGVcbiAgICAgICAgY29uc3QgcHJvY2Vzc29KdWRpY2lhbCA9IGF3YWl0IHRoaXMucHJvY2Vzc29KdWRpY2lhbFJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHZpbmN1bGFyRHRvLnByb2Nlc3NvX2p1ZGljaWFsX2lkIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghcHJvY2Vzc29KdWRpY2lhbCkge1xuICAgICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJvY2Vzc28ganVkaWNpYWwgbsOjbyBlbmNvbnRyYWRvJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGrDoSB0ZW0gZXN0ZSBwcm9jZXNzbyB2aW5jdWxhZG9cbiAgICAgICAgaWYgKFxuICAgICAgICAgIHNvbGljaXRhY2FvLnByb2Nlc3NvX2p1ZGljaWFsX2lkID09PSB2aW5jdWxhckR0by5wcm9jZXNzb19qdWRpY2lhbF9pZFxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgICAnRXN0ZSBwcm9jZXNzbyBqdWRpY2lhbCBqw6EgZXN0w6EgdmluY3VsYWRvIMOgIHNvbGljaXRhw6fDo28nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBdHVhbGl6YXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgICAgIHNvbGljaXRhY2FvLnByb2Nlc3NvX2p1ZGljaWFsX2lkID0gdmluY3VsYXJEdG8ucHJvY2Vzc29fanVkaWNpYWxfaWQ7XG5cbiAgICAgICAgLy8gUmVnaXN0cmFyIG5vIGhpc3TDs3JpY29cbiAgICAgICAgY29uc3QgaGlzdG9yaWNvRW50cnkgPSB0aGlzLmhpc3Rvcmljb1JlcG9zaXRvcnkuY3JlYXRlKFxuICAgICAgICAgIG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAgICAgc29saWNpdGFjYW9faWQ6IHNvbGljaXRhY2FvSWQsXG4gICAgICAgICAgICBzdGF0dXNfYW50ZXJpb3I6IHNvbGljaXRhY2FvLnN0YXR1cyxcbiAgICAgICAgICAgIHN0YXR1c19hdHVhbDogc29saWNpdGFjYW8uc3RhdHVzLFxuICAgICAgICAgICAgdXN1YXJpb19pZDogdXNlci5pZCxcbiAgICAgICAgICAgIG9ic2VydmFjYW86IHZpbmN1bGFyRHRvLm9ic2VydmFjYW8gfHwgJ1Byb2Nlc3NvIGp1ZGljaWFsIHZpbmN1bGFkbycsXG4gICAgICAgICAgICBkYWRvc19hbHRlcmFkb3M6IHtcbiAgICAgICAgICAgICAgcHJvY2Vzc29fanVkaWNpYWw6IHtcbiAgICAgICAgICAgICAgICBpZDogdmluY3VsYXJEdG8ucHJvY2Vzc29fanVkaWNpYWxfaWQsXG4gICAgICAgICAgICAgICAgbnVtZXJvOiBwcm9jZXNzb0p1ZGljaWFsLm51bWVyb19wcm9jZXNzbyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpcF91c3VhcmlvOiB1c2VyLmlwIHx8ICcwLjAuMC4wJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBTYWx2YXIgYXMgYWx0ZXJhw6fDtWVzXG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShzb2xpY2l0YWNhbyk7XG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShoaXN0b3JpY29FbnRyeSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQoc29saWNpdGFjYW9JZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgVW5hdXRob3JpemVkRXhjZXB0aW9uIHx8XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDb25mbGljdEV4Y2VwdGlvblxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBFcnJvIGFvIHZpbmN1bGFyIHByb2Nlc3NvIGp1ZGljaWFsOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICAgJ0Vycm8gYW8gdmluY3VsYXIgcHJvY2Vzc28ganVkaWNpYWwgw6Agc29saWNpdGHDp8OjbycsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVzdmluY3VsYSB1bSBwcm9jZXNzbyBqdWRpY2lhbCBkZSB1bWEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c2VyIFVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIGEgb3BlcmHDp8Ojb1xuICAgKiBAcmV0dXJucyBTb2xpY2l0YcOnw6NvIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIGRlc3ZpbmN1bGFyUHJvY2Vzc29KdWRpY2lhbChcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdXNlcjogYW55LFxuICApOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbi50cmFuc2FjdGlvbihhc3luYyAobWFuYWdlcikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgc29saWNpdGHDp8OjbyBleGlzdGVcbiAgICAgICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKHNvbGljaXRhY2FvSWQpO1xuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBvIHVzdcOhcmlvIHRlbSBwZXJtaXNzw6NvXG4gICAgICAgIGlmICghW1JPTEVTLkFETUlOLCBST0xFUy5HRVNUT1JdLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKFxuICAgICAgICAgICAgJ1ZvY8OqIG7Do28gdGVtIHBlcm1pc3PDo28gcGFyYSBkZXN2aW5jdWxhciBwcm9jZXNzb3MganVkaWNpYWlzJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgc29saWNpdGHDp8OjbyB0ZW0gcHJvY2Vzc28gdmluY3VsYWRvXG4gICAgICAgIGlmICghc29saWNpdGFjYW8ucHJvY2Vzc29fanVkaWNpYWxfaWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdFc3RhIHNvbGljaXRhw6fDo28gbsOjbyBwb3NzdWkgcHJvY2Vzc28ganVkaWNpYWwgdmluY3VsYWRvJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR3VhcmRhciBpbmZvcm1hw6fDo28gZG8gcHJvY2Vzc28gcGFyYSBvIGhpc3TDs3JpY29cbiAgICAgICAgY29uc3QgcHJvY2Vzc29KdWRpY2lhbElkID0gc29saWNpdGFjYW8ucHJvY2Vzc29fanVkaWNpYWxfaWQ7XG4gICAgICAgIGNvbnN0IHByb2Nlc3NvSnVkaWNpYWwgPSBhd2FpdCB0aGlzLnByb2Nlc3NvSnVkaWNpYWxSZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiBwcm9jZXNzb0p1ZGljaWFsSWQgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQXR1YWxpemFyIGEgc29saWNpdGHDp8Ojb1xuICAgICAgICBzb2xpY2l0YWNhby5wcm9jZXNzb19qdWRpY2lhbF9pZCA9IG51bGwgYXMgdW5rbm93biBhcyBzdHJpbmc7XG5cbiAgICAgICAgLy8gUmVnaXN0cmFyIG5vIGhpc3TDs3JpY29cbiAgICAgICAgY29uc3QgaGlzdG9yaWNvRW50cnkgPSB0aGlzLmhpc3Rvcmljb1JlcG9zaXRvcnkuY3JlYXRlKFxuICAgICAgICAgIG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAgICAgc29saWNpdGFjYW9faWQ6IHNvbGljaXRhY2FvSWQsXG4gICAgICAgICAgICBzdGF0dXNfYW50ZXJpb3I6IHNvbGljaXRhY2FvLnN0YXR1cyxcbiAgICAgICAgICAgIHN0YXR1c19hdHVhbDogc29saWNpdGFjYW8uc3RhdHVzLFxuICAgICAgICAgICAgdXN1YXJpb19pZDogdXNlci5pZCxcbiAgICAgICAgICAgIG9ic2VydmFjYW86ICdQcm9jZXNzbyBqdWRpY2lhbCBkZXN2aW5jdWxhZG8nLFxuICAgICAgICAgICAgZGFkb3NfYWx0ZXJhZG9zOiB7XG4gICAgICAgICAgICAgIHByb2Nlc3NvX2p1ZGljaWFsOiB7XG4gICAgICAgICAgICAgICAgaWQ6IHByb2Nlc3NvSnVkaWNpYWxJZCxcbiAgICAgICAgICAgICAgICBudW1lcm86IHByb2Nlc3NvSnVkaWNpYWxcbiAgICAgICAgICAgICAgICAgID8gcHJvY2Vzc29KdWRpY2lhbC5udW1lcm9fcHJvY2Vzc29cbiAgICAgICAgICAgICAgICAgIDogJ0Rlc2NvbmhlY2lkbycsXG4gICAgICAgICAgICAgICAgYWNhbzogJ3JlbW92aWRvJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpcF91c3VhcmlvOiB1c2VyLmlwIHx8ICcwLjAuMC4wJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBTYWx2YXIgYXMgYWx0ZXJhw6fDtWVzXG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShzb2xpY2l0YWNhbyk7XG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShoaXN0b3JpY29FbnRyeSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQoc29saWNpdGFjYW9JZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgVW5hdXRob3JpemVkRXhjZXB0aW9uIHx8XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgYEVycm8gYW8gZGVzdmluY3VsYXIgcHJvY2Vzc28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgICApO1xuICAgICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgICAnRXJybyBhbyBkZXN2aW5jdWxhciBwcm9jZXNzbyBqdWRpY2lhbCBkYSBzb2xpY2l0YcOnw6NvJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWaW5jdWxhIHVtYSBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCBhIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHZpbmN1bGFyRHRvIERhZG9zIGRvIHbDrW5jdWxvXG4gICAqIEBwYXJhbSB1c2VyIFVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIGEgb3BlcmHDp8Ojb1xuICAgKiBAcmV0dXJucyBTb2xpY2l0YcOnw6NvIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHZpbmN1bGFyRGV0ZXJtaW5hY2FvSnVkaWNpYWwoXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICAgIHZpbmN1bGFyRHRvOiBWaW5jdWxhckRldGVybWluYWNhb0p1ZGljaWFsRHRvLFxuICAgIHVzZXI6IGFueSxcbiAgKTogUHJvbWlzZTxTb2xpY2l0YWNhbz4ge1xuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb24udHJhbnNhY3Rpb24oYXN5bmMgKG1hbmFnZXIpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBhIHNvbGljaXRhw6fDo28gZXhpc3RlXG4gICAgICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5maW5kQnlJZChzb2xpY2l0YWNhb0lkKTtcblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyB1c3XDoXJpbyB0ZW0gcGVybWlzc8Ojb1xuICAgICAgICBpZiAoIVtST0xFUy5BRE1JTiwgUk9MRVMuR0VTVE9SLCBST0xFUy5URUNOSUNPXS5pbmNsdWRlcyh1c2VyLnJvbGUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdWb2PDqiBuw6NvIHRlbSBwZXJtaXNzw6NvIHBhcmEgdmluY3VsYXIgZGV0ZXJtaW5hw6fDtWVzIGp1ZGljaWFpcycsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsIGV4aXN0ZVxuICAgICAgICBjb25zdCBkZXRlcm1pbmFjYW9KdWRpY2lhbCA9XG4gICAgICAgICAgYXdhaXQgdGhpcy5kZXRlcm1pbmFjYW9KdWRpY2lhbFJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBpZDogdmluY3VsYXJEdG8uZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkIH0sXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFkZXRlcm1pbmFjYW9KdWRpY2lhbCkge1xuICAgICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignRGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGrDoSB0ZW0gZXN0YSBkZXRlcm1pbmHDp8OjbyB2aW5jdWxhZGFcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHNvbGljaXRhY2FvLmRldGVybWluYWNhb19qdWRpY2lhbF9pZCA9PT1cbiAgICAgICAgICB2aW5jdWxhckR0by5kZXRlcm1pbmFjYW9fanVkaWNpYWxfaWRcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0VzdGEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgasOhIGVzdMOhIHZpbmN1bGFkYSDDoCBzb2xpY2l0YcOnw6NvJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQXR1YWxpemFyIGEgc29saWNpdGHDp8Ojb1xuICAgICAgICBzb2xpY2l0YWNhby5kZXRlcm1pbmFjYW9fanVkaWNpYWxfaWQgPVxuICAgICAgICAgIHZpbmN1bGFyRHRvLmRldGVybWluYWNhb19qdWRpY2lhbF9pZDtcblxuICAgICAgICAvLyBSZWdpc3RyYXIgbm8gaGlzdMOzcmljb1xuICAgICAgICBjb25zdCBoaXN0b3JpY29FbnRyeSA9IHRoaXMuaGlzdG9yaWNvUmVwb3NpdG9yeS5jcmVhdGUoXG4gICAgICAgICAgbm9ybWFsaXplRW51bUZpZWxkcyh7XG4gICAgICAgICAgICBzb2xpY2l0YWNhb19pZDogc29saWNpdGFjYW9JZCxcbiAgICAgICAgICAgIHN0YXR1c19hbnRlcmlvcjogc29saWNpdGFjYW8uc3RhdHVzLFxuICAgICAgICAgICAgc3RhdHVzX2F0dWFsOiBzb2xpY2l0YWNhby5zdGF0dXMsXG4gICAgICAgICAgICB1c3VhcmlvX2lkOiB1c2VyLmlkLFxuICAgICAgICAgICAgb2JzZXJ2YWNhbzpcbiAgICAgICAgICAgICAgdmluY3VsYXJEdG8ub2JzZXJ2YWNhbyB8fCAnRGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgdmluY3VsYWRhJyxcbiAgICAgICAgICAgIGRhZG9zX2FsdGVyYWRvczoge1xuICAgICAgICAgICAgICBkZXRlcm1pbmFjYW9fanVkaWNpYWw6IHtcbiAgICAgICAgICAgICAgICBpZDogdmluY3VsYXJEdG8uZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkLFxuICAgICAgICAgICAgICAgIG51bWVybzogZGV0ZXJtaW5hY2FvSnVkaWNpYWwubnVtZXJvX2RldGVybWluYWNhbyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpcF91c3VhcmlvOiB1c2VyLmlwIHx8ICcwLjAuMC4wJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBTYWx2YXIgYXMgYWx0ZXJhw6fDtWVzXG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShzb2xpY2l0YWNhbyk7XG4gICAgICAgIGF3YWl0IG1hbmFnZXIuc2F2ZShoaXN0b3JpY29FbnRyeSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQoc29saWNpdGFjYW9JZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgVW5hdXRob3JpemVkRXhjZXB0aW9uIHx8XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDb25mbGljdEV4Y2VwdGlvblxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBFcnJvIGFvIHZpbmN1bGFyIGRldGVybWluYcOnw6NvIGp1ZGljaWFsOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICAgJ0Vycm8gYW8gdmluY3VsYXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgw6Agc29saWNpdGHDp8OjbycsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVzdmluY3VsYSB1bWEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgZGUgdW1hIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gdXNlciBVc3XDoXJpbyBxdWUgZXN0w6EgcmVhbGl6YW5kbyBhIG9wZXJhw6fDo29cbiAgICogQHJldHVybnMgU29saWNpdGHDp8OjbyBhdHVhbGl6YWRhXG4gICAqL1xuICAvKipcbiAgICogQ29udmVydGUgdW0gY2lkYWTDo28gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIHBhcmEgYmVuZWZpY2nDoXJpbyBwcmluY2lwYWwgZGUgdW1hIG5vdmEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gY29udmVydGVyUGFwZWxEdG8gRGFkb3MgcGFyYSBjb252ZXJzw6NvIGRlIHBhcGVsXG4gICAqIEBwYXJhbSB1c2VyIFVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIGEgb3BlcmHDp8Ojb1xuICAgKiBAcmV0dXJucyBOb3ZhIHNvbGljaXRhw6fDo28gY3JpYWRhXG4gICAqL1xuICBhc3luYyBjb252ZXJ0ZXJQYXBlbChcbiAgICBjb252ZXJ0ZXJQYXBlbER0bzogQ29udmVydGVyUGFwZWxEdG8sXG4gICAgdXNlcjogYW55LFxuICApOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgYEluaWNpYW5kbyBjb252ZXJzw6NvIGRlIHBhcGVsIHBhcmEgY2lkYWTDo28gJHtjb252ZXJ0ZXJQYXBlbER0by5jaWRhZGFvX2lkfWAsXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb24udHJhbnNhY3Rpb24oYXN5bmMgKG1hbmFnZXIpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEJ1c2NhciBhIHNvbGljaXRhw6fDo28gZGUgb3JpZ2VtXG4gICAgICAgIGNvbnN0IHNvbGljaXRhY2FvT3JpZ2VtID0gYXdhaXQgdGhpcy5maW5kQnlJZChcbiAgICAgICAgICBjb252ZXJ0ZXJQYXBlbER0by5zb2xpY2l0YWNhb19vcmlnZW1faWQsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKCFzb2xpY2l0YWNhb09yaWdlbSkge1xuICAgICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbyBkZSBvcmlnZW0gbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyBjaWRhZMOjbyBlc3TDoSBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgZGEgc29saWNpdGHDp8Ojb1xuICAgICAgICBjb25zdCBjb21wb3NpY2FvRmFtaWxpYXIgPVxuICAgICAgICAgIHNvbGljaXRhY2FvT3JpZ2VtLmRhZG9zX2NvbXBsZW1lbnRhcmVzPy5jb21wb3NpY2FvX2ZhbWlsaWFyIHx8IFtdO1xuICAgICAgICBjb25zdCBtZW1icm9JbmRleCA9IGNvbXBvc2ljYW9GYW1pbGlhci5maW5kSW5kZXgoXG4gICAgICAgICAgKG1lbWJybykgPT4gbWVtYnJvLmNpZGFkYW9faWQgPT09IGNvbnZlcnRlclBhcGVsRHRvLmNpZGFkYW9faWQsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKG1lbWJyb0luZGV4ID09PSAtMSkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0NpZGFkw6NvIG7Do28gZW5jb250cmFkbyBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgZGEgc29saWNpdGHDp8OjbyBkZSBvcmlnZW0nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBPYnRlciBvIG1lbWJybyBlIHJlbW92ZXIgZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyXG4gICAgICAgIGNvbnN0IG1lbWJybyA9IHsgLi4uY29tcG9zaWNhb0ZhbWlsaWFyW21lbWJyb0luZGV4XSB9O1xuICAgICAgICBjb21wb3NpY2FvRmFtaWxpYXIuc3BsaWNlKG1lbWJyb0luZGV4LCAxKTtcblxuICAgICAgICAvLyBBdHVhbGl6YXIgYSBzb2xpY2l0YcOnw6NvIGRlIG9yaWdlbSBjb20gYSBub3ZhIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxuICAgICAgICBzb2xpY2l0YWNhb09yaWdlbS5kYWRvc19jb21wbGVtZW50YXJlcyA9IHtcbiAgICAgICAgICAuLi5zb2xpY2l0YWNhb09yaWdlbS5kYWRvc19jb21wbGVtZW50YXJlcyxcbiAgICAgICAgICBjb21wb3NpY2FvX2ZhbWlsaWFyOiBjb21wb3NpY2FvRmFtaWxpYXIsXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKHNvbGljaXRhY2FvT3JpZ2VtKTtcblxuICAgICAgICAvLyBDcmlhciB1bWEgbm92YSBzb2xpY2l0YcOnw6NvIGNvbSBvIGNpZGFkw6NvIGNvbW8gYmVuZWZpY2nDoXJpbyBwcmluY2lwYWxcbiAgICAgICAgY29uc3Qgbm92YVNvbGljaXRhY2FvID0gbmV3IFNvbGljaXRhY2FvKCk7XG4gICAgICAgIG5vdmFTb2xpY2l0YWNhby5iZW5lZmljaWFyaW9faWQgPSBjb252ZXJ0ZXJQYXBlbER0by5jaWRhZGFvX2lkO1xuICAgICAgICBub3ZhU29saWNpdGFjYW8udGlwb19iZW5lZmljaW9faWQgPSBjb252ZXJ0ZXJQYXBlbER0by50aXBvX2JlbmVmaWNpb19pZDtcbiAgICAgICAgbm92YVNvbGljaXRhY2FvLnVuaWRhZGVfaWQgPSBjb252ZXJ0ZXJQYXBlbER0by51bmlkYWRlX2lkO1xuICAgICAgICBub3ZhU29saWNpdGFjYW8udGVjbmljb19pZCA9IHVzZXIuaWQ7XG4gICAgICAgIG5vdmFTb2xpY2l0YWNhby5zdGF0dXMgPSBTdGF0dXNTb2xpY2l0YWNhby5SQVNDVU5ITztcbiAgICAgICAgbm92YVNvbGljaXRhY2FvLmRhdGFfYWJlcnR1cmEgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBub3ZhU29saWNpdGFjYW8uc29saWNpdGFjYW9fb3JpZ2luYWxfaWQgPVxuICAgICAgICAgIGNvbnZlcnRlclBhcGVsRHRvLnNvbGljaXRhY2FvX29yaWdlbV9pZDtcbiAgICAgICAgbm92YVNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzID1cbiAgICAgICAgICBjb252ZXJ0ZXJQYXBlbER0by5kYWRvc19jb21wbGVtZW50YXJlcyB8fCB7fTtcblxuICAgICAgICAvLyBBZGljaW9uYXIgb2JzZXJ2YcOnw6NvIHNvYnJlIGEgY29udmVyc8OjbyBkZSBwYXBlbFxuICAgICAgICBub3ZhU29saWNpdGFjYW8ub2JzZXJ2YWNvZXMgPSBgU29saWNpdGHDp8OjbyBjcmlhZGEgYSBwYXJ0aXIgZGEgY29udmVyc8OjbyBkZSBwYXBlbC4gSnVzdGlmaWNhdGl2YTogJHtjb252ZXJ0ZXJQYXBlbER0by5qdXN0aWZpY2F0aXZhfWA7XG5cbiAgICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKG5vdmFTb2xpY2l0YWNhbyk7XG5cbiAgICAgICAgLy8gUmVnaXN0cmFyIG5vIGhpc3TDs3JpY28gZGEgc29saWNpdGHDp8OjbyBkZSBvcmlnZW1cbiAgICAgICAgY29uc3QgaGlzdG9yaWNvT3JpZ2VtID0gdGhpcy5oaXN0b3JpY29SZXBvc2l0b3J5LmNyZWF0ZShcbiAgICAgICAgICBub3JtYWxpemVFbnVtRmllbGRzKHtcbiAgICAgICAgICAgIHNvbGljaXRhY2FvX2lkOiBzb2xpY2l0YWNhb09yaWdlbS5pZCxcbiAgICAgICAgICAgIHN0YXR1c19hbnRlcmlvcjogc29saWNpdGFjYW9PcmlnZW0uc3RhdHVzLFxuICAgICAgICAgICAgc3RhdHVzX2F0dWFsOiBzb2xpY2l0YWNhb09yaWdlbS5zdGF0dXMsXG4gICAgICAgICAgICB1c3VhcmlvX2lkOiB1c2VyLmlkLFxuICAgICAgICAgICAgb2JzZXJ2YWNhbzogYENpZGFkw6NvIHJlbW92aWRvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBwYXJhIHNlIHRvcm5hciBiZW5lZmljacOhcmlvIHByaW5jaXBhbCBlbSBub3ZhIHNvbGljaXRhw6fDo28gKCR7bm92YVNvbGljaXRhY2FvLnByb3RvY29sb30pYCxcbiAgICAgICAgICAgIGRhZG9zX2FsdGVyYWRvczoge1xuICAgICAgICAgICAgICBjb21wb3NpY2FvX2ZhbWlsaWFyOiB7XG4gICAgICAgICAgICAgICAgYWNhbzogJ3JlbW9jYW9fbWVtYnJvJyxcbiAgICAgICAgICAgICAgICBjaWRhZGFvX2lkOiBjb252ZXJ0ZXJQYXBlbER0by5jaWRhZGFvX2lkLFxuICAgICAgICAgICAgICAgIG5vdmFfc29saWNpdGFjYW9faWQ6IG5vdmFTb2xpY2l0YWNhby5pZCxcbiAgICAgICAgICAgICAgICBub3ZhX3NvbGljaXRhY2FvX3Byb3RvY29sbzogbm92YVNvbGljaXRhY2FvLnByb3RvY29sbyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpcF91c3VhcmlvOiB1c2VyLmlwIHx8ICcwLjAuMC4wJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICBhd2FpdCBtYW5hZ2VyLnNhdmUoaGlzdG9yaWNvT3JpZ2VtKTtcblxuICAgICAgICAvLyBSZWdpc3RyYXIgbm8gaGlzdMOzcmljbyBkYSBub3ZhIHNvbGljaXRhw6fDo29cbiAgICAgICAgY29uc3QgaGlzdG9yaWNvTm92YSA9IHRoaXMuaGlzdG9yaWNvUmVwb3NpdG9yeS5jcmVhdGUoXG4gICAgICAgICAgbm9ybWFsaXplRW51bUZpZWxkcyh7XG4gICAgICAgICAgICBzb2xpY2l0YWNhb19pZDogbm92YVNvbGljaXRhY2FvLmlkLFxuICAgICAgICAgICAgc3RhdHVzX2FudGVyaW9yOiBTdGF0dXNTb2xpY2l0YWNhby5SQVNDVU5ITyxcbiAgICAgICAgICAgIHN0YXR1c19hdHVhbDogU3RhdHVzU29saWNpdGFjYW8uUkFTQ1VOSE8sXG4gICAgICAgICAgICB1c3VhcmlvX2lkOiB1c2VyLmlkLFxuICAgICAgICAgICAgb2JzZXJ2YWNhbzogYFNvbGljaXRhw6fDo28gY3JpYWRhIGEgcGFydGlyIGRhIGNvbnZlcnPDo28gZGUgcGFwZWwgZG8gY2lkYWTDo28gcXVlIGVzdGF2YSBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgZGEgc29saWNpdGHDp8OjbyAke3NvbGljaXRhY2FvT3JpZ2VtLnByb3RvY29sb31gLFxuICAgICAgICAgICAgZGFkb3NfYWx0ZXJhZG9zOiB7XG4gICAgICAgICAgICAgIGNvbnZlcnNhb19wYXBlbDoge1xuICAgICAgICAgICAgICAgIHNvbGljaXRhY2FvX29yaWdlbV9pZDogc29saWNpdGFjYW9PcmlnZW0uaWQsXG4gICAgICAgICAgICAgICAgc29saWNpdGFjYW9fb3JpZ2VtX3Byb3RvY29sbzogc29saWNpdGFjYW9PcmlnZW0ucHJvdG9jb2xvLFxuICAgICAgICAgICAgICAgIGp1c3RpZmljYXRpdmE6IGNvbnZlcnRlclBhcGVsRHRvLmp1c3RpZmljYXRpdmEsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaXBfdXN1YXJpbzogdXNlci5pcCB8fCAnMC4wLjAuMCcsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG5cbiAgICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKGhpc3Rvcmljb05vdmEpO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgQ29udmVyc8OjbyBkZSBwYXBlbCBjb25jbHXDrWRhIGNvbSBzdWNlc3NvLiBOb3ZhIHNvbGljaXRhw6fDo286ICR7bm92YVNvbGljaXRhY2FvLmlkfWAsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQobm92YVNvbGljaXRhY2FvLmlkKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uIHx8XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfHxcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICBgRXJybyBhbyBjb252ZXJ0ZXIgcGFwZWwgZG8gY2lkYWTDo286ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgICApO1xuICAgICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgICAnRXJybyBhbyBjb252ZXJ0ZXIgcGFwZWwgZG8gY2lkYWTDo28gcGFyYSBiZW5lZmljacOhcmlvIHByaW5jaXBhbCcsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZXN2aW5jdWxhckRldGVybWluYWNhb0p1ZGljaWFsKFxuICAgIHNvbGljaXRhY2FvSWQ6IHN0cmluZyxcbiAgICB1c2VyOiBhbnksXG4gICk6IFByb21pc2U8U29saWNpdGFjYW8+IHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGV4aXN0ZVxuICAgICAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoc29saWNpdGFjYW9JZCk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gdXN1w6FyaW8gdGVtIHBlcm1pc3PDo29cbiAgICAgICAgaWYgKCFbUk9MRVMuQURNSU4sIFJPTEVTLkdFU1RPUl0uaW5jbHVkZXModXNlci5yb2xlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICAgICAnVm9jw6ogbsOjbyB0ZW0gcGVybWlzc8OjbyBwYXJhIGRlc3ZpbmN1bGFyIGRldGVybWluYcOnw7VlcyBqdWRpY2lhaXMnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIHRlbSBkZXRlcm1pbmHDp8OjbyB2aW5jdWxhZGFcbiAgICAgICAgaWYgKCFzb2xpY2l0YWNhby5kZXRlcm1pbmFjYW9fanVkaWNpYWxfaWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdFc3RhIHNvbGljaXRhw6fDo28gbsOjbyBwb3NzdWkgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgdmluY3VsYWRhJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR3VhcmRhciBpbmZvcm1hw6fDo28gZGEgZGV0ZXJtaW5hw6fDo28gcGFyYSBvIGhpc3TDs3JpY29cbiAgICAgICAgY29uc3QgZGV0ZXJtaW5hY2FvSnVkaWNpYWxJZCA9IHNvbGljaXRhY2FvLmRldGVybWluYWNhb19qdWRpY2lhbF9pZDtcbiAgICAgICAgY29uc3QgZGV0ZXJtaW5hY2FvSnVkaWNpYWwgPVxuICAgICAgICAgIGF3YWl0IHRoaXMuZGV0ZXJtaW5hY2FvSnVkaWNpYWxSZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IGRldGVybWluYWNhb0p1ZGljaWFsSWQgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAvLyBBdHVhbGl6YXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgICAgIHNvbGljaXRhY2FvLmRldGVybWluYWNhb19qdWRpY2lhbF9pZCA9IG51bGwgYXMgdW5rbm93biBhcyBzdHJpbmc7XG5cbiAgICAgICAgLy8gUmVnaXN0cmFyIG5vIGhpc3TDs3JpY29cbiAgICAgICAgY29uc3QgaGlzdG9yaWNvRW50cnkgPSB0aGlzLmhpc3Rvcmljb1JlcG9zaXRvcnkuY3JlYXRlKFxuICAgICAgICAgIG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAgICAgc29saWNpdGFjYW9faWQ6IHNvbGljaXRhY2FvSWQsXG4gICAgICAgICAgICBzdGF0dXNfYW50ZXJpb3I6IHNvbGljaXRhY2FvLnN0YXR1cyxcbiAgICAgICAgICAgIHN0YXR1c19hdHVhbDogc29saWNpdGFjYW8uc3RhdHVzLFxuICAgICAgICAgICAgdXN1YXJpb19pZDogdXNlci5pZCxcbiAgICAgICAgICAgIG9ic2VydmFjYW86ICdEZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCBkZXN2aW5jdWxhZGEnLFxuICAgICAgICAgICAgZGFkb3NfYWx0ZXJhZG9zOiB7XG4gICAgICAgICAgICAgIGRldGVybWluYWNhb19qdWRpY2lhbDoge1xuICAgICAgICAgICAgICAgIGlkOiBkZXRlcm1pbmFjYW9KdWRpY2lhbElkLFxuICAgICAgICAgICAgICAgIG51bWVybzogZGV0ZXJtaW5hY2FvSnVkaWNpYWxcbiAgICAgICAgICAgICAgICAgID8gZGV0ZXJtaW5hY2FvSnVkaWNpYWwubnVtZXJvX2RldGVybWluYWNhb1xuICAgICAgICAgICAgICAgICAgOiAnRGVzY29uaGVjaWRhJyxcbiAgICAgICAgICAgICAgICBhY2FvOiAncmVtb3ZpZGEnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGlwX3VzdWFyaW86IHVzZXIuaXAgfHwgJzAuMC4wLjAnLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFNhbHZhciBhcyBhbHRlcmHDp8O1ZXNcbiAgICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKHNvbGljaXRhY2FvKTtcbiAgICAgICAgYXdhaXQgbWFuYWdlci5zYXZlKGhpc3Rvcmljb0VudHJ5KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5maW5kQnlJZChzb2xpY2l0YWNhb0lkKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uIHx8XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfHxcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICBgRXJybyBhbyBkZXN2aW5jdWxhciBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAgICdFcnJvIGFvIGRlc3ZpbmN1bGFyIGRldGVybWluYcOnw6NvIGp1ZGljaWFsIGRhIHNvbGljaXRhw6fDo28nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=