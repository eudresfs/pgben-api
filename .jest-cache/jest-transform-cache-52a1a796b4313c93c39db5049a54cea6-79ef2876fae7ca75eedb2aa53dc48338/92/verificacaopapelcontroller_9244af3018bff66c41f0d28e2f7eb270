6425f200d8b22466848e4737a144caad
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var VerificacaoPapelController_1;
var _a, _b, _c, _d, _e, _f, _g, _h;
Object.defineProperty(exports, "__esModule", { value: true });
exports.VerificacaoPapelController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const jwt_auth_guard_1 = require("../../../auth/guards/jwt-auth.guard");
const permission_guard_1 = require("../../../auth/guards/permission.guard");
const requires_permission_decorator_1 = require("../../../auth/decorators/requires-permission.decorator");
const verificacao_papel_service_1 = require("../services/verificacao-papel.service");
const cidadao_service_1 = require("../services/cidadao.service");
const verificacao_conflito_papel_dto_1 = require("../dto/verificacao-conflito-papel.dto");
const conversao_papel_dto_1 = require("../dto/conversao-papel.dto");
const user_permission_entity_1 = require("../../../entities/user-permission.entity");
const sexo_enum_1 = require("../../../enums/sexo.enum");
/**
 * Controller de Verificação de Papel
 *
 * Responsável por expor os endpoints de verificação e conversão de papéis
 * dos cidadãos no sistema.
 */
let VerificacaoPapelController = VerificacaoPapelController_1 = class VerificacaoPapelController {
    verificacaoPapelService;
    cidadaoService;
    logger = new common_1.Logger(VerificacaoPapelController_1.name);
    constructor(verificacaoPapelService, cidadaoService) {
        this.verificacaoPapelService = verificacaoPapelService;
        this.cidadaoService = cidadaoService;
    }
    /**
     * Verifica se um cidadão possui conflito de papéis
     * @param verificacaoDto Dados para verificação
     * @returns Resultado da verificação
     */
    async verificarConflito(verificacaoDto) {
        this.logger.log(`Iniciando verificação de conflito para CPF: ${this.maskCpf(verificacaoDto.cpf)}`);
        try {
            const resultado = await this.verificacaoPapelService.verificarConflitoPapeis(verificacaoDto.cpf);
            this.logger.log(`Verificação de conflito concluída para CPF: ${this.maskCpf(verificacaoDto.cpf)}`);
            return resultado;
        }
        catch (error) {
            this.logger.error(`Erro ao verificar conflito para CPF: ${this.maskCpf(verificacaoDto.cpf)}`, error.stack);
            throw error;
        }
    }
    /**
     * Converte um membro de composição familiar para cidadão beneficiário
     * @param conversaoDto Dados para conversão
     * @param req Requisição autenticada
     * @returns Resultado da conversão
     */
    async converterParaBeneficiario(conversaoDto, req) {
        const usuarioId = req.user.id;
        const cpfMasked = this.maskCpf(conversaoDto.cpf);
        this.logger.log(`Iniciando conversão para beneficiário - CPF: ${cpfMasked}, Usuário: ${usuarioId}`);
        try {
            this.validateConversaoParaBeneficiario(conversaoDto);
            const dadosCidadao = this.buildDadosCidadao(conversaoDto);
            // Buscar cidadão pelo CPF para obter o ID
            const cidadao = await this.cidadaoService.findByCpf(conversaoDto.cpf);
            if (!cidadao) {
                throw new common_1.NotFoundException('Cidadão não encontrado');
            }
            const resultado = await this.verificacaoPapelService.converterParaBeneficiario(cidadao.id, conversaoDto.justificativa);
            this.logger.log(`Conversão para beneficiário concluída - CPF: ${cpfMasked}`);
            return resultado;
        }
        catch (error) {
            this.logger.error(`Erro na conversão para beneficiário - CPF: ${cpfMasked}`, error.stack);
            throw error;
        }
    }
    /**
     * Converte um cidadão beneficiário para membro de composição familiar
     * @param conversaoDto Dados para conversão
     * @param req Requisição autenticada
     * @returns Resultado da conversão
     */
    async converterParaComposicaoFamiliar(conversaoDto, req) {
        const usuarioId = req.user.id;
        const cpfMasked = this.maskCpf(conversaoDto.cpf);
        this.logger.log(`Iniciando conversão para composição familiar - CPF: ${cpfMasked}, Usuário: ${usuarioId}`);
        try {
            const resultado = await this.verificacaoPapelService.converterParaComposicaoFamiliar(conversaoDto.cpf, conversaoDto.cidadao_alvo_id, conversaoDto.dados_composicao, conversaoDto.justificativa, usuarioId);
            this.logger.log(`Conversão para composição familiar concluída - CPF: ${cpfMasked}`);
            return resultado;
        }
        catch (error) {
            this.logger.error(`Erro na conversão para composição familiar - CPF: ${cpfMasked}`, error.stack);
            throw error;
        }
    }
    /**
     * Valida os dados necessários para conversão para beneficiário
     * @private
     */
    validateConversaoParaBeneficiario(conversaoDto) {
        if (!conversaoDto.dados_cidadao) {
            throw new common_1.BadRequestException('Dados do cidadão são obrigatórios para a conversão');
        }
        const { dados_cidadao } = conversaoDto;
        if (!dados_cidadao.data_nascimento) {
            throw new common_1.BadRequestException('Data de nascimento é obrigatória');
        }
        if (!dados_cidadao.nome?.trim()) {
            throw new common_1.BadRequestException('Nome do cidadão é obrigatório');
        }
        if (!dados_cidadao.sexo ||
            !Object.values(sexo_enum_1.Sexo).includes(dados_cidadao.sexo)) {
            throw new common_1.BadRequestException('Sexo do cidadão é obrigatório e deve ser válido');
        }
        // Validação adicional da data de nascimento
        const dataNascimento = new Date(dados_cidadao.data_nascimento);
        if (isNaN(dataNascimento.getTime())) {
            throw new common_1.BadRequestException('Data de nascimento deve ser uma data válida');
        }
        const hoje = new Date();
        if (dataNascimento > hoje) {
            throw new common_1.BadRequestException('Data de nascimento não pode ser futura');
        }
        // Validação de idade mínima/máxima razoável (ex: entre 0 e 150 anos)
        const idade = hoje.getFullYear() - dataNascimento.getFullYear();
        if (idade > 150) {
            throw new common_1.BadRequestException('Data de nascimento inválida - idade muito avançada');
        }
    }
    /**
     * Constrói o objeto de dados do cidadão com validações
     * @private
     */
    buildDadosCidadao(conversaoDto) {
        const { dados_cidadao } = conversaoDto;
        // A validação já garante que data_nascimento existe
        if (!dados_cidadao.data_nascimento) {
            throw new common_1.BadRequestException('Data de nascimento é obrigatória');
        }
        return {
            nome: dados_cidadao.nome.trim(),
            cpf: conversaoDto.cpf,
            rg: dados_cidadao.rg?.trim() || '',
            nis: dados_cidadao.nis?.trim() || undefined,
            email: dados_cidadao.email?.trim() || undefined,
            telefone: dados_cidadao.telefone?.trim() || undefined,
            data_nascimento: new Date(dados_cidadao.data_nascimento),
            sexo: dados_cidadao.sexo,
            endereco: dados_cidadao.endereco,
        };
    }
    /**
     * Mascara o CPF para logs (mantém apenas os 3 primeiros e 2 últimos dígitos)
     * @private
     */
    maskCpf(cpf) {
        if (!cpf || cpf.length < 11) {
            return '***';
        }
        const cleanCpf = cpf.replace(/\D/g, '');
        if (cleanCpf.length !== 11) {
            return '***';
        }
        return `${cleanCpf.substring(0, 3)}*****${cleanCpf.substring(9)}`;
    }
};
exports.VerificacaoPapelController = VerificacaoPapelController;
__decorate([
    (0, common_1.Post)('verificar-conflito'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, requires_permission_decorator_1.RequiresPermission)({
        permissionName: 'cidadao.verificar-conflito-papel',
        scopeType: user_permission_entity_1.TipoEscopo.UNIDADE,
        scopeIdExpression: 'params.unidadeId',
    }),
    (0, swagger_1.ApiOperation)({
        summary: 'Verifica se um cidadão possui conflito de papéis',
        description: 'Endpoint para verificar se um cidadão possui conflitos de papéis no sistema',
    }),
    (0, swagger_1.ApiResponse)({
        status: common_1.HttpStatus.OK,
        description: 'Verificação realizada com sucesso',
        type: verificacao_conflito_papel_dto_1.VerificacaoConflitoPapelResponseDto,
    }),
    (0, swagger_1.ApiBadRequestResponse)({
        description: 'Dados de entrada inválidos',
    }),
    (0, swagger_1.ApiUnauthorizedResponse)({
        description: 'Token de autenticação inválido ou ausente',
    }),
    (0, swagger_1.ApiForbiddenResponse)({
        description: 'Usuário não possui permissão para esta operação',
    }),
    __param(0, (0, common_1.Body)(common_1.ValidationPipe)),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_c = typeof verificacao_conflito_papel_dto_1.VerificacaoConflitoPapelDto !== "undefined" && verificacao_conflito_papel_dto_1.VerificacaoConflitoPapelDto) === "function" ? _c : Object]),
    __metadata("design:returntype", typeof (_d = typeof Promise !== "undefined" && Promise) === "function" ? _d : Object)
], VerificacaoPapelController.prototype, "verificarConflito", null);
__decorate([
    (0, common_1.Post)('converter-para-beneficiario'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, requires_permission_decorator_1.RequiresPermission)({
        permissionName: 'cidadao.converter-papel',
        scopeType: user_permission_entity_1.TipoEscopo.UNIDADE,
        scopeIdExpression: 'params.unidadeId',
    }),
    (0, swagger_1.ApiOperation)({
        summary: 'Converte um membro de composição familiar para cidadão beneficiário',
        description: 'Endpoint para converter um membro de composição familiar em cidadão beneficiário',
    }),
    (0, swagger_1.ApiResponse)({
        status: common_1.HttpStatus.OK,
        description: 'Conversão realizada com sucesso',
        type: conversao_papel_dto_1.ConversaoPapelResponseDto,
    }),
    (0, swagger_1.ApiBadRequestResponse)({
        description: 'Dados de entrada inválidos ou incompletos',
    }),
    (0, swagger_1.ApiUnauthorizedResponse)({
        description: 'Token de autenticação inválido ou ausente',
    }),
    (0, swagger_1.ApiForbiddenResponse)({
        description: 'Usuário não possui permissão para esta operação',
    }),
    __param(0, (0, common_1.Body)(common_1.ValidationPipe)),
    __param(1, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_e = typeof conversao_papel_dto_1.ConversaoParaBeneficiarioDto !== "undefined" && conversao_papel_dto_1.ConversaoParaBeneficiarioDto) === "function" ? _e : Object, Object]),
    __metadata("design:returntype", typeof (_f = typeof Promise !== "undefined" && Promise) === "function" ? _f : Object)
], VerificacaoPapelController.prototype, "converterParaBeneficiario", null);
__decorate([
    (0, common_1.Post)('converter-para-composicao-familiar'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, requires_permission_decorator_1.RequiresPermission)({
        permissionName: 'cidadao.converter-papel',
        scopeType: user_permission_entity_1.TipoEscopo.UNIDADE,
        scopeIdExpression: 'params.unidadeId',
    }),
    (0, swagger_1.ApiOperation)({
        summary: 'Converte um cidadão beneficiário para membro de composição familiar',
        description: 'Endpoint para converter um cidadão beneficiário em membro de composição familiar',
    }),
    (0, swagger_1.ApiResponse)({
        status: common_1.HttpStatus.OK,
        description: 'Conversão realizada com sucesso',
        type: conversao_papel_dto_1.ConversaoPapelResponseDto,
    }),
    (0, swagger_1.ApiBadRequestResponse)({
        description: 'Dados de entrada inválidos ou incompletos',
    }),
    (0, swagger_1.ApiUnauthorizedResponse)({
        description: 'Token de autenticação inválido ou ausente',
    }),
    (0, swagger_1.ApiForbiddenResponse)({
        description: 'Usuário não possui permissão para esta operação',
    }),
    __param(0, (0, common_1.Body)(common_1.ValidationPipe)),
    __param(1, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_g = typeof conversao_papel_dto_1.ConversaoParaComposicaoFamiliarDto !== "undefined" && conversao_papel_dto_1.ConversaoParaComposicaoFamiliarDto) === "function" ? _g : Object, Object]),
    __metadata("design:returntype", typeof (_h = typeof Promise !== "undefined" && Promise) === "function" ? _h : Object)
], VerificacaoPapelController.prototype, "converterParaComposicaoFamiliar", null);
exports.VerificacaoPapelController = VerificacaoPapelController = VerificacaoPapelController_1 = __decorate([
    (0, swagger_1.ApiTags)('Cidadão'),
    (0, common_1.Controller)('cidadao/verificacao-papel'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard, permission_guard_1.PermissionGuard),
    (0, swagger_1.ApiBearerAuth)(),
    __metadata("design:paramtypes", [typeof (_a = typeof verificacao_papel_service_1.VerificacaoPapelService !== "undefined" && verificacao_papel_service_1.VerificacaoPapelService) === "function" ? _a : Object, typeof (_b = typeof cidadao_service_1.CidadaoService !== "undefined" && cidadao_service_1.CidadaoService) === "function" ? _b : Object])
], VerificacaoPapelController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXGNvbnRyb2xsZXJzXFx2ZXJpZmljYWNhby1wYXBlbC5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBYXdCO0FBQ3hCLDZDQVF5QjtBQUV6Qix3RUFBbUU7QUFDbkUsNEVBQXdFO0FBQ3hFLDBHQUE0RjtBQUM1RixxRkFBZ0Y7QUFDaEYsaUVBQTZEO0FBQzdELDBGQUcrQztBQUMvQyxvRUFJb0M7QUFDcEMscUZBQXNFO0FBQ3RFLHdEQUFnRDtBQWFoRDs7Ozs7R0FLRztBQUtJLElBQU0sMEJBQTBCLGtDQUFoQyxNQUFNLDBCQUEwQjtJQUlsQjtJQUNBO0lBSkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLDRCQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRFLFlBQ21CLHVCQUFnRCxFQUNoRCxjQUE4QjtRQUQ5Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUM5QyxDQUFDO0lBRUo7Ozs7T0FJRztJQTJCRyxBQUFOLEtBQUssQ0FBQyxpQkFBaUIsQ0FDQyxjQUEyQztRQUVqRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiwrQ0FBK0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FDbEYsQ0FBQztRQUVGLElBQUksQ0FBQztZQUNILE1BQU0sU0FBUyxHQUNiLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLHVCQUF1QixDQUN4RCxjQUFjLENBQUMsR0FBRyxDQUNuQixDQUFDO1lBRUosSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsK0NBQStDLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQ2xGLENBQUM7WUFDRixPQUFPLFNB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SUFBQSxzQkFBWSxFQUFDO1FBQ1osT0FBTyxFQUNMLHFFQUFxRTtRQUN2RSxXQUFXLEVBQ1Qsa0ZBQWtGO0tBQ3JGLENBQUM7SUFDRCxJQUFBLHFCQUFXLEVBQUM7UUFDWCxNQUFNLEVBQUUsbUJBQVUsQ0FBQyxFQUFFO1FBQ3JCLFdBQVcsRUFBRSxpQ0FBaUM7UUFDOUMsSUFBSSxFQUFFLCtDQUF5QjtLQUNoQyxDQUFDO0lBQ0QsSUFBQSwrQkFBcUIsRUFBQztRQUNyQixXQUFXLEVBQUUsMkNBQTJDO0tBQ3pELENBQUM7SUFDRCxJQUFBLGlDQUF1QixFQUFDO1FBQ3ZCLFdBQVcsRUFBRSwyQ0FBMkM7S0FDekQsQ0FBQztJQUNELElBQUEsOEJBQW9CLEVBQUM7UUFDcEIsV0FBVyxFQUFFLGlEQUFpRDtLQUMvRCxDQUFDO0lBRUMsV0FBQSxJQUFBLGFBQUksRUFBQyx1QkFBYyxDQUFDLENBQUE7SUFDcEIsV0FBQSxJQUFBLFlBQUcsR0FBRSxDQUFBOzt5REFEOEIsd0RBQWtDLG9CQUFsQyx3REFBa0M7d0RBRXJFLE9BQU8sb0JBQVAsT0FBTztpRkE2QlQ7cUNBNU1VLDBCQUEwQjtJQUp0QyxJQUFBLGlCQUFPLEVBQUMsU0FBUyxDQUFDO0lBQ2xCLElBQUEsbUJBQVUsRUFBQywyQkFBMkIsQ0FBQztJQUN2QyxJQUFBLGtCQUFTLEVBQUMsNkJBQVksRUFBRSxrQ0FBZSxDQUFDO0lBQ3hDLElBQUEsdUJBQWEsR0FBRTt5REFLOEIsbURBQXVCLG9CQUF2QixtREFBdUIsb0RBQ2hDLGdDQUFjLG9CQUFkLGdDQUFjO0dBTHRDLDBCQUEwQixDQTZTdEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXGNvbnRyb2xsZXJzXFx2ZXJpZmljYWNhby1wYXBlbC5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIFBvc3QsXG4gIEJvZHksXG4gIFVzZUd1YXJkcyxcbiAgUmVxLFxuICBIdHRwQ29kZSxcbiAgSHR0cFN0YXR1cyxcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIExvZ2dlcixcbiAgUGFyc2VVVUlEUGlwZSxcbiAgVmFsaWRhdGlvblBpcGUsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7XG4gIEFwaUJlYXJlckF1dGgsXG4gIEFwaU9wZXJhdGlvbixcbiAgQXBpUmVzcG9uc2UsXG4gIEFwaVRhZ3MsXG4gIEFwaUJhZFJlcXVlc3RSZXNwb25zZSxcbiAgQXBpVW5hdXRob3JpemVkUmVzcG9uc2UsXG4gIEFwaUZvcmJpZGRlblJlc3BvbnNlLFxufSBmcm9tICdAbmVzdGpzL3N3YWdnZXInO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgSnd0QXV0aEd1YXJkIH0gZnJvbSAnLi4vLi4vLi4vYXV0aC9ndWFyZHMvand0LWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgUGVybWlzc2lvbkd1YXJkIH0gZnJvbSAnLi4vLi4vLi4vYXV0aC9ndWFyZHMvcGVybWlzc2lvbi5ndWFyZCc7XG5pbXBvcnQgeyBSZXF1aXJlc1Blcm1pc3Npb24gfSBmcm9tICcuLi8uLi8uLi9hdXRoL2RlY29yYXRvcnMvcmVxdWlyZXMtcGVybWlzc2lvbi5kZWNvcmF0b3InO1xuaW1wb3J0IHsgVmVyaWZpY2FjYW9QYXBlbFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy92ZXJpZmljYWNhby1wYXBlbC5zZXJ2aWNlJztcbmltcG9ydCB7IENpZGFkYW9TZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvY2lkYWRhby5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIFZlcmlmaWNhY2FvQ29uZmxpdG9QYXBlbER0byxcbiAgVmVyaWZpY2FjYW9Db25mbGl0b1BhcGVsUmVzcG9uc2VEdG8sXG59IGZyb20gJy4uL2R0by92ZXJpZmljYWNhby1jb25mbGl0by1wYXBlbC5kdG8nO1xuaW1wb3J0IHtcbiAgQ29udmVyc2FvUGFyYUJlbmVmaWNpYXJpb0R0byxcbiAgQ29udmVyc2FvUGFyYUNvbXBvc2ljYW9GYW1pbGlhckR0byxcbiAgQ29udmVyc2FvUGFwZWxSZXNwb25zZUR0byxcbn0gZnJvbSAnLi4vZHRvL2NvbnZlcnNhby1wYXBlbC5kdG8nO1xuaW1wb3J0IHsgVGlwb0VzY29wbyB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3VzZXItcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgU2V4byB9IGZyb20gJy4uLy4uLy4uL2VudW1zL3NleG8uZW51bSc7XG5pbXBvcnQgeyBFbmRlcmVjb0R0byB9IGZyb20gJy4uL2R0by9jcmVhdGUtY2lkYWRhby5kdG8nO1xuXG5pbnRlcmZhY2UgQXV0aGVudGljYXRlZFVzZXIge1xuICBpZDogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xuICAvLyBBZGljaW9uZSBvdXRyYXMgcHJvcHJpZWRhZGVzIGNvbmZvcm1lIG5lY2Vzc8OhcmlvXG59XG5cbmludGVyZmFjZSBBdXRoZW50aWNhdGVkUmVxdWVzdCBleHRlbmRzIFJlcXVlc3Qge1xuICB1c2VyOiBBdXRoZW50aWNhdGVkVXNlcjtcbn1cblxuLyoqXG4gKiBDb250cm9sbGVyIGRlIFZlcmlmaWNhw6fDo28gZGUgUGFwZWxcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcG9yIGV4cG9yIG9zIGVuZHBvaW50cyBkZSB2ZXJpZmljYcOnw6NvIGUgY29udmVyc8OjbyBkZSBwYXDDqWlzXG4gKiBkb3MgY2lkYWTDo29zIG5vIHNpc3RlbWEuXG4gKi9cbkBBcGlUYWdzKCdDaWRhZMOjbycpXG5AQ29udHJvbGxlcignY2lkYWRhby92ZXJpZmljYWNhby1wYXBlbCcpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZCwgUGVybWlzc2lvbkd1YXJkKVxuQEFwaUJlYXJlckF1dGgoKVxuZXhwb3J0IGNsYXNzIFZlcmlmaWNhY2FvUGFwZWxDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFZlcmlmaWNhY2FvUGFwZWxDb250cm9sbGVyLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmVyaWZpY2FjYW9QYXBlbFNlcnZpY2U6IFZlcmlmaWNhY2FvUGFwZWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2lkYWRhb1NlcnZpY2U6IENpZGFkYW9TZXJ2aWNlLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtIGNpZGFkw6NvIHBvc3N1aSBjb25mbGl0byBkZSBwYXDDqWlzXG4gICAqIEBwYXJhbSB2ZXJpZmljYWNhb0R0byBEYWRvcyBwYXJhIHZlcmlmaWNhw6fDo29cbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIHZlcmlmaWNhw6fDo29cbiAgICovXG4gIEBQb3N0KCd2ZXJpZmljYXItY29uZmxpdG8nKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQFJlcXVpcmVzUGVybWlzc2lvbih7XG4gICAgcGVybWlzc2lvbk5hbWU6ICdjaWRhZGFvLnZlcmlmaWNhci1jb25mbGl0by1wYXBlbCcsXG4gICAgc2NvcGVUeXBlOiBUaXBvRXNjb3BvLlVOSURBREUsXG4gICAgc2NvcGVJZEV4cHJlc3Npb246ICdwYXJhbXMudW5pZGFkZUlkJyxcbiAgfSlcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1ZlcmlmaWNhIHNlIHVtIGNpZGFkw6NvIHBvc3N1aSBjb25mbGl0byBkZSBwYXDDqWlzJyxcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgICdFbmRwb2ludCBwYXJhIHZlcmlmaWNhciBzZSB1bSBjaWRhZMOjbyBwb3NzdWkgY29uZmxpdG9zIGRlIHBhcMOpaXMgbm8gc2lzdGVtYScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiBIdHRwU3RhdHVzLk9LLFxuICAgIGRlc2NyaXB0aW9uOiAnVmVyaWZpY2HDp8OjbyByZWFsaXphZGEgY29tIHN1Y2Vzc28nLFxuICAgIHR5cGU6IFZlcmlmaWNhY2FvQ29uZmxpdG9QYXBlbFJlc3BvbnNlRHRvLFxuICB9KVxuICBAQXBpQmFkUmVxdWVzdFJlc3BvbnNlKHtcbiAgICBkZXNjcmlwdGlvbjogJ0RhZG9zIGRlIGVudHJhZGEgaW52w6FsaWRvcycsXG4gIH0pXG4gIEBBcGlVbmF1dGhvcml6ZWRSZXNwb25zZSh7XG4gICAgZGVzY3JpcHRpb246ICdUb2tlbiBkZSBhdXRlbnRpY2HDp8OjbyBpbnbDoWxpZG8gb3UgYXVzZW50ZScsXG4gIH0pXG4gIEBBcGlGb3JiaWRkZW5SZXNwb25zZSh7XG4gICAgZGVzY3JpcHRpb246ICdVc3XDoXJpbyBuw6NvIHBvc3N1aSBwZXJtaXNzw6NvIHBhcmEgZXN0YSBvcGVyYcOnw6NvJyxcbiAgfSlcbiAgYXN5bmMgdmVyaWZpY2FyQ29uZmxpdG8oXG4gICAgQEJvZHkoVmFsaWRhdGlvblBpcGUpIHZlcmlmaWNhY2FvRHRvOiBWZXJpZmljYWNhb0NvbmZsaXRvUGFwZWxEdG8sXG4gICk6IFByb21pc2U8VmVyaWZpY2FjYW9Db25mbGl0b1BhcGVsUmVzcG9uc2VEdG8+IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgSW5pY2lhbmRvIHZlcmlmaWNhw6fDo28gZGUgY29uZmxpdG8gcGFyYSBDUEY6ICR7dGhpcy5tYXNrQ3BmKHZlcmlmaWNhY2FvRHRvLmNwZil9YCxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9XG4gICAgICAgIGF3YWl0IHRoaXMudmVyaWZpY2FjYW9QYXBlbFNlcnZpY2UudmVyaWZpY2FyQ29uZmxpdG9QYXBlaXMoXG4gICAgICAgICAgdmVyaWZpY2FjYW9EdG8uY3BmLFxuICAgICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBWZXJpZmljYcOnw6NvIGRlIGNvbmZsaXRvIGNvbmNsdcOtZGEgcGFyYSBDUEY6ICR7dGhpcy5tYXNrQ3BmKHZlcmlmaWNhY2FvRHRvLmNwZil9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gcmVzdWx0YWRvO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gdmVyaWZpY2FyIGNvbmZsaXRvIHBhcmEgQ1BGOiAke3RoaXMubWFza0NwZih2ZXJpZmljYWNhb0R0by5jcGYpfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0ZSB1bSBtZW1icm8gZGUgY29tcG9zacOnw6NvIGZhbWlsaWFyIHBhcmEgY2lkYWTDo28gYmVuZWZpY2nDoXJpb1xuICAgKiBAcGFyYW0gY29udmVyc2FvRHRvIERhZG9zIHBhcmEgY29udmVyc8Ojb1xuICAgKiBAcGFyYW0gcmVxIFJlcXVpc2nDp8OjbyBhdXRlbnRpY2FkYVxuICAgKiBAcmV0dXJucyBSZXN1bHRhZG8gZGEgY29udmVyc8Ojb1xuICAgKi9cbiAgQFBvc3QoJ2NvbnZlcnRlci1wYXJhLWJlbmVmaWNpYXJpbycpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBAUmVxdWlyZXNQZXJtaXNzaW9uKHtcbiAgICBwZXJtaXNzaW9uTmFtZTogJ2NpZGFkYW8uY29udmVydGVyLXBhcGVsJyxcbiAgICBzY29wZVR5cGU6IFRpcG9Fc2NvcG8uVU5JREFERSxcbiAgICBzY29wZUlkRXhwcmVzc2lvbjogJ3BhcmFtcy51bmlkYWRlSWQnLFxuICB9KVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OlxuICAgICAgJ0NvbnZlcnRlIHVtIG1lbWJybyBkZSBjb21wb3Npw6fDo28gZmFtaWxpYXIgcGFyYSBjaWRhZMOjbyBiZW5lZmljacOhcmlvJyxcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgICdFbmRwb2ludCBwYXJhIGNvbnZlcnRlciB1bSBtZW1icm8gZGUgY29tcG9zacOnw6NvIGZhbWlsaWFyIGVtIGNpZGFkw6NvIGJlbmVmaWNpw6FyaW8nLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogSHR0cFN0YXR1cy5PSyxcbiAgICBkZXNjcmlwdGlvbjogJ0NvbnZlcnPDo28gcmVhbGl6YWRhIGNvbSBzdWNlc3NvJyxcbiAgICB0eXBlOiBDb252ZXJzYW9QYXBlbFJlc3BvbnNlRHRvLFxuICB9KVxuICBAQXBpQmFkUmVxdWVzdFJlc3BvbnNlKHtcbiAgICBkZXNjcmlwdGlvbjogJ0RhZG9zIGRlIGVudHJhZGEgaW52w6FsaWRvcyBvdSBpbmNvbXBsZXRvcycsXG4gIH0pXG4gIEBBcGlVbmF1dGhvcml6ZWRSZXNwb25zZSh7XG4gICAgZGVzY3JpcHRpb246ICdUb2tlbiBkZSBhdXRlbnRpY2HDp8OjbyBpbnbDoWxpZG8gb3UgYXVzZW50ZScsXG4gIH0pXG4gIEBBcGlGb3JiaWRkZW5SZXNwb25zZSh7XG4gICAgZGVzY3JpcHRpb246ICdVc3XDoXJpbyBuw6NvIHBvc3N1aSBwZXJtaXNzw6NvIHBhcmEgZXN0YSBvcGVyYcOnw6NvJyxcbiAgfSlcbiAgYXN5bmMgY29udmVydGVyUGFyYUJlbmVmaWNpYXJpbyhcbiAgICBAQm9keShWYWxpZGF0aW9uUGlwZSkgY29udmVyc2FvRHRvOiBDb252ZXJzYW9QYXJhQmVuZWZpY2lhcmlvRHRvLFxuICAgIEBSZXEoKSByZXE6IEF1dGhlbnRpY2F0ZWRSZXF1ZXN0LFxuICApOiBQcm9taXNlPENvbnZlcnNhb1BhcGVsUmVzcG9uc2VEdG8+IHtcbiAgICBjb25zdCB1c3VhcmlvSWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCBjcGZNYXNrZWQgPSB0aGlzLm1hc2tDcGYoY29udmVyc2FvRHRvLmNwZik7XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgSW5pY2lhbmRvIGNvbnZlcnPDo28gcGFyYSBiZW5lZmljacOhcmlvIC0gQ1BGOiAke2NwZk1hc2tlZH0sIFVzdcOhcmlvOiAke3VzdWFyaW9JZH1gLFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy52YWxpZGF0ZUNvbnZlcnNhb1BhcmFCZW5lZmljaWFyaW8oY29udmVyc2FvRHRvKTtcblxuICAgICAgY29uc3QgZGFkb3NDaWRhZGFvID0gdGhpcy5idWlsZERhZG9zQ2lkYWRhbyhjb252ZXJzYW9EdG8pO1xuXG4gICAgICAvLyBCdXNjYXIgY2lkYWTDo28gcGVsbyBDUEYgcGFyYSBvYnRlciBvIElEXG4gICAgICBjb25zdCBjaWRhZGFvID0gYXdhaXQgdGhpcy5jaWRhZGFvU2VydmljZS5maW5kQnlDcGYoY29udmVyc2FvRHRvLmNwZik7XG4gICAgICBpZiAoIWNpZGFkYW8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDaWRhZMOjbyBuw6NvIGVuY29udHJhZG8nKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0YWRvID1cbiAgICAgICAgYXdhaXQgdGhpcy52ZXJpZmljYWNhb1BhcGVsU2VydmljZS5jb252ZXJ0ZXJQYXJhQmVuZWZpY2lhcmlvKFxuICAgICAgICAgIGNpZGFkYW8uaWQsXG4gICAgICAgICAgY29udmVyc2FvRHRvLmp1c3RpZmljYXRpdmEsXG4gICAgICAgICk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYENvbnZlcnPDo28gcGFyYSBiZW5lZmljacOhcmlvIGNvbmNsdcOtZGEgLSBDUEY6ICR7Y3BmTWFza2VkfWAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlc3VsdGFkbztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIG5hIGNvbnZlcnPDo28gcGFyYSBiZW5lZmljacOhcmlvIC0gQ1BGOiAke2NwZk1hc2tlZH1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydGUgdW0gY2lkYWTDo28gYmVuZWZpY2nDoXJpbyBwYXJhIG1lbWJybyBkZSBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICogQHBhcmFtIGNvbnZlcnNhb0R0byBEYWRvcyBwYXJhIGNvbnZlcnPDo29cbiAgICogQHBhcmFtIHJlcSBSZXF1aXNpw6fDo28gYXV0ZW50aWNhZGFcbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIGNvbnZlcnPDo29cbiAgICovXG4gIEBQb3N0KCdjb252ZXJ0ZXItcGFyYS1jb21wb3NpY2FvLWZhbWlsaWFyJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBSZXF1aXJlc1Blcm1pc3Npb24oe1xuICAgIHBlcm1pc3Npb25OYW1lOiAnY2lkYWRhby5jb252ZXJ0ZXItcGFwZWwnLFxuICAgIHNjb3BlVHlwZTogVGlwb0VzY29wby5VTklEQURFLFxuICAgIHNjb3BlSWRFeHByZXNzaW9uOiAncGFyYW1zLnVuaWRhZGVJZCcsXG4gIH0pXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6XG4gICAgICAnQ29udmVydGUgdW0gY2lkYWTDo28gYmVuZWZpY2nDoXJpbyBwYXJhIG1lbWJybyBkZSBjb21wb3Npw6fDo28gZmFtaWxpYXInLFxuICAgIGRlc2NyaXB0aW9uOlxuICAgICAgJ0VuZHBvaW50IHBhcmEgY29udmVydGVyIHVtIGNpZGFkw6NvIGJlbmVmaWNpw6FyaW8gZW0gbWVtYnJvIGRlIGNvbXBvc2nDp8OjbyBmYW1pbGlhcicsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiBIdHRwU3RhdHVzLk9LLFxuICAgIGRlc2NyaXB0aW9uOiAnQ29udmVyc8OjbyByZWFsaXphZGEgY29tIHN1Y2Vzc28nLFxuICAgIHR5cGU6IENvbnZlcnNhb1BhcGVsUmVzcG9uc2VEdG8sXG4gIH0pXG4gIEBBcGlCYWRSZXF1ZXN0UmVzcG9uc2Uoe1xuICAgIGRlc2NyaXB0aW9uOiAnRGFkb3MgZGUgZW50cmFkYSBpbnbDoWxpZG9zIG91IGluY29tcGxldG9zJyxcbiAgfSlcbiAgQEFwaVVuYXV0aG9yaXplZFJlc3BvbnNlKHtcbiAgICBkZXNjcmlwdGlvbjogJ1Rva2VuIGRlIGF1dGVudGljYcOnw6NvIGludsOhbGlkbyBvdSBhdXNlbnRlJyxcbiAgfSlcbiAgQEFwaUZvcmJpZGRlblJlc3BvbnNlKHtcbiAgICBkZXNjcmlwdGlvbjogJ1VzdcOhcmlvIG7Do28gcG9zc3VpIHBlcm1pc3PDo28gcGFyYSBlc3RhIG9wZXJhw6fDo28nLFxuICB9KVxuICBhc3luYyBjb252ZXJ0ZXJQYXJhQ29tcG9zaWNhb0ZhbWlsaWFyKFxuICAgIEBCb2R5KFZhbGlkYXRpb25QaXBlKSBjb252ZXJzYW9EdG86IENvbnZlcnNhb1BhcmFDb21wb3NpY2FvRmFtaWxpYXJEdG8sXG4gICAgQFJlcSgpIHJlcTogQXV0aGVudGljYXRlZFJlcXVlc3QsXG4gICk6IFByb21pc2U8Q29udmVyc2FvUGFwZWxSZXNwb25zZUR0bz4ge1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9IHJlcS51c2VyLmlkO1xuICAgIGNvbnN0IGNwZk1hc2tlZCA9IHRoaXMubWFza0NwZihjb252ZXJzYW9EdG8uY3BmKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBJbmljaWFuZG8gY29udmVyc8OjbyBwYXJhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciAtIENQRjogJHtjcGZNYXNrZWR9LCBVc3XDoXJpbzogJHt1c3VhcmlvSWR9YCxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9XG4gICAgICAgIGF3YWl0IHRoaXMudmVyaWZpY2FjYW9QYXBlbFNlcnZpY2UuY29udmVydGVyUGFyYUNvbXBvc2ljYW9GYW1pbGlhcihcbiAgICAgICAgICBjb252ZXJzYW9EdG8uY3BmLFxuICAgICAgICAgIGNvbnZlcnNhb0R0by5jaWRhZGFvX2Fsdm9faWQsXG4gICAgICAgICAgY29udmVyc2FvRHRvLmRhZG9zX2NvbXBvc2ljYW8sXG4gICAgICAgICAgY29udmVyc2FvRHRvLmp1c3RpZmljYXRpdmEsXG4gICAgICAgICAgdXN1YXJpb0lkLFxuICAgICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBDb252ZXJzw6NvIHBhcmEgY29tcG9zacOnw6NvIGZhbWlsaWFyIGNvbmNsdcOtZGEgLSBDUEY6ICR7Y3BmTWFza2VkfWAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlc3VsdGFkbztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIG5hIGNvbnZlcnPDo28gcGFyYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgLSBDUEY6ICR7Y3BmTWFza2VkfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgb3MgZGFkb3MgbmVjZXNzw6FyaW9zIHBhcmEgY29udmVyc8OjbyBwYXJhIGJlbmVmaWNpw6FyaW9cbiAgICogQHByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVDb252ZXJzYW9QYXJhQmVuZWZpY2lhcmlvKFxuICAgIGNvbnZlcnNhb0R0bzogQ29udmVyc2FvUGFyYUJlbmVmaWNpYXJpb0R0byxcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFjb252ZXJzYW9EdG8uZGFkb3NfY2lkYWRhbykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdEYWRvcyBkbyBjaWRhZMOjbyBzw6NvIG9icmlnYXTDs3Jpb3MgcGFyYSBhIGNvbnZlcnPDo28nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGRhZG9zX2NpZGFkYW8gfSA9IGNvbnZlcnNhb0R0bztcblxuICAgIGlmICghZGFkb3NfY2lkYWRhby5kYXRhX25hc2NpbWVudG8pIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdEYXRhIGRlIG5hc2NpbWVudG8gw6kgb2JyaWdhdMOzcmlhJyk7XG4gICAgfVxuXG4gICAgaWYgKCFkYWRvc19jaWRhZGFvLm5vbWU/LnRyaW0oKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ05vbWUgZG8gY2lkYWTDo28gw6kgb2JyaWdhdMOzcmlvJyk7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWRhZG9zX2NpZGFkYW8uc2V4byB8fFxuICAgICAgIU9iamVjdC52YWx1ZXMoU2V4bykuaW5jbHVkZXMoZGFkb3NfY2lkYWRhby5zZXhvIGFzIFNleG8pXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1NleG8gZG8gY2lkYWTDo28gw6kgb2JyaWdhdMOzcmlvIGUgZGV2ZSBzZXIgdsOhbGlkbycsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYcOnw6NvIGFkaWNpb25hbCBkYSBkYXRhIGRlIG5hc2NpbWVudG9cbiAgICBjb25zdCBkYXRhTmFzY2ltZW50byA9IG5ldyBEYXRlKGRhZG9zX2NpZGFkYW8uZGF0YV9uYXNjaW1lbnRvKTtcbiAgICBpZiAoaXNOYU4oZGF0YU5hc2NpbWVudG8uZ2V0VGltZSgpKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdEYXRhIGRlIG5hc2NpbWVudG8gZGV2ZSBzZXIgdW1hIGRhdGEgdsOhbGlkYScsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGhvamUgPSBuZXcgRGF0ZSgpO1xuICAgIGlmIChkYXRhTmFzY2ltZW50byA+IGhvamUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdEYXRhIGRlIG5hc2NpbWVudG8gbsOjbyBwb2RlIHNlciBmdXR1cmEnKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGHDp8OjbyBkZSBpZGFkZSBtw61uaW1hL23DoXhpbWEgcmF6b8OhdmVsIChleDogZW50cmUgMCBlIDE1MCBhbm9zKVxuICAgIGNvbnN0IGlkYWRlID0gaG9qZS5nZXRGdWxsWWVhcigpIC0gZGF0YU5hc2NpbWVudG8uZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoaWRhZGUgPiAxNTApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnRGF0YSBkZSBuYXNjaW1lbnRvIGludsOhbGlkYSAtIGlkYWRlIG11aXRvIGF2YW7Dp2FkYScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDb25zdHLDs2kgbyBvYmpldG8gZGUgZGFkb3MgZG8gY2lkYWTDo28gY29tIHZhbGlkYcOnw7Vlc1xuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZERhZG9zQ2lkYWRhbyhjb252ZXJzYW9EdG86IENvbnZlcnNhb1BhcmFCZW5lZmljaWFyaW9EdG8pIHtcbiAgICBjb25zdCB7IGRhZG9zX2NpZGFkYW8gfSA9IGNvbnZlcnNhb0R0bztcblxuICAgIC8vIEEgdmFsaWRhw6fDo28gasOhIGdhcmFudGUgcXVlIGRhdGFfbmFzY2ltZW50byBleGlzdGVcbiAgICBpZiAoIWRhZG9zX2NpZGFkYW8uZGF0YV9uYXNjaW1lbnRvKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRGF0YSBkZSBuYXNjaW1lbnRvIMOpIG9icmlnYXTDs3JpYScpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBub21lOiBkYWRvc19jaWRhZGFvLm5vbWUudHJpbSgpLFxuICAgICAgY3BmOiBjb252ZXJzYW9EdG8uY3BmLFxuICAgICAgcmc6IGRhZG9zX2NpZGFkYW8ucmc/LnRyaW0oKSB8fCAnJyxcbiAgICAgIG5pczogZGFkb3NfY2lkYWRhby5uaXM/LnRyaW0oKSB8fCB1bmRlZmluZWQsXG4gICAgICBlbWFpbDogZGFkb3NfY2lkYWRhby5lbWFpbD8udHJpbSgpIHx8IHVuZGVmaW5lZCxcbiAgICAgIHRlbGVmb25lOiBkYWRvc19jaWRhZGFvLnRlbGVmb25lPy50cmltKCkgfHwgdW5kZWZpbmVkLFxuICAgICAgZGF0YV9uYXNjaW1lbnRvOiBuZXcgRGF0ZShkYWRvc19jaWRhZGFvLmRhdGFfbmFzY2ltZW50byksXG4gICAgICBzZXhvOiBkYWRvc19jaWRhZGFvLnNleG8gYXMgU2V4byxcbiAgICAgIGVuZGVyZWNvOiBkYWRvc19jaWRhZGFvLmVuZGVyZWNvIGFzIHVua25vd24gYXMgRW5kZXJlY29EdG8sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXNjYXJhIG8gQ1BGIHBhcmEgbG9ncyAobWFudMOpbSBhcGVuYXMgb3MgMyBwcmltZWlyb3MgZSAyIMO6bHRpbW9zIGTDrWdpdG9zKVxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBtYXNrQ3BmKGNwZjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIWNwZiB8fCBjcGYubGVuZ3RoIDwgMTEpIHtcbiAgICAgIHJldHVybiAnKioqJztcbiAgICB9XG5cbiAgICBjb25zdCBjbGVhbkNwZiA9IGNwZi5yZXBsYWNlKC9cXEQvZywgJycpO1xuICAgIGlmIChjbGVhbkNwZi5sZW5ndGggIT09IDExKSB7XG4gICAgICByZXR1cm4gJyoqKic7XG4gICAgfVxuXG4gICAgcmV0dXJuIGAke2NsZWFuQ3BmLnN1YnN0cmluZygwLCAzKX0qKioqKiR7Y2xlYW5DcGYuc3Vic3RyaW5nKDkpfWA7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==