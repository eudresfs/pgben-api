92cff3e3929b296d538276d02ce6e8bb
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var ComposicaoFamiliarService_1;
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ComposicaoFamiliarService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const class_transformer_1 = require("class-transformer");
const class_validator_1 = require("class-validator");
const composicao_familiar_entity_1 = require("../../../entities/composicao-familiar.entity");
const cidadao_entity_1 = require("../../../entities/cidadao.entity");
const composicao_familiar_response_dto_1 = require("../dto/composicao-familiar-response.dto");
const cache_1 = require("../../../shared/cache");
const cpf_validator_1 = require("../validators/cpf-validator");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
/**
 * Serviço de Composição Familiar
 *
 * Responsável pela lógica de negócio relacionada aos membros da composição familiar dos cidadãos.
 * Implementa operações CRUD completas com validações específicas, cache e auditoria.
 */
let ComposicaoFamiliarService = ComposicaoFamiliarService_1 = class ComposicaoFamiliarService {
    composicaoFamiliarRepository;
    cidadaoRepository;
    cacheService;
    dataSource;
    logger = new common_1.Logger(ComposicaoFamiliarService_1.name);
    CACHE_TTL = 3600; // 1 hora
    CACHE_PREFIX = 'composicao_familiar:';
    constructor(composicaoFamiliarRepository, cidadaoRepository, cacheService, dataSource) {
        this.composicaoFamiliarRepository = composicaoFamiliarRepository;
        this.cidadaoRepository = cidadaoRepository;
        this.cacheService = cacheService;
        this.dataSource = dataSource;
    }
    /**
     * Cria um novo membro da composição familiar
     * @param createComposicaoFamiliarDto Dados do membro familiar
     * @param userId ID do usuário que está criando
     * @returns Membro da composição familiar criado
     */
    async create(createComposicaoFamiliarDto, userId) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            // Validar se o cidadão existe
            const cidadao = await this.cidadaoRepository.findOne({
                where: { id: createComposicaoFamiliarDto.cidadao_id },
            });
            if (!cidadao) {
                throw new common_1.NotFoundException('Cidadão não encontrado');
            }
            // Validar CPF
            const cpfLimpo = createComposicaoFamiliarDto.cpf.replace(/\D/g, '');
            const cpfValidator = new cpf_validator_1.CPFValidator();
            if (!cpfValidator.validate(cpfLimpo, {})) {
                throw new common_1.BadRequestException('CPF inválido');
            }
            // Verificar se já existe membro com o mesmo CPF na composição familiar do cidadão
            const membroExistente = await this.composicaoFamiliarRepository.findOne({
                where: {
                    cidadao_id: createComposicaoFamiliarDto.cidadao_id,
                    cpf: cpfLimpo,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
            });
            if (membroExistente) {
                throw new common_1.ConflictException('Já existe um membro com este CPF na composição familiar');
            }
            // Verificar se o CPF não é o mesmo do cidadão responsável
            if (cidadao.cpf === cpfLimpo) {
                throw new common_1.ConflictException('O CPF do membro não pode ser igual ao CPF do cidadão responsável');
            }
            // Validar se o nome não é duplicado na mesma composição familiar
            const nomeExistente = await this.composicaoFamiliarRepository.findOne({
                where: {
                    cidadao_id: createComposicaoFamiliarDto.cidadao_id,
                    nome: createComposicaoFamiliarDto.nome,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
            });
            if (nomeExistente) {
                throw new common_1.ConflictException('Já existe um membro com este nome na composição familiar');
            }
            // Normalizar campos de enum antes de criar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)({
                ...createComposicaoFamiliarDto,
                cpf: cpfLimpo,
            });
            // Criar o membro da composição familiar
            const novoMembro = this.composicaoFamiliarRepository.create(dadosNormalizados);
            // Validar entidade
            const errors = await (0, class_validator_1.validate)(novoMembro);
            if (errors.length > 0) {
                const errorMessages = errors
                    .map((error) => Object.values(error.constraints || {}).join(', '))
                    .join('; ');
                throw new common_1.BadRequestException(`Dados inválidos: ${errorMessages}`);
            }
            const membroSalvo = await queryRunner.manager.save(novoMembro);
            await queryRunner.commitTransaction();
            // Invalidar cache relacionado
            await this.invalidateCache(createComposicaoFamiliarDto.cidadao_id);
            // Converter para DTO de resposta
            const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membroSalvo, {
                excludeExtraneousValues: true,
                enableImplicitConversion: true,
            });
            // Cachear o resultado
            await this.cacheService.set(`${this.CACHE_PREFIX}id:${membroSalvo.id}`, responseDto, this.CACHE_TTL);
            this.logger.log(`Membro da composição familiar criado: ${membroSalvo.id} por usuário ${userId}`);
            return responseDto;
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            this.logger.error(`Erro ao criar membro da composição familiar: ${error.message}`, error.stack);
            throw error;
        }
        finally {
            await queryRunner.release();
        }
    }
    /**
     * Lista membros da composição familiar por cidadão
     * @param cidadaoId ID do cidadão
     * @param options Opções de paginação
     * @returns Lista paginada de membros
     */
    async findByCidadao(cidadaoId, options) {
        const { page, limit } = options;
        const offset = (page - 1) * limit;
        // Verificar se o cidadão existe
        const cidadao = await this.cidadaoRepository.findOne({
            where: { id: cidadaoId },
        });
        if (!cidadao) {
            throw new common_1.NotFoundException('Cidadão não encontrado');
        }
        // Verificar cache
        const cacheKey = `${this.CACHE_PREFIX}cidadao:${cidadaoId}:page:${page}:limit:${limit}`;
        const cached = await this.cacheService.get(cacheKey);
        if (cached) {
            return cached;
        }
        // Buscar membros da composição familiar
        const [membros, total] = await this.composicaoFamiliarRepository.findAndCount({
            where: {
                cidadao_id: cidadaoId,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            order: {
                created_at: 'DESC',
            },
            skip: offset,
            take: limit,
        });
        // Converter para DTOs de resposta
        const data = membros.map((membro) => (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        }));
        // Calcular estatísticas
        const estatisticas = await this.calcularEstatisticas(cidadaoId);
        const totalPages = Math.ceil(total / limit);
        const result = {
            data,
            meta: {
                total,
                page,
                limit,
                totalPages,
                hasNext: page < totalPages,
                hasPrev: page > 1,
            },
            estatisticas,
        };
        // Cachear resultado
        await this.cacheService.set(cacheKey, result, this.CACHE_TTL);
        return result;
    }
    /**
     * Busca um membro específico da composição familiar
     * @param id ID do membro
     * @returns Dados do membro
     */
    async findOne(id) {
        // Verificar cache
        const cacheKey = `${this.CACHE_PREFIX}id:${id}`;
        const cached = await this.cacheService.get(cacheKey);
        if (cached) {
            return cached;
        }
        const membro = await this.composicaoFamiliarRepository.findOne({
            where: {
                id,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            relations: ['cidadao'],
        });
        if (!membro) {
            throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
        }
        const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        });
        // Cachear resultado
        await this.cacheService.set(cacheKey, responseDto, this.CACHE_TTL);
        return responseDto;
    }
    /**
     * Atualiza um membro da composição familiar
     * @param id ID do membro
     * @param updateComposicaoFamiliarDto Dados para atualização
     * @param userId ID do usuário que está atualizando
     * @returns Membro atualizado
     */
    async update(id, updateComposicaoFamiliarDto, userId) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            const membro = await this.composicaoFamiliarRepository.findOne({
                where: {
                    id,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
                relations: ['cidadao'],
            });
            if (!membro) {
                throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
            }
            // Se o CPF está sendo atualizado, validar
            if (updateComposicaoFamiliarDto.cpf) {
                const cpfLimpo = updateComposicaoFamiliarDto.cpf.replace(/\D/g, '');
                const cpfValidator = new cpf_validator_1.CPFValidator();
                if (!cpfValidator.validate(cpfLimpo, {})) {
                    throw new common_1.BadRequestException('CPF inválido');
                }
                // Verificar se já existe outro membro com o mesmo CPF
                const membroExistente = await this.composicaoFamiliarRepository.findOne({
                    where: {
                        cidadao_id: membro.cidadao_id,
                        cpf: cpfLimpo,
                        id: (0, typeorm_2.Not)(id),
                        removed_at: (0, typeorm_2.IsNull)(),
                    },
                });
                if (membroExistente) {
                    throw new common_1.ConflictException('Já existe um membro com este CPF na composição familiar');
                }
                // Verificar se o CPF não é o mesmo do cidadão responsável
                if (membro.cidadao.cpf === cpfLimpo) {
                    throw new common_1.ConflictException('O CPF do membro não pode ser igual ao CPF do cidadão responsável');
                }
                updateComposicaoFamiliarDto.cpf = cpfLimpo;
            }
            // Se o nome está sendo atualizado, validar
            if (updateComposicaoFamiliarDto.nome) {
                const nomeExistente = await this.composicaoFamiliarRepository.findOne({
                    where: {
                        cidadao_id: membro.cidadao_id,
                        nome: updateComposicaoFamiliarDto.nome,
                        id: (0, typeorm_2.Not)(id),
                        removed_at: (0, typeorm_2.IsNull)(),
                    },
                });
                if (nomeExistente) {
                    throw new common_1.ConflictException('Já existe um membro com este nome na composição familiar');
                }
            }
            // Normalizar campos de enum antes de atualizar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)({ ...updateComposicaoFamiliarDto });
            // Atualizar dados
            Object.assign(membro, dadosNormalizados);
            membro.updated_at = new Date();
            // Validar entidade
            const errors = await (0, class_validator_1.validate)(membro);
            if (errors.length > 0) {
                const errorMessages = errors
                    .map((error) => Object.values(error.constraints || {}).join(', '))
                    .join('; ');
                throw new common_1.BadRequestException(`Dados inválidos: ${errorMessages}`);
            }
            const membroAtualizado = await queryRunner.manager.save(membro);
            await queryRunner.commitTransaction();
            // Invalidar cache
            await this.invalidateCache(membro.cidadao_id, id);
            const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membroAtualizado, {
                excludeExtraneousValues: true,
                enableImplicitConversion: true,
            });
            // Atualizar cache
            await this.cacheService.set(`${this.CACHE_PREFIX}id:${id}`, responseDto, this.CACHE_TTL);
            this.logger.log(`Membro da composição familiar atualizado: ${id} por usuário ${userId}`);
            return responseDto;
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            this.logger.error(`Erro ao atualizar membro da composição familiar: ${error.message}`, error.stack);
            throw error;
        }
        finally {
            await queryRunner.release();
        }
    }
    /**
     * Remove um membro da composição familiar (soft delete)
     * @param id ID do membro
     * @param userId ID do usuário que está removendo
     */
    async remove(id, userId) {
        const membro = await this.composicaoFamiliarRepository.findOne({
            where: {
                id,
                removed_at: (0, typeorm_2.IsNull)(),
            },
        });
        if (!membro) {
            throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
        }
        // Soft delete
        membro.removed_at = new Date();
        await this.composicaoFamiliarRepository.save(membro);
        // Invalidar cache
        await this.invalidateCache(membro.cidadao_id, id);
        this.logger.log(`Membro da composição familiar removido: ${id} por usuário ${userId}`);
    }
    /**
     * Busca membros da composição familiar por CPF
     * @param cpf CPF para busca
     * @returns Lista de membros encontrados
     */
    async findByCpf(cpf) {
        const cpfLimpo = cpf.replace(/\D/g, '');
        if (cpfLimpo.length !== 11) {
            throw new common_1.BadRequestException('CPF deve ter 11 dígitos');
        }
        const membros = await this.composicaoFamiliarRepository.find({
            where: {
                cpf: cpfLimpo,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            relations: ['cidadao'],
            order: {
                created_at: 'DESC',
            },
        });
        return membros.map((membro) => (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        }));
    }
    /**
     * Calcula estatísticas da composição familiar
     * @param cidadaoId ID do cidadão
     * @returns Estatísticas calculadas
     */
    async calcularEstatisticas(cidadaoId) {
        const membros = await this.composicaoFamiliarRepository.find({
            where: {
                cidadao_id: cidadaoId,
                removed_at: (0, typeorm_2.IsNull)(),
            },
        });
        const totalMembros = membros.length;
        const membrosComRenda = membros.filter((m) => m.renda && m.renda > 0).length;
        const rendaTotal = membros.reduce((sum, m) => sum + (m.renda || 0), 0);
        const rendaMedia = membrosComRenda > 0 ? rendaTotal / membrosComRenda : 0;
        const idadeMedia = totalMembros > 0 ? membros.reduce((sum, m) => sum + m.idade, 0) / totalMembros : 0;
        return {
            totalMembros,
            rendaTotal,
            rendaMedia: Math.round(rendaMedia * 100) / 100,
            idadeMedia: Math.round(idadeMedia * 100) / 100,
            membrosComRenda,
        };
    }
    /**
     * Invalida cache relacionado à composição familiar
     * @param cidadaoId ID do cidadão
     * @param membroId ID do membro (opcional)
     */
    async invalidateCache(cidadaoId, membroId) {
        const patterns = [
            `${this.CACHE_PREFIX}cidadao:${cidadaoId}:*`,
            `cidadao:id:${cidadaoId}`,
            `cidadao:list:*`,
        ];
        if (membroId) {
            patterns.push(`${this.CACHE_PREFIX}id:${membroId}`);
        }
        for (const pattern of patterns) {
            await this.cacheService.del(pattern);
        }
    }
};
exports.ComposicaoFamiliarService = ComposicaoFamiliarService;
exports.ComposicaoFamiliarService = ComposicaoFamiliarService = ComposicaoFamiliarService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(composicao_familiar_entity_1.ComposicaoFamiliar)),
    __param(1, (0, typeorm_1.InjectRepository)(cidadao_entity_1.Cidadao)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof cache_1.CacheService !== "undefined" && cache_1.CacheService) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _d : Object])
], ComposicaoFamiliarService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHNlcnZpY2VzXFxjb21wb3NpY2FvLWZhbWlsaWFyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUE4RDtBQUM5RCx5REFBb0Q7QUFDcEQscURBQTJDO0FBQzNDLDZGQUFrRjtBQUNsRixxRUFBMkQ7QUFHM0QsOEZBR2lEO0FBQ2pELGlEQUFxRDtBQUNyRCwrREFBMkQ7QUFDM0QscUZBQWlGO0FBRWpGOzs7OztHQUtHO0FBRUksSUFBTSx5QkFBeUIsaUNBQS9CLE1BQU0seUJBQXlCO0lBT2pCO0lBRUE7SUFDQTtJQUNBO0lBVkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLDJCQUF5QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQyxTQUFTO0lBQzNCLFlBQVksR0FBRyxzQkFBc0IsQ0FBQztJQUV2RCxZQUVtQiw0QkFBNEQsRUFFNUQsaUJBQXNDLEVBQ3RDLFlBQTBCLEVBQzFCLFVBQXNCO1FBSnRCLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBZ0M7UUFFNUQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFxQjtRQUN0QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQ3RDLENBQUM7SUFFSjs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQ1YsMkJBQXdELEVBQ3hELE1BQWM7UUFFZCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDeEQsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUIsTUFBTSxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUVyQyxJQUFJLENBQUM7WUFDSCw4QkFBOEI7WUFDOUIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDO2dCQUNuRCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsMkJBQTJCLENBQUMsVUFBVSxFQUFFO2FBQ3RELENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDYixNQUFNLElBQUksMEJBQWlCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN4RCxDQUFDO1lBRUQsY0FBYztZQUNkLE1BQU0sUUFBUSxHQUFHLDJCQUEyQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLE1BQU0sWUFBWSxHQUFHLElBQUksNEJBQVksRUFBRSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFTLENBQUMsRUFBRSxDQUFDO2dCQUNoRCxNQUFNLElBQUksNEJBQW1CLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDaEQsQ0FBQztZQUVELGtGQUFrRjtZQUNsRixNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxPQUFPLENBQUM7Z0JBQ3RFLEtBQUssRUFBRTtvQkFDTCxVQUFVLEVBQUUsMkJBQTJCLENBQUMsVUFBVTtvQkFDbEQsR0FBRyxFQUFFLFFBQVE7b0JBQ2IsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTtpQkFDckI7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixNQUFNLElBQUksMEJBQWlCLENBQ3pCLHlEQUF5RCxDQUMxRCxDQUFDO1lBQ0osQ0FBQztZQUVELDBEQUEwRDtZQUMxRCxJQUFJLE9BQU8sQ0FBQyxHQUFHLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzdCLE1BQU0sSUFBSSwwQkFBaUIsQ0FDekIsa0VBQWtFLENBQ25FLENBQUM7WUFDSixDQUFDO1lBRUQsaUVBQWlFO1lBQ2pFLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLE9BQU8sQ0FBQztnQkFDcEUsS0FBSyxFQUFFO29CQUNMLFVBQVUsRUFBRSwyQkFBMkIsQ0FBQyxVQUFVO29CQUNsRCxJQUFJLEVBQUUsMkJBQTJCLENBQUMsSUFBSTtvQkFDdEMsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTtpQkFDckI7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLGFBQWEsRUFBRSxDQUFDO2dCQUNsQixNQUFNLElBQUksMEJBQWlCLENBQ3pCLDBEQUEwRCxDQUMzRCxDQUFDO1lBQ0osQ0FBQztZQUVELDJDQUEyQztZQUMzQyxNQUFNLGlCQUFpQixHQUFHLElBQUEsMENBQW1CLEVBQUM7Z0JBQzVDLEdBQUcsMkJBQTJCO2dCQUM5QixHQUFHLEVBQUUsUUFBUTthQUNkLENBQUMsQ0FBQztZQUVILHdDQUF3QztZQUN4QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFFL0UsbUJBQW1CO1lBQ25CLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSwwQkFBUSxFQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzFDLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDdEIsTUFBTSxhQUFhLEdBQUcsTUFBTTtxQkFDekIsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO3FCQUNqRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2QsTUFBTSxJQUFJLDRCQUFtQixDQUFDLG9CQUFvQixhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQ3JFLENBQUM7WUFFRCxNQUFNLFdBQVcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRS9ELE1BQU0sV0FBVyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFFdEMsOEJBQThCO1lBQzlCLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQywyQkFBMkIsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVuRSxpQ0FBaUM7WUFDakMsTUFBTSxXQUFXLEdBQUcsSUFBQSxtQ0FBZSxFQUFDLGdFQUE2QixFQUFFLFdBQVcsRUFBRTtnQkFDOUUsdUJBQXVCLEVBQUUsSUFBSTtnQkFDN0Isd0JBQXdCLEVBQUUsSUFBSTthQUMvQixDQUFDLENBQUM7WUFFSCxzQkFBc0I7WUFDdEIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FDekIsR0FBRyxJQUFJLENBQUMsWUFBWSxNQUFNLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFDMUMsV0FBVyxFQUNYLElBQUksQ0FBQyxTQUFTLENBQ2YsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNiLHlDQUF5QyxXQUFXLENBQUMsRUFBRSxnQkFBZ0IsTUFBTSxFQUFFLENBQ2hGLENBQUM7WUFFRixPQUFPLFdBQVcsQ0FBQztRQUNyQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sV0FBVyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsZ0RBQWdELEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFDL0QsS0FBSyxDQUFDLEtBQUssQ0FDWixDQUFDO1lBQ0YsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO2dCQUFTLENBQUM7WUFDVCxNQUFNLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FDakIsU0FBaUIsRUFDakIsT0FBd0M7UUFFeEMsTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDaEMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBRWxDLGdDQUFnQztRQUNoQyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUM7WUFDbkQsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRTtTQUN6QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixNQUFNLElBQUksMEJBQWlCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUN4RCxDQUFDO1FBRUQsa0JBQWtCO1FBQ2xCLE1BQU0sUUFBUSxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksV0FBVyxTQUFTLFNBQVMsSUFBSSxVQUFVLEtBQUssRUFBRSxDQUFDO1FBQ3hGLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQXlDLFFBQVEsQ0FBQyxDQUFDO1FBQzdGLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDO1FBRUQsd0NBQXdDO1FBQ3hDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsWUFBWSxDQUFDO1lBQzVFLEtBQUssRUFBRTtnQkFDTCxVQUFVLEVBQUUsU0FBUztnQkFDckIsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTthQUNyQjtZQUNELEtBQUssRUFBRTtnQkFDTCxVQUFVLEVBQUUsTUFBTTthQUNuQjtZQUNELElBQUksRUFBRSxNQUFNO1lBQ1osSUFBSSxFQUFFLEtBQUs7U0FDWixDQUFDLENBQUM7UUFFSCxrQ0FBa0M7UUFDbEMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ2xDLElBQUEsbUNBQWUsRUFBQyxnRUFBNkIsRUFBRSxNQUFNLEVBQUU7WUFDckQsdUJBQXVCLEVBQUUsSUFBSTtZQUM3Qix3QkFBd0IsRUFBRSxJQUFJO1NBQy9CLENBQUMsQ0FDSCxDQUFDO1FBRUYsd0JBQXdCO1FBQ3hCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQzVDLE1BQU0sTUFBTSxHQUEyQztZQUNyRCxJQUFJO1lBQ0osSUFBSSxFQUFFO2dCQUNKLEtBQUs7Z0JBQ0wsSUFBSTtnQkFDSixLQUFLO2dCQUNMLFVBQVU7Z0JBQ1YsT0FBTyxFQUFFLElBQUksR0FBRyxVQUFVO2dCQUMxQixPQUFPLEVBQUUsSUFBSSxHQUFHLENBQUM7YUFDbEI7WUFDRCxZQUFZO1NBQ2IsQ0FBQztRQUVGLG9CQUFvQjtRQUNwQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFVO1FBQ3RCLGtCQUFrQjtRQUNsQixNQUFNLFFBQVEsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFDaEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBZ0MsUUFBUSxDQUFDLENBQUM7UUFDcEYsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxPQUFPLENBQUM7WUFDN0QsS0FBSyxFQUFFO2dCQUNMLEVBQUU7Z0JBQ0YsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTthQUNyQjtZQUNELFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQztTQUN2QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixNQUFNLElBQUksMEJBQWlCLENBQUMsOENBQThDLENBQUMsQ0FBQztRQUM5RSxDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQUcsSUFBQSxtQ0FBZSxFQUFDLGdFQUE2QixFQUFFLE1BQU0sRUFBRTtZQUN6RSx1QkFBdUIsRUFBRSxJQUFJO1lBQzdCLHdCQUF3QixFQUFFLElBQUk7U0FDL0IsQ0FBQyxDQUFDO1FBRUgsb0JBQW9CO1FBQ3BCLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbkUsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQ1YsRUFBVSxFQUNWLDJCQUF3RCxFQUN4RCxNQUFjO1FBRWQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3hELE1BQU0sV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzVCLE1BQU0sV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFFckMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsT0FBTyxDQUFDO2dCQUM3RCxLQUFLLEVBQUU7b0JBQ0wsRUFBRTtvQkFDRixVQUFVLEVBQUUsSUFBQSxnQkFBTSxHQUFFO2lCQUNyQjtnQkFDRCxTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUM7YUFDdkIsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNaLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1lBQzlFLENBQUM7WUFFRCwwQ0FBMEM7WUFDMUMsSUFBSSwyQkFBMkIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDcEMsTUFBTSxRQUFRLEdBQUcsMkJBQTJCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ3BFLE1BQU0sWUFBWSxHQUFHLElBQUksNEJBQVksRUFBRSxDQUFDO2dCQUN4QyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsRUFBUyxDQUFDLEVBQUUsQ0FBQztvQkFDaEQsTUFBTSxJQUFJLDRCQUFtQixDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNoRCxDQUFDO2dCQUVELHNEQUFzRDtnQkFDdEQsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsT0FBTyxDQUFDO29CQUN0RSxLQUFLLEVBQUU7d0JBQ0wsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO3dCQUM3QixHQUFHLEVBQUUsUUFBUTt3QkFDYixFQUFFLEVBQUUsSUFBQSxhQUFHLEVBQUMsRUFBRSxDQUFDO3dCQUNYLFVBQVUsRUFBRSxJQUFBLGdCQUFNLEdBQUU7cUJBQ3JCO2lCQUNGLENBQUMsQ0FBQztnQkFFSCxJQUFJLGVBQWUsRUFBRSxDQUFDO29CQUNwQixNQUFNLElBQUksMEJBQWlCLENBQ3pCLHlEQUF5RCxDQUMxRCxDQUFDO2dCQUNKLENBQUM7Z0JBRUQsMERBQTBEO2dCQUMxRCxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLFFBQVEsRUFBRSxDQUFDO29CQUNwQyxNQUFNLElBQUksMEJBQWlCLENBQ3pCLGtFQUFrRSxDQUNuRSxDQUFDO2dCQUNKLENBQUM7Z0JBRUQsMkJBQTJCLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQztZQUM3QyxDQUFDO1lBRUQsMkNBQTJDO1lBQzNDLElBQUksMkJBQTJCLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3JDLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLE9BQU8sQ0FBQztvQkFDcEUsS0FBSyxFQUFFO3dCQUNMLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVTt3QkFDN0IsSUFBSSxFQUFFLDJCQUEyQixDQUFDLElBQUk7d0JBQ3RDLEVBQUUsRUFBRSxJQUFBLGFBQUcsRUFBQyxFQUFFLENBQUM7d0JBQ1gsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTtxQkFDckI7aUJBQ0YsQ0FBQyxDQUFDO2dCQUVILElBQUksYUFBYSxFQUFFLENBQUM7b0JBQ2xCLE1BQU0sSUFBSSwwQkFBaUIsQ0FDekIsMERBQTBELENBQzNELENBQUM7Z0JBQ0osQ0FBQztZQUNILENBQUM7WUFFRCwrQ0FBK0M7WUFDL0MsTUFBTSxpQkFBaUIsR0FBRyxJQUFBLDBDQUFtQixFQUFDLEVBQUUsR0FBRywyQkFBMkIsRUFBRSxDQUFDLENBQUM7WUFFbEYsa0JBQWtCO1lBQ2xCLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBRS9CLG1CQUFtQjtZQUNuQixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsMEJBQVEsRUFBQyxNQUFNLENBQUMsQ0FBQztZQUN0QyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RCLE1BQU0sYUFBYSxHQUFHLE1BQU07cUJBQ3pCLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztxQkFDakUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNkLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyxvQkFBb0IsYUFBYSxFQUFFLENBQUMsQ0FBQztZQUNyRSxDQUFDO1lBRUQsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRWhFLE1BQU0sV0FBVyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFFdEMsa0JBQWtCO1lBQ2xCLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRWxELE1BQU0sV0FBVyxHQUFHLElBQUEsbUNBQWUsRUFBQyxnRUFBNkIsRUFBRSxnQkFBZ0IsRUFBRTtnQkFDbkYsdUJBQXVCLEVBQUUsSUFBSTtnQkFDN0Isd0JBQXdCLEVBQUUsSUFBSTthQUMvQixDQUFDLENBQUM7WUFFSCxrQkFBa0I7WUFDbEIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FDekIsR0FBRyxJQUFJLENBQUMsWUFBWSxNQUFNLEVBQUUsRUFBRSxFQUM5QixXQUFXLEVBQ1gsSUFBSSxDQUFDLFNBQVMsQ0FDZixDQUFDO1lBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsNkNBQTZDLEVBQUUsZ0JBQWdCLE1BQU0sRUFBRSxDQUN4RSxDQUFDO1lBRUYsT0FBTyxXQUFXLENBQUM7UUFDckIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixNQUFNLFdBQVcsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLG9EQUFvRCxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQ25FLEtBQUssQ0FBQyxLQUFLLENBQ1osQ0FBQztZQUNGLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztnQkFBUyxDQUFDO1lBQ1QsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUIsQ0FBQztJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFVLEVBQUUsTUFBYztRQUNyQyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxPQUFPLENBQUM7WUFDN0QsS0FBSyxFQUFFO2dCQUNMLEVBQUU7Z0JBQ0YsVUFBVSxFQUFFLElBQUEsZ0JBQU0sR0FBRTthQUNyQjtTQUNGLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFFRCxjQUFjO1FBQ2QsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQy9CLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVyRCxrQkFBa0I7UUFDbEIsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsMkNBQTJDLEVBQUUsZ0JBQWdCLE1BQU0sRUFBRSxDQUN0RSxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQVc7UUFDekIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFeEMsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEVBQUUsRUFBRSxDQUFDO1lBQzNCLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUM7WUFDM0QsS0FBSyxFQUFFO2dCQUNMLEdBQUcsRUFBRSxRQUFRO2dCQUNiLFVBQVUsRUFBRSxJQUFBLGdCQUFNLEdBQUU7YUFDckI7WUFDRCxTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDdEIsS0FBSyxFQUFFO2dCQUNMLFVBQVUsRUFBRSxNQUFNO2FBQ25CO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FDNUIsSUFBQSxtQ0FBZSxFQUFDLGdFQUE2QixFQUFFLE1BQU0sRUFBRTtZQUNyRCx1QkFBdUIsRUFBRSxJQUFJO1lBQzdCLHdCQUF3QixFQUFFLElBQUk7U0FDL0IsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxTQUFpQjtRQUNsRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUM7WUFDM0QsS0FBSyxFQUFFO2dCQUNMLFVBQVUsRUFBRSxTQUFTO2dCQUNyQixVQUFVLEVBQUUsSUFBQSxnQkFBTSxHQUFFO2FBQ3JCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUNwQyxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQzdFLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sVUFBVSxHQUFHLGVBQWUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxRSxNQUFNLFVBQVUsR0FBRyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFdEcsT0FBTztZQUNMLFlBQVk7WUFDWixVQUFVO1lBQ1YsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUc7WUFDOUMsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUc7WUFDOUMsZUFBZTtTQUNoQixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxLQUFLLENBQUMsZUFBZSxDQUFDLFNBQWlCLEVBQUUsUUFBaUI7UUFDaEUsTUFBTSxRQUFRLEdBQUc7WUFDZixHQUFHLElBQUksQ0FBQyxZQUFZLFdBQVcsU0FBUyxJQUFJO1lBQzVDLGNBQWMsU0FBUyxFQUFFO1lBQ3pCLGdCQUFnQjtTQUNqQixDQUFDO1FBRUYsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNiLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxNQUFNLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUVELEtBQUssTUFBTSxPQUFPLElBQUksUUFBUSxFQUFFLENBQUM7WUFDL0IsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QyxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUF2ZVksOERBQXlCO29DQUF6Qix5QkFBeUI7SUFEckMsSUFBQSxtQkFBVSxHQUFFO0lBT1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLCtDQUFrQixDQUFDLENBQUE7SUFFcEMsV0FBQSxJQUFBLDBCQUFnQixFQUFDLHdCQUFPLENBQUMsQ0FBQTt5REFEcUIsb0JBQVUsb0JBQVYsb0JBQVUsb0RBRXJCLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNmLG9CQUFZLG9CQUFaLG9CQUFZLG9EQUNkLG9CQUFVLG9CQUFWLG9CQUFVO0dBWDlCLHlCQUF5QixDQXVlckMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHNlcnZpY2VzXFxjb21wb3NpY2FvLWZhbWlsaWFyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBJbmplY3RhYmxlLFxyXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxyXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxyXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXHJcbiAgTG9nZ2VyLFxyXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIERhdGFTb3VyY2UsIElzTnVsbCwgTm90IH0gZnJvbSAndHlwZW9ybSc7XHJcbmltcG9ydCB7IHBsYWluVG9JbnN0YW5jZSB9IGZyb20gJ2NsYXNzLXRyYW5zZm9ybWVyJztcclxuaW1wb3J0IHsgdmFsaWRhdGUgfSBmcm9tICdjbGFzcy12YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBDb21wb3NpY2FvRmFtaWxpYXIgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9jb21wb3NpY2FvLWZhbWlsaWFyLmVudGl0eSc7XHJcbmltcG9ydCB7IENpZGFkYW8gfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9jaWRhZGFvLmVudGl0eSc7XHJcbmltcG9ydCB7IENyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byB9IGZyb20gJy4uL2R0by9jcmVhdGUtY29tcG9zaWNhby1mYW1pbGlhci5kdG8nO1xyXG5pbXBvcnQgeyBVcGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8gfSBmcm9tICcuLi9kdG8vdXBkYXRlLWNvbXBvc2ljYW8tZmFtaWxpYXIuZHRvJztcclxuaW1wb3J0IHtcclxuICBDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0byxcclxuICBDb21wb3NpY2FvRmFtaWxpYXJQYWdpbmF0ZWRSZXNwb25zZUR0byxcclxufSBmcm9tICcuLi9kdG8vY29tcG9zaWNhby1mYW1pbGlhci1yZXNwb25zZS5kdG8nO1xyXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvY2FjaGUnO1xyXG5pbXBvcnQgeyBDUEZWYWxpZGF0b3IgfSBmcm9tICcuLi92YWxpZGF0b3JzL2NwZi12YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBub3JtYWxpemVFbnVtRmllbGRzIH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL3V0aWxzL2VudW0tbm9ybWFsaXplci51dGlsJztcclxuXHJcbi8qKlxyXG4gKiBTZXJ2acOnbyBkZSBDb21wb3Npw6fDo28gRmFtaWxpYXJcclxuICpcclxuICogUmVzcG9uc8OhdmVsIHBlbGEgbMOzZ2ljYSBkZSBuZWfDs2NpbyByZWxhY2lvbmFkYSBhb3MgbWVtYnJvcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgZG9zIGNpZGFkw6Nvcy5cclxuICogSW1wbGVtZW50YSBvcGVyYcOnw7VlcyBDUlVEIGNvbXBsZXRhcyBjb20gdmFsaWRhw6fDtWVzIGVzcGVjw61maWNhcywgY2FjaGUgZSBhdWRpdG9yaWEuXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDb21wb3NpY2FvRmFtaWxpYXJTZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQ29tcG9zaWNhb0ZhbWlsaWFyU2VydmljZS5uYW1lKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IENBQ0hFX1RUTCA9IDM2MDA7IC8vIDEgaG9yYVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FDSEVfUFJFRklYID0gJ2NvbXBvc2ljYW9fZmFtaWxpYXI6JztcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0UmVwb3NpdG9yeShDb21wb3NpY2FvRmFtaWxpYXIpXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Q29tcG9zaWNhb0ZhbWlsaWFyPixcclxuICAgIEBJbmplY3RSZXBvc2l0b3J5KENpZGFkYW8pXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNpZGFkYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PENpZGFkYW8+LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZSxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSxcclxuICApIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyaWEgdW0gbm92byBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyXHJcbiAgICogQHBhcmFtIGNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byBEYWRvcyBkbyBtZW1icm8gZmFtaWxpYXJcclxuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBjcmlhbmRvXHJcbiAgICogQHJldHVybnMgTWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBjcmlhZG9cclxuICAgKi9cclxuICBhc3luYyBjcmVhdGUoXHJcbiAgICBjcmVhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG86IENyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byxcclxuICAgIHVzZXJJZDogc3RyaW5nLFxyXG4gICk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+IHtcclxuICAgIGNvbnN0IHF1ZXJ5UnVubmVyID0gdGhpcy5kYXRhU291cmNlLmNyZWF0ZVF1ZXJ5UnVubmVyKCk7XHJcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb25uZWN0KCk7XHJcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5zdGFydFRyYW5zYWN0aW9uKCk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gVmFsaWRhciBzZSBvIGNpZGFkw6NvIGV4aXN0ZVxyXG4gICAgICBjb25zdCBjaWRhZGFvID0gYXdhaXQgdGhpcy5jaWRhZGFvUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgICB3aGVyZTogeyBpZDogY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNpZGFkYW9faWQgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoIWNpZGFkYW8pIHtcclxuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NpZGFkw6NvIG7Do28gZW5jb250cmFkbycpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBWYWxpZGFyIENQRlxyXG4gICAgICBjb25zdCBjcGZMaW1wbyA9IGNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5jcGYucmVwbGFjZSgvXFxEL2csICcnKTtcclxuICAgICAgY29uc3QgY3BmVmFsaWRhdG9yID0gbmV3IENQRlZhbGlkYXRvcigpO1xyXG4gICAgICBpZiAoIWNwZlZhbGlkYXRvci52YWxpZGF0ZShjcGZMaW1wbywge30gYXMgYW55KSkge1xyXG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDUEYgaW52w6FsaWRvJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlIG1lbWJybyBjb20gbyBtZXNtbyBDUEYgbmEgY29tcG9zacOnw6NvIGZhbWlsaWFyIGRvIGNpZGFkw6NvXHJcbiAgICAgIGNvbnN0IG1lbWJyb0V4aXN0ZW50ZSA9IGF3YWl0IHRoaXMuY29tcG9zaWNhb0ZhbWlsaWFyUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgY2lkYWRhb19pZDogY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNpZGFkYW9faWQsXHJcbiAgICAgICAgICBjcGY6IGNwZkxpbXBvLFxyXG4gICAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAobWVtYnJvRXhpc3RlbnRlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxyXG4gICAgICAgICAgJ0rDoSBleGlzdGUgdW0gbWVtYnJvIGNvbSBlc3RlIENQRiBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXInLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvIENQRiBuw6NvIMOpIG8gbWVzbW8gZG8gY2lkYWTDo28gcmVzcG9uc8OhdmVsXHJcbiAgICAgIGlmIChjaWRhZGFvLmNwZiA9PT0gY3BmTGltcG8pIHtcclxuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXHJcbiAgICAgICAgICAnTyBDUEYgZG8gbWVtYnJvIG7Do28gcG9kZSBzZXIgaWd1YWwgYW8gQ1BGIGRvIGNpZGFkw6NvIHJlc3BvbnPDoXZlbCcsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gVmFsaWRhciBzZSBvIG5vbWUgbsOjbyDDqSBkdXBsaWNhZG8gbmEgbWVzbWEgY29tcG9zacOnw6NvIGZhbWlsaWFyXHJcbiAgICAgIGNvbnN0IG5vbWVFeGlzdGVudGUgPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgIGNpZGFkYW9faWQ6IGNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5jaWRhZGFvX2lkLFxyXG4gICAgICAgICAgbm9tZTogY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLm5vbWUsXHJcbiAgICAgICAgICByZW1vdmVkX2F0OiBJc051bGwoKSxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGlmIChub21lRXhpc3RlbnRlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxyXG4gICAgICAgICAgJ0rDoSBleGlzdGUgdW0gbWVtYnJvIGNvbSBlc3RlIG5vbWUgbmEgY29tcG9zacOnw6NvIGZhbWlsaWFyJyxcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBOb3JtYWxpemFyIGNhbXBvcyBkZSBlbnVtIGFudGVzIGRlIGNyaWFyXHJcbiAgICAgIGNvbnN0IGRhZG9zTm9ybWFsaXphZG9zID0gbm9ybWFsaXplRW51bUZpZWxkcyh7XHJcbiAgICAgICAgLi4uY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLFxyXG4gICAgICAgIGNwZjogY3BmTGltcG8sXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gQ3JpYXIgbyBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyXHJcbiAgICAgIGNvbnN0IG5vdm9NZW1icm8gPSB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuY3JlYXRlKGRhZG9zTm9ybWFsaXphZG9zKTtcclxuXHJcbiAgICAgIC8vIFZhbGlkYXIgZW50aWRhZGVcclxuICAgICAgY29uc3QgZXJyb3JzID0gYXdhaXQgdmFsaWRhdGUobm92b01lbWJybyk7XHJcbiAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZXMgPSBlcnJvcnNcclxuICAgICAgICAgIC5tYXAoKGVycm9yKSA9PiBPYmplY3QudmFsdWVzKGVycm9yLmNvbnN0cmFpbnRzIHx8IHt9KS5qb2luKCcsICcpKVxyXG4gICAgICAgICAgLmpvaW4oJzsgJyk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYERhZG9zIGludsOhbGlkb3M6ICR7ZXJyb3JNZXNzYWdlc31gKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbWVtYnJvU2Fsdm8gPSBhd2FpdCBxdWVyeVJ1bm5lci5tYW5hZ2VyLnNhdmUobm92b01lbWJybyk7XHJcblxyXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb21taXRUcmFuc2FjdGlvbigpO1xyXG5cclxuICAgICAgLy8gSW52YWxpZGFyIGNhY2hlIHJlbGFjaW9uYWRvXHJcbiAgICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZUNhY2hlKGNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5jaWRhZGFvX2lkKTtcclxuXHJcbiAgICAgIC8vIENvbnZlcnRlciBwYXJhIERUTyBkZSByZXNwb3N0YVxyXG4gICAgICBjb25zdCByZXNwb25zZUR0byA9IHBsYWluVG9JbnN0YW5jZShDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0bywgbWVtYnJvU2Fsdm8sIHtcclxuICAgICAgICBleGNsdWRlRXh0cmFuZW91c1ZhbHVlczogdHJ1ZSxcclxuICAgICAgICBlbmFibGVJbXBsaWNpdENvbnZlcnNpb246IHRydWUsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gQ2FjaGVhciBvIHJlc3VsdGFkb1xyXG4gICAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXHJcbiAgICAgICAgYCR7dGhpcy5DQUNIRV9QUkVGSVh9aWQ6JHttZW1icm9TYWx2by5pZH1gLFxyXG4gICAgICAgIHJlc3BvbnNlRHRvLFxyXG4gICAgICAgIHRoaXMuQ0FDSEVfVFRMLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxyXG4gICAgICAgIGBNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIGNyaWFkbzogJHttZW1icm9TYWx2by5pZH0gcG9yIHVzdcOhcmlvICR7dXNlcklkfWAsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4gcmVzcG9uc2VEdG87XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5yb2xsYmFja1RyYW5zYWN0aW9uKCk7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxyXG4gICAgICAgIGBFcnJvIGFvIGNyaWFyIG1lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXI6ICR7ZXJyb3IubWVzc2FnZX1gLFxyXG4gICAgICAgIGVycm9yLnN0YWNrLFxyXG4gICAgICApO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLnJlbGVhc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExpc3RhIG1lbWJyb3MgZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIHBvciBjaWRhZMOjb1xyXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cclxuICAgKiBAcGFyYW0gb3B0aW9ucyBPcMOnw7VlcyBkZSBwYWdpbmHDp8Ojb1xyXG4gICAqIEByZXR1cm5zIExpc3RhIHBhZ2luYWRhIGRlIG1lbWJyb3NcclxuICAgKi9cclxuICBhc3luYyBmaW5kQnlDaWRhZGFvKFxyXG4gICAgY2lkYWRhb0lkOiBzdHJpbmcsXHJcbiAgICBvcHRpb25zOiB7IHBhZ2U6IG51bWJlcjsgbGltaXQ6IG51bWJlciB9LFxyXG4gICk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUGFnaW5hdGVkUmVzcG9uc2VEdG8+IHtcclxuICAgIGNvbnN0IHsgcGFnZSwgbGltaXQgfSA9IG9wdGlvbnM7XHJcbiAgICBjb25zdCBvZmZzZXQgPSAocGFnZSAtIDEpICogbGltaXQ7XHJcblxyXG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gY2lkYWTDo28gZXhpc3RlXHJcbiAgICBjb25zdCBjaWRhZGFvID0gYXdhaXQgdGhpcy5jaWRhZGFvUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgd2hlcmU6IHsgaWQ6IGNpZGFkYW9JZCB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFjaWRhZGFvKSB7XHJcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQ2lkYWTDo28gbsOjbyBlbmNvbnRyYWRvJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVmVyaWZpY2FyIGNhY2hlXHJcbiAgICBjb25zdCBjYWNoZUtleSA9IGAke3RoaXMuQ0FDSEVfUFJFRklYfWNpZGFkYW86JHtjaWRhZGFvSWR9OnBhZ2U6JHtwYWdlfTpsaW1pdDoke2xpbWl0fWA7XHJcbiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQ8Q29tcG9zaWNhb0ZhbWlsaWFyUGFnaW5hdGVkUmVzcG9uc2VEdG8+KGNhY2hlS2V5KTtcclxuICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgcmV0dXJuIGNhY2hlZDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBCdXNjYXIgbWVtYnJvcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcclxuICAgIGNvbnN0IFttZW1icm9zLCB0b3RhbF0gPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZEFuZENvdW50KHtcclxuICAgICAgd2hlcmU6IHtcclxuICAgICAgICBjaWRhZGFvX2lkOiBjaWRhZGFvSWQsXHJcbiAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXHJcbiAgICAgIH0sXHJcbiAgICAgIG9yZGVyOiB7XHJcbiAgICAgICAgY3JlYXRlZF9hdDogJ0RFU0MnLFxyXG4gICAgICB9LFxyXG4gICAgICBza2lwOiBvZmZzZXQsXHJcbiAgICAgIHRha2U6IGxpbWl0LFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQ29udmVydGVyIHBhcmEgRFRPcyBkZSByZXNwb3N0YVxyXG4gICAgY29uc3QgZGF0YSA9IG1lbWJyb3MubWFwKChtZW1icm8pID0+XHJcbiAgICAgIHBsYWluVG9JbnN0YW5jZShDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0bywgbWVtYnJvLCB7XHJcbiAgICAgICAgZXhjbHVkZUV4dHJhbmVvdXNWYWx1ZXM6IHRydWUsXHJcbiAgICAgICAgZW5hYmxlSW1wbGljaXRDb252ZXJzaW9uOiB0cnVlLFxyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgLy8gQ2FsY3VsYXIgZXN0YXTDrXN0aWNhc1xyXG4gICAgY29uc3QgZXN0YXRpc3RpY2FzID0gYXdhaXQgdGhpcy5jYWxjdWxhckVzdGF0aXN0aWNhcyhjaWRhZGFvSWQpO1xyXG5cclxuICAgIGNvbnN0IHRvdGFsUGFnZXMgPSBNYXRoLmNlaWwodG90YWwgLyBsaW1pdCk7XHJcbiAgICBjb25zdCByZXN1bHQ6IENvbXBvc2ljYW9GYW1pbGlhclBhZ2luYXRlZFJlc3BvbnNlRHRvID0ge1xyXG4gICAgICBkYXRhLFxyXG4gICAgICBtZXRhOiB7XHJcbiAgICAgICAgdG90YWwsXHJcbiAgICAgICAgcGFnZSxcclxuICAgICAgICBsaW1pdCxcclxuICAgICAgICB0b3RhbFBhZ2VzLFxyXG4gICAgICAgIGhhc05leHQ6IHBhZ2UgPCB0b3RhbFBhZ2VzLFxyXG4gICAgICAgIGhhc1ByZXY6IHBhZ2UgPiAxLFxyXG4gICAgICB9LFxyXG4gICAgICBlc3RhdGlzdGljYXMsXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIENhY2hlYXIgcmVzdWx0YWRvXHJcbiAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoY2FjaGVLZXksIHJlc3VsdCwgdGhpcy5DQUNIRV9UVEwpO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBCdXNjYSB1bSBtZW1icm8gZXNwZWPDrWZpY28gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyXHJcbiAgICogQHBhcmFtIGlkIElEIGRvIG1lbWJyb1xyXG4gICAqIEByZXR1cm5zIERhZG9zIGRvIG1lbWJyb1xyXG4gICAqL1xyXG4gIGFzeW5jIGZpbmRPbmUoaWQ6IHN0cmluZyk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+IHtcclxuICAgIC8vIFZlcmlmaWNhciBjYWNoZVxyXG4gICAgY29uc3QgY2FjaGVLZXkgPSBgJHt0aGlzLkNBQ0hFX1BSRUZJWH1pZDoke2lkfWA7XHJcbiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQ8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+KGNhY2hlS2V5KTtcclxuICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgcmV0dXJuIGNhY2hlZDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtZW1icm8gPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgaWQsXHJcbiAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbGF0aW9uczogWydjaWRhZGFvJ10sXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoIW1lbWJybykge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ01lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgbsOjbyBlbmNvbnRyYWRvJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2VEdG8gPSBwbGFpblRvSW5zdGFuY2UoQ29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8sIG1lbWJybywge1xyXG4gICAgICBleGNsdWRlRXh0cmFuZW91c1ZhbHVlczogdHJ1ZSxcclxuICAgICAgZW5hYmxlSW1wbGljaXRDb252ZXJzaW9uOiB0cnVlLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQ2FjaGVhciByZXN1bHRhZG9cclxuICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChjYWNoZUtleSwgcmVzcG9uc2VEdG8sIHRoaXMuQ0FDSEVfVFRMKTtcclxuXHJcbiAgICByZXR1cm4gcmVzcG9uc2VEdG87XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBdHVhbGl6YSB1bSBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyXHJcbiAgICogQHBhcmFtIGlkIElEIGRvIG1lbWJyb1xyXG4gICAqIEBwYXJhbSB1cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8gRGFkb3MgcGFyYSBhdHVhbGl6YcOnw6NvXHJcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpbyBxdWUgZXN0w6EgYXR1YWxpemFuZG9cclxuICAgKiBAcmV0dXJucyBNZW1icm8gYXR1YWxpemFkb1xyXG4gICAqL1xyXG4gIGFzeW5jIHVwZGF0ZShcclxuICAgIGlkOiBzdHJpbmcsXHJcbiAgICB1cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG86IFVwZGF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byxcclxuICAgIHVzZXJJZDogc3RyaW5nLFxyXG4gICk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+IHtcclxuICAgIGNvbnN0IHF1ZXJ5UnVubmVyID0gdGhpcy5kYXRhU291cmNlLmNyZWF0ZVF1ZXJ5UnVubmVyKCk7XHJcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb25uZWN0KCk7XHJcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5zdGFydFRyYW5zYWN0aW9uKCk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgbWVtYnJvID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgICBpZCxcclxuICAgICAgICAgIHJlbW92ZWRfYXQ6IElzTnVsbCgpLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVsYXRpb25zOiBbJ2NpZGFkYW8nXSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoIW1lbWJybykge1xyXG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBuw6NvIGVuY29udHJhZG8nKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gU2UgbyBDUEYgZXN0w6Egc2VuZG8gYXR1YWxpemFkbywgdmFsaWRhclxyXG4gICAgICBpZiAodXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNwZikge1xyXG4gICAgICAgIGNvbnN0IGNwZkxpbXBvID0gdXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNwZi5yZXBsYWNlKC9cXEQvZywgJycpO1xyXG4gICAgICAgIGNvbnN0IGNwZlZhbGlkYXRvciA9IG5ldyBDUEZWYWxpZGF0b3IoKTtcclxuICAgICAgICBpZiAoIWNwZlZhbGlkYXRvci52YWxpZGF0ZShjcGZMaW1wbywge30gYXMgYW55KSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0NQRiBpbnbDoWxpZG8nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlIG91dHJvIG1lbWJybyBjb20gbyBtZXNtbyBDUEZcclxuICAgICAgICBjb25zdCBtZW1icm9FeGlzdGVudGUgPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICBjaWRhZGFvX2lkOiBtZW1icm8uY2lkYWRhb19pZCxcclxuICAgICAgICAgICAgY3BmOiBjcGZMaW1wbyxcclxuICAgICAgICAgICAgaWQ6IE5vdChpZCksXHJcbiAgICAgICAgICAgIHJlbW92ZWRfYXQ6IElzTnVsbCgpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKG1lbWJyb0V4aXN0ZW50ZSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxyXG4gICAgICAgICAgICAnSsOhIGV4aXN0ZSB1bSBtZW1icm8gY29tIGVzdGUgQ1BGIG5hIGNvbXBvc2nDp8OjbyBmYW1pbGlhcicsXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gQ1BGIG7Do28gw6kgbyBtZXNtbyBkbyBjaWRhZMOjbyByZXNwb25zw6F2ZWxcclxuICAgICAgICBpZiAobWVtYnJvLmNpZGFkYW8uY3BmID09PSBjcGZMaW1wbykge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxyXG4gICAgICAgICAgICAnTyBDUEYgZG8gbWVtYnJvIG7Do28gcG9kZSBzZXIgaWd1YWwgYW8gQ1BGIGRvIGNpZGFkw6NvIHJlc3BvbnPDoXZlbCcsXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNwZiA9IGNwZkxpbXBvO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBTZSBvIG5vbWUgZXN0w6Egc2VuZG8gYXR1YWxpemFkbywgdmFsaWRhclxyXG4gICAgICBpZiAodXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLm5vbWUpIHtcclxuICAgICAgICBjb25zdCBub21lRXhpc3RlbnRlID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAgY2lkYWRhb19pZDogbWVtYnJvLmNpZGFkYW9faWQsXHJcbiAgICAgICAgICAgIG5vbWU6IHVwZGF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5ub21lLFxyXG4gICAgICAgICAgICBpZDogTm90KGlkKSxcclxuICAgICAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAobm9tZUV4aXN0ZW50ZSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxyXG4gICAgICAgICAgICAnSsOhIGV4aXN0ZSB1bSBtZW1icm8gY29tIGVzdGUgbm9tZSBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXInLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE5vcm1hbGl6YXIgY2FtcG9zIGRlIGVudW0gYW50ZXMgZGUgYXR1YWxpemFyXHJcbiAgICAgIGNvbnN0IGRhZG9zTm9ybWFsaXphZG9zID0gbm9ybWFsaXplRW51bUZpZWxkcyh7IC4uLnVwZGF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byB9KTtcclxuXHJcbiAgICAgIC8vIEF0dWFsaXphciBkYWRvc1xyXG4gICAgICBPYmplY3QuYXNzaWduKG1lbWJybywgZGFkb3NOb3JtYWxpemFkb3MpO1xyXG4gICAgICBtZW1icm8udXBkYXRlZF9hdCA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgICAvLyBWYWxpZGFyIGVudGlkYWRlXHJcbiAgICAgIGNvbnN0IGVycm9ycyA9IGF3YWl0IHZhbGlkYXRlKG1lbWJybyk7XHJcbiAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZXMgPSBlcnJvcnNcclxuICAgICAgICAgIC5tYXAoKGVycm9yKSA9PiBPYmplY3QudmFsdWVzKGVycm9yLmNvbnN0cmFpbnRzIHx8IHt9KS5qb2luKCcsICcpKVxyXG4gICAgICAgICAgLmpvaW4oJzsgJyk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYERhZG9zIGludsOhbGlkb3M6ICR7ZXJyb3JNZXNzYWdlc31gKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbWVtYnJvQXR1YWxpemFkbyA9IGF3YWl0IHF1ZXJ5UnVubmVyLm1hbmFnZXIuc2F2ZShtZW1icm8pO1xyXG5cclxuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIuY29tbWl0VHJhbnNhY3Rpb24oKTtcclxuXHJcbiAgICAgIC8vIEludmFsaWRhciBjYWNoZVxyXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVDYWNoZShtZW1icm8uY2lkYWRhb19pZCwgaWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2VEdG8gPSBwbGFpblRvSW5zdGFuY2UoQ29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8sIG1lbWJyb0F0dWFsaXphZG8sIHtcclxuICAgICAgICBleGNsdWRlRXh0cmFuZW91c1ZhbHVlczogdHJ1ZSxcclxuICAgICAgICBlbmFibGVJbXBsaWNpdENvbnZlcnNpb246IHRydWUsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gQXR1YWxpemFyIGNhY2hlXHJcbiAgICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChcclxuICAgICAgICBgJHt0aGlzLkNBQ0hFX1BSRUZJWH1pZDoke2lkfWAsXHJcbiAgICAgICAgcmVzcG9uc2VEdG8sXHJcbiAgICAgICAgdGhpcy5DQUNIRV9UVEwsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXHJcbiAgICAgICAgYE1lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgYXR1YWxpemFkbzogJHtpZH0gcG9yIHVzdcOhcmlvICR7dXNlcklkfWAsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4gcmVzcG9uc2VEdG87XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5yb2xsYmFja1RyYW5zYWN0aW9uKCk7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxyXG4gICAgICAgIGBFcnJvIGFvIGF0dWFsaXphciBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyOiAke2Vycm9yLm1lc3NhZ2V9YCxcclxuICAgICAgICBlcnJvci5zdGFjayxcclxuICAgICAgKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5yZWxlYXNlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmUgdW0gbWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciAoc29mdCBkZWxldGUpXHJcbiAgICogQHBhcmFtIGlkIElEIGRvIG1lbWJyb1xyXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIHJlbW92ZW5kb1xyXG4gICAqL1xyXG4gIGFzeW5jIHJlbW92ZShpZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgbWVtYnJvID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICB3aGVyZToge1xyXG4gICAgICAgIGlkLFxyXG4gICAgICAgIHJlbW92ZWRfYXQ6IElzTnVsbCgpLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFtZW1icm8pIHtcclxuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIG7Do28gZW5jb250cmFkbycpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFNvZnQgZGVsZXRlXHJcbiAgICBtZW1icm8ucmVtb3ZlZF9hdCA9IG5ldyBEYXRlKCk7XHJcbiAgICBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuc2F2ZShtZW1icm8pO1xyXG5cclxuICAgIC8vIEludmFsaWRhciBjYWNoZVxyXG4gICAgYXdhaXQgdGhpcy5pbnZhbGlkYXRlQ2FjaGUobWVtYnJvLmNpZGFkYW9faWQsIGlkKTtcclxuXHJcbiAgICB0aGlzLmxvZ2dlci5sb2coXHJcbiAgICAgIGBNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIHJlbW92aWRvOiAke2lkfSBwb3IgdXN1w6FyaW8gJHt1c2VySWR9YCxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBCdXNjYSBtZW1icm9zIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBwb3IgQ1BGXHJcbiAgICogQHBhcmFtIGNwZiBDUEYgcGFyYSBidXNjYVxyXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIG1lbWJyb3MgZW5jb250cmFkb3NcclxuICAgKi9cclxuICBhc3luYyBmaW5kQnlDcGYoY3BmOiBzdHJpbmcpOiBQcm9taXNlPENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvW10+IHtcclxuICAgIGNvbnN0IGNwZkxpbXBvID0gY3BmLnJlcGxhY2UoL1xcRC9nLCAnJyk7XHJcblxyXG4gICAgaWYgKGNwZkxpbXBvLmxlbmd0aCAhPT0gMTEpIHtcclxuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0NQRiBkZXZlIHRlciAxMSBkw61naXRvcycpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG1lbWJyb3MgPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZCh7XHJcbiAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgY3BmOiBjcGZMaW1wbyxcclxuICAgICAgICByZW1vdmVkX2F0OiBJc051bGwoKSxcclxuICAgICAgfSxcclxuICAgICAgcmVsYXRpb25zOiBbJ2NpZGFkYW8nXSxcclxuICAgICAgb3JkZXI6IHtcclxuICAgICAgICBjcmVhdGVkX2F0OiAnREVTQycsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gbWVtYnJvcy5tYXAoKG1lbWJybykgPT5cclxuICAgICAgcGxhaW5Ub0luc3RhbmNlKENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvLCBtZW1icm8sIHtcclxuICAgICAgICBleGNsdWRlRXh0cmFuZW91c1ZhbHVlczogdHJ1ZSxcclxuICAgICAgICBlbmFibGVJbXBsaWNpdENvbnZlcnNpb246IHRydWUsXHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGN1bGEgZXN0YXTDrXN0aWNhcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcclxuICAgKiBAcGFyYW0gY2lkYWRhb0lkIElEIGRvIGNpZGFkw6NvXHJcbiAgICogQHJldHVybnMgRXN0YXTDrXN0aWNhcyBjYWxjdWxhZGFzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBjYWxjdWxhckVzdGF0aXN0aWNhcyhjaWRhZGFvSWQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgbWVtYnJvcyA9IGF3YWl0IHRoaXMuY29tcG9zaWNhb0ZhbWlsaWFyUmVwb3NpdG9yeS5maW5kKHtcclxuICAgICAgd2hlcmU6IHtcclxuICAgICAgICBjaWRhZGFvX2lkOiBjaWRhZGFvSWQsXHJcbiAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCB0b3RhbE1lbWJyb3MgPSBtZW1icm9zLmxlbmd0aDtcclxuICAgIGNvbnN0IG1lbWJyb3NDb21SZW5kYSA9IG1lbWJyb3MuZmlsdGVyKChtKSA9PiBtLnJlbmRhICYmIG0ucmVuZGEgPiAwKS5sZW5ndGg7XHJcbiAgICBjb25zdCByZW5kYVRvdGFsID0gbWVtYnJvcy5yZWR1Y2UoKHN1bSwgbSkgPT4gc3VtICsgKG0ucmVuZGEgfHwgMCksIDApO1xyXG4gICAgY29uc3QgcmVuZGFNZWRpYSA9IG1lbWJyb3NDb21SZW5kYSA+IDAgPyByZW5kYVRvdGFsIC8gbWVtYnJvc0NvbVJlbmRhIDogMDtcclxuICAgIGNvbnN0IGlkYWRlTWVkaWEgPSB0b3RhbE1lbWJyb3MgPiAwID8gbWVtYnJvcy5yZWR1Y2UoKHN1bSwgbSkgPT4gc3VtICsgbS5pZGFkZSwgMCkgLyB0b3RhbE1lbWJyb3MgOiAwO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRvdGFsTWVtYnJvcyxcclxuICAgICAgcmVuZGFUb3RhbCxcclxuICAgICAgcmVuZGFNZWRpYTogTWF0aC5yb3VuZChyZW5kYU1lZGlhICogMTAwKSAvIDEwMCxcclxuICAgICAgaWRhZGVNZWRpYTogTWF0aC5yb3VuZChpZGFkZU1lZGlhICogMTAwKSAvIDEwMCxcclxuICAgICAgbWVtYnJvc0NvbVJlbmRhLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEludmFsaWRhIGNhY2hlIHJlbGFjaW9uYWRvIMOgIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxyXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cclxuICAgKiBAcGFyYW0gbWVtYnJvSWQgSUQgZG8gbWVtYnJvIChvcGNpb25hbClcclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIGludmFsaWRhdGVDYWNoZShjaWRhZGFvSWQ6IHN0cmluZywgbWVtYnJvSWQ/OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHBhdHRlcm5zID0gW1xyXG4gICAgICBgJHt0aGlzLkNBQ0hFX1BSRUZJWH1jaWRhZGFvOiR7Y2lkYWRhb0lkfToqYCxcclxuICAgICAgYGNpZGFkYW86aWQ6JHtjaWRhZGFvSWR9YCxcclxuICAgICAgYGNpZGFkYW86bGlzdDoqYCxcclxuICAgIF07XHJcblxyXG4gICAgaWYgKG1lbWJyb0lkKSB7XHJcbiAgICAgIHBhdHRlcm5zLnB1c2goYCR7dGhpcy5DQUNIRV9QUkVGSVh9aWQ6JHttZW1icm9JZH1gKTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgcGF0dGVybnMpIHtcclxuICAgICAgYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZGVsKHBhdHRlcm4pO1xyXG4gICAgfVxyXG4gIH1cclxufSJdLCJ2ZXJzaW9uIjozfQ==