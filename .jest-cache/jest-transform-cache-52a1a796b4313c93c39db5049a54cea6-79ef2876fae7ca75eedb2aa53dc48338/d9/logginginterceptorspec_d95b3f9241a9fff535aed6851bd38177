89b6604bfc6f3b374b2fae35b6bcd033
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const logging_interceptor_1 = require("../logging.interceptor");
const logging_service_1 = require("../logging.service");
const rxjs_1 = require("rxjs");
/**
 * Testes unitários para o interceptor de logging
 *
 * Verifica o funcionamento do interceptor que registra
 * informações sobre requisições HTTP
 */
describe('LoggingInterceptor', () => {
    let interceptor;
    let loggingService;
    // Mock do serviço de logging
    const mockLoggingService = {
        info: jest.fn(),
        debug: jest.fn(),
        error: jest.fn(),
    };
    beforeEach(async () => {
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            providers: [
                logging_interceptor_1.LoggingInterceptor,
                {
                    provide: logging_service_1.LoggingService,
                    useValue: mockLoggingService,
                },
            ],
        }).compile();
        interceptor = module.get(logging_interceptor_1.LoggingInterceptor);
        loggingService = module.get(logging_service_1.LoggingService);
        // Mock para Date.now()
        jest
            .spyOn(Date, 'now')
            .mockImplementationOnce(() => 1000)
            .mockImplementationOnce(() => 1200);
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    it('deve ser definido', () => {
        expect(interceptor).toBeDefined();
    });
    describe('intercept', () => {
        it('deve registrar informações sobre a requisição e resposta', (done) => {
            // Mock do contexto de execução
            const mockRequest = {
                method: 'GET',
                url: '/api/cidadaos',
                ip: '127.0.0.1',
                headers: {
                    'user-agent': 'test-agent',
                },
                user: {
                    id: 'user-123',
                    email: 'usuario@teste.com',
                },
            };
            const mockResponse = {
                statusCode: 200,
            };
            const mockExecutionContext = {
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                }),
            };
            // Mock do handler de chamada
            const mockCallHandler = {
                handle: jest.fn().mockReturnValue((0, rxjs_1.of)({ data: 'test' })),
            };
            // Executar o interceptor
            interceptor.intercept(mockExecutionContext, mockCallHandler).subscribe({
                next: (data) => {
                    expect(data).toEqual({ data: 'test' });
                    // Verificar se o log de início da requisição foi registrado
                    expect(mockLoggingService.info).toHaveBeenCalledWith('Requisição iniciada: GET /api/cidadaos', 'HTTP', expect.objectContaining({
                        method: 'GET',
                        url: '/api/cidadaos',
                    }));
                    // Verificar se o log de fim da requisição foi registrado
                    expect(mockLoggingService.info).toHaveBeenCalledWith('Requisição concluída: GET /api/cidadaos - Status: 200 - Tempo: 200ms', 'HTTP', expect.objectContaining({
                        method: 'GET',
                        url: '/api/cidadaos',
                        statusCode: 200,
                    }));
                    done();
                },
                error: done,
            });
        });
        it('deve lidar com requisições sem usuário autenticado', (done) => {
            // Mock do contexto de execução sem usuário
            const mockRequest = {
                method: 'GET',
                url: '/api/public',
                ip: '127.0.0.1',
                headers: {
                    'user-agent': 'test-agent',
                },
                // Sem objeto user
            };
            const mockResponse = {
                statusCode: 200,
            };
            const mockExecutionContext = {
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                }),
            };
            // Mock do handler de chamada
            const mockCallHandler = {
                handle: jest.fn().mockReturnValue((0, rxjs_1.of)({ data: 'public' })),
            };
            // Executar o interceptor
            interceptor.intercept(mockExecutionContext, mockCallHandler).subscribe({
                next: (data) => {
                    expect(data).toEqual({ data: 'public' });
                    // Verificar se o log de início da requisição foi registrado sem userId
                    expect(mockLoggingService.info).toHaveBeenCalledWith('Requisição iniciada: GET /api/public', 'HTTP', expect.objectContaining({
                        method: 'GET',
                        url: '/api/public',
                    }));
                    // Verificar se o log de fim da requisição foi registrado sem userId
                    expect(mockLoggingService.info).toHaveBeenCalledWith('Requisição concluída: GET /api/public - Status: 200 - Tempo: 200ms', 'HTTP', expect.objectContaining({
                        method: 'GET',
                        url: '/api/public',
                        statusCode: 200,
                    }));
                    done();
                },
                error: done,
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbG9nZ2luZ1xcdGVzdHNcXGxvZ2dpbmcuaW50ZXJjZXB0b3Iuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCxnRUFBNEQ7QUFDNUQsd0RBQW9EO0FBRXBELCtCQUEwQjtBQUcxQjs7Ozs7R0FLRztBQUNILFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7SUFDbEMsSUFBSSxXQUErQixDQUFDO0lBQ3BDLElBQUksY0FBOEIsQ0FBQztJQUVuQyw2QkFBNkI7SUFDN0IsTUFBTSxrQkFBa0IsR0FBRztRQUN6QixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2hCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2pCLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1Qsd0NBQWtCO2dCQUNsQjtvQkFDRSxPQUFPLEVBQUUsZ0NBQWM7b0JBQ3ZCLFFBQVEsRUFBRSxrQkFBa0I7aUJBQzdCO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixXQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBcUIsd0NBQWtCLENBQUMsQ0FBQztRQUNqRSxjQUFjLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBaUIsZ0NBQWMsQ0FBQyxDQUFDO1FBRTVELHVCQUF1QjtRQUN2QixJQUFJO2FBQ0QsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7YUFDbEIsc0JBQXNCLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDO2FBQ2xDLHNC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RCxvRUFBb0UsRUFDcEUsTUFBTSxFQUNOLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDdEIsTUFBTSxFQUFFLEtBQUs7d0JBQ2IsR0FBRyxFQUFFLGFBQWE7d0JBQ2xCLFVBQVUsRUFBRSxHQUFHO3FCQUNoQixDQUFDLENBQ0gsQ0FBQztvQkFFRixJQUFJLEVBQUUsQ0FBQztnQkFDVCxDQUFDO2dCQUNELEtBQUssRUFBRSxJQUFJO2FBQ1osQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXGxvZ2dpbmdcXHRlc3RzXFxsb2dnaW5nLmludGVyY2VwdG9yLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBMb2dnaW5nSW50ZXJjZXB0b3IgfSBmcm9tICcuLi9sb2dnaW5nLmludGVyY2VwdG9yJztcbmltcG9ydCB7IExvZ2dpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nZ2luZy5zZXJ2aWNlJztcbmltcG9ydCB7IEV4ZWN1dGlvbkNvbnRleHQsIENhbGxIYW5kbGVyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIGludGVyY2VwdG9yIGRlIGxvZ2dpbmdcbiAqXG4gKiBWZXJpZmljYSBvIGZ1bmNpb25hbWVudG8gZG8gaW50ZXJjZXB0b3IgcXVlIHJlZ2lzdHJhXG4gKiBpbmZvcm1hw6fDtWVzIHNvYnJlIHJlcXVpc2nDp8O1ZXMgSFRUUFxuICovXG5kZXNjcmliZSgnTG9nZ2luZ0ludGVyY2VwdG9yJywgKCkgPT4ge1xuICBsZXQgaW50ZXJjZXB0b3I6IExvZ2dpbmdJbnRlcmNlcHRvcjtcbiAgbGV0IGxvZ2dpbmdTZXJ2aWNlOiBMb2dnaW5nU2VydmljZTtcblxuICAvLyBNb2NrIGRvIHNlcnZpw6dvIGRlIGxvZ2dpbmdcbiAgY29uc3QgbW9ja0xvZ2dpbmdTZXJ2aWNlID0ge1xuICAgIGluZm86IGplc3QuZm4oKSxcbiAgICBkZWJ1ZzogamVzdC5mbigpLFxuICAgIGVycm9yOiBqZXN0LmZuKCksXG4gIH07XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIExvZ2dpbmdJbnRlcmNlcHRvcixcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IExvZ2dpbmdTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrTG9nZ2luZ1NlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGludGVyY2VwdG9yID0gbW9kdWxlLmdldDxMb2dnaW5nSW50ZXJjZXB0b3I+KExvZ2dpbmdJbnRlcmNlcHRvcik7XG4gICAgbG9nZ2luZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PExvZ2dpbmdTZXJ2aWNlPihMb2dnaW5nU2VydmljZSk7XG5cbiAgICAvLyBNb2NrIHBhcmEgRGF0ZS5ub3coKVxuICAgIGplc3RcbiAgICAgIC5zcHlPbihEYXRlLCAnbm93JylcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+IDEwMDApXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoKSA9PiAxMjAwKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LnJlc3RvcmVBbGxNb2NrcygpO1xuICB9KTtcblxuICBpdCgnZGV2ZSBzZXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KGludGVyY2VwdG9yKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnaW50ZXJjZXB0JywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBpbmZvcm1hw6fDtWVzIHNvYnJlIGEgcmVxdWlzacOnw6NvIGUgcmVzcG9zdGEnLCAoZG9uZSkgPT4ge1xuICAgICAgLy8gTW9jayBkbyBjb250ZXh0byBkZSBleGVjdcOnw6NvXG4gICAgICBjb25zdCBtb2NrUmVxdWVzdCA9IHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgdXJsOiAnL2FwaS9jaWRhZGFvcycsXG4gICAgICAgIGlwOiAnMTI3LjAuMC4xJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICd1c2VyLWFnZW50JzogJ3Rlc3QtYWdlbnQnLFxuICAgICAgICB9LFxuICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgaWQ6ICd1c2VyLTEyMycsXG4gICAgICAgICAgZW1haWw6ICd1c3VhcmlvQHRlc3RlLmNvbScsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVxdWVzdDtcblxuICAgICAgY29uc3QgbW9ja1Jlc3BvbnNlID0ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVzcG9uc2U7XG5cbiAgICAgIGNvbnN0IG1vY2tFeGVjdXRpb25Db250ZXh0ID0ge1xuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja1JlcXVlc3QpLFxuICAgICAgICAgIGdldFJlc3BvbnNlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tSZXNwb25zZSksXG4gICAgICAgIH0pLFxuICAgICAgfSBhcyB1bmtub3duIGFzIEV4ZWN1dGlvbkNvbnRleHQ7XG5cbiAgICAgIC8vIE1vY2sgZG8gaGFuZGxlciBkZSBjaGFtYWRhXG4gICAgICBjb25zdCBtb2NrQ2FsbEhhbmRsZXIgPSB7XG4gICAgICAgIGhhbmRsZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShvZih7IGRhdGE6ICd0ZXN0JyB9KSksXG4gICAgICB9IGFzIHVua25vd24gYXMgQ2FsbEhhbmRsZXI7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIG8gaW50ZXJjZXB0b3JcbiAgICAgIGludGVyY2VwdG9yLmludGVyY2VwdChtb2NrRXhlY3V0aW9uQ29udGV4dCwgbW9ja0NhbGxIYW5kbGVyKS5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoZGF0YSkgPT4ge1xuICAgICAgICAgIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgZGF0YTogJ3Rlc3QnIH0pO1xuXG4gICAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gbG9nIGRlIGluw61jaW8gZGEgcmVxdWlzacOnw6NvIGZvaSByZWdpc3RyYWRvXG4gICAgICAgICAgZXhwZWN0KG1vY2tMb2dnaW5nU2VydmljZS5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICAgICdSZXF1aXNpw6fDo28gaW5pY2lhZGE6IEdFVCAvYXBpL2NpZGFkYW9zJyxcbiAgICAgICAgICAgICdIVFRQJyxcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgICAgdXJsOiAnL2FwaS9jaWRhZGFvcycsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gbG9nIGRlIGZpbSBkYSByZXF1aXNpw6fDo28gZm9pIHJlZ2lzdHJhZG9cbiAgICAgICAgICBleHBlY3QobW9ja0xvZ2dpbmdTZXJ2aWNlLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAgICAgJ1JlcXVpc2nDp8OjbyBjb25jbHXDrWRhOiBHRVQgL2FwaS9jaWRhZGFvcyAtIFN0YXR1czogMjAwIC0gVGVtcG86IDIwMG1zJyxcbiAgICAgICAgICAgICdIVFRQJyxcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgICAgdXJsOiAnL2FwaS9jaWRhZGFvcycsXG4gICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBkb25lLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBsaWRhciBjb20gcmVxdWlzacOnw7VlcyBzZW0gdXN1w6FyaW8gYXV0ZW50aWNhZG8nLCAoZG9uZSkgPT4ge1xuICAgICAgLy8gTW9jayBkbyBjb250ZXh0byBkZSBleGVjdcOnw6NvIHNlbSB1c3XDoXJpb1xuICAgICAgY29uc3QgbW9ja1JlcXVlc3QgPSB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHVybDogJy9hcGkvcHVibGljJyxcbiAgICAgICAgaXA6ICcxMjcuMC4wLjEnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ3VzZXItYWdlbnQnOiAndGVzdC1hZ2VudCcsXG4gICAgICAgIH0sXG4gICAgICAgIC8vIFNlbSBvYmpldG8gdXNlclxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlcXVlc3Q7XG5cbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlc3BvbnNlO1xuXG4gICAgICBjb25zdCBtb2NrRXhlY3V0aW9uQ29udGV4dCA9IHtcbiAgICAgICAgc3dpdGNoVG9IdHRwOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICBnZXRSZXF1ZXN0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tSZXF1ZXN0KSxcbiAgICAgICAgICBnZXRSZXNwb25zZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrUmVzcG9uc2UpLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBFeGVjdXRpb25Db250ZXh0O1xuXG4gICAgICAvLyBNb2NrIGRvIGhhbmRsZXIgZGUgY2hhbWFkYVxuICAgICAgY29uc3QgbW9ja0NhbGxIYW5kbGVyID0ge1xuICAgICAgICBoYW5kbGU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUob2YoeyBkYXRhOiAncHVibGljJyB9KSksXG4gICAgICB9IGFzIHVua25vd24gYXMgQ2FsbEhhbmRsZXI7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIG8gaW50ZXJjZXB0b3JcbiAgICAgIGludGVyY2VwdG9yLmludGVyY2VwdChtb2NrRXhlY3V0aW9uQ29udGV4dCwgbW9ja0NhbGxIYW5kbGVyKS5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoZGF0YSkgPT4ge1xuICAgICAgICAgIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgZGF0YTogJ3B1YmxpYycgfSk7XG5cbiAgICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyBsb2cgZGUgaW7DrWNpbyBkYSByZXF1aXNpw6fDo28gZm9pIHJlZ2lzdHJhZG8gc2VtIHVzZXJJZFxuICAgICAgICAgIGV4cGVjdChtb2NrTG9nZ2luZ1NlcnZpY2UuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgICAnUmVxdWlzacOnw6NvIGluaWNpYWRhOiBHRVQgL2FwaS9wdWJsaWMnLFxuICAgICAgICAgICAgJ0hUVFAnLFxuICAgICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgICAgICB1cmw6ICcvYXBpL3B1YmxpYycsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gbG9nIGRlIGZpbSBkYSByZXF1aXNpw6fDo28gZm9pIHJlZ2lzdHJhZG8gc2VtIHVzZXJJZFxuICAgICAgICAgIGV4cGVjdChtb2NrTG9nZ2luZ1NlcnZpY2UuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgICAnUmVxdWlzacOnw6NvIGNvbmNsdcOtZGE6IEdFVCAvYXBpL3B1YmxpYyAtIFN0YXR1czogMjAwIC0gVGVtcG86IDIwMG1zJyxcbiAgICAgICAgICAgICdIVFRQJyxcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgICAgdXJsOiAnL2FwaS9wdWJsaWMnLFxuICAgICAgICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogZG9uZSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9