bb5aaf6ba8eaf1c2478a6fbd71c4a698
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const comprovante_controller_1 = require("../../../controllers/comprovante.controller");
const comprovante_service_1 = require("../../../services/comprovante.service");
const pagamento_service_1 = require("../../../services/pagamento.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para ComprovanteController
 *
 * Valida o comportamento dos endpoints de comprovante de pagamento, garantindo
 * o correto funcionamento do upload, download e manipulação de comprovantes.
 *
 * @author Equipe PGBen
 */
describe('ComprovanteController', () => {
    let controller;
    let comprovanteService;
    let pagamentoService;
    // Mock de um comprovante para os testes
    const comprovanteMock = {
        id: 'comprovante-id-1',
        pagamentoId: 'pagamento-id-1',
        nomeArquivo: 'comprovante.pdf',
        tipoArquivo: 'application/pdf',
        tamanhoArquivo: 1024,
        caminhoArquivo: 'pagamentos/comprovantes/comprovante-id-1.pdf',
        adicionadoPor: 'usuario-id-1',
        dataCriacao: new Date(),
        observacoes: 'Comprovante de pagamento via PIX',
    };
    // Mock de um pagamento para os testes
    const pagamentoMock = {
        id: 'pagamento-id-1',
        solicitacaoId: 'solicitacao-id-1',
        status: 'LIBERADO',
        valor: 500,
    };
    // Lista de comprovantes para teste
    const comprovantesMock = [
        comprovanteMock,
        {
            ...comprovanteMock,
            id: 'comprovante-id-2',
            nomeArquivo: 'comprovante2.pdf',
        },
    ];
    // Mock do arquivo para teste de upload
    const fileMock = {
        originalname: 'comprovante.pdf',
        mimetype: 'application/pdf',
        size: 1024,
        buffer: Buffer.from('mock file content'),
    };
    // Mock do request com usuário autenticado
    const mockRequest = {
        user: {
            id: 'usuario-id-1',
            nome: 'Usuário Teste',
            perfil: 'operador',
        },
    };
    // Mock da resposta para download
    const mockResponse = {
        contentType: jest.fn().mockReturnThis(),
        header: jest.fn().mockReturnThis(),
        send: jest.fn().mockReturnThis(),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            controllers: [comprovante_controller_1.ComprovanteController],
            providers: [
                {
                    provide: comprovante_service_1.ComprovanteService,
                    useValue: {
                        uploadComprovante: jest.fn().mockResolvedValue(comprovanteMock),
                        getComprovante: jest.fn().mockResolvedValue(comprovanteMock),
                        getComprovanteConteudo: jest
                            .fn()
                            .mockResolvedValue(Buffer.from('mock file content')),
                        listarComprovantes: jest.fn().mockResolvedValue(comprovantesMock),
                        removerComprovante: jest.fn().mockResolvedValue(true),
                    },
                },
                {
                    provide: pagamento_service_1.PagamentoService,
                    useValue: {
                        findOne: jest.fn().mockResolvedValue(pagamentoMock),
                    },
                },
            ],
        }).compile();
        controller = module.get(comprovante_controller_1.ComprovanteController);
        comprovanteService = module.get(comprovante_service_1.ComprovanteService);
        pagamentoService = module.get(pagamento_service_1.PagamentoService);
    });
    it('deve estar definido', () => {
        expect(controller).toBeDefined();
    });
    describe('uploadComprovante', () => {
        it('deve fazer upload de comprovante com sucesso', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            // Act
            const resultado = await controller.uploadComprovante(pagamentoId, fileMock, observacoes, mockRequest);
            // Assert
            expect(resultado).toEqual(comprovanteMock);
            expect(comprovanteService.uploadComprovante).toHaveBeenCalledWith(pagamentoId, fileMock, observacoes, mockRequest.user.id);
        });
        it('deve validar se o pagamento existe antes do upload', async () => {
            // Arrange
            const pagamentoId = 'pagamento-inexistente';
            const observacoes = 'Comprovante de pagamento';
            jest.spyOn(pagamentoService, 'findOne').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, fileMock, observacoes, mockRequest)).rejects.toThrow(common_1.NotFoundException);
            expect(pagamentoService.findOne).toHaveBeenCalledWith(pagamentoId);
        });
        it('deve rejeitar upload de arquivo não permitido', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            const arquivoInvalido = {
                ...fileMock,
                mimetype: 'application/exe',
            };
            jest
                .spyOn(comprovanteService, 'uploadComprovante')
                .mockRejectedValue(new common_1.BadRequestException('Tipo de arquivo não permitido'));
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, arquivoInvalido, observacoes, mockRequest)).rejects.toThrow(common_1.BadRequestException);
        });
        it('deve rejeitar upload de arquivo muito grande', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            const arquivoGrande = {
                ...fileMock,
                size: 10 * 1024 * 1024, // 10MB
            };
            jest
                .spyOn(comprovanteService, 'uploadComprovante')
                .mockRejectedValue(new common_1.BadRequestException('Arquivo excede o tamanho máximo permitido'));
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, arquivoGrande, observacoes, mockRequest)).rejects.toThrow(common_1.BadRequestException);
        });
    });
    describe('getComprovante', () => {
        it('deve retornar os metadados do comprovante', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            // Act
            const resultado = await controller.getComprovante(comprovanteId);
            // Assert
            expect(resultado).toEqual(comprovanteMock);
            expect(comprovanteService.getComprovante).toHaveBeenCalledWith(comprovanteId);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest.spyOn(comprovanteService, 'getComprovante').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.getComprovante(comprovanteId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('downloadComprovante', () => {
        it('deve retornar o conteúdo do comprovante', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            const arquivoConteudo = Buffer.from('mock file content');
            // Act
            await controller.downloadComprovante(comprovanteId, mockResponse);
            // Assert
            expect(comprovanteService.getComprovante).toHaveBeenCalledWith(comprovanteId);
            expect(comprovanteService.getComprovanteConteudo).toHaveBeenCalledWith(comprovanteId);
            expect(mockResponse.contentType).toHaveBeenCalledWith(comprovanteMock.tipoArquivo);
            expect(mockResponse.header).toHaveBeenCalledWith('Content-Disposition', `attachment; filename="${comprovanteMock.nomeArquivo}"`);
            expect(mockResponse.send).toHaveBeenCalledWith(arquivoConteudo);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest.spyOn(comprovanteService, 'getComprovante').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.downloadComprovante(comprovanteId, mockResponse)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('listarComprovantes', () => {
        it('deve listar comprovantes de um pagamento', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            // Act
            const resultado = await controller.listarComprovantes(pagamentoId);
            // Assert
            expect(resultado).toEqual(comprovantesMock);
            expect(comprovanteService.listarComprovantes).toHaveBeenCalledWith(pagamentoId);
        });
        it('deve retornar lista vazia quando não há comprovantes', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            jest
                .spyOn(comprovanteService, 'listarComprovantes')
                .mockResolvedValue([]);
            // Act
            const resultado = await controller.listarComprovantes(pagamentoId);
            // Assert
            expect(resultado).toEqual([]);
        });
    });
    describe('removerComprovante', () => {
        it('deve remover um comprovante com sucesso', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            // Act
            const resultado = await controller.removerComprovante(comprovanteId, mockRequest);
            // Assert
            expect(resultado).toEqual({
                success: true,
                message: 'Comprovante removido com sucesso',
            });
            expect(comprovanteService.removerComprovante).toHaveBeenCalledWith(comprovanteId, mockRequest.user.id);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest
                .spyOn(comprovanteService, 'removerComprovante')
                .mockRejectedValue(new common_1.NotFoundException('Comprovante não encontrado'));
            // Act & Assert
            await expect(controller.removerComprovante(comprovanteId, mockRequest)).rejects.toThrow(common_1.NotFoundException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHVuaXRcXGNvbnRyb2xsZXJzXFxjb21wcm92YW50ZS5jb250cm9sbGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsd0ZBQW9GO0FBQ3BGLCtFQUEyRTtBQUMzRSwyRUFBdUU7QUFDdkUsMkNBQXdFO0FBR3hFOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLElBQUksVUFBaUMsQ0FBQztJQUN0QyxJQUFJLGtCQUFzQyxDQUFDO0lBQzNDLElBQUksZ0JBQWtDLENBQUM7SUFFdkMsd0NBQXdDO0lBQ3hDLE1BQU0sZUFBZSxHQUFHO1FBQ3RCLEVBQUUsRUFBRSxrQkFBa0I7UUFDdEIsV0FBVyxFQUFFLGdCQUFnQjtRQUM3QixXQUFXLEVBQUUsaUJBQWlCO1FBQzlCLFdBQVcsRUFBRSxpQkFBaUI7UUFDOUIsY0FBYyxFQUFFLElBQUk7UUFDcEIsY0FBYyxFQUFFLDhDQUE4QztRQUM5RCxhQUFhLEVBQUUsY0FBYztRQUM3QixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDdkIsV0FBVyxFQUFFLGtDQUFrQztLQUNoRCxDQUFDO0lBRUYsc0NBQXNDO0lBQ3RDLE1BQU0sYUFBYSxHQUFHO1FBQ3BCLEVBQUUsRUFBRSxnQkFBZ0I7UUFDcEIsYUFBYSxFQUFFLGtCQUFrQjtRQUNqQyxNQUFNLEVBQUUsVUFBVTtRQUNsQixLQUFLLEVBQUUsR0FBRztLQUNYLENBQUM7SUFFRixtQ0FBbUM7SUFDbkMsTUFBTSxnQkFBZ0IsR0FBRztRQUN2QixlQUFlO1FBQ2Y7WUFDRSxHQUFHLGVBQWU7WUFDbEIsRUFBRSxFQUFFLGtCQUFrQjtZQUN0QixXQUFXLEVBQUUsa0JBQWtCO1NBQ2hDO0tBQ0YsQ0FBQztJQUVGLHVDQUF1QztJQUN2QyxNQUFNLFFB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QWlCLENBQUMsSUFBSSwwQkFBaUIsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDLENBQUM7WUFFMUUsZUFBZTtZQUNmLE1BQU0sTUFBTSxDQUNWLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsV0FBa0IsQ0FBQyxDQUNqRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsMEJBQWlCLENBQUMsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHVuaXRcXGNvbnRyb2xsZXJzXFxjb21wcm92YW50ZS5jb250cm9sbGVyLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBDb21wcm92YW50ZUNvbnRyb2xsZXIgfSBmcm9tICcuLi8uLi8uLi9jb250cm9sbGVycy9jb21wcm92YW50ZS5jb250cm9sbGVyJztcbmltcG9ydCB7IENvbXByb3ZhbnRlU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2NvbXByb3ZhbnRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGFnYW1lbnRvU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3BhZ2FtZW50by5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdEZvdW5kRXhjZXB0aW9uLCBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcblxuLyoqXG4gKiBUZXN0ZXMgdW5pdMOhcmlvcyBwYXJhIENvbXByb3ZhbnRlQ29udHJvbGxlclxuICpcbiAqIFZhbGlkYSBvIGNvbXBvcnRhbWVudG8gZG9zIGVuZHBvaW50cyBkZSBjb21wcm92YW50ZSBkZSBwYWdhbWVudG8sIGdhcmFudGluZG9cbiAqIG8gY29ycmV0byBmdW5jaW9uYW1lbnRvIGRvIHVwbG9hZCwgZG93bmxvYWQgZSBtYW5pcHVsYcOnw6NvIGRlIGNvbXByb3ZhbnRlcy5cbiAqXG4gKiBAYXV0aG9yIEVxdWlwZSBQR0JlblxuICovXG5kZXNjcmliZSgnQ29tcHJvdmFudGVDb250cm9sbGVyJywgKCkgPT4ge1xuICBsZXQgY29udHJvbGxlcjogQ29tcHJvdmFudGVDb250cm9sbGVyO1xuICBsZXQgY29tcHJvdmFudGVTZXJ2aWNlOiBDb21wcm92YW50ZVNlcnZpY2U7XG4gIGxldCBwYWdhbWVudG9TZXJ2aWNlOiBQYWdhbWVudG9TZXJ2aWNlO1xuXG4gIC8vIE1vY2sgZGUgdW0gY29tcHJvdmFudGUgcGFyYSBvcyB0ZXN0ZXNcbiAgY29uc3QgY29tcHJvdmFudGVNb2NrID0ge1xuICAgIGlkOiAnY29tcHJvdmFudGUtaWQtMScsXG4gICAgcGFnYW1lbnRvSWQ6ICdwYWdhbWVudG8taWQtMScsXG4gICAgbm9tZUFycXVpdm86ICdjb21wcm92YW50ZS5wZGYnLFxuICAgIHRpcG9BcnF1aXZvOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICB0YW1hbmhvQXJxdWl2bzogMTAyNCxcbiAgICBjYW1pbmhvQXJxdWl2bzogJ3BhZ2FtZW50b3MvY29tcHJvdmFudGVzL2NvbXByb3ZhbnRlLWlkLTEucGRmJyxcbiAgICBhZGljaW9uYWRvUG9yOiAndXN1YXJpby1pZC0xJyxcbiAgICBkYXRhQ3JpYWNhbzogbmV3IERhdGUoKSxcbiAgICBvYnNlcnZhY29lczogJ0NvbXByb3ZhbnRlIGRlIHBhZ2FtZW50byB2aWEgUElYJyxcbiAgfTtcblxuICAvLyBNb2NrIGRlIHVtIHBhZ2FtZW50byBwYXJhIG9zIHRlc3Rlc1xuICBjb25zdCBwYWdhbWVudG9Nb2NrID0ge1xuICAgIGlkOiAncGFnYW1lbnRvLWlkLTEnLFxuICAgIHNvbGljaXRhY2FvSWQ6ICdzb2xpY2l0YWNhby1pZC0xJyxcbiAgICBzdGF0dXM6ICdMSUJFUkFETycsXG4gICAgdmFsb3I6IDUwMCxcbiAgfTtcblxuICAvLyBMaXN0YSBkZSBjb21wcm92YW50ZXMgcGFyYSB0ZXN0ZVxuICBjb25zdCBjb21wcm92YW50ZXNNb2NrID0gW1xuICAgIGNvbXByb3ZhbnRlTW9jayxcbiAgICB7XG4gICAgICAuLi5jb21wcm92YW50ZU1vY2ssXG4gICAgICBpZDogJ2NvbXByb3ZhbnRlLWlkLTInLFxuICAgICAgbm9tZUFycXVpdm86ICdjb21wcm92YW50ZTIucGRmJyxcbiAgICB9LFxuICBdO1xuXG4gIC8vIE1vY2sgZG8gYXJxdWl2byBwYXJhIHRlc3RlIGRlIHVwbG9hZFxuICBjb25zdCBmaWxlTW9jayA9IHtcbiAgICBvcmlnaW5hbG5hbWU6ICdjb21wcm92YW50ZS5wZGYnLFxuICAgIG1pbWV0eXBlOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICBzaXplOiAxMDI0LFxuICAgIGJ1ZmZlcjogQnVmZmVyLmZyb20oJ21vY2sgZmlsZSBjb250ZW50JyksXG4gIH07XG5cbiAgLy8gTW9jayBkbyByZXF1ZXN0IGNvbSB1c3XDoXJpbyBhdXRlbnRpY2Fkb1xuICBjb25zdCBtb2NrUmVxdWVzdCA9IHtcbiAgICB1c2VyOiB7XG4gICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICBub21lOiAnVXN1w6FyaW8gVGVzdGUnLFxuICAgICAgcGVyZmlsOiAnb3BlcmFkb3InLFxuICAgIH0sXG4gIH07XG5cbiAgLy8gTW9jayBkYSByZXNwb3N0YSBwYXJhIGRvd25sb2FkXG4gIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICBjb250ZW50VHlwZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgaGVhZGVyOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICBzZW5kOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgY29udHJvbGxlcnM6IFtDb21wcm92YW50ZUNvbnRyb2xsZXJdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb21wcm92YW50ZVNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIHVwbG9hZENvbXByb3ZhbnRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29tcHJvdmFudGVNb2NrKSxcbiAgICAgICAgICAgIGdldENvbXByb3ZhbnRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29tcHJvdmFudGVNb2NrKSxcbiAgICAgICAgICAgIGdldENvbXByb3ZhbnRlQ29udGV1ZG86IGplc3RcbiAgICAgICAgICAgICAgLmZuKClcbiAgICAgICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKEJ1ZmZlci5mcm9tKCdtb2NrIGZpbGUgY29udGVudCcpKSxcbiAgICAgICAgICAgIGxpc3RhckNvbXByb3ZhbnRlczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKGNvbXByb3ZhbnRlc01vY2spLFxuICAgICAgICAgICAgcmVtb3ZlckNvbXByb3ZhbnRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFBhZ2FtZW50b1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShwYWdhbWVudG9Nb2NrKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBjb250cm9sbGVyID0gbW9kdWxlLmdldDxDb21wcm92YW50ZUNvbnRyb2xsZXI+KENvbXByb3ZhbnRlQ29udHJvbGxlcik7XG4gICAgY29tcHJvdmFudGVTZXJ2aWNlID0gbW9kdWxlLmdldDxDb21wcm92YW50ZVNlcnZpY2U+KENvbXByb3ZhbnRlU2VydmljZSk7XG4gICAgcGFnYW1lbnRvU2VydmljZSA9IG1vZHVsZS5nZXQ8UGFnYW1lbnRvU2VydmljZT4oUGFnYW1lbnRvU2VydmljZSk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIGVzdGFyIGRlZmluaWRvJywgKCkgPT4ge1xuICAgIGV4cGVjdChjb250cm9sbGVyKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgndXBsb2FkQ29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgZmF6ZXIgdXBsb2FkIGRlIGNvbXByb3ZhbnRlIGNvbSBzdWNlc3NvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkLTEnO1xuICAgICAgY29uc3Qgb2JzZXJ2YWNvZXMgPSAnQ29tcHJvdmFudGUgZGUgcGFnYW1lbnRvJztcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBjb250cm9sbGVyLnVwbG9hZENvbXByb3ZhbnRlKFxuICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgZmlsZU1vY2sgYXMgYW55LFxuICAgICAgICBvYnNlcnZhY29lcyxcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgYW55LFxuICAgICAgKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0YWRvKS50b0VxdWFsKGNvbXByb3ZhbnRlTW9jayk7XG4gICAgICBleHBlY3QoY29tcHJvdmFudGVTZXJ2aWNlLnVwbG9hZENvbXByb3ZhbnRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICAgIGZpbGVNb2NrLFxuICAgICAgICBvYnNlcnZhY29lcyxcbiAgICAgICAgbW9ja1JlcXVlc3QudXNlci5pZCxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2YWxpZGFyIHNlIG8gcGFnYW1lbnRvIGV4aXN0ZSBhbnRlcyBkbyB1cGxvYWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taW5leGlzdGVudGUnO1xuICAgICAgY29uc3Qgb2JzZXJ2YWNvZXMgPSAnQ29tcHJvdmFudGUgZGUgcGFnYW1lbnRvJztcblxuICAgICAgamVzdC5zcHlPbihwYWdhbWVudG9TZXJ2aWNlLCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci51cGxvYWRDb21wcm92YW50ZShcbiAgICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgICBmaWxlTW9jayBhcyBhbnksXG4gICAgICAgICAgb2JzZXJ2YWNvZXMsXG4gICAgICAgICAgbW9ja1JlcXVlc3QgYXMgYW55LFxuICAgICAgICApLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgICAgZXhwZWN0KHBhZ2FtZW50b1NlcnZpY2UuZmluZE9uZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgocGFnYW1lbnRvSWQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVqZWl0YXIgdXBsb2FkIGRlIGFycXVpdm8gbsOjbyBwZXJtaXRpZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG4gICAgICBjb25zdCBvYnNlcnZhY29lcyA9ICdDb21wcm92YW50ZSBkZSBwYWdhbWVudG8nO1xuICAgICAgY29uc3QgYXJxdWl2b0ludmFsaWRvID0ge1xuICAgICAgICAuLi5maWxlTW9jayxcbiAgICAgICAgbWltZXR5cGU6ICdhcHBsaWNhdGlvbi9leGUnLFxuICAgICAgfTtcblxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oY29tcHJvdmFudGVTZXJ2aWNlLCAndXBsb2FkQ29tcHJvdmFudGUnKVxuICAgICAgICAubW9ja1JlamVjdGVkVmFsdWUoXG4gICAgICAgICAgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1RpcG8gZGUgYXJxdWl2byBuw6NvIHBlcm1pdGlkbycpLFxuICAgICAgICApO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci51cGxvYWRDb21wcm92YW50ZShcbiAgICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgICBhcnF1aXZvSW52YWxpZG8gYXMgYW55LFxuICAgICAgICAgIG9ic2VydmFjb2VzLFxuICAgICAgICAgIG1vY2tSZXF1ZXN0IGFzIGFueSxcbiAgICAgICAgKSxcbiAgICAgICkucmVqZWN0cy50b1Rocm93KEJhZFJlcXVlc3RFeGNlcHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVqZWl0YXIgdXBsb2FkIGRlIGFycXVpdm8gbXVpdG8gZ3JhbmRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkLTEnO1xuICAgICAgY29uc3Qgb2JzZXJ2YWNvZXMgPSAnQ29tcHJvdmFudGUgZGUgcGFnYW1lbnRvJztcbiAgICAgIGNvbnN0IGFycXVpdm9HcmFuZGUgPSB7XG4gICAgICAgIC4uLmZpbGVNb2NrLFxuICAgICAgICBzaXplOiAxMCAqIDEwMjQgKiAxMDI0LCAvLyAxME1CXG4gICAgICB9O1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihjb21wcm92YW50ZVNlcnZpY2UsICd1cGxvYWRDb21wcm92YW50ZScpXG4gICAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZShcbiAgICAgICAgICBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQXJxdWl2byBleGNlZGUgbyB0YW1hbmhvIG3DoXhpbW8gcGVybWl0aWRvJyksXG4gICAgICAgICk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBjb250cm9sbGVyLnVwbG9hZENvbXByb3ZhbnRlKFxuICAgICAgICAgIHBhZ2FtZW50b0lkLFxuICAgICAgICAgIGFycXVpdm9HcmFuZGUgYXMgYW55LFxuICAgICAgICAgIG9ic2VydmFjb2VzLFxuICAgICAgICAgIG1vY2tSZXF1ZXN0IGFzIGFueSxcbiAgICAgICAgKSxcbiAgICAgICkucmVqZWN0cy50b1Rocm93KEJhZFJlcXVlc3RFeGNlcHRpb24pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0Q29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgb3MgbWV0YWRhZG9zIGRvIGNvbXByb3ZhbnRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgY29tcHJvdmFudGVJZCA9ICdjb21wcm92YW50ZS1pZC0xJztcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBjb250cm9sbGVyLmdldENvbXByb3ZhbnRlKGNvbXByb3ZhbnRlSWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoY29tcHJvdmFudGVNb2NrKTtcbiAgICAgIGV4cGVjdChjb21wcm92YW50ZVNlcnZpY2UuZ2V0Q29tcHJvdmFudGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBjb21wcm92YW50ZUlkLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgZXJybyBxdWFuZG8gbyBjb21wcm92YW50ZSBuw6NvIGV4aXN0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaW5leGlzdGVudGUnO1xuXG4gICAgICBqZXN0LnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ2dldENvbXByb3ZhbnRlJykubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGNvbnRyb2xsZXIuZ2V0Q29tcHJvdmFudGUoY29tcHJvdmFudGVJZCkpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgTm90Rm91bmRFeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZG93bmxvYWRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZXRvcm5hciBvIGNvbnRlw7pkbyBkbyBjb21wcm92YW50ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQtMSc7XG4gICAgICBjb25zdCBhcnF1aXZvQ29udGV1ZG8gPSBCdWZmZXIuZnJvbSgnbW9jayBmaWxlIGNvbnRlbnQnKTtcblxuICAgICAgLy8gQWN0XG4gICAgICBhd2FpdCBjb250cm9sbGVyLmRvd25sb2FkQ29tcHJvdmFudGUoXG4gICAgICAgIGNvbXByb3ZhbnRlSWQsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyB1bmtub3duIGFzIFJlc3BvbnNlLFxuICAgICAgKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QoY29tcHJvdmFudGVTZXJ2aWNlLmdldENvbXByb3ZhbnRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgY29tcHJvdmFudGVJZCxcbiAgICAgICk7XG4gICAgICBleHBlY3QoY29tcHJvdmFudGVTZXJ2aWNlLmdldENvbXByb3ZhbnRlQ29udGV1ZG8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBjb21wcm92YW50ZUlkLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuY29udGVudFR5cGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBjb21wcm92YW50ZU1vY2sudGlwb0FycXVpdm8sXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5oZWFkZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbicsXG4gICAgICAgIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cIiR7Y29tcHJvdmFudGVNb2NrLm5vbWVBcnF1aXZvfVwiYCxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGFycXVpdm9Db250ZXVkbyk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBsYW7Dp2FyIGVycm8gcXVhbmRvIG8gY29tcHJvdmFudGUgbsOjbyBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBjb21wcm92YW50ZUlkID0gJ2NvbXByb3ZhbnRlLWluZXhpc3RlbnRlJztcblxuICAgICAgamVzdC5zcHlPbihjb21wcm92YW50ZVNlcnZpY2UsICdnZXRDb21wcm92YW50ZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci5kb3dubG9hZENvbXByb3ZhbnRlKFxuICAgICAgICAgIGNvbXByb3ZhbnRlSWQsXG4gICAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIHVua25vd24gYXMgUmVzcG9uc2UsXG4gICAgICAgICksXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsaXN0YXJDb21wcm92YW50ZXMnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgbGlzdGFyIGNvbXByb3ZhbnRlcyBkZSB1bSBwYWdhbWVudG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0YWRvID0gYXdhaXQgY29udHJvbGxlci5saXN0YXJDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoY29tcHJvdmFudGVzTW9jayk7XG4gICAgICBleHBlY3QoY29tcHJvdmFudGVTZXJ2aWNlLmxpc3RhckNvbXByb3ZhbnRlcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIHBhZ2FtZW50b0lkLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJldG9ybmFyIGxpc3RhIHZhemlhIHF1YW5kbyBuw6NvIGjDoSBjb21wcm92YW50ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ2xpc3RhckNvbXByb3ZhbnRlcycpXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShbXSk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0YWRvID0gYXdhaXQgY29udHJvbGxlci5saXN0YXJDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoW10pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVtb3ZlckNvbXByb3ZhbnRlJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJlbW92ZXIgdW0gY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBjb21wcm92YW50ZUlkID0gJ2NvbXByb3ZhbnRlLWlkLTEnO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGNvbnRyb2xsZXIucmVtb3ZlckNvbXByb3ZhbnRlKFxuICAgICAgICBjb21wcm92YW50ZUlkLFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBhbnksXG4gICAgICApO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnQ29tcHJvdmFudGUgcmVtb3ZpZG8gY29tIHN1Y2Vzc28nLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoY29tcHJvdmFudGVTZXJ2aWNlLnJlbW92ZXJDb21wcm92YW50ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGNvbXByb3ZhbnRlSWQsXG4gICAgICAgIG1vY2tSZXF1ZXN0LnVzZXIuaWQsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBvIGNvbXByb3ZhbnRlIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgY29tcHJvdmFudGVJZCA9ICdjb21wcm92YW50ZS1pbmV4aXN0ZW50ZSc7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ3JlbW92ZXJDb21wcm92YW50ZScpXG4gICAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NvbXByb3ZhbnRlIG7Do28gZW5jb250cmFkbycpKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIucmVtb3ZlckNvbXByb3ZhbnRlKGNvbXByb3ZhbnRlSWQsIG1vY2tSZXF1ZXN0IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=