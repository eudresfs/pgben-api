ebf97ca5d6af51f312360390939bddac
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const permission_guard_1 = require("./permission.guard");
const permission_service_1 = require("../services/permission.service");
const user_permission_entity_1 = require("../entities/user-permission.entity");
const requires_permission_decorator_1 = require("../decorators/requires-permission.decorator");
const ts_jest_1 = require("@golevelup/ts-jest");
const common_2 = require("@nestjs/common");
// Mock para o serviço de permissões
const mockPermissionService = {
    hasPermission: jest.fn(),
};
describe('PermissionGuard', () => {
    let guard;
    let reflector;
    beforeEach(async () => {
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            providers: [
                permission_guard_1.PermissionGuard,
                {
                    provide: permission_service_1.PermissionService,
                    useValue: mockPermissionService,
                },
                {
                    provide: core_1.Reflector,
                    useValue: {
                        get: jest.fn(),
                        getAllAndOverride: jest.fn(),
                    },
                },
                {
                    provide: common_2.Logger,
                    useValue: {
                        log: jest.fn(),
                        error: jest.fn(),
                        warn: jest.fn(),
                        debug: jest.fn(),
                    },
                },
            ],
        }).compile();
        guard = module.get(permission_guard_1.PermissionGuard);
        reflector = module.get(core_1.Reflector);
    });
    it('should be defined', () => {
        expect(guard).toBeDefined();
    });
    describe('canActivate', () => {
        it('should allow access when no permission is required', async () => {
            // Arrange
            const context = (0, ts_jest_1.createMock)();
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(undefined);
            // Act
            const result = await guard.canActivate(context);
            // Assert
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(result).toBe(true);
        });
        it('should allow access when user has required permission', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.GLOBAL,
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: { id: 'user-123' },
                        params: {},
                        query: {},
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            mockPermissionService.hasPermission.mockResolvedValue(true);
            // Act
            const result = await guard.canActivate(context);
            // Assert
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).toHaveBeenCalledWith({
                userId: 'user-123',
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.GLOBAL,
                scopeId: undefined,
            });
            expect(result).toBe(true);
        });
        it('should deny access when user does not have required permission', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.GLOBAL,
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: { id: 'user-123' },
                        params: {},
                        query: {},
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            mockPermissionService.hasPermission.mockResolvedValue(false);
            // Act & Assert
            await expect(guard.canActivate(context)).rejects.toThrow(common_1.UnauthorizedException);
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).toHaveBeenCalledWith({
                userId: 'user-123',
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.GLOBAL,
                scopeId: undefined,
            });
        });
        it('should extract scopeId from request params when scopeType is UNIT', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeIdParam: 'userId',
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: { id: 'user-123' },
                        params: { userId: 'target-user-456' },
                        query: {},
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            mockPermissionService.hasPermission.mockResolvedValue(true);
            // Act
            const result = await guard.canActivate(context);
            // Assert
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).toHaveBeenCalledWith({
                userId: 'user-123',
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeId: 'target-user-456',
            });
            expect(result).toBe(true);
        });
        it('should extract scopeId from request query when scopeType is UNIT and param not found', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeIdParam: 'userId',
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: { id: 'user-123' },
                        params: {},
                        query: { userId: 'target-user-456' },
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            mockPermissionService.hasPermission.mockResolvedValue(true);
            // Act
            const result = await guard.canActivate(context);
            // Assert
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).toHaveBeenCalledWith({
                userId: 'user-123',
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeId: 'target-user-456',
            });
            expect(result).toBe(true);
        });
        it('should throw UnauthorizedException when user is not authenticated', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.GLOBAL,
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: undefined,
                        params: {},
                        query: {},
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            // Act & Assert
            await expect(guard.canActivate(context)).rejects.toThrow(common_1.UnauthorizedException);
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).not.toHaveBeenCalled();
        });
        it('should throw UnauthorizedException when scopeId is required but not found', async () => {
            // Arrange
            const permissionOptions = {
                permissionName: 'usuario.visualizar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeIdParam: 'userId',
            };
            const context = (0, ts_jest_1.createMock)({
                switchToHttp: () => ({
                    getRequest: () => ({
                        user: { id: 'user-123' },
                        params: {},
                        query: {},
                    }),
                }),
            });
            jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(permissionOptions);
            // Act & Assert
            await expect(guard.canActivate(context)).rejects.toThrow(common_1.UnauthorizedException);
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(requires_permission_decorator_1.PERMISSION_REQUIREMENTS_KEY, [
                context.getHandler(),
                context.getClass(),
            ]);
            expect(mockPermissionService.hasPermission).not.toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXGd1YXJkc1xccGVybWlzc2lvbi5ndWFyZC5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELDJDQUF5RTtBQUN6RSx1Q0FBeUM7QUFDekMseURBQXFEO0FBQ3JELHVFQUFtRTtBQUNuRSwrRUFBK0Q7QUFDL0QsK0ZBQTBGO0FBQzFGLGdEQUFnRDtBQUNoRCwyQ0FBd0M7QUFFeEMsb0NBQW9DO0FBQ3BDLE1BQU0scUJBQXFCLEdBQUc7SUFDNUIsYUFBYSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDekIsQ0FBQztBQUVGLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxLQUFzQixDQUFDO0lBQzNCLElBQUksU0FBb0IsQ0FBQztJQUV6QixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1Qsa0NBQWU7Z0JBQ2Y7b0JBQ0UsT0FBTyxFQUFFLHNDQUFpQjtvQkFDMUIsUUFBUSxFQUFFLHFCQUFxQjtpQkFDaEM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLGdCQUFTO29CQUNsQixRQUFRLEVBQUU7d0JBQ1IsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ2QsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDN0I7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLGVBQU07b0JBQ2YsUUFBUSxFQUFFO3dCQUNSLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNkLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTt3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QWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcYXV0aFxcZ3VhcmRzXFxwZXJtaXNzaW9uLmd1YXJkLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBFeGVjdXRpb25Db250ZXh0LCBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZWZsZWN0b3IgfSBmcm9tICdAbmVzdGpzL2NvcmUnO1xuaW1wb3J0IHsgUGVybWlzc2lvbkd1YXJkIH0gZnJvbSAnLi9wZXJtaXNzaW9uLmd1YXJkJztcbmltcG9ydCB7IFBlcm1pc3Npb25TZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcGVybWlzc2lvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFNjb3BlVHlwZSB9IGZyb20gJy4uL2VudGl0aWVzL3VzZXItcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgUEVSTUlTU0lPTl9SRVFVSVJFTUVOVFNfS0VZIH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9yZXF1aXJlcy1wZXJtaXNzaW9uLmRlY29yYXRvcic7XG5pbXBvcnQgeyBjcmVhdGVNb2NrIH0gZnJvbSAnQGdvbGV2ZWx1cC90cy1qZXN0JztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcblxuLy8gTW9jayBwYXJhIG8gc2VydmnDp28gZGUgcGVybWlzc8O1ZXNcbmNvbnN0IG1vY2tQZXJtaXNzaW9uU2VydmljZSA9IHtcbiAgaGFzUGVybWlzc2lvbjogamVzdC5mbigpLFxufTtcblxuZGVzY3JpYmUoJ1Blcm1pc3Npb25HdWFyZCcsICgpID0+IHtcbiAgbGV0IGd1YXJkOiBQZXJtaXNzaW9uR3VhcmQ7XG4gIGxldCByZWZsZWN0b3I6IFJlZmxlY3RvcjtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgUGVybWlzc2lvbkd1YXJkLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGVybWlzc2lvblNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tQZXJtaXNzaW9uU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFJlZmxlY3RvcixcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgICAgICAgICBnZXRBbGxBbmRPdmVycmlkZTogamVzdC5mbigpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBMb2dnZXIsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIGxvZzogamVzdC5mbigpLFxuICAgICAgICAgICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICAgICAgICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICAgICAgICAgIGRlYnVnOiBqZXN0LmZuKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgZ3VhcmQgPSBtb2R1bGUuZ2V0PFBlcm1pc3Npb25HdWFyZD4oUGVybWlzc2lvbkd1YXJkKTtcbiAgICByZWZsZWN0b3IgPSBtb2R1bGUuZ2V0PFJlZmxlY3Rvcj4oUmVmbGVjdG9yKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChndWFyZCkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NhbkFjdGl2YXRlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYWxsb3cgYWNjZXNzIHdoZW4gbm8gcGVybWlzc2lvbiBpcyByZXF1aXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbnRleHQgPSBjcmVhdGVNb2NrPEV4ZWN1dGlvbkNvbnRleHQ+KCk7XG4gICAgICBqZXN0LnNweU9uKHJlZmxlY3RvciwgJ2dldEFsbEFuZE92ZXJyaWRlJykubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3VhcmQuY2FuQWN0aXZhdGUoY29udGV4dCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoUEVSTUlTU0lPTl9SRVFVSVJFTUVOVFNfS0VZLCBbXG4gICAgICAgIGNvbnRleHQuZ2V0SGFuZGxlcigpLFxuICAgICAgICBjb250ZXh0LmdldENsYXNzKCksXG4gICAgICBdKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFsbG93IGFjY2VzcyB3aGVuIHVzZXIgaGFzIHJlcXVpcmVkIHBlcm1pc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwZXJtaXNzaW9uT3B0aW9ucyA9IHtcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICd1c3VhcmlvLnZpc3VhbGl6YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5HTE9CQUwsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlTW9jazxFeGVjdXRpb25Db250ZXh0Pih7XG4gICAgICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcbiAgICAgICAgICBnZXRSZXF1ZXN0OiAoKSA9PiAoe1xuICAgICAgICAgICAgdXNlcjogeyBpZDogJ3VzZXItMTIzJyB9LFxuICAgICAgICAgICAgcGFyYW1zOiB7fSxcbiAgICAgICAgICAgIHF1ZXJ5OiB7fSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgamVzdC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpLm1vY2tSZXR1cm5WYWx1ZShwZXJtaXNzaW9uT3B0aW9ucyk7XG4gICAgICBtb2NrUGVybWlzc2lvblNlcnZpY2UuaGFzUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKTtcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBndWFyZC5jYW5BY3RpdmF0ZShjb250ZXh0KTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVmbGVjdG9yLmdldEFsbEFuZE92ZXJyaWRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChQRVJNSVNTSU9OX1JFUVVJUkVNRU5UU19LRVksIFtcbiAgICAgICAgY29udGV4dC5nZXRIYW5kbGVyKCksXG4gICAgICAgIGNvbnRleHQuZ2V0Q2xhc3MoKSxcbiAgICAgIF0pO1xuICAgICAgZXhwZWN0KG1vY2tQZXJtaXNzaW9uU2VydmljZS5oYXNQZXJtaXNzaW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICd1c3VhcmlvLnZpc3VhbGl6YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5HTE9CQUwsXG4gICAgICAgIHNjb3BlSWQ6IHVuZGVmaW5lZCxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGVueSBhY2Nlc3Mgd2hlbiB1c2VyIGRvZXMgbm90IGhhdmUgcmVxdWlyZWQgcGVybWlzc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBlcm1pc3Npb25PcHRpb25zID0ge1xuICAgICAgICBwZXJtaXNzaW9uTmFtZTogJ3VzdWFyaW8udmlzdWFsaXphcicsXG4gICAgICAgIHNjb3BlVHlwZTogU2NvcGVUeXBlLkdMT0JBTCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGNvbnRleHQgPSBjcmVhdGVNb2NrPEV4ZWN1dGlvbkNvbnRleHQ+KHtcbiAgICAgICAgc3dpdGNoVG9IdHRwOiAoKSA9PiAoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6ICgpID0+ICh7XG4gICAgICAgICAgICB1c2VyOiB7IGlkOiAndXNlci0xMjMnIH0sXG4gICAgICAgICAgICBwYXJhbXM6IHt9LFxuICAgICAgICAgICAgcXVlcnk6IHt9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBqZXN0LnNweU9uKHJlZmxlY3RvciwgJ2dldEFsbEFuZE92ZXJyaWRlJykubW9ja1JldHVyblZhbHVlKHBlcm1pc3Npb25PcHRpb25zKTtcbiAgICAgIG1vY2tQZXJtaXNzaW9uU2VydmljZS5oYXNQZXJtaXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlKGZhbHNlKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoZ3VhcmQuY2FuQWN0aXZhdGUoY29udGV4dCkpLnJlamVjdHMudG9UaHJvdyhVbmF1dGhvcml6ZWRFeGNlcHRpb24pO1xuICAgICAgZXhwZWN0KHJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoUEVSTUlTU0lPTl9SRVFVSVJFTUVOVFNfS0VZLCBbXG4gICAgICAgIGNvbnRleHQuZ2V0SGFuZGxlcigpLFxuICAgICAgICBjb250ZXh0LmdldENsYXNzKCksXG4gICAgICBdKTtcbiAgICAgIGV4cGVjdChtb2NrUGVybWlzc2lvblNlcnZpY2UuaGFzUGVybWlzc2lvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB1c2VySWQ6ICd1c2VyLTEyMycsXG4gICAgICAgIHBlcm1pc3Npb25OYW1lOiAndXN1YXJpby52aXN1YWxpemFyJyxcbiAgICAgICAgc2NvcGVUeXBlOiBTY29wZVR5cGUuR0xPQkFMLFxuICAgICAgICBzY29wZUlkOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBzY29wZUlkIGZyb20gcmVxdWVzdCBwYXJhbXMgd2hlbiBzY29wZVR5cGUgaXMgVU5JVCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBlcm1pc3Npb25PcHRpb25zID0ge1xuICAgICAgICBwZXJtaXNzaW9uTmFtZTogJ3VzdWFyaW8udmlzdWFsaXphcicsXG4gICAgICAgIHNjb3BlVHlwZTogU2NvcGVUeXBlLlVOSVQsXG4gICAgICAgIHNjb3BlSWRQYXJhbTogJ3VzZXJJZCcsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlTW9jazxFeGVjdXRpb25Db250ZXh0Pih7XG4gICAgICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcbiAgICAgICAgICBnZXRSZXF1ZXN0OiAoKSA9PiAoe1xuICAgICAgICAgICAgdXNlcjogeyBpZDogJ3VzZXItMTIzJyB9LFxuICAgICAgICAgICAgcGFyYW1zOiB7IHVzZXJJZDogJ3RhcmdldC11c2VyLTQ1NicgfSxcbiAgICAgICAgICAgIHF1ZXJ5OiB7fSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgamVzdC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpLm1vY2tSZXR1cm5WYWx1ZShwZXJtaXNzaW9uT3B0aW9ucyk7XG4gICAgICBtb2NrUGVybWlzc2lvblNlcnZpY2UuaGFzUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKTtcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBndWFyZC5jYW5BY3RpdmF0ZShjb250ZXh0KTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVmbGVjdG9yLmdldEFsbEFuZE92ZXJyaWRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChQRVJNSVNTSU9OX1JFUVVJUkVNRU5UU19LRVksIFtcbiAgICAgICAgY29udGV4dC5nZXRIYW5kbGVyKCksXG4gICAgICAgIGNvbnRleHQuZ2V0Q2xhc3MoKSxcbiAgICAgIF0pO1xuICAgICAgZXhwZWN0KG1vY2tQZXJtaXNzaW9uU2VydmljZS5oYXNQZXJtaXNzaW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICd1c3VhcmlvLnZpc3VhbGl6YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5VTklULFxuICAgICAgICBzY29wZUlkOiAndGFyZ2V0LXVzZXItNDU2JyxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBzY29wZUlkIGZyb20gcmVxdWVzdCBxdWVyeSB3aGVuIHNjb3BlVHlwZSBpcyBVTklUIGFuZCBwYXJhbSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwZXJtaXNzaW9uT3B0aW9ucyA9IHtcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICd1c3VhcmlvLnZpc3VhbGl6YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5VTklULFxuICAgICAgICBzY29wZUlkUGFyYW06ICd1c2VySWQnLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZU1vY2s8RXhlY3V0aW9uQ29udGV4dD4oe1xuICAgICAgICBzd2l0Y2hUb0h0dHA6ICgpID0+ICh7XG4gICAgICAgICAgZ2V0UmVxdWVzdDogKCkgPT4gKHtcbiAgICAgICAgICAgIHVzZXI6IHsgaWQ6ICd1c2VyLTEyMycgfSxcbiAgICAgICAgICAgIHBhcmFtczoge30sXG4gICAgICAgICAgICBxdWVyeTogeyB1c2VySWQ6ICd0YXJnZXQtdXNlci00NTYnIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG5cbiAgICAgIGplc3Quc3B5T24ocmVmbGVjdG9yLCAnZ2V0QWxsQW5kT3ZlcnJpZGUnKS5tb2NrUmV0dXJuVmFsdWUocGVybWlzc2lvbk9wdGlvbnMpO1xuICAgICAgbW9ja1Blcm1pc3Npb25TZXJ2aWNlLmhhc1Blcm1pc3Npb24ubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSk7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ3VhcmQuY2FuQWN0aXZhdGUoY29udGV4dCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoUEVSTUlTU0lPTl9SRVFVSVJFTUVOVFNfS0VZLCBbXG4gICAgICAgIGNvbnRleHQuZ2V0SGFuZGxlcigpLFxuICAgICAgICBjb250ZXh0LmdldENsYXNzKCksXG4gICAgICBdKTtcbiAgICAgIGV4cGVjdChtb2NrUGVybWlzc2lvblNlcnZpY2UuaGFzUGVybWlzc2lvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB1c2VySWQ6ICd1c2VyLTEyMycsXG4gICAgICAgIHBlcm1pc3Npb25OYW1lOiAndXN1YXJpby52aXN1YWxpemFyJyxcbiAgICAgICAgc2NvcGVUeXBlOiBTY29wZVR5cGUuVU5JVCxcbiAgICAgICAgc2NvcGVJZDogJ3RhcmdldC11c2VyLTQ1NicsXG4gICAgICB9KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB3aGVuIHVzZXIgaXMgbm90IGF1dGhlbnRpY2F0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwZXJtaXNzaW9uT3B0aW9ucyA9IHtcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICd1c3VhcmlvLnZpc3VhbGl6YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5HTE9CQUwsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlTW9jazxFeGVjdXRpb25Db250ZXh0Pih7XG4gICAgICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcbiAgICAgICAgICBnZXRSZXF1ZXN0OiAoKSA9PiAoe1xuICAgICAgICAgICAgdXNlcjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgcGFyYW1zOiB7fSxcbiAgICAgICAgICAgIHF1ZXJ5OiB7fSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgamVzdC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpLm1vY2tSZXR1cm5WYWx1ZShwZXJtaXNzaW9uT3B0aW9ucyk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKGNvbnRleHQpKS5yZWplY3RzLnRvVGhyb3coVW5hdXRob3JpemVkRXhjZXB0aW9uKTtcbiAgICAgIGV4cGVjdChyZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFBFUk1JU1NJT05fUkVRVUlSRU1FTlRTX0tFWSwgW1xuICAgICAgICBjb250ZXh0LmdldEhhbmRsZXIoKSxcbiAgICAgICAgY29udGV4dC5nZXRDbGFzcygpLFxuICAgICAgXSk7XG4gICAgICBleHBlY3QobW9ja1Blcm1pc3Npb25TZXJ2aWNlLmhhc1Blcm1pc3Npb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB3aGVuIHNjb3BlSWQgaXMgcmVxdWlyZWQgYnV0IG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBlcm1pc3Npb25PcHRpb25zID0ge1xuICAgICAgICBwZXJtaXNzaW9uTmFtZTogJ3VzdWFyaW8udmlzdWFsaXphcicsXG4gICAgICAgIHNjb3BlVHlwZTogU2NvcGVUeXBlLlVOSVQsXG4gICAgICAgIHNjb3BlSWRQYXJhbTogJ3VzZXJJZCcsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlTW9jazxFeGVjdXRpb25Db250ZXh0Pih7XG4gICAgICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcbiAgICAgICAgICBnZXRSZXF1ZXN0OiAoKSA9PiAoe1xuICAgICAgICAgICAgdXNlcjogeyBpZDogJ3VzZXItMTIzJyB9LFxuICAgICAgICAgICAgcGFyYW1zOiB7fSxcbiAgICAgICAgICAgIHF1ZXJ5OiB7fSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgamVzdC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpLm1vY2tSZXR1cm5WYWx1ZShwZXJtaXNzaW9uT3B0aW9ucyk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKGNvbnRleHQpKS5yZWplY3RzLnRvVGhyb3coVW5hdXRob3JpemVkRXhjZXB0aW9uKTtcbiAgICAgIGV4cGVjdChyZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFBFUk1JU1NJT05fUkVRVUlSRU1FTlRTX0tFWSwgW1xuICAgICAgICBjb250ZXh0LmdldEhhbmRsZXIoKSxcbiAgICAgICAgY29udGV4dC5nZXRDbGFzcygpLFxuICAgICAgXSk7XG4gICAgICBleHBlY3QobW9ja1Blcm1pc3Npb25TZXJ2aWNlLmhhc1Blcm1pc3Npb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=