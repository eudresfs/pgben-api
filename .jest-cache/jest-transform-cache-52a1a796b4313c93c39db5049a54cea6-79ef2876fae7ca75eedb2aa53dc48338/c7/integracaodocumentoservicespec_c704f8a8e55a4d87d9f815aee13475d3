976bf796f2b291f0ebc739dd571dff82
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const axios_1 = require("@nestjs/axios");
const config_1 = require("@nestjs/config");
const rxjs_1 = require("rxjs");
const integracao_documento_service_1 = require("../../services/integracao-documento.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para o serviço de integração com o módulo de documentos
 *
 * Verifica o funcionamento correto das operações de armazenamento e
 * recuperação de comprovantes de pagamento.
 *
 * @author Equipe PGBen
 */
describe('IntegracaoDocumentoService', () => {
    let service;
    let httpService;
    let configService;
    // Mock do HttpService
    const mockHttpService = {
        get: jest.fn(),
        post: jest.fn(),
        put: jest.fn(),
        delete: jest.fn()
    };
    // Mock do ConfigService
    const mockConfigService = {
        get: jest.fn().mockImplementation((key) => {
            if (key === 'documento.apiUrl') {
                return 'http://api-documento.pgben.local';
            }
            if (key === 'documento.apiKey') {
                return 'api-key-mock';
            }
            if (key === 'documento.categoriaComprovante') {
                return 'COMPROVANTE_PAGAMENTO';
            }
            return null;
        })
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                integracao_documento_service_1.IntegracaoDocumentoService,
                {
                    provide: axios_1.HttpService,
                    useValue: mockHttpService
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService
                }
            ],
        }).compile();
        service = module.get(integracao_documento_service_1.IntegracaoDocumentoService);
        httpService = module.get(axios_1.HttpService);
        configService = module.get(config_1.ConfigService);
        // Limpar mocks antes de cada teste
        jest.clearAllMocks();
    });
    describe('uploadComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const usuarioId = 'usuario-id';
        const arquivo = {
            originalname: 'comprovante.pdf',
            mimetype: 'application/pdf',
            buffer: Buffer.from('conteúdo do arquivo'),
            size: 1024
        };
        const mockResposta = {
            id: 'documento-id',
            nome: 'comprovante.pdf',
            tamanho: 1024,
            tipo: 'application/pdf',
            categoria: 'COMPROVANTE_PAGAMENTO',
            referencia: pagamentoId,
            url: 'http://api-documento.pgben.local/documentos/documento-id',
            createdAt: '2023-01-01T00:00:00Z'
        };
        it('deve fazer upload de comprovante com sucesso', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockResposta,
                status: 201,
                statusText: 'Created',
                headers: {},
                config: { headers: {} }
            };
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.uploadComprovante(pagamentoId, arquivo, usuarioId);
            // Verificar resultado
            expect(result).toEqual(mockResposta);
            expect(mockHttpService.post).toHaveBeenCalledWith('http://api-documento.pgben.local/documentos', expect.any(FormData), expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                    'Content-Type': expect.stringContaining('multipart/form-data')
                })
            }));
        });
        it('deve propagar erros HTTP durante o upload', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.post.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 500,
                    data: { message: 'Erro interno do servidor' }
                }
            })));
            // Executar e verificar exceção
            await expect(service.uploadComprovante(pagamentoId, arquivo, usuarioId)).rejects.toThrow();
        });
    });
    describe('obterComprovante', () => {
        const documentoId = 'documento-id';
        const mockDocumento = {
            id: documentoId,
            nome: 'comprovante.pdf',
            tamanho: 1024,
            tipo: 'application/pdf',
            categoria: 'COMPROVANTE_PAGAMENTO',
            referencia: 'pagamento-id',
            url: 'http://api-documento.pgben.local/documentos/documento-id',
            createdAt: '2023-01-01T00:00:00Z'
        };
        it('deve obter documento quando encontrado', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockDocumento,
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} }
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.obterComprovante(documentoId);
            // Verificar resultado
            expect(result).toEqual(mockDocumento);
            expect(mockHttpService.get).toHaveBeenCalledWith(`http://api-documento.pgben.local/documentos/${documentoId}`, expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock'
                })
            }));
        });
        it('deve lançar NotFoundException quando documento não encontrado', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.get.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 404,
                    data: { message: 'Documento não encontrado' }
                }
            })));
            // Executar e verificar exceção
            await expect(service.obterComprovante(documentoId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('listarComprovantes', () => {
        const pagamentoId = 'pagamento-id';
        const mockComprovantes = [
            {
                id: 'documento-1',
                nome: 'comprovante1.pdf',
                tamanho: 1024,
                tipo: 'application/pdf',
                categoria: 'COMPROVANTE_PAGAMENTO',
                referencia: pagamentoId,
                url: 'http://api-documento.pgben.local/documentos/documento-1',
                createdAt: '2023-01-01T00:00:00Z'
            },
            {
                id: 'documento-2',
                nome: 'comprovante2.pdf',
                tamanho: 2048,
                tipo: 'application/pdf',
                categoria: 'COMPROVANTE_PAGAMENTO',
                referencia: pagamentoId,
                url: 'http://api-documento.pgben.local/documentos/documento-2',
                createdAt: '2023-01-02T00:00:00Z'
            }
        ];
        it('deve listar comprovantes quando encontrados', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockComprovantes,
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} }
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.listarComprovantes(pagamentoId);
            // Verificar resultado
            expect(result).toEqual(mockComprovantes);
            expect(mockHttpService.get).toHaveBeenCalledWith(expect.stringContaining(`referencia=${pagamentoId}`), expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock'
                })
            }));
        });
        it('deve retornar array vazio quando não há comprovantes', async () => {
            // Configurar mock da resposta HTTP com array vazio
            const axiosResponse = {
                data: [],
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} }
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.listarComprovantes(pagamentoId);
            // Verificar resultado
            expect(result).toEqual([]);
        });
    });
    describe('removerComprovante', () => {
        const documentoId = 'documento-id';
        const usuarioId = 'usuario-id';
        it('deve remover comprovante com sucesso', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: { success: true },
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} }
            };
            mockHttpService.delete.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            await service.removerComprovante(documentoId, usuarioId);
            // Verificar resultado
            expect(mockHttpService.delete).toHaveBeenCalledWith(`http://api-documento.pgben.local/documentos/${documentoId}`, expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                    'x-user-id': usuarioId
                })
            }));
        });
        it('deve lançar NotFoundException quando documento não encontrado', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.delete.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 404,
                    data: { message: 'Documento não encontrado' }
                }
            })));
            // Executar e verificar exceção
            await expect(service.removerComprovante(documentoId, usuarioId)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve propagar outros erros HTTP', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.delete.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 500,
                    data: { message: 'Erro interno do servidor' }
                }
            })));
            // Executar e verificar exceção
            await expect(service.removerComprovante(documentoId, usuarioId)).rejects.toThrow();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxpbnRlZ3JhY2FvLWRvY3VtZW50by5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQseUNBQTRDO0FBQzVDLDJDQUErQztBQUMvQywrQkFBc0M7QUFFdEMsOEZBQXlGO0FBQ3pGLDJDQUFtRDtBQUVuRDs7Ozs7OztHQU9HO0FBQ0gsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLE9BQW1DLENBQUM7SUFDeEMsSUFBSSxXQUF3QixDQUFDO0lBQzdCLElBQUksYUFBNEIsQ0FBQztJQUVqQyxzQkFBc0I7SUFDdEIsTUFBTSxlQUFlLEdBQUc7UUFDdEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZCxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDbEIsQ0FBQztJQUVGLHdCQUF3QjtJQUN4QixNQUFNLGlCQUFpQixHQUFHO1FBQ3hCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN4QyxJQUFJLEdBQUcsS0FBSyxrQkFBa0IsRUFBRSxDQUFDO2dCQUFBLE9BQU8sa0NBQWtDLENBQUM7WUFBQSxDQUFDO1lBQzVFLElBQUksR0FBRyxLQUFLLGtCQUFrQixFQUFFLENBQUM7Z0JBQUEsT0FBTyxjQUFjLENBQUM7WUFBQSxDQUFDO1lBQ3hELElBQUksR0FBRyxLQUFLLGdDQUFnQyxFQUFFLENBQUM7Z0JBQUEsT0FBTyx1QkFBdUIsQ0FBQztZQUFBLENBQUM7WUFDL0UsT0FBTyxJQUFJLENBQUM7UUFDZCxD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Q1IsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFO2lCQUM5QzthQUNGLENBQUMsQ0FBQyxDQUNKLENBQUM7WUFFRiwrQkFBK0I7WUFDL0IsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxpbnRlZ3JhY2FvLWRvY3VtZW50by5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BuZXN0anMvYXhpb3MnO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBeGlvc1Jlc3BvbnNlIH0gZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgSW50ZWdyYWNhb0RvY3VtZW50b1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9pbnRlZ3JhY2FvLWRvY3VtZW50by5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgbyBzZXJ2acOnbyBkZSBpbnRlZ3Jhw6fDo28gY29tIG8gbcOzZHVsbyBkZSBkb2N1bWVudG9zXG4gKiBcbiAqIFZlcmlmaWNhIG8gZnVuY2lvbmFtZW50byBjb3JyZXRvIGRhcyBvcGVyYcOnw7VlcyBkZSBhcm1hemVuYW1lbnRvIGVcbiAqIHJlY3VwZXJhw6fDo28gZGUgY29tcHJvdmFudGVzIGRlIHBhZ2FtZW50by5cbiAqIFxuICogQGF1dGhvciBFcXVpcGUgUEdCZW5cbiAqL1xuZGVzY3JpYmUoJ0ludGVncmFjYW9Eb2N1bWVudG9TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogSW50ZWdyYWNhb0RvY3VtZW50b1NlcnZpY2U7XG4gIGxldCBodHRwU2VydmljZTogSHR0cFNlcnZpY2U7XG4gIGxldCBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlO1xuXG4gIC8vIE1vY2sgZG8gSHR0cFNlcnZpY2VcbiAgY29uc3QgbW9ja0h0dHBTZXJ2aWNlID0ge1xuICAgIGdldDogamVzdC5mbigpLFxuICAgIHBvc3Q6IGplc3QuZm4oKSxcbiAgICBwdXQ6IGplc3QuZm4oKSxcbiAgICBkZWxldGU6IGplc3QuZm4oKVxuICB9O1xuXG4gIC8vIE1vY2sgZG8gQ29uZmlnU2VydmljZVxuICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICBnZXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ2RvY3VtZW50by5hcGlVcmwnKSB7cmV0dXJuICdodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbCc7fVxuICAgICAgaWYgKGtleSA9PT0gJ2RvY3VtZW50by5hcGlLZXknKSB7cmV0dXJuICdhcGkta2V5LW1vY2snO31cbiAgICAgIGlmIChrZXkgPT09ICdkb2N1bWVudG8uY2F0ZWdvcmlhQ29tcHJvdmFudGUnKSB7cmV0dXJuICdDT01QUk9WQU5URV9QQUdBTUVOVE8nO31cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0pXG4gIH07XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBJbnRlZ3JhY2FvRG9jdW1lbnRvU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEh0dHBTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSHR0cFNlcnZpY2VcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IENvbmZpZ1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tDb25maWdTZXJ2aWNlXG4gICAgICAgIH1cbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8SW50ZWdyYWNhb0RvY3VtZW50b1NlcnZpY2U+KEludGVncmFjYW9Eb2N1bWVudG9TZXJ2aWNlKTtcbiAgICBodHRwU2VydmljZSA9IG1vZHVsZS5nZXQ8SHR0cFNlcnZpY2U+KEh0dHBTZXJ2aWNlKTtcbiAgICBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxDb25maWdTZXJ2aWNlPihDb25maWdTZXJ2aWNlKTtcblxuICAgIC8vIExpbXBhciBtb2NrcyBhbnRlcyBkZSBjYWRhIHRlc3RlXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd1cGxvYWRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcbiAgICBjb25zdCBhcnF1aXZvID0ge1xuICAgICAgb3JpZ2luYWxuYW1lOiAnY29tcHJvdmFudGUucGRmJyxcbiAgICAgIG1pbWV0eXBlOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICAgIGJ1ZmZlcjogQnVmZmVyLmZyb20oJ2NvbnRlw7pkbyBkbyBhcnF1aXZvJyksXG4gICAgICBzaXplOiAxMDI0XG4gICAgfSBhcyBhbnk7XG5cbiAgICBjb25zdCBtb2NrUmVzcG9zdGEgPSB7XG4gICAgICBpZDogJ2RvY3VtZW50by1pZCcsXG4gICAgICBub21lOiAnY29tcHJvdmFudGUucGRmJyxcbiAgICAgIHRhbWFuaG86IDEwMjQsXG4gICAgICB0aXBvOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICAgIGNhdGVnb3JpYTogJ0NPTVBST1ZBTlRFX1BBR0FNRU5UTycsXG4gICAgICByZWZlcmVuY2lhOiBwYWdhbWVudG9JZCxcbiAgICAgIHVybDogJ2h0dHA6Ly9hcGktZG9jdW1lbnRvLnBnYmVuLmxvY2FsL2RvY3VtZW50b3MvZG9jdW1lbnRvLWlkJyxcbiAgICAgIGNyZWF0ZWRBdDogJzIwMjMtMDEtMDFUMDA6MDA6MDBaJ1xuICAgIH07XG5cbiAgICBpdCgnZGV2ZSBmYXplciB1cGxvYWQgZGUgY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUFxuICAgICAgY29uc3QgYXhpb3NSZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogbW9ja1Jlc3Bvc3RhLFxuICAgICAgICBzdGF0dXM6IDIwMSxcbiAgICAgICAgc3RhdHVzVGV4dDogJ0NyZWF0ZWQnLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55XG4gICAgICB9O1xuICAgICAgXG4gICAgICBtb2NrSHR0cFNlcnZpY2UucG9zdC5tb2NrUmV0dXJuVmFsdWUob2YoYXhpb3NSZXNwb25zZSkpO1xuXG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnVwbG9hZENvbXByb3ZhbnRlKHBhZ2FtZW50b0lkLCBhcnF1aXZvLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tSZXNwb3N0YSk7XG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcycsXG4gICAgICAgIGV4cGVjdC5hbnkoRm9ybURhdGEpLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaGVhZGVyczogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgJ3gtYXBpLWtleSc6ICdhcGkta2V5LW1vY2snLFxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdtdWx0aXBhcnQvZm9ybS1kYXRhJylcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHByb3BhZ2FyIGVycm9zIEhUVFAgZHVyYW50ZSBvIHVwbG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENvbmZpZ3VyYXIgbW9jayBkbyBlcnJvIEhUVFBcbiAgICAgIG1vY2tIdHRwU2VydmljZS5wb3N0Lm1vY2tSZXR1cm5WYWx1ZShcbiAgICAgICAgdGhyb3dFcnJvcigoKSA9PiAoe1xuICAgICAgICAgIHJlc3BvbnNlOiB7XG4gICAgICAgICAgICBzdGF0dXM6IDUwMCxcbiAgICAgICAgICAgIGRhdGE6IHsgbWVzc2FnZTogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSkpXG4gICAgICApO1xuXG4gICAgICAvLyBFeGVjdXRhciBlIHZlcmlmaWNhciBleGNlw6fDo29cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLnVwbG9hZENvbXByb3ZhbnRlKHBhZ2FtZW50b0lkLCBhcnF1aXZvLCB1c3VhcmlvSWQpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ29idGVyQ29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgY29uc3QgZG9jdW1lbnRvSWQgPSAnZG9jdW1lbnRvLWlkJztcbiAgICBcbiAgICBjb25zdCBtb2NrRG9jdW1lbnRvID0ge1xuICAgICAgaWQ6IGRvY3VtZW50b0lkLFxuICAgICAgbm9tZTogJ2NvbXByb3ZhbnRlLnBkZicsXG4gICAgICB0YW1hbmhvOiAxMDI0LFxuICAgICAgdGlwbzogJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICBjYXRlZ29yaWE6ICdDT01QUk9WQU5URV9QQUdBTUVOVE8nLFxuICAgICAgcmVmZXJlbmNpYTogJ3BhZ2FtZW50by1pZCcsXG4gICAgICB1cmw6ICdodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbC9kb2N1bWVudG9zL2RvY3VtZW50by1pZCcsXG4gICAgICBjcmVhdGVkQXQ6ICcyMDIzLTAxLTAxVDAwOjAwOjAwWidcbiAgICB9O1xuXG4gICAgaXQoJ2RldmUgb2J0ZXIgZG9jdW1lbnRvIHF1YW5kbyBlbmNvbnRyYWRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRhIHJlc3Bvc3RhIEhUVFBcbiAgICAgIGNvbnN0IGF4aW9zUmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSB7XG4gICAgICAgIGRhdGE6IG1vY2tEb2N1bWVudG8sXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55XG4gICAgICB9O1xuICAgICAgXG4gICAgICBtb2NrSHR0cFNlcnZpY2UuZ2V0Lm1vY2tSZXR1cm5WYWx1ZShvZihheGlvc1Jlc3BvbnNlKSk7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIG3DqXRvZG9cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uub2J0ZXJDb21wcm92YW50ZShkb2N1bWVudG9JZCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja0RvY3VtZW50byk7XG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGBodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbC9kb2N1bWVudG9zLyR7ZG9jdW1lbnRvSWR9YCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICd4LWFwaS1rZXknOiAnYXBpLWtleS1tb2NrJ1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBOb3RGb3VuZEV4Y2VwdGlvbiBxdWFuZG8gZG9jdW1lbnRvIG7Do28gZW5jb250cmFkbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENvbmZpZ3VyYXIgbW9jayBkbyBlcnJvIEhUVFBcbiAgICAgIG1vY2tIdHRwU2VydmljZS5nZXQubW9ja1JldHVyblZhbHVlKFxuICAgICAgICB0aHJvd0Vycm9yKCgpID0+ICh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICAgICAgZGF0YTogeyBtZXNzYWdlOiAnRG9jdW1lbnRvIG7Do28gZW5jb250cmFkbycgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSkpXG4gICAgICApO1xuXG4gICAgICAvLyBFeGVjdXRhciBlIHZlcmlmaWNhciBleGNlw6fDo29cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLm9idGVyQ29tcHJvdmFudGUoZG9jdW1lbnRvSWQpKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbGlzdGFyQ29tcHJvdmFudGVzJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgXG4gICAgY29uc3QgbW9ja0NvbXByb3ZhbnRlcyA9IFtcbiAgICAgIHtcbiAgICAgICAgaWQ6ICdkb2N1bWVudG8tMScsXG4gICAgICAgIG5vbWU6ICdjb21wcm92YW50ZTEucGRmJyxcbiAgICAgICAgdGFtYW5obzogMTAyNCxcbiAgICAgICAgdGlwbzogJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICAgIGNhdGVnb3JpYTogJ0NPTVBST1ZBTlRFX1BBR0FNRU5UTycsXG4gICAgICAgIHJlZmVyZW5jaWE6IHBhZ2FtZW50b0lkLFxuICAgICAgICB1cmw6ICdodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbC9kb2N1bWVudG9zL2RvY3VtZW50by0xJyxcbiAgICAgICAgY3JlYXRlZEF0OiAnMjAyMy0wMS0wMVQwMDowMDowMFonXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBpZDogJ2RvY3VtZW50by0yJyxcbiAgICAgICAgbm9tZTogJ2NvbXByb3ZhbnRlMi5wZGYnLFxuICAgICAgICB0YW1hbmhvOiAyMDQ4LFxuICAgICAgICB0aXBvOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICAgICAgY2F0ZWdvcmlhOiAnQ09NUFJPVkFOVEVfUEFHQU1FTlRPJyxcbiAgICAgICAgcmVmZXJlbmNpYTogcGFnYW1lbnRvSWQsXG4gICAgICAgIHVybDogJ2h0dHA6Ly9hcGktZG9jdW1lbnRvLnBnYmVuLmxvY2FsL2RvY3VtZW50b3MvZG9jdW1lbnRvLTInLFxuICAgICAgICBjcmVhdGVkQXQ6ICcyMDIzLTAxLTAyVDAwOjAwOjAwWidcbiAgICAgIH1cbiAgICBdO1xuXG4gICAgaXQoJ2RldmUgbGlzdGFyIGNvbXByb3ZhbnRlcyBxdWFuZG8gZW5jb250cmFkb3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUFxuICAgICAgY29uc3QgYXhpb3NSZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogbW9ja0NvbXByb3ZhbnRlcyxcbiAgICAgICAgc3RhdHVzOiAyMDAsXG4gICAgICAgIHN0YXR1c1RleHQ6ICdPSycsXG4gICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICBjb25maWc6IHsgaGVhZGVyczoge30gfSBhcyBhbnlcbiAgICAgIH07XG4gICAgICBcbiAgICAgIG1vY2tIdHRwU2VydmljZS5nZXQubW9ja1JldHVyblZhbHVlKG9mKGF4aW9zUmVzcG9uc2UpKTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5saXN0YXJDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tDb21wcm92YW50ZXMpO1xuICAgICAgZXhwZWN0KG1vY2tIdHRwU2VydmljZS5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyhgcmVmZXJlbmNpYT0ke3BhZ2FtZW50b0lkfWApLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaGVhZGVyczogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgJ3gtYXBpLWtleSc6ICdhcGkta2V5LW1vY2snXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZXRvcm5hciBhcnJheSB2YXppbyBxdWFuZG8gbsOjbyBow6EgY29tcHJvdmFudGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRhIHJlc3Bvc3RhIEhUVFAgY29tIGFycmF5IHZhemlvXG4gICAgICBjb25zdCBheGlvc1Jlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlID0ge1xuICAgICAgICBkYXRhOiBbXSxcbiAgICAgICAgc3RhdHVzOiAyMDAsXG4gICAgICAgIHN0YXR1c1RleHQ6ICdPSycsXG4gICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICBjb25maWc6IHsgaGVhZGVyczoge30gfSBhcyBhbnlcbiAgICAgIH07XG4gICAgICBcbiAgICAgIG1vY2tIdHRwU2VydmljZS5nZXQubW9ja1JldHVyblZhbHVlKG9mKGF4aW9zUmVzcG9uc2UpKTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5saXN0YXJDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFtdKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JlbW92ZXJDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBkb2N1bWVudG9JZCA9ICdkb2N1bWVudG8taWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcblxuICAgIGl0KCdkZXZlIHJlbW92ZXIgY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUFxuICAgICAgY29uc3QgYXhpb3NSZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogeyBzdWNjZXNzOiB0cnVlIH0sXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55XG4gICAgICB9O1xuICAgICAgXG4gICAgICBtb2NrSHR0cFNlcnZpY2UuZGVsZXRlLm1vY2tSZXR1cm5WYWx1ZShvZihheGlvc1Jlc3BvbnNlKSk7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIG3DqXRvZG9cbiAgICAgIGF3YWl0IHNlcnZpY2UucmVtb3ZlckNvbXByb3ZhbnRlKGRvY3VtZW50b0lkLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLmRlbGV0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGBodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbC9kb2N1bWVudG9zLyR7ZG9jdW1lbnRvSWR9YCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICd4LWFwaS1rZXknOiAnYXBpLWtleS1tb2NrJyxcbiAgICAgICAgICAgICd4LXVzZXItaWQnOiB1c3VhcmlvSWRcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgTm90Rm91bmRFeGNlcHRpb24gcXVhbmRvIGRvY3VtZW50byBuw6NvIGVuY29udHJhZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZG8gZXJybyBIVFRQXG4gICAgICBtb2NrSHR0cFNlcnZpY2UuZGVsZXRlLm1vY2tSZXR1cm5WYWx1ZShcbiAgICAgICAgdGhyb3dFcnJvcigoKSA9PiAoe1xuICAgICAgICAgIHJlc3BvbnNlOiB7XG4gICAgICAgICAgICBzdGF0dXM6IDQwNCxcbiAgICAgICAgICAgIGRhdGE6IHsgbWVzc2FnZTogJ0RvY3VtZW50byBuw6NvIGVuY29udHJhZG8nIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pKVxuICAgICAgKTtcblxuICAgICAgLy8gRXhlY3V0YXIgZSB2ZXJpZmljYXIgZXhjZcOnw6NvXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5yZW1vdmVyQ29tcHJvdmFudGUoZG9jdW1lbnRvSWQsIHVzdWFyaW9JZCkpLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBwcm9wYWdhciBvdXRyb3MgZXJyb3MgSFRUUCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENvbmZpZ3VyYXIgbW9jayBkbyBlcnJvIEhUVFBcbiAgICAgIG1vY2tIdHRwU2VydmljZS5kZWxldGUubW9ja1JldHVyblZhbHVlKFxuICAgICAgICB0aHJvd0Vycm9yKCgpID0+ICh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHN0YXR1czogNTAwLFxuICAgICAgICAgICAgZGF0YTogeyBtZXNzYWdlOiAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yJyB9XG4gICAgICAgICAgfVxuICAgICAgICB9KSlcbiAgICAgICk7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIGUgdmVyaWZpY2FyIGV4Y2XDp8Ojb1xuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UucmVtb3ZlckNvbXByb3ZhbnRlKGRvY3VtZW50b0lkLCB1c3VhcmlvSWQpKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==