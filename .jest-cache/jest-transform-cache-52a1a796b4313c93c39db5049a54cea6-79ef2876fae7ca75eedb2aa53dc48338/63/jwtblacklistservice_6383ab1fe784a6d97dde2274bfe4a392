6c6223e417cab6047822c2242ad1724e
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var JwtBlacklistService_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.JwtBlacklistService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const config_1 = require("@nestjs/config");
const jwt_1 = require("@nestjs/jwt");
const jwt_blacklist_entity_1 = require("../../entities/jwt-blacklist.entity");
/**
 * Serviço de Blacklist de Tokens JWT
 *
 * Gerencia tokens JWT invalidados para prevenir reutilização
 * de tokens comprometidos, revogados ou de usuários deslogados
 */
let JwtBlacklistService = JwtBlacklistService_1 = class JwtBlacklistService {
    jwtBlacklistRepository;
    configService;
    jwtService;
    logger = new common_1.Logger(JwtBlacklistService_1.name);
    CLEANUP_INTERVAL = 6 * 60 * 60 * 1000; // 6 horas
    lastCleanup = new Date();
    constructor(jwtBlacklistRepository, configService, jwtService) {
        this.jwtBlacklistRepository = jwtBlacklistRepository;
        this.configService = configService;
        this.jwtService = jwtService;
        // Iniciar limpeza automática de tokens expirados
        this.startTokenCleanup();
    }
    /**
     * Adiciona um token à blacklist
     * @param addToBlacklistDto Dados do token a ser invalidado
     * @returns Resposta da operação
     */
    async addToBlacklist(addToBlacklistDto) {
        try {
            // Verificar se o token já está na blacklist
            const existingToken = await this.jwtBlacklistRepository.findOne({
                where: { jti: addToBlacklistDto.jti },
            });
            if (existingToken) {
                this.logger.warn(`Token já está na blacklist: ${addToBlacklistDto.jti}`, {
                    jti: addToBlacklistDto.jti,
                    usuarioId: addToBlacklistDto.usuario_id,
                    existingReason: existingToken.reason,
                    newReason: addToBlacklistDto.reason,
                });
                return {
                    message: 'Token já está na blacklist',
                    success: true,
                    affected_count: 0,
                };
            }
            // Criar registro na blacklist
            const blacklistEntry = this.jwtBlacklistRepository.create({
                jti: addToBlacklistDto.jti,
                usuario_id: addToBlacklistDto.usuario_id,
                token_type: addToBlacklistDto.token_type,
                expires_at: new Date(addToBlacklistDto.expires_at),
                reason: addToBlacklistDto.reason,
                client_ip: addToBlacklistDto.client_ip,
                user_agent: addToBlacklistDto.user_agent,
                metadata: addToBlacklistDto.metadata,
            });
            await this.jwtBlacklistRepository.save(blacklistEntry);
            this.logger.log(`Token adicionado à blacklist: ${addToBlacklistDto.jti}`, {
                jti: addToBlacklistDto.jti,
                usuarioId: addToBlacklistDto.usuario_id,
                tokenType: addToBlacklistDto.token_type,
                reason: addToBlacklistDto.reason,
                expiresAt: addToBlacklistDto.expires_at,
            });
            return {
                message: 'Token adicionado à blacklist com sucesso',
                success: true,
                affected_count: 1,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao adicionar token à blacklist: ${error.message}`, {
                jti: addToBlacklistDto.jti,
                error: error.stack,
            });
            throw new common_1.InternalServerErrorException('Erro interno ao invalidar token');
        }
    }
    /**
     * Verifica se um token está na blacklist
     * @param checkBlacklistDto Dados do token a ser verificado
     * @returns Status do token na blacklist
     */
    async isTokenBlacklisted(checkBlacklistDto) {
        try {
            const blacklistEntry = await this.jwtBlacklistRepository.findOne({
                where: { jti: checkBlacklistDto.jti },
            });
            if (!blacklistEntry) {
                return {
                    is_blacklisted: false,
                };
            }
            // Verificar se o token ainda está válido na blacklist
            const isStillBlacklisted = blacklistEntry.isStillBlacklisted();
            if (!isStillBlacklisted) {
                // Token expirou, pode ser removido da blacklist
                await this.jwtBlacklistRepository.remove(blacklistEntry);
                return {
                    is_blacklisted: false,
                };
            }
            return {
                is_blacklisted: true,
                reason: blacklistEntry.reason,
                expires_at: blacklistEntry.expires_at.toISOString(),
                minutes_until_expiration: blacklistEntry.getMinutesUntilExpiration(),
            };
        }
        catch (error) {
            this.logger.error(`Erro ao verificar blacklist: ${error.message}`, {
                jti: checkBlacklistDto.jti,
                error: error.stack,
            });
            // Em caso de erro, assumir que o token não está blacklisted
            // para não bloquear usuários desnecessariamente
            return {
                is_blacklisted: false,
            };
        }
    }
    /**
     * Invalida todos os tokens de um usuário
     * @param invalidateDto Dados da invalidação
     * @param activeTokens Lista de tokens ativos do usuário
     * @returns Resposta da operação
     */
    async invalidateUserTokens(invalidateDto, activeTokens) {
        try {
            if (!activeTokens || activeTokens.length === 0) {
                return {
                    message: 'Nenhum token ativo encontrado para invalidar',
                    success: true,
                    affected_count: 0,
                };
            }
            // Filtrar tokens por tipo se especificado
            let tokensToInvalidate = activeTokens;
            if (invalidateDto.token_type && invalidateDto.token_type !== 'all') {
                tokensToInvalidate = activeTokens.filter(token => token.token_type === invalidateDto.token_type);
            }
            // Criar registros na blacklist
            const blacklistEntries = tokensToInvalidate.map(token => this.jwtBlacklistRepository.create({
                jti: token.jti,
                usuario_id: invalidateDto.usuario_id,
                token_type: token.token_type,
                expires_at: token.expires_at,
                reason: invalidateDto.reason,
                client_ip: invalidateDto.client_ip,
                user_agent: invalidateDto.user_agent,
                metadata: {
                    bulk_invalidation: true,
                    invalidated_at: new Date().toISOString(),
                },
            }));
            await this.jwtBlacklistRepository.save(blacklistEntries);
            this.logger.log(`Tokens de usuário invalidados em massa`, {
                usuarioId: invalidateDto.usuario_id,
                tokenType: invalidateDto.token_type || 'all',
                reason: invalidateDto.reason,
                affectedCount: blacklistEntries.length,
                tokenJtis: tokensToInvalidate.map(t => t.jti),
            });
            return {
                message: `${blacklistEntries.length} token(s) invalidado(s) com sucesso`,
                success: true,
                affected_count: blacklistEntries.length,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao invalidar tokens do usuário: ${error.message}`, {
                usuarioId: invalidateDto.usuario_id,
                error: error.stack,
            });
            throw new common_1.InternalServerErrorException('Erro interno ao invalidar tokens do usuário');
        }
    }
    /**
     * Remove um token específico da blacklist
     * @param jti JWT ID do token
     * @returns Resposta da operação
     */
    async removeFromBlacklist(jti) {
        try {
            const result = await this.jwtBlacklistRepository.delete({ jti });
            if (result.affected === 0) {
                throw new common_1.NotFoundException('Token não encontrado na blacklist');
            }
            this.logger.log(`Token removido da blacklist: ${jti}`);
            return {
                message: 'Token removido da blacklist com sucesso',
                success: true,
                affected_count: result.affected || 0,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao remover token da blacklist: ${error.message}`, {
                jti,
                error: error.stack,
            });
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao remover token da blacklist');
        }
    }
    /**
     * Lista tokens na blacklist com filtros
     * @param queryDto Filtros de consulta
     * @returns Lista paginada de tokens
     */
    async listBlacklistedTokens(queryDto) {
        try {
            const page = queryDto.page || 1;
            const limit = Math.min(queryDto.limit || 10, 100);
            const skip = (page - 1) * limit;
            const queryBuilder = this.jwtBlacklistRepository.createQueryBuilder('blacklist');
            // Aplicar filtros
            if (queryDto.usuario_id) {
                queryBuilder.andWhere('blacklist.usuario_id = :usuario_id', {
                    usuario_id: queryDto.usuario_id,
                });
            }
            if (queryDto.token_type) {
                queryBuilder.andWhere('blacklist.token_type = :token_type', {
                    token_type: queryDto.token_type,
                });
            }
            if (queryDto.reason) {
                queryBuilder.andWhere('blacklist.reason = :reason', {
                    reason: queryDto.reason,
                });
            }
            if (queryDto.only_active) {
                queryBuilder.andWhere('blacklist.expires_at > :now', {
                    now: new Date(),
                });
            }
            // Ordenar por data de criação (mais recentes primeiro)
            queryBuilder.orderBy('blacklist.created_at', 'DESC');
            // Aplicar paginação
            queryBuilder.skip(skip).take(limit);
            const [data, total] = await queryBuilder.getManyAndCount();
            const totalPages = Math.ceil(total / limit);
            return {
                data,
                total,
                page,
                limit,
                totalPages,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao listar tokens blacklisted: ${error.message}`, {
                queryDto,
                error: error.stack,
            });
            throw new common_1.InternalServerErrorException('Erro interno ao consultar blacklist');
        }
    }
    /**
     * Obtém estatísticas da blacklist
     * @returns Estatísticas detalhadas
     */
    async getBlacklistStats() {
        try {
            const now = new Date();
            const [total, expired, active, accessTokens, refreshTokens, reasonStats] = await Promise.all([
                this.jwtBlacklistRepository.count(),
                this.jwtBlacklistRepository.count({
                    where: { expires_at: (0, typeorm_2.LessThan)(now) },
                }),
                this.jwtBlacklistRepository.count({
                    where: { expires_at: (0, typeorm_2.MoreThan)(now) },
                }),
                this.jwtBlacklistRepository.count({
                    where: { token_type: 'access' },
                }),
                this.jwtBlacklistRepository.count({
                    where: { token_type: 'refresh' },
                }),
                this.getReasonStats(),
            ]);
            return {
                total,
                active,
                expired,
                access_tokens: accessTokens,
                refresh_tokens: refreshTokens,
                by_reason: reasonStats,
                last_cleanup: this.lastCleanup.toISOString(),
            };
        }
        catch (error) {
            this.logger.error(`Erro ao obter estatísticas da blacklist: ${error.message}`, {
                error: error.stack,
            });
            throw new common_1.InternalServerErrorException('Erro interno ao obter estatísticas');
        }
    }
    /**
     * Limpa tokens expirados da blacklist
     * @returns Número de tokens removidos
     */
    async cleanupExpiredTokens() {
        try {
            const result = await this.jwtBlacklistRepository.delete({
                expires_at: (0, typeorm_2.LessThan)(new Date()),
            });
            const deletedCount = result.affected || 0;
            this.lastCleanup = new Date();
            this.logger.log(`Limpeza da blacklist: ${deletedCount} tokens expirados removidos`);
            return deletedCount;
        }
        catch (error) {
            this.logger.error(`Erro na limpeza da blacklist: ${error.message}`, {
                error: error.stack,
            });
            throw new common_1.InternalServerErrorException('Erro interno na limpeza da blacklist');
        }
    }
    /**
     * Obtém estatísticas por motivo de invalidação
     * @returns Contagem por motivo
     */
    async getReasonStats() {
        try {
            const results = await this.jwtBlacklistRepository
                .createQueryBuilder('blacklist')
                .select('blacklist.reason', 'reason')
                .addSelect('COUNT(*)', 'count')
                .groupBy('blacklist.reason')
                .getRawMany();
            const stats = {};
            results.forEach(result => {
                stats[result.reason] = parseInt(result.count, 10);
            });
            return stats;
        }
        catch (error) {
            this.logger.error(`Erro ao obter estatísticas por motivo: ${error.message}`);
            return {};
        }
    }
    /**
     * Inicia limpeza automática de tokens expirados
     */
    startTokenCleanup() {
        setInterval(async () => {
            try {
                const deletedCount = await this.cleanupExpiredTokens();
                if (deletedCount > 0) {
                    this.logger.log(`Limpeza automática da blacklist: ${deletedCount} tokens removidos`);
                }
            }
            catch (error) {
                this.logger.error(`Erro na limpeza automática da blacklist: ${error.message}`);
            }
        }, this.CLEANUP_INTERVAL);
    }
    /**
     * Extrai JTI de um token JWT
     * @param token Token JWT
     * @returns JTI ou null se inválido
     */
    extractJtiFromToken(token) {
        try {
            const decoded = this.jwtService.decode(token);
            return decoded?.jti || null;
        }
        catch (error) {
            this.logger.warn(`Erro ao extrair JTI do token: ${error.message}`);
            return null;
        }
    }
    /**
     * Valida se um token JWT não está na blacklist
     * Método utilitário para uso em guards
     * @param token Token JWT completo
     * @returns true se o token é válido (não blacklisted)
     */
    async validateTokenNotBlacklisted(token) {
        const jti = this.extractJtiFromToken(token);
        if (!jti) {
            return false;
        }
        const result = await this.isTokenBlacklisted({ jti });
        return !result.is_blacklisted;
    }
};
exports.JwtBlacklistService = JwtBlacklistService;
exports.JwtBlacklistService = JwtBlacklistService = JwtBlacklistService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(jwt_blacklist_entity_1.JwtBlacklist)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _b : Object, typeof (_c = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _c : Object])
], JwtBlacklistService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxqd3QtYmxhY2tsaXN0LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FLd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUE2RDtBQUM3RCwyQ0FBK0M7QUFDL0MscUNBQXlDO0FBQ3pDLDhFQUFtRTtBQVduRTs7Ozs7R0FLRztBQUVJLElBQU0sbUJBQW1CLDJCQUF6QixNQUFNLG1CQUFtQjtJQU9YO0lBQ0E7SUFDQTtJQVJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxxQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QyxnQkFBZ0IsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxVQUFVO0lBQzFELFdBQVcsR0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO0lBRXZDLFlBRW1CLHNCQUFnRCxFQUNoRCxhQUE0QixFQUM1QixVQUFzQjtRQUZ0QiwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQTBCO1FBQ2hELGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFFdkMsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FDbEIsaUJBQW9DO1FBRXBDLElBQUksQ0FBQztZQUNILDRDQUE0QztZQUM1QyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUM7Z0JBQzlELEtBQUssRUFBRSxFQUFFLEdBQUcsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7YUFDdEMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxhQUFhLEVBQUUsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJ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OztPQUtHO0lBQ0gsS0FBSyxDQUFDLDJCQUEyQixDQUFDLEtBQWE7UUFDN0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNULE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN0RCxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQztJQUNoQyxDQUFDO0NBQ0YsQ0FBQTtBQTljWSxrREFBbUI7OEJBQW5CLG1CQUFtQjtJQUQvQixJQUFBLG1CQUFVLEdBQUU7SUFPUixXQUFBLElBQUEsMEJBQWdCLEVBQUMsbUNBQVksQ0FBQyxDQUFBO3lEQUNVLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNuQixzQkFBYSxvQkFBYixzQkFBYSxvREFDaEIsZ0JBQVUsb0JBQVYsZ0JBQVU7R0FUOUIsbUJBQW1CLENBOGMvQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcYXV0aFxcc2VydmljZXNcXGp3dC1ibGFja2xpc3Quc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBMb2dnZXIsXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcbmltcG9ydCB7IFJlcG9zaXRvcnksIExlc3NUaGFuLCBNb3JlVGhhbiwgSW4gfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBKd3RTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9qd3QnO1xuaW1wb3J0IHsgSnd0QmxhY2tsaXN0IH0gZnJvbSAnLi4vLi4vZW50aXRpZXMvand0LWJsYWNrbGlzdC5lbnRpdHknO1xuaW1wb3J0IHtcbiAgQWRkVG9CbGFja2xpc3REdG8sXG4gIENoZWNrQmxhY2tsaXN0RHRvLFxuICBJbnZhbGlkYXRlVXNlclRva2Vuc0R0byxcbiAgQmxhY2tsaXN0UmVzcG9uc2VEdG8sXG4gIENoZWNrQmxhY2tsaXN0UmVzcG9uc2VEdG8sXG4gIEJsYWNrbGlzdFF1ZXJ5RHRvLFxuICBCbGFja2xpc3RTdGF0c0R0byxcbn0gZnJvbSAnLi4vZHRvcy9qd3QtYmxhY2tsaXN0LmR0byc7XG5cbi8qKlxuICogU2VydmnDp28gZGUgQmxhY2tsaXN0IGRlIFRva2VucyBKV1RcbiAqIFxuICogR2VyZW5jaWEgdG9rZW5zIEpXVCBpbnZhbGlkYWRvcyBwYXJhIHByZXZlbmlyIHJldXRpbGl6YcOnw6NvXG4gKiBkZSB0b2tlbnMgY29tcHJvbWV0aWRvcywgcmV2b2dhZG9zIG91IGRlIHVzdcOhcmlvcyBkZXNsb2dhZG9zXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBKd3RCbGFja2xpc3RTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEp3dEJsYWNrbGlzdFNlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0xFQU5VUF9JTlRFUlZBTCA9IDYgKiA2MCAqIDYwICogMTAwMDsgLy8gNiBob3Jhc1xuICBwcml2YXRlIGxhc3RDbGVhbnVwOiBEYXRlID0gbmV3IERhdGUoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShKd3RCbGFja2xpc3QpXG4gICAgcHJpdmF0ZSByZWFkb25seSBqd3RCbGFja2xpc3RSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEp3dEJsYWNrbGlzdD4sXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgand0U2VydmljZTogSnd0U2VydmljZSxcbiAgKSB7XG4gICAgLy8gSW5pY2lhciBsaW1wZXphIGF1dG9tw6F0aWNhIGRlIHRva2VucyBleHBpcmFkb3NcbiAgICB0aGlzLnN0YXJ0VG9rZW5DbGVhbnVwKCk7XG4gIH1cblxuICAvKipcbiAgICogQWRpY2lvbmEgdW0gdG9rZW4gw6AgYmxhY2tsaXN0XG4gICAqIEBwYXJhbSBhZGRUb0JsYWNrbGlzdER0byBEYWRvcyBkbyB0b2tlbiBhIHNlciBpbnZhbGlkYWRvXG4gICAqIEByZXR1cm5zIFJlc3Bvc3RhIGRhIG9wZXJhw6fDo29cbiAgICovXG4gIGFzeW5jIGFkZFRvQmxhY2tsaXN0KFxuICAgIGFkZFRvQmxhY2tsaXN0RHRvOiBBZGRUb0JsYWNrbGlzdER0byxcbiAgKTogUHJvbWlzZTxCbGFja2xpc3RSZXNwb25zZUR0bz4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyB0b2tlbiBqw6EgZXN0w6EgbmEgYmxhY2tsaXN0XG4gICAgICBjb25zdCBleGlzdGluZ1Rva2VuID0gYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBqdGk6IGFkZFRvQmxhY2tsaXN0RHRvLmp0aSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChleGlzdGluZ1Rva2VuKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFRva2VuIGrDoSBlc3TDoSBuYSBibGFja2xpc3Q6ICR7YWRkVG9CbGFja2xpc3REdG8uanRpfWAsIHtcbiAgICAgICAgICBqdGk6IGFkZFRvQmxhY2tsaXN0RHRvLmp0aSxcbiAgICAgICAgICB1c3VhcmlvSWQ6IGFkZFRvQmxhY2tsaXN0RHRvLnVzdWFyaW9faWQsXG4gICAgICAgICAgZXhpc3RpbmdSZWFzb246IGV4aXN0aW5nVG9rZW4ucmVhc29uLFxuICAgICAgICAgIG5ld1JlYXNvbjogYWRkVG9CbGFja2xpc3REdG8ucmVhc29uLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBqw6EgZXN0w6EgbmEgYmxhY2tsaXN0JyxcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIGFmZmVjdGVkX2NvdW50OiAwLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBDcmlhciByZWdpc3RybyBuYSBibGFja2xpc3RcbiAgICAgIGNvbnN0IGJsYWNrbGlzdEVudHJ5ID0gdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAgIGp0aTogYWRkVG9CbGFja2xpc3REdG8uanRpLFxuICAgICAgICB1c3VhcmlvX2lkOiBhZGRUb0JsYWNrbGlzdER0by51c3VhcmlvX2lkLFxuICAgICAgICB0b2tlbl90eXBlOiBhZGRUb0JsYWNrbGlzdER0by50b2tlbl90eXBlLFxuICAgICAgICBleHBpcmVzX2F0OiBuZXcgRGF0ZShhZGRUb0JsYWNrbGlzdER0by5leHBpcmVzX2F0KSxcbiAgICAgICAgcmVhc29uOiBhZGRUb0JsYWNrbGlzdER0by5yZWFzb24sXG4gICAgICAgIGNsaWVudF9pcDogYWRkVG9CbGFja2xpc3REdG8uY2xpZW50X2lwLFxuICAgICAgICB1c2VyX2FnZW50OiBhZGRUb0JsYWNrbGlzdER0by51c2VyX2FnZW50LFxuICAgICAgICBtZXRhZGF0YTogYWRkVG9CbGFja2xpc3REdG8ubWV0YWRhdGEsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LnNhdmUoYmxhY2tsaXN0RW50cnkpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFRva2VuIGFkaWNpb25hZG8gw6AgYmxhY2tsaXN0OiAke2FkZFRvQmxhY2tsaXN0RHRvLmp0aX1gLCB7XG4gICAgICAgIGp0aTogYWRkVG9CbGFja2xpc3REdG8uanRpLFxuICAgICAgICB1c3VhcmlvSWQ6IGFkZFRvQmxhY2tsaXN0RHRvLnVzdWFyaW9faWQsXG4gICAgICAgIHRva2VuVHlwZTogYWRkVG9CbGFja2xpc3REdG8udG9rZW5fdHlwZSxcbiAgICAgICAgcmVhc29uOiBhZGRUb0JsYWNrbGlzdER0by5yZWFzb24sXG4gICAgICAgIGV4cGlyZXNBdDogYWRkVG9CbGFja2xpc3REdG8uZXhwaXJlc19hdCxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiAnVG9rZW4gYWRpY2lvbmFkbyDDoCBibGFja2xpc3QgY29tIHN1Y2Vzc28nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBhZmZlY3RlZF9jb3VudDogMSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIGFvIGFkaWNpb25hciB0b2tlbiDDoCBibGFja2xpc3Q6ICR7ZXJyb3IubWVzc2FnZX1gLCB7XG4gICAgICAgIGp0aTogYWRkVG9CbGFja2xpc3REdG8uanRpLFxuICAgICAgICBlcnJvcjogZXJyb3Iuc3RhY2ssXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdFcnJvIGludGVybm8gYW8gaW52YWxpZGFyIHRva2VuJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtIHRva2VuIGVzdMOhIG5hIGJsYWNrbGlzdFxuICAgKiBAcGFyYW0gY2hlY2tCbGFja2xpc3REdG8gRGFkb3MgZG8gdG9rZW4gYSBzZXIgdmVyaWZpY2Fkb1xuICAgKiBAcmV0dXJucyBTdGF0dXMgZG8gdG9rZW4gbmEgYmxhY2tsaXN0XG4gICAqL1xuICBhc3luYyBpc1Rva2VuQmxhY2tsaXN0ZWQoXG4gICAgY2hlY2tCbGFja2xpc3REdG86IENoZWNrQmxhY2tsaXN0RHRvLFxuICApOiBQcm9taXNlPENoZWNrQmxhY2tsaXN0UmVzcG9uc2VEdG8+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYmxhY2tsaXN0RW50cnkgPSBhd2FpdCB0aGlzLmp3dEJsYWNrbGlzdFJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7IGp0aTogY2hlY2tCbGFja2xpc3REdG8uanRpIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFibGFja2xpc3RFbnRyeSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzX2JsYWNrbGlzdGVkOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gdG9rZW4gYWluZGEgZXN0w6EgdsOhbGlkbyBuYSBibGFja2xpc3RcbiAgICAgIGNvbnN0IGlzU3RpbGxCbGFja2xpc3RlZCA9IGJsYWNrbGlzdEVudHJ5LmlzU3RpbGxCbGFja2xpc3RlZCgpO1xuXG4gICAgICBpZiAoIWlzU3RpbGxCbGFja2xpc3RlZCkge1xuICAgICAgICAvLyBUb2tlbiBleHBpcm91LCBwb2RlIHNlciByZW1vdmlkbyBkYSBibGFja2xpc3RcbiAgICAgICAgYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LnJlbW92ZShibGFja2xpc3RFbnRyeSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzX2JsYWNrbGlzdGVkOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNfYmxhY2tsaXN0ZWQ6IHRydWUsXG4gICAgICAgIHJlYXNvbjogYmxhY2tsaXN0RW50cnkucmVhc29uLFxuICAgICAgICBleHBpcmVzX2F0OiBibGFja2xpc3RFbnRyeS5leHBpcmVzX2F0LnRvSVNPU3RyaW5nKCksXG4gICAgICAgIG1pbnV0ZXNfdW50aWxfZXhwaXJhdGlvbjogYmxhY2tsaXN0RW50cnkuZ2V0TWludXRlc1VudGlsRXhwaXJhdGlvbigpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gdmVyaWZpY2FyIGJsYWNrbGlzdDogJHtlcnJvci5tZXNzYWdlfWAsIHtcbiAgICAgICAganRpOiBjaGVja0JsYWNrbGlzdER0by5qdGksXG4gICAgICAgIGVycm9yOiBlcnJvci5zdGFjayxcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICAvLyBFbSBjYXNvIGRlIGVycm8sIGFzc3VtaXIgcXVlIG8gdG9rZW4gbsOjbyBlc3TDoSBibGFja2xpc3RlZFxuICAgICAgLy8gcGFyYSBuw6NvIGJsb3F1ZWFyIHVzdcOhcmlvcyBkZXNuZWNlc3NhcmlhbWVudGVcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzX2JsYWNrbGlzdGVkOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEludmFsaWRhIHRvZG9zIG9zIHRva2VucyBkZSB1bSB1c3XDoXJpb1xuICAgKiBAcGFyYW0gaW52YWxpZGF0ZUR0byBEYWRvcyBkYSBpbnZhbGlkYcOnw6NvXG4gICAqIEBwYXJhbSBhY3RpdmVUb2tlbnMgTGlzdGEgZGUgdG9rZW5zIGF0aXZvcyBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyBSZXNwb3N0YSBkYSBvcGVyYcOnw6NvXG4gICAqL1xuICBhc3luYyBpbnZhbGlkYXRlVXNlclRva2VucyhcbiAgICBpbnZhbGlkYXRlRHRvOiBJbnZhbGlkYXRlVXNlclRva2Vuc0R0byxcbiAgICBhY3RpdmVUb2tlbnM6IEFycmF5PHtcbiAgICAgIGp0aTogc3RyaW5nO1xuICAgICAgdG9rZW5fdHlwZTogJ2FjY2VzcycgfCAncmVmcmVzaCc7XG4gICAgICBleHBpcmVzX2F0OiBEYXRlO1xuICAgIH0+LFxuICApOiBQcm9taXNlPEJsYWNrbGlzdFJlc3BvbnNlRHRvPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghYWN0aXZlVG9rZW5zIHx8IGFjdGl2ZVRva2Vucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtZXNzYWdlOiAnTmVuaHVtIHRva2VuIGF0aXZvIGVuY29udHJhZG8gcGFyYSBpbnZhbGlkYXInLFxuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgYWZmZWN0ZWRfY291bnQ6IDAsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIEZpbHRyYXIgdG9rZW5zIHBvciB0aXBvIHNlIGVzcGVjaWZpY2Fkb1xuICAgICAgbGV0IHRva2Vuc1RvSW52YWxpZGF0ZSA9IGFjdGl2ZVRva2VucztcbiAgICAgIGlmIChpbnZhbGlkYXRlRHRvLnRva2VuX3R5cGUgJiYgaW52YWxpZGF0ZUR0by50b2tlbl90eXBlICE9PSAnYWxsJykge1xuICAgICAgICB0b2tlbnNUb0ludmFsaWRhdGUgPSBhY3RpdmVUb2tlbnMuZmlsdGVyKFxuICAgICAgICAgIHRva2VuID0+IHRva2VuLnRva2VuX3R5cGUgPT09IGludmFsaWRhdGVEdG8udG9rZW5fdHlwZSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ3JpYXIgcmVnaXN0cm9zIG5hIGJsYWNrbGlzdFxuICAgICAgY29uc3QgYmxhY2tsaXN0RW50cmllcyA9IHRva2Vuc1RvSW52YWxpZGF0ZS5tYXAodG9rZW4gPT4gXG4gICAgICAgIHRoaXMuand0QmxhY2tsaXN0UmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICAgIGp0aTogdG9rZW4uanRpLFxuICAgICAgICAgIHVzdWFyaW9faWQ6IGludmFsaWRhdGVEdG8udXN1YXJpb19pZCxcbiAgICAgICAgICB0b2tlbl90eXBlOiB0b2tlbi50b2tlbl90eXBlLFxuICAgICAgICAgIGV4cGlyZXNfYXQ6IHRva2VuLmV4cGlyZXNfYXQsXG4gICAgICAgICAgcmVhc29uOiBpbnZhbGlkYXRlRHRvLnJlYXNvbixcbiAgICAgICAgICBjbGllbnRfaXA6IGludmFsaWRhdGVEdG8uY2xpZW50X2lwLFxuICAgICAgICAgIHVzZXJfYWdlbnQ6IGludmFsaWRhdGVEdG8udXNlcl9hZ2VudCxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgYnVsa19pbnZhbGlkYXRpb246IHRydWUsXG4gICAgICAgICAgICBpbnZhbGlkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LnNhdmUoYmxhY2tsaXN0RW50cmllcyk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVG9rZW5zIGRlIHVzdcOhcmlvIGludmFsaWRhZG9zIGVtIG1hc3NhYCwge1xuICAgICAgICB1c3VhcmlvSWQ6IGludmFsaWRhdGVEdG8udXN1YXJpb19pZCxcbiAgICAgICAgdG9rZW5UeXBlOiBpbnZhbGlkYXRlRHRvLnRva2VuX3R5cGUgfHwgJ2FsbCcsXG4gICAgICAgIHJlYXNvbjogaW52YWxpZGF0ZUR0by5yZWFzb24sXG4gICAgICAgIGFmZmVjdGVkQ291bnQ6IGJsYWNrbGlzdEVudHJpZXMubGVuZ3RoLFxuICAgICAgICB0b2tlbkp0aXM6IHRva2Vuc1RvSW52YWxpZGF0ZS5tYXAodCA9PiB0Lmp0aSksXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbWVzc2FnZTogYCR7YmxhY2tsaXN0RW50cmllcy5sZW5ndGh9IHRva2VuKHMpIGludmFsaWRhZG8ocykgY29tIHN1Y2Vzc29gLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBhZmZlY3RlZF9jb3VudDogYmxhY2tsaXN0RW50cmllcy5sZW5ndGgsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBhbyBpbnZhbGlkYXIgdG9rZW5zIGRvIHVzdcOhcmlvOiAke2Vycm9yLm1lc3NhZ2V9YCwge1xuICAgICAgICB1c3VhcmlvSWQ6IGludmFsaWRhdGVEdG8udXN1YXJpb19pZCxcbiAgICAgICAgZXJyb3I6IGVycm9yLnN0YWNrLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBpbnRlcm5vIGFvIGludmFsaWRhciB0b2tlbnMgZG8gdXN1w6FyaW8nLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHVtIHRva2VuIGVzcGVjw61maWNvIGRhIGJsYWNrbGlzdFxuICAgKiBAcGFyYW0ganRpIEpXVCBJRCBkbyB0b2tlblxuICAgKiBAcmV0dXJucyBSZXNwb3N0YSBkYSBvcGVyYcOnw6NvXG4gICAqL1xuICBhc3luYyByZW1vdmVGcm9tQmxhY2tsaXN0KGp0aTogc3RyaW5nKTogUHJvbWlzZTxCbGFja2xpc3RSZXNwb25zZUR0bz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmp3dEJsYWNrbGlzdFJlcG9zaXRvcnkuZGVsZXRlKHsganRpIH0pO1xuXG4gICAgICBpZiAocmVzdWx0LmFmZmVjdGVkID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVG9rZW4gbsOjbyBlbmNvbnRyYWRvIG5hIGJsYWNrbGlzdCcpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFRva2VuIHJlbW92aWRvIGRhIGJsYWNrbGlzdDogJHtqdGl9YCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiByZW1vdmlkbyBkYSBibGFja2xpc3QgY29tIHN1Y2Vzc28nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBhZmZlY3RlZF9jb3VudDogcmVzdWx0LmFmZmVjdGVkIHx8IDAsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBhbyByZW1vdmVyIHRva2VuIGRhIGJsYWNrbGlzdDogJHtlcnJvci5tZXNzYWdlfWAsIHtcbiAgICAgICAganRpLFxuICAgICAgICBlcnJvcjogZXJyb3Iuc3RhY2ssXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBpbnRlcm5vIGFvIHJlbW92ZXIgdG9rZW4gZGEgYmxhY2tsaXN0JyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpc3RhIHRva2VucyBuYSBibGFja2xpc3QgY29tIGZpbHRyb3NcbiAgICogQHBhcmFtIHF1ZXJ5RHRvIEZpbHRyb3MgZGUgY29uc3VsdGFcbiAgICogQHJldHVybnMgTGlzdGEgcGFnaW5hZGEgZGUgdG9rZW5zXG4gICAqL1xuICBhc3luYyBsaXN0QmxhY2tsaXN0ZWRUb2tlbnMoXG4gICAgcXVlcnlEdG86IEJsYWNrbGlzdFF1ZXJ5RHRvLFxuICApOiBQcm9taXNlPHtcbiAgICBkYXRhOiBKd3RCbGFja2xpc3RbXTtcbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIHBhZ2U6IG51bWJlcjtcbiAgICBsaW1pdDogbnVtYmVyO1xuICAgIHRvdGFsUGFnZXM6IG51bWJlcjtcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYWdlID0gcXVlcnlEdG8ucGFnZSB8fCAxO1xuICAgICAgY29uc3QgbGltaXQgPSBNYXRoLm1pbihxdWVyeUR0by5saW1pdCB8fCAxMCwgMTAwKTtcbiAgICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICAgIGNvbnN0IHF1ZXJ5QnVpbGRlciA9IHRoaXMuand0QmxhY2tsaXN0UmVwb3NpdG9yeS5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2JsYWNrbGlzdCcpO1xuXG4gICAgICAvLyBBcGxpY2FyIGZpbHRyb3NcbiAgICAgIGlmIChxdWVyeUR0by51c3VhcmlvX2lkKSB7XG4gICAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnYmxhY2tsaXN0LnVzdWFyaW9faWQgPSA6dXN1YXJpb19pZCcsIHtcbiAgICAgICAgICB1c3VhcmlvX2lkOiBxdWVyeUR0by51c3VhcmlvX2lkLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHF1ZXJ5RHRvLnRva2VuX3R5cGUpIHtcbiAgICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKCdibGFja2xpc3QudG9rZW5fdHlwZSA9IDp0b2tlbl90eXBlJywge1xuICAgICAgICAgIHRva2VuX3R5cGU6IHF1ZXJ5RHRvLnRva2VuX3R5cGUsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAocXVlcnlEdG8ucmVhc29uKSB7XG4gICAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnYmxhY2tsaXN0LnJlYXNvbiA9IDpyZWFzb24nLCB7XG4gICAgICAgICAgcmVhc29uOiBxdWVyeUR0by5yZWFzb24sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAocXVlcnlEdG8ub25seV9hY3RpdmUpIHtcbiAgICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKCdibGFja2xpc3QuZXhwaXJlc19hdCA+IDpub3cnLCB7XG4gICAgICAgICAgbm93OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gT3JkZW5hciBwb3IgZGF0YSBkZSBjcmlhw6fDo28gKG1haXMgcmVjZW50ZXMgcHJpbWVpcm8pXG4gICAgICBxdWVyeUJ1aWxkZXIub3JkZXJCeSgnYmxhY2tsaXN0LmNyZWF0ZWRfYXQnLCAnREVTQycpO1xuXG4gICAgICAvLyBBcGxpY2FyIHBhZ2luYcOnw6NvXG4gICAgICBxdWVyeUJ1aWxkZXIuc2tpcChza2lwKS50YWtlKGxpbWl0KTtcblxuICAgICAgY29uc3QgW2RhdGEsIHRvdGFsXSA9IGF3YWl0IHF1ZXJ5QnVpbGRlci5nZXRNYW55QW5kQ291bnQoKTtcbiAgICAgIGNvbnN0IHRvdGFsUGFnZXMgPSBNYXRoLmNlaWwodG90YWwgLyBsaW1pdCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGRhdGEsXG4gICAgICAgIHRvdGFsLFxuICAgICAgICBwYWdlLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgdG90YWxQYWdlcyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIGFvIGxpc3RhciB0b2tlbnMgYmxhY2tsaXN0ZWQ6ICR7ZXJyb3IubWVzc2FnZX1gLCB7XG4gICAgICAgIHF1ZXJ5RHRvLFxuICAgICAgICBlcnJvcjogZXJyb3Iuc3RhY2ssXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdFcnJvIGludGVybm8gYW8gY29uc3VsdGFyIGJsYWNrbGlzdCcsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gZXN0YXTDrXN0aWNhcyBkYSBibGFja2xpc3RcbiAgICogQHJldHVybnMgRXN0YXTDrXN0aWNhcyBkZXRhbGhhZGFzXG4gICAqL1xuICBhc3luYyBnZXRCbGFja2xpc3RTdGF0cygpOiBQcm9taXNlPEJsYWNrbGlzdFN0YXRzRHRvPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGNvbnN0IFt0b3RhbCwgZXhwaXJlZCwgYWN0aXZlLCBhY2Nlc3NUb2tlbnMsIHJlZnJlc2hUb2tlbnMsIHJlYXNvblN0YXRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LmNvdW50KCksXG4gICAgICAgIHRoaXMuand0QmxhY2tsaXN0UmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSB9LFxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyBleHBpcmVzX2F0OiBNb3JlVGhhbihub3cpIH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLmp3dEJsYWNrbGlzdFJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IHRva2VuX3R5cGU6ICdhY2Nlc3MnIH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLmp3dEJsYWNrbGlzdFJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IHRva2VuX3R5cGU6ICdyZWZyZXNoJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5nZXRSZWFzb25TdGF0cygpLFxuICAgICAgXSk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvdGFsLFxuICAgICAgICBhY3RpdmUsXG4gICAgICAgIGV4cGlyZWQsXG4gICAgICAgIGFjY2Vzc190b2tlbnM6IGFjY2Vzc1Rva2VucyxcbiAgICAgICAgcmVmcmVzaF90b2tlbnM6IHJlZnJlc2hUb2tlbnMsXG4gICAgICAgIGJ5X3JlYXNvbjogcmVhc29uU3RhdHMsXG4gICAgICAgIGxhc3RfY2xlYW51cDogdGhpcy5sYXN0Q2xlYW51cC50b0lTT1N0cmluZygpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gb2J0ZXIgZXN0YXTDrXN0aWNhcyBkYSBibGFja2xpc3Q6ICR7ZXJyb3IubWVzc2FnZX1gLCB7XG4gICAgICAgIGVycm9yOiBlcnJvci5zdGFjayxcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJubyBhbyBvYnRlciBlc3RhdMOtc3RpY2FzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpbXBhIHRva2VucyBleHBpcmFkb3MgZGEgYmxhY2tsaXN0XG4gICAqIEByZXR1cm5zIE7Dum1lcm8gZGUgdG9rZW5zIHJlbW92aWRvc1xuICAgKi9cbiAgYXN5bmMgY2xlYW51cEV4cGlyZWRUb2tlbnMoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5LmRlbGV0ZSh7XG4gICAgICAgIGV4cGlyZXNfYXQ6IExlc3NUaGFuKG5ldyBEYXRlKCkpLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGRlbGV0ZWRDb3VudCA9IHJlc3VsdC5hZmZlY3RlZCB8fCAwO1xuICAgICAgdGhpcy5sYXN0Q2xlYW51cCA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgTGltcGV6YSBkYSBibGFja2xpc3Q6ICR7ZGVsZXRlZENvdW50fSB0b2tlbnMgZXhwaXJhZG9zIHJlbW92aWRvc2ApO1xuXG4gICAgICByZXR1cm4gZGVsZXRlZENvdW50O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBuYSBsaW1wZXphIGRhIGJsYWNrbGlzdDogJHtlcnJvci5tZXNzYWdlfWAsIHtcbiAgICAgICAgZXJyb3I6IGVycm9yLnN0YWNrLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBpbnRlcm5vIG5hIGxpbXBlemEgZGEgYmxhY2tsaXN0JyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBlc3RhdMOtc3RpY2FzIHBvciBtb3Rpdm8gZGUgaW52YWxpZGHDp8Ojb1xuICAgKiBAcmV0dXJucyBDb250YWdlbSBwb3IgbW90aXZvXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldFJlYXNvblN0YXRzKCk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgbnVtYmVyPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgdGhpcy5qd3RCbGFja2xpc3RSZXBvc2l0b3J5XG4gICAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2JsYWNrbGlzdCcpXG4gICAgICAgIC5zZWxlY3QoJ2JsYWNrbGlzdC5yZWFzb24nLCAncmVhc29uJylcbiAgICAgICAgLmFkZFNlbGVjdCgnQ09VTlQoKiknLCAnY291bnQnKVxuICAgICAgICAuZ3JvdXBCeSgnYmxhY2tsaXN0LnJlYXNvbicpXG4gICAgICAgIC5nZXRSYXdNYW55KCk7XG5cbiAgICAgIGNvbnN0IHN0YXRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG4gICAgICByZXN1bHRzLmZvckVhY2gocmVzdWx0ID0+IHtcbiAgICAgICAgc3RhdHNbcmVzdWx0LnJlYXNvbl0gPSBwYXJzZUludChyZXN1bHQuY291bnQsIDEwKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gc3RhdHM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIGFvIG9idGVyIGVzdGF0w61zdGljYXMgcG9yIG1vdGl2bzogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbmljaWEgbGltcGV6YSBhdXRvbcOhdGljYSBkZSB0b2tlbnMgZXhwaXJhZG9zXG4gICAqL1xuICBwcml2YXRlIHN0YXJ0VG9rZW5DbGVhbnVwKCk6IHZvaWQge1xuICAgIHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZWRDb3VudCA9IGF3YWl0IHRoaXMuY2xlYW51cEV4cGlyZWRUb2tlbnMoKTtcbiAgICAgICAgaWYgKGRlbGV0ZWRDb3VudCA+IDApIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coYExpbXBlemEgYXV0b23DoXRpY2EgZGEgYmxhY2tsaXN0OiAke2RlbGV0ZWRDb3VudH0gdG9rZW5zIHJlbW92aWRvc2ApO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJybyBuYSBsaW1wZXphIGF1dG9tw6F0aWNhIGRhIGJsYWNrbGlzdDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0sIHRoaXMuQ0xFQU5VUF9JTlRFUlZBTCk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFpIEpUSSBkZSB1bSB0b2tlbiBKV1RcbiAgICogQHBhcmFtIHRva2VuIFRva2VuIEpXVFxuICAgKiBAcmV0dXJucyBKVEkgb3UgbnVsbCBzZSBpbnbDoWxpZG9cbiAgICovXG4gIGV4dHJhY3RKdGlGcm9tVG9rZW4odG9rZW46IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gdGhpcy5qd3RTZXJ2aWNlLmRlY29kZSh0b2tlbikgYXMgYW55O1xuICAgICAgcmV0dXJuIGRlY29kZWQ/Lmp0aSB8fCBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBFcnJvIGFvIGV4dHJhaXIgSlRJIGRvIHRva2VuOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIHNlIHVtIHRva2VuIEpXVCBuw6NvIGVzdMOhIG5hIGJsYWNrbGlzdFxuICAgKiBNw6l0b2RvIHV0aWxpdMOhcmlvIHBhcmEgdXNvIGVtIGd1YXJkc1xuICAgKiBAcGFyYW0gdG9rZW4gVG9rZW4gSldUIGNvbXBsZXRvXG4gICAqIEByZXR1cm5zIHRydWUgc2UgbyB0b2tlbiDDqSB2w6FsaWRvIChuw6NvIGJsYWNrbGlzdGVkKVxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVUb2tlbk5vdEJsYWNrbGlzdGVkKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBqdGkgPSB0aGlzLmV4dHJhY3RKdGlGcm9tVG9rZW4odG9rZW4pO1xuICAgIGlmICghanRpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5pc1Rva2VuQmxhY2tsaXN0ZWQoeyBqdGkgfSk7XG4gICAgcmV0dXJuICFyZXN1bHQuaXNfYmxhY2tsaXN0ZWQ7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=