bf8542b146568382c4627428e125c5bf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DadosFuneralRepository = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("typeorm");
const dados_funeral_entity_1 = require("../../../entities/dados-funeral.entity");
/**
 * Repositório customizado para DadosFuneral
 * Extende o repositório base do TypeORM com métodos específicos
 */
let DadosFuneralRepository = class DadosFuneralRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(dados_funeral_entity_1.DadosFuneral, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Buscar dados de funeral por solicitação com relacionamentos
     */
    async findBySolicitacaoWithRelations(solicitacaoId) {
        return this.findOne({
            where: { solicitacao_id: solicitacaoId },
            relations: [
                'solicitacao',
                'solicitacao.cidadao',
                'solicitacao.tipo_beneficio',
            ],
        });
    }
    /**
     * Buscar dados por período de óbito
     */
    async findByPeriodoObito(dataInicio, dataFim) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.data_obito BETWEEN :dataInicio AND :dataFim', {
            dataInicio,
            dataFim,
        })
            .orderBy('dados.data_obito', 'DESC')
            .getMany();
    }
    /**
     * Buscar dados por grau de parentesco
     */
    async findByGrauParentesco(grauParentesco) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.grau_parentesco_requerente = :grauParentesco', {
            grauParentesco,
        })
            .orderBy('dados.created_at', 'DESC')
            .getMany();
    }
    /**
     * Buscar dados por tipo de urna
     */
    async findByTipoUrna(tipoUrna) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.tipo_urna_necessaria = :tipoUrna', { tipoUrna })
            .orderBy('dados.created_at', 'DESC')
            .getMany();
    }
    /**
     * Buscar dados por local de óbito
     */
    async findByLocalObito(localObito) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('LOWER(dados.local_obito) LIKE LOWER(:localObito)', {
            localObito: `%${localObito}%`,
        })
            .orderBy('dados.created_at', 'DESC')
            .getMany();
    }
    /**
     * Buscar dados por período de autorização
     */
    async findByPeriodoAutorizacao(dataInicio, dataFim) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.data_autorizacao BETWEEN :dataInicio AND :dataFim', {
            dataInicio,
            dataFim,
        })
            .orderBy('dados.data_autorizacao', 'DESC')
            .getMany();
    }
    /**
     * Buscar estatísticas de funeral
     */
    async getEstatisticas() {
        const totalObitos = await this.count();
        // Estatísticas por grau de parentesco
        const porGrauResult = await this.createQueryBuilder('dados')
            .select('dados.grau_parentesco_requerente', 'grau')
            .addSelect('COUNT(*)', 'quantidade')
            .groupBy('dados.grau_parentesco_requerente')
            .getRawMany();
        const porGrauParentesco = porGrauResult.reduce((acc, item) => {
            acc[item.grau] = parseInt(item.quantidade);
            return acc;
        }, {});
        // Estatísticas por tipo de urna
        const porUrnaResult = await this.createQueryBuilder('dados')
            .select('dados.tipo_urna_necessaria', 'urna')
            .addSelect('COUNT(*)', 'quantidade')
            .groupBy('dados.tipo_urna_necessaria')
            .getRawMany();
        const porTipoUrna = porUrnaResult.reduce((acc, item) => {
            acc[item.urna] = parseInt(item.quantidade);
            return acc;
        }, {});
        // Estatísticas por local de óbito (top 10)
        const porLocalResult = await this.createQueryBuilder('dados')
            .select('dados.local_obito', 'local')
            .addSelect('COUNT(*)', 'quantidade')
            .groupBy('dados.local_obito')
            .orderBy('quantidade', 'DESC')
            .limit(10)
            .getRawMany();
        const porLocalObito = porLocalResult.reduce((acc, item) => {
            acc[item.local] = parseInt(item.quantidade);
            return acc;
        }, {});
        // Tempo médio entre óbito e autorização (em dias)
        const tempoMedioResult = await this.createQueryBuilder('dados')
            .select('AVG(EXTRACT(DAY FROM (dados.data_autorizacao - dados.data_obito)))', 'tempoMedio')
            .where('dados.data_autorizacao IS NOT NULL')
            .andWhere('dados.data_obito IS NOT NULL')
            .getRawOne();
        const tempoMedioAutorizacao = parseFloat(tempoMedioResult.tempoMedio) || 0;
        return {
            totalObitos,
            porGrauParentesco,
            porTipoUrna,
            porLocalObito,
            tempoMedioAutorizacao,
        };
    }
    /**
     * Verificar duplicatas por dados do falecido
     */
    async findDuplicatesByFalecido(nomeFalecido, dataObito, excludeId) {
        const query = this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .where('LOWER(dados.nome_completo_falecido) = LOWER(:nomeFalecido)', {
            nomeFalecido,
        })
            .andWhere('dados.data_obito = :dataObito', { dataObito });
        if (excludeId) {
            query.andWhere('dados.id != :excludeId', { excludeId });
        }
        return query.getMany();
    }
    /**
     * Buscar dados de funeral com filtros avançados
     */
    async findWithFilters(filters) {
        const query = this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao');
        if (filters.dataObitoInicio && filters.dataObitoFim) {
            query.andWhere('dados.data_obito BETWEEN :dataObitoInicio AND :dataObitoFim', {
                dataObitoInicio: filters.dataObitoInicio,
                dataObitoFim: filters.dataObitoFim,
            });
        }
        if (filters.dataAutorizacaoInicio && filters.dataAutorizacaoFim) {
            query.andWhere('dados.data_autorizacao BETWEEN :dataAutorizacaoInicio AND :dataAutorizacaoFim', {
                dataAutorizacaoInicio: filters.dataAutorizacaoInicio,
                dataAutorizacaoFim: filters.dataAutorizacaoFim,
            });
        }
        if (filters.grauParentesco) {
            query.andWhere('dados.grau_parentesco_requerente = :grauParentesco', {
                grauParentesco: filters.grauParentesco,
            });
        }
        if (filters.tipoUrna) {
            query.andWhere('dados.tipo_urna_necessaria = :tipoUrna', {
                tipoUrna: filters.tipoUrna,
            });
        }
        if (filters.localObito) {
            query.andWhere('LOWER(dados.local_obito) LIKE LOWER(:localObito)', {
                localObito: `%${filters.localObito}%`,
            });
        }
        if (filters.nomeFalecido) {
            query.andWhere('LOWER(dados.nome_completo_falecido) LIKE LOWER(:nomeFalecido)', {
                nomeFalecido: `%${filters.nomeFalecido}%`,
            });
        }
        const total = await query.getCount();
        if (filters.page && filters.limit) {
            query.skip((filters.page - 1) * filters.limit).take(filters.limit);
        }
        query.orderBy('dados.data_obito', 'DESC');
        const data = await query.getMany();
        return { data, total };
    }
    /**
     * Buscar óbitos por mês para relatórios
     */
    async getObitosPorMes(ano) {
        return this.createQueryBuilder('dados')
            .select('EXTRACT(MONTH FROM dados.data_obito)', 'mes')
            .addSelect('COUNT(*)', 'quantidade')
            .where('EXTRACT(YEAR FROM dados.data_obito) = :ano', { ano })
            .groupBy('EXTRACT(MONTH FROM dados.data_obito)')
            .orderBy('mes', 'ASC')
            .getRawMany()
            .then((results) => results.map((item) => ({
            mes: parseInt(item.mes),
            quantidade: parseInt(item.quantidade),
        })));
    }
};
exports.DadosFuneralRepository = DadosFuneralRepository;
exports.DadosFuneralRepository = DadosFuneralRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], DadosFuneralRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xccmVwb3NpdG9yaWVzXFxkYWRvcy1mdW5lcmFsLnJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxxQ0FBaUQ7QUFDakQsaUZBQXNFO0FBR3RFOzs7R0FHRztBQUVJLElBQU0sc0JBQXNCLEdBQTVCLE1BQU0sc0JBQXVCLFNBQVEsb0JBQXdCO0lBQzlDO0lBQXBCLFlBQW9CLFVBQXNCO1FBQ3hDLEtBQUssQ0FBQyxtQ0FBWSxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7UUFEcEMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtJQUUxQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsOEJBQThCLENBQ2xDLGFBQXFCO1FBRXJCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNsQixLQUFLLEVBQUUsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFO1lBQ3hDLFNBQVMsRUFBRTtnQkFDVCxhQUFhO2dCQUNiLHFCQUFxQjtnQkFDckIsNEJBQTRCO2FBQzdCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGtCQUFrQixDQUN0QixVQUFnQixFQUNoQixPQUFhO1FBRWIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDO2FBQ3BDLGlCQUFpQixDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQzthQUNyRCxpQkFBaUIsQ0FBQyxxQkFBcUIsRUFBRSxTQUFTLENBQUM7YUFDbkQsS0FBSyxDQUFDLG1EQUFtRCxFQUFFO1lBQzFELFVBQVU7WUFDVixPQUFPO1NBQ1IsQ0FBQzthQUNELE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLENBQUM7YUFDbkMsT0FBTyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQ7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XERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xccmVwb3NpdG9yaWVzXFxkYWRvcy1mdW5lcmFsLnJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IERhdGFTb3VyY2UsIFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IERhZG9zRnVuZXJhbCB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL2RhZG9zLWZ1bmVyYWwuZW50aXR5JztcbmltcG9ydCB7IFBhcmVudGVzY29FbnVtLCBUaXBvVXJuYUVudW0gfSBmcm9tICdAL2VudW1zJztcblxuLyoqXG4gKiBSZXBvc2l0w7NyaW8gY3VzdG9taXphZG8gcGFyYSBEYWRvc0Z1bmVyYWxcbiAqIEV4dGVuZGUgbyByZXBvc2l0w7NyaW8gYmFzZSBkbyBUeXBlT1JNIGNvbSBtw6l0b2RvcyBlc3BlY8OtZmljb3NcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhZG9zRnVuZXJhbFJlcG9zaXRvcnkgZXh0ZW5kcyBSZXBvc2l0b3J5PERhZG9zRnVuZXJhbD4ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGFTb3VyY2U6IERhdGFTb3VyY2UpIHtcbiAgICBzdXBlcihEYWRvc0Z1bmVyYWwsIGRhdGFTb3VyY2UuY3JlYXRlRW50aXR5TWFuYWdlcigpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgZGUgZnVuZXJhbCBwb3Igc29saWNpdGHDp8OjbyBjb20gcmVsYWNpb25hbWVudG9zXG4gICAqL1xuICBhc3luYyBmaW5kQnlTb2xpY2l0YWNhb1dpdGhSZWxhdGlvbnMoXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPERhZG9zRnVuZXJhbCB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IHNvbGljaXRhY2FvX2lkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgICByZWxhdGlvbnM6IFtcbiAgICAgICAgJ3NvbGljaXRhY2FvJyxcbiAgICAgICAgJ3NvbGljaXRhY2FvLmNpZGFkYW8nLFxuICAgICAgICAnc29saWNpdGFjYW8udGlwb19iZW5lZmljaW8nLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgcG9yIHBlcsOtb2RvIGRlIMOzYml0b1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5UGVyaW9kb09iaXRvKFxuICAgIGRhdGFJbmljaW86IERhdGUsXG4gICAgZGF0YUZpbTogRGF0ZSxcbiAgKTogUHJvbWlzZTxEYWRvc0Z1bmVyYWxbXT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcignZGFkb3MnKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdkYWRvcy5zb2xpY2l0YWNhbycsICdzb2xpY2l0YWNhbycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ3NvbGljaXRhY2FvLmNpZGFkYW8nLCAnY2lkYWRhbycpXG4gICAgICAud2hlcmUoJ2RhZG9zLmRhdGFfb2JpdG8gQkVUV0VFTiA6ZGF0YUluaWNpbyBBTkQgOmRhdGFGaW0nLCB7XG4gICAgICAgIGRhdGFJbmljaW8sXG4gICAgICAgIGRhdGFGaW0sXG4gICAgICB9KVxuICAgICAgLm9yZGVyQnkoJ2RhZG9zLmRhdGFfb2JpdG8nLCAnREVTQycpXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciBkYWRvcyBwb3IgZ3JhdSBkZSBwYXJlbnRlc2NvXG4gICAqL1xuICBhc3luYyBmaW5kQnlHcmF1UGFyZW50ZXNjbyhcbiAgICBncmF1UGFyZW50ZXNjbzogUGFyZW50ZXNjb0VudW0sXG4gICk6IFByb21pc2U8RGFkb3NGdW5lcmFsW10+IHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnZGFkb3Muc29saWNpdGFjYW8nLCAnc29saWNpdGFjYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby5jaWRhZGFvJywgJ2NpZGFkYW8nKVxuICAgICAgLndoZXJlKCdkYWRvcy5ncmF1X3BhcmVudGVzY29fcmVxdWVyZW50ZSA9IDpncmF1UGFyZW50ZXNjbycsIHtcbiAgICAgICAgZ3JhdVBhcmVudGVzY28sXG4gICAgICB9KVxuICAgICAgLm9yZGVyQnkoJ2RhZG9zLmNyZWF0ZWRfYXQnLCAnREVTQycpXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciBkYWRvcyBwb3IgdGlwbyBkZSB1cm5hXG4gICAqL1xuICBhc3luYyBmaW5kQnlUaXBvVXJuYSh0aXBvVXJuYTogVGlwb1VybmFFbnVtKTogUHJvbWlzZTxEYWRvc0Z1bmVyYWxbXT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcignZGFkb3MnKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdkYWRvcy5zb2xpY2l0YWNhbycsICdzb2xpY2l0YWNhbycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ3NvbGljaXRhY2FvLmNpZGFkYW8nLCAnY2lkYWRhbycpXG4gICAgICAud2hlcmUoJ2RhZG9zLnRpcG9fdXJuYV9uZWNlc3NhcmlhID0gOnRpcG9Vcm5hJywgeyB0aXBvVXJuYSB9KVxuICAgICAgLm9yZGVyQnkoJ2RhZG9zLmNyZWF0ZWRfYXQnLCAnREVTQycpXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciBkYWRvcyBwb3IgbG9jYWwgZGUgw7NiaXRvXG4gICAqL1xuICBhc3luYyBmaW5kQnlMb2NhbE9iaXRvKGxvY2FsT2JpdG86IHN0cmluZyk6IFByb21pc2U8RGFkb3NGdW5lcmFsW10+IHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnZGFkb3Muc29saWNpdGFjYW8nLCAnc29saWNpdGFjYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby5jaWRhZGFvJywgJ2NpZGFkYW8nKVxuICAgICAgLndoZXJlKCdMT1dFUihkYWRvcy5sb2NhbF9vYml0bykgTElLRSBMT1dFUig6bG9jYWxPYml0byknLCB7XG4gICAgICAgIGxvY2FsT2JpdG86IGAlJHtsb2NhbE9iaXRvfSVgLFxuICAgICAgfSlcbiAgICAgIC5vcmRlckJ5KCdkYWRvcy5jcmVhdGVkX2F0JywgJ0RFU0MnKVxuICAgICAgLmdldE1hbnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgcG9yIHBlcsOtb2RvIGRlIGF1dG9yaXphw6fDo29cbiAgICovXG4gIGFzeW5jIGZpbmRCeVBlcmlvZG9BdXRvcml6YWNhbyhcbiAgICBkYXRhSW5pY2lvOiBEYXRlLFxuICAgIGRhdGFGaW06IERhdGUsXG4gICk6IFByb21pc2U8RGFkb3NGdW5lcmFsW10+IHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnZGFkb3Muc29saWNpdGFjYW8nLCAnc29saWNpdGFjYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby5jaWRhZGFvJywgJ2NpZGFkYW8nKVxuICAgICAgLndoZXJlKCdkYWRvcy5kYXRhX2F1dG9yaXphY2FvIEJFVFdFRU4gOmRhdGFJbmljaW8gQU5EIDpkYXRhRmltJywge1xuICAgICAgICBkYXRhSW5pY2lvLFxuICAgICAgICBkYXRhRmltLFxuICAgICAgfSlcbiAgICAgIC5vcmRlckJ5KCdkYWRvcy5kYXRhX2F1dG9yaXphY2FvJywgJ0RFU0MnKVxuICAgICAgLmdldE1hbnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZXN0YXTDrXN0aWNhcyBkZSBmdW5lcmFsXG4gICAqL1xuICBhc3luYyBnZXRFc3RhdGlzdGljYXMoKTogUHJvbWlzZTx7XG4gICAgdG90YWxPYml0b3M6IG51bWJlcjtcbiAgICBwb3JHcmF1UGFyZW50ZXNjbzogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBwb3JUaXBvVXJuYTogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBwb3JMb2NhbE9iaXRvOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICAgIHRlbXBvTWVkaW9BdXRvcml6YWNhbzogbnVtYmVyO1xuICB9PiB7XG4gICAgY29uc3QgdG90YWxPYml0b3MgPSBhd2FpdCB0aGlzLmNvdW50KCk7XG5cbiAgICAvLyBFc3RhdMOtc3RpY2FzIHBvciBncmF1IGRlIHBhcmVudGVzY29cbiAgICBjb25zdCBwb3JHcmF1UmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5zZWxlY3QoJ2RhZG9zLmdyYXVfcGFyZW50ZXNjb19yZXF1ZXJlbnRlJywgJ2dyYXUnKVxuICAgICAgLmFkZFNlbGVjdCgnQ09VTlQoKiknLCAncXVhbnRpZGFkZScpXG4gICAgICAuZ3JvdXBCeSgnZGFkb3MuZ3JhdV9wYXJlbnRlc2NvX3JlcXVlcmVudGUnKVxuICAgICAgLmdldFJhd01hbnkoKTtcblxuICAgIGNvbnN0IHBvckdyYXVQYXJlbnRlc2NvID0gcG9yR3JhdVJlc3VsdC5yZWR1Y2UoKGFjYywgaXRlbSkgPT4ge1xuICAgICAgYWNjW2l0ZW0uZ3JhdV0gPSBwYXJzZUludChpdGVtLnF1YW50aWRhZGUpO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG5cbiAgICAvLyBFc3RhdMOtc3RpY2FzIHBvciB0aXBvIGRlIHVybmFcbiAgICBjb25zdCBwb3JVcm5hUmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5zZWxlY3QoJ2RhZG9zLnRpcG9fdXJuYV9uZWNlc3NhcmlhJywgJ3VybmEnKVxuICAgICAgLmFkZFNlbGVjdCgnQ09VTlQoKiknLCAncXVhbnRpZGFkZScpXG4gICAgICAuZ3JvdXBCeSgnZGFkb3MudGlwb191cm5hX25lY2Vzc2FyaWEnKVxuICAgICAgLmdldFJhd01hbnkoKTtcblxuICAgIGNvbnN0IHBvclRpcG9Vcm5hID0gcG9yVXJuYVJlc3VsdC5yZWR1Y2UoKGFjYywgaXRlbSkgPT4ge1xuICAgICAgYWNjW2l0ZW0udXJuYV0gPSBwYXJzZUludChpdGVtLnF1YW50aWRhZGUpO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG5cbiAgICAvLyBFc3RhdMOtc3RpY2FzIHBvciBsb2NhbCBkZSDDs2JpdG8gKHRvcCAxMClcbiAgICBjb25zdCBwb3JMb2NhbFJlc3VsdCA9IGF3YWl0IHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAuc2VsZWN0KCdkYWRvcy5sb2NhbF9vYml0bycsICdsb2NhbCcpXG4gICAgICAuYWRkU2VsZWN0KCdDT1VOVCgqKScsICdxdWFudGlkYWRlJylcbiAgICAgIC5ncm91cEJ5KCdkYWRvcy5sb2NhbF9vYml0bycpXG4gICAgICAub3JkZXJCeSgncXVhbnRpZGFkZScsICdERVNDJylcbiAgICAgIC5saW1pdCgxMClcbiAgICAgIC5nZXRSYXdNYW55KCk7XG5cbiAgICBjb25zdCBwb3JMb2NhbE9iaXRvID0gcG9yTG9jYWxSZXN1bHQucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICAgIGFjY1tpdGVtLmxvY2FsXSA9IHBhcnNlSW50KGl0ZW0ucXVhbnRpZGFkZSk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcblxuICAgIC8vIFRlbXBvIG3DqWRpbyBlbnRyZSDDs2JpdG8gZSBhdXRvcml6YcOnw6NvIChlbSBkaWFzKVxuICAgIGNvbnN0IHRlbXBvTWVkaW9SZXN1bHQgPSBhd2FpdCB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcignZGFkb3MnKVxuICAgICAgLnNlbGVjdChcbiAgICAgICAgJ0FWRyhFWFRSQUNUKERBWSBGUk9NIChkYWRvcy5kYXRhX2F1dG9yaXphY2FvIC0gZGFkb3MuZGF0YV9vYml0bykpKScsXG4gICAgICAgICd0ZW1wb01lZGlvJyxcbiAgICAgIClcbiAgICAgIC53aGVyZSgnZGFkb3MuZGF0YV9hdXRvcml6YWNhbyBJUyBOT1QgTlVMTCcpXG4gICAgICAuYW5kV2hlcmUoJ2RhZG9zLmRhdGFfb2JpdG8gSVMgTk9UIE5VTEwnKVxuICAgICAgLmdldFJhd09uZSgpO1xuXG4gICAgY29uc3QgdGVtcG9NZWRpb0F1dG9yaXphY2FvID0gcGFyc2VGbG9hdCh0ZW1wb01lZGlvUmVzdWx0LnRlbXBvTWVkaW8pIHx8IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxPYml0b3MsXG4gICAgICBwb3JHcmF1UGFyZW50ZXNjbyxcbiAgICAgIHBvclRpcG9Vcm5hLFxuICAgICAgcG9yTG9jYWxPYml0byxcbiAgICAgIHRlbXBvTWVkaW9BdXRvcml6YWNhbyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhciBkdXBsaWNhdGFzIHBvciBkYWRvcyBkbyBmYWxlY2lkb1xuICAgKi9cbiAgYXN5bmMgZmluZER1cGxpY2F0ZXNCeUZhbGVjaWRvKFxuICAgIG5vbWVGYWxlY2lkbzogc3RyaW5nLFxuICAgIGRhdGFPYml0bzogRGF0ZSxcbiAgICBleGNsdWRlSWQ/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8RGFkb3NGdW5lcmFsW10+IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ2RhZG9zLnNvbGljaXRhY2FvJywgJ3NvbGljaXRhY2FvJylcbiAgICAgIC53aGVyZSgnTE9XRVIoZGFkb3Mubm9tZV9jb21wbGV0b19mYWxlY2lkbykgPSBMT1dFUig6bm9tZUZhbGVjaWRvKScsIHtcbiAgICAgICAgbm9tZUZhbGVjaWRvLFxuICAgICAgfSlcbiAgICAgIC5hbmRXaGVyZSgnZGFkb3MuZGF0YV9vYml0byA9IDpkYXRhT2JpdG8nLCB7IGRhdGFPYml0byB9KTtcblxuICAgIGlmIChleGNsdWRlSWQpIHtcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKCdkYWRvcy5pZCAhPSA6ZXhjbHVkZUlkJywgeyBleGNsdWRlSWQgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHF1ZXJ5LmdldE1hbnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgZGUgZnVuZXJhbCBjb20gZmlsdHJvcyBhdmFuw6dhZG9zXG4gICAqL1xuICBhc3luYyBmaW5kV2l0aEZpbHRlcnMoZmlsdGVyczoge1xuICAgIGRhdGFPYml0b0luaWNpbz86IERhdGU7XG4gICAgZGF0YU9iaXRvRmltPzogRGF0ZTtcbiAgICBkYXRhQXV0b3JpemFjYW9JbmljaW8/OiBEYXRlO1xuICAgIGRhdGFBdXRvcml6YWNhb0ZpbT86IERhdGU7XG4gICAgZ3JhdVBhcmVudGVzY28/OiBQYXJlbnRlc2NvRW51bTtcbiAgICB0aXBvVXJuYT86IFRpcG9Vcm5hRW51bTtcbiAgICBsb2NhbE9iaXRvPzogc3RyaW5nO1xuICAgIG5vbWVGYWxlY2lkbz86IHN0cmluZztcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICB9KTogUHJvbWlzZTx7IGRhdGE6IERhZG9zRnVuZXJhbFtdOyB0b3RhbDogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ2RhZG9zLnNvbGljaXRhY2FvJywgJ3NvbGljaXRhY2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8uY2lkYWRhbycsICdjaWRhZGFvJyk7XG5cbiAgICBpZiAoZmlsdGVycy5kYXRhT2JpdG9JbmljaW8gJiYgZmlsdGVycy5kYXRhT2JpdG9GaW0pIHtcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFxuICAgICAgICAnZGFkb3MuZGF0YV9vYml0byBCRVRXRUVOIDpkYXRhT2JpdG9JbmljaW8gQU5EIDpkYXRhT2JpdG9GaW0nLFxuICAgICAgICB7XG4gICAgICAgICAgZGF0YU9iaXRvSW5pY2lvOiBmaWx0ZXJzLmRhdGFPYml0b0luaWNpbyxcbiAgICAgICAgICBkYXRhT2JpdG9GaW06IGZpbHRlcnMuZGF0YU9iaXRvRmltLFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZmlsdGVycy5kYXRhQXV0b3JpemFjYW9JbmljaW8gJiYgZmlsdGVycy5kYXRhQXV0b3JpemFjYW9GaW0pIHtcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFxuICAgICAgICAnZGFkb3MuZGF0YV9hdXRvcml6YWNhbyBCRVRXRUVOIDpkYXRhQXV0b3JpemFjYW9JbmljaW8gQU5EIDpkYXRhQXV0b3JpemFjYW9GaW0nLFxuICAgICAgICB7XG4gICAgICAgICAgZGF0YUF1dG9yaXphY2FvSW5pY2lvOiBmaWx0ZXJzLmRhdGFBdXRvcml6YWNhb0luaWNpbyxcbiAgICAgICAgICBkYXRhQXV0b3JpemFjYW9GaW06IGZpbHRlcnMuZGF0YUF1dG9yaXphY2FvRmltLFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZmlsdGVycy5ncmF1UGFyZW50ZXNjbykge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ2RhZG9zLmdyYXVfcGFyZW50ZXNjb19yZXF1ZXJlbnRlID0gOmdyYXVQYXJlbnRlc2NvJywge1xuICAgICAgICBncmF1UGFyZW50ZXNjbzogZmlsdGVycy5ncmF1UGFyZW50ZXNjbyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChmaWx0ZXJzLnRpcG9Vcm5hKSB7XG4gICAgICBxdWVyeS5hbmRXaGVyZSgnZGFkb3MudGlwb191cm5hX25lY2Vzc2FyaWEgPSA6dGlwb1VybmEnLCB7XG4gICAgICAgIHRpcG9Vcm5hOiBmaWx0ZXJzLnRpcG9Vcm5hLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGZpbHRlcnMubG9jYWxPYml0bykge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ0xPV0VSKGRhZG9zLmxvY2FsX29iaXRvKSBMSUtFIExPV0VSKDpsb2NhbE9iaXRvKScsIHtcbiAgICAgICAgbG9jYWxPYml0bzogYCUke2ZpbHRlcnMubG9jYWxPYml0b30lYCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChmaWx0ZXJzLm5vbWVGYWxlY2lkbykge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoXG4gICAgICAgICdMT1dFUihkYWRvcy5ub21lX2NvbXBsZXRvX2ZhbGVjaWRvKSBMSUtFIExPV0VSKDpub21lRmFsZWNpZG8pJyxcbiAgICAgICAge1xuICAgICAgICAgIG5vbWVGYWxlY2lkbzogYCUke2ZpbHRlcnMubm9tZUZhbGVjaWRvfSVgLFxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB0b3RhbCA9IGF3YWl0IHF1ZXJ5LmdldENvdW50KCk7XG5cbiAgICBpZiAoZmlsdGVycy5wYWdlICYmIGZpbHRlcnMubGltaXQpIHtcbiAgICAgIHF1ZXJ5LnNraXAoKGZpbHRlcnMucGFnZSAtIDEpICogZmlsdGVycy5saW1pdCkudGFrZShmaWx0ZXJzLmxpbWl0KTtcbiAgICB9XG5cbiAgICBxdWVyeS5vcmRlckJ5KCdkYWRvcy5kYXRhX29iaXRvJywgJ0RFU0MnKTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBxdWVyeS5nZXRNYW55KCk7XG5cbiAgICByZXR1cm4geyBkYXRhLCB0b3RhbCB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciDDs2JpdG9zIHBvciBtw6pzIHBhcmEgcmVsYXTDs3Jpb3NcbiAgICovXG4gIGFzeW5jIGdldE9iaXRvc1Bvck1lcyhcbiAgICBhbm86IG51bWJlcixcbiAgKTogUHJvbWlzZTx7IG1lczogbnVtYmVyOyBxdWFudGlkYWRlOiBudW1iZXIgfVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAuc2VsZWN0KCdFWFRSQUNUKE1PTlRIIEZST00gZGFkb3MuZGF0YV9vYml0byknLCAnbWVzJylcbiAgICAgIC5hZGRTZWxlY3QoJ0NPVU5UKCopJywgJ3F1YW50aWRhZGUnKVxuICAgICAgLndoZXJlKCdFWFRSQUNUKFlFQVIgRlJPTSBkYWRvcy5kYXRhX29iaXRvKSA9IDphbm8nLCB7IGFubyB9KVxuICAgICAgLmdyb3VwQnkoJ0VYVFJBQ1QoTU9OVEggRlJPTSBkYWRvcy5kYXRhX29iaXRvKScpXG4gICAgICAub3JkZXJCeSgnbWVzJywgJ0FTQycpXG4gICAgICAuZ2V0UmF3TWFueSgpXG4gICAgICAudGhlbigocmVzdWx0cykgPT5cbiAgICAgICAgcmVzdWx0cy5tYXAoKGl0ZW0pID0+ICh7XG4gICAgICAgICAgbWVzOiBwYXJzZUludChpdGVtLm1lcyksXG4gICAgICAgICAgcXVhbnRpZGFkZTogcGFyc2VJbnQoaXRlbS5xdWFudGlkYWRlKSxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9