2a36b0b078fb566d76866938314c9668
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var AuditService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const audit_log_entity_1 = require("../../entities/audit-log.entity");
let AuditService = AuditService_1 = class AuditService {
    auditLogRepository;
    logger = new common_1.Logger(AuditService_1.name);
    constructor(auditLogRepository) {
        this.auditLogRepository = auditLogRepository;
    }
    /**
     * Cria um novo log de auditoria
     */
    async createLog(createAuditLogDto) {
        try {
            const auditLog = this.auditLogRepository.create({
                ...createAuditLogDto,
                severity: createAuditLogDto.severity || audit_log_entity_1.AuditSeverity.LOW,
            });
            const savedLog = await this.auditLogRepository.save(auditLog);
            // Log crítico ou de alta severidade deve ser registrado no console
            if (savedLog.isHighRisk()) {
                this.logger.warn(`[AUDIT ${savedLog.severity}] ${savedLog.getFormattedMessage()}`, {
                    id: savedLog.id,
                    action: savedLog.action,
                    resource: `${savedLog.resource_type}:${savedLog.resource_id}`,
                    user: savedLog.usuario_id,
                    ip: savedLog.client_ip,
                    metadata: savedLog.metadata,
                });
            }
            return savedLog;
        }
        catch (error) {
            this.logger.error('Erro ao criar log de auditoria', error.stack);
            throw error;
        }
    }
    /**
     * Busca logs de auditoria com filtros e paginação
     */
    async findLogs(queryDto) {
        const { usuario_id, action, resource_type, resource_id, severity, client_ip, start_date, end_date, page = 1, limit = 20, sort_by = 'created_at', sort_order = 'DESC', security_events_only, critical_only, } = queryDto;
        const where = {};
        // Aplicar filtros
        if (usuario_id) {
            where.usuario_id = usuario_id;
        }
        if (action) {
            where.action = action;
        }
        if (resource_type) {
            where.resource_type = resource_type;
        }
        if (resource_id) {
            where.resource_id = resource_id;
        }
        if (severity) {
            where.severity = severity;
        }
        if (client_ip) {
            where.client_ip = client_ip;
        }
        // Filtro de data
        if (start_date || end_date) {
            const startDate = start_date
                ? new Date(start_date)
                : new Date('1970-01-01');
            const endDate = end_date ? new Date(end_date) : new Date();
            where.created_at = (0, typeorm_2.Between)(startDate, endDate);
        }
        // Filtros especiais
        if (security_events_only) {
            where.action = (0, typeorm_2.In)([
                audit_log_entity_1.AuditAction.LOGIN,
                audit_log_entity_1.AuditAction.LOGOUT,
                audit_log_entity_1.AuditAction.LOGIN_FAILED,
                audit_log_entity_1.AuditAction.PASSWORD_RESET,
                audit_log_entity_1.AuditAction.PASSWORD_CHANGE,
                audit_log_entity_1.AuditAction.PERMISSION_DENIED,
                audit_log_entity_1.AuditAction.TOKEN_REFRESH,
                audit_log_entity_1.AuditAction.TOKEN_REVOKE,
            ]);
        }
        if (critical_only) {
            where.severity = (0, typeorm_2.In)([audit_log_entity_1.AuditSeverity.HIGH, audit_log_entity_1.AuditSeverity.CRITICAL]);
        }
        const [logs, total] = await this.auditLogRepository.findAndCount({
            where,
            relations: ['usuario'],
            order: { [sort_by]: sort_order },
            skip: (page - 1) * limit,
            take: limit,
        });
        const data = logs.map((log) => this.mapToResponseDto(log));
        return {
            data,
            total,
            page,
            limit,
            totalPages: Math.ceil(total / limit),
        };
    }
    /**
     * Busca um log específico por ID
     */
    async findLogById(id) {
        const log = await this.auditLogRepository.findOne({
            where: { id },
            relations: ['usuario'],
        });
        return log ? this.mapToResponseDto(log) : null;
    }
    /**
     * Gera estatísticas de auditoria
     */
    async getStats(startDate, endDate) {
        const start = startDate || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000); // 30 dias atrás
        const end = endDate || new Date();
        const where = {
            created_at: (0, typeorm_2.Between)(start, end),
        };
        // Total de logs
        const totalLogs = await this.auditLogRepository.count({ where });
        // Logs por ação
        const logsByAction = await this.auditLogRepository
            .createQueryBuilder('log')
            .select('log.action', 'action')
            .addSelect('COUNT(*)', 'count')
            .where('log.created_at BETWEEN :start AND :end', { start, end })
            .groupBy('log.action')
            .getRawMany();
        // Logs por severidade
        const logsBySeverity = await this.auditLogRepository
            .createQueryBuilder('log')
            .select('log.severity', 'severity')
            .addSelect('COUNT(*)', 'count')
            .where('log.created_at BETWEEN :start AND :end', { start, end })
            .groupBy('log.severity')
            .getRawMany();
        // Top usuários
        const topUsers = await this.auditLogRepository
            .createQueryBuilder('log')
            .leftJoin('log.usuario', 'usuario')
            .select('log.usuario_id', 'usuario_id')
            .addSelect('usuario.nome', 'nome')
            .addSelect('COUNT(*)', 'count')
            .where('log.created_at BETWEEN :start AND :end', { start, end })
            .andWhere('log.usuario_id IS NOT NULL')
            .groupBy('log.usuario_id, usuario.nome')
            .orderBy('COUNT(*)', 'DESC')
            .limit(10)
            .getRawMany();
        // Eventos de segurança recentes (últimas 24h)
        const recentSecurityEvents = await this.auditLogRepository.count({
            where: {
                created_at: (0, typeorm_2.Between)(new Date(Date.now() - 24 * 60 * 60 * 1000), new Date()),
                action: (0, typeorm_2.In)([
                    audit_log_entity_1.AuditAction.LOGIN,
                    audit_log_entity_1.AuditAction.LOGOUT,
                    audit_log_entity_1.AuditAction.LOGIN_FAILED,
                    audit_log_entity_1.AuditAction.PASSWORD_RESET,
                    audit_log_entity_1.AuditAction.PASSWORD_CHANGE,
                    audit_log_entity_1.AuditAction.PERMISSION_DENIED,
                    audit_log_entity_1.AuditAction.TOKEN_REFRESH,
                    audit_log_entity_1.AuditAction.TOKEN_REVOKE,
                ]),
            },
        });
        // Eventos críticos recentes (últimas 24h)
        const recentCriticalEvents = await this.auditLogRepository.count({
            where: {
                created_at: (0, typeorm_2.Between)(new Date(Date.now() - 24 * 60 * 60 * 1000), new Date()),
                severity: (0, typeorm_2.In)([audit_log_entity_1.AuditSeverity.HIGH, audit_log_entity_1.AuditSeverity.CRITICAL]),
            },
        });
        return {
            total_logs: totalLogs,
            logs_by_action: logsByAction.reduce((acc, item) => ({ ...acc, [item.action]: parseInt(item.count) }), {}),
            logs_by_severity: logsBySeverity.reduce((acc, item) => ({ ...acc, [item.severity]: parseInt(item.count) }), {}),
            top_users: topUsers.map((user) => ({
                usuario_id: user.usuario_id,
                nome: user.nome || 'Usuário Desconhecido',
                count: parseInt(user.count),
            })),
            recent_security_events: recentSecurityEvents,
            recent_critical_events: recentCriticalEvents,
            period: {
                start_date: start.toISOString(),
                end_date: end.toISOString(),
            },
        };
    }
    /**
     * Remove logs antigos (executado automaticamente)
     * TEMPORARIAMENTE DESABILITADO - pode estar causando travamento na inicialização
     */
    // @Cron(CronExpression.EVERY_DAY_AT_2AM)
    async cleanupOldLogs() {
        try {
            // Remove logs com mais de 1 ano (exceto críticos)
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const result = await this.auditLogRepository
                .createQueryBuilder()
                .delete()
                .where('created_at < :date', { date: oneYearAgo })
                .andWhere('severity NOT IN (:...severities)', {
                severities: [audit_log_entity_1.AuditSeverity.HIGH, audit_log_entity_1.AuditSeverity.CRITICAL],
            })
                .execute();
            this.logger.log(`Limpeza automática: ${result.affected} logs antigos removidos`);
            // Remove logs críticos com mais de 2 anos
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            const criticalResult = await this.auditLogRepository
                .createQueryBuilder()
                .delete()
                .where('created_at < :date', { date: twoYearsAgo })
                .andWhere('severity IN (:...severities)', {
                severities: [audit_log_entity_1.AuditSeverity.HIGH, audit_log_entity_1.AuditSeverity.CRITICAL],
            })
                .execute();
            this.logger.log(`Limpeza automática: ${criticalResult.affected} logs críticos antigos removidos`);
        }
        catch (error) {
            this.logger.error('Erro na limpeza automática de logs', error.stack);
        }
    }
    /**
     * Métodos de conveniência para logging específico
     */
    async logUserAction(usuarioId, action, resourceType, resourceId, description, metadata, request) {
        await this.createLog({
            usuario_id: usuarioId,
            action,
            resource_type: resourceType,
            resource_id: resourceId,
            description,
            severity: this.getSeverityForAction(action),
            client_ip: request?.ip,
            user_agent: request?.userAgent,
            request_method: request?.method,
            request_url: request?.url,
            metadata,
        });
    }
    async logSecurityEvent(action, description, usuarioId, severity = audit_log_entity_1.AuditSeverity.HIGH, metadata, request) {
        await this.createLog({
            usuario_id: usuarioId,
            action,
            resource_type: 'Security',
            description,
            severity,
            client_ip: request?.ip,
            user_agent: request?.userAgent,
            metadata,
        });
    }
    async logSystemEvent(action, description, metadata) {
        await this.createLog({
            action,
            resource_type: 'System',
            description,
            severity: audit_log_entity_1.AuditSeverity.LOW,
            metadata,
        });
    }
    /**
     * Métodos privados
     */
    mapToResponseDto(log) {
        return {
            id: log.id,
            usuario_id: log.usuario_id,
            usuario: log.usuario
                ? {
                    id: log.usuario.id,
                    nome: log.usuario.nome,
                    email: log.usuario.email,
                }
                : undefined,
            action: log.action,
            resource_type: log.resource_type,
            resource_id: log.resource_id,
            description: log.description,
            severity: log.severity,
            client_ip: log.client_ip,
            user_agent: log.user_agent,
            created_at: log.created_at,
            metadata: log.metadata,
        };
    }
    getSeverityForAction(action) {
        const severityMap = {
            [audit_log_entity_1.AuditAction.CREATE]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.READ]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.UPDATE]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.DELETE]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.LOGIN]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.LOGOUT]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.LOGIN_FAILED]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.PASSWORD_RESET]: audit_log_entity_1.AuditSeverity.HIGH,
            [audit_log_entity_1.AuditAction.PASSWORD_CHANGE]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.PERMISSION_DENIED]: audit_log_entity_1.AuditSeverity.HIGH,
            [audit_log_entity_1.AuditAction.TOKEN_REFRESH]: audit_log_entity_1.AuditSeverity.LOW,
            [audit_log_entity_1.AuditAction.TOKEN_REVOKE]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.EXPORT_DATA]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.IMPORT_DATA]: audit_log_entity_1.AuditSeverity.MEDIUM,
            [audit_log_entity_1.AuditAction.SYSTEM_CONFIG]: audit_log_entity_1.AuditSeverity.HIGH,
        };
        return severityMap[action] || audit_log_entity_1.AuditSeverity.LOW;
    }
};
exports.AuditService = AuditService;
exports.AuditService = AuditService = AuditService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(audit_log_entity_1.AuditLog)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object])
], AuditService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1ZGl0XFxzZXJ2aWNlc1xcYXVkaXQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFvRDtBQUNwRCw2Q0FBbUQ7QUFDbkQscUNBQW9FO0FBRXBFLHNFQUl5QztBQVNsQyxJQUFNLFlBQVksb0JBQWxCLE1BQU0sWUFBWTtJQUtKO0lBSkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGNBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV4RCxZQUVtQixrQkFBd0M7UUFBeEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFzQjtJQUN4RCxDQUFDO0lBRUo7O09BRUc7SUFDSCxLQUFLLENBQUMsU0FBUyxDQUFDLGlCQUFvQztRQUNsRCxJQUFJLENBQUM7WUFDSCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDO2dCQUM5QyxHQUFHLGlCQUFpQjtnQkFDcEIsUUFBUSxFQUFFLGlCQUFpQixDQUFDLFFBQVEsSUFBSSxnQ0FBYSxDQUFDLEdBQUc7YUFDMUQsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTlELG1FQUFtRTtZQUNuRSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDO2dCQUMxQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZCxVQUFVLFFBQVEsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLG1CQUFtQixFQUFFLEVBQUUsRUFDaEU7b0JBQ0UsRUFBRSxFQUFFLFFBQVEsQ0FBQyxFQUFFO29CQUNmLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTTtvQkFDdkIsUUFBUSxFQUFFLEdBQUcsUUFBUSxDQUFDLGFBQWEsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFO29C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V0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLGdDQUFhLENBQUMsR0FBRyxDQUFDO0lBQ2xELENBQUM7Q0FDRixDQUFBO0FBM1pZLG9DQUFZO3VCQUFaLFlBQVk7SUFEeEIsSUFBQSxtQkFBVSxHQUFFO0lBS1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLDJCQUFRLENBQUMsQ0FBQTt5REFDVSxvQkFBVSxvQkFBVixvQkFBVTtHQUx0QyxZQUFZLENBMlp4QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcYXVkaXRcXHNlcnZpY2VzXFxhdWRpdC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSwgQmV0d2VlbiwgSW4sIEZpbmRPcHRpb25zV2hlcmUgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IENyb24sIENyb25FeHByZXNzaW9uIH0gZnJvbSAnQG5lc3Rqcy9zY2hlZHVsZSc7XG5pbXBvcnQge1xuICBBdWRpdExvZyxcbiAgQXVkaXRBY3Rpb24sXG4gIEF1ZGl0U2V2ZXJpdHksXG59IGZyb20gJy4uLy4uL2VudGl0aWVzL2F1ZGl0LWxvZy5lbnRpdHknO1xuaW1wb3J0IHtcbiAgQ3JlYXRlQXVkaXRMb2dEdG8sXG4gIEF1ZGl0TG9nUXVlcnlEdG8sXG4gIEF1ZGl0TG9nUmVzcG9uc2VEdG8sXG4gIEF1ZGl0TG9nU3RhdHNEdG8sXG59IGZyb20gJy4uL2R0by9hdWRpdC1sb2cuZHRvJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1ZGl0U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihBdWRpdFNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdFJlcG9zaXRvcnkoQXVkaXRMb2cpXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdWRpdExvZ1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8QXVkaXRMb2c+LFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyaWEgdW0gbm92byBsb2cgZGUgYXVkaXRvcmlhXG4gICAqL1xuICBhc3luYyBjcmVhdGVMb2coY3JlYXRlQXVkaXRMb2dEdG86IENyZWF0ZUF1ZGl0TG9nRHRvKTogUHJvbWlzZTxBdWRpdExvZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdWRpdExvZyA9IHRoaXMuYXVkaXRMb2dSZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAgIC4uLmNyZWF0ZUF1ZGl0TG9nRHRvLFxuICAgICAgICBzZXZlcml0eTogY3JlYXRlQXVkaXRMb2dEdG8uc2V2ZXJpdHkgfHwgQXVkaXRTZXZlcml0eS5MT1csXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2F2ZWRMb2cgPSBhd2FpdCB0aGlzLmF1ZGl0TG9nUmVwb3NpdG9yeS5zYXZlKGF1ZGl0TG9nKTtcblxuICAgICAgLy8gTG9nIGNyw610aWNvIG91IGRlIGFsdGEgc2V2ZXJpZGFkZSBkZXZlIHNlciByZWdpc3RyYWRvIG5vIGNvbnNvbGVcbiAgICAgIGlmIChzYXZlZExvZy5pc0hpZ2hSaXNrKCkpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICBgW0FVRElUICR7c2F2ZWRMb2cuc2V2ZXJpdHl9XSAke3NhdmVkTG9nLmdldEZvcm1hdHRlZE1lc3NhZ2UoKX1gLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiBzYXZlZExvZy5pZCxcbiAgICAgICAgICAgIGFjdGlvbjogc2F2ZWRMb2cuYWN0aW9uLFxuICAgICAgICAgICAgcmVzb3VyY2U6IGAke3NhdmVkTG9nLnJlc291cmNlX3R5cGV9OiR7c2F2ZWRMb2cucmVzb3VyY2VfaWR9YCxcbiAgICAgICAgICAgIHVzZXI6IHNhdmVkTG9nLnVzdWFyaW9faWQsXG4gICAgICAgICAgICBpcDogc2F2ZWRMb2cuY2xpZW50X2lwLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHNhdmVkTG9nLm1ldGFkYXRhLFxuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzYXZlZExvZztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm8gYW8gY3JpYXIgbG9nIGRlIGF1ZGl0b3JpYScsIGVycm9yLnN0YWNrKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBsb2dzIGRlIGF1ZGl0b3JpYSBjb20gZmlsdHJvcyBlIHBhZ2luYcOnw6NvXG4gICAqL1xuICBhc3luYyBmaW5kTG9ncyhxdWVyeUR0bzogQXVkaXRMb2dRdWVyeUR0byk6IFByb21pc2U8e1xuICAgIGRhdGE6IEF1ZGl0TG9nUmVzcG9uc2VEdG9bXTtcbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIHBhZ2U6IG51bWJlcjtcbiAgICBsaW1pdDogbnVtYmVyO1xuICAgIHRvdGFsUGFnZXM6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHVzdWFyaW9faWQsXG4gICAgICBhY3Rpb24sXG4gICAgICByZXNvdXJjZV90eXBlLFxuICAgICAgcmVzb3VyY2VfaWQsXG4gICAgICBzZXZlcml0eSxcbiAgICAgIGNsaWVudF9pcCxcbiAgICAgIHN0YXJ0X2RhdGUsXG4gICAgICBlbmRfZGF0ZSxcbiAgICAgIHBhZ2UgPSAxLFxuICAgICAgbGltaXQgPSAyMCxcbiAgICAgIHNvcnRfYnkgPSAnY3JlYXRlZF9hdCcsXG4gICAgICBzb3J0X29yZGVyID0gJ0RFU0MnLFxuICAgICAgc2VjdXJpdHlfZXZlbnRzX29ubHksXG4gICAgICBjcml0aWNhbF9vbmx5LFxuICAgIH0gPSBxdWVyeUR0bztcblxuICAgIGNvbnN0IHdoZXJlOiBGaW5kT3B0aW9uc1doZXJlPEF1ZGl0TG9nPiA9IHt9O1xuXG4gICAgLy8gQXBsaWNhciBmaWx0cm9zXG4gICAgaWYgKHVzdWFyaW9faWQpIHtcbiAgICAgIHdoZXJlLnVzdWFyaW9faWQgPSB1c3VhcmlvX2lkO1xuICAgIH1cbiAgICBpZiAoYWN0aW9uKSB7XG4gICAgICB3aGVyZS5hY3Rpb24gPSBhY3Rpb247XG4gICAgfVxuICAgIGlmIChyZXNvdXJjZV90eXBlKSB7XG4gICAgICB3aGVyZS5yZXNvdXJjZV90eXBlID0gcmVzb3VyY2VfdHlwZTtcbiAgICB9XG4gICAgaWYgKHJlc291cmNlX2lkKSB7XG4gICAgICB3aGVyZS5yZXNvdXJjZV9pZCA9IHJlc291cmNlX2lkO1xuICAgIH1cbiAgICBpZiAoc2V2ZXJpdHkpIHtcbiAgICAgIHdoZXJlLnNldmVyaXR5ID0gc2V2ZXJpdHk7XG4gICAgfVxuICAgIGlmIChjbGllbnRfaXApIHtcbiAgICAgIHdoZXJlLmNsaWVudF9pcCA9IGNsaWVudF9pcDtcbiAgICB9XG5cbiAgICAvLyBGaWx0cm8gZGUgZGF0YVxuICAgIGlmIChzdGFydF9kYXRlIHx8IGVuZF9kYXRlKSB7XG4gICAgICBjb25zdCBzdGFydERhdGUgPSBzdGFydF9kYXRlXG4gICAgICAgID8gbmV3IERhdGUoc3RhcnRfZGF0ZSlcbiAgICAgICAgOiBuZXcgRGF0ZSgnMTk3MC0wMS0wMScpO1xuICAgICAgY29uc3QgZW5kRGF0ZSA9IGVuZF9kYXRlID8gbmV3IERhdGUoZW5kX2RhdGUpIDogbmV3IERhdGUoKTtcbiAgICAgIHdoZXJlLmNyZWF0ZWRfYXQgPSBCZXR3ZWVuKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG4gICAgfVxuXG4gICAgLy8gRmlsdHJvcyBlc3BlY2lhaXNcbiAgICBpZiAoc2VjdXJpdHlfZXZlbnRzX29ubHkpIHtcbiAgICAgIHdoZXJlLmFjdGlvbiA9IEluKFtcbiAgICAgICAgQXVkaXRBY3Rpb24uTE9HSU4sXG4gICAgICAgIEF1ZGl0QWN0aW9uLkxPR09VVCxcbiAgICAgICAgQXVkaXRBY3Rpb24uTE9HSU5fRkFJTEVELFxuICAgICAgICBBdWRpdEFjdGlvbi5QQVNTV09SRF9SRVNFVCxcbiAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfQ0hBTkdFLFxuICAgICAgICBBdWRpdEFjdGlvbi5QRVJNSVNTSU9OX0RFTklFRCxcbiAgICAgICAgQXVkaXRBY3Rpb24uVE9LRU5fUkVGUkVTSCxcbiAgICAgICAgQXVkaXRBY3Rpb24uVE9LRU5fUkVWT0tFLFxuICAgICAgXSk7XG4gICAgfVxuXG4gICAgaWYgKGNyaXRpY2FsX29ubHkpIHtcbiAgICAgIHdoZXJlLnNldmVyaXR5ID0gSW4oW0F1ZGl0U2V2ZXJpdHkuSElHSCwgQXVkaXRTZXZlcml0eS5DUklUSUNBTF0pO1xuICAgIH1cblxuICAgIGNvbnN0IFtsb2dzLCB0b3RhbF0gPSBhd2FpdCB0aGlzLmF1ZGl0TG9nUmVwb3NpdG9yeS5maW5kQW5kQ291bnQoe1xuICAgICAgd2hlcmUsXG4gICAgICByZWxhdGlvbnM6IFsndXN1YXJpbyddLFxuICAgICAgb3JkZXI6IHsgW3NvcnRfYnldOiBzb3J0X29yZGVyIH0sXG4gICAgICBza2lwOiAocGFnZSAtIDEpICogbGltaXQsXG4gICAgICB0YWtlOiBsaW1pdCxcbiAgICB9KTtcblxuICAgIGNvbnN0IGRhdGEgPSBsb2dzLm1hcCgobG9nKSA9PiB0aGlzLm1hcFRvUmVzcG9uc2VEdG8obG9nKSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGF0YSxcbiAgICAgIHRvdGFsLFxuICAgICAgcGFnZSxcbiAgICAgIGxpbWl0LFxuICAgICAgdG90YWxQYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gbGltaXQpLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdW0gbG9nIGVzcGVjw61maWNvIHBvciBJRFxuICAgKi9cbiAgYXN5bmMgZmluZExvZ0J5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8QXVkaXRMb2dSZXNwb25zZUR0byB8IG51bGw+IHtcbiAgICBjb25zdCBsb2cgPSBhd2FpdCB0aGlzLmF1ZGl0TG9nUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICByZWxhdGlvbnM6IFsndXN1YXJpbyddLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGxvZyA/IHRoaXMubWFwVG9SZXNwb25zZUR0byhsb2cpIDogbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXJhIGVzdGF0w61zdGljYXMgZGUgYXVkaXRvcmlhXG4gICAqL1xuICBhc3luYyBnZXRTdGF0cyhzdGFydERhdGU/OiBEYXRlLCBlbmREYXRlPzogRGF0ZSk6IFByb21pc2U8QXVkaXRMb2dTdGF0c0R0bz4ge1xuICAgIGNvbnN0IHN0YXJ0ID0gc3RhcnREYXRlIHx8IG5ldyBEYXRlKERhdGUubm93KCkgLSAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyAzMCBkaWFzIGF0csOhc1xuICAgIGNvbnN0IGVuZCA9IGVuZERhdGUgfHwgbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IHdoZXJlOiBGaW5kT3B0aW9uc1doZXJlPEF1ZGl0TG9nPiA9IHtcbiAgICAgIGNyZWF0ZWRfYXQ6IEJldHdlZW4oc3RhcnQsIGVuZCksXG4gICAgfTtcblxuICAgIC8vIFRvdGFsIGRlIGxvZ3NcbiAgICBjb25zdCB0b3RhbExvZ3MgPSBhd2FpdCB0aGlzLmF1ZGl0TG9nUmVwb3NpdG9yeS5jb3VudCh7IHdoZXJlIH0pO1xuXG4gICAgLy8gTG9ncyBwb3IgYcOnw6NvXG4gICAgY29uc3QgbG9nc0J5QWN0aW9uID0gYXdhaXQgdGhpcy5hdWRpdExvZ1JlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2xvZycpXG4gICAgICAuc2VsZWN0KCdsb2cuYWN0aW9uJywgJ2FjdGlvbicpXG4gICAgICAuYWRkU2VsZWN0KCdDT1VOVCgqKScsICdjb3VudCcpXG4gICAgICAud2hlcmUoJ2xvZy5jcmVhdGVkX2F0IEJFVFdFRU4gOnN0YXJ0IEFORCA6ZW5kJywgeyBzdGFydCwgZW5kIH0pXG4gICAgICAuZ3JvdXBCeSgnbG9nLmFjdGlvbicpXG4gICAgICAuZ2V0UmF3TWFueSgpO1xuXG4gICAgLy8gTG9ncyBwb3Igc2V2ZXJpZGFkZVxuICAgIGNvbnN0IGxvZ3NCeVNldmVyaXR5ID0gYXdhaXQgdGhpcy5hdWRpdExvZ1JlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2xvZycpXG4gICAgICAuc2VsZWN0KCdsb2cuc2V2ZXJpdHknLCAnc2V2ZXJpdHknKVxuICAgICAgLmFkZFNlbGVjdCgnQ09VTlQoKiknLCAnY291bnQnKVxuICAgICAgLndoZXJlKCdsb2cuY3JlYXRlZF9hdCBCRVRXRUVOIDpzdGFydCBBTkQgOmVuZCcsIHsgc3RhcnQsIGVuZCB9KVxuICAgICAgLmdyb3VwQnkoJ2xvZy5zZXZlcml0eScpXG4gICAgICAuZ2V0UmF3TWFueSgpO1xuXG4gICAgLy8gVG9wIHVzdcOhcmlvc1xuICAgIGNvbnN0IHRvcFVzZXJzID0gYXdhaXQgdGhpcy5hdWRpdExvZ1JlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2xvZycpXG4gICAgICAubGVmdEpvaW4oJ2xvZy51c3VhcmlvJywgJ3VzdWFyaW8nKVxuICAgICAgLnNlbGVjdCgnbG9nLnVzdWFyaW9faWQnLCAndXN1YXJpb19pZCcpXG4gICAgICAuYWRkU2VsZWN0KCd1c3VhcmlvLm5vbWUnLCAnbm9tZScpXG4gICAgICAuYWRkU2VsZWN0KCdDT1VOVCgqKScsICdjb3VudCcpXG4gICAgICAud2hlcmUoJ2xvZy5jcmVhdGVkX2F0IEJFVFdFRU4gOnN0YXJ0IEFORCA6ZW5kJywgeyBzdGFydCwgZW5kIH0pXG4gICAgICAuYW5kV2hlcmUoJ2xvZy51c3VhcmlvX2lkIElTIE5PVCBOVUxMJylcbiAgICAgIC5ncm91cEJ5KCdsb2cudXN1YXJpb19pZCwgdXN1YXJpby5ub21lJylcbiAgICAgIC5vcmRlckJ5KCdDT1VOVCgqKScsICdERVNDJylcbiAgICAgIC5saW1pdCgxMClcbiAgICAgIC5nZXRSYXdNYW55KCk7XG5cbiAgICAvLyBFdmVudG9zIGRlIHNlZ3VyYW7Dp2EgcmVjZW50ZXMgKMO6bHRpbWFzIDI0aClcbiAgICBjb25zdCByZWNlbnRTZWN1cml0eUV2ZW50cyA9IGF3YWl0IHRoaXMuYXVkaXRMb2dSZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGNyZWF0ZWRfYXQ6IEJldHdlZW4oXG4gICAgICAgICAgbmV3IERhdGUoRGF0ZS5ub3coKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApLFxuICAgICAgICAgIG5ldyBEYXRlKCksXG4gICAgICAgICksXG4gICAgICAgIGFjdGlvbjogSW4oW1xuICAgICAgICAgIEF1ZGl0QWN0aW9uLkxPR0lOLFxuICAgICAgICAgIEF1ZGl0QWN0aW9uLkxPR09VVCxcbiAgICAgICAgICBBdWRpdEFjdGlvbi5MT0dJTl9GQUlMRUQsXG4gICAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVQsXG4gICAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfQ0hBTkdFLFxuICAgICAgICAgIEF1ZGl0QWN0aW9uLlBFUk1JU1NJT05fREVOSUVELFxuICAgICAgICAgIEF1ZGl0QWN0aW9uLlRPS0VOX1JFRlJFU0gsXG4gICAgICAgICAgQXVkaXRBY3Rpb24uVE9LRU5fUkVWT0tFLFxuICAgICAgICBdKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBFdmVudG9zIGNyw610aWNvcyByZWNlbnRlcyAow7psdGltYXMgMjRoKVxuICAgIGNvbnN0IHJlY2VudENyaXRpY2FsRXZlbnRzID0gYXdhaXQgdGhpcy5hdWRpdExvZ1JlcG9zaXRvcnkuY291bnQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY3JlYXRlZF9hdDogQmV0d2VlbihcbiAgICAgICAgICBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMjQgKiA2MCAqIDYwICogMTAwMCksXG4gICAgICAgICAgbmV3IERhdGUoKSxcbiAgICAgICAgKSxcbiAgICAgICAgc2V2ZXJpdHk6IEluKFtBdWRpdFNldmVyaXR5LkhJR0gsIEF1ZGl0U2V2ZXJpdHkuQ1JJVElDQUxdKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxfbG9nczogdG90YWxMb2dzLFxuICAgICAgbG9nc19ieV9hY3Rpb246IGxvZ3NCeUFjdGlvbi5yZWR1Y2UoXG4gICAgICAgIChhY2MsIGl0ZW0pID0+ICh7IC4uLmFjYywgW2l0ZW0uYWN0aW9uXTogcGFyc2VJbnQoaXRlbS5jb3VudCkgfSksXG4gICAgICAgIHt9LFxuICAgICAgKSxcbiAgICAgIGxvZ3NfYnlfc2V2ZXJpdHk6IGxvZ3NCeVNldmVyaXR5LnJlZHVjZShcbiAgICAgICAgKGFjYywgaXRlbSkgPT4gKHsgLi4uYWNjLCBbaXRlbS5zZXZlcml0eV06IHBhcnNlSW50KGl0ZW0uY291bnQpIH0pLFxuICAgICAgICB7fSxcbiAgICAgICksXG4gICAgICB0b3BfdXNlcnM6IHRvcFVzZXJzLm1hcCgodXNlcikgPT4gKHtcbiAgICAgICAgdXN1YXJpb19pZDogdXNlci51c3VhcmlvX2lkLFxuICAgICAgICBub21lOiB1c2VyLm5vbWUgfHwgJ1VzdcOhcmlvIERlc2NvbmhlY2lkbycsXG4gICAgICAgIGNvdW50OiBwYXJzZUludCh1c2VyLmNvdW50KSxcbiAgICAgIH0pKSxcbiAgICAgIHJlY2VudF9zZWN1cml0eV9ldmVudHM6IHJlY2VudFNlY3VyaXR5RXZlbnRzLFxuICAgICAgcmVjZW50X2NyaXRpY2FsX2V2ZW50czogcmVjZW50Q3JpdGljYWxFdmVudHMsXG4gICAgICBwZXJpb2Q6IHtcbiAgICAgICAgc3RhcnRfZGF0ZTogc3RhcnQudG9JU09TdHJpbmcoKSxcbiAgICAgICAgZW5kX2RhdGU6IGVuZC50b0lTT1N0cmluZygpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBsb2dzIGFudGlnb3MgKGV4ZWN1dGFkbyBhdXRvbWF0aWNhbWVudGUpXG4gICAqIFRFTVBPUkFSSUFNRU5URSBERVNBQklMSVRBRE8gLSBwb2RlIGVzdGFyIGNhdXNhbmRvIHRyYXZhbWVudG8gbmEgaW5pY2lhbGl6YcOnw6NvXG4gICAqL1xuICAvLyBAQ3JvbihDcm9uRXhwcmVzc2lvbi5FVkVSWV9EQVlfQVRfMkFNKVxuICBhc3luYyBjbGVhbnVwT2xkTG9ncygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gUmVtb3ZlIGxvZ3MgY29tIG1haXMgZGUgMSBhbm8gKGV4Y2V0byBjcsOtdGljb3MpXG4gICAgICBjb25zdCBvbmVZZWFyQWdvID0gbmV3IERhdGUoKTtcbiAgICAgIG9uZVllYXJBZ28uc2V0RnVsbFllYXIob25lWWVhckFnby5nZXRGdWxsWWVhcigpIC0gMSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYXVkaXRMb2dSZXBvc2l0b3J5XG4gICAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoKVxuICAgICAgICAuZGVsZXRlKClcbiAgICAgICAgLndoZXJlKCdjcmVhdGVkX2F0IDwgOmRhdGUnLCB7IGRhdGU6IG9uZVllYXJBZ28gfSlcbiAgICAgICAgLmFuZFdoZXJlKCdzZXZlcml0eSBOT1QgSU4gKDouLi5zZXZlcml0aWVzKScsIHtcbiAgICAgICAgICBzZXZlcml0aWVzOiBbQXVkaXRTZXZlcml0eS5ISUdILCBBdWRpdFNldmVyaXR5LkNSSVRJQ0FMXSxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4ZWN1dGUoKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgTGltcGV6YSBhdXRvbcOhdGljYTogJHtyZXN1bHQuYWZmZWN0ZWR9IGxvZ3MgYW50aWdvcyByZW1vdmlkb3NgLFxuICAgICAgKTtcblxuICAgICAgLy8gUmVtb3ZlIGxvZ3MgY3LDrXRpY29zIGNvbSBtYWlzIGRlIDIgYW5vc1xuICAgICAgY29uc3QgdHdvWWVhcnNBZ28gPSBuZXcgRGF0ZSgpO1xuICAgICAgdHdvWWVhcnNBZ28uc2V0RnVsbFllYXIodHdvWWVhcnNBZ28uZ2V0RnVsbFllYXIoKSAtIDIpO1xuXG4gICAgICBjb25zdCBjcml0aWNhbFJlc3VsdCA9IGF3YWl0IHRoaXMuYXVkaXRMb2dSZXBvc2l0b3J5XG4gICAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoKVxuICAgICAgICAuZGVsZXRlKClcbiAgICAgICAgLndoZXJlKCdjcmVhdGVkX2F0IDwgOmRhdGUnLCB7IGRhdGU6IHR3b1llYXJzQWdvIH0pXG4gICAgICAgIC5hbmRXaGVyZSgnc2V2ZXJpdHkgSU4gKDouLi5zZXZlcml0aWVzKScsIHtcbiAgICAgICAgICBzZXZlcml0aWVzOiBbQXVkaXRTZXZlcml0eS5ISUdILCBBdWRpdFNldmVyaXR5LkNSSVRJQ0FMXSxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4ZWN1dGUoKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgTGltcGV6YSBhdXRvbcOhdGljYTogJHtjcml0aWNhbFJlc3VsdC5hZmZlY3RlZH0gbG9ncyBjcsOtdGljb3MgYW50aWdvcyByZW1vdmlkb3NgLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm8gbmEgbGltcGV6YSBhdXRvbcOhdGljYSBkZSBsb2dzJywgZXJyb3Iuc3RhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNw6l0b2RvcyBkZSBjb252ZW5pw6puY2lhIHBhcmEgbG9nZ2luZyBlc3BlY8OtZmljb1xuICAgKi9cbiAgYXN5bmMgbG9nVXNlckFjdGlvbihcbiAgICB1c3VhcmlvSWQ6IHN0cmluZyxcbiAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLFxuICAgIHJlc291cmNlVHlwZTogc3RyaW5nLFxuICAgIHJlc291cmNlSWQ/OiBzdHJpbmcsXG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmcsXG4gICAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgIHJlcXVlc3Q/OiB7XG4gICAgICBpcD86IHN0cmluZztcbiAgICAgIHVzZXJBZ2VudD86IHN0cmluZztcbiAgICAgIG1ldGhvZD86IHN0cmluZztcbiAgICAgIHVybD86IHN0cmluZztcbiAgICB9LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUxvZyh7XG4gICAgICB1c3VhcmlvX2lkOiB1c3VhcmlvSWQsXG4gICAgICBhY3Rpb24sXG4gICAgICByZXNvdXJjZV90eXBlOiByZXNvdXJjZVR5cGUsXG4gICAgICByZXNvdXJjZV9pZDogcmVzb3VyY2VJZCxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgc2V2ZXJpdHk6IHRoaXMuZ2V0U2V2ZXJpdHlGb3JBY3Rpb24oYWN0aW9uKSxcbiAgICAgIGNsaWVudF9pcDogcmVxdWVzdD8uaXAsXG4gICAgICB1c2VyX2FnZW50OiByZXF1ZXN0Py51c2VyQWdlbnQsXG4gICAgICByZXF1ZXN0X21ldGhvZDogcmVxdWVzdD8ubWV0aG9kLFxuICAgICAgcmVxdWVzdF91cmw6IHJlcXVlc3Q/LnVybCxcbiAgICAgIG1ldGFkYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nU2VjdXJpdHlFdmVudChcbiAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkPzogc3RyaW5nLFxuICAgIHNldmVyaXR5OiBBdWRpdFNldmVyaXR5ID0gQXVkaXRTZXZlcml0eS5ISUdILFxuICAgIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICByZXF1ZXN0Pzoge1xuICAgICAgaXA/OiBzdHJpbmc7XG4gICAgICB1c2VyQWdlbnQ/OiBzdHJpbmc7XG4gICAgfSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVMb2coe1xuICAgICAgdXN1YXJpb19pZDogdXN1YXJpb0lkLFxuICAgICAgYWN0aW9uLFxuICAgICAgcmVzb3VyY2VfdHlwZTogJ1NlY3VyaXR5JyxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgc2V2ZXJpdHksXG4gICAgICBjbGllbnRfaXA6IHJlcXVlc3Q/LmlwLFxuICAgICAgdXNlcl9hZ2VudDogcmVxdWVzdD8udXNlckFnZW50LFxuICAgICAgbWV0YWRhdGEsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dTeXN0ZW1FdmVudChcbiAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUxvZyh7XG4gICAgICBhY3Rpb24sXG4gICAgICByZXNvdXJjZV90eXBlOiAnU3lzdGVtJyxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgc2V2ZXJpdHk6IEF1ZGl0U2V2ZXJpdHkuTE9XLFxuICAgICAgbWV0YWRhdGEsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTcOpdG9kb3MgcHJpdmFkb3NcbiAgICovXG4gIHByaXZhdGUgbWFwVG9SZXNwb25zZUR0byhsb2c6IEF1ZGl0TG9nKTogQXVkaXRMb2dSZXNwb25zZUR0byB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBsb2cuaWQsXG4gICAgICB1c3VhcmlvX2lkOiBsb2cudXN1YXJpb19pZCxcbiAgICAgIHVzdWFyaW86IGxvZy51c3VhcmlvXG4gICAgICAgID8ge1xuICAgICAgICAgICAgaWQ6IGxvZy51c3VhcmlvLmlkLFxuICAgICAgICAgICAgbm9tZTogbG9nLnVzdWFyaW8ubm9tZSxcbiAgICAgICAgICAgIGVtYWlsOiBsb2cudXN1YXJpby5lbWFpbCxcbiAgICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgYWN0aW9uOiBsb2cuYWN0aW9uLFxuICAgICAgcmVzb3VyY2VfdHlwZTogbG9nLnJlc291cmNlX3R5cGUsXG4gICAgICByZXNvdXJjZV9pZDogbG9nLnJlc291cmNlX2lkLFxuICAgICAgZGVzY3JpcHRpb246IGxvZy5kZXNjcmlwdGlvbixcbiAgICAgIHNldmVyaXR5OiBsb2cuc2V2ZXJpdHksXG4gICAgICBjbGllbnRfaXA6IGxvZy5jbGllbnRfaXAsXG4gICAgICB1c2VyX2FnZW50OiBsb2cudXNlcl9hZ2VudCxcbiAgICAgIGNyZWF0ZWRfYXQ6IGxvZy5jcmVhdGVkX2F0LFxuICAgICAgbWV0YWRhdGE6IGxvZy5tZXRhZGF0YSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTZXZlcml0eUZvckFjdGlvbihhY3Rpb246IEF1ZGl0QWN0aW9uKTogQXVkaXRTZXZlcml0eSB7XG4gICAgY29uc3Qgc2V2ZXJpdHlNYXA6IFJlY29yZDxBdWRpdEFjdGlvbiwgQXVkaXRTZXZlcml0eT4gPSB7XG4gICAgICBbQXVkaXRBY3Rpb24uQ1JFQVRFXTogQXVkaXRTZXZlcml0eS5MT1csXG4gICAgICBbQXVkaXRBY3Rpb24uUkVBRF06IEF1ZGl0U2V2ZXJpdHkuTE9XLFxuICAgICAgW0F1ZGl0QWN0aW9uLlVQREFURV06IEF1ZGl0U2V2ZXJpdHkuTE9XLFxuICAgICAgW0F1ZGl0QWN0aW9uLkRFTEVURV06IEF1ZGl0U2V2ZXJpdHkuTUVESVVNLFxuICAgICAgW0F1ZGl0QWN0aW9uLkxPR0lOXTogQXVkaXRTZXZlcml0eS5MT1csXG4gICAgICBbQXVkaXRBY3Rpb24uTE9HT1VUXTogQXVkaXRTZXZlcml0eS5MT1csXG4gICAgICBbQXVkaXRBY3Rpb24uTE9HSU5fRkFJTEVEXTogQXVkaXRTZXZlcml0eS5NRURJVU0sXG4gICAgICBbQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVRdOiBBdWRpdFNldmVyaXR5LkhJR0gsXG4gICAgICBbQXVkaXRBY3Rpb24uUEFTU1dPUkRfQ0hBTkdFXTogQXVkaXRTZXZlcml0eS5NRURJVU0sXG4gICAgICBbQXVkaXRBY3Rpb24uUEVSTUlTU0lPTl9ERU5JRURdOiBBdWRpdFNldmVyaXR5LkhJR0gsXG4gICAgICBbQXVkaXRBY3Rpb24uVE9LRU5fUkVGUkVTSF06IEF1ZGl0U2V2ZXJpdHkuTE9XLFxuICAgICAgW0F1ZGl0QWN0aW9uLlRPS0VOX1JFVk9LRV06IEF1ZGl0U2V2ZXJpdHkuTUVESVVNLFxuICAgICAgW0F1ZGl0QWN0aW9uLkVYUE9SVF9EQVRBXTogQXVkaXRTZXZlcml0eS5NRURJVU0sXG4gICAgICBbQXVkaXRBY3Rpb24uSU1QT1JUX0RBVEFdOiBBdWRpdFNldmVyaXR5Lk1FRElVTSxcbiAgICAgIFtBdWRpdEFjdGlvbi5TWVNURU1fQ09ORklHXTogQXVkaXRTZXZlcml0eS5ISUdILFxuICAgIH07XG5cbiAgICByZXR1cm4gc2V2ZXJpdHlNYXBbYWN0aW9uXSB8fCBBdWRpdFNldmVyaXR5LkxPVztcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9