ca5b6e7e3e0feb1415284be3c1fa40ea
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var MetricasService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricasService = void 0;
const common_1 = require("@nestjs/common");
const client = __importStar(require("prom-client"));
/**
 * Serviço responsável por gerenciar as métricas do sistema para monitoramento
 * com Prometheus e Grafana.
 */
let MetricasService = MetricasService_1 = class MetricasService {
    logger = new common_1.Logger(MetricasService_1.name);
    registry;
    // Métricas HTTP
    httpRequestsTotal;
    httpRequestDuration;
    httpRequestsSizeBytes;
    httpResponsesSizeBytes;
    // Métricas de negócio
    operacoesTotal;
    dadosSensiveisAcessosTotal;
    // Métricas de sistema
    memoryUsage;
    cpuUsage;
    constructor() {
        // Inicializa o registro de métricas
        this.registry = new client.Registry();
        // Registra o coletor padrão (métricas do Node.js)
        client.collectDefaultMetrics({
            register: this.registry,
            prefix: 'pgben_',
        });
        this.inicializarMetricas();
        this.logger.log('Serviço de métricas inicializado');
    }
    /**
     * Inicializa todas as métricas que serão coletadas pelo sistema
     */
    inicializarMetricas() {
        // Métricas HTTP
        this.httpRequestsTotal = new client.Counter({
            name: 'pgben_http_requests_total',
            help: 'Total de requisições HTTP',
            labelNames: ['method', 'path', 'status'],
            registers: [this.registry],
        });
        this.httpRequestDuration = new client.Histogram({
            name: 'pgben_http_request_duration_seconds',
            help: 'Duração das requisições HTTP em segundos',
            labelNames: ['method', 'path', 'status'],
            buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5, 10],
            registers: [this.registry],
        });
        this.httpRequestsSizeBytes = new client.Histogram({
            name: 'pgben_http_request_size_bytes',
            help: 'Tamanho das requisições HTTP em bytes',
            labelNames: ['method', 'path'],
            buckets: [100, 1000, 10000, 100000, 1000000],
            registers: [this.registry],
        });
        this.httpResponsesSizeBytes = new client.Histogram({
            name: 'pgben_http_response_size_bytes',
            help: 'Tamanho das respostas HTTP em bytes',
            labelNames: ['method', 'path', 'status'],
            buckets: [100, 1000, 10000, 100000, 1000000],
            registers: [this.registry],
        });
        // Métricas de negócio
        this.operacoesTotal = new client.Counter({
            name: 'pgben_operacoes_total',
            help: 'Total de operações por tipo',
            labelNames: ['tipo_operacao', 'entidade'],
            registers: [this.registry],
        });
        this.dadosSensiveisAcessosTotal = new client.Counter({
            name: 'pgben_dados_sensiveis_acessos_total',
            help: 'Total de acessos a dados sensíveis',
            labelNames: ['entidade', 'campo', 'usuario_id'],
            registers: [this.registry],
        });
        // Métricas de sistema
        this.memoryUsage = new client.Gauge({
            name: 'pgben_memory_usage_bytes',
            help: 'Uso de memória em bytes',
            registers: [this.registry],
        });
        this.cpuUsage = new client.Gauge({
            name: 'pgben_cpu_usage_percent',
            help: 'Uso de CPU em porcentagem',
            registers: [this.registry],
        });
    }
    /**
     * Registra uma requisição HTTP
     * @param method Método HTTP
     * @param path Caminho da requisição
     * @param status Código de status da resposta
     * @param duration Duração da requisição em segundos
     * @param requestSize Tamanho da requisição em bytes
     * @param responseSize Tamanho da resposta em bytes
     */
    registrarRequisicaoHttp(method, path, status, duration, requestSize, responseSize) {
        const statusCode = status.toString();
        // Normaliza o path para evitar cardinalidade alta
        const normalizedPath = this.normalizarPath(path);
        this.httpRequestsTotal.inc({
            method,
            path: normalizedPath,
            status: statusCode,
        });
        this.httpRequestDuration.observe({ method, path: normalizedPath, status: statusCode }, duration);
        this.httpRequestsSizeBytes.observe({ method, path: normalizedPath }, requestSize);
        this.httpResponsesSizeBytes.observe({ method, path: normalizedPath, status: statusCode }, responseSize);
    }
    /**
     * Registra uma operação de negócio
     * @param tipoOperacao Tipo de operação (CREATE, READ, UPDATE, DELETE)
     * @param entidade Entidade afetada
     */
    registrarOperacao(tipoOperacao, entidade) {
        this.operacoesTotal.inc({ tipo_operacao: tipoOperacao, entidade });
    }
    /**
     * Registra um acesso a dados sensíveis
     * @param entidade Entidade que contém os dados sensíveis
     * @param campo Campo sensível acessado
     * @param usuarioId ID do usuário que acessou os dados
     */
    registrarAcessoDadosSensiveis(entidade, campo, usuarioId) {
        this.dadosSensiveisAcessosTotal.inc({
            entidade,
            campo,
            usuario_id: usuarioId,
        });
    }
    /**
     * Atualiza as métricas de uso de recursos do sistema
     */
    atualizarMetricasSistema() {
        const memoryUsage = process.memoryUsage();
        this.memoryUsage.set(memoryUsage.rss);
        // Nota: Para obter métricas precisas de CPU, seria necessário
        // implementar uma solução mais robusta usando bibliotecas como os-utils
        // Esta é uma implementação simplificada
        this.cpuUsage.set(process.cpuUsage().user / 1000000);
    }
    /**
     * Obtém todas as métricas registradas
     * @returns Métricas no formato do Prometheus
     */
    async obterMetricas() {
        this.atualizarMetricasSistema();
        return this.registry.metrics();
    }
    /**
     * Normaliza o path da requisição para evitar cardinalidade alta nas métricas
     * @param path Caminho original da requisição
     * @returns Caminho normalizado
     */
    normalizarPath(path) {
        // Remove IDs e outros parâmetros variáveis do path
        // Exemplo: /api/v1/usuarios/123e4567-e89b-12d3-a456-426614174000 -> /api/v1/usuarios/:id
        return path
            .replace(/\/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g, '/:id')
            .replace(/\/[0-9]+/g, '/:id');
    }
};
exports.MetricasService = MetricasService;
exports.MetricasService = MetricasService = MetricasService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [])
], MetricasService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXG1ldHJpY2FzXFxzZXJ2aWNlc1xcbWV0cmljYXMuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELG9EQUFzQztBQUV0Qzs7O0dBR0c7QUFFSSxJQUFNLGVBQWUsdUJBQXJCLE1BQU0sZUFBZTtJQUNULE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25ELFFBQVEsQ0FBa0I7SUFFbEMsZ0JBQWdCO0lBQ1IsaUJBQWlCLENBQXlCO0lBQzFDLG1CQUFtQixDQUEyQjtJQUM5QyxxQkFBcUIsQ0FBMkI7SUFDaEQsc0JBQXNCLENBQTJCO0lBRXpELHNCQUFzQjtJQUNkLGNBQWMsQ0FBeUI7SUFDdkMsMEJBQTBCLENBQXlCO0lBRTNELHNCQUFzQjtJQUNkLFdBQVcsQ0FBdUI7SUFDbEMsUUFBUSxDQUF1QjtJQUV2QztRQUNFLG9DQUFvQztRQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXRDLGtEQUFrRDtRQUNsRCxNQUFNLENBQUMscUJBQXFCLENBQUM7WUFDM0IsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLE1BQU0sRUFBRSxRQUFRO1NBQ2pCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ssbUJBQW1CO1FBQ3pCLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQzFDLElBQUksRUFBRSwy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QUF3QjtRQUN0QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXRDLDhEQUE4RDtRQUM5RCx3RUFBd0U7UUFDeEUsd0NBQXdDO1FBQ3hDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxhQUFhO1FBQ2pCLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLGNBQWMsQ0FBQyxJQUFZO1FBQ2pDLG1EQUFtRDtRQUNuRCx5RkFBeUY7UUFDekYsT0FBTyxJQUFJO2FBQ1IsT0FBTyxDQUNOLGdGQUFnRixFQUNoRixNQUFNLENBQ1A7YUFDQSxPQUFPLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRixDQUFBO0FBMU1ZLDBDQUFlOzBCQUFmLGVBQWU7SUFEM0IsSUFBQSxtQkFBVSxHQUFFOztHQUNBLGVBQWUsQ0EwTTNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxtZXRyaWNhc1xcc2VydmljZXNcXG1ldHJpY2FzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0ICogYXMgY2xpZW50IGZyb20gJ3Byb20tY2xpZW50JztcblxuLyoqXG4gKiBTZXJ2acOnbyByZXNwb25zw6F2ZWwgcG9yIGdlcmVuY2lhciBhcyBtw6l0cmljYXMgZG8gc2lzdGVtYSBwYXJhIG1vbml0b3JhbWVudG9cbiAqIGNvbSBQcm9tZXRoZXVzIGUgR3JhZmFuYS5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1ldHJpY2FzU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihNZXRyaWNhc1NlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVnaXN0cnk6IGNsaWVudC5SZWdpc3RyeTtcblxuICAvLyBNw6l0cmljYXMgSFRUUFxuICBwcml2YXRlIGh0dHBSZXF1ZXN0c1RvdGFsOiBjbGllbnQuQ291bnRlcjxzdHJpbmc+O1xuICBwcml2YXRlIGh0dHBSZXF1ZXN0RHVyYXRpb246IGNsaWVudC5IaXN0b2dyYW08c3RyaW5nPjtcbiAgcHJpdmF0ZSBodHRwUmVxdWVzdHNTaXplQnl0ZXM6IGNsaWVudC5IaXN0b2dyYW08c3RyaW5nPjtcbiAgcHJpdmF0ZSBodHRwUmVzcG9uc2VzU2l6ZUJ5dGVzOiBjbGllbnQuSGlzdG9ncmFtPHN0cmluZz47XG5cbiAgLy8gTcOpdHJpY2FzIGRlIG5lZ8OzY2lvXG4gIHByaXZhdGUgb3BlcmFjb2VzVG90YWw6IGNsaWVudC5Db3VudGVyPHN0cmluZz47XG4gIHByaXZhdGUgZGFkb3NTZW5zaXZlaXNBY2Vzc29zVG90YWw6IGNsaWVudC5Db3VudGVyPHN0cmluZz47XG5cbiAgLy8gTcOpdHJpY2FzIGRlIHNpc3RlbWFcbiAgcHJpdmF0ZSBtZW1vcnlVc2FnZTogY2xpZW50LkdhdWdlPHN0cmluZz47XG4gIHByaXZhdGUgY3B1VXNhZ2U6IGNsaWVudC5HYXVnZTxzdHJpbmc+O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIEluaWNpYWxpemEgbyByZWdpc3RybyBkZSBtw6l0cmljYXNcbiAgICB0aGlzLnJlZ2lzdHJ5ID0gbmV3IGNsaWVudC5SZWdpc3RyeSgpO1xuXG4gICAgLy8gUmVnaXN0cmEgbyBjb2xldG9yIHBhZHLDo28gKG3DqXRyaWNhcyBkbyBOb2RlLmpzKVxuICAgIGNsaWVudC5jb2xsZWN0RGVmYXVsdE1ldHJpY3Moe1xuICAgICAgcmVnaXN0ZXI6IHRoaXMucmVnaXN0cnksXG4gICAgICBwcmVmaXg6ICdwZ2Jlbl8nLFxuICAgIH0pO1xuXG4gICAgdGhpcy5pbmljaWFsaXphck1ldHJpY2FzKCk7XG4gICAgdGhpcy5sb2dnZXIubG9nKCdTZXJ2acOnbyBkZSBtw6l0cmljYXMgaW5pY2lhbGl6YWRvJyk7XG4gIH1cblxuICAvKipcbiAgICogSW5pY2lhbGl6YSB0b2RhcyBhcyBtw6l0cmljYXMgcXVlIHNlcsOjbyBjb2xldGFkYXMgcGVsbyBzaXN0ZW1hXG4gICAqL1xuICBwcml2YXRlIGluaWNpYWxpemFyTWV0cmljYXMoKTogdm9pZCB7XG4gICAgLy8gTcOpdHJpY2FzIEhUVFBcbiAgICB0aGlzLmh0dHBSZXF1ZXN0c1RvdGFsID0gbmV3IGNsaWVudC5Db3VudGVyKHtcbiAgICAgIG5hbWU6ICdwZ2Jlbl9odHRwX3JlcXVlc3RzX3RvdGFsJyxcbiAgICAgIGhlbHA6ICdUb3RhbCBkZSByZXF1aXNpw6fDtWVzIEhUVFAnLFxuICAgICAgbGFiZWxOYW1lczogWydtZXRob2QnLCAncGF0aCcsICdzdGF0dXMnXSxcbiAgICAgIHJlZ2lzdGVyczogW3RoaXMucmVnaXN0cnldLFxuICAgIH0pO1xuXG4gICAgdGhpcy5odHRwUmVxdWVzdER1cmF0aW9uID0gbmV3IGNsaWVudC5IaXN0b2dyYW0oe1xuICAgICAgbmFtZTogJ3BnYmVuX2h0dHBfcmVxdWVzdF9kdXJhdGlvbl9zZWNvbmRzJyxcbiAgICAgIGhlbHA6ICdEdXJhw6fDo28gZGFzIHJlcXVpc2nDp8O1ZXMgSFRUUCBlbSBzZWd1bmRvcycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ21ldGhvZCcsICdwYXRoJywgJ3N0YXR1cyddLFxuICAgICAgYnVja2V0czogWzAuMDEsIDAuMDUsIDAuMSwgMC41LCAxLCAyLCA1LCAxMF0sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuaHR0cFJlcXVlc3RzU2l6ZUJ5dGVzID0gbmV3IGNsaWVudC5IaXN0b2dyYW0oe1xuICAgICAgbmFtZTogJ3BnYmVuX2h0dHBfcmVxdWVzdF9zaXplX2J5dGVzJyxcbiAgICAgIGhlbHA6ICdUYW1hbmhvIGRhcyByZXF1aXNpw6fDtWVzIEhUVFAgZW0gYnl0ZXMnLFxuICAgICAgbGFiZWxOYW1lczogWydtZXRob2QnLCAncGF0aCddLFxuICAgICAgYnVja2V0czogWzEwMCwgMTAwMCwgMTAwMDAsIDEwMDAwMCwgMTAwMDAwMF0sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuaHR0cFJlc3BvbnNlc1NpemVCeXRlcyA9IG5ldyBjbGllbnQuSGlzdG9ncmFtKHtcbiAgICAgIG5hbWU6ICdwZ2Jlbl9odHRwX3Jlc3BvbnNlX3NpemVfYnl0ZXMnLFxuICAgICAgaGVscDogJ1RhbWFuaG8gZGFzIHJlc3Bvc3RhcyBIVFRQIGVtIGJ5dGVzJyxcbiAgICAgIGxhYmVsTmFtZXM6IFsnbWV0aG9kJywgJ3BhdGgnLCAnc3RhdHVzJ10sXG4gICAgICBidWNrZXRzOiBbMTAwLCAxMDAwLCAxMDAwMCwgMTAwMDAwLCAxMDAwMDAwXSxcbiAgICAgIHJlZ2lzdGVyczogW3RoaXMucmVnaXN0cnldLFxuICAgIH0pO1xuXG4gICAgLy8gTcOpdHJpY2FzIGRlIG5lZ8OzY2lvXG4gICAgdGhpcy5vcGVyYWNvZXNUb3RhbCA9IG5ldyBjbGllbnQuQ291bnRlcih7XG4gICAgICBuYW1lOiAncGdiZW5fb3BlcmFjb2VzX3RvdGFsJyxcbiAgICAgIGhlbHA6ICdUb3RhbCBkZSBvcGVyYcOnw7VlcyBwb3IgdGlwbycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ3RpcG9fb3BlcmFjYW8nLCAnZW50aWRhZGUnXSxcbiAgICAgIHJlZ2lzdGVyczogW3RoaXMucmVnaXN0cnldLFxuICAgIH0pO1xuXG4gICAgdGhpcy5kYWRvc1NlbnNpdmVpc0FjZXNzb3NUb3RhbCA9IG5ldyBjbGllbnQuQ291bnRlcih7XG4gICAgICBuYW1lOiAncGdiZW5fZGFkb3Nfc2Vuc2l2ZWlzX2FjZXNzb3NfdG90YWwnLFxuICAgICAgaGVscDogJ1RvdGFsIGRlIGFjZXNzb3MgYSBkYWRvcyBzZW5zw612ZWlzJyxcbiAgICAgIGxhYmVsTmFtZXM6IFsnZW50aWRhZGUnLCAnY2FtcG8nLCAndXN1YXJpb19pZCddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICAvLyBNw6l0cmljYXMgZGUgc2lzdGVtYVxuICAgIHRoaXMubWVtb3J5VXNhZ2UgPSBuZXcgY2xpZW50LkdhdWdlKHtcbiAgICAgIG5hbWU6ICdwZ2Jlbl9tZW1vcnlfdXNhZ2VfYnl0ZXMnLFxuICAgICAgaGVscDogJ1VzbyBkZSBtZW3Ds3JpYSBlbSBieXRlcycsXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuY3B1VXNhZ2UgPSBuZXcgY2xpZW50LkdhdWdlKHtcbiAgICAgIG5hbWU6ICdwZ2Jlbl9jcHVfdXNhZ2VfcGVyY2VudCcsXG4gICAgICBoZWxwOiAnVXNvIGRlIENQVSBlbSBwb3JjZW50YWdlbScsXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RyYSB1bWEgcmVxdWlzacOnw6NvIEhUVFBcbiAgICogQHBhcmFtIG1ldGhvZCBNw6l0b2RvIEhUVFBcbiAgICogQHBhcmFtIHBhdGggQ2FtaW5obyBkYSByZXF1aXNpw6fDo29cbiAgICogQHBhcmFtIHN0YXR1cyBDw7NkaWdvIGRlIHN0YXR1cyBkYSByZXNwb3N0YVxuICAgKiBAcGFyYW0gZHVyYXRpb24gRHVyYcOnw6NvIGRhIHJlcXVpc2nDp8OjbyBlbSBzZWd1bmRvc1xuICAgKiBAcGFyYW0gcmVxdWVzdFNpemUgVGFtYW5obyBkYSByZXF1aXNpw6fDo28gZW0gYnl0ZXNcbiAgICogQHBhcmFtIHJlc3BvbnNlU2l6ZSBUYW1hbmhvIGRhIHJlc3Bvc3RhIGVtIGJ5dGVzXG4gICAqL1xuICByZWdpc3RyYXJSZXF1aXNpY2FvSHR0cChcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgc3RhdHVzOiBudW1iZXIsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICByZXF1ZXN0U2l6ZTogbnVtYmVyLFxuICAgIHJlc3BvbnNlU2l6ZTogbnVtYmVyLFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0dXNDb2RlID0gc3RhdHVzLnRvU3RyaW5nKCk7XG5cbiAgICAvLyBOb3JtYWxpemEgbyBwYXRoIHBhcmEgZXZpdGFyIGNhcmRpbmFsaWRhZGUgYWx0YVxuICAgIGNvbnN0IG5vcm1hbGl6ZWRQYXRoID0gdGhpcy5ub3JtYWxpemFyUGF0aChwYXRoKTtcblxuICAgIHRoaXMuaHR0cFJlcXVlc3RzVG90YWwuaW5jKHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIHBhdGg6IG5vcm1hbGl6ZWRQYXRoLFxuICAgICAgc3RhdHVzOiBzdGF0dXNDb2RlLFxuICAgIH0pO1xuICAgIHRoaXMuaHR0cFJlcXVlc3REdXJhdGlvbi5vYnNlcnZlKFxuICAgICAgeyBtZXRob2QsIHBhdGg6IG5vcm1hbGl6ZWRQYXRoLCBzdGF0dXM6IHN0YXR1c0NvZGUgfSxcbiAgICAgIGR1cmF0aW9uLFxuICAgICk7XG4gICAgdGhpcy5odHRwUmVxdWVzdHNTaXplQnl0ZXMub2JzZXJ2ZShcbiAgICAgIHsgbWV0aG9kLCBwYXRoOiBub3JtYWxpemVkUGF0aCB9LFxuICAgICAgcmVxdWVzdFNpemUsXG4gICAgKTtcbiAgICB0aGlzLmh0dHBSZXNwb25zZXNTaXplQnl0ZXMub2JzZXJ2ZShcbiAgICAgIHsgbWV0aG9kLCBwYXRoOiBub3JtYWxpemVkUGF0aCwgc3RhdHVzOiBzdGF0dXNDb2RlIH0sXG4gICAgICByZXNwb25zZVNpemUsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RyYSB1bWEgb3BlcmHDp8OjbyBkZSBuZWfDs2Npb1xuICAgKiBAcGFyYW0gdGlwb09wZXJhY2FvIFRpcG8gZGUgb3BlcmHDp8OjbyAoQ1JFQVRFLCBSRUFELCBVUERBVEUsIERFTEVURSlcbiAgICogQHBhcmFtIGVudGlkYWRlIEVudGlkYWRlIGFmZXRhZGFcbiAgICovXG4gIHJlZ2lzdHJhck9wZXJhY2FvKHRpcG9PcGVyYWNhbzogc3RyaW5nLCBlbnRpZGFkZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5vcGVyYWNvZXNUb3RhbC5pbmMoeyB0aXBvX29wZXJhY2FvOiB0aXBvT3BlcmFjYW8sIGVudGlkYWRlIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdHJhIHVtIGFjZXNzbyBhIGRhZG9zIHNlbnPDrXZlaXNcbiAgICogQHBhcmFtIGVudGlkYWRlIEVudGlkYWRlIHF1ZSBjb250w6ltIG9zIGRhZG9zIHNlbnPDrXZlaXNcbiAgICogQHBhcmFtIGNhbXBvIENhbXBvIHNlbnPDrXZlbCBhY2Vzc2Fkb1xuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBhY2Vzc291IG9zIGRhZG9zXG4gICAqL1xuICByZWdpc3RyYXJBY2Vzc29EYWRvc1NlbnNpdmVpcyhcbiAgICBlbnRpZGFkZTogc3RyaW5nLFxuICAgIGNhbXBvOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IHZvaWQge1xuICAgIHRoaXMuZGFkb3NTZW5zaXZlaXNBY2Vzc29zVG90YWwuaW5jKHtcbiAgICAgIGVudGlkYWRlLFxuICAgICAgY2FtcG8sXG4gICAgICB1c3VhcmlvX2lkOiB1c3VhcmlvSWQsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgYXMgbcOpdHJpY2FzIGRlIHVzbyBkZSByZWN1cnNvcyBkbyBzaXN0ZW1hXG4gICAqL1xuICBhdHVhbGl6YXJNZXRyaWNhc1Npc3RlbWEoKTogdm9pZCB7XG4gICAgY29uc3QgbWVtb3J5VXNhZ2UgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gICAgdGhpcy5tZW1vcnlVc2FnZS5zZXQobWVtb3J5VXNhZ2UucnNzKTtcblxuICAgIC8vIE5vdGE6IFBhcmEgb2J0ZXIgbcOpdHJpY2FzIHByZWNpc2FzIGRlIENQVSwgc2VyaWEgbmVjZXNzw6FyaW9cbiAgICAvLyBpbXBsZW1lbnRhciB1bWEgc29sdcOnw6NvIG1haXMgcm9idXN0YSB1c2FuZG8gYmlibGlvdGVjYXMgY29tbyBvcy11dGlsc1xuICAgIC8vIEVzdGEgw6kgdW1hIGltcGxlbWVudGHDp8OjbyBzaW1wbGlmaWNhZGFcbiAgICB0aGlzLmNwdVVzYWdlLnNldChwcm9jZXNzLmNwdVVzYWdlKCkudXNlciAvIDEwMDAwMDApO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSB0b2RhcyBhcyBtw6l0cmljYXMgcmVnaXN0cmFkYXNcbiAgICogQHJldHVybnMgTcOpdHJpY2FzIG5vIGZvcm1hdG8gZG8gUHJvbWV0aGV1c1xuICAgKi9cbiAgYXN5bmMgb2J0ZXJNZXRyaWNhcygpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRoaXMuYXR1YWxpemFyTWV0cmljYXNTaXN0ZW1hKCk7XG4gICAgcmV0dXJuIHRoaXMucmVnaXN0cnkubWV0cmljcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIE5vcm1hbGl6YSBvIHBhdGggZGEgcmVxdWlzacOnw6NvIHBhcmEgZXZpdGFyIGNhcmRpbmFsaWRhZGUgYWx0YSBuYXMgbcOpdHJpY2FzXG4gICAqIEBwYXJhbSBwYXRoIENhbWluaG8gb3JpZ2luYWwgZGEgcmVxdWlzacOnw6NvXG4gICAqIEByZXR1cm5zIENhbWluaG8gbm9ybWFsaXphZG9cbiAgICovXG4gIHByaXZhdGUgbm9ybWFsaXphclBhdGgocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBSZW1vdmUgSURzIGUgb3V0cm9zIHBhcsOibWV0cm9zIHZhcmnDoXZlaXMgZG8gcGF0aFxuICAgIC8vIEV4ZW1wbG86IC9hcGkvdjEvdXN1YXJpb3MvMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwIC0+IC9hcGkvdjEvdXN1YXJpb3MvOmlkXG4gICAgcmV0dXJuIHBhdGhcbiAgICAgIC5yZXBsYWNlKFxuICAgICAgICAvXFwvWzAtOWEtZkEtRl17OH0tWzAtOWEtZkEtRl17NH0tWzAtOWEtZkEtRl17NH0tWzAtOWEtZkEtRl17NH0tWzAtOWEtZkEtRl17MTJ9L2csXG4gICAgICAgICcvOmlkJyxcbiAgICAgIClcbiAgICAgIC5yZXBsYWNlKC9cXC9bMC05XSsvZywgJy86aWQnKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9