b1bf76b8adf79e18dee2795149085506
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const auditoria_pagamento_service_1 = require("../../services/auditoria-pagamento.service");
const config_1 = require("@nestjs/config");
const common_1 = require("@nestjs/common");
const status_pagamento_enum_1 = require("../../enums/status-pagamento.enum");
const metodo_pagamento_enum_1 = require("../../enums/metodo-pagamento.enum");
/**
 * Testes unitários para o serviço de auditoria de pagamento
 *
 * Verifica o funcionamento correto das operações de registro de logs
 * para ações sensíveis relacionadas a pagamentos.
 *
 * @author Equipe PGBen
 */
describe('AuditoriaPagamentoService', () => {
    let service;
    let logger;
    let configService;
    // Mock do Logger
    const mockLogger = {
        log: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        debug: jest.fn(),
    };
    // Mock do ConfigService
    const mockConfigService = {
        get: jest.fn().mockImplementation((key) => {
            if (key === 'auditoria.nivel') {
                return 'completo';
            }
            if (key === 'auditoria.mascaraDados') {
                return true;
            }
            return null;
        }),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                auditoria_pagamento_service_1.AuditoriaPagamentoService,
                {
                    provide: common_1.Logger,
                    useValue: mockLogger,
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        service = module.get(auditoria_pagamento_service_1.AuditoriaPagamentoService);
        logger = module.get(common_1.Logger);
        configService = module.get(config_1.ConfigService);
        // Limpar mocks antes de cada teste
        jest.clearAllMocks();
    });
    describe('logCriacaoPagamento', () => {
        const pagamento = {
            id: 'pagamento-id',
            solicitacaoId: 'solicitacao-id',
            valor: 500.0,
            status: status_pagamento_enum_1.StatusPagamentoEnum.AGENDADO,
            metodoPagamento: metodo_pagamento_enum_1.MetodoPagamentoEnum.PIX,
            dadosBancarios: {
                pixTipo: 'cpf',
                pixChave: '12345678909',
            },
        };
        const usuarioId = 'usuario-id';
        it('deve registrar log de criação de pagamento com dados mascarados', () => {
            // Executar método
            service.logCriacaoPagamento(pagamento, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Pagamento criado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém dados mascarados
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).not.toContain('12345678909');
            expect(logMessage).toContain('***');
        });
        it('deve registrar log sem mascaramento quando configurado', () => {
            // Alterar configuração para não mascarar dados
            mockConfigService.get.mockImplementation((key) => {
                if (key === 'auditoria.nivel') {
                    return 'completo';
                }
                if (key === 'auditoria.mascaraDados') {
                    return false;
                }
                return null;
            });
            // Executar método
            service.logCriacaoPagamento(pagamento, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Pagamento criado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém dados completos
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamento.id);
            expect(logMessage).toContain(pagamento.solicitacaoId);
        });
    });
    describe('logMudancaStatus', () => {
        const pagamentoId = 'pagamento-id';
        const statusAntigo = status_pagamento_enum_1.StatusPagamentoEnum.AGENDADO;
        const statusNovo = status_pagamento_enum_1.StatusPagamentoEnum.LIBERADO;
        const usuarioId = 'usuario-id';
        it('deve registrar log de mudança de status', () => {
            // Executar método
            service.logMudancaStatus(pagamentoId, statusAntigo, statusNovo, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Status alterado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os status
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(statusAntigo);
            expect(logMessage).toContain(statusNovo);
            expect(logMessage).toContain(pagamentoId);
        });
    });
    describe('logCancelamentoPagamento', () => {
        const pagamentoId = 'pagamento-id';
        const motivo = 'Pagamento cancelado a pedido do beneficiário';
        const usuarioId = 'usuario-id';
        it('deve registrar log de cancelamento de pagamento', () => {
            // Executar método
            service.logCancelamentoPagamento(pagamentoId, motivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Pagamento cancelado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém o motivo
            const logMessage = mockLogger.warn.mock.calls[0][0];
            expect(logMessage).toContain(motivo);
            expect(logMessage).toContain(pagamentoId);
        });
    });
    describe('logUploadComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const comprovanteId = 'comprovante-id';
        const usuarioId = 'usuario-id';
        const nomeArquivo = 'comprovante.pdf';
        it('deve registrar log de upload de comprovante', () => {
            // Executar método
            service.logUploadComprovante(pagamentoId, comprovanteId, nomeArquivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Comprovante enviado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados do comprovante
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(comprovanteId);
            expect(logMessage).toContain(nomeArquivo);
        });
    });
    describe('logRemocaoComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const comprovanteId = 'comprovante-id';
        const usuarioId = 'usuario-id';
        const motivo = 'Documento incorreto';
        it('deve registrar log de remoção de comprovante', () => {
            // Executar método
            service.logRemocaoComprovante(pagamentoId, comprovanteId, motivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Comprovante removido'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados da remoção
            const logMessage = mockLogger.warn.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(comprovanteId);
            expect(logMessage).toContain(motivo);
        });
    });
    describe('logConfirmacaoRecebimento', () => {
        const pagamentoId = 'pagamento-id';
        const confirmacaoId = 'confirmacao-id';
        const usuarioId = 'usuario-id';
        it('deve registrar log de confirmação de recebimento', () => {
            // Executar método
            service.logConfirmacaoRecebimento(pagamentoId, confirmacaoId, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Recebimento confirmado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados da confirmação
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(confirmacaoId);
        });
    });
    describe('logErroProcessamento', () => {
        const pagamentoId = 'pagamento-id';
        const erro = new Error('Erro ao processar pagamento');
        const contexto = 'atualizarStatus';
        it('deve registrar log de erro de processamento', () => {
            // Executar método
            service.logErroProcessamento(pagamentoId, erro, contexto);
            // Verificar resultado
            expect(mockLogger.error).toHaveBeenCalledWith(expect.stringContaining('Erro ao processar pagamento'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados do erro
            const logMessage = mockLogger.error.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(contexto);
            expect(logMessage).toContain(erro.message);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxhdWRpdG9yaWEtcGFnYW1lbnRvLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCw0RkFBdUY7QUFDdkYsMkNBQStDO0FBQy9DLDJDQUF3QztBQUN4Qyw2RUFBd0U7QUFDeEUsNkVBQXdFO0FBRXhFOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksT0FBa0MsQ0FBQztJQUN2QyxJQUFJLE1BQWMsQ0FBQztJQUNuQixJQUFJLGFBQTRCLENBQUM7SUFFakMsaUJBQWlCO0lBQ2pCLE1BQU0sVUFBVSxHQUFHO1FBQ2pCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNqQixDQUFDO0lBRUYsd0JBQXdCO0lBQ3hCLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3hDLElBQUksR0FBRyxLQUFLLGlCQUFpQixFQUFFLENBQUM7Z0JBQzlCLE9BQU8sVUFBVSxDQUFDO1lBQ3BCLENBQUM7WUFDRCxJQUFJLEdBQUcsS0FBSyx3QkFBd0IsRUFBRSxDQUFDO2dCQUNyQyxPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQztLQUNILENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1B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QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxhdWRpdG9yaWEtcGFnYW1lbnRvLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hdWRpdG9yaWEtcGFnYW1lbnRvLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFN0YXR1c1BhZ2FtZW50b0VudW0gfSBmcm9tICcuLi8uLi9lbnVtcy9zdGF0dXMtcGFnYW1lbnRvLmVudW0nO1xuaW1wb3J0IHsgTWV0b2RvUGFnYW1lbnRvRW51bSB9IGZyb20gJy4uLy4uL2VudW1zL21ldG9kby1wYWdhbWVudG8uZW51bSc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIHNlcnZpw6dvIGRlIGF1ZGl0b3JpYSBkZSBwYWdhbWVudG9cbiAqXG4gKiBWZXJpZmljYSBvIGZ1bmNpb25hbWVudG8gY29ycmV0byBkYXMgb3BlcmHDp8O1ZXMgZGUgcmVnaXN0cm8gZGUgbG9nc1xuICogcGFyYSBhw6fDtWVzIHNlbnPDrXZlaXMgcmVsYWNpb25hZGFzIGEgcGFnYW1lbnRvcy5cbiAqXG4gKiBAYXV0aG9yIEVxdWlwZSBQR0JlblxuICovXG5kZXNjcmliZSgnQXVkaXRvcmlhUGFnYW1lbnRvU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2U7XG4gIGxldCBsb2dnZXI6IExvZ2dlcjtcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2U7XG5cbiAgLy8gTW9jayBkbyBMb2dnZXJcbiAgY29uc3QgbW9ja0xvZ2dlciA9IHtcbiAgICBsb2c6IGplc3QuZm4oKSxcbiAgICB3YXJuOiBqZXN0LmZuKCksXG4gICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICBkZWJ1ZzogamVzdC5mbigpLFxuICB9O1xuXG4gIC8vIE1vY2sgZG8gQ29uZmlnU2VydmljZVxuICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICBnZXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ2F1ZGl0b3JpYS5uaXZlbCcpIHtcbiAgICAgICAgcmV0dXJuICdjb21wbGV0byc7XG4gICAgICB9XG4gICAgICBpZiAoa2V5ID09PSAnYXVkaXRvcmlhLm1hc2NhcmFEYWRvcycpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9KSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBMb2dnZXIsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tMb2dnZXIsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQ29uZmlnU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8QXVkaXRvcmlhUGFnYW1lbnRvU2VydmljZT4oQXVkaXRvcmlhUGFnYW1lbnRvU2VydmljZSk7XG4gICAgbG9nZ2VyID0gbW9kdWxlLmdldDxMb2dnZXI+KExvZ2dlcik7XG4gICAgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8Q29uZmlnU2VydmljZT4oQ29uZmlnU2VydmljZSk7XG5cbiAgICAvLyBMaW1wYXIgbW9ja3MgYW50ZXMgZGUgY2FkYSB0ZXN0ZVxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnbG9nQ3JpYWNhb1BhZ2FtZW50bycsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG8gPSB7XG4gICAgICBpZDogJ3BhZ2FtZW50by1pZCcsXG4gICAgICBzb2xpY2l0YWNhb0lkOiAnc29saWNpdGFjYW8taWQnLFxuICAgICAgdmFsb3I6IDUwMC4wLFxuICAgICAgc3RhdHVzOiBTdGF0dXNQYWdhbWVudG9FbnVtLkFHRU5EQURPLFxuICAgICAgbWV0b2RvUGFnYW1lbnRvOiBNZXRvZG9QYWdhbWVudG9FbnVtLlBJWCxcbiAgICAgIGRhZG9zQmFuY2FyaW9zOiB7XG4gICAgICAgIHBpeFRpcG86ICdjcGYnLFxuICAgICAgICBwaXhDaGF2ZTogJzEyMzQ1Njc4OTA5JyxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBjb25zdCB1c3VhcmlvSWQgPSAndXN1YXJpby1pZCc7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIGNyaWHDp8OjbyBkZSBwYWdhbWVudG8gY29tIGRhZG9zIG1hc2NhcmFkb3MnLCAoKSA9PiB7XG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBzZXJ2aWNlLmxvZ0NyaWFjYW9QYWdhbWVudG8ocGFnYW1lbnRvLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnUGFnYW1lbnRvIGNyaWFkbycpLFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXVkaXRvcmlhUGFnYW1lbnRvJyksXG4gICAgICApO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcXVlIG8gbG9nIGNvbnTDqW0gZGFkb3MgbWFzY2FyYWRvc1xuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIubG9nLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkubm90LnRvQ29udGFpbignMTIzNDU2Nzg5MDknKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4oJyoqKicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBzZW0gbWFzY2FyYW1lbnRvIHF1YW5kbyBjb25maWd1cmFkbycsICgpID0+IHtcbiAgICAgIC8vIEFsdGVyYXIgY29uZmlndXJhw6fDo28gcGFyYSBuw6NvIG1hc2NhcmFyIGRhZG9zXG4gICAgICBtb2NrQ29uZmlnU2VydmljZS5nZXQubW9ja0ltcGxlbWVudGF0aW9uKChrZXkpID0+IHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ2F1ZGl0b3JpYS5uaXZlbCcpIHtcbiAgICAgICAgICByZXR1cm4gJ2NvbXBsZXRvJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5ID09PSAnYXVkaXRvcmlhLm1hc2NhcmFEYWRvcycpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9KTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dDcmlhY2FvUGFnYW1lbnRvKHBhZ2FtZW50bywgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIubG9nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1BhZ2FtZW50byBjcmlhZG8nKSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0F1ZGl0b3JpYVBhZ2FtZW50bycpLFxuICAgICAgKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHF1ZSBvIGxvZyBjb250w6ltIGRhZG9zIGNvbXBsZXRvc1xuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIubG9nLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50by5pZCk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50by5zb2xpY2l0YWNhb0lkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ011ZGFuY2FTdGF0dXMnLCAoKSA9PiB7XG4gICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkJztcbiAgICBjb25zdCBzdGF0dXNBbnRpZ28gPSBTdGF0dXNQYWdhbWVudG9FbnVtLkFHRU5EQURPO1xuICAgIGNvbnN0IHN0YXR1c05vdm8gPSBTdGF0dXNQYWdhbWVudG9FbnVtLkxJQkVSQURPO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcblxuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgZGUgbXVkYW7Dp2EgZGUgc3RhdHVzJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dNdWRhbmNhU3RhdHVzKFxuICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgc3RhdHVzQW50aWdvLFxuICAgICAgICBzdGF0dXNOb3ZvLFxuICAgICAgICB1c3VhcmlvSWQsXG4gICAgICApO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnU3RhdHVzIGFsdGVyYWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBzdGF0dXNcbiAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBtb2NrTG9nZ2VyLmxvZy5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihzdGF0dXNBbnRpZ28pO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihzdGF0dXNOb3ZvKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbG9nQ2FuY2VsYW1lbnRvUGFnYW1lbnRvJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgbW90aXZvID0gJ1BhZ2FtZW50byBjYW5jZWxhZG8gYSBwZWRpZG8gZG8gYmVuZWZpY2nDoXJpbyc7XG4gICAgY29uc3QgdXN1YXJpb0lkID0gJ3VzdWFyaW8taWQnO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSBjYW5jZWxhbWVudG8gZGUgcGFnYW1lbnRvJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dDYW5jZWxhbWVudG9QYWdhbWVudG8ocGFnYW1lbnRvSWQsIG1vdGl2bywgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdQYWdhbWVudG8gY2FuY2VsYWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvIG1vdGl2b1xuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIud2Fybi5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihtb3Rpdm8pO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihwYWdhbWVudG9JZCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsb2dVcGxvYWRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQnO1xuICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcbiAgICBjb25zdCBub21lQXJxdWl2byA9ICdjb21wcm92YW50ZS5wZGYnO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSB1cGxvYWQgZGUgY29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBzZXJ2aWNlLmxvZ1VwbG9hZENvbXByb3ZhbnRlKFxuICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgY29tcHJvdmFudGVJZCxcbiAgICAgICAgbm9tZUFycXVpdm8sXG4gICAgICAgIHVzdWFyaW9JZCxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdDb21wcm92YW50ZSBlbnZpYWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBkYWRvcyBkbyBjb21wcm92YW50ZVxuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIubG9nLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50b0lkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4oY29tcHJvdmFudGVJZCk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKG5vbWVBcnF1aXZvKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ1JlbW9jYW9Db21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQnO1xuICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcbiAgICBjb25zdCBtb3Rpdm8gPSAnRG9jdW1lbnRvIGluY29ycmV0byc7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIHJlbW/Dp8OjbyBkZSBjb21wcm92YW50ZScsICgpID0+IHtcbiAgICAgIC8vIEV4ZWN1dGFyIG3DqXRvZG9cbiAgICAgIHNlcnZpY2UubG9nUmVtb2Nhb0NvbXByb3ZhbnRlKFxuICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgY29tcHJvdmFudGVJZCxcbiAgICAgICAgbW90aXZvLFxuICAgICAgICB1c3VhcmlvSWQsXG4gICAgICApO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci53YXJuKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0NvbXByb3ZhbnRlIHJlbW92aWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBkYWRvcyBkYSByZW1vw6fDo29cbiAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBtb2NrTG9nZ2VyLndhcm4ubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihjb21wcm92YW50ZUlkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4obW90aXZvKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ0NvbmZpcm1hY2FvUmVjZWJpbWVudG8nLCAoKSA9PiB7XG4gICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkJztcbiAgICBjb25zdCBjb25maXJtYWNhb0lkID0gJ2NvbmZpcm1hY2FvLWlkJztcbiAgICBjb25zdCB1c3VhcmlvSWQgPSAndXN1YXJpby1pZCc7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIGNvbmZpcm1hw6fDo28gZGUgcmVjZWJpbWVudG8nLCAoKSA9PiB7XG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBzZXJ2aWNlLmxvZ0NvbmZpcm1hY2FvUmVjZWJpbWVudG8ocGFnYW1lbnRvSWQsIGNvbmZpcm1hY2FvSWQsIHVzdWFyaW9JZCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdSZWNlYmltZW50byBjb25maXJtYWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBkYWRvcyBkYSBjb25maXJtYcOnw6NvXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci5sb2cubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihjb25maXJtYWNhb0lkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ0Vycm9Qcm9jZXNzYW1lbnRvJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgZXJybyA9IG5ldyBFcnJvcignRXJybyBhbyBwcm9jZXNzYXIgcGFnYW1lbnRvJyk7XG4gICAgY29uc3QgY29udGV4dG8gPSAnYXR1YWxpemFyU3RhdHVzJztcblxuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgZGUgZXJybyBkZSBwcm9jZXNzYW1lbnRvJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dFcnJvUHJvY2Vzc2FtZW50byhwYWdhbWVudG9JZCwgZXJybywgY29udGV4dG8pO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdFcnJvIGFvIHByb2Nlc3NhciBwYWdhbWVudG8nKSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0F1ZGl0b3JpYVBhZ2FtZW50bycpLFxuICAgICAgKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHF1ZSBvIGxvZyBjb250w6ltIG9zIGRhZG9zIGRvIGVycm9cbiAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBtb2NrTG9nZ2VyLmVycm9yLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50b0lkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4oY29udGV4dG8pO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihlcnJvLm1lc3NhZ2UpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9