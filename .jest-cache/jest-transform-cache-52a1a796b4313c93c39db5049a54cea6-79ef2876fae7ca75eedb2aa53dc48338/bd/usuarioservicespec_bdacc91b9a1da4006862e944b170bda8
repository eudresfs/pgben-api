086794615b3cbf7bf9732b5ad42e9511
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
// Mock do bcrypt
jest.mock('bcrypt', () => ({
    hash: jest.fn().mockResolvedValue('hashedPassword'),
    compare: jest.fn().mockResolvedValue(true),
}));
const testing_1 = require("@nestjs/testing");
const usuario_service_1 = require("./usuario.service");
const usuario_repository_1 = require("../repositories/usuario.repository");
const typeorm_1 = require("typeorm");
const usuario_errors_1 = require("../errors/usuario.errors");
const bcrypt = __importStar(require("bcrypt"));
/**
 * Testes unitários para o UsuarioService
 *
 * Cobertura de testes:
 * - Criação de usuários
 * - Busca de usuários
 * - Atualização de dados
 * - Validação de credenciais
 * - Sistema de bloqueio por tentativas
 * - Remoção de usuários
 */
describe('UsuarioService', () => {
    let service;
    let repository;
    let dataSource;
    const mockUsuario = {
        id: '123e4567-e89b-12d3-a456-426614174000',
        nome: 'João Silva',
        email: 'joao.silva@semtas.natal.gov.br',
        cpf: '12345678901',
        telefone: '(84) 99999-9999',
        matricula: 'SEMTAS001',
        senhaHash: 'hashedPassword',
        role_id: 'role-id',
        role: null,
        unidadeId: 'unidade-id',
        unidade: null,
        setorId: 'setor-id',
        setor: null,
        status: 'ativo',
        primeiro_acesso: true,
        ultimo_login: null,
        tentativas_login: 0,
        created_at: new Date(),
        updated_at: new Date(),
        removed_at: null,
        refreshTokens: [],
    };
    beforeEach(async () => {
        const mockRepository = {
            findAll: jest.fn(),
            findById: jest.fn(),
            findByEmail: jest.fn(),
            findByCpf: jest.fn(),
            findByMatricula: jest.fn(),
            create: jest.fn(),
            update: jest.fn(),
            updateStatus: jest.fn(),
            updateSenha: jest.fn(),
            remove: jest.fn(),
        };
        const mockDataSource = {
            transaction: jest
                .fn()
                .mockImplementation((callbackOrIsolation, callback) => {
                // Se apenas um parâmetro for passado, é o callback
                if (typeof callbackOrIsolation === 'function') {
                    return callbackOrIsolation({});
                }
                // Se dois parâmetros, o segundo é o callback
                return callback({});
            }),
            getRepository: jest.fn(),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                usuario_service_1.UsuarioService,
                {
                    provide: usuario_repository_1.UsuarioRepository,
                    useValue: mockRepository,
                },
                {
                    provide: typeorm_1.DataSource,
                    useValue: mockDataSource,
                },
            ],
        }).compile();
        service = module.get(usuario_service_1.UsuarioService);
        repository = module.get(usuario_repository_1.UsuarioRepository);
        dataSource = module.get(typeorm_1.DataSource);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe('findById', () => {
        it('deve retornar um usuário quando encontrado', async () => {
            repository.findById.mockResolvedValue(mockUsuario);
            const result = await service.findById('123e4567-e89b-12d3-a456-426614174000');
            // O service remove a senhaHash do retorno
            const { senhaHash, ...expectedResult } = mockUsuario;
            expect(result).toEqual(expectedResult);
            expect(repository.findById).toHaveBeenCalledWith('123e4567-e89b-12d3-a456-426614174000');
        });
        it('deve lançar UsuarioError quando usuário não encontrado', async () => {
            repository.findById.mockRejectedValue(new usuario_errors_1.UsuarioError('USUARIO_NOT_FOUND', 'Usuário não encontrado', {
                id: 'invalid-id',
            }));
            await expect(service.findById('invalid-id')).rejects.toThrow(usuario_errors_1.UsuarioError);
        });
    });
    describe('findByEmail', () => {
        it('deve retornar usuário quando email existe', async () => {
            repository.findByEmail.mockResolvedValue(mockUsuario);
            const result = await service.findByEmail('joao.silva@semtas.natal.gov.br');
            expect(result).toEqual(mockUsuario);
            expect(repository.findByEmail).toHaveBeenCalledWith('joao.silva@semtas.natal.gov.br');
        });
        it('deve normalizar email para minúsculas', async () => {
            repository.findByEmail.mockResolvedValue(mockUsuario);
            await service.findByEmail('JOAO.SILVA@SEMTAS.NATAL.GOV.BR');
            expect(repository.findByEmail).toHaveBeenCalledWith('joao.silva@semtas.natal.gov.br');
        });
        it('deve retornar null quando email não existe', async () => {
            repository.findByEmail.mockResolvedValue(null);
            const result = await service.findByEmail('inexistente@email.com');
            expect(result).toBeNull();
        });
    });
    describe('validateUserCredentials', () => {
        beforeEach(() => {
            jest
                .spyOn(bcrypt, 'compare')
                .mockImplementation(() => Promise.resolve(true));
        });
        it('deve retornar usuário quando credenciais são válidas', async () => {
            const usuarioAtivo = { ...mockUsuario, tentativas_login: 0 };
            repository.findByEmail.mockResolvedValue(usuarioAtivo);
            repository.updateStatus.mockResolvedValue(usuarioAtivo);
            const mockTransaction = jest.fn().mockImplementation((callback) => {
                const mockManager = {
                    getRepository: jest.fn().mockReturnValue({
                        update: jest.fn().mockResolvedValue({}),
                    }),
                };
                return callback(mockManager);
            });
            dataSource.transaction.mockImplementation(mockTransaction);
            const result = await service.validateUserCredentials('joao.silva@semtas.natal.gov.br', 'senha123');
            expect(result).toEqual(usuarioAtivo);
        });
        it('deve retornar null quando email não existe', async () => {
            repository.findByEmail.mockResolvedValue(null);
            const result = await service.validateUserCredentials('inexistente@email.com', 'senha123');
            expect(result).toBeNull();
        });
        it('deve lançar UsuarioError quando usuário está bloqueado', async () => {
            const usuarioBloqueado = {
                ...mockUsuario,
                tentativas_login: 5,
                ultimo_login: new Date(), // Tentativa recente
            };
            repository.findByEmail.mockResolvedValue(usuarioBloqueado);
            await expect(service.validateUserCredentials('joao.silva@semtas.natal.gov.br', 'senha123')).rejects.toThrow(usuario_errors_1.UsuarioError);
        });
        it('deve retornar null e incrementar tentativas quando senha é inválida', async () => {
            jest
                .spyOn(bcrypt, 'compare')
                .mockImplementation(() => Promise.resolve(false));
            repository.findByEmail.mockResolvedValue(mockUsuario);
            const mockTransaction = jest.fn().mockImplementation((callback) => {
                const mockManager = {
                    getRepository: jest.fn().mockReturnValue({
                        increment: jest.fn().mockResolvedValue({}),
                        update: jest.fn().mockResolvedValue({}),
                    }),
                };
                return callback(mockManager);
            });
            dataSource.transaction.mockImplementation(mockTransaction);
            const result = await service.validateUserCredentials('joao.silva@semtas.natal.gov.br', 'senhaerrada');
            expect(result).toBeNull();
            expect(dataSource.transaction).toHaveBeenCalled();
        });
    });
    describe('create', () => {
        const createUsuarioDto = {
            nome: 'João da Silva',
            email: 'joao.silva@semtas.natal.gov.br',
            senha: 'Senha@123',
            cpf: '123.456.789-00',
            telefone: '(84) 99999-9999',
            matricula: '12345',
            role_id: 'ASSISTENTE_SOCIAL',
            unidadeId: 'unidade-123',
            setorId: 'setor-123',
        };
        it('deve criar usuário com sucesso', async () => {
            const mockManager = {
                getRepository: jest.fn().mockImplementation((entity) => {
                    if (entity === 'usuario') {
                        return {
                            findOne: jest.fn().mockResolvedValue(null),
                            create: jest.fn().mockReturnValue(mockUsuario),
                            save: jest.fn().mockResolvedValue(mockUsuario),
                        };
                    }
                    if (entity === 'unidade') {
                        return {
                            findOne: jest.fn().mockResolvedValue({ id: 'unidade-123' }),
                        };
                    }
                    if (entity === 'setor') {
                        return {
                            findOne: jest.fn().mockResolvedValue({ id: 'setor-123' }),
                        };
                    }
                }),
            };
            dataSource.transaction.mockImplementationOnce((callback) => callback(mockManager));
            const result = await service.create(createUsuarioDto);
            expect(result.data).toBeDefined();
            expect(dataSource.transaction).toHaveBeenCalled();
        });
        it('deve lançar UsuarioError quando email já existe', async () => {
            const mockManager = {
                getRepository: jest.fn().mockImplementation((entity) => {
                    if (entity === 'usuario') {
                        return {
                            findOne: jest.fn().mockResolvedValue(mockUsuario),
                        };
                    }
                }),
            };
            dataSource.transaction.mockImplementationOnce((callback) => callback(mockManager));
            await expect(service.create(createUsuarioDto)).rejects.toThrow(usuario_errors_1.UsuarioError);
        });
        it('deve lançar UsuarioError quando CPF já existe', async () => {
            const mockManager = {
                getRepository: jest.fn().mockImplementation((entity) => {
                    if (entity === 'usuario') {
                        return {
                            findOne: jest.fn().mockImplementation((options) => {
                                if (options.where.email) {
                                    return null;
                                }
                                if (options.where.cpf) {
                                    return mockUsuario;
                                }
                                return null;
                            }),
                        };
                    }
                }),
            };
            dataSource.transaction.mockImplementationOnce((callback) => callback(mockManager));
            await expect(service.create(createUsuarioDto)).rejects.toThrow('CPF já está em uso');
        });
        it('deve lançar UsuarioError quando matrícula já existe', async () => {
            const mockManager = {
                getRepository: jest.fn().mockImplementation((entity) => {
                    if (entity === 'usuario') {
                        return {
                            findOne: jest.fn().mockImplementation((options) => {
                                if (options.where.email) {
                                    return null;
                                }
                                if (options.where.cpf) {
                                    return null;
                                }
                                if (options.where.matricula) {
                                    return mockUsuario;
                                }
                                return null;
                            }),
                        };
                    }
                }),
            };
            dataSource.transaction.mockImplementationOnce((callback) => callback(mockManager));
            await expect(service.create(createUsuarioDto)).rejects.toThrow(usuario_errors_1.UsuarioError);
        });
    });
    describe('remove', () => {
        it('deve remover usuário com sucesso', async () => {
            repository.findById.mockResolvedValue(mockUsuario);
            repository.remove.mockResolvedValue();
            await service.remove('123e4567-e89b-12d3-a456-426614174000');
            expect(repository.remove).toHaveBeenCalledWith('123e4567-e89b-12d3-a456-426614174000');
        });
        it('deve lançar UsuarioError quando usuário não existe', async () => {
            repository.findById.mockRejectedValue(new usuario_errors_1.UsuarioError('USUARIO_NOT_FOUND', 'Usuário não encontrado', {
                id: 'invalid-id',
            }));
            await expect(service.remove('invalid-id')).rejects.toThrow(usuario_errors_1.UsuarioError);
        });
    });
    describe('getProfile', () => {
        it('deve retornar perfil do usuário', async () => {
            repository.findById.mockResolvedValue(mockUsuario);
            const result = await service.getProfile('123e4567-e89b-12d3-a456-426614174000');
            // O service remove a senhaHash do retorno
            const { senhaHash, ...expectedResult } = mockUsuario;
            expect(result).toEqual(expectedResult);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHNlcnZpY2VzXFx1c3VhcmlvLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU9BLGlCQUFpQjtBQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3pCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUM7SUFDbkQsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7Q0FDM0MsQ0FBQyxDQUFDLENBQUM7QUFYSiw2Q0FBc0Q7QUFDdEQsdURBQW1EO0FBQ25ELDJFQUF1RTtBQUN2RSxxQ0FBcUM7QUFDckMsNkRBQXdEO0FBU3hELCtDQUFpQztBQUVqQzs7Ozs7Ozs7OztHQVVHO0FBQ0gsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtJQUM5QixJQUFJLE9BQXVCLENBQUM7SUFDNUIsSUFBSSxVQUEwQyxDQUFDO0lBQy9DLElBQUksVUFBbUMsQ0FBQztJQUV4QyxNQUFNLFdBQVcsR0FBRztRQUNsQixFQUFFLEVBQUUsc0NBQXNDO1FBQzFDLElBQUksRUFBRSxZQUFZO1FBQ2xCLEtBQUssRUFBRSxnQ0FBZ0M7UUFDdkMsR0FBRyxFQUFFLGFBQWE7UUFDbEIsUUFBUSxFQUFFLGlCQUFpQjtRQUMzQixTQUFTLEVBQUUsV0FBVztRQUN0QixTQUFTLEVBQUUsZ0JBQWdCO1FBQzNCLE9BQU8sRUFBRSxTQUFTO1FBQ2xCLElBQUksRUFBRSxJQUFJO1FBQ1YsU0FBUyxFQUFFLFlBQVk7UUFDdkIsT0FBTyxFQUFFLElBQUk7UUFDYixPQUFPLEVBQUUsVUFBVTtRQUNuQixLQUFLLEVBQUUsSUFBSTtR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QUFLLElBQUksRUFBRTtZQUNsRSxVQUFVLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUNuQyxJQUFJLDZCQUFZLENBQUMsbUJBQW1CLEVBQUUsd0JBQXdCLEVBQUU7Z0JBQzlELEVBQUUsRUFBRSxZQUFZO2FBQ2pCLENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsNkJBQVksQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtRQUMxQixFQUFFLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDL0MsVUFBVSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUVuRCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQ3JDLHNDQUFzQyxDQUN2QyxDQUFDO1lBRUYsMENBQTBDO1lBQzFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxjQUFjLEVBQUUsR0FBRyxXQUFXLENBQUM7WUFDckQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHNlcnZpY2VzXFx1c3VhcmlvLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IFVzdWFyaW9TZXJ2aWNlIH0gZnJvbSAnLi91c3VhcmlvLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXN1YXJpb1JlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3JpZXMvdXN1YXJpby5yZXBvc2l0b3J5JztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IFVzdWFyaW9FcnJvciB9IGZyb20gJy4uL2Vycm9ycy91c3VhcmlvLmVycm9ycyc7XG5pbXBvcnQgeyBVc3VhcmlvIH0gZnJvbSAnLi4vZW50aXRpZXMvdXN1YXJpby5lbnRpdHknO1xuXG4vLyBNb2NrIGRvIGJjcnlwdFxuamVzdC5tb2NrKCdiY3J5cHQnLCAoKSA9PiAoe1xuICBoYXNoOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ2hhc2hlZFBhc3N3b3JkJyksXG4gIGNvbXBhcmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKSxcbn0pKTtcblxuaW1wb3J0ICogYXMgYmNyeXB0IGZyb20gJ2JjcnlwdCc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIFVzdWFyaW9TZXJ2aWNlXG4gKlxuICogQ29iZXJ0dXJhIGRlIHRlc3RlczpcbiAqIC0gQ3JpYcOnw6NvIGRlIHVzdcOhcmlvc1xuICogLSBCdXNjYSBkZSB1c3XDoXJpb3NcbiAqIC0gQXR1YWxpemHDp8OjbyBkZSBkYWRvc1xuICogLSBWYWxpZGHDp8OjbyBkZSBjcmVkZW5jaWFpc1xuICogLSBTaXN0ZW1hIGRlIGJsb3F1ZWlvIHBvciB0ZW50YXRpdmFzXG4gKiAtIFJlbW/Dp8OjbyBkZSB1c3XDoXJpb3NcbiAqL1xuZGVzY3JpYmUoJ1VzdWFyaW9TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogVXN1YXJpb1NlcnZpY2U7XG4gIGxldCByZXBvc2l0b3J5OiBqZXN0Lk1vY2tlZDxVc3VhcmlvUmVwb3NpdG9yeT47XG4gIGxldCBkYXRhU291cmNlOiBqZXN0Lk1vY2tlZDxEYXRhU291cmNlPjtcblxuICBjb25zdCBtb2NrVXN1YXJpbyA9IHtcbiAgICBpZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgbm9tZTogJ0pvw6NvIFNpbHZhJyxcbiAgICBlbWFpbDogJ2pvYW8uc2lsdmFAc2VtdGFzLm5hdGFsLmdvdi5icicsXG4gICAgY3BmOiAnMTIzNDU2Nzg5MDEnLFxuICAgIHRlbGVmb25lOiAnKDg0KSA5OTk5OS05OTk5JyxcbiAgICBtYXRyaWN1bGE6ICdTRU1UQVMwMDEnLFxuICAgIHNlbmhhSGFzaDogJ2hhc2hlZFBhc3N3b3JkJyxcbiAgICByb2xlX2lkOiAncm9sZS1pZCcsXG4gICAgcm9sZTogbnVsbCxcbiAgICB1bmlkYWRlSWQ6ICd1bmlkYWRlLWlkJyxcbiAgICB1bmlkYWRlOiBudWxsLFxuICAgIHNldG9ySWQ6ICdzZXRvci1pZCcsXG4gICAgc2V0b3I6IG51bGwsXG4gICAgc3RhdHVzOiAnYXRpdm8nLFxuICAgIHByaW1laXJvX2FjZXNzbzogdHJ1ZSxcbiAgICB1bHRpbW9fbG9naW46IG51bGwsXG4gICAgdGVudGF0aXZhc19sb2dpbjogMCxcbiAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLFxuICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCksXG4gICAgcmVtb3ZlZF9hdDogbnVsbCxcbiAgICByZWZyZXNoVG9rZW5zOiBbXSxcbiAgfSBhcyBhbnk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9ja1JlcG9zaXRvcnkgPSB7XG4gICAgICBmaW5kQWxsOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQnlJZDogamVzdC5mbigpLFxuICAgICAgZmluZEJ5RW1haWw6IGplc3QuZm4oKSxcbiAgICAgIGZpbmRCeUNwZjogamVzdC5mbigpLFxuICAgICAgZmluZEJ5TWF0cmljdWxhOiBqZXN0LmZuKCksXG4gICAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxuICAgICAgdXBkYXRlU3RhdHVzOiBqZXN0LmZuKCksXG4gICAgICB1cGRhdGVTZW5oYTogamVzdC5mbigpLFxuICAgICAgcmVtb3ZlOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tEYXRhU291cmNlID0ge1xuICAgICAgdHJhbnNhY3Rpb246IGplc3RcbiAgICAgICAgLmZuKClcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoY2FsbGJhY2tPcklzb2xhdGlvbiwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgICAvLyBTZSBhcGVuYXMgdW0gcGFyw6JtZXRybyBmb3IgcGFzc2Fkbywgw6kgbyBjYWxsYmFja1xuICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tPcklzb2xhdGlvbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrT3JJc29sYXRpb24oe30pO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBTZSBkb2lzIHBhcsOibWV0cm9zLCBvIHNlZ3VuZG8gw6kgbyBjYWxsYmFja1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjayh7fSk7XG4gICAgICAgIH0pLFxuICAgICAgZ2V0UmVwb3NpdG9yeTogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFVzdWFyaW9TZXJ2aWNlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogVXN1YXJpb1JlcG9zaXRvcnksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tSZXBvc2l0b3J5LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogRGF0YVNvdXJjZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0RhdGFTb3VyY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PFVzdWFyaW9TZXJ2aWNlPihVc3VhcmlvU2VydmljZSk7XG4gICAgcmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQoVXN1YXJpb1JlcG9zaXRvcnkpO1xuICAgIGRhdGFTb3VyY2UgPSBtb2R1bGUuZ2V0KERhdGFTb3VyY2UpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZmluZEJ5SWQnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgdW0gdXN1w6FyaW8gcXVhbmRvIGVuY29udHJhZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXBvc2l0b3J5LmZpbmRCeUlkLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc3VhcmlvKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5maW5kQnlJZChcbiAgICAgICAgJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICApO1xuXG4gICAgICAvLyBPIHNlcnZpY2UgcmVtb3ZlIGEgc2VuaGFIYXNoIGRvIHJldG9ybm9cbiAgICAgIGNvbnN0IHsgc2VuaGFIYXNoLCAuLi5leHBlY3RlZFJlc3VsdCB9ID0gbW9ja1VzdWFyaW87XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGV4cGVjdGVkUmVzdWx0KTtcbiAgICAgIGV4cGVjdChyZXBvc2l0b3J5LmZpbmRCeUlkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBVc3VhcmlvRXJyb3IgcXVhbmRvIHVzdcOhcmlvIG7Do28gZW5jb250cmFkbycsIGFzeW5jICgpID0+IHtcbiAgICAgIHJlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1JlamVjdGVkVmFsdWUoXG4gICAgICAgIG5ldyBVc3VhcmlvRXJyb3IoJ1VTVUFSSU9fTk9UX0ZPVU5EJywgJ1VzdcOhcmlvIG7Do28gZW5jb250cmFkbycsIHtcbiAgICAgICAgICBpZDogJ2ludmFsaWQtaWQnLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmZpbmRCeUlkKCdpbnZhbGlkLWlkJykpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgVXN1YXJpb0Vycm9yLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2ZpbmRCeUVtYWlsJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIHVzdcOhcmlvIHF1YW5kbyBlbWFpbCBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXBvc2l0b3J5LmZpbmRCeUVtYWlsLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc3VhcmlvKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5maW5kQnlFbWFpbChcbiAgICAgICAgJ2pvYW8uc2lsdmFAc2VtdGFzLm5hdGFsLmdvdi5icicsXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc3VhcmlvKTtcbiAgICAgIGV4cGVjdChyZXBvc2l0b3J5LmZpbmRCeUVtYWlsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2pvYW8uc2lsdmFAc2VtdGFzLm5hdGFsLmdvdi5icicsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbm9ybWFsaXphciBlbWFpbCBwYXJhIG1pbsO6c2N1bGFzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmVwb3NpdG9yeS5maW5kQnlFbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXN1YXJpbyk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuZmluZEJ5RW1haWwoJ0pPQU8uU0lMVkFAU0VNVEFTLk5BVEFMLkdPVi5CUicpO1xuXG4gICAgICBleHBlY3QocmVwb3NpdG9yeS5maW5kQnlFbWFpbCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdqb2FvLnNpbHZhQHNlbXRhcy5uYXRhbC5nb3YuYnInLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJldG9ybmFyIG51bGwgcXVhbmRvIGVtYWlsIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmVwb3NpdG9yeS5maW5kQnlFbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5maW5kQnlFbWFpbCgnaW5leGlzdGVudGVAZW1haWwuY29tJyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2YWxpZGF0ZVVzZXJDcmVkZW50aWFscycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGJjcnlwdCwgJ2NvbXBhcmUnKVxuICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh0cnVlKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZXRvcm5hciB1c3XDoXJpbyBxdWFuZG8gY3JlZGVuY2lhaXMgc8OjbyB2w6FsaWRhcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzdWFyaW9BdGl2byA9IHsgLi4ubW9ja1VzdWFyaW8sIHRlbnRhdGl2YXNfbG9naW46IDAgfTtcbiAgICAgIHJlcG9zaXRvcnkuZmluZEJ5RW1haWwubW9ja1Jlc29sdmVkVmFsdWUodXN1YXJpb0F0aXZvKTtcbiAgICAgIHJlcG9zaXRvcnkudXBkYXRlU3RhdHVzLm1vY2tSZXNvbHZlZFZhbHVlKHVzdWFyaW9BdGl2byk7XG5cbiAgICAgIGNvbnN0IG1vY2tUcmFuc2FjdGlvbiA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGNhbGxiYWNrKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tNYW5hZ2VyID0ge1xuICAgICAgICAgIGdldFJlcG9zaXRvcnk6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobW9ja01hbmFnZXIpO1xuICAgICAgfSk7XG4gICAgICBkYXRhU291cmNlLnRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbihtb2NrVHJhbnNhY3Rpb24pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnZhbGlkYXRlVXNlckNyZWRlbnRpYWxzKFxuICAgICAgICAnam9hby5zaWx2YUBzZW10YXMubmF0YWwuZ292LmJyJyxcbiAgICAgICAgJ3NlbmhhMTIzJyxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwodXN1YXJpb0F0aXZvKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJldG9ybmFyIG51bGwgcXVhbmRvIGVtYWlsIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmVwb3NpdG9yeS5maW5kQnlFbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS52YWxpZGF0ZVVzZXJDcmVkZW50aWFscyhcbiAgICAgICAgJ2luZXhpc3RlbnRlQGVtYWlsLmNvbScsXG4gICAgICAgICdzZW5oYTEyMycsXG4gICAgICApO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBVc3VhcmlvRXJyb3IgcXVhbmRvIHVzdcOhcmlvIGVzdMOhIGJsb3F1ZWFkbycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzdWFyaW9CbG9xdWVhZG8gPSB7XG4gICAgICAgIC4uLm1vY2tVc3VhcmlvLFxuICAgICAgICB0ZW50YXRpdmFzX2xvZ2luOiA1LFxuICAgICAgICB1bHRpbW9fbG9naW46IG5ldyBEYXRlKCksIC8vIFRlbnRhdGl2YSByZWNlbnRlXG4gICAgICB9O1xuICAgICAgcmVwb3NpdG9yeS5maW5kQnlFbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZSh1c3VhcmlvQmxvcXVlYWRvKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBzZXJ2aWNlLnZhbGlkYXRlVXNlckNyZWRlbnRpYWxzKFxuICAgICAgICAgICdqb2FvLnNpbHZhQHNlbXRhcy5uYXRhbC5nb3YuYnInLFxuICAgICAgICAgICdzZW5oYTEyMycsXG4gICAgICAgICksXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhVc3VhcmlvRXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgbnVsbCBlIGluY3JlbWVudGFyIHRlbnRhdGl2YXMgcXVhbmRvIHNlbmhhIMOpIGludsOhbGlkYScsIGFzeW5jICgpID0+IHtcbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGJjcnlwdCwgJ2NvbXBhcmUnKVxuICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZShmYWxzZSkpO1xuICAgICAgcmVwb3NpdG9yeS5maW5kQnlFbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXN1YXJpbyk7XG5cbiAgICAgIGNvbnN0IG1vY2tUcmFuc2FjdGlvbiA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGNhbGxiYWNrKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tNYW5hZ2VyID0ge1xuICAgICAgICAgIGdldFJlcG9zaXRvcnk6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgaW5jcmVtZW50OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pLFxuICAgICAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobW9ja01hbmFnZXIpO1xuICAgICAgfSk7XG4gICAgICBkYXRhU291cmNlLnRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbihtb2NrVHJhbnNhY3Rpb24pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnZhbGlkYXRlVXNlckNyZWRlbnRpYWxzKFxuICAgICAgICAnam9hby5zaWx2YUBzZW10YXMubmF0YWwuZ292LmJyJyxcbiAgICAgICAgJ3NlbmhhZXJyYWRhJyxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QoZGF0YVNvdXJjZS50cmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlJywgKCkgPT4ge1xuICAgIGNvbnN0IGNyZWF0ZVVzdWFyaW9EdG8gPSB7XG4gICAgICBub21lOiAnSm/Do28gZGEgU2lsdmEnLFxuICAgICAgZW1haWw6ICdqb2FvLnNpbHZhQHNlbXRhcy5uYXRhbC5nb3YuYnInLFxuICAgICAgc2VuaGE6ICdTZW5oYUAxMjMnLFxuICAgICAgY3BmOiAnMTIzLjQ1Ni43ODktMDAnLFxuICAgICAgdGVsZWZvbmU6ICcoODQpIDk5OTk5LTk5OTknLFxuICAgICAgbWF0cmljdWxhOiAnMTIzNDUnLFxuICAgICAgcm9sZV9pZDogJ0FTU0lTVEVOVEVfU09DSUFMJyxcbiAgICAgIHVuaWRhZGVJZDogJ3VuaWRhZGUtMTIzJyxcbiAgICAgIHNldG9ySWQ6ICdzZXRvci0xMjMnLFxuICAgIH07XG5cbiAgICBpdCgnZGV2ZSBjcmlhciB1c3XDoXJpbyBjb20gc3VjZXNzbycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tNYW5hZ2VyID0ge1xuICAgICAgICBnZXRSZXBvc2l0b3J5OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChlbnRpdHkpID0+IHtcbiAgICAgICAgICBpZiAoZW50aXR5ID09PSAndXN1YXJpbycpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKSxcbiAgICAgICAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tVc3VhcmlvKSxcbiAgICAgICAgICAgICAgc2F2ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc3VhcmlvKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChlbnRpdHkgPT09ICd1bmlkYWRlJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd1bmlkYWRlLTEyMycgfSksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZW50aXR5ID09PSAnc2V0b3InKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ3NldG9yLTEyMycgfSksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICAoZGF0YVNvdXJjZS50cmFuc2FjdGlvbiBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKGNhbGxiYWNrKSA9PlxuICAgICAgICBjYWxsYmFjayhtb2NrTWFuYWdlciksXG4gICAgICApO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmNyZWF0ZShjcmVhdGVVc3VhcmlvRHRvKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGRhdGFTb3VyY2UudHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgVXN1YXJpb0Vycm9yIHF1YW5kbyBlbWFpbCBqw6EgZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja01hbmFnZXIgPSB7XG4gICAgICAgIGdldFJlcG9zaXRvcnk6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGVudGl0eSkgPT4ge1xuICAgICAgICAgIGlmIChlbnRpdHkgPT09ICd1c3VhcmlvJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc3VhcmlvKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgIH07XG5cbiAgICAgIChkYXRhU291cmNlLnRyYW5zYWN0aW9uIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoY2FsbGJhY2spID0+XG4gICAgICAgIGNhbGxiYWNrKG1vY2tNYW5hZ2VyKSxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmNyZWF0ZShjcmVhdGVVc3VhcmlvRHRvKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBVc3VhcmlvRXJyb3IsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBVc3VhcmlvRXJyb3IgcXVhbmRvIENQRiBqw6EgZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja01hbmFnZXIgPSB7XG4gICAgICAgIGdldFJlcG9zaXRvcnk6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGVudGl0eSkgPT4ge1xuICAgICAgICAgIGlmIChlbnRpdHkgPT09ICd1c3VhcmlvJykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigob3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLndoZXJlLmVtYWlsKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMud2hlcmUuY3BmKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbW9ja1VzdWFyaW87XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgIH07XG5cbiAgICAgIChkYXRhU291cmNlLnRyYW5zYWN0aW9uIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uT25jZSgoY2FsbGJhY2spID0+XG4gICAgICAgIGNhbGxiYWNrKG1vY2tNYW5hZ2VyKSxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmNyZWF0ZShjcmVhdGVVc3VhcmlvRHRvKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICAnQ1BGIGrDoSBlc3TDoSBlbSB1c28nLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgVXN1YXJpb0Vycm9yIHF1YW5kbyBtYXRyw61jdWxhIGrDoSBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrTWFuYWdlciA9IHtcbiAgICAgICAgZ2V0UmVwb3NpdG9yeTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoZW50aXR5KSA9PiB7XG4gICAgICAgICAgaWYgKGVudGl0eSA9PT0gJ3VzdWFyaW8nKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMud2hlcmUuZW1haWwpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy53aGVyZS5jcGYpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy53aGVyZS5tYXRyaWN1bGEpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBtb2NrVXN1YXJpbztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgfTtcblxuICAgICAgKGRhdGFTb3VyY2UudHJhbnNhY3Rpb24gYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb25PbmNlKChjYWxsYmFjaykgPT5cbiAgICAgICAgY2FsbGJhY2sobW9ja01hbmFnZXIpLFxuICAgICAgKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuY3JlYXRlKGNyZWF0ZVVzdWFyaW9EdG8pKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIFVzdWFyaW9FcnJvcixcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZW1vdmUnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmVtb3ZlciB1c3XDoXJpbyBjb20gc3VjZXNzbycsIGFzeW5jICgpID0+IHtcbiAgICAgIHJlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzdWFyaW8pO1xuICAgICAgcmVwb3NpdG9yeS5yZW1vdmUubW9ja1Jlc29sdmVkVmFsdWUoKTtcblxuICAgICAgYXdhaXQgc2VydmljZS5yZW1vdmUoJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcpO1xuXG4gICAgICBleHBlY3QocmVwb3NpdG9yeS5yZW1vdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwJyxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBsYW7Dp2FyIFVzdWFyaW9FcnJvciBxdWFuZG8gdXN1w6FyaW8gbsOjbyBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXBvc2l0b3J5LmZpbmRCeUlkLm1vY2tSZWplY3RlZFZhbHVlKFxuICAgICAgICBuZXcgVXN1YXJpb0Vycm9yKCdVU1VBUklPX05PVF9GT1VORCcsICdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nLCB7XG4gICAgICAgICAgaWQ6ICdpbnZhbGlkLWlkJyxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5yZW1vdmUoJ2ludmFsaWQtaWQnKSkucmVqZWN0cy50b1Rocm93KFVzdWFyaW9FcnJvcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRQcm9maWxlJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIHBlcmZpbCBkbyB1c3XDoXJpbycsIGFzeW5jICgpID0+IHtcbiAgICAgIHJlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzdWFyaW8pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmdldFByb2ZpbGUoXG4gICAgICAgICcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAnLFxuICAgICAgKTtcblxuICAgICAgLy8gTyBzZXJ2aWNlIHJlbW92ZSBhIHNlbmhhSGFzaCBkbyByZXRvcm5vXG4gICAgICBjb25zdCB7IHNlbmhhSGFzaCwgLi4uZXhwZWN0ZWRSZXN1bHQgfSA9IG1vY2tVc3VhcmlvO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChleHBlY3RlZFJlc3VsdCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=