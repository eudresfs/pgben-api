{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\pagamento\\guards\\pagamento-access.guard.ts","mappings":";;;;;;;;;;;;;AAAA,2CAAkH;AAClH,uCAAyC;AACzC,qEAAiE;AACjE,uFAAkF;AAClF,+FAA0F;AAE1F,8CAA8C;AACjC,QAAA,UAAU,GAAG,mBAAmB,CAAC;AACjC,QAAA,YAAY,GAAG,mBAAmB,CAAC;AAEhD;;;;;;;;;GASG;AAEI,IAAM,oBAAoB,GAA1B,MAAM,oBAAoB;IAErB;IACA;IACA;IACA;IAJV,YACU,SAAoB,EACpB,gBAAkC,EAClC,cAAwC,EACxC,kBAAgD;QAHhD,cAAS,GAAT,SAAS,CAAW;QACpB,qBAAgB,GAAhB,gBAAgB,CAAkB;QAClC,mBAAc,GAAd,cAAc,CAA0B;QACxC,uBAAkB,GAAlB,kBAAkB,CAA8B;IACvD,CAAC;IAEJ;;;;;OAKG;IACH,KAAK,CAAC,WAAW,CAAC,OAAyB;QACzC,MAAM,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CACvD,kBAAU,EACV,CAAC,OAAO,CAAC,UAAU,EAAE,EAAE,OAAO,CAAC,QAAQ,EAAE,CAAC,CAC3C,IAAI,EAAE,CAAC;QAER,MAAM,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CACvD,oBAAY,EACZ,CAAC,OAAO,CAAC,UAAU,EAAE,EAAE,OAAO,CAAC,QAAQ,EAAE,CAAC,CAC3C,IAAI,KAAK,CAAC;QAEX,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC;QAE7B,8CAA8C;QAC9C,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,2BAAkB,CAAC,yBAAyB,CAAC,CAAC;QAC1D,CAAC;QAED,8BAA8B;QAC9B,IAAI,gBAAgB,CAAC,MAAM,GAAG,CAAC,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;YAC9E,MAAM,IAAI,2BAAkB,CAAC,sBAAsB,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QACpF,CAAC;QAED,gCAAgC;QAChC,IAAI,OAAO,CAAC,MAAM,KAAK,aAAa,EAAE,CAAC;YACrC,OAAO,IAAI,CAAC;QACd,CAAC;QAED,oDAAoD;QACpD,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,yCAAyC;QACzC,MAAM,WAAW,GAAG,OAAO,CAAC,MAAM,CAAC,WAAW,IAAI,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC;QACpE,MAAM,cAAc,GAAG,OAAO,CAAC,MAAM,CAAC,cAAc,CAAC;QACrD,MAAM,aAAa,GAAG,OAAO,CAAC,MAAM,CAAC,aAAa,CAAC;QAEnD,8CAA8C;QAC9C,IAAI,WAAW,EAAE,CAAC;YAChB,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,oBAAoB,CAAC,WAAW,CAAC,CAAC;gBAEhF,IAAI,CAAC,SAAS,EAAE,CAAC;oBACf,MAAM,IAAI,0BAAiB,CAAC,0BAA0B,CAAC,CAAC;gBAC1D,CAAC;gBAED,yDAAyD;gBACzD,wCAAwC;gBACxC,MAAM,iBAAiB,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,4BAA4B,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;gBAE9G,IAAI,CAAC,iBAAiB,EAAE,CAAC;oBACvB,MAAM,IAAI,0BAAiB,CAAC,4BAA4B,CAAC,CAAC;gBAC5D,CAAC;gBAED,iCAAiC;gBACjC,MAAM,SAAS,GAAG,iBAAiB,CAAC,SAAS,CAAC;gBAE9C,iEAAiE;gBACjE,IAAI,OAAO,CAAC,SAAS,KAAK,SAAS,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;oBAClE,MAAM,IAAI,2BAAkB,CAAC,uCAAuC,CAAC,CAAC;gBACxE,CAAC;gBAED,4CAA4C;gBAC5C,IAAI,aAAa,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;oBAChD,4DAA4D;oBAC5D,wDAAwD;oBACxD,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;oBAEvE,mDAAmD;oBACnD,IAAI,CAAC,WAAW,IAAI,WAAW,CAAC,aAAa,KAAK,SAAS,CAAC,aAAa,EAAE,CAAC;wBAC1E,MAAM,IAAI,2BAAkB,CAAC,yDAAyD,CAAC,CAAC;oBAC1F,CAAC;gBACH,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,KAAK,YAAY,0BAAiB,EAAE,CAAC;oBACvC,MAAM,KAAK,CAAC;gBACd,CAAC;gBACD,MAAM,IAAI,2BAAkB,CAAC,wCAAwC,CAAC,CAAC;YACzE,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAED,iDAAiD;QACjD,IAAI,cAAc,EAAE,CAAC;YACnB,IAAI,CAAC;gBACH,kFAAkF;gBAClF,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,kBAAkB,CAAC,cAAc,CAAC,CAAC;gBAE7E,IAAI,CAAC,OAAO,EAAE,CAAC;oBACb,MAAM,IAAI,0BAAiB,CAAC,6BAA6B,CAAC,CAAC;gBAC7D,CAAC;gBAED,6DAA6D;gBAC7D,+DAA+D;gBAC/D,MAAM,SAAS,GAAG,OAAO,CAAC,SAAS,IAAI,IAAI,CAAC;gBAE5C,IAAI,SAAS,IAAI,OAAO,CAAC,SAAS,KAAK,SAAS,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;oBAC/E,MAAM,IAAI,2BAAkB,CAAC,yDAAyD,CAAC,CAAC;gBAC1F,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,KAAK,YAAY,0BAAiB,EAAE,CAAC;oBACvC,MAAM,KAAK,CAAC;gBACd,CAAC;gBACD,MAAM,IAAI,2BAAkB,CAAC,wDAAwD,CAAC,CAAC;YACzF,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAED,kCAAkC;QAClC,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AAjIY,oDAAoB;+BAApB,oBAAoB;IADhC,IAAA,mBAAU,GAAE;yDAGU,gBAAS,oBAAT,gBAAS,oDACF,oCAAgB,oBAAhB,oCAAgB,oDAClB,qDAAwB,oBAAxB,qDAAwB,oDACpB,6DAA4B,oBAA5B,6DAA4B;GAL/C,oBAAoB,CAiIhC","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\pagamento\\guards\\pagamento-access.guard.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext, ForbiddenException, NotFoundException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { PagamentoService } from '../services/pagamento.service';\nimport { IntegracaoCidadaoService } from '../services/integracao-cidadao.service';\nimport { IntegracaoSolicitacaoService } from '../services/integracao-solicitacao.service';\n\n// Chaves para metadados de controle de acesso\nexport const PERFIS_KEY = 'perfis_permitidos';\nexport const UNIDADES_KEY = 'verificar_unidade';\n\n/**\n * Guard para controle de acesso aos endpoints do módulo de pagamento\n * \n * Implementa verificações de permissão baseadas em:\n * - Perfil do usuário (admin, operador, etc)\n * - Unidade do usuário vs unidade do pagamento/solicitação\n * - Propriedade do recurso (pagamento, comprovante, confirmação)\n * \n * @author Equipe PGBen\n */\n@Injectable()\nexport class PagamentoAccessGuard implements CanActivate {\n  constructor(\n    private reflector: Reflector,\n    private pagamentoService: PagamentoService,\n    private cidadaoService: IntegracaoCidadaoService,\n    private solicitacaoService: IntegracaoSolicitacaoService,\n  ) {}\n\n  /**\n   * Verifica se o usuário tem permissão para acessar o recurso\n   * \n   * @param context Contexto de execução\n   * @returns true se o usuário tem permissão, false caso contrário\n   */\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const perfisPermitidos = this.reflector.getAllAndOverride<string[]>(\n      PERFIS_KEY,\n      [context.getHandler(), context.getClass()],\n    ) || [];\n\n    const verificarUnidade = this.reflector.getAllAndOverride<boolean>(\n      UNIDADES_KEY,\n      [context.getHandler(), context.getClass()],\n    ) || false;\n\n    const request = context.switchToHttp().getRequest();\n    const usuario = request.user;\n\n    // Se não há usuário autenticado, negar acesso\n    if (!usuario) {\n      throw new ForbiddenException('Usuário não autenticado');\n    }\n\n    // Verificar perfil do usuário\n    if (perfisPermitidos.length > 0 && !perfisPermitidos.includes(usuario.perfil)) {\n      throw new ForbiddenException(`Acesso restrito a: ${perfisPermitidos.join(', ')}`);\n    }\n\n    // Super admin sempre tem acesso\n    if (usuario.perfil === 'super_admin') {\n      return true;\n    }\n\n    // Se não precisa verificar unidade, permitir acesso\n    if (!verificarUnidade) {\n      return true;\n    }\n\n    // Obter IDs dos parâmetros da requisição\n    const pagamentoId = request.params.pagamentoId || request.params.id;\n    const beneficiarioId = request.params.beneficiarioId;\n    const comprovanteId = request.params.comprovanteId;\n\n    // Verificar acesso baseado no ID do pagamento\n    if (pagamentoId) {\n      try {\n        const pagamento = await this.pagamentoService.findOneWithRelations(pagamentoId);\n        \n        if (!pagamento) {\n          throw new NotFoundException('Pagamento não encontrado');\n        }\n\n        // Verificar status da solicitação associada ao pagamento\n        // Usando o método que existe no serviço\n        const solicitacaoStatus = await this.solicitacaoService.verificarSolicitacaoAprovada(pagamento.solicitacaoId);\n        \n        if (!solicitacaoStatus) {\n          throw new NotFoundException('Solicitação não encontrada');\n        }\n        \n        // Obter a unidade da solicitação\n        const unidadeId = solicitacaoStatus.unidadeId;\n\n        // Verificar se o usuário pertence à mesma unidade da solicitação\n        if (usuario.unidadeId !== unidadeId && usuario.perfil !== 'admin') {\n          throw new ForbiddenException('Acesso restrito à unidade responsável');\n        }\n\n        // Verificações adicionais para comprovantes\n        if (comprovanteId && usuario.perfil !== 'admin') {\n          // Verificar se o comprovante existe e pertence ao pagamento\n          // Usando um método genérico que deve existir no serviço\n          const comprovante = await this.pagamentoService.findOne(comprovanteId);\n          \n          // Verificar se o comprovante pertence ao pagamento\n          if (!comprovante || comprovante.solicitacaoId !== pagamento.solicitacaoId) {\n            throw new ForbiddenException('Comprovante não encontrado ou não pertence ao pagamento');\n          }\n        }\n      } catch (error) {\n        if (error instanceof NotFoundException) {\n          throw error;\n        }\n        throw new ForbiddenException('Erro ao verificar permissões de acesso');\n      }\n\n      return true;\n    }\n\n    // Verificar acesso baseado no ID do beneficiário\n    if (beneficiarioId) {\n      try {\n        // Obter informações do beneficiário usando o método correto que existe no serviço\n        const cidadao = await this.cidadaoService.obterDadosPessoais(beneficiarioId);\n        \n        if (!cidadao) {\n          throw new NotFoundException('Beneficiário não encontrado');\n        }\n\n        // Verificar se o usuário pertence à mesma unidade do cidadão\n        // Assumindo que a unidade está disponível nos dados retornados\n        const unidadeId = cidadao.unidadeId || null;\n        \n        if (unidadeId && usuario.unidadeId !== unidadeId && usuario.perfil !== 'admin') {\n          throw new ForbiddenException('Acesso restrito à unidade responsável pelo beneficiário');\n        }\n      } catch (error) {\n        if (error instanceof NotFoundException) {\n          throw error;\n        }\n        throw new ForbiddenException('Erro ao verificar permissões de acesso ao beneficiário');\n      }\n\n      return true;\n    }\n\n    // Se chegou aqui, permitir acesso\n    return true;\n  }\n}\n"],"version":3}