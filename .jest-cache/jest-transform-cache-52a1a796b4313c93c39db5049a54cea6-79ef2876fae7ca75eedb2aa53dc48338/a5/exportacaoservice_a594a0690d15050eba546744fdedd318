cb192414815c448fc3aaf37ab70325b9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var ExportacaoService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExportacaoService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const solicitacao_entity_1 = require("../../../entities/solicitacao.entity");
const tipo_beneficio_entity_1 = require("../../../entities/tipo-beneficio.entity");
/**
 * Serviço de Exportação de Dados
 *
 * Responsável por exportar dados de solicitações de benefícios em diferentes formatos,
 * como CSV, para análise e relatórios.
 */
let ExportacaoService = ExportacaoService_1 = class ExportacaoService {
    solicitacaoRepository;
    tipoBeneficioRepository;
    logger = new common_1.Logger(ExportacaoService_1.name);
    constructor(solicitacaoRepository, tipoBeneficioRepository) {
        this.solicitacaoRepository = solicitacaoRepository;
        this.tipoBeneficioRepository = tipoBeneficioRepository;
    }
    /**
     * Exporta solicitações de benefício em formato CSV
     *
     * @param filtros Filtros para as solicitações a serem exportadas
     * @returns String em formato CSV
     */
    async exportarSolicitacoesCSV(filtros) {
        try {
            // Construir query com filtros opcionais
            const where = {};
            if (filtros?.cidadao_id) {
                where.cidadao_id = filtros.cidadao_id;
            }
            if (filtros?.tipo_beneficio_id) {
                where.tipo_beneficio_id = filtros.tipo_beneficio_id;
            }
            if (filtros?.status) {
                where.status = filtros.status;
            }
            if (filtros?.data_inicio && filtros?.data_fim) {
                where.created_at = {
                    $gte: new Date(filtros.data_inicio),
                    $lte: new Date(filtros.data_fim),
                };
            }
            // Buscar solicitações
            const solicitacoes = await this.solicitacaoRepository.find({
                where,
                relations: ['tipo_beneficio'],
                order: { created_at: 'DESC' },
            });
            // Transformar dados para CSV
            const dados = await this.transformarDadosParaCSV(solicitacoes);
            // Definir cabeçalhos padrão
            const cabecalhosBasicos = [
                'ID',
                'ID do Cidadão',
                'Tipo de Benefício',
                'Status',
                'Data da Solicitação',
                'Última Atualização',
            ];
            // Obter todos os campos dinâmicos
            const camposDinamicos = new Set();
            dados.forEach((item) => {
                Object.keys(item).forEach((key) => {
                    if (![
                        'id',
                        'cidadao_id',
                        'tipo_beneficio',
                        'status',
                        'data_solicitacao',
                        'updated_at',
                    ].includes(key)) {
                        camposDinamicos.add(key);
                    }
                });
            });
            // Montar cabeçalho completo
            const cabecalhoCompleto = [
                ...cabecalhosBasicos,
                ...Array.from(camposDinamicos),
            ];
            // Gerar linha de cabeçalho CSV
            let csv = cabecalhoCompleto.map(this.escaparCampoCSV).join(',') + '\n';
            // Gerar linhas de dados
            dados.forEach((item) => {
                const linha = [
                    this.escaparCampoCSV(item.id || ''),
                    this.escaparCampoCSV(item.cidadao_id || ''),
                    this.escaparCampoCSV(item.tipo_beneficio || ''),
                    this.escaparCampoCSV(item.status || ''),
                    this.escaparCampoCSV(item.data_solicitacao || ''),
                    this.escaparCampoCSV(item.updated_at || ''),
                ];
                // Adicionar campos dinâmicos
                camposDinamicos.forEach((campo) => {
                    linha.push(this.escaparCampoCSV(item[campo] || ''));
                });
                csv += linha.join(',') + '\n';
            });
            return csv;
        }
        catch (error) {
            this.logger.error(`Erro ao exportar solicitações para CSV: ${error.message}`, error.stack);
            throw new Error('Erro ao exportar solicitações para CSV');
        }
    }
    /**
     * Transforma dados de solicitações para o formato CSV
     *
     * @param solicitacoes Lista de solicitações
     * @returns Dados formatados para CSV
     */
    async transformarDadosParaCSV(solicitacoes) {
        return solicitacoes.map((solicitacao) => {
            // Dados básicos
            const dadosBasicos = {
                id: solicitacao.id,
                cidadao_id: solicitacao.beneficiario_id,
                tipo_beneficio: solicitacao.tipo_beneficio?.nome || 'Não especificado',
                status: solicitacao.status,
                data_solicitacao: this.formatarData(solicitacao.created_at),
                updated_at: this.formatarData(solicitacao.updated_at),
            };
            // Adicionar dados dinâmicos
            const dadosDinamicos = solicitacao.dados_dinamicos || {};
            // Mesclar dados básicos com dados dinâmicos
            return {
                ...dadosBasicos,
                ...this.processarDadosDinamicos(dadosDinamicos),
            };
        });
    }
    /**
     * Processa dados dinâmicos para exportação
     *
     * @param dados Dados dinâmicos
     * @returns Dados processados
     */
    processarDadosDinamicos(dados) {
        const resultado = {};
        // Processar cada campo dinâmico
        Object.keys(dados).forEach((chave) => {
            const valor = dados[chave];
            // Processar conforme o tipo
            if (valor === null || valor === undefined) {
                resultado[chave] = '';
            }
            else if (typeof valor === 'object' && valor instanceof Date) {
                resultado[chave] = this.formatarData(valor);
            }
            else if (typeof valor === 'object') {
                resultado[chave] = JSON.stringify(valor);
            }
            else {
                resultado[chave] = String(valor);
            }
        });
        return resultado;
    }
    /**
     * Formata data para string no formato DD/MM/YYYY HH:MM:SS
     *
     * @param data Data a ser formatada
     * @returns Data formatada
     */
    formatarData(data) {
        if (!data) {
            return '';
        }
        const dia = data.getDate().toString().padStart(2, '0');
        const mes = (data.getMonth() + 1).toString().padStart(2, '0');
        const ano = data.getFullYear();
        const hora = data.getHours().toString().padStart(2, '0');
        const minuto = data.getMinutes().toString().padStart(2, '0');
        const segundo = data.getSeconds().toString().padStart(2, '0');
        return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
    }
    /**
     * Escapa um campo para formato CSV
     *
     * @param valor Valor a ser escapado
     * @returns Valor escapado para CSV
     */
    escaparCampoCSV(valor) {
        if (valor === null || valor === undefined) {
            return '';
        }
        const str = String(valor);
        // Se o valor contém vírgulas, aspas ou quebras de linha, envolvê-lo em aspas duplas
        if (str.includes(',') ||
            str.includes('"') ||
            str.includes('\n') ||
            str.includes('\r')) {
            // Substituir aspas duplas por duas aspas duplas (padrão CSV)
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    }
};
exports.ExportacaoService = ExportacaoService;
exports.ExportacaoService = ExportacaoService = ExportacaoService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(solicitacao_entity_1.Solicitacao)),
    __param(1, (0, typeorm_1.InjectRepository)(tipo_beneficio_entity_1.TipoBeneficio)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object])
], ExportacaoService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcZXhwb3J0YWNhby5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELDZDQUFtRDtBQUNuRCxxQ0FBcUM7QUFDckMsNkVBQW1FO0FBQ25FLG1GQUF3RTtBQUV4RTs7Ozs7R0FLRztBQUVJLElBQU0saUJBQWlCLHlCQUF2QixNQUFNLGlCQUFpQjtJQUtUO0lBRUE7SUFORixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsbUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0QsWUFFbUIscUJBQThDLEVBRTlDLHVCQUFrRDtRQUZsRCwwQkFBcUIsR0FBckIscUJBQXFCLENBQXlCO1FBRTlDLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBMkI7SUFDbEUsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLHVCQUF1QixDQUFDLE9BQWE7UUFDekMsSUFBSSxDQUFDO1lBQ0gsd0NBQXdDO1lBQ3hDLE1BQU0sS0FBSyxHQUFRLEVBQUUsQ0FBQztZQUV0QixJQUFJLE9BQU8sRUFBRSxVQUFVLEVBQUUsQ0FBQztnQkFDeEIsS0FBSyxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO1lBQ3hDLENBQUM7WUFFRCxJQUFJLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDO2dCQUMvQixLQUFLLENBQUMsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDO1lBQ3RELENBQUM7WUFFRCxJQUFJLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQztnQkFDcEIsS0FBSyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2hDLENBQUM7WUFFRCxJQUFJLE9BQU8sRUFBRSxXQUFXLElBQUksT0FBTyxFQUFFLFFBQVEsRUFBRSxDQUFD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LENBQUM7UUFDN0MsQ0FBQztRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztDQUNGLENBQUE7QUEvTlksOENBQWlCOzRCQUFqQixpQkFBaUI7SUFEN0IsSUFBQSxtQkFBVSxHQUFFO0lBS1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLGdDQUFXLENBQUMsQ0FBQTtJQUU3QixXQUFBLElBQUEsMEJBQWdCLEVBQUMscUNBQWEsQ0FBQyxDQUFBO3lEQURRLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVSLG9CQUFVLG9CQUFWLG9CQUFVO0dBUDNDLGlCQUFpQixDQStON0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcZXhwb3J0YWNhby5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHsgU29saWNpdGFjYW8gfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9zb2xpY2l0YWNhby5lbnRpdHknO1xuaW1wb3J0IHsgVGlwb0JlbmVmaWNpbyB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3RpcG8tYmVuZWZpY2lvLmVudGl0eSc7XG5cbi8qKlxuICogU2VydmnDp28gZGUgRXhwb3J0YcOnw6NvIGRlIERhZG9zXG4gKlxuICogUmVzcG9uc8OhdmVsIHBvciBleHBvcnRhciBkYWRvcyBkZSBzb2xpY2l0YcOnw7VlcyBkZSBiZW5lZsOtY2lvcyBlbSBkaWZlcmVudGVzIGZvcm1hdG9zLFxuICogY29tbyBDU1YsIHBhcmEgYW7DoWxpc2UgZSByZWxhdMOzcmlvcy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEV4cG9ydGFjYW9TZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEV4cG9ydGFjYW9TZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFNvbGljaXRhY2FvKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgc29saWNpdGFjYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFNvbGljaXRhY2FvPixcbiAgICBASW5qZWN0UmVwb3NpdG9yeShUaXBvQmVuZWZpY2lvKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGlwb0JlbmVmaWNpb1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VGlwb0JlbmVmaWNpbz4sXG4gICkge31cblxuICAvKipcbiAgICogRXhwb3J0YSBzb2xpY2l0YcOnw7VlcyBkZSBiZW5lZsOtY2lvIGVtIGZvcm1hdG8gQ1NWXG4gICAqXG4gICAqIEBwYXJhbSBmaWx0cm9zIEZpbHRyb3MgcGFyYSBhcyBzb2xpY2l0YcOnw7VlcyBhIHNlcmVtIGV4cG9ydGFkYXNcbiAgICogQHJldHVybnMgU3RyaW5nIGVtIGZvcm1hdG8gQ1NWXG4gICAqL1xuICBhc3luYyBleHBvcnRhclNvbGljaXRhY29lc0NTVihmaWx0cm9zPzogYW55KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQ29uc3RydWlyIHF1ZXJ5IGNvbSBmaWx0cm9zIG9wY2lvbmFpc1xuICAgICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuXG4gICAgICBpZiAoZmlsdHJvcz8uY2lkYWRhb19pZCkge1xuICAgICAgICB3aGVyZS5jaWRhZGFvX2lkID0gZmlsdHJvcy5jaWRhZGFvX2lkO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmlsdHJvcz8udGlwb19iZW5lZmljaW9faWQpIHtcbiAgICAgICAgd2hlcmUudGlwb19iZW5lZmljaW9faWQgPSBmaWx0cm9zLnRpcG9fYmVuZWZpY2lvX2lkO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmlsdHJvcz8uc3RhdHVzKSB7XG4gICAgICAgIHdoZXJlLnN0YXR1cyA9IGZpbHRyb3Muc3RhdHVzO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmlsdHJvcz8uZGF0YV9pbmljaW8gJiYgZmlsdHJvcz8uZGF0YV9maW0pIHtcbiAgICAgICAgd2hlcmUuY3JlYXRlZF9hdCA9IHtcbiAgICAgICAgICAkZ3RlOiBuZXcgRGF0ZShmaWx0cm9zLmRhdGFfaW5pY2lvKSxcbiAgICAgICAgICAkbHRlOiBuZXcgRGF0ZShmaWx0cm9zLmRhdGFfZmltKSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gQnVzY2FyIHNvbGljaXRhw6fDtWVzXG4gICAgICBjb25zdCBzb2xpY2l0YWNvZXMgPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kKHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIHJlbGF0aW9uczogWyd0aXBvX2JlbmVmaWNpbyddLFxuICAgICAgICBvcmRlcjogeyBjcmVhdGVkX2F0OiAnREVTQycgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUcmFuc2Zvcm1hciBkYWRvcyBwYXJhIENTVlxuICAgICAgY29uc3QgZGFkb3MgPSBhd2FpdCB0aGlzLnRyYW5zZm9ybWFyRGFkb3NQYXJhQ1NWKHNvbGljaXRhY29lcyk7XG5cbiAgICAgIC8vIERlZmluaXIgY2FiZcOnYWxob3MgcGFkcsOjb1xuICAgICAgY29uc3QgY2FiZWNhbGhvc0Jhc2ljb3MgPSBbXG4gICAgICAgICdJRCcsXG4gICAgICAgICdJRCBkbyBDaWRhZMOjbycsXG4gICAgICAgICdUaXBvIGRlIEJlbmVmw61jaW8nLFxuICAgICAgICAnU3RhdHVzJyxcbiAgICAgICAgJ0RhdGEgZGEgU29saWNpdGHDp8OjbycsXG4gICAgICAgICfDmmx0aW1hIEF0dWFsaXphw6fDo28nLFxuICAgICAgXTtcblxuICAgICAgLy8gT2J0ZXIgdG9kb3Mgb3MgY2FtcG9zIGRpbsOibWljb3NcbiAgICAgIGNvbnN0IGNhbXBvc0RpbmFtaWNvcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgICAgZGFkb3MuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICBPYmplY3Qua2V5cyhpdGVtKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAhW1xuICAgICAgICAgICAgICAnaWQnLFxuICAgICAgICAgICAgICAnY2lkYWRhb19pZCcsXG4gICAgICAgICAgICAgICd0aXBvX2JlbmVmaWNpbycsXG4gICAgICAgICAgICAgICdzdGF0dXMnLFxuICAgICAgICAgICAgICAnZGF0YV9zb2xpY2l0YWNhbycsXG4gICAgICAgICAgICAgICd1cGRhdGVkX2F0JyxcbiAgICAgICAgICAgIF0uaW5jbHVkZXMoa2V5KVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgY2FtcG9zRGluYW1pY29zLmFkZChrZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gTW9udGFyIGNhYmXDp2FsaG8gY29tcGxldG9cbiAgICAgIGNvbnN0IGNhYmVjYWxob0NvbXBsZXRvID0gW1xuICAgICAgICAuLi5jYWJlY2FsaG9zQmFzaWNvcyxcbiAgICAgICAgLi4uQXJyYXkuZnJvbShjYW1wb3NEaW5hbWljb3MpLFxuICAgICAgXTtcblxuICAgICAgLy8gR2VyYXIgbGluaGEgZGUgY2FiZcOnYWxobyBDU1ZcbiAgICAgIGxldCBjc3YgPSBjYWJlY2FsaG9Db21wbGV0by5tYXAodGhpcy5lc2NhcGFyQ2FtcG9DU1YpLmpvaW4oJywnKSArICdcXG4nO1xuXG4gICAgICAvLyBHZXJhciBsaW5oYXMgZGUgZGFkb3NcbiAgICAgIGRhZG9zLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3QgbGluaGEgPSBbXG4gICAgICAgICAgdGhpcy5lc2NhcGFyQ2FtcG9DU1YoaXRlbS5pZCB8fCAnJyksXG4gICAgICAgICAgdGhpcy5lc2NhcGFyQ2FtcG9DU1YoaXRlbS5jaWRhZGFvX2lkIHx8ICcnKSxcbiAgICAgICAgICB0aGlzLmVzY2FwYXJDYW1wb0NTVihpdGVtLnRpcG9fYmVuZWZpY2lvIHx8ICcnKSxcbiAgICAgICAgICB0aGlzLmVzY2FwYXJDYW1wb0NTVihpdGVtLnN0YXR1cyB8fCAnJyksXG4gICAgICAgICAgdGhpcy5lc2NhcGFyQ2FtcG9DU1YoaXRlbS5kYXRhX3NvbGljaXRhY2FvIHx8ICcnKSxcbiAgICAgICAgICB0aGlzLmVzY2FwYXJDYW1wb0NTVihpdGVtLnVwZGF0ZWRfYXQgfHwgJycpLFxuICAgICAgICBdO1xuXG4gICAgICAgIC8vIEFkaWNpb25hciBjYW1wb3MgZGluw6JtaWNvc1xuICAgICAgICBjYW1wb3NEaW5hbWljb3MuZm9yRWFjaCgoY2FtcG8pID0+IHtcbiAgICAgICAgICBsaW5oYS5wdXNoKHRoaXMuZXNjYXBhckNhbXBvQ1NWKGl0ZW1bY2FtcG9dIHx8ICcnKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNzdiArPSBsaW5oYS5qb2luKCcsJykgKyAnXFxuJztcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gY3N2O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gZXhwb3J0YXIgc29saWNpdGHDp8O1ZXMgcGFyYSBDU1Y6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm8gYW8gZXhwb3J0YXIgc29saWNpdGHDp8O1ZXMgcGFyYSBDU1YnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtYSBkYWRvcyBkZSBzb2xpY2l0YcOnw7VlcyBwYXJhIG8gZm9ybWF0byBDU1ZcbiAgICpcbiAgICogQHBhcmFtIHNvbGljaXRhY29lcyBMaXN0YSBkZSBzb2xpY2l0YcOnw7Vlc1xuICAgKiBAcmV0dXJucyBEYWRvcyBmb3JtYXRhZG9zIHBhcmEgQ1NWXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHRyYW5zZm9ybWFyRGFkb3NQYXJhQ1NWKFxuICAgIHNvbGljaXRhY29lczogU29saWNpdGFjYW9bXSxcbiAgKTogUHJvbWlzZTxhbnlbXT4ge1xuICAgIHJldHVybiBzb2xpY2l0YWNvZXMubWFwKChzb2xpY2l0YWNhbykgPT4ge1xuICAgICAgLy8gRGFkb3MgYsOhc2ljb3NcbiAgICAgIGNvbnN0IGRhZG9zQmFzaWNvcyA9IHtcbiAgICAgICAgaWQ6IHNvbGljaXRhY2FvLmlkLFxuICAgICAgICBjaWRhZGFvX2lkOiBzb2xpY2l0YWNhby5iZW5lZmljaWFyaW9faWQsXG4gICAgICAgIHRpcG9fYmVuZWZpY2lvOiBzb2xpY2l0YWNhby50aXBvX2JlbmVmaWNpbz8ubm9tZSB8fCAnTsOjbyBlc3BlY2lmaWNhZG8nLFxuICAgICAgICBzdGF0dXM6IHNvbGljaXRhY2FvLnN0YXR1cyxcbiAgICAgICAgZGF0YV9zb2xpY2l0YWNhbzogdGhpcy5mb3JtYXRhckRhdGEoc29saWNpdGFjYW8uY3JlYXRlZF9hdCksXG4gICAgICAgIHVwZGF0ZWRfYXQ6IHRoaXMuZm9ybWF0YXJEYXRhKHNvbGljaXRhY2FvLnVwZGF0ZWRfYXQpLFxuICAgICAgfTtcblxuICAgICAgLy8gQWRpY2lvbmFyIGRhZG9zIGRpbsOibWljb3NcbiAgICAgIGNvbnN0IGRhZG9zRGluYW1pY29zID0gc29saWNpdGFjYW8uZGFkb3NfZGluYW1pY29zIHx8IHt9O1xuXG4gICAgICAvLyBNZXNjbGFyIGRhZG9zIGLDoXNpY29zIGNvbSBkYWRvcyBkaW7Dom1pY29zXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5kYWRvc0Jhc2ljb3MsXG4gICAgICAgIC4uLnRoaXMucHJvY2Vzc2FyRGFkb3NEaW5hbWljb3MoZGFkb3NEaW5hbWljb3MpLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzYSBkYWRvcyBkaW7Dom1pY29zIHBhcmEgZXhwb3J0YcOnw6NvXG4gICAqXG4gICAqIEBwYXJhbSBkYWRvcyBEYWRvcyBkaW7Dom1pY29zXG4gICAqIEByZXR1cm5zIERhZG9zIHByb2Nlc3NhZG9zXG4gICAqL1xuICBwcml2YXRlIHByb2Nlc3NhckRhZG9zRGluYW1pY29zKGRhZG9zOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHJlc3VsdGFkbyA9IHt9O1xuXG4gICAgLy8gUHJvY2Vzc2FyIGNhZGEgY2FtcG8gZGluw6JtaWNvXG4gICAgT2JqZWN0LmtleXMoZGFkb3MpLmZvckVhY2goKGNoYXZlKSA9PiB7XG4gICAgICBjb25zdCB2YWxvciA9IGRhZG9zW2NoYXZlXTtcblxuICAgICAgLy8gUHJvY2Vzc2FyIGNvbmZvcm1lIG8gdGlwb1xuICAgICAgaWYgKHZhbG9yID09PSBudWxsIHx8IHZhbG9yID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVzdWx0YWRvW2NoYXZlXSA9ICcnO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsb3IgPT09ICdvYmplY3QnICYmIHZhbG9yIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICByZXN1bHRhZG9bY2hhdmVdID0gdGhpcy5mb3JtYXRhckRhdGEodmFsb3IpO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsb3IgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIHJlc3VsdGFkb1tjaGF2ZV0gPSBKU09OLnN0cmluZ2lmeSh2YWxvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRhZG9bY2hhdmVdID0gU3RyaW5nKHZhbG9yKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHRhZG87XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0YSBkYXRhIHBhcmEgc3RyaW5nIG5vIGZvcm1hdG8gREQvTU0vWVlZWSBISDpNTTpTU1xuICAgKlxuICAgKiBAcGFyYW0gZGF0YSBEYXRhIGEgc2VyIGZvcm1hdGFkYVxuICAgKiBAcmV0dXJucyBEYXRhIGZvcm1hdGFkYVxuICAgKi9cbiAgcHJpdmF0ZSBmb3JtYXRhckRhdGEoZGF0YTogRGF0ZSk6IHN0cmluZyB7XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgY29uc3QgZGlhID0gZGF0YS5nZXREYXRlKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xuICAgIGNvbnN0IG1lcyA9IChkYXRhLmdldE1vbnRoKCkgKyAxKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyk7XG4gICAgY29uc3QgYW5vID0gZGF0YS5nZXRGdWxsWWVhcigpO1xuICAgIGNvbnN0IGhvcmEgPSBkYXRhLmdldEhvdXJzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xuICAgIGNvbnN0IG1pbnV0byA9IGRhdGEuZ2V0TWludXRlcygpLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKTtcbiAgICBjb25zdCBzZWd1bmRvID0gZGF0YS5nZXRTZWNvbmRzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xuXG4gICAgcmV0dXJuIGAke2RpYX0vJHttZXN9LyR7YW5vfSAke2hvcmF9OiR7bWludXRvfToke3NlZ3VuZG99YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBFc2NhcGEgdW0gY2FtcG8gcGFyYSBmb3JtYXRvIENTVlxuICAgKlxuICAgKiBAcGFyYW0gdmFsb3IgVmFsb3IgYSBzZXIgZXNjYXBhZG9cbiAgICogQHJldHVybnMgVmFsb3IgZXNjYXBhZG8gcGFyYSBDU1ZcbiAgICovXG4gIHByaXZhdGUgZXNjYXBhckNhbXBvQ1NWKHZhbG9yOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICh2YWxvciA9PT0gbnVsbCB8fCB2YWxvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyID0gU3RyaW5nKHZhbG9yKTtcblxuICAgIC8vIFNlIG8gdmFsb3IgY29udMOpbSB2w61yZ3VsYXMsIGFzcGFzIG91IHF1ZWJyYXMgZGUgbGluaGEsIGVudm9sdsOqLWxvIGVtIGFzcGFzIGR1cGxhc1xuICAgIGlmIChcbiAgICAgIHN0ci5pbmNsdWRlcygnLCcpIHx8XG4gICAgICBzdHIuaW5jbHVkZXMoJ1wiJykgfHxcbiAgICAgIHN0ci5pbmNsdWRlcygnXFxuJykgfHxcbiAgICAgIHN0ci5pbmNsdWRlcygnXFxyJylcbiAgICApIHtcbiAgICAgIC8vIFN1YnN0aXR1aXIgYXNwYXMgZHVwbGFzIHBvciBkdWFzIGFzcGFzIGR1cGxhcyAocGFkcsOjbyBDU1YpXG4gICAgICByZXR1cm4gJ1wiJyArIHN0ci5yZXBsYWNlKC9cIi9nLCAnXCJcIicpICsgJ1wiJztcbiAgICB9XG5cbiAgICByZXR1cm4gc3RyO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=