31cce912e940d176cdcae380ed31477f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const comprovante_controller_1 = require("../../../controllers/comprovante.controller");
const comprovante_service_1 = require("../../../services/comprovante.service");
const pagamento_service_1 = require("../../../services/pagamento.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para ComprovanteController
 *
 * Valida o comportamento dos endpoints de comprovante de pagamento, garantindo
 * o correto funcionamento do upload, download e manipulação de comprovantes.
 *
 * @author Equipe PGBen
 */
describe('ComprovanteController', () => {
    let controller;
    let comprovanteService;
    let pagamentoService;
    // Mock de um comprovante para os testes
    const comprovanteMock = {
        id: 'comprovante-id-1',
        pagamentoId: 'pagamento-id-1',
        nomeArquivo: 'comprovante.pdf',
        tipoArquivo: 'application/pdf',
        tamanhoArquivo: 1024,
        caminhoArquivo: 'pagamentos/comprovantes/comprovante-id-1.pdf',
        adicionadoPor: 'usuario-id-1',
        dataCriacao: new Date(),
        observacoes: 'Comprovante de pagamento via PIX'
    };
    // Mock de um pagamento para os testes
    const pagamentoMock = {
        id: 'pagamento-id-1',
        solicitacaoId: 'solicitacao-id-1',
        status: 'LIBERADO',
        valor: 500
    };
    // Lista de comprovantes para teste
    const comprovantesMock = [
        comprovanteMock,
        {
            ...comprovanteMock,
            id: 'comprovante-id-2',
            nomeArquivo: 'comprovante2.pdf'
        }
    ];
    // Mock do arquivo para teste de upload
    const fileMock = {
        originalname: 'comprovante.pdf',
        mimetype: 'application/pdf',
        size: 1024,
        buffer: Buffer.from('mock file content')
    };
    // Mock do request com usuário autenticado
    const mockRequest = {
        user: {
            id: 'usuario-id-1',
            nome: 'Usuário Teste',
            perfil: 'operador'
        }
    };
    // Mock da resposta para download
    const mockResponse = {
        contentType: jest.fn().mockReturnThis(),
        header: jest.fn().mockReturnThis(),
        send: jest.fn().mockReturnThis()
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            controllers: [comprovante_controller_1.ComprovanteController],
            providers: [
                {
                    provide: comprovante_service_1.ComprovanteService,
                    useValue: {
                        uploadComprovante: jest.fn().mockResolvedValue(comprovanteMock),
                        getComprovante: jest.fn().mockResolvedValue(comprovanteMock),
                        getComprovanteConteudo: jest.fn().mockResolvedValue(Buffer.from('mock file content')),
                        listarComprovantes: jest.fn().mockResolvedValue(comprovantesMock),
                        removerComprovante: jest.fn().mockResolvedValue(true)
                    }
                },
                {
                    provide: pagamento_service_1.PagamentoService,
                    useValue: {
                        findOne: jest.fn().mockResolvedValue(pagamentoMock)
                    }
                }
            ],
        }).compile();
        controller = module.get(comprovante_controller_1.ComprovanteController);
        comprovanteService = module.get(comprovante_service_1.ComprovanteService);
        pagamentoService = module.get(pagamento_service_1.PagamentoService);
    });
    it('deve estar definido', () => {
        expect(controller).toBeDefined();
    });
    describe('uploadComprovante', () => {
        it('deve fazer upload de comprovante com sucesso', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            // Act
            const resultado = await controller.uploadComprovante(pagamentoId, fileMock, observacoes, mockRequest);
            // Assert
            expect(resultado).toEqual(comprovanteMock);
            expect(comprovanteService.uploadComprovante).toHaveBeenCalledWith(pagamentoId, fileMock, observacoes, mockRequest.user.id);
        });
        it('deve validar se o pagamento existe antes do upload', async () => {
            // Arrange
            const pagamentoId = 'pagamento-inexistente';
            const observacoes = 'Comprovante de pagamento';
            jest.spyOn(pagamentoService, 'findOne').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, fileMock, observacoes, mockRequest)).rejects.toThrow(common_1.NotFoundException);
            expect(pagamentoService.findOne).toHaveBeenCalledWith(pagamentoId);
        });
        it('deve rejeitar upload de arquivo não permitido', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            const arquivoInvalido = {
                ...fileMock,
                mimetype: 'application/exe'
            };
            jest.spyOn(comprovanteService, 'uploadComprovante').mockRejectedValue(new common_1.BadRequestException('Tipo de arquivo não permitido'));
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, arquivoInvalido, observacoes, mockRequest)).rejects.toThrow(common_1.BadRequestException);
        });
        it('deve rejeitar upload de arquivo muito grande', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const observacoes = 'Comprovante de pagamento';
            const arquivoGrande = {
                ...fileMock,
                size: 10 * 1024 * 1024 // 10MB
            };
            jest.spyOn(comprovanteService, 'uploadComprovante').mockRejectedValue(new common_1.BadRequestException('Arquivo excede o tamanho máximo permitido'));
            // Act & Assert
            await expect(controller.uploadComprovante(pagamentoId, arquivoGrande, observacoes, mockRequest)).rejects.toThrow(common_1.BadRequestException);
        });
    });
    describe('getComprovante', () => {
        it('deve retornar os metadados do comprovante', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            // Act
            const resultado = await controller.getComprovante(comprovanteId);
            // Assert
            expect(resultado).toEqual(comprovanteMock);
            expect(comprovanteService.getComprovante).toHaveBeenCalledWith(comprovanteId);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest.spyOn(comprovanteService, 'getComprovante').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.getComprovante(comprovanteId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('downloadComprovante', () => {
        it('deve retornar o conteúdo do comprovante', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            const arquivoConteudo = Buffer.from('mock file content');
            // Act
            await controller.downloadComprovante(comprovanteId, mockResponse);
            // Assert
            expect(comprovanteService.getComprovante).toHaveBeenCalledWith(comprovanteId);
            expect(comprovanteService.getComprovanteConteudo).toHaveBeenCalledWith(comprovanteId);
            expect(mockResponse.contentType).toHaveBeenCalledWith(comprovanteMock.tipoArquivo);
            expect(mockResponse.header).toHaveBeenCalledWith('Content-Disposition', `attachment; filename="${comprovanteMock.nomeArquivo}"`);
            expect(mockResponse.send).toHaveBeenCalledWith(arquivoConteudo);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest.spyOn(comprovanteService, 'getComprovante').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.downloadComprovante(comprovanteId, mockResponse)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('listarComprovantes', () => {
        it('deve listar comprovantes de um pagamento', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            // Act
            const resultado = await controller.listarComprovantes(pagamentoId);
            // Assert
            expect(resultado).toEqual(comprovantesMock);
            expect(comprovanteService.listarComprovantes).toHaveBeenCalledWith(pagamentoId);
        });
        it('deve retornar lista vazia quando não há comprovantes', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            jest.spyOn(comprovanteService, 'listarComprovantes').mockResolvedValue([]);
            // Act
            const resultado = await controller.listarComprovantes(pagamentoId);
            // Assert
            expect(resultado).toEqual([]);
        });
    });
    describe('removerComprovante', () => {
        it('deve remover um comprovante com sucesso', async () => {
            // Arrange
            const comprovanteId = 'comprovante-id-1';
            // Act
            const resultado = await controller.removerComprovante(comprovanteId, mockRequest);
            // Assert
            expect(resultado).toEqual({ success: true, message: 'Comprovante removido com sucesso' });
            expect(comprovanteService.removerComprovante).toHaveBeenCalledWith(comprovanteId, mockRequest.user.id);
        });
        it('deve lançar erro quando o comprovante não existe', async () => {
            // Arrange
            const comprovanteId = 'comprovante-inexistente';
            jest.spyOn(comprovanteService, 'removerComprovante').mockRejectedValue(new common_1.NotFoundException('Comprovante não encontrado'));
            // Act & Assert
            await expect(controller.removerComprovante(comprovanteId, mockRequest)).rejects.toThrow(common_1.NotFoundException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHVuaXRcXGNvbnRyb2xsZXJzXFxjb21wcm92YW50ZS5jb250cm9sbGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsd0ZBQW9GO0FBQ3BGLCtFQUEyRTtBQUMzRSwyRUFBdUU7QUFDdkUsMkNBQXdFO0FBR3hFOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLElBQUksVUFBaUMsQ0FBQztJQUN0QyxJQUFJLGtCQUFzQyxDQUFDO0lBQzNDLElBQUksZ0JBQWtDLENBQUM7SUFFdkMsd0NBQXdDO0lBQ3hDLE1BQU0sZUFBZSxHQUFHO1FBQ3RCLEVBQUUsRUFBRSxrQkFBa0I7UUFDdEIsV0FBVyxFQUFFLGdCQUFnQjtRQUM3QixXQUFXLEVBQUUsaUJBQWlCO1FBQzlCLFdBQVcsRUFBRSxpQkFBaUI7UUFDOUIsY0FBYyxFQUFFLElBQUk7UUFDcEIsY0FBYyxFQUFFLDhDQUE4QztRQUM5RCxhQUFhLEVBQUUsY0FBYztRQUM3QixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDdkIsV0FBVyxFQUFFLGtDQUFrQztLQUNoRCxDQUFDO0lBRUYsc0NBQXNDO0lBQ3RDLE1BQU0sYUFBYSxHQUFHO1FBQ3BCLEVBQUUsRUFBRSxnQkFBZ0I7UUFDcEIsYUFBYSxFQUFFLGtCQUFrQjtRQUNqQyxNQUFNLEVBQUUsVUFBVTtRQUNsQixLQUFLLEVBQUUsR0FBRztLQUNYLENBQUM7SUFFRixtQ0FBbUM7SUFDbkMsTUFBTSxnQkFBZ0IsR0FBRztRQUN2QixlQUFlO1FBQ2Y7WUFDRSxHQUFHLGVBQWU7WUFDbEIsRUFBRSxFQUFFLGtCQUFrQjtZQUN0QixXQUFXLEVBQUUsa0JBQWtCO1NBQ2hDO0tBQ0YsQ0FBQztJQUVGLHVDQUF1QztJQUN2QyxNQUFNLFFB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LDRCQUE0QixDQUFDLENBQ3BELENBQUM7WUFFRixlQUFlO1lBQ2YsTUFBTSxNQUFNLENBQ1YsVUFBVSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxXQUFrQixDQUFDLENBQ2pFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywwQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xccGFnYW1lbnRvXFx0ZXN0c1xcdW5pdFxcY29udHJvbGxlcnNcXGNvbXByb3ZhbnRlLmNvbnRyb2xsZXIuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbXByb3ZhbnRlQ29udHJvbGxlciB9IGZyb20gJy4uLy4uLy4uL2NvbnRyb2xsZXJzL2NvbXByb3ZhbnRlLmNvbnRyb2xsZXInO1xuaW1wb3J0IHsgQ29tcHJvdmFudGVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvY29tcHJvdmFudGUuc2VydmljZSc7XG5pbXBvcnQgeyBQYWdhbWVudG9TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcGFnYW1lbnRvLnNlcnZpY2UnO1xuaW1wb3J0IHsgTm90Rm91bmRFeGNlcHRpb24sIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgQ29tcHJvdmFudGVDb250cm9sbGVyXG4gKiBcbiAqIFZhbGlkYSBvIGNvbXBvcnRhbWVudG8gZG9zIGVuZHBvaW50cyBkZSBjb21wcm92YW50ZSBkZSBwYWdhbWVudG8sIGdhcmFudGluZG8gXG4gKiBvIGNvcnJldG8gZnVuY2lvbmFtZW50byBkbyB1cGxvYWQsIGRvd25sb2FkIGUgbWFuaXB1bGHDp8OjbyBkZSBjb21wcm92YW50ZXMuXG4gKiBcbiAqIEBhdXRob3IgRXF1aXBlIFBHQmVuXG4gKi9cbmRlc2NyaWJlKCdDb21wcm92YW50ZUNvbnRyb2xsZXInLCAoKSA9PiB7XG4gIGxldCBjb250cm9sbGVyOiBDb21wcm92YW50ZUNvbnRyb2xsZXI7XG4gIGxldCBjb21wcm92YW50ZVNlcnZpY2U6IENvbXByb3ZhbnRlU2VydmljZTtcbiAgbGV0IHBhZ2FtZW50b1NlcnZpY2U6IFBhZ2FtZW50b1NlcnZpY2U7XG5cbiAgLy8gTW9jayBkZSB1bSBjb21wcm92YW50ZSBwYXJhIG9zIHRlc3Rlc1xuICBjb25zdCBjb21wcm92YW50ZU1vY2sgPSB7XG4gICAgaWQ6ICdjb21wcm92YW50ZS1pZC0xJyxcbiAgICBwYWdhbWVudG9JZDogJ3BhZ2FtZW50by1pZC0xJyxcbiAgICBub21lQXJxdWl2bzogJ2NvbXByb3ZhbnRlLnBkZicsXG4gICAgdGlwb0FycXVpdm86ICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgIHRhbWFuaG9BcnF1aXZvOiAxMDI0LFxuICAgIGNhbWluaG9BcnF1aXZvOiAncGFnYW1lbnRvcy9jb21wcm92YW50ZXMvY29tcHJvdmFudGUtaWQtMS5wZGYnLFxuICAgIGFkaWNpb25hZG9Qb3I6ICd1c3VhcmlvLWlkLTEnLFxuICAgIGRhdGFDcmlhY2FvOiBuZXcgRGF0ZSgpLFxuICAgIG9ic2VydmFjb2VzOiAnQ29tcHJvdmFudGUgZGUgcGFnYW1lbnRvIHZpYSBQSVgnXG4gIH07XG5cbiAgLy8gTW9jayBkZSB1bSBwYWdhbWVudG8gcGFyYSBvcyB0ZXN0ZXNcbiAgY29uc3QgcGFnYW1lbnRvTW9jayA9IHtcbiAgICBpZDogJ3BhZ2FtZW50by1pZC0xJyxcbiAgICBzb2xpY2l0YWNhb0lkOiAnc29saWNpdGFjYW8taWQtMScsXG4gICAgc3RhdHVzOiAnTElCRVJBRE8nLFxuICAgIHZhbG9yOiA1MDBcbiAgfTtcblxuICAvLyBMaXN0YSBkZSBjb21wcm92YW50ZXMgcGFyYSB0ZXN0ZVxuICBjb25zdCBjb21wcm92YW50ZXNNb2NrID0gW1xuICAgIGNvbXByb3ZhbnRlTW9jayxcbiAgICB7XG4gICAgICAuLi5jb21wcm92YW50ZU1vY2ssXG4gICAgICBpZDogJ2NvbXByb3ZhbnRlLWlkLTInLFxuICAgICAgbm9tZUFycXVpdm86ICdjb21wcm92YW50ZTIucGRmJ1xuICAgIH1cbiAgXTtcblxuICAvLyBNb2NrIGRvIGFycXVpdm8gcGFyYSB0ZXN0ZSBkZSB1cGxvYWRcbiAgY29uc3QgZmlsZU1vY2sgPSB7XG4gICAgb3JpZ2luYWxuYW1lOiAnY29tcHJvdmFudGUucGRmJyxcbiAgICBtaW1ldHlwZTogJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgc2l6ZTogMTAyNCxcbiAgICBidWZmZXI6IEJ1ZmZlci5mcm9tKCdtb2NrIGZpbGUgY29udGVudCcpXG4gIH07XG5cbiAgLy8gTW9jayBkbyByZXF1ZXN0IGNvbSB1c3XDoXJpbyBhdXRlbnRpY2Fkb1xuICBjb25zdCBtb2NrUmVxdWVzdCA9IHtcbiAgICB1c2VyOiB7XG4gICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICBub21lOiAnVXN1w6FyaW8gVGVzdGUnLFxuICAgICAgcGVyZmlsOiAnb3BlcmFkb3InXG4gICAgfVxuICB9O1xuXG4gIC8vIE1vY2sgZGEgcmVzcG9zdGEgcGFyYSBkb3dubG9hZFxuICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgY29udGVudFR5cGU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIGhlYWRlcjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgc2VuZDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKClcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgY29udHJvbGxlcnM6IFtDb21wcm92YW50ZUNvbnRyb2xsZXJdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb21wcm92YW50ZVNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIHVwbG9hZENvbXByb3ZhbnRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29tcHJvdmFudGVNb2NrKSxcbiAgICAgICAgICAgIGdldENvbXByb3ZhbnRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29tcHJvdmFudGVNb2NrKSxcbiAgICAgICAgICAgIGdldENvbXByb3ZhbnRlQ29udGV1ZG86IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShCdWZmZXIuZnJvbSgnbW9jayBmaWxlIGNvbnRlbnQnKSksXG4gICAgICAgICAgICBsaXN0YXJDb21wcm92YW50ZXM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShjb21wcm92YW50ZXNNb2NrKSxcbiAgICAgICAgICAgIHJlbW92ZXJDb21wcm92YW50ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHRydWUpXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGFnYW1lbnRvU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHBhZ2FtZW50b01vY2spXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGNvbnRyb2xsZXIgPSBtb2R1bGUuZ2V0PENvbXByb3ZhbnRlQ29udHJvbGxlcj4oQ29tcHJvdmFudGVDb250cm9sbGVyKTtcbiAgICBjb21wcm92YW50ZVNlcnZpY2UgPSBtb2R1bGUuZ2V0PENvbXByb3ZhbnRlU2VydmljZT4oQ29tcHJvdmFudGVTZXJ2aWNlKTtcbiAgICBwYWdhbWVudG9TZXJ2aWNlID0gbW9kdWxlLmdldDxQYWdhbWVudG9TZXJ2aWNlPihQYWdhbWVudG9TZXJ2aWNlKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgZXN0YXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KGNvbnRyb2xsZXIpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd1cGxvYWRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBmYXplciB1cGxvYWQgZGUgY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG4gICAgICBjb25zdCBvYnNlcnZhY29lcyA9ICdDb21wcm92YW50ZSBkZSBwYWdhbWVudG8nO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGNvbnRyb2xsZXIudXBsb2FkQ29tcHJvdmFudGUoXG4gICAgICAgIHBhZ2FtZW50b0lkLFxuICAgICAgICBmaWxlTW9jayBhcyBhbnksXG4gICAgICAgIG9ic2VydmFjb2VzLFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBhbnlcbiAgICAgICk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdGFkbykudG9FcXVhbChjb21wcm92YW50ZU1vY2spO1xuICAgICAgZXhwZWN0KGNvbXByb3ZhbnRlU2VydmljZS51cGxvYWRDb21wcm92YW50ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIHBhZ2FtZW50b0lkLFxuICAgICAgICBmaWxlTW9jayxcbiAgICAgICAgb2JzZXJ2YWNvZXMsXG4gICAgICAgIG1vY2tSZXF1ZXN0LnVzZXIuaWRcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2YWxpZGFyIHNlIG8gcGFnYW1lbnRvIGV4aXN0ZSBhbnRlcyBkbyB1cGxvYWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taW5leGlzdGVudGUnO1xuICAgICAgY29uc3Qgb2JzZXJ2YWNvZXMgPSAnQ29tcHJvdmFudGUgZGUgcGFnYW1lbnRvJztcbiAgICAgIFxuICAgICAgamVzdC5zcHlPbihwYWdhbWVudG9TZXJ2aWNlLCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci51cGxvYWRDb21wcm92YW50ZShwYWdhbWVudG9JZCwgZmlsZU1vY2sgYXMgYW55LCBvYnNlcnZhY29lcywgbW9ja1JlcXVlc3QgYXMgYW55KVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgICAgZXhwZWN0KHBhZ2FtZW50b1NlcnZpY2UuZmluZE9uZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgocGFnYW1lbnRvSWQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVqZWl0YXIgdXBsb2FkIGRlIGFycXVpdm8gbsOjbyBwZXJtaXRpZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG4gICAgICBjb25zdCBvYnNlcnZhY29lcyA9ICdDb21wcm92YW50ZSBkZSBwYWdhbWVudG8nO1xuICAgICAgY29uc3QgYXJxdWl2b0ludmFsaWRvID0ge1xuICAgICAgICAuLi5maWxlTW9jayxcbiAgICAgICAgbWltZXR5cGU6ICdhcHBsaWNhdGlvbi9leGUnXG4gICAgICB9O1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ3VwbG9hZENvbXByb3ZhbnRlJykubW9ja1JlamVjdGVkVmFsdWUoXG4gICAgICAgIG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdUaXBvIGRlIGFycXVpdm8gbsOjbyBwZXJtaXRpZG8nKVxuICAgICAgKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIudXBsb2FkQ29tcHJvdmFudGUocGFnYW1lbnRvSWQsIGFycXVpdm9JbnZhbGlkbyBhcyBhbnksIG9ic2VydmFjb2VzLCBtb2NrUmVxdWVzdCBhcyBhbnkpXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJlamVpdGFyIHVwbG9hZCBkZSBhcnF1aXZvIG11aXRvIGdyYW5kZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZC0xJztcbiAgICAgIGNvbnN0IG9ic2VydmFjb2VzID0gJ0NvbXByb3ZhbnRlIGRlIHBhZ2FtZW50byc7XG4gICAgICBjb25zdCBhcnF1aXZvR3JhbmRlID0ge1xuICAgICAgICAuLi5maWxlTW9jayxcbiAgICAgICAgc2l6ZTogMTAgKiAxMDI0ICogMTAyNCAvLyAxME1CXG4gICAgICB9O1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ3VwbG9hZENvbXByb3ZhbnRlJykubW9ja1JlamVjdGVkVmFsdWUoXG4gICAgICAgIG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBcnF1aXZvIGV4Y2VkZSBvIHRhbWFuaG8gbcOheGltbyBwZXJtaXRpZG8nKVxuICAgICAgKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIudXBsb2FkQ29tcHJvdmFudGUocGFnYW1lbnRvSWQsIGFycXVpdm9HcmFuZGUgYXMgYW55LCBvYnNlcnZhY29lcywgbW9ja1JlcXVlc3QgYXMgYW55KVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZXRvcm5hciBvcyBtZXRhZGFkb3MgZG8gY29tcHJvdmFudGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBjb21wcm92YW50ZUlkID0gJ2NvbXByb3ZhbnRlLWlkLTEnO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGNvbnRyb2xsZXIuZ2V0Q29tcHJvdmFudGUoY29tcHJvdmFudGVJZCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdGFkbykudG9FcXVhbChjb21wcm92YW50ZU1vY2spO1xuICAgICAgZXhwZWN0KGNvbXByb3ZhbnRlU2VydmljZS5nZXRDb21wcm92YW50ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY29tcHJvdmFudGVJZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBsYW7Dp2FyIGVycm8gcXVhbmRvIG8gY29tcHJvdmFudGUgbsOjbyBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBjb21wcm92YW50ZUlkID0gJ2NvbXByb3ZhbnRlLWluZXhpc3RlbnRlJztcbiAgICAgIFxuICAgICAgamVzdC5zcHlPbihjb21wcm92YW50ZVNlcnZpY2UsICdnZXRDb21wcm92YW50ZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci5nZXRDb21wcm92YW50ZShjb21wcm92YW50ZUlkKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZG93bmxvYWRDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZXRvcm5hciBvIGNvbnRlw7pkbyBkbyBjb21wcm92YW50ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQtMSc7XG4gICAgICBjb25zdCBhcnF1aXZvQ29udGV1ZG8gPSBCdWZmZXIuZnJvbSgnbW9jayBmaWxlIGNvbnRlbnQnKTtcbiAgICAgIFxuICAgICAgLy8gQWN0XG4gICAgICBhd2FpdCBjb250cm9sbGVyLmRvd25sb2FkQ29tcHJvdmFudGUoY29tcHJvdmFudGVJZCwgbW9ja1Jlc3BvbnNlIGFzIHVua25vd24gYXMgUmVzcG9uc2UpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChjb21wcm92YW50ZVNlcnZpY2UuZ2V0Q29tcHJvdmFudGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGNvbXByb3ZhbnRlSWQpO1xuICAgICAgZXhwZWN0KGNvbXByb3ZhbnRlU2VydmljZS5nZXRDb21wcm92YW50ZUNvbnRldWRvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChjb21wcm92YW50ZUlkKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuY29udGVudFR5cGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGNvbXByb3ZhbnRlTW9jay50aXBvQXJxdWl2byk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmhlYWRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdDb250ZW50LURpc3Bvc2l0aW9uJyxcbiAgICAgICAgYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPVwiJHtjb21wcm92YW50ZU1vY2subm9tZUFycXVpdm99XCJgXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChhcnF1aXZvQ29udGV1ZG8pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBvIGNvbXByb3ZhbnRlIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgY29tcHJvdmFudGVJZCA9ICdjb21wcm92YW50ZS1pbmV4aXN0ZW50ZSc7XG4gICAgICBcbiAgICAgIGplc3Quc3B5T24oY29tcHJvdmFudGVTZXJ2aWNlLCAnZ2V0Q29tcHJvdmFudGUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIuZG93bmxvYWRDb21wcm92YW50ZShjb21wcm92YW50ZUlkLCBtb2NrUmVzcG9uc2UgYXMgdW5rbm93biBhcyBSZXNwb25zZSlcbiAgICAgICkucmVqZWN0cy50b1Rocm93KE5vdEZvdW5kRXhjZXB0aW9uKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xpc3RhckNvbXByb3ZhbnRlcycsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBsaXN0YXIgY29tcHJvdmFudGVzIGRlIHVtIHBhZ2FtZW50bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZC0xJztcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBjb250cm9sbGVyLmxpc3RhckNvbXByb3ZhbnRlcyhwYWdhbWVudG9JZCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdGFkbykudG9FcXVhbChjb21wcm92YW50ZXNNb2NrKTtcbiAgICAgIGV4cGVjdChjb21wcm92YW50ZVNlcnZpY2UubGlzdGFyQ29tcHJvdmFudGVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwYWdhbWVudG9JZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZXRvcm5hciBsaXN0YSB2YXppYSBxdWFuZG8gbsOjbyBow6EgY29tcHJvdmFudGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkLTEnO1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ2xpc3RhckNvbXByb3ZhbnRlcycpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKTtcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBjb250cm9sbGVyLmxpc3RhckNvbXByb3ZhbnRlcyhwYWdhbWVudG9JZCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdGFkbykudG9FcXVhbChbXSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZW1vdmVyQ29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmVtb3ZlciB1bSBjb21wcm92YW50ZSBjb20gc3VjZXNzbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQtMSc7XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0YWRvID0gYXdhaXQgY29udHJvbGxlci5yZW1vdmVyQ29tcHJvdmFudGUoXG4gICAgICAgIGNvbXByb3ZhbnRlSWQsXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIGFueVxuICAgICAgKTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0YWRvKS50b0VxdWFsKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ0NvbXByb3ZhbnRlIHJlbW92aWRvIGNvbSBzdWNlc3NvJyB9KTtcbiAgICAgIGV4cGVjdChjb21wcm92YW50ZVNlcnZpY2UucmVtb3ZlckNvbXByb3ZhbnRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgY29tcHJvdmFudGVJZCxcbiAgICAgICAgbW9ja1JlcXVlc3QudXNlci5pZFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgZXJybyBxdWFuZG8gbyBjb21wcm92YW50ZSBuw6NvIGV4aXN0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaW5leGlzdGVudGUnO1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGNvbXByb3ZhbnRlU2VydmljZSwgJ3JlbW92ZXJDb21wcm92YW50ZScpLm1vY2tSZWplY3RlZFZhbHVlKFxuICAgICAgICBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NvbXByb3ZhbnRlIG7Do28gZW5jb250cmFkbycpXG4gICAgICApO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci5yZW1vdmVyQ29tcHJvdmFudGUoY29tcHJvdmFudGVJZCwgbW9ja1JlcXVlc3QgYXMgYW55KVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9