448703c310c0ac201058ee900e731f27
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RefreshToken = void 0;
// src/auth/entities/refresh-token.entity.ts
const typeorm_1 = require("typeorm");
const class_validator_1 = require("class-validator");
const usuario_entity_1 = require("./usuario.entity");
let RefreshToken = class RefreshToken {
    id;
    usuario_id;
    token;
    expires_at;
    revoked;
    revoked_at;
    revokedByIp;
    replacedByToken;
    created_at;
    updated_at;
    usuario;
    // Métodos utilitários
    /**
     * Verifica se o token está expirado
     */
    isExpired() {
        return new Date() > this.expires_at;
    }
    /**
     * Verifica se o token está ativo (não revogado e não expirado)
     */
    isActive() {
        return !this.revoked && !this.isExpired();
    }
    /**
     * Revoga o token
     */
    revoke(ip, replacedByToken) {
        this.revoked = true;
        this.revoked_at = new Date();
        if (ip) {
            this.revokedByIp = ip;
        }
        if (replacedByToken) {
            this.replacedByToken = replacedByToken;
        }
    }
    /**
     * Verifica se o token foi revogado
     */
    isRevoked() {
        return this.revoked;
    }
    /**
     * Calcula o tempo restante até a expiração em milissegundos
     */
    getTimeToExpiration() {
        const now = new Date().getTime();
        const expiration = this.expires_at.getTime();
        return Math.max(0, expiration - now);
    }
    /**
     * Verifica se o token expira em breve (próximos X minutos)
     */
    isExpiringWithin(minutes) {
        const timeToExpiration = this.getTimeToExpiration();
        const minutesInMs = minutes * 60 * 1000;
        return timeToExpiration <= minutesInMs && timeToExpiration > 0;
    }
    /**
     * Obtém informações de status do token
     */
    getStatus() {
        return {
            isActive: this.isActive(),
            isExpired: this.isExpired(),
            isRevoked: this.isRevoked(),
            timeToExpiration: this.getTimeToExpiration(),
        };
    }
    /**
     * Verifica se o token pertence a um usuário específico
     */
    belongsToUser(userId) {
        return this.usuario_id === userId;
    }
    /**
     * Gera uma chave única para o token
     */
    getUniqueKey() {
        return `refresh_token_${this.usuario_id}_${this.id}`;
    }
    /**
     * Verifica se o token foi criado recentemente (últimas X horas)
     */
    isCriadoRecentemente(horas = 1) {
        if (!this.created_at)
            return false;
        const agora = new Date();
        const horasAtras = new Date(agora.getTime() - horas * 60 * 60 * 1000);
        return this.created_at > horasAtras;
    }
    /**
     * Calcula a idade do token em horas
     */
    getIdadeEmHoras() {
        if (!this.created_at)
            return 0;
        const agora = new Date();
        const diffTime = Math.abs(agora.getTime() - this.created_at.getTime());
        const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
        return diffHours;
    }
    /**
     * Calcula quantos minutos restam até a expiração
     */
    getMinutosAteExpiracao() {
        const timeToExpiration = this.getTimeToExpiration();
        return Math.floor(timeToExpiration / (1000 * 60));
    }
    /**
     * Verifica se o token foi substituído por outro
     */
    foiSubstituido() {
        return !!this.replacedByToken;
    }
    /**
     * Verifica se o token foi revogado por IP específico
     */
    foiRevogadoPorIp(ip) {
        return this.isRevoked() && this.revokedByIp === ip;
    }
    /**
     * Obtém informações detalhadas do token
     */
    getDetalhes() {
        return {
            id: this.id,
            usuario_id: this.usuario_id,
            ativo: this.isActive(),
            expirado: this.isExpired(),
            revogado: this.isRevoked(),
            criadoEm: this.created_at,
            expiraEm: this.expires_at,
            minutosRestantes: this.getMinutosAteExpiracao(),
            idadeEmHoras: this.getIdadeEmHoras(),
            foiSubstituido: this.foiSubstituido()
        };
    }
    /**
     * Verifica se o token está em estado válido
     */
    isValido() {
        return (!!this.token &&
            !!this.usuario_id &&
            !!this.expires_at &&
            this.expires_at > new Date());
    }
    /**
     * Verifica se o token pode ser renovado
     */
    podeSerRenovado() {
        return this.isActive() && !this.isExpiringWithin(5); // Não renova se expira em menos de 5 minutos
    }
    /**
     * Obtém o tempo de vida útil do token em horas
     */
    getTempoVidaUtil() {
        if (!this.created_at || !this.expires_at)
            return 0;
        const diffTime = this.expires_at.getTime() - this.created_at.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60));
    }
    /**
     * Verifica se o token está próximo da expiração (últimos 10% do tempo de vida)
     */
    isProximoExpiracao() {
        const tempoVidaUtil = this.getTempoVidaUtil();
        const tempoRestante = this.getMinutosAteExpiracao() / 60; // Converter para horas
        return tempoRestante <= (tempoVidaUtil * 0.1);
    }
    /**
     * Formata a data de expiração para exibição
     */
    getExpiracaoFormatada() {
        return this.expires_at.toLocaleString('pt-BR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    /**
     * Obtém um resumo do status do token
     */
    getStatusResumo() {
        if (this.isRevoked()) {
            return `Revogado em ${this.revoked_at?.toLocaleString('pt-BR')}`;
        }
        if (this.isExpired()) {
            return `Expirado em ${this.getExpiracaoFormatada()}`;
        }
        if (this.isProximoExpiracao()) {
            return `Expira em ${this.getMinutosAteExpiracao()} minutos`;
        }
        return 'Ativo';
    }
};
exports.RefreshToken = RefreshToken;
__decorate([
    (0, typeorm_1.PrimaryGeneratedColumn)('uuid'),
    __metadata("design:type", String)
], RefreshToken.prototype, "id", void 0);
__decorate([
    (0, typeorm_1.Column)({ name: 'usuario_id', type: 'uuid', nullable: false }),
    (0, class_validator_1.IsNotEmpty)({ message: 'ID do usuário é obrigatório' }),
    (0, class_validator_1.IsUUID)('4', { message: 'ID do usuário inválido' }),
    __metadata("design:type", String)
], RefreshToken.prototype, "usuario_id", void 0);
__decorate([
    (0, typeorm_1.Column)({ type: 'varchar', length: 500, unique: true }),
    (0, class_validator_1.IsNotEmpty)({ message: 'Token é obrigatório' }),
    (0, class_validator_1.IsString)({ message: 'Token deve ser uma string' }),
    (0, class_validator_1.Length)(10, 500, { message: 'Token deve ter entre 10 e 500 caracteres' }),
    __metadata("design:type", String)
], RefreshToken.prototype, "token", void 0);
__decorate([
    (0, typeorm_1.Column)({ name: 'expires_at', type: 'timestamp with time zone' }),
    __metadata("design:type", typeof (_a = typeof Date !== "undefined" && Date) === "function" ? _a : Object)
], RefreshToken.prototype, "expires_at", void 0);
__decorate([
    (0, typeorm_1.Column)({ type: 'boolean', default: false }),
    (0, class_validator_1.IsBoolean)({ message: 'Revoked deve ser um boolean' }),
    __metadata("design:type", Boolean)
], RefreshToken.prototype, "revoked", void 0);
__decorate([
    (0, typeorm_1.Column)({
        name: 'revoked_at',
        type: 'timestamp with time zone',
        nullable: true,
    }),
    __metadata("design:type", Object)
], RefreshToken.prototype, "revoked_at", void 0);
__decorate([
    (0, typeorm_1.Column)({
        name: 'revoked_by_ip',
        type: 'varchar',
        length: 45,
        nullable: true,
    }),
    (0, class_validator_1.IsOptional)(),
    (0, class_validator_1.IsString)({ message: 'IP deve ser uma string' }),
    (0, class_validator_1.Length)(7, 45, { message: 'IP deve ter entre 7 e 45 caracteres' }),
    __metadata("design:type", Object)
], RefreshToken.prototype, "revokedByIp", void 0);
__decorate([
    (0, typeorm_1.Column)({
        name: 'replaced_by_token',
        type: 'varchar',
        length: 500,
        nullable: true,
    }),
    (0, class_validator_1.IsOptional)(),
    (0, class_validator_1.IsString)({ message: 'Token de substituição deve ser uma string' }),
    (0, class_validator_1.Length)(10, 500, { message: 'Token de substituição deve ter entre 10 e 500 caracteres' }),
    __metadata("design:type", Object)
], RefreshToken.prototype, "replacedByToken", void 0);
__decorate([
    (0, typeorm_1.CreateDateColumn)({ name: 'created_at', type: 'timestamp with time zone' }),
    __metadata("design:type", typeof (_c = typeof Date !== "undefined" && Date) === "function" ? _c : Object)
], RefreshToken.prototype, "created_at", void 0);
__decorate([
    (0, typeorm_1.UpdateDateColumn)({ name: 'updated_at', type: 'timestamp with time zone' }),
    __metadata("design:type", typeof (_d = typeof Date !== "undefined" && Date) === "function" ? _d : Object)
], RefreshToken.prototype, "updated_at", void 0);
__decorate([
    (0, typeorm_1.ManyToOne)(() => usuario_entity_1.Usuario, (usuario) => usuario.refreshTokens, {
        onDelete: 'CASCADE',
    }),
    (0, typeorm_1.JoinColumn)({ name: 'usuario_id', referencedColumnName: 'id' }),
    __metadata("design:type", typeof (_e = typeof usuario_entity_1.Usuario !== "undefined" && usuario_entity_1.Usuario) === "function" ? _e : Object)
], RefreshToken.prototype, "usuario", void 0);
exports.RefreshToken = RefreshToken = __decorate([
    (0, typeorm_1.Entity)('refresh_tokens'),
    (0, typeorm_1.Index)(['usuario_id']),
    (0, typeorm_1.Index)(['token'], { unique: true }),
    (0, typeorm_1.Index)(['expires_at']),
    (0, typeorm_1.Index)(['revoked']),
    (0, typeorm_1.Index)(['usuario_id', 'revoked'])
], RefreshToken);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGVudGl0aWVzXFxyZWZyZXNoLXRva2VuLmVudGl0eS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsNENBQTRDO0FBQzVDLHFDQVNpQjtBQUNqQixxREFBNEc7QUFDNUcscURBQTJDO0FBUXBDLElBQU0sWUFBWSxHQUFsQixNQUFNLFlBQVk7SUFFdkIsRUFBRSxDQUFTO0lBS1gsVUFBVSxDQUFTO0lBTW5CLEtBQUssQ0FBUztJQUdkLFVBQVUsQ0FBTztJQUlqQixPQUFPLENBQVU7SUFPakIsVUFBVSxDQUFjO0lBV3hCLFdBQVcsQ0FBZ0I7SUFXM0IsZUFBZSxDQUFnQjtJQUcvQixVQUFVLENBQU87SUFHakIsVUFBVSxDQUFPO0lBTWpCLE9BQU8sQ0FBVTtJQUVqQixzQkFBc0I7SUFDdEI7O09BRUc7SUFDSCxTQUFTO1FBQ1AsT0FBTyxJQUFJLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDdEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsUUFBUTtRQUNOLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxFQUFXLEVBQUUsZUFBd0I7UUFDMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksRUFBRSxFQUFFLENBQUM7WUFDUCxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN4QixDQUFDO1FBQ0QsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN6QyxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNQLE9B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S0FDcEIsQ0FBQztJQUNELElBQUEsb0JBQVUsRUFBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsSUFBSSxFQUFFLENBQUM7a0RBQ3RELHdCQUFPLG9CQUFQLHdCQUFPOzZDQUFDO3VCQTdETixZQUFZO0lBTnhCLElBQUEsZ0JBQU0sRUFBQyxnQkFBZ0IsQ0FBQztJQUN4QixJQUFBLGVBQUssRUFBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3JCLElBQUEsZUFBSyxFQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDbEMsSUFBQSxlQUFLLEVBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNyQixJQUFBLGVBQUssRUFBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xCLElBQUEsZUFBSyxFQUFDLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0dBQ3BCLFlBQVksQ0F1U3hCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxlbnRpdGllc1xccmVmcmVzaC10b2tlbi5lbnRpdHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL2F1dGgvZW50aXRpZXMvcmVmcmVzaC10b2tlbi5lbnRpdHkudHNcbmltcG9ydCB7XG4gIEVudGl0eSxcbiAgQ29sdW1uLFxuICBQcmltYXJ5R2VuZXJhdGVkQ29sdW1uLFxuICBDcmVhdGVEYXRlQ29sdW1uLFxuICBVcGRhdGVEYXRlQ29sdW1uLFxuICBNYW55VG9PbmUsXG4gIEpvaW5Db2x1bW4sXG4gIEluZGV4LFxufSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IElzTm90RW1wdHksIElzVVVJRCwgSXNCb29sZWFuLCBJc09wdGlvbmFsLCBJc1N0cmluZywgSXNEYXRlU3RyaW5nLCBMZW5ndGggfSBmcm9tICdjbGFzcy12YWxpZGF0b3InO1xuaW1wb3J0IHsgVXN1YXJpbyB9IGZyb20gJy4vdXN1YXJpby5lbnRpdHknO1xuXG5ARW50aXR5KCdyZWZyZXNoX3Rva2VucycpXG5ASW5kZXgoWyd1c3VhcmlvX2lkJ10pXG5ASW5kZXgoWyd0b2tlbiddLCB7IHVuaXF1ZTogdHJ1ZSB9KVxuQEluZGV4KFsnZXhwaXJlc19hdCddKVxuQEluZGV4KFsncmV2b2tlZCddKVxuQEluZGV4KFsndXN1YXJpb19pZCcsICdyZXZva2VkJ10pXG5leHBvcnQgY2xhc3MgUmVmcmVzaFRva2VuIHtcbiAgQFByaW1hcnlHZW5lcmF0ZWRDb2x1bW4oJ3V1aWQnKVxuICBpZDogc3RyaW5nO1xuXG4gIEBDb2x1bW4oeyBuYW1lOiAndXN1YXJpb19pZCcsIHR5cGU6ICd1dWlkJywgbnVsbGFibGU6IGZhbHNlIH0pXG4gIEBJc05vdEVtcHR5KHsgbWVzc2FnZTogJ0lEIGRvIHVzdcOhcmlvIMOpIG9icmlnYXTDs3JpbycgfSlcbiAgQElzVVVJRCgnNCcsIHsgbWVzc2FnZTogJ0lEIGRvIHVzdcOhcmlvIGludsOhbGlkbycgfSlcbiAgdXN1YXJpb19pZDogc3RyaW5nO1xuXG4gIEBDb2x1bW4oeyB0eXBlOiAndmFyY2hhcicsIGxlbmd0aDogNTAwLCB1bmlxdWU6IHRydWUgfSlcbiAgQElzTm90RW1wdHkoeyBtZXNzYWdlOiAnVG9rZW4gw6kgb2JyaWdhdMOzcmlvJyB9KVxuICBASXNTdHJpbmcoeyBtZXNzYWdlOiAnVG9rZW4gZGV2ZSBzZXIgdW1hIHN0cmluZycgfSlcbiAgQExlbmd0aCgxMCwgNTAwLCB7IG1lc3NhZ2U6ICdUb2tlbiBkZXZlIHRlciBlbnRyZSAxMCBlIDUwMCBjYXJhY3RlcmVzJyB9KVxuICB0b2tlbjogc3RyaW5nO1xuXG4gIEBDb2x1bW4oeyBuYW1lOiAnZXhwaXJlc19hdCcsIHR5cGU6ICd0aW1lc3RhbXAgd2l0aCB0aW1lIHpvbmUnIH0pXG4gIGV4cGlyZXNfYXQ6IERhdGU7XG5cbiAgQENvbHVtbih7IHR5cGU6ICdib29sZWFuJywgZGVmYXVsdDogZmFsc2UgfSlcbiAgQElzQm9vbGVhbih7IG1lc3NhZ2U6ICdSZXZva2VkIGRldmUgc2VyIHVtIGJvb2xlYW4nIH0pXG4gIHJldm9rZWQ6IGJvb2xlYW47XG5cbiAgQENvbHVtbih7XG4gICAgbmFtZTogJ3Jldm9rZWRfYXQnLFxuICAgIHR5cGU6ICd0aW1lc3RhbXAgd2l0aCB0aW1lIHpvbmUnLFxuICAgIG51bGxhYmxlOiB0cnVlLFxuICB9KVxuICByZXZva2VkX2F0OiBEYXRlIHwgbnVsbDtcblxuICBAQ29sdW1uKHtcbiAgICBuYW1lOiAncmV2b2tlZF9ieV9pcCcsXG4gICAgdHlwZTogJ3ZhcmNoYXInLFxuICAgIGxlbmd0aDogNDUsXG4gICAgbnVsbGFibGU6IHRydWUsXG4gIH0pXG4gIEBJc09wdGlvbmFsKClcbiAgQElzU3RyaW5nKHsgbWVzc2FnZTogJ0lQIGRldmUgc2VyIHVtYSBzdHJpbmcnIH0pXG4gIEBMZW5ndGgoNywgNDUsIHsgbWVzc2FnZTogJ0lQIGRldmUgdGVyIGVudHJlIDcgZSA0NSBjYXJhY3RlcmVzJyB9KVxuICByZXZva2VkQnlJcDogc3RyaW5nIHwgbnVsbDtcblxuICBAQ29sdW1uKHtcbiAgICBuYW1lOiAncmVwbGFjZWRfYnlfdG9rZW4nLFxuICAgIHR5cGU6ICd2YXJjaGFyJyxcbiAgICBsZW5ndGg6IDUwMCxcbiAgICBudWxsYWJsZTogdHJ1ZSxcbiAgfSlcbiAgQElzT3B0aW9uYWwoKVxuICBASXNTdHJpbmcoeyBtZXNzYWdlOiAnVG9rZW4gZGUgc3Vic3RpdHVpw6fDo28gZGV2ZSBzZXIgdW1hIHN0cmluZycgfSlcbiAgQExlbmd0aCgxMCwgNTAwLCB7IG1lc3NhZ2U6ICdUb2tlbiBkZSBzdWJzdGl0dWnDp8OjbyBkZXZlIHRlciBlbnRyZSAxMCBlIDUwMCBjYXJhY3RlcmVzJyB9KVxuICByZXBsYWNlZEJ5VG9rZW46IHN0cmluZyB8IG51bGw7XG5cbiAgQENyZWF0ZURhdGVDb2x1bW4oeyBuYW1lOiAnY3JlYXRlZF9hdCcsIHR5cGU6ICd0aW1lc3RhbXAgd2l0aCB0aW1lIHpvbmUnIH0pXG4gIGNyZWF0ZWRfYXQ6IERhdGU7XG5cbiAgQFVwZGF0ZURhdGVDb2x1bW4oeyBuYW1lOiAndXBkYXRlZF9hdCcsIHR5cGU6ICd0aW1lc3RhbXAgd2l0aCB0aW1lIHpvbmUnIH0pXG4gIHVwZGF0ZWRfYXQ6IERhdGU7XG5cbiAgQE1hbnlUb09uZSgoKSA9PiBVc3VhcmlvLCAodXN1YXJpbykgPT4gdXN1YXJpby5yZWZyZXNoVG9rZW5zLCB7XG4gICAgb25EZWxldGU6ICdDQVNDQURFJyxcbiAgfSlcbiAgQEpvaW5Db2x1bW4oeyBuYW1lOiAndXN1YXJpb19pZCcsIHJlZmVyZW5jZWRDb2x1bW5OYW1lOiAnaWQnIH0pXG4gIHVzdWFyaW86IFVzdWFyaW87XG5cbiAgLy8gTcOpdG9kb3MgdXRpbGl0w6FyaW9zXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIHRva2VuIGVzdMOhIGV4cGlyYWRvXG4gICAqL1xuICBpc0V4cGlyZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKCkgPiB0aGlzLmV4cGlyZXNfYXQ7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyB0b2tlbiBlc3TDoSBhdGl2byAobsOjbyByZXZvZ2FkbyBlIG7Do28gZXhwaXJhZG8pXG4gICAqL1xuICBpc0FjdGl2ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMucmV2b2tlZCAmJiAhdGhpcy5pc0V4cGlyZWQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZvZ2EgbyB0b2tlblxuICAgKi9cbiAgcmV2b2tlKGlwPzogc3RyaW5nLCByZXBsYWNlZEJ5VG9rZW4/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnJldm9rZWQgPSB0cnVlO1xuICAgIHRoaXMucmV2b2tlZF9hdCA9IG5ldyBEYXRlKCk7XG4gICAgaWYgKGlwKSB7XG4gICAgICB0aGlzLnJldm9rZWRCeUlwID0gaXA7XG4gICAgfVxuICAgIGlmIChyZXBsYWNlZEJ5VG9rZW4pIHtcbiAgICAgIHRoaXMucmVwbGFjZWRCeVRva2VuID0gcmVwbGFjZWRCeVRva2VuO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIHRva2VuIGZvaSByZXZvZ2Fkb1xuICAgKi9cbiAgaXNSZXZva2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJldm9rZWQ7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBvIHRlbXBvIHJlc3RhbnRlIGF0w6kgYSBleHBpcmHDp8OjbyBlbSBtaWxpc3NlZ3VuZG9zXG4gICAqL1xuICBnZXRUaW1lVG9FeHBpcmF0aW9uKCk6IG51bWJlciB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgZXhwaXJhdGlvbiA9IHRoaXMuZXhwaXJlc19hdC5nZXRUaW1lKCk7XG4gICAgcmV0dXJuIE1hdGgubWF4KDAsIGV4cGlyYXRpb24gLSBub3cpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gdG9rZW4gZXhwaXJhIGVtIGJyZXZlIChwcsOzeGltb3MgWCBtaW51dG9zKVxuICAgKi9cbiAgaXNFeHBpcmluZ1dpdGhpbihtaW51dGVzOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCB0aW1lVG9FeHBpcmF0aW9uID0gdGhpcy5nZXRUaW1lVG9FeHBpcmF0aW9uKCk7XG4gICAgY29uc3QgbWludXRlc0luTXMgPSBtaW51dGVzICogNjAgKiAxMDAwO1xuICAgIHJldHVybiB0aW1lVG9FeHBpcmF0aW9uIDw9IG1pbnV0ZXNJbk1zICYmIHRpbWVUb0V4cGlyYXRpb24gPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBpbmZvcm1hw6fDtWVzIGRlIHN0YXR1cyBkbyB0b2tlblxuICAgKi9cbiAgZ2V0U3RhdHVzKCk6IHtcbiAgICBpc0FjdGl2ZTogYm9vbGVhbjtcbiAgICBpc0V4cGlyZWQ6IGJvb2xlYW47XG4gICAgaXNSZXZva2VkOiBib29sZWFuO1xuICAgIHRpbWVUb0V4cGlyYXRpb246IG51bWJlcjtcbiAgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlzQWN0aXZlOiB0aGlzLmlzQWN0aXZlKCksXG4gICAgICBpc0V4cGlyZWQ6IHRoaXMuaXNFeHBpcmVkKCksXG4gICAgICBpc1Jldm9rZWQ6IHRoaXMuaXNSZXZva2VkKCksXG4gICAgICB0aW1lVG9FeHBpcmF0aW9uOiB0aGlzLmdldFRpbWVUb0V4cGlyYXRpb24oKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gdG9rZW4gcGVydGVuY2UgYSB1bSB1c3XDoXJpbyBlc3BlY8OtZmljb1xuICAgKi9cbiAgYmVsb25nc1RvVXNlcih1c2VySWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnVzdWFyaW9faWQgPT09IHVzZXJJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXJhIHVtYSBjaGF2ZSDDum5pY2EgcGFyYSBvIHRva2VuXG4gICAqL1xuICBnZXRVbmlxdWVLZXkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYHJlZnJlc2hfdG9rZW5fJHt0aGlzLnVzdWFyaW9faWR9XyR7dGhpcy5pZH1gO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gdG9rZW4gZm9pIGNyaWFkbyByZWNlbnRlbWVudGUgKMO6bHRpbWFzIFggaG9yYXMpXG4gICAqL1xuICBpc0NyaWFkb1JlY2VudGVtZW50ZShob3JhczogbnVtYmVyID0gMSk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5jcmVhdGVkX2F0KSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgY29uc3QgYWdvcmEgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGhvcmFzQXRyYXMgPSBuZXcgRGF0ZShhZ29yYS5nZXRUaW1lKCkgLSBob3JhcyAqIDYwICogNjAgKiAxMDAwKTtcbiAgICBcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVkX2F0ID4gaG9yYXNBdHJhcztcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhIGEgaWRhZGUgZG8gdG9rZW4gZW0gaG9yYXNcbiAgICovXG4gIGdldElkYWRlRW1Ib3JhcygpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy5jcmVhdGVkX2F0KSByZXR1cm4gMDtcbiAgICBcbiAgICBjb25zdCBhZ29yYSA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgZGlmZlRpbWUgPSBNYXRoLmFicyhhZ29yYS5nZXRUaW1lKCkgLSB0aGlzLmNyZWF0ZWRfYXQuZ2V0VGltZSgpKTtcbiAgICBjb25zdCBkaWZmSG91cnMgPSBNYXRoLmZsb29yKGRpZmZUaW1lIC8gKDEwMDAgKiA2MCAqIDYwKSk7XG4gICAgXG4gICAgcmV0dXJuIGRpZmZIb3VycztcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhIHF1YW50b3MgbWludXRvcyByZXN0YW0gYXTDqSBhIGV4cGlyYcOnw6NvXG4gICAqL1xuICBnZXRNaW51dG9zQXRlRXhwaXJhY2FvKCk6IG51bWJlciB7XG4gICAgY29uc3QgdGltZVRvRXhwaXJhdGlvbiA9IHRoaXMuZ2V0VGltZVRvRXhwaXJhdGlvbigpO1xuICAgIHJldHVybiBNYXRoLmZsb29yKHRpbWVUb0V4cGlyYXRpb24gLyAoMTAwMCAqIDYwKSk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyB0b2tlbiBmb2kgc3Vic3RpdHXDrWRvIHBvciBvdXRyb1xuICAgKi9cbiAgZm9pU3Vic3RpdHVpZG8oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5yZXBsYWNlZEJ5VG9rZW47XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyB0b2tlbiBmb2kgcmV2b2dhZG8gcG9yIElQIGVzcGVjw61maWNvXG4gICAqL1xuICBmb2lSZXZvZ2Fkb1BvcklwKGlwOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pc1Jldm9rZWQoKSAmJiB0aGlzLnJldm9rZWRCeUlwID09PSBpcDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gaW5mb3JtYcOnw7VlcyBkZXRhbGhhZGFzIGRvIHRva2VuXG4gICAqL1xuICBnZXREZXRhbGhlcygpOiB7XG4gICAgaWQ6IHN0cmluZztcbiAgICB1c3VhcmlvX2lkOiBzdHJpbmc7XG4gICAgYXRpdm86IGJvb2xlYW47XG4gICAgZXhwaXJhZG86IGJvb2xlYW47XG4gICAgcmV2b2dhZG86IGJvb2xlYW47XG4gICAgY3JpYWRvRW06IERhdGU7XG4gICAgZXhwaXJhRW06IERhdGU7XG4gICAgbWludXRvc1Jlc3RhbnRlczogbnVtYmVyO1xuICAgIGlkYWRlRW1Ib3JhczogbnVtYmVyO1xuICAgIGZvaVN1YnN0aXR1aWRvOiBib29sZWFuO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICB1c3VhcmlvX2lkOiB0aGlzLnVzdWFyaW9faWQsXG4gICAgICBhdGl2bzogdGhpcy5pc0FjdGl2ZSgpLFxuICAgICAgZXhwaXJhZG86IHRoaXMuaXNFeHBpcmVkKCksXG4gICAgICByZXZvZ2FkbzogdGhpcy5pc1Jldm9rZWQoKSxcbiAgICAgIGNyaWFkb0VtOiB0aGlzLmNyZWF0ZWRfYXQsXG4gICAgICBleHBpcmFFbTogdGhpcy5leHBpcmVzX2F0LFxuICAgICAgbWludXRvc1Jlc3RhbnRlczogdGhpcy5nZXRNaW51dG9zQXRlRXhwaXJhY2FvKCksXG4gICAgICBpZGFkZUVtSG9yYXM6IHRoaXMuZ2V0SWRhZGVFbUhvcmFzKCksXG4gICAgICBmb2lTdWJzdGl0dWlkbzogdGhpcy5mb2lTdWJzdGl0dWlkbygpXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIHRva2VuIGVzdMOhIGVtIGVzdGFkbyB2w6FsaWRvXG4gICAqL1xuICBpc1ZhbGlkbygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgISF0aGlzLnRva2VuICYmXG4gICAgICAhIXRoaXMudXN1YXJpb19pZCAmJlxuICAgICAgISF0aGlzLmV4cGlyZXNfYXQgJiZcbiAgICAgIHRoaXMuZXhwaXJlc19hdCA+IG5ldyBEYXRlKClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gdG9rZW4gcG9kZSBzZXIgcmVub3ZhZG9cbiAgICovXG4gIHBvZGVTZXJSZW5vdmFkbygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pc0FjdGl2ZSgpICYmICF0aGlzLmlzRXhwaXJpbmdXaXRoaW4oNSk7IC8vIE7Do28gcmVub3ZhIHNlIGV4cGlyYSBlbSBtZW5vcyBkZSA1IG1pbnV0b3NcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gbyB0ZW1wbyBkZSB2aWRhIMO6dGlsIGRvIHRva2VuIGVtIGhvcmFzXG4gICAqL1xuICBnZXRUZW1wb1ZpZGFVdGlsKCk6IG51bWJlciB7XG4gICAgaWYgKCF0aGlzLmNyZWF0ZWRfYXQgfHwgIXRoaXMuZXhwaXJlc19hdCkgcmV0dXJuIDA7XG4gICAgXG4gICAgY29uc3QgZGlmZlRpbWUgPSB0aGlzLmV4cGlyZXNfYXQuZ2V0VGltZSgpIC0gdGhpcy5jcmVhdGVkX2F0LmdldFRpbWUoKTtcbiAgICByZXR1cm4gTWF0aC5mbG9vcihkaWZmVGltZSAvICgxMDAwICogNjAgKiA2MCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gdG9rZW4gZXN0w6EgcHLDs3hpbW8gZGEgZXhwaXJhw6fDo28gKMO6bHRpbW9zIDEwJSBkbyB0ZW1wbyBkZSB2aWRhKVxuICAgKi9cbiAgaXNQcm94aW1vRXhwaXJhY2FvKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHRlbXBvVmlkYVV0aWwgPSB0aGlzLmdldFRlbXBvVmlkYVV0aWwoKTtcbiAgICBjb25zdCB0ZW1wb1Jlc3RhbnRlID0gdGhpcy5nZXRNaW51dG9zQXRlRXhwaXJhY2FvKCkgLyA2MDsgLy8gQ29udmVydGVyIHBhcmEgaG9yYXNcbiAgICBcbiAgICByZXR1cm4gdGVtcG9SZXN0YW50ZSA8PSAodGVtcG9WaWRhVXRpbCAqIDAuMSk7XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0YSBhIGRhdGEgZGUgZXhwaXJhw6fDo28gcGFyYSBleGliacOnw6NvXG4gICAqL1xuICBnZXRFeHBpcmFjYW9Gb3JtYXRhZGEoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5leHBpcmVzX2F0LnRvTG9jYWxlU3RyaW5nKCdwdC1CUicsIHtcbiAgICAgIHllYXI6ICdudW1lcmljJyxcbiAgICAgIG1vbnRoOiAnMi1kaWdpdCcsXG4gICAgICBkYXk6ICcyLWRpZ2l0JyxcbiAgICAgIGhvdXI6ICcyLWRpZ2l0JyxcbiAgICAgIG1pbnV0ZTogJzItZGlnaXQnLFxuICAgICAgc2Vjb25kOiAnMi1kaWdpdCdcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gdW0gcmVzdW1vIGRvIHN0YXR1cyBkbyB0b2tlblxuICAgKi9cbiAgZ2V0U3RhdHVzUmVzdW1vKCk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuaXNSZXZva2VkKCkpIHtcbiAgICAgIHJldHVybiBgUmV2b2dhZG8gZW0gJHt0aGlzLnJldm9rZWRfYXQ/LnRvTG9jYWxlU3RyaW5nKCdwdC1CUicpfWA7XG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLmlzRXhwaXJlZCgpKSB7XG4gICAgICByZXR1cm4gYEV4cGlyYWRvIGVtICR7dGhpcy5nZXRFeHBpcmFjYW9Gb3JtYXRhZGEoKX1gO1xuICAgIH1cbiAgICBcbiAgICBpZiAodGhpcy5pc1Byb3hpbW9FeHBpcmFjYW8oKSkge1xuICAgICAgcmV0dXJuIGBFeHBpcmEgZW0gJHt0aGlzLmdldE1pbnV0b3NBdGVFeHBpcmFjYW8oKX0gbWludXRvc2A7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiAnQXRpdm8nO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=