17d9f78e2ed505b28ba0e630a50fa4de
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.InfoBancariaRepository = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("typeorm");
const info_bancaria_entity_1 = require("../../../entities/info-bancaria.entity");
/**
 * Repository para gerenciamento de informações bancárias
 *
 * Responsável por operações de banco de dados relacionadas às informações bancárias dos cidadãos,
 * incluindo contas poupança social do Banco do Brasil e dados PIX.
 */
let InfoBancariaRepository = class InfoBancariaRepository {
    dataSource;
    repository;
    constructor(dataSource) {
        this.dataSource = dataSource;
        this.repository = this.dataSource.getRepository(info_bancaria_entity_1.InfoBancaria);
    }
    /**
     * Cria uma nova informação bancária
     * @param createInfoBancariaDto Dados para criação
     * @returns Informação bancária criada
     */
    async create(createInfoBancariaDto) {
        const infoBancaria = this.repository.create(createInfoBancariaDto);
        return await this.repository.save(infoBancaria);
    }
    /**
     * Busca todas as informações bancárias com filtros opcionais
     * @param options Opções de filtro e paginação
     * @returns Lista de informações bancárias e contagem total
     */
    async findAll(options) {
        const { skip = 0, take = 10, where = {}, order = { created_at: 'DESC' }, includeRelations = false, } = options || {};
        const queryBuilder = this.repository.createQueryBuilder('info_bancaria');
        // Adiciona relações se solicitado
        if (includeRelations) {
            queryBuilder.leftJoinAndSelect('info_bancaria.cidadao', 'cidadao');
        }
        // Aplica filtros
        if (where.cidadao_id) {
            queryBuilder.andWhere('info_bancaria.cidadao_id = :cidadao_id', {
                cidadao_id: where.cidadao_id,
            });
        }
        if (where.banco) {
            queryBuilder.andWhere('info_bancaria.banco = :banco', {
                banco: where.banco,
            });
        }
        if (where.ativo !== undefined) {
            queryBuilder.andWhere('info_bancaria.ativo = :ativo', {
                ativo: where.ativo,
            });
        }
        if (where.tipo_conta) {
            queryBuilder.andWhere('info_bancaria.tipo_conta = :tipo_conta', {
                tipo_conta: where.tipo_conta,
            });
        }
        // Aplica ordenação
        Object.entries(order).forEach(([field, direction]) => {
            queryBuilder.addOrderBy(`info_bancaria.${field}`, direction);
        });
        // Aplica paginação
        queryBuilder.skip(skip).take(take);
        return await queryBuilder.getManyAndCount();
    }
    /**
     * Busca informação bancária por ID
     * @param id ID da informação bancária
     * @param includeRelations Se deve incluir relações
     * @returns Informação bancária encontrada ou null
     */
    async findById(id, includeRelations = false) {
        const queryBuilder = this.repository
            .createQueryBuilder('info_bancaria')
            .where('info_bancaria.id = :id', { id });
        if (includeRelations) {
            queryBuilder.leftJoinAndSelect('info_bancaria.cidadao', 'cidadao');
        }
        return await queryBuilder.getOne();
    }
    /**
     * Busca informação bancária por ID do cidadão
     * @param cidadaoId ID do cidadão
     * @param includeRelations Se deve incluir relações
     * @returns Informação bancária encontrada ou null
     */
    async findByCidadaoId(cidadaoId, includeRelations = false) {
        const queryBuilder = this.repository
            .createQueryBuilder('info_bancaria')
            .where('info_bancaria.cidadao_id = :cidadaoId', { cidadaoId })
            .andWhere('info_bancaria.ativo = :ativo', { ativo: true });
        if (includeRelations) {
            queryBuilder.leftJoinAndSelect('info_bancaria.cidadao', 'cidadao');
        }
        return await queryBuilder.getOne();
    }
    /**
     * Busca informações bancárias por chave PIX
     * @param chavePix Chave PIX
     * @returns Lista de informações bancárias
     */
    async findByChavePix(chavePix) {
        return await this.repository.find({
            where: {
                chave_pix: chavePix,
                ativo: true,
            },
            relations: ['cidadao'],
        });
    }
    /**
     * Atualiza informação bancária
     * @param id ID da informação bancária
     * @param updateInfoBancariaDto Dados para atualização
     * @returns Informação bancária atualizada
     */
    async update(id, updateInfoBancariaDto) {
        await this.repository.update(id, updateInfoBancariaDto);
        return await this.findById(id);
    }
    /**
     * Remove informação bancária (soft delete)
     * @param id ID da informação bancária
     * @returns Resultado da operação
     */
    async remove(id) {
        const result = await this.repository.softDelete(id);
        return (result.affected ?? 0) > 0;
    }
    /**
     * Desativa informação bancária
     * @param id ID da informação bancária
     * @returns Informação bancária atualizada
     */
    async deactivate(id) {
        await this.repository.update(id, { ativo: false });
        return await this.findById(id);
    }
    /**
     * Verifica se existe informação bancária ativa para um cidadão
     * @param cidadaoId ID do cidadão
     * @returns True se existe, false caso contrário
     */
    async existsActiveByCidadaoId(cidadaoId) {
        const count = await this.repository.count({
            where: {
                cidadao_id: cidadaoId,
                ativo: true,
            },
        });
        return count > 0;
    }
    /**
     * Verifica se uma chave PIX já está em uso
     * @param chavePix Chave PIX
     * @param excludeId ID para excluir da verificação (útil em atualizações)
     * @returns True se já existe, false caso contrário
     */
    async existsByChavePix(chavePix, excludeId) {
        const queryBuilder = this.repository
            .createQueryBuilder('info_bancaria')
            .where('info_bancaria.chave_pix = :chavePix', { chavePix })
            .andWhere('info_bancaria.ativo = :ativo', { ativo: true });
        if (excludeId) {
            queryBuilder.andWhere('info_bancaria.id != :excludeId', { excludeId });
        }
        const count = await queryBuilder.getCount();
        return count > 0;
    }
};
exports.InfoBancariaRepository = InfoBancariaRepository;
exports.InfoBancariaRepository = InfoBancariaRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], InfoBancariaRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHJlcG9zaXRvcmllc1xcaW5mby1iYW5jYXJpYS5yZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMscUNBQWlEO0FBQ2pELGlGQUFzRTtBQUl0RTs7Ozs7R0FLRztBQUVJLElBQU0sc0JBQXNCLEdBQTVCLE1BQU0sc0JBQXNCO0lBR2I7SUFGWixVQUFVLENBQTJCO0lBRTdDLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDeEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxtQ0FBWSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsTUFBTSxDQUNWLHFCQUE0QztRQUU1QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ25FLE9BQU8sTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsT0FNYjtRQUNDLE1BQU0sRUFDSixJQUFJLEdBQUcsQ0FBQyxFQUNSLElBQUksR0FBRyxFQUFFLEVBQ1QsS0FBSyxHQUFHLEVBQUUsRUFDVixLQUFLLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEVBQzlCLGdCQUFnQixHQUFHLEtBQUssR0FDekIsR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO1FBRWxCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFekUsa0NBQWtDO1FBQ2xDLElBQUksZ0JBQWdCLEVBQUUs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Q2hCLFNBQWtCO1FBRWxCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVO2FBQ2pDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQzthQUNuQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsQ0FBQzthQUMxRCxRQUFRLENBQUMsOEJBQThCLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUU3RCxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ2QsWUFBWSxDQUFDLFFBQVEsQ0FBQyxnQ0FBZ0MsRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDekUsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVDLE9BQU8sS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNuQixDQUFDO0NBQ0YsQ0FBQTtBQXROWSx3REFBc0I7aUNBQXRCLHNCQUFzQjtJQURsQyxJQUFBLG1CQUFVLEdBQUU7eURBSXFCLG9CQUFVLG9CQUFWLG9CQUFVO0dBSC9CLHNCQUFzQixDQXNObEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHJlcG9zaXRvcmllc1xcaW5mby1iYW5jYXJpYS5yZXBvc2l0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBEYXRhU291cmNlLCBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBJbmZvQmFuY2FyaWEgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9pbmZvLWJhbmNhcmlhLmVudGl0eSc7XG5pbXBvcnQgeyBDcmVhdGVJbmZvQmFuY2FyaWFEdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLWluZm8tYmFuY2FyaWEuZHRvJztcbmltcG9ydCB7IFVwZGF0ZUluZm9CYW5jYXJpYUR0byB9IGZyb20gJy4uL2R0by91cGRhdGUtaW5mby1iYW5jYXJpYS5kdG8nO1xuXG4vKipcbiAqIFJlcG9zaXRvcnkgcGFyYSBnZXJlbmNpYW1lbnRvIGRlIGluZm9ybWHDp8O1ZXMgYmFuY8Ohcmlhc1xuICpcbiAqIFJlc3BvbnPDoXZlbCBwb3Igb3BlcmHDp8O1ZXMgZGUgYmFuY28gZGUgZGFkb3MgcmVsYWNpb25hZGFzIMOgcyBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXMgZG9zIGNpZGFkw6NvcyxcbiAqIGluY2x1aW5kbyBjb250YXMgcG91cGFuw6dhIHNvY2lhbCBkbyBCYW5jbyBkbyBCcmFzaWwgZSBkYWRvcyBQSVguXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJbmZvQmFuY2FyaWFSZXBvc2l0b3J5IHtcbiAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEluZm9CYW5jYXJpYT47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhU291cmNlOiBEYXRhU291cmNlKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy5kYXRhU291cmNlLmdldFJlcG9zaXRvcnkoSW5mb0JhbmNhcmlhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtYSBub3ZhIGluZm9ybWHDp8OjbyBiYW5jw6FyaWFcbiAgICogQHBhcmFtIGNyZWF0ZUluZm9CYW5jYXJpYUR0byBEYWRvcyBwYXJhIGNyaWHDp8Ojb1xuICAgKiBAcmV0dXJucyBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGNyaWFkYVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlKFxuICAgIGNyZWF0ZUluZm9CYW5jYXJpYUR0bzogQ3JlYXRlSW5mb0JhbmNhcmlhRHRvLFxuICApOiBQcm9taXNlPEluZm9CYW5jYXJpYT4ge1xuICAgIGNvbnN0IGluZm9CYW5jYXJpYSA9IHRoaXMucmVwb3NpdG9yeS5jcmVhdGUoY3JlYXRlSW5mb0JhbmNhcmlhRHRvKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LnNhdmUoaW5mb0JhbmNhcmlhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RhcyBhcyBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXMgY29tIGZpbHRyb3Mgb3BjaW9uYWlzXG4gICAqIEBwYXJhbSBvcHRpb25zIE9ww6fDtWVzIGRlIGZpbHRybyBlIHBhZ2luYcOnw6NvXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIGluZm9ybWHDp8O1ZXMgYmFuY8OhcmlhcyBlIGNvbnRhZ2VtIHRvdGFsXG4gICAqL1xuICBhc3luYyBmaW5kQWxsKG9wdGlvbnM/OiB7XG4gICAgc2tpcD86IG51bWJlcjtcbiAgICB0YWtlPzogbnVtYmVyO1xuICAgIHdoZXJlPzogYW55O1xuICAgIG9yZGVyPzogYW55O1xuICAgIGluY2x1ZGVSZWxhdGlvbnM/OiBib29sZWFuO1xuICB9KTogUHJvbWlzZTxbSW5mb0JhbmNhcmlhW10sIG51bWJlcl0+IHtcbiAgICBjb25zdCB7XG4gICAgICBza2lwID0gMCxcbiAgICAgIHRha2UgPSAxMCxcbiAgICAgIHdoZXJlID0ge30sXG4gICAgICBvcmRlciA9IHsgY3JlYXRlZF9hdDogJ0RFU0MnIH0sXG4gICAgICBpbmNsdWRlUmVsYXRpb25zID0gZmFsc2UsXG4gICAgfSA9IG9wdGlvbnMgfHwge307XG5cbiAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSB0aGlzLnJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKCdpbmZvX2JhbmNhcmlhJyk7XG5cbiAgICAvLyBBZGljaW9uYSByZWxhw6fDtWVzIHNlIHNvbGljaXRhZG9cbiAgICBpZiAoaW5jbHVkZVJlbGF0aW9ucykge1xuICAgICAgcXVlcnlCdWlsZGVyLmxlZnRKb2luQW5kU2VsZWN0KCdpbmZvX2JhbmNhcmlhLmNpZGFkYW8nLCAnY2lkYWRhbycpO1xuICAgIH1cblxuICAgIC8vIEFwbGljYSBmaWx0cm9zXG4gICAgaWYgKHdoZXJlLmNpZGFkYW9faWQpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnaW5mb19iYW5jYXJpYS5jaWRhZGFvX2lkID0gOmNpZGFkYW9faWQnLCB7XG4gICAgICAgIGNpZGFkYW9faWQ6IHdoZXJlLmNpZGFkYW9faWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAod2hlcmUuYmFuY28pIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnaW5mb19iYW5jYXJpYS5iYW5jbyA9IDpiYW5jbycsIHtcbiAgICAgICAgYmFuY286IHdoZXJlLmJhbmNvLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHdoZXJlLmF0aXZvICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnaW5mb19iYW5jYXJpYS5hdGl2byA9IDphdGl2bycsIHtcbiAgICAgICAgYXRpdm86IHdoZXJlLmF0aXZvLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHdoZXJlLnRpcG9fY29udGEpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgnaW5mb19iYW5jYXJpYS50aXBvX2NvbnRhID0gOnRpcG9fY29udGEnLCB7XG4gICAgICAgIHRpcG9fY29udGE6IHdoZXJlLnRpcG9fY29udGEsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBcGxpY2Egb3JkZW5hw6fDo29cbiAgICBPYmplY3QuZW50cmllcyhvcmRlcikuZm9yRWFjaCgoW2ZpZWxkLCBkaXJlY3Rpb25dKSA9PiB7XG4gICAgICBxdWVyeUJ1aWxkZXIuYWRkT3JkZXJCeShcbiAgICAgICAgYGluZm9fYmFuY2FyaWEuJHtmaWVsZH1gLFxuICAgICAgICBkaXJlY3Rpb24gYXMgJ0FTQycgfCAnREVTQycsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgLy8gQXBsaWNhIHBhZ2luYcOnw6NvXG4gICAgcXVlcnlCdWlsZGVyLnNraXAoc2tpcCkudGFrZSh0YWtlKTtcblxuICAgIHJldHVybiBhd2FpdCBxdWVyeUJ1aWxkZXIuZ2V0TWFueUFuZENvdW50KCk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBwb3IgSURcbiAgICogQHBhcmFtIGlkIElEIGRhIGluZm9ybWHDp8OjbyBiYW5jw6FyaWFcbiAgICogQHBhcmFtIGluY2x1ZGVSZWxhdGlvbnMgU2UgZGV2ZSBpbmNsdWlyIHJlbGHDp8O1ZXNcbiAgICogQHJldHVybnMgSW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBlbmNvbnRyYWRhIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgaW5jbHVkZVJlbGF0aW9ucyA9IGZhbHNlLFxuICApOiBQcm9taXNlPEluZm9CYW5jYXJpYSB8IG51bGw+IHtcbiAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSB0aGlzLnJlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2luZm9fYmFuY2FyaWEnKVxuICAgICAgLndoZXJlKCdpbmZvX2JhbmNhcmlhLmlkID0gOmlkJywgeyBpZCB9KTtcblxuICAgIGlmIChpbmNsdWRlUmVsYXRpb25zKSB7XG4gICAgICBxdWVyeUJ1aWxkZXIubGVmdEpvaW5BbmRTZWxlY3QoJ2luZm9fYmFuY2FyaWEuY2lkYWRhbycsICdjaWRhZGFvJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHF1ZXJ5QnVpbGRlci5nZXRPbmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhIHBvciBJRCBkbyBjaWRhZMOjb1xuICAgKiBAcGFyYW0gY2lkYWRhb0lkIElEIGRvIGNpZGFkw6NvXG4gICAqIEBwYXJhbSBpbmNsdWRlUmVsYXRpb25zIFNlIGRldmUgaW5jbHVpciByZWxhw6fDtWVzXG4gICAqIEByZXR1cm5zIEluZm9ybWHDp8OjbyBiYW5jw6FyaWEgZW5jb250cmFkYSBvdSBudWxsXG4gICAqL1xuICBhc3luYyBmaW5kQnlDaWRhZGFvSWQoXG4gICAgY2lkYWRhb0lkOiBzdHJpbmcsXG4gICAgaW5jbHVkZVJlbGF0aW9ucyA9IGZhbHNlLFxuICApOiBQcm9taXNlPEluZm9CYW5jYXJpYSB8IG51bGw+IHtcbiAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSB0aGlzLnJlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2luZm9fYmFuY2FyaWEnKVxuICAgICAgLndoZXJlKCdpbmZvX2JhbmNhcmlhLmNpZGFkYW9faWQgPSA6Y2lkYWRhb0lkJywgeyBjaWRhZGFvSWQgfSlcbiAgICAgIC5hbmRXaGVyZSgnaW5mb19iYW5jYXJpYS5hdGl2byA9IDphdGl2bycsIHsgYXRpdm86IHRydWUgfSk7XG5cbiAgICBpZiAoaW5jbHVkZVJlbGF0aW9ucykge1xuICAgICAgcXVlcnlCdWlsZGVyLmxlZnRKb2luQW5kU2VsZWN0KCdpbmZvX2JhbmNhcmlhLmNpZGFkYW8nLCAnY2lkYWRhbycpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBxdWVyeUJ1aWxkZXIuZ2V0T25lKCk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgaW5mb3JtYcOnw7VlcyBiYW5jw6FyaWFzIHBvciBjaGF2ZSBQSVhcbiAgICogQHBhcmFtIGNoYXZlUGl4IENoYXZlIFBJWFxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXNcbiAgICovXG4gIGFzeW5jIGZpbmRCeUNoYXZlUGl4KGNoYXZlUGl4OiBzdHJpbmcpOiBQcm9taXNlPEluZm9CYW5jYXJpYVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVwb3NpdG9yeS5maW5kKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGNoYXZlX3BpeDogY2hhdmVQaXgsXG4gICAgICAgIGF0aXZvOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIHJlbGF0aW9uczogWydjaWRhZGFvJ10sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gaWQgSUQgZGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gdXBkYXRlSW5mb0JhbmNhcmlhRHRvIERhZG9zIHBhcmEgYXR1YWxpemHDp8Ojb1xuICAgKiBAcmV0dXJucyBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHVwZGF0ZShcbiAgICBpZDogc3RyaW5nLFxuICAgIHVwZGF0ZUluZm9CYW5jYXJpYUR0bzogVXBkYXRlSW5mb0JhbmNhcmlhRHRvLFxuICApOiBQcm9taXNlPEluZm9CYW5jYXJpYSB8IG51bGw+IHtcbiAgICBhd2FpdCB0aGlzLnJlcG9zaXRvcnkudXBkYXRlKGlkLCB1cGRhdGVJbmZvQmFuY2FyaWFEdG8pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSAoc29mdCBkZWxldGUpXG4gICAqIEBwYXJhbSBpZCBJRCBkYSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSBvcGVyYcOnw6NvXG4gICAqL1xuICBhc3luYyByZW1vdmUoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5zb2Z0RGVsZXRlKGlkKTtcbiAgICByZXR1cm4gKHJlc3VsdC5hZmZlY3RlZCA/PyAwKSA+IDA7XG4gIH1cblxuICAvKipcbiAgICogRGVzYXRpdmEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gaWQgSUQgZGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcmV0dXJucyBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIGRlYWN0aXZhdGUoaWQ6IHN0cmluZyk6IFByb21pc2U8SW5mb0JhbmNhcmlhIHwgbnVsbD4ge1xuICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeS51cGRhdGUoaWQsIHsgYXRpdm86IGZhbHNlIH0pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBleGlzdGUgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBhdGl2YSBwYXJhIHVtIGNpZGFkw6NvXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cbiAgICogQHJldHVybnMgVHJ1ZSBzZSBleGlzdGUsIGZhbHNlIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgYXN5bmMgZXhpc3RzQWN0aXZlQnlDaWRhZGFvSWQoY2lkYWRhb0lkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBjb3VudCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjaWRhZGFvX2lkOiBjaWRhZGFvSWQsXG4gICAgICAgIGF0aXZvOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICByZXR1cm4gY291bnQgPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtYSBjaGF2ZSBQSVggasOhIGVzdMOhIGVtIHVzb1xuICAgKiBAcGFyYW0gY2hhdmVQaXggQ2hhdmUgUElYXG4gICAqIEBwYXJhbSBleGNsdWRlSWQgSUQgcGFyYSBleGNsdWlyIGRhIHZlcmlmaWNhw6fDo28gKMO6dGlsIGVtIGF0dWFsaXphw6fDtWVzKVxuICAgKiBAcmV0dXJucyBUcnVlIHNlIGrDoSBleGlzdGUsIGZhbHNlIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgYXN5bmMgZXhpc3RzQnlDaGF2ZVBpeChcbiAgICBjaGF2ZVBpeDogc3RyaW5nLFxuICAgIGV4Y2x1ZGVJZD86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID0gdGhpcy5yZXBvc2l0b3J5XG4gICAgICAuY3JlYXRlUXVlcnlCdWlsZGVyKCdpbmZvX2JhbmNhcmlhJylcbiAgICAgIC53aGVyZSgnaW5mb19iYW5jYXJpYS5jaGF2ZV9waXggPSA6Y2hhdmVQaXgnLCB7IGNoYXZlUGl4IH0pXG4gICAgICAuYW5kV2hlcmUoJ2luZm9fYmFuY2FyaWEuYXRpdm8gPSA6YXRpdm8nLCB7IGF0aXZvOiB0cnVlIH0pO1xuXG4gICAgaWYgKGV4Y2x1ZGVJZCkge1xuICAgICAgcXVlcnlCdWlsZGVyLmFuZFdoZXJlKCdpbmZvX2JhbmNhcmlhLmlkICE9IDpleGNsdWRlSWQnLCB7IGV4Y2x1ZGVJZCB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBjb3VudCA9IGF3YWl0IHF1ZXJ5QnVpbGRlci5nZXRDb3VudCgpO1xuICAgIHJldHVybiBjb3VudCA+IDA7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==