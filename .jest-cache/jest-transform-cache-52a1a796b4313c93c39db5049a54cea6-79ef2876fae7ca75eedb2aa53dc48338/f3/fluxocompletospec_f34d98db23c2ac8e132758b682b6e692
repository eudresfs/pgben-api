127567686461268ae5a1362e260507ea
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const common_1 = require("@nestjs/common");
const request = __importStar(require("supertest"));
const app_module_1 = require("../../src/app.module");
const tipo_operacao_enum_1 = require("../../src/modules/auditoria/enums/tipo-operacao.enum");
const typeorm_1 = require("@nestjs/typeorm");
const log_auditoria_entity_1 = require("../../src/modules/auditoria/entities/log-auditoria.entity");
const config_1 = require("@nestjs/config");
// Importações corretas para os serviços
class CriptografiaService {
    criptografar;
    descriptografar;
    criptografarArquivo;
    descriptografarArquivo;
}
class MinioService {
    inicializarBucket;
    uploadArquivo;
    downloadArquivo;
    listarArquivos;
}
describe('Fluxo Completo (e2e)', () => {
    let app;
    let criptografiaService;
    let minioService;
    let logAuditoriaRepository;
    beforeEach(async () => {
        const moduleFixture = await testing_1.Test.createTestingModule({
            imports: [
                config_1.ConfigModule.forRoot({
                    isGlobal: true,
                    envFilePath: '.env.test',
                }),
                app_module_1.AppModule,
            ],
        })
            .overrideProvider((0, typeorm_1.getRepositoryToken)(log_auditoria_entity_1.LogAuditoria))
            .useValue({
            create: jest.fn().mockImplementation((dto) => dto),
            save: jest.fn().mockResolvedValue({ id: 'mock-log-id' }),
            find: jest.fn().mockResolvedValue([]),
            findOne: jest.fn().mockResolvedValue(null),
        })
            .compile();
        app = moduleFixture.createNestApplication();
        app.useGlobalPipes(new common_1.ValidationPipe({
            transform: true,
            whitelist: true,
            forbidNonWhitelisted: true,
        }));
        criptografiaService =
            moduleFixture.get(CriptografiaService);
        minioService = moduleFixture.get(MinioService);
        logAuditoriaRepository = moduleFixture.get((0, typeorm_1.getRepositoryToken)(log_auditoria_entity_1.LogAuditoria));
        // Mock das funções do MinioService
        jest.spyOn(minioService, 'inicializarBucket').mockResolvedValue(undefined);
        jest.spyOn(minioService, 'uploadArquivo').mockResolvedValue({
            etag: 'mock-etag',
            versionId: 'mock-version',
        });
        jest.spyOn(minioService, 'downloadArquivo').mockResolvedValue({
            buffer: Buffer.from('conteúdo do arquivo'),
            contentType: 'application/pdf',
        });
        await app.init();
    });
    afterEach(async () => {
        await app.close();
    });
    describe('Fluxo de Auditoria', () => {
        it('deve registrar log de auditoria ao criar um novo recurso', async () => {
            // Simula a criação de um novo usuário
            const novoUsuario = {
                nome: 'João Silva',
                cpf: '529.982.247-25',
                email: 'joao@exemplo.com',
                telefone: '(84) 99999-8888',
                endereco: {
                    cep: '59000-000',
                    logradouro: 'Rua das Flores',
                    numero: 123,
                    bairro: 'Centro',
                    cidade: 'Natal',
                    uf: 'RN',
                },
            };
            // Faz a requisição para criar o usuário
            await request(app.getHttpServer())
                .post('/api/v1/usuarios')
                .send(novoUsuario)
                .expect(201);
            // Verifica se o log de auditoria foi criado
            expect(logAuditoriaRepository.save).toHaveBeenCalledWith(expect.objectContaining({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'Usuario',
                dados_sensiveis_acessados: expect.arrayContaining([
                    'cpf',
                    'endereco',
                ]),
            }));
        });
        it('deve registrar log de auditoria ao consultar dados sensíveis', async () => {
            // Simula a consulta de um usuário com dados sensíveis
            await request(app.getHttpServer())
                .get('/api/v1/usuarios/123e4567-e89b-12d3-a456-426614174000')
                .expect(200);
            // Verifica se o log de auditoria foi criado
            expect(logAuditoriaRepository.save).toHaveBeenCalledWith(expect.objectContaining({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.READ,
                entidade_afetada: 'Usuario',
                entidade_id: '123e4567-e89b-12d3-a456-426614174000',
            }));
        });
    });
    describe('Fluxo de Criptografia', () => {
        it('deve criptografar dados sensíveis antes de armazenar', async () => {
            // Espia o método de criptografia
            const spyCriptografar = jest.spyOn(criptografiaService, 'criptografar');
            // Simula a criação de um documento com dados sensíveis
            const novoDocumento = {
                titulo: 'Contrato de Trabalho',
                tipo: 'PDF',
                conteudo: 'Dados sensíveis do contrato',
                usuario_id: '123e4567-e89b-12d3-a456-426614174000',
            };
            // Faz a requisição para criar o documento
            await request(app.getHttpServer())
                .post('/api/v1/documentos')
                .send(novoDocumento)
                .expect(201);
            // Verifica se o método de criptografia foi chamado
            expect(spyCriptografar).toHaveBeenCalled();
        });
        it('deve descriptografar dados sensíveis ao consultar', async () => {
            // Espia o método de descriptografia
            const spyDescriptografar = jest.spyOn(criptografiaService, 'descriptografar');
            // Simula a consulta de um documento com dados sensíveis
            await request(app.getHttpServer())
                .get('/api/v1/documentos/123e4567-e89b-12d3-a456-426614174000')
                .expect(200);
            // Verifica se o método de descriptografia foi chamado
            expect(spyDescriptografar).toHaveBeenCalled();
        });
    });
    describe('Fluxo de Armazenamento no MinIO', () => {
        it('deve armazenar documentos no MinIO com criptografia', async () => {
            // Cria um buffer simulando um arquivo
            const arquivoBuffer = Buffer.from('Conteúdo do arquivo PDF');
            // Simula o upload de um documento
            await request(app.getHttpServer())
                .post('/api/v1/documentos/upload')
                .attach('arquivo', arquivoBuffer, {
                filename: 'documento.pdf',
                contentType: 'application/pdf',
            })
                .field('metadados', JSON.stringify({
                titulo: 'Contrato de Trabalho',
                tipo: 'PDF',
                usuario_id: '123e4567-e89b-12d3-a456-426614174000',
            }))
                .expect(201);
            // Verifica se o método de upload do MinIO foi chamado com criptografia
            expect(minioService.uploadArquivo).toHaveBeenCalledWith(expect.any(Buffer), expect.stringContaining('documento.pdf'), 'pgben-documentos', 'application/pdf', expect.objectContaining({
                titulo: 'Contrato de Trabalho',
                tipo: 'PDF',
                usuario_id: '123e4567-e89b-12d3-a456-426614174000',
            }), true);
        });
        it('deve recuperar documentos do MinIO e descriptografar', async () => {
            // Simula o download de um documento
            await request(app.getHttpServer())
                .get('/api/v1/documentos/123e4567-e89b-12d3-a456-426614174000/download')
                .expect(200);
            // Verifica se o método de download do MinIO foi chamado
            expect(minioService.downloadArquivo).toHaveBeenCalledWith(expect.stringContaining('123e4567-e89b-12d3-a456-426614174000'), 'pgben-documentos');
        });
    });
    describe('Validação de DTOs', () => {
        it('deve rejeitar dados inválidos com mensagens apropriadas', async () => {
            // Simula a criação de um usuário com CPF inválido
            const usuarioInvalido = {
                nome: 'João Silva',
                cpf: '111.111.111-11', // CPF inválido (dígitos repetidos)
                email: 'joao@exemplo.com',
                telefone: '(84) 99999-8888',
                endereco: {
                    cep: '59000-000',
                    logradouro: 'Rua das Flores',
                    numero: 123,
                    bairro: 'Centro',
                    cidade: 'Natal',
                    uf: 'RN',
                },
            };
            // Faz a requisição para criar o usuário
            const response = await request(app.getHttpServer())
                .post('/api/v1/usuarios')
                .send(usuarioInvalido)
                .expect(400);
            // Verifica se a resposta contém a mensagem de erro apropriada
            expect(response.body.message).toContain('CPF inválido');
        });
        it('deve rejeitar dados incompletos com mensagens apropriadas', async () => {
            // Simula a criação de um usuário sem campos obrigatórios
            const usuarioIncompleto = {
                nome: 'João Silva',
                // CPF ausente (obrigatório)
                email: 'joao@exemplo.com',
                // Outros campos obrigatórios ausentes
            };
            // Faz a requisição para criar o usuário
            const response = await request(app.getHttpServer())
                .post('/api/v1/usuarios')
                .send(usuarioIncompleto)
                .expect(400);
            // Verifica se a resposta contém as mensagens de erro apropriadas
            expect(response.body.message).toContain('cpf');
        });
    });
    describe('Fluxo Completo', () => {
        it('deve executar o fluxo completo de criação, auditoria, criptografia e armazenamento', async () => {
            // Espia os métodos relevantes
            const spyCriptografar = jest.spyOn(criptografiaService, 'criptografar');
            // Simula a criação de um documento com dados sensíveis e upload de arquivo
            const arquivoBuffer = Buffer.from('Conteúdo do arquivo PDF');
            await request(app.getHttpServer())
                .post('/api/v1/documentos/upload')
                .attach('arquivo', arquivoBuffer, {
                filename: 'documento.pdf',
                contentType: 'application/pdf',
            })
                .field('metadados', JSON.stringify({
                titulo: 'Contrato de Trabalho',
                tipo: 'PDF',
                conteudo: 'Dados sensíveis do contrato',
                usuario_id: '123e4567-e89b-12d3-a456-426614174000',
            }))
                .expect(201);
            // Verifica se os métodos de criptografia foram chamados
            expect(spyCriptografar).toHaveBeenCalled();
            // Verifica se o método de upload do MinIO foi chamado
            expect(minioService.uploadArquivo).toHaveBeenCalled();
            // Verifica se o log de auditoria foi criado
            expect(logAuditoriaRepository.save).toHaveBeenCalledWith(expect.objectContaining({
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'Documento',
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxpbnRlZ3JhdGlvblxcZmx1eG8tY29tcGxldG8uc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUFzRDtBQUN0RCwyQ0FBa0U7QUFDbEUsbURBQXFDO0FBQ3JDLHFEQUFpRDtBQUNqRCw2RkFBb0Y7QUFDcEYsNkNBQXFEO0FBQ3JELG9HQUF5RjtBQUN6RiwyQ0FBOEM7QUFFOUMsd0NBQXdDO0FBQ3hDLE1BQU0sbUJBQW1CO0lBQ3ZCLFlBQVksQ0FBWTtJQUN4QixlQUFlLENBQVk7SUFDM0IsbUJBQW1CLENBQVk7SUFDL0Isc0JBQXNCLENBQVk7Q0FDbkM7QUFFRCxNQUFNLFlBQVk7SUFDaEIsaUJBQWlCLENBQVk7SUFDN0IsYUFBYSxDQUFZO0lBQ3pCLGVBQWUsQ0FBWTtJQUMzQixjQUFjLENBQVk7Q0FDM0I7QUFFRCxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksR0FBcUIsQ0FBQztJQUMxQixJQUFJLG1CQUF3QyxDQUFDO0lBQzdDLElBQUksWUFBMEIsQ0FBQztJQUMvQixJQUFJLHNCQUEyQixDQUFDO0lBRWhDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLGFBQWEsR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDbEUsT0FBTyxFQUFFO2dCQUNQLHFCQUFZLENBQUMsT0FBTyxDQUFDO29CQUNuQixRQUFRLEVBQUUsSUFBSTtvQkFDZCxXQUFXLEVBQUUsV0FBVztpQkFDekIsQ0FBQztnQkFDRixzQkFBUzthQUNWO1NBQ0YsQ0FBQzthQUNDLGdCQUFnQixDQUFDLElBQUEsNEJBQWtCLEVBQUMsbUNBQVksQ0FBQyxDQUFDO2FBQ2xELFFBQVEsQ0FBQztZQUNSLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMs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YUFDOUIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxpbnRlZ3JhdGlvblxcZmx1eG8tY29tcGxldG8uc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24sIFZhbGlkYXRpb25QaXBlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0ICogYXMgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnLi4vLi4vc3JjL2FwcC5tb2R1bGUnO1xuaW1wb3J0IHsgVGlwb09wZXJhY2FvIH0gZnJvbSAnLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL2VudW1zL3RpcG8tb3BlcmFjYW8uZW51bSc7XG5pbXBvcnQgeyBnZXRSZXBvc2l0b3J5VG9rZW4gfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgTG9nQXVkaXRvcmlhIH0gZnJvbSAnLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL2VudGl0aWVzL2xvZy1hdWRpdG9yaWEuZW50aXR5JztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcblxuLy8gSW1wb3J0YcOnw7VlcyBjb3JyZXRhcyBwYXJhIG9zIHNlcnZpw6dvc1xuY2xhc3MgQ3JpcHRvZ3JhZmlhU2VydmljZSB7XG4gIGNyaXB0b2dyYWZhcjogamVzdC5Nb2NrO1xuICBkZXNjcmlwdG9ncmFmYXI6IGplc3QuTW9jaztcbiAgY3JpcHRvZ3JhZmFyQXJxdWl2bzogamVzdC5Nb2NrO1xuICBkZXNjcmlwdG9ncmFmYXJBcnF1aXZvOiBqZXN0Lk1vY2s7XG59XG5cbmNsYXNzIE1pbmlvU2VydmljZSB7XG4gIGluaWNpYWxpemFyQnVja2V0OiBqZXN0Lk1vY2s7XG4gIHVwbG9hZEFycXVpdm86IGplc3QuTW9jaztcbiAgZG93bmxvYWRBcnF1aXZvOiBqZXN0Lk1vY2s7XG4gIGxpc3RhckFycXVpdm9zOiBqZXN0Lk1vY2s7XG59XG5cbmRlc2NyaWJlKCdGbHV4byBDb21wbGV0byAoZTJlKScsICgpID0+IHtcbiAgbGV0IGFwcDogSU5lc3RBcHBsaWNhdGlvbjtcbiAgbGV0IGNyaXB0b2dyYWZpYVNlcnZpY2U6IENyaXB0b2dyYWZpYVNlcnZpY2U7XG4gIGxldCBtaW5pb1NlcnZpY2U6IE1pbmlvU2VydmljZTtcbiAgbGV0IGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnk6IGFueTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGVGaXh0dXJlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtcbiAgICAgICAgQ29uZmlnTW9kdWxlLmZvclJvb3Qoe1xuICAgICAgICAgIGlzR2xvYmFsOiB0cnVlLFxuICAgICAgICAgIGVudkZpbGVQYXRoOiAnLmVudi50ZXN0JyxcbiAgICAgICAgfSksXG4gICAgICAgIEFwcE1vZHVsZSxcbiAgICAgIF0sXG4gICAgfSlcbiAgICAgIC5vdmVycmlkZVByb3ZpZGVyKGdldFJlcG9zaXRvcnlUb2tlbihMb2dBdWRpdG9yaWEpKVxuICAgICAgLnVzZVZhbHVlKHtcbiAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChkdG8pID0+IGR0byksXG4gICAgICAgIHNhdmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnbW9jay1sb2ctaWQnIH0pLFxuICAgICAgICBmaW5kOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW10pLFxuICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobnVsbCksXG4gICAgICB9KVxuICAgICAgLmNvbXBpbGUoKTtcblxuICAgIGFwcCA9IG1vZHVsZUZpeHR1cmUuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXBwLnVzZUdsb2JhbFBpcGVzKFxuICAgICAgbmV3IFZhbGlkYXRpb25QaXBlKHtcbiAgICAgICAgdHJhbnNmb3JtOiB0cnVlLFxuICAgICAgICB3aGl0ZWxpc3Q6IHRydWUsXG4gICAgICAgIGZvcmJpZE5vbldoaXRlbGlzdGVkOiB0cnVlLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGNyaXB0b2dyYWZpYVNlcnZpY2UgPVxuICAgICAgbW9kdWxlRml4dHVyZS5nZXQ8Q3JpcHRvZ3JhZmlhU2VydmljZT4oQ3JpcHRvZ3JhZmlhU2VydmljZSk7XG4gICAgbWluaW9TZXJ2aWNlID0gbW9kdWxlRml4dHVyZS5nZXQ8TWluaW9TZXJ2aWNlPihNaW5pb1NlcnZpY2UpO1xuICAgIGxvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkgPSBtb2R1bGVGaXh0dXJlLmdldChcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihMb2dBdWRpdG9yaWEpLFxuICAgICk7XG5cbiAgICAvLyBNb2NrIGRhcyBmdW7Dp8O1ZXMgZG8gTWluaW9TZXJ2aWNlXG4gICAgamVzdC5zcHlPbihtaW5pb1NlcnZpY2UsICdpbmljaWFsaXphckJ1Y2tldCcpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG4gICAgamVzdC5zcHlPbihtaW5pb1NlcnZpY2UsICd1cGxvYWRBcnF1aXZvJykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgZXRhZzogJ21vY2stZXRhZycsXG4gICAgICB2ZXJzaW9uSWQ6ICdtb2NrLXZlcnNpb24nLFxuICAgIH0pO1xuICAgIGplc3Quc3B5T24obWluaW9TZXJ2aWNlLCAnZG93bmxvYWRBcnF1aXZvJykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgYnVmZmVyOiBCdWZmZXIuZnJvbSgnY29udGXDumRvIGRvIGFycXVpdm8nKSxcbiAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICB9KTtcblxuICAgIGF3YWl0IGFwcC5pbml0KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdGbHV4byBkZSBBdWRpdG9yaWEnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSBhdWRpdG9yaWEgYW8gY3JpYXIgdW0gbm92byByZWN1cnNvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhIGEgY3JpYcOnw6NvIGRlIHVtIG5vdm8gdXN1w6FyaW9cbiAgICAgIGNvbnN0IG5vdm9Vc3VhcmlvID0ge1xuICAgICAgICBub21lOiAnSm/Do28gU2lsdmEnLFxuICAgICAgICBjcGY6ICc1MjkuOTgyLjI0Ny0yNScsXG4gICAgICAgIGVtYWlsOiAnam9hb0BleGVtcGxvLmNvbScsXG4gICAgICAgIHRlbGVmb25lOiAnKDg0KSA5OTk5OS04ODg4JyxcbiAgICAgICAgZW5kZXJlY286IHtcbiAgICAgICAgICBjZXA6ICc1OTAwMC0wMDAnLFxuICAgICAgICAgIGxvZ3JhZG91cm86ICdSdWEgZGFzIEZsb3JlcycsXG4gICAgICAgICAgbnVtZXJvOiAxMjMsXG4gICAgICAgICAgYmFpcnJvOiAnQ2VudHJvJyxcbiAgICAgICAgICBjaWRhZGU6ICdOYXRhbCcsXG4gICAgICAgICAgdWY6ICdSTicsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICAvLyBGYXogYSByZXF1aXNpw6fDo28gcGFyYSBjcmlhciBvIHVzdcOhcmlvXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5wb3N0KCcvYXBpL3YxL3VzdWFyaW9zJylcbiAgICAgICAgLnNlbmQobm92b1VzdWFyaW8pXG4gICAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgbyBsb2cgZGUgYXVkaXRvcmlhIGZvaSBjcmlhZG9cbiAgICAgIGV4cGVjdChsb2dBdWRpdG9yaWFSZXBvc2l0b3J5LnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLkNSRUFURSxcbiAgICAgICAgICBlbnRpZGFkZV9hZmV0YWRhOiAnVXN1YXJpbycsXG4gICAgICAgICAgZGFkb3Nfc2Vuc2l2ZWlzX2FjZXNzYWRvczogZXhwZWN0LmFycmF5Q29udGFpbmluZyhbXG4gICAgICAgICAgICAnY3BmJyxcbiAgICAgICAgICAgICdlbmRlcmVjbycsXG4gICAgICAgICAgXSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgZGUgYXVkaXRvcmlhIGFvIGNvbnN1bHRhciBkYWRvcyBzZW5zw612ZWlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhIGEgY29uc3VsdGEgZGUgdW0gdXN1w6FyaW8gY29tIGRhZG9zIHNlbnPDrXZlaXNcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLmdldCgnL2FwaS92MS91c3Vhcmlvcy8xMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAnKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhIHNlIG8gbG9nIGRlIGF1ZGl0b3JpYSBmb2kgY3JpYWRvXG4gICAgICBleHBlY3QobG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5zYXZlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHRpcG9fb3BlcmFjYW86IFRpcG9PcGVyYWNhby5SRUFELFxuICAgICAgICAgIGVudGlkYWRlX2FmZXRhZGE6ICdVc3VhcmlvJyxcbiAgICAgICAgICBlbnRpZGFkZV9pZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0ZsdXhvIGRlIENyaXB0b2dyYWZpYScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBjcmlwdG9ncmFmYXIgZGFkb3Mgc2Vuc8OtdmVpcyBhbnRlcyBkZSBhcm1hemVuYXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBFc3BpYSBvIG3DqXRvZG8gZGUgY3JpcHRvZ3JhZmlhXG4gICAgICBjb25zdCBzcHlDcmlwdG9ncmFmYXIgPSBqZXN0LnNweU9uKGNyaXB0b2dyYWZpYVNlcnZpY2UsICdjcmlwdG9ncmFmYXInKTtcblxuICAgICAgLy8gU2ltdWxhIGEgY3JpYcOnw6NvIGRlIHVtIGRvY3VtZW50byBjb20gZGFkb3Mgc2Vuc8OtdmVpc1xuICAgICAgY29uc3Qgbm92b0RvY3VtZW50byA9IHtcbiAgICAgICAgdGl0dWxvOiAnQ29udHJhdG8gZGUgVHJhYmFsaG8nLFxuICAgICAgICB0aXBvOiAnUERGJyxcbiAgICAgICAgY29udGV1ZG86ICdEYWRvcyBzZW5zw612ZWlzIGRvIGNvbnRyYXRvJyxcbiAgICAgICAgdXN1YXJpb19pZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICB9O1xuXG4gICAgICAvLyBGYXogYSByZXF1aXNpw6fDo28gcGFyYSBjcmlhciBvIGRvY3VtZW50b1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdCgnL2FwaS92MS9kb2N1bWVudG9zJylcbiAgICAgICAgLnNlbmQobm92b0RvY3VtZW50bylcbiAgICAgICAgLmV4cGVjdCgyMDEpO1xuXG4gICAgICAvLyBWZXJpZmljYSBzZSBvIG3DqXRvZG8gZGUgY3JpcHRvZ3JhZmlhIGZvaSBjaGFtYWRvXG4gICAgICBleHBlY3Qoc3B5Q3JpcHRvZ3JhZmFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBkZXNjcmlwdG9ncmFmYXIgZGFkb3Mgc2Vuc8OtdmVpcyBhbyBjb25zdWx0YXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBFc3BpYSBvIG3DqXRvZG8gZGUgZGVzY3JpcHRvZ3JhZmlhXG4gICAgICBjb25zdCBzcHlEZXNjcmlwdG9ncmFmYXIgPSBqZXN0LnNweU9uKFxuICAgICAgICBjcmlwdG9ncmFmaWFTZXJ2aWNlLFxuICAgICAgICAnZGVzY3JpcHRvZ3JhZmFyJyxcbiAgICAgICk7XG5cbiAgICAgIC8vIFNpbXVsYSBhIGNvbnN1bHRhIGRlIHVtIGRvY3VtZW50byBjb20gZGFkb3Mgc2Vuc8OtdmVpc1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAuZ2V0KCcvYXBpL3YxL2RvY3VtZW50b3MvMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwJylcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBWZXJpZmljYSBzZSBvIG3DqXRvZG8gZGUgZGVzY3JpcHRvZ3JhZmlhIGZvaSBjaGFtYWRvXG4gICAgICBleHBlY3Qoc3B5RGVzY3JpcHRvZ3JhZmFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdGbHV4byBkZSBBcm1hemVuYW1lbnRvIG5vIE1pbklPJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIGFybWF6ZW5hciBkb2N1bWVudG9zIG5vIE1pbklPIGNvbSBjcmlwdG9ncmFmaWEnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmlhIHVtIGJ1ZmZlciBzaW11bGFuZG8gdW0gYXJxdWl2b1xuICAgICAgY29uc3QgYXJxdWl2b0J1ZmZlciA9IEJ1ZmZlci5mcm9tKCdDb250ZcO6ZG8gZG8gYXJxdWl2byBQREYnKTtcblxuICAgICAgLy8gU2ltdWxhIG8gdXBsb2FkIGRlIHVtIGRvY3VtZW50b1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdCgnL2FwaS92MS9kb2N1bWVudG9zL3VwbG9hZCcpXG4gICAgICAgIC5hdHRhY2goJ2FycXVpdm8nLCBhcnF1aXZvQnVmZmVyLCB7XG4gICAgICAgICAgZmlsZW5hbWU6ICdkb2N1bWVudG8ucGRmJyxcbiAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICAgIH0pXG4gICAgICAgIC5maWVsZChcbiAgICAgICAgICAnbWV0YWRhZG9zJyxcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICB0aXR1bG86ICdDb250cmF0byBkZSBUcmFiYWxobycsXG4gICAgICAgICAgICB0aXBvOiAnUERGJyxcbiAgICAgICAgICAgIHVzdWFyaW9faWQ6ICcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAnLFxuICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgbyBtw6l0b2RvIGRlIHVwbG9hZCBkbyBNaW5JTyBmb2kgY2hhbWFkbyBjb20gY3JpcHRvZ3JhZmlhXG4gICAgICBleHBlY3QobWluaW9TZXJ2aWNlLnVwbG9hZEFycXVpdm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QuYW55KEJ1ZmZlciksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdkb2N1bWVudG8ucGRmJyksXG4gICAgICAgICdwZ2Jlbi1kb2N1bWVudG9zJyxcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0aXR1bG86ICdDb250cmF0byBkZSBUcmFiYWxobycsXG4gICAgICAgICAgdGlwbzogJ1BERicsXG4gICAgICAgICAgdXN1YXJpb19pZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICAgIH0pLFxuICAgICAgICB0cnVlLCAvLyBDcmlwdG9ncmFmYXIgPSB0cnVlXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmVjdXBlcmFyIGRvY3VtZW50b3MgZG8gTWluSU8gZSBkZXNjcmlwdG9ncmFmYXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTaW11bGEgbyBkb3dubG9hZCBkZSB1bSBkb2N1bWVudG9cbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLmdldCgnL2FwaS92MS9kb2N1bWVudG9zLzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMC9kb3dubG9hZCcpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgbyBtw6l0b2RvIGRlIGRvd25sb2FkIGRvIE1pbklPIGZvaSBjaGFtYWRvXG4gICAgICBleHBlY3QobWluaW9TZXJ2aWNlLmRvd25sb2FkQXJxdWl2bykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAnKSxcbiAgICAgICAgJ3BnYmVuLWRvY3VtZW50b3MnLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1ZhbGlkYcOnw6NvIGRlIERUT3MnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmVqZWl0YXIgZGFkb3MgaW52w6FsaWRvcyBjb20gbWVuc2FnZW5zIGFwcm9wcmlhZGFzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhIGEgY3JpYcOnw6NvIGRlIHVtIHVzdcOhcmlvIGNvbSBDUEYgaW52w6FsaWRvXG4gICAgICBjb25zdCB1c3VhcmlvSW52YWxpZG8gPSB7XG4gICAgICAgIG5vbWU6ICdKb8OjbyBTaWx2YScsXG4gICAgICAgIGNwZjogJzExMS4xMTEuMTExLTExJywgLy8gQ1BGIGludsOhbGlkbyAoZMOtZ2l0b3MgcmVwZXRpZG9zKVxuICAgICAgICBlbWFpbDogJ2pvYW9AZXhlbXBsby5jb20nLFxuICAgICAgICB0ZWxlZm9uZTogJyg4NCkgOTk5OTktODg4OCcsXG4gICAgICAgIGVuZGVyZWNvOiB7XG4gICAgICAgICAgY2VwOiAnNTkwMDAtMDAwJyxcbiAgICAgICAgICBsb2dyYWRvdXJvOiAnUnVhIGRhcyBGbG9yZXMnLFxuICAgICAgICAgIG51bWVybzogMTIzLFxuICAgICAgICAgIGJhaXJybzogJ0NlbnRybycsXG4gICAgICAgICAgY2lkYWRlOiAnTmF0YWwnLFxuICAgICAgICAgIHVmOiAnUk4nLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgLy8gRmF6IGEgcmVxdWlzacOnw6NvIHBhcmEgY3JpYXIgbyB1c3XDoXJpb1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5wb3N0KCcvYXBpL3YxL3VzdWFyaW9zJylcbiAgICAgICAgLnNlbmQodXN1YXJpb0ludmFsaWRvKVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhIHNlIGEgcmVzcG9zdGEgY29udMOpbSBhIG1lbnNhZ2VtIGRlIGVycm8gYXByb3ByaWFkYVxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubWVzc2FnZSkudG9Db250YWluKCdDUEYgaW52w6FsaWRvJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZWplaXRhciBkYWRvcyBpbmNvbXBsZXRvcyBjb20gbWVuc2FnZW5zIGFwcm9wcmlhZGFzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhIGEgY3JpYcOnw6NvIGRlIHVtIHVzdcOhcmlvIHNlbSBjYW1wb3Mgb2JyaWdhdMOzcmlvc1xuICAgICAgY29uc3QgdXN1YXJpb0luY29tcGxldG8gPSB7XG4gICAgICAgIG5vbWU6ICdKb8OjbyBTaWx2YScsXG4gICAgICAgIC8vIENQRiBhdXNlbnRlIChvYnJpZ2F0w7NyaW8pXG4gICAgICAgIGVtYWlsOiAnam9hb0BleGVtcGxvLmNvbScsXG4gICAgICAgIC8vIE91dHJvcyBjYW1wb3Mgb2JyaWdhdMOzcmlvcyBhdXNlbnRlc1xuICAgICAgfTtcblxuICAgICAgLy8gRmF6IGEgcmVxdWlzacOnw6NvIHBhcmEgY3JpYXIgbyB1c3XDoXJpb1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5wb3N0KCcvYXBpL3YxL3VzdWFyaW9zJylcbiAgICAgICAgLnNlbmQodXN1YXJpb0luY29tcGxldG8pXG4gICAgICAgIC5leHBlY3QoNDAwKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgYSByZXNwb3N0YSBjb250w6ltIGFzIG1lbnNhZ2VucyBkZSBlcnJvIGFwcm9wcmlhZGFzXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5tZXNzYWdlKS50b0NvbnRhaW4oJ2NwZicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRmx1eG8gQ29tcGxldG8nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgZXhlY3V0YXIgbyBmbHV4byBjb21wbGV0byBkZSBjcmlhw6fDo28sIGF1ZGl0b3JpYSwgY3JpcHRvZ3JhZmlhIGUgYXJtYXplbmFtZW50bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEVzcGlhIG9zIG3DqXRvZG9zIHJlbGV2YW50ZXNcbiAgICAgIGNvbnN0IHNweUNyaXB0b2dyYWZhciA9IGplc3Quc3B5T24oY3JpcHRvZ3JhZmlhU2VydmljZSwgJ2NyaXB0b2dyYWZhcicpO1xuXG4gICAgICAvLyBTaW11bGEgYSBjcmlhw6fDo28gZGUgdW0gZG9jdW1lbnRvIGNvbSBkYWRvcyBzZW5zw612ZWlzIGUgdXBsb2FkIGRlIGFycXVpdm9cbiAgICAgIGNvbnN0IGFycXVpdm9CdWZmZXIgPSBCdWZmZXIuZnJvbSgnQ29udGXDumRvIGRvIGFycXVpdm8gUERGJyk7XG5cbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLnBvc3QoJy9hcGkvdjEvZG9jdW1lbnRvcy91cGxvYWQnKVxuICAgICAgICAuYXR0YWNoKCdhcnF1aXZvJywgYXJxdWl2b0J1ZmZlciwge1xuICAgICAgICAgIGZpbGVuYW1lOiAnZG9jdW1lbnRvLnBkZicsXG4gICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICAgICB9KVxuICAgICAgICAuZmllbGQoXG4gICAgICAgICAgJ21ldGFkYWRvcycsXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgdGl0dWxvOiAnQ29udHJhdG8gZGUgVHJhYmFsaG8nLFxuICAgICAgICAgICAgdGlwbzogJ1BERicsXG4gICAgICAgICAgICBjb250ZXVkbzogJ0RhZG9zIHNlbnPDrXZlaXMgZG8gY29udHJhdG8nLFxuICAgICAgICAgICAgdXN1YXJpb19pZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCcsXG4gICAgICAgICAgfSksXG4gICAgICAgIClcbiAgICAgICAgLmV4cGVjdCgyMDEpO1xuXG4gICAgICAvLyBWZXJpZmljYSBzZSBvcyBtw6l0b2RvcyBkZSBjcmlwdG9ncmFmaWEgZm9yYW0gY2hhbWFkb3NcbiAgICAgIGV4cGVjdChzcHlDcmlwdG9ncmFmYXIpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgbyBtw6l0b2RvIGRlIHVwbG9hZCBkbyBNaW5JTyBmb2kgY2hhbWFkb1xuICAgICAgZXhwZWN0KG1pbmlvU2VydmljZS51cGxvYWRBcnF1aXZvKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhIHNlIG8gbG9nIGRlIGF1ZGl0b3JpYSBmb2kgY3JpYWRvXG4gICAgICBleHBlY3QobG9nQXVkaXRvcmlhUmVwb3NpdG9yeS5zYXZlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHRpcG9fb3BlcmFjYW86IFRpcG9PcGVyYWNhby5DUkVBVEUsXG4gICAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ0RvY3VtZW50bycsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==