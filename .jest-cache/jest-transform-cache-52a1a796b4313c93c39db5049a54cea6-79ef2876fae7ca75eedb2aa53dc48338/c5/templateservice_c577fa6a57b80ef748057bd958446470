7fcf775822df6d222a0aabfda7ac7456
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TemplateService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TemplateService = void 0;
const common_1 = require("@nestjs/common");
const template_repository_1 = require("../repositories/template.repository");
const template_entity_1 = require("../../../entities/template.entity");
const template_response_dto_1 = require("../dtos/template/template-response.dto");
const template_invalido_exception_1 = require("../exceptions/template-invalido.exception");
const template_engine_1 = require("../util/template-engine");
const template_tipo_enum_1 = require("../../../enums/template-tipo.enum");
/**
 * Serviço para gerenciamento de templates do sistema
 *
 * Responsável por:
 * - Operações CRUD para templates
 * - Renderização de templates
 * - Sanitização de dados
 * - Validação de templates
 */
let TemplateService = TemplateService_1 = class TemplateService {
    templateRepository;
    logger = new common_1.Logger(TemplateService_1.name);
    templateEngine;
    constructor(templateRepository) {
        this.templateRepository = templateRepository;
        this.templateEngine = new template_engine_1.TemplateEngine();
    }
    /**
     * Busca todos os templates, convertendo-os para DTOs de resposta
     * @param tipo Tipo opcional para filtrar
     * @returns Lista de DTOs de resposta de templates
     */
    async buscarTodos(tipo) {
        const templates = await this.templateRepository.findAll(tipo);
        return templates.map(t => this.mapearParaDto(t));
    }
    /**
     * Busca um template por seu código
     * @param codigo Código do template
     * @returns DTO de resposta do template
     * @throws Error se o template não existir
     */
    async buscarPorCodigo(codigo) {
        const template = await this.templateRepository.findByCodigo(codigo);
        if (!template) {
            throw new Error(`Template com código '${codigo}' não encontrado`);
        }
        return this.mapearParaDto(template);
    }
    /**
     * Cria um novo template
     * @param dto DTO com dados para criação
     * @returns DTO de resposta do template criado
     */
    async criar(dto) {
        // Verificar se já existe template com mesmo código
        const existente = await this.templateRepository.existsByCodigo(dto.codigo);
        if (existente) {
            throw new Error(`Template com código '${dto.codigo}' já existe`);
        }
        // Validar se o conteúdo do template é válido
        try {
            this.templateEngine.compile(dto.conteudo);
        }
        catch (error) {
            throw new template_invalido_exception_1.TemplateInvalidoException(dto.codigo, `Template inválido: ${error.message}`);
        }
        const template = new template_entity_1.Template();
        template.codigo = dto.codigo;
        template.nome = dto.nome;
        // A propriedade descricao não existe na entidade Template
        template.tipo = dto.tipo;
        template.conteudo = dto.conteudo;
        template.ativo = true;
        const salvo = await this.templateRepository.save(template);
        return this.mapearParaDto(salvo);
    }
    /**
     * Atualiza um template existente
     * @param codigo Código do template
     * @param dto DTO com dados para atualização
     * @returns DTO de resposta do template atualizado
     * @throws Error se o template não existir
     */
    async atualizar(codigo, dto) {
        const template = await this.templateRepository.findByCodigo(codigo);
        if (!template) {
            throw new Error(`Template com código '${codigo}' não encontrado`);
        }
        // Validar se o conteúdo do template é válido (se fornecido)
        if (dto.conteudo) {
            try {
                this.templateEngine.compile(dto.conteudo);
            }
            catch (error) {
                throw new template_invalido_exception_1.TemplateInvalidoException(codigo, `Template inválido: ${error.message}`);
            }
            template.conteudo = dto.conteudo;
        }
        if (dto.nome !== undefined) {
            template.nome = dto.nome;
        }
        // A propriedade descricao não existe no DTO nem na entidade Template
        if (dto.ativo !== undefined) {
            template.ativo = dto.ativo;
        }
        const salvo = await this.templateRepository.save(template);
        return this.mapearParaDto(salvo);
    }
    /**
     * Remove um template
     * @param codigo Código do template
     * @throws Error se o template não existir
     */
    async remover(codigo) {
        const template = await this.templateRepository.findByCodigo(codigo);
        if (!template) {
            throw new Error(`Template com código '${codigo}' não encontrado`);
        }
        await this.templateRepository.remove(template.id);
        this.logger.log(`Template '${codigo}' removido`);
    }
    /**
     * Testa a renderização de um template com dados de exemplo
     * @param dto DTO com dados para teste
     * @returns String renderizada
     * @throws TemplateInvalidoException se ocorrer erro na renderização
     */
    async testar(dto) {
        let template = null;
        // Se for um código, busca o template existente
        if (dto.codigo) {
            template = await this.templateRepository.findByCodigo(dto.codigo);
            if (!template && !dto.conteudo) {
                throw new Error(`Template com código '${dto.codigo}' não encontrado`);
            }
        }
        // Se não encontrou o template pelo código ou não foi fornecido código, usa o conteúdo direto
        if (!template && dto.conteudo) {
            const tempTemplate = new template_entity_1.Template();
            tempTemplate.conteudo = dto.conteudo;
            tempTemplate.tipo = dto.tipo || template_tipo_enum_1.TemplateTipoEnum.EMAIL;
            tempTemplate.codigo = 'temp-' + Date.now();
            tempTemplate.nome = 'Template Temporário';
            tempTemplate.ativo = true;
            template = tempTemplate;
        }
        if (!template) {
            throw new Error('É necessário fornecer o código ou o conteúdo do template');
        }
        try {
            const conteudoRenderizado = await this.templateEngine.render(template.conteudo, dto.dados || {}, { sanitize: true });
            return { conteudo: conteudoRenderizado };
        }
        catch (error) {
            throw new template_invalido_exception_1.TemplateInvalidoException(dto.codigo || 'unknown', `Erro ao renderizar template: ${error.message}`);
        }
    }
    /**
     * Renderiza um template com dados reais
     * @param codigo Código do template
     * @param dados Dados para renderização
     * @param opcoes Opções adicionais de renderização
     * @returns String renderizada
     * @throws Error se o template não existir
     * @throws TemplateInvalidoException se ocorrer erro na renderização
     */
    async renderizar(codigo, dados, opcoes = { sanitize: true }) {
        const template = await this.templateRepository.findByCodigo(codigo);
        if (!template) {
            throw new Error(`Template com código '${codigo}' não encontrado`);
        }
        if (!template.ativo) {
            throw new Error(`Template com código '${codigo}' está inativo`);
        }
        try {
            return await this.templateEngine.render(template.conteudo, dados, opcoes);
        }
        catch (error) {
            throw new template_invalido_exception_1.TemplateInvalidoException(codigo, `Erro ao renderizar template: ${error.message}`);
        }
    }
    /**
     * Busca templates por tipo
     * @param tipo Tipo dos templates
     * @returns Lista de DTOs de resposta de templates
     */
    async buscarPorTipo(tipo) {
        const templates = await this.templateRepository.findByTipo(tipo);
        return templates.map(t => this.mapearParaDto(t));
    }
    /**
     * Ativa ou desativa um template
     * @param codigo Código do template
     * @param ativo Status de ativação
     * @returns DTO de resposta do template atualizado
     * @throws Error se o template não existir
     */
    async alterarStatus(codigo, ativo) {
        const template = await this.templateRepository.findByCodigo(codigo);
        if (!template) {
            throw new Error(`Template com código '${codigo}' não encontrado`);
        }
        template.ativo = ativo;
        const salvo = await this.templateRepository.save(template);
        this.logger.log(`Template '${codigo}' ${ativo ? 'ativado' : 'desativado'}`);
        return this.mapearParaDto(salvo);
    }
    /**
     * Converte uma entidade Template para um DTO de resposta
     * @param template Entidade a ser convertida
     * @returns DTO de resposta
     */
    mapearParaDto(template) {
        const dto = new template_response_dto_1.TemplateResponseDto();
        dto.codigo = template.codigo;
        dto.nome = template.nome;
        // Não existe a propriedade descricao
        dto.tipo = template.tipo;
        dto.conteudo = template.conteudo;
        dto.ativo = template.ativo;
        dto.created_at = template.created_at;
        dto.updated_at = template.updated_at;
        return dto;
    }
};
exports.TemplateService = TemplateService;
exports.TemplateService = TemplateService = TemplateService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof template_repository_1.TemplateRepository !== "undefined" && template_repository_1.TemplateRepository) === "function" ? _a : Object])
], TemplateService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNvbmZpZ3VyYWNhb1xcc2VydmljZXNcXHRlbXBsYXRlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQsNkVBQXlFO0FBQ3pFLHVFQUE2RDtBQUc3RCxrRkFBNkU7QUFFN0UsMkZBQXNGO0FBQ3RGLDZEQUF5RDtBQUN6RCwwRUFBcUU7QUFFckU7Ozs7Ozs7O0dBUUc7QUFFSSxJQUFNLGVBQWUsdUJBQXJCLE1BQU0sZUFBZTtJQUlHO0lBSFosTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGlCQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUMsY0FBYyxDQUFpQjtJQUVoRCxZQUE2QixrQkFBc0M7UUFBdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUNqRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksZ0NBQWMsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUF1QjtRQUN2QyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUQsT0FBTyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBYztRQUNsQyxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsTUFBTSxrQkFBa0Is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UUFFM0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxNQUFNLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDNUUsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssYUFBYSxDQUFDLFFBQWtCO1FBQ3RDLE1BQU0sR0FBRyxHQUFHLElBQUksMkNBQW1CLEVBQUUsQ0FBQztRQUN0QyxHQUFHLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDN0IsR0FBRyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3pCLHFDQUFxQztRQUNyQyxHQUFHLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDekIsR0FBRyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDO1FBQ2pDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUMzQixHQUFHLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDckMsR0FBRyxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO1FBQ3JDLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztDQUNGLENBQUE7QUF6UFksMENBQWU7MEJBQWYsZUFBZTtJQUQzQixJQUFBLG1CQUFVLEdBQUU7eURBS3NDLHdDQUFrQixvQkFBbEIsd0NBQWtCO0dBSnhELGVBQWUsQ0F5UDNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxjb25maWd1cmFjYW9cXHNlcnZpY2VzXFx0ZW1wbGF0ZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFRlbXBsYXRlUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy90ZW1wbGF0ZS5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvdGVtcGxhdGUuZW50aXR5JztcbmltcG9ydCB7IFRlbXBsYXRlQ3JlYXRlRHRvIH0gZnJvbSAnLi4vZHRvcy90ZW1wbGF0ZS90ZW1wbGF0ZS1jcmVhdGUuZHRvJztcbmltcG9ydCB7IFRlbXBsYXRlVXBkYXRlRHRvIH0gZnJvbSAnLi4vZHRvcy90ZW1wbGF0ZS90ZW1wbGF0ZS11cGRhdGUuZHRvJztcbmltcG9ydCB7IFRlbXBsYXRlUmVzcG9uc2VEdG8gfSBmcm9tICcuLi9kdG9zL3RlbXBsYXRlL3RlbXBsYXRlLXJlc3BvbnNlLmR0byc7XG5pbXBvcnQgeyBUZW1wbGF0ZVRlc3REdG8gfSBmcm9tICcuLi9kdG9zL3RlbXBsYXRlL3RlbXBsYXRlLXRlc3QuZHRvJztcbmltcG9ydCB7IFRlbXBsYXRlSW52YWxpZG9FeGNlcHRpb24gfSBmcm9tICcuLi9leGNlcHRpb25zL3RlbXBsYXRlLWludmFsaWRvLmV4Y2VwdGlvbic7XG5pbXBvcnQgeyBUZW1wbGF0ZUVuZ2luZSB9IGZyb20gJy4uL3V0aWwvdGVtcGxhdGUtZW5naW5lJztcbmltcG9ydCB7IFRlbXBsYXRlVGlwb0VudW0gfSBmcm9tICcuLi8uLi8uLi9lbnVtcy90ZW1wbGF0ZS10aXBvLmVudW0nO1xuXG4vKipcbiAqIFNlcnZpw6dvIHBhcmEgZ2VyZW5jaWFtZW50byBkZSB0ZW1wbGF0ZXMgZG8gc2lzdGVtYVxuICogXG4gKiBSZXNwb25zw6F2ZWwgcG9yOlxuICogLSBPcGVyYcOnw7VlcyBDUlVEIHBhcmEgdGVtcGxhdGVzXG4gKiAtIFJlbmRlcml6YcOnw6NvIGRlIHRlbXBsYXRlc1xuICogLSBTYW5pdGl6YcOnw6NvIGRlIGRhZG9zXG4gKiAtIFZhbGlkYcOnw6NvIGRlIHRlbXBsYXRlc1xuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGVtcGxhdGVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFRlbXBsYXRlU2VydmljZS5uYW1lKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0ZW1wbGF0ZUVuZ2luZTogVGVtcGxhdGVFbmdpbmU7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB0ZW1wbGF0ZVJlcG9zaXRvcnk6IFRlbXBsYXRlUmVwb3NpdG9yeSkge1xuICAgIHRoaXMudGVtcGxhdGVFbmdpbmUgPSBuZXcgVGVtcGxhdGVFbmdpbmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RvcyBvcyB0ZW1wbGF0ZXMsIGNvbnZlcnRlbmRvLW9zIHBhcmEgRFRPcyBkZSByZXNwb3N0YVxuICAgKiBAcGFyYW0gdGlwbyBUaXBvIG9wY2lvbmFsIHBhcmEgZmlsdHJhclxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBEVE9zIGRlIHJlc3Bvc3RhIGRlIHRlbXBsYXRlc1xuICAgKi9cbiAgYXN5bmMgYnVzY2FyVG9kb3ModGlwbz86IFRlbXBsYXRlVGlwb0VudW0pOiBQcm9taXNlPFRlbXBsYXRlUmVzcG9uc2VEdG9bXT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlcyA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRBbGwodGlwbyk7XG4gICAgcmV0dXJuIHRlbXBsYXRlcy5tYXAodCA9PiB0aGlzLm1hcGVhclBhcmFEdG8odCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHRlbXBsYXRlIHBvciBzZXUgY8OzZGlnb1xuICAgKiBAcGFyYW0gY29kaWdvIEPDs2RpZ28gZG8gdGVtcGxhdGVcbiAgICogQHJldHVybnMgRFRPIGRlIHJlc3Bvc3RhIGRvIHRlbXBsYXRlXG4gICAqIEB0aHJvd3MgRXJyb3Igc2UgbyB0ZW1wbGF0ZSBuw6NvIGV4aXN0aXJcbiAgICovXG4gIGFzeW5jIGJ1c2NhclBvckNvZGlnbyhjb2RpZ286IHN0cmluZyk6IFByb21pc2U8VGVtcGxhdGVSZXNwb25zZUR0bz4ge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZEJ5Q29kaWdvKGNvZGlnbyk7XG4gICAgaWYgKCF0ZW1wbGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSBjb20gY8OzZGlnbyAnJHtjb2RpZ299JyBuw6NvIGVuY29udHJhZG9gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubWFwZWFyUGFyYUR0byh0ZW1wbGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBub3ZvIHRlbXBsYXRlXG4gICAqIEBwYXJhbSBkdG8gRFRPIGNvbSBkYWRvcyBwYXJhIGNyaWHDp8Ojb1xuICAgKiBAcmV0dXJucyBEVE8gZGUgcmVzcG9zdGEgZG8gdGVtcGxhdGUgY3JpYWRvXG4gICAqL1xuICBhc3luYyBjcmlhcihkdG86IFRlbXBsYXRlQ3JlYXRlRHRvKTogUHJvbWlzZTxUZW1wbGF0ZVJlc3BvbnNlRHRvPiB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIGrDoSBleGlzdGUgdGVtcGxhdGUgY29tIG1lc21vIGPDs2RpZ29cbiAgICBjb25zdCBleGlzdGVudGUgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5leGlzdHNCeUNvZGlnbyhkdG8uY29kaWdvKTtcbiAgICBpZiAoZXhpc3RlbnRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbXBsYXRlIGNvbSBjw7NkaWdvICcke2R0by5jb2RpZ299JyBqw6EgZXhpc3RlYCk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhciBzZSBvIGNvbnRlw7pkbyBkbyB0ZW1wbGF0ZSDDqSB2w6FsaWRvXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMudGVtcGxhdGVFbmdpbmUuY29tcGlsZShkdG8uY29udGV1ZG8pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgVGVtcGxhdGVJbnZhbGlkb0V4Y2VwdGlvbihcbiAgICAgICAgZHRvLmNvZGlnbyxcbiAgICAgICAgYFRlbXBsYXRlIGludsOhbGlkbzogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUoKTtcbiAgICB0ZW1wbGF0ZS5jb2RpZ28gPSBkdG8uY29kaWdvO1xuICAgIHRlbXBsYXRlLm5vbWUgPSBkdG8ubm9tZTtcbiAgICAvLyBBIHByb3ByaWVkYWRlIGRlc2NyaWNhbyBuw6NvIGV4aXN0ZSBuYSBlbnRpZGFkZSBUZW1wbGF0ZVxuICAgIHRlbXBsYXRlLnRpcG8gPSBkdG8udGlwbztcbiAgICB0ZW1wbGF0ZS5jb250ZXVkbyA9IGR0by5jb250ZXVkbztcbiAgICB0ZW1wbGF0ZS5hdGl2byA9IHRydWU7XG5cbiAgICBjb25zdCBzYWx2byA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnNhdmUodGVtcGxhdGUpO1xuICAgIHJldHVybiB0aGlzLm1hcGVhclBhcmFEdG8oc2Fsdm8pO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIHVtIHRlbXBsYXRlIGV4aXN0ZW50ZVxuICAgKiBAcGFyYW0gY29kaWdvIEPDs2RpZ28gZG8gdGVtcGxhdGVcbiAgICogQHBhcmFtIGR0byBEVE8gY29tIGRhZG9zIHBhcmEgYXR1YWxpemHDp8Ojb1xuICAgKiBAcmV0dXJucyBEVE8gZGUgcmVzcG9zdGEgZG8gdGVtcGxhdGUgYXR1YWxpemFkb1xuICAgKiBAdGhyb3dzIEVycm9yIHNlIG8gdGVtcGxhdGUgbsOjbyBleGlzdGlyXG4gICAqL1xuICBhc3luYyBhdHVhbGl6YXIoY29kaWdvOiBzdHJpbmcsIGR0bzogVGVtcGxhdGVVcGRhdGVEdG8pOiBQcm9taXNlPFRlbXBsYXRlUmVzcG9uc2VEdG8+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNvZGlnbyhjb2RpZ28pO1xuICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgY29tIGPDs2RpZ28gJyR7Y29kaWdvfScgbsOjbyBlbmNvbnRyYWRvYCk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhciBzZSBvIGNvbnRlw7pkbyBkbyB0ZW1wbGF0ZSDDqSB2w6FsaWRvIChzZSBmb3JuZWNpZG8pXG4gICAgaWYgKGR0by5jb250ZXVkbykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZUVuZ2luZS5jb21waWxlKGR0by5jb250ZXVkbyk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgVGVtcGxhdGVJbnZhbGlkb0V4Y2VwdGlvbihcbiAgICAgICAgICBjb2RpZ28sXG4gICAgICAgICAgYFRlbXBsYXRlIGludsOhbGlkbzogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRlbXBsYXRlLmNvbnRldWRvID0gZHRvLmNvbnRldWRvO1xuICAgIH1cblxuICAgIGlmIChkdG8ubm9tZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0ZW1wbGF0ZS5ub21lID0gZHRvLm5vbWU7XG4gICAgfVxuXG4gICAgLy8gQSBwcm9wcmllZGFkZSBkZXNjcmljYW8gbsOjbyBleGlzdGUgbm8gRFRPIG5lbSBuYSBlbnRpZGFkZSBUZW1wbGF0ZVxuXG4gICAgaWYgKGR0by5hdGl2byAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0ZW1wbGF0ZS5hdGl2byA9IGR0by5hdGl2bztcbiAgICB9XG5cbiAgICBjb25zdCBzYWx2byA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnNhdmUodGVtcGxhdGUpO1xuICAgIHJldHVybiB0aGlzLm1hcGVhclBhcmFEdG8oc2Fsdm8pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bSB0ZW1wbGF0ZVxuICAgKiBAcGFyYW0gY29kaWdvIEPDs2RpZ28gZG8gdGVtcGxhdGVcbiAgICogQHRocm93cyBFcnJvciBzZSBvIHRlbXBsYXRlIG7Do28gZXhpc3RpclxuICAgKi9cbiAgYXN5bmMgcmVtb3Zlcihjb2RpZ286IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZEJ5Q29kaWdvKGNvZGlnbyk7XG4gICAgaWYgKCF0ZW1wbGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSBjb20gY8OzZGlnbyAnJHtjb2RpZ299JyBuw6NvIGVuY29udHJhZG9gKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5yZW1vdmUodGVtcGxhdGUuaWQgYXMgdW5rbm93biBhcyBudW1iZXIpO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgVGVtcGxhdGUgJyR7Y29kaWdvfScgcmVtb3ZpZG9gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0YSBhIHJlbmRlcml6YcOnw6NvIGRlIHVtIHRlbXBsYXRlIGNvbSBkYWRvcyBkZSBleGVtcGxvXG4gICAqIEBwYXJhbSBkdG8gRFRPIGNvbSBkYWRvcyBwYXJhIHRlc3RlXG4gICAqIEByZXR1cm5zIFN0cmluZyByZW5kZXJpemFkYVxuICAgKiBAdGhyb3dzIFRlbXBsYXRlSW52YWxpZG9FeGNlcHRpb24gc2Ugb2NvcnJlciBlcnJvIG5hIHJlbmRlcml6YcOnw6NvXG4gICAqL1xuICBhc3luYyB0ZXN0YXIoZHRvOiBUZW1wbGF0ZVRlc3REdG8pOiBQcm9taXNlPHsgY29udGV1ZG86IHN0cmluZyB9PiB7XG4gICAgbGV0IHRlbXBsYXRlOiBUZW1wbGF0ZSB8IG51bGwgPSBudWxsO1xuXG4gICAgLy8gU2UgZm9yIHVtIGPDs2RpZ28sIGJ1c2NhIG8gdGVtcGxhdGUgZXhpc3RlbnRlXG4gICAgaWYgKGR0by5jb2RpZ28pIHtcbiAgICAgIHRlbXBsYXRlID0gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZEJ5Q29kaWdvKGR0by5jb2RpZ28pO1xuICAgICAgaWYgKCF0ZW1wbGF0ZSAmJiAhZHRvLmNvbnRldWRvKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgY29tIGPDs2RpZ28gJyR7ZHRvLmNvZGlnb30nIG7Do28gZW5jb250cmFkb2ApO1xuICAgICAgfVxuICAgIH0gXG4gICAgXG4gICAgLy8gU2UgbsOjbyBlbmNvbnRyb3UgbyB0ZW1wbGF0ZSBwZWxvIGPDs2RpZ28gb3UgbsOjbyBmb2kgZm9ybmVjaWRvIGPDs2RpZ28sIHVzYSBvIGNvbnRlw7pkbyBkaXJldG9cbiAgICBpZiAoIXRlbXBsYXRlICYmIGR0by5jb250ZXVkbykge1xuICAgICAgY29uc3QgdGVtcFRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKCk7XG4gICAgICB0ZW1wVGVtcGxhdGUuY29udGV1ZG8gPSBkdG8uY29udGV1ZG87XG4gICAgICB0ZW1wVGVtcGxhdGUudGlwbyA9IGR0by50aXBvIHx8IFRlbXBsYXRlVGlwb0VudW0uRU1BSUw7XG4gICAgICB0ZW1wVGVtcGxhdGUuY29kaWdvID0gJ3RlbXAtJyArIERhdGUubm93KCk7XG4gICAgICB0ZW1wVGVtcGxhdGUubm9tZSA9ICdUZW1wbGF0ZSBUZW1wb3LDoXJpbyc7XG4gICAgICB0ZW1wVGVtcGxhdGUuYXRpdm8gPSB0cnVlO1xuICAgICAgdGVtcGxhdGUgPSB0ZW1wVGVtcGxhdGU7XG4gICAgfSBcbiAgICBcbiAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ8OJIG5lY2Vzc8OhcmlvIGZvcm5lY2VyIG8gY8OzZGlnbyBvdSBvIGNvbnRlw7pkbyBkbyB0ZW1wbGF0ZScpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb250ZXVkb1JlbmRlcml6YWRvID0gYXdhaXQgdGhpcy50ZW1wbGF0ZUVuZ2luZS5yZW5kZXIoXG4gICAgICAgIHRlbXBsYXRlLmNvbnRldWRvLFxuICAgICAgICBkdG8uZGFkb3MgfHwge30sXG4gICAgICAgIHsgc2FuaXRpemU6IHRydWUgfVxuICAgICAgKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHsgY29udGV1ZG86IGNvbnRldWRvUmVuZGVyaXphZG8gfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IFRlbXBsYXRlSW52YWxpZG9FeGNlcHRpb24oXG4gICAgICAgIGR0by5jb2RpZ28gfHwgJ3Vua25vd24nLFxuICAgICAgICBgRXJybyBhbyByZW5kZXJpemFyIHRlbXBsYXRlOiAke2Vycm9yLm1lc3NhZ2V9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyaXphIHVtIHRlbXBsYXRlIGNvbSBkYWRvcyByZWFpc1xuICAgKiBAcGFyYW0gY29kaWdvIEPDs2RpZ28gZG8gdGVtcGxhdGVcbiAgICogQHBhcmFtIGRhZG9zIERhZG9zIHBhcmEgcmVuZGVyaXphw6fDo29cbiAgICogQHBhcmFtIG9wY29lcyBPcMOnw7VlcyBhZGljaW9uYWlzIGRlIHJlbmRlcml6YcOnw6NvXG4gICAqIEByZXR1cm5zIFN0cmluZyByZW5kZXJpemFkYVxuICAgKiBAdGhyb3dzIEVycm9yIHNlIG8gdGVtcGxhdGUgbsOjbyBleGlzdGlyXG4gICAqIEB0aHJvd3MgVGVtcGxhdGVJbnZhbGlkb0V4Y2VwdGlvbiBzZSBvY29ycmVyIGVycm8gbmEgcmVuZGVyaXphw6fDo29cbiAgICovXG4gIGFzeW5jIHJlbmRlcml6YXIoXG4gICAgY29kaWdvOiBzdHJpbmcsIFxuICAgIGRhZG9zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCBcbiAgICBvcGNvZXM6IHsgc2FuaXRpemU/OiBib29sZWFuIH0gPSB7IHNhbml0aXplOiB0cnVlIH1cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNvZGlnbyhjb2RpZ28pO1xuICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgY29tIGPDs2RpZ28gJyR7Y29kaWdvfScgbsOjbyBlbmNvbnRyYWRvYCk7XG4gICAgfVxuXG4gICAgaWYgKCF0ZW1wbGF0ZS5hdGl2bykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSBjb20gY8OzZGlnbyAnJHtjb2RpZ299JyBlc3TDoSBpbmF0aXZvYCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlRW5naW5lLnJlbmRlcih0ZW1wbGF0ZS5jb250ZXVkbywgZGFkb3MsIG9wY29lcyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBUZW1wbGF0ZUludmFsaWRvRXhjZXB0aW9uKFxuICAgICAgICBjb2RpZ28sXG4gICAgICAgIGBFcnJvIGFvIHJlbmRlcml6YXIgdGVtcGxhdGU6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0ZW1wbGF0ZXMgcG9yIHRpcG9cbiAgICogQHBhcmFtIHRpcG8gVGlwbyBkb3MgdGVtcGxhdGVzXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIERUT3MgZGUgcmVzcG9zdGEgZGUgdGVtcGxhdGVzXG4gICAqL1xuICBhc3luYyBidXNjYXJQb3JUaXBvKHRpcG86IFRlbXBsYXRlVGlwb0VudW0pOiBQcm9taXNlPFRlbXBsYXRlUmVzcG9uc2VEdG9bXT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlcyA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeVRpcG8odGlwbyk7XG4gICAgcmV0dXJuIHRlbXBsYXRlcy5tYXAodCA9PiB0aGlzLm1hcGVhclBhcmFEdG8odCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0aXZhIG91IGRlc2F0aXZhIHVtIHRlbXBsYXRlXG4gICAqIEBwYXJhbSBjb2RpZ28gQ8OzZGlnbyBkbyB0ZW1wbGF0ZVxuICAgKiBAcGFyYW0gYXRpdm8gU3RhdHVzIGRlIGF0aXZhw6fDo29cbiAgICogQHJldHVybnMgRFRPIGRlIHJlc3Bvc3RhIGRvIHRlbXBsYXRlIGF0dWFsaXphZG9cbiAgICogQHRocm93cyBFcnJvciBzZSBvIHRlbXBsYXRlIG7Do28gZXhpc3RpclxuICAgKi9cbiAgYXN5bmMgYWx0ZXJhclN0YXR1cyhjb2RpZ286IHN0cmluZywgYXRpdm86IGJvb2xlYW4pOiBQcm9taXNlPFRlbXBsYXRlUmVzcG9uc2VEdG8+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNvZGlnbyhjb2RpZ28pO1xuICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgY29tIGPDs2RpZ28gJyR7Y29kaWdvfScgbsOjbyBlbmNvbnRyYWRvYCk7XG4gICAgfVxuXG4gICAgdGVtcGxhdGUuYXRpdm8gPSBhdGl2bztcbiAgICBjb25zdCBzYWx2byA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnNhdmUodGVtcGxhdGUpO1xuICAgIFxuICAgIHRoaXMubG9nZ2VyLmxvZyhgVGVtcGxhdGUgJyR7Y29kaWdvfScgJHthdGl2byA/ICdhdGl2YWRvJyA6ICdkZXNhdGl2YWRvJ31gKTtcbiAgICByZXR1cm4gdGhpcy5tYXBlYXJQYXJhRHRvKHNhbHZvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0ZSB1bWEgZW50aWRhZGUgVGVtcGxhdGUgcGFyYSB1bSBEVE8gZGUgcmVzcG9zdGFcbiAgICogQHBhcmFtIHRlbXBsYXRlIEVudGlkYWRlIGEgc2VyIGNvbnZlcnRpZGFcbiAgICogQHJldHVybnMgRFRPIGRlIHJlc3Bvc3RhXG4gICAqL1xuICBwcml2YXRlIG1hcGVhclBhcmFEdG8odGVtcGxhdGU6IFRlbXBsYXRlKTogVGVtcGxhdGVSZXNwb25zZUR0byB7XG4gICAgY29uc3QgZHRvID0gbmV3IFRlbXBsYXRlUmVzcG9uc2VEdG8oKTtcbiAgICBkdG8uY29kaWdvID0gdGVtcGxhdGUuY29kaWdvO1xuICAgIGR0by5ub21lID0gdGVtcGxhdGUubm9tZTtcbiAgICAvLyBOw6NvIGV4aXN0ZSBhIHByb3ByaWVkYWRlIGRlc2NyaWNhb1xuICAgIGR0by50aXBvID0gdGVtcGxhdGUudGlwbztcbiAgICBkdG8uY29udGV1ZG8gPSB0ZW1wbGF0ZS5jb250ZXVkbztcbiAgICBkdG8uYXRpdm8gPSB0ZW1wbGF0ZS5hdGl2bztcbiAgICBkdG8uY3JlYXRlZF9hdCA9IHRlbXBsYXRlLmNyZWF0ZWRfYXQ7XG4gICAgZHRvLnVwZGF0ZWRfYXQgPSB0ZW1wbGF0ZS51cGRhdGVkX2F0O1xuICAgIHJldHVybiBkdG87XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==