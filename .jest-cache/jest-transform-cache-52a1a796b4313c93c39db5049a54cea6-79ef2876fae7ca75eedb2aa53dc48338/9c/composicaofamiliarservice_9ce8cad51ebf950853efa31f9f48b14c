afba1ff7104782cdf80fbaceb6c15859
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var ComposicaoFamiliarService_1;
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ComposicaoFamiliarService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const class_transformer_1 = require("class-transformer");
const class_validator_1 = require("class-validator");
const composicao_familiar_entity_1 = require("../../../entities/composicao-familiar.entity");
const cidadao_entity_1 = require("../../../entities/cidadao.entity");
const composicao_familiar_response_dto_1 = require("../dto/composicao-familiar-response.dto");
const cache_1 = require("../../../shared/cache");
const cpf_validator_1 = require("../validators/cpf-validator");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
/**
 * Serviço de Composição Familiar
 *
 * Responsável pela lógica de negócio relacionada aos membros da composição familiar dos cidadãos.
 * Implementa operações CRUD completas com validações específicas, cache e auditoria.
 */
let ComposicaoFamiliarService = ComposicaoFamiliarService_1 = class ComposicaoFamiliarService {
    composicaoFamiliarRepository;
    cidadaoRepository;
    cacheService;
    dataSource;
    logger = new common_1.Logger(ComposicaoFamiliarService_1.name);
    CACHE_TTL = 3600; // 1 hora
    CACHE_PREFIX = 'composicao_familiar:';
    constructor(composicaoFamiliarRepository, cidadaoRepository, cacheService, dataSource) {
        this.composicaoFamiliarRepository = composicaoFamiliarRepository;
        this.cidadaoRepository = cidadaoRepository;
        this.cacheService = cacheService;
        this.dataSource = dataSource;
    }
    /**
     * Cria um novo membro da composição familiar
     * @param createComposicaoFamiliarDto Dados do membro familiar
     * @param userId ID do usuário que está criando
     * @returns Membro da composição familiar criado
     */
    async create(createComposicaoFamiliarDto, userId) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            // Validar se o cidadão existe
            const cidadao = await this.cidadaoRepository.findOne({
                where: { id: createComposicaoFamiliarDto.cidadao_id },
            });
            if (!cidadao) {
                throw new common_1.NotFoundException('Cidadão não encontrado');
            }
            // Validar CPF
            const cpfLimpo = createComposicaoFamiliarDto.cpf.replace(/\D/g, '');
            const cpfValidator = new cpf_validator_1.CPFValidator();
            if (!cpfValidator.validate(cpfLimpo, {})) {
                throw new common_1.BadRequestException('CPF inválido');
            }
            // Verificar se já existe membro com o mesmo CPF na composição familiar do cidadão
            const membroExistente = await this.composicaoFamiliarRepository.findOne({
                where: {
                    cidadao_id: createComposicaoFamiliarDto.cidadao_id,
                    cpf: cpfLimpo,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
            });
            if (membroExistente) {
                throw new common_1.ConflictException('Já existe um membro com este CPF na composição familiar');
            }
            // Verificar se o CPF não é o mesmo do cidadão responsável
            if (cidadao.cpf === cpfLimpo) {
                throw new common_1.ConflictException('O CPF do membro não pode ser igual ao CPF do cidadão responsável');
            }
            // Validar se o nome não é duplicado na mesma composição familiar
            const nomeExistente = await this.composicaoFamiliarRepository.findOne({
                where: {
                    cidadao_id: createComposicaoFamiliarDto.cidadao_id,
                    nome: createComposicaoFamiliarDto.nome,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
            });
            if (nomeExistente) {
                throw new common_1.ConflictException('Já existe um membro com este nome na composição familiar');
            }
            // Normalizar campos de enum antes de criar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)({
                ...createComposicaoFamiliarDto,
                cpf: cpfLimpo,
            });
            // Criar o membro da composição familiar
            const novoMembro = this.composicaoFamiliarRepository.create(dadosNormalizados);
            // Validar entidade
            const errors = await (0, class_validator_1.validate)(novoMembro);
            if (errors.length > 0) {
                const errorMessages = errors
                    .map((error) => Object.values(error.constraints || {}).join(', '))
                    .join('; ');
                throw new common_1.BadRequestException(`Dados inválidos: ${errorMessages}`);
            }
            const membroSalvo = await queryRunner.manager.save(novoMembro);
            await queryRunner.commitTransaction();
            // Invalidar cache relacionado
            await this.invalidateCache(createComposicaoFamiliarDto.cidadao_id);
            // Converter para DTO de resposta
            const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membroSalvo, {
                excludeExtraneousValues: true,
                enableImplicitConversion: true,
            });
            // Cachear o resultado
            await this.cacheService.set(`${this.CACHE_PREFIX}id:${membroSalvo.id}`, responseDto, this.CACHE_TTL);
            this.logger.log(`Membro da composição familiar criado: ${membroSalvo.id} por usuário ${userId}`);
            return responseDto;
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            this.logger.error(`Erro ao criar membro da composição familiar: ${error.message}`, error.stack);
            throw error;
        }
        finally {
            await queryRunner.release();
        }
    }
    /**
     * Lista membros da composição familiar por cidadão
     * @param cidadaoId ID do cidadão
     * @param options Opções de paginação
     * @returns Lista paginada de membros
     */
    async findByCidadao(cidadaoId, options) {
        const { page, limit } = options;
        const offset = (page - 1) * limit;
        // Verificar se o cidadão existe
        const cidadao = await this.cidadaoRepository.findOne({
            where: { id: cidadaoId },
        });
        if (!cidadao) {
            throw new common_1.NotFoundException('Cidadão não encontrado');
        }
        // Verificar cache
        const cacheKey = `${this.CACHE_PREFIX}cidadao:${cidadaoId}:page:${page}:limit:${limit}`;
        const cached = await this.cacheService.get(cacheKey);
        if (cached) {
            return cached;
        }
        // Buscar membros da composição familiar
        const [membros, total] = await this.composicaoFamiliarRepository.findAndCount({
            where: {
                cidadao_id: cidadaoId,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            order: {
                created_at: 'DESC',
            },
            skip: offset,
            take: limit,
        });
        // Converter para DTOs de resposta
        const data = membros.map((membro) => (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        }));
        // Calcular estatísticas
        const estatisticas = await this.calcularEstatisticas(cidadaoId);
        const totalPages = Math.ceil(total / limit);
        const result = {
            data,
            meta: {
                total,
                page,
                limit,
                totalPages,
                hasNext: page < totalPages,
                hasPrev: page > 1,
            },
            estatisticas,
        };
        // Cachear resultado
        await this.cacheService.set(cacheKey, result, this.CACHE_TTL);
        return result;
    }
    /**
     * Busca um membro específico da composição familiar
     * @param id ID do membro
     * @returns Dados do membro
     */
    async findOne(id) {
        // Verificar cache
        const cacheKey = `${this.CACHE_PREFIX}id:${id}`;
        const cached = await this.cacheService.get(cacheKey);
        if (cached) {
            return cached;
        }
        const membro = await this.composicaoFamiliarRepository.findOne({
            where: {
                id,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            relations: ['cidadao'],
        });
        if (!membro) {
            throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
        }
        const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        });
        // Cachear resultado
        await this.cacheService.set(cacheKey, responseDto, this.CACHE_TTL);
        return responseDto;
    }
    /**
     * Atualiza um membro da composição familiar
     * @param id ID do membro
     * @param updateComposicaoFamiliarDto Dados para atualização
     * @param userId ID do usuário que está atualizando
     * @returns Membro atualizado
     */
    async update(id, updateComposicaoFamiliarDto, userId) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            const membro = await this.composicaoFamiliarRepository.findOne({
                where: {
                    id,
                    removed_at: (0, typeorm_2.IsNull)(),
                },
                relations: ['cidadao'],
            });
            if (!membro) {
                throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
            }
            // Se o CPF está sendo atualizado, validar
            if (updateComposicaoFamiliarDto.cpf) {
                const cpfLimpo = updateComposicaoFamiliarDto.cpf.replace(/\D/g, '');
                const cpfValidator = new cpf_validator_1.CPFValidator();
                if (!cpfValidator.validate(cpfLimpo, {})) {
                    throw new common_1.BadRequestException('CPF inválido');
                }
                // Verificar se já existe outro membro com o mesmo CPF
                const membroExistente = await this.composicaoFamiliarRepository.findOne({
                    where: {
                        cidadao_id: membro.cidadao_id,
                        cpf: cpfLimpo,
                        id: (0, typeorm_2.Not)(id),
                        removed_at: (0, typeorm_2.IsNull)(),
                    },
                });
                if (membroExistente) {
                    throw new common_1.ConflictException('Já existe um membro com este CPF na composição familiar');
                }
                // Verificar se o CPF não é o mesmo do cidadão responsável
                if (membro.cidadao.cpf === cpfLimpo) {
                    throw new common_1.ConflictException('O CPF do membro não pode ser igual ao CPF do cidadão responsável');
                }
                updateComposicaoFamiliarDto.cpf = cpfLimpo;
            }
            // Se o nome está sendo atualizado, validar
            if (updateComposicaoFamiliarDto.nome) {
                const nomeExistente = await this.composicaoFamiliarRepository.findOne({
                    where: {
                        cidadao_id: membro.cidadao_id,
                        nome: updateComposicaoFamiliarDto.nome,
                        id: (0, typeorm_2.Not)(id),
                        removed_at: (0, typeorm_2.IsNull)(),
                    },
                });
                if (nomeExistente) {
                    throw new common_1.ConflictException('Já existe um membro com este nome na composição familiar');
                }
            }
            // Normalizar campos de enum antes de atualizar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)({
                ...updateComposicaoFamiliarDto,
            });
            // Atualizar dados
            Object.assign(membro, dadosNormalizados);
            membro.updated_at = new Date();
            // Validar entidade
            const errors = await (0, class_validator_1.validate)(membro);
            if (errors.length > 0) {
                const errorMessages = errors
                    .map((error) => Object.values(error.constraints || {}).join(', '))
                    .join('; ');
                throw new common_1.BadRequestException(`Dados inválidos: ${errorMessages}`);
            }
            const membroAtualizado = await queryRunner.manager.save(membro);
            await queryRunner.commitTransaction();
            // Invalidar cache
            await this.invalidateCache(membro.cidadao_id, id);
            const responseDto = (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membroAtualizado, {
                excludeExtraneousValues: true,
                enableImplicitConversion: true,
            });
            // Atualizar cache
            await this.cacheService.set(`${this.CACHE_PREFIX}id:${id}`, responseDto, this.CACHE_TTL);
            this.logger.log(`Membro da composição familiar atualizado: ${id} por usuário ${userId}`);
            return responseDto;
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            this.logger.error(`Erro ao atualizar membro da composição familiar: ${error.message}`, error.stack);
            throw error;
        }
        finally {
            await queryRunner.release();
        }
    }
    /**
     * Remove um membro da composição familiar (soft delete)
     * @param id ID do membro
     * @param userId ID do usuário que está removendo
     */
    async remove(id, userId) {
        const membro = await this.composicaoFamiliarRepository.findOne({
            where: {
                id,
                removed_at: (0, typeorm_2.IsNull)(),
            },
        });
        if (!membro) {
            throw new common_1.NotFoundException('Membro da composição familiar não encontrado');
        }
        // Soft delete
        membro.removed_at = new Date();
        await this.composicaoFamiliarRepository.save(membro);
        // Invalidar cache
        await this.invalidateCache(membro.cidadao_id, id);
        this.logger.log(`Membro da composição familiar removido: ${id} por usuário ${userId}`);
    }
    /**
     * Busca membros da composição familiar por CPF
     * @param cpf CPF para busca
     * @returns Lista de membros encontrados
     */
    async findByCpf(cpf) {
        const cpfLimpo = cpf.replace(/\D/g, '');
        if (cpfLimpo.length !== 11) {
            throw new common_1.BadRequestException('CPF deve ter 11 dígitos');
        }
        const membros = await this.composicaoFamiliarRepository.find({
            where: {
                cpf: cpfLimpo,
                removed_at: (0, typeorm_2.IsNull)(),
            },
            relations: ['cidadao'],
            order: {
                created_at: 'DESC',
            },
        });
        return membros.map((membro) => (0, class_transformer_1.plainToInstance)(composicao_familiar_response_dto_1.ComposicaoFamiliarResponseDto, membro, {
            excludeExtraneousValues: true,
            enableImplicitConversion: true,
        }));
    }
    /**
     * Calcula estatísticas da composição familiar
     * @param cidadaoId ID do cidadão
     * @returns Estatísticas calculadas
     */
    async calcularEstatisticas(cidadaoId) {
        const membros = await this.composicaoFamiliarRepository.find({
            where: {
                cidadao_id: cidadaoId,
                removed_at: (0, typeorm_2.IsNull)(),
            },
        });
        const totalMembros = membros.length;
        const membrosComRenda = membros.filter((m) => m.renda && m.renda > 0).length;
        const rendaTotal = membros.reduce((sum, m) => sum + (m.renda || 0), 0);
        const rendaMedia = membrosComRenda > 0 ? rendaTotal / membrosComRenda : 0;
        const idadeMedia = totalMembros > 0
            ? membros.reduce((sum, m) => sum + m.idade, 0) / totalMembros
            : 0;
        return {
            totalMembros,
            rendaTotal,
            rendaMedia: Math.round(rendaMedia * 100) / 100,
            idadeMedia: Math.round(idadeMedia * 100) / 100,
            membrosComRenda,
        };
    }
    /**
     * Invalida cache relacionado à composição familiar
     * @param cidadaoId ID do cidadão
     * @param membroId ID do membro (opcional)
     */
    async invalidateCache(cidadaoId, membroId) {
        const patterns = [
            `${this.CACHE_PREFIX}cidadao:${cidadaoId}:*`,
            `cidadao:id:${cidadaoId}`,
            `cidadao:list:*`,
        ];
        if (membroId) {
            patterns.push(`${this.CACHE_PREFIX}id:${membroId}`);
        }
        for (const pattern of patterns) {
            await this.cacheService.del(pattern);
        }
    }
};
exports.ComposicaoFamiliarService = ComposicaoFamiliarService;
exports.ComposicaoFamiliarService = ComposicaoFamiliarService = ComposicaoFamiliarService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(composicao_familiar_entity_1.ComposicaoFamiliar)),
    __param(1, (0, typeorm_1.InjectRepository)(cidadao_entity_1.Cidadao)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof cache_1.CacheService !== "undefined" && cache_1.CacheService) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _d : Object])
], ComposicaoFamiliarService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHNlcnZpY2VzXFxjb21wb3NpY2FvLWZhbWlsaWFyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUE4RDtBQUM5RCx5REFBb0Q7QUFDcEQscURBQTJDO0FBQzNDLDZGQUFrRjtBQUNsRixxRUFBMkQ7QUFHM0QsOEZBR2lEO0FBQ2pELGlEQUFxRDtBQUNyRCwrREFBMkQ7QUFDM0QscUZBQWlGO0FBRWpGOzs7OztHQUtHO0FBRUksSUFBTSx5QkFBeUIsaUNBQS9CLE1BQU0seUJBQXlCO0lBT2pCO0lBRUE7SUFDQTtJQUNBO0lBVkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLDJCQUF5QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQyxTQUFTO0lBQzNCLFlBQVksR0FBRyxzQkFBc0IsQ0FBQztJQUV2RCxZQUVtQiw0QkFBNEQsRUFFNUQsaUJBQXNDLEVBQ3RDLFlBQTBCLEVBQzFCLFVBQXNCO1FBSnRCLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBZ0M7UUFFNUQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFxQjtRQUN0QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQ3RDLENBQUM7SUFFSjs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQ1YsMkJBQXdELEVBQ3hELE1BQWM7UUFFZCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDeEQsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUIsTUFBTSxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUVyQyxJQUFJLENBQUM7WUFDSCw4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LEdBQUc7WUFDOUMsZUFBZTtTQUNoQixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxLQUFLLENBQUMsZUFBZSxDQUMzQixTQUFpQixFQUNqQixRQUFpQjtRQUVqQixNQUFNLFFBQVEsR0FBRztZQUNmLEdBQUcsSUFBSSxDQUFDLFlBQVksV0FBVyxTQUFTLElBQUk7WUFDNUMsY0FBYyxTQUFTLEVBQUU7WUFDekIsZ0JBQWdCO1NBQ2pCLENBQUM7UUFFRixJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLE1BQU0sUUFBUSxFQUFFLENBQUMsQ0FBQztRQUN0RCxDQUFDO1FBRUQsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUMvQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQXZnQlksOERBQXlCO29DQUF6Qix5QkFBeUI7SUFEckMsSUFBQSxtQkFBVSxHQUFFO0lBT1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLCtDQUFrQixDQUFDLENBQUE7SUFFcEMsV0FBQSxJQUFBLDBCQUFnQixFQUFDLHdCQUFPLENBQUMsQ0FBQTt5REFEcUIsb0JBQVUsb0JBQVYsb0JBQVUsb0RBRXJCLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNmLG9CQUFZLG9CQUFaLG9CQUFZLG9EQUNkLG9CQUFVLG9CQUFWLG9CQUFVO0dBWDlCLHlCQUF5QixDQXVnQnJDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxjaWRhZGFvXFxzZXJ2aWNlc1xcY29tcG9zaWNhby1mYW1pbGlhci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBDb25mbGljdEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcbmltcG9ydCB7IFJlcG9zaXRvcnksIERhdGFTb3VyY2UsIElzTnVsbCwgTm90IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBwbGFpblRvSW5zdGFuY2UgfSBmcm9tICdjbGFzcy10cmFuc2Zvcm1lcic7XG5pbXBvcnQgeyB2YWxpZGF0ZSB9IGZyb20gJ2NsYXNzLXZhbGlkYXRvcic7XG5pbXBvcnQgeyBDb21wb3NpY2FvRmFtaWxpYXIgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9jb21wb3NpY2FvLWZhbWlsaWFyLmVudGl0eSc7XG5pbXBvcnQgeyBDaWRhZGFvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY2lkYWRhby5lbnRpdHknO1xuaW1wb3J0IHsgQ3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvIH0gZnJvbSAnLi4vZHRvL2NyZWF0ZS1jb21wb3NpY2FvLWZhbWlsaWFyLmR0byc7XG5pbXBvcnQgeyBVcGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8gfSBmcm9tICcuLi9kdG8vdXBkYXRlLWNvbXBvc2ljYW8tZmFtaWxpYXIuZHRvJztcbmltcG9ydCB7XG4gIENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvLFxuICBDb21wb3NpY2FvRmFtaWxpYXJQYWdpbmF0ZWRSZXNwb25zZUR0byxcbn0gZnJvbSAnLi4vZHRvL2NvbXBvc2ljYW8tZmFtaWxpYXItcmVzcG9uc2UuZHRvJztcbmltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9jYWNoZSc7XG5pbXBvcnQgeyBDUEZWYWxpZGF0b3IgfSBmcm9tICcuLi92YWxpZGF0b3JzL2NwZi12YWxpZGF0b3InO1xuaW1wb3J0IHsgbm9ybWFsaXplRW51bUZpZWxkcyB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC91dGlscy9lbnVtLW5vcm1hbGl6ZXIudXRpbCc7XG5cbi8qKlxuICogU2VydmnDp28gZGUgQ29tcG9zacOnw6NvIEZhbWlsaWFyXG4gKlxuICogUmVzcG9uc8OhdmVsIHBlbGEgbMOzZ2ljYSBkZSBuZWfDs2NpbyByZWxhY2lvbmFkYSBhb3MgbWVtYnJvcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgZG9zIGNpZGFkw6Nvcy5cbiAqIEltcGxlbWVudGEgb3BlcmHDp8O1ZXMgQ1JVRCBjb21wbGV0YXMgY29tIHZhbGlkYcOnw7VlcyBlc3BlY8OtZmljYXMsIGNhY2hlIGUgYXVkaXRvcmlhLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29tcG9zaWNhb0ZhbWlsaWFyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihDb21wb3NpY2FvRmFtaWxpYXJTZXJ2aWNlLm5hbWUpO1xuICBwcml2YXRlIHJlYWRvbmx5IENBQ0hFX1RUTCA9IDM2MDA7IC8vIDEgaG9yYVxuICBwcml2YXRlIHJlYWRvbmx5IENBQ0hFX1BSRUZJWCA9ICdjb21wb3NpY2FvX2ZhbWlsaWFyOic7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdFJlcG9zaXRvcnkoQ29tcG9zaWNhb0ZhbWlsaWFyKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29tcG9zaWNhb0ZhbWlsaWFyUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDb21wb3NpY2FvRmFtaWxpYXI+LFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KENpZGFkYW8pXG4gICAgcHJpdmF0ZSByZWFkb25seSBjaWRhZGFvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDaWRhZGFvPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtIG5vdm8gbWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxuICAgKiBAcGFyYW0gY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvIERhZG9zIGRvIG1lbWJybyBmYW1pbGlhclxuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBjcmlhbmRvXG4gICAqIEByZXR1cm5zIE1lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgY3JpYWRvXG4gICAqL1xuICBhc3luYyBjcmVhdGUoXG4gICAgY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvOiBDcmVhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8sXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+IHtcbiAgICBjb25zdCBxdWVyeVJ1bm5lciA9IHRoaXMuZGF0YVNvdXJjZS5jcmVhdGVRdWVyeVJ1bm5lcigpO1xuICAgIGF3YWl0IHF1ZXJ5UnVubmVyLmNvbm5lY3QoKTtcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5zdGFydFRyYW5zYWN0aW9uKCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVmFsaWRhciBzZSBvIGNpZGFkw6NvIGV4aXN0ZVxuICAgICAgY29uc3QgY2lkYWRhbyA9IGF3YWl0IHRoaXMuY2lkYWRhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjcmVhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8uY2lkYWRhb19pZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY2lkYWRhbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NpZGFkw6NvIG7Do28gZW5jb250cmFkbycpO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGFyIENQRlxuICAgICAgY29uc3QgY3BmTGltcG8gPSBjcmVhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8uY3BmLnJlcGxhY2UoL1xcRC9nLCAnJyk7XG4gICAgICBjb25zdCBjcGZWYWxpZGF0b3IgPSBuZXcgQ1BGVmFsaWRhdG9yKCk7XG4gICAgICBpZiAoIWNwZlZhbGlkYXRvci52YWxpZGF0ZShjcGZMaW1wbywge30gYXMgYW55KSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQ1BGIGludsOhbGlkbycpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgasOhIGV4aXN0ZSBtZW1icm8gY29tIG8gbWVzbW8gQ1BGIG5hIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBkbyBjaWRhZMOjb1xuICAgICAgY29uc3QgbWVtYnJvRXhpc3RlbnRlID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGNpZGFkYW9faWQ6IGNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5jaWRhZGFvX2lkLFxuICAgICAgICAgIGNwZjogY3BmTGltcG8sXG4gICAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKG1lbWJyb0V4aXN0ZW50ZSkge1xuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0rDoSBleGlzdGUgdW0gbWVtYnJvIGNvbSBlc3RlIENQRiBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXInLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyBDUEYgbsOjbyDDqSBvIG1lc21vIGRvIGNpZGFkw6NvIHJlc3BvbnPDoXZlbFxuICAgICAgaWYgKGNpZGFkYW8uY3BmID09PSBjcGZMaW1wbykge1xuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgJ08gQ1BGIGRvIG1lbWJybyBuw6NvIHBvZGUgc2VyIGlndWFsIGFvIENQRiBkbyBjaWRhZMOjbyByZXNwb25zw6F2ZWwnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGFyIHNlIG8gbm9tZSBuw6NvIMOpIGR1cGxpY2FkbyBuYSBtZXNtYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICAgIGNvbnN0IG5vbWVFeGlzdGVudGUgPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgY2lkYWRhb19pZDogY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNpZGFkYW9faWQsXG4gICAgICAgICAgbm9tZTogY3JlYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLm5vbWUsXG4gICAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKG5vbWVFeGlzdGVudGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgICdKw6EgZXhpc3RlIHVtIG1lbWJybyBjb20gZXN0ZSBub21lIG5hIGNvbXBvc2nDp8OjbyBmYW1pbGlhcicsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIE5vcm1hbGl6YXIgY2FtcG9zIGRlIGVudW0gYW50ZXMgZGUgY3JpYXJcbiAgICAgIGNvbnN0IGRhZG9zTm9ybWFsaXphZG9zID0gbm9ybWFsaXplRW51bUZpZWxkcyh7XG4gICAgICAgIC4uLmNyZWF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byxcbiAgICAgICAgY3BmOiBjcGZMaW1wbyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDcmlhciBvIG1lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICAgIGNvbnN0IG5vdm9NZW1icm8gPVxuICAgICAgICB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuY3JlYXRlKGRhZG9zTm9ybWFsaXphZG9zKTtcblxuICAgICAgLy8gVmFsaWRhciBlbnRpZGFkZVxuICAgICAgY29uc3QgZXJyb3JzID0gYXdhaXQgdmFsaWRhdGUobm92b01lbWJybyk7XG4gICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlcyA9IGVycm9yc1xuICAgICAgICAgIC5tYXAoKGVycm9yKSA9PiBPYmplY3QudmFsdWVzKGVycm9yLmNvbnN0cmFpbnRzIHx8IHt9KS5qb2luKCcsICcpKVxuICAgICAgICAgIC5qb2luKCc7ICcpO1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihgRGFkb3MgaW52w6FsaWRvczogJHtlcnJvck1lc3NhZ2VzfWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtZW1icm9TYWx2byA9IGF3YWl0IHF1ZXJ5UnVubmVyLm1hbmFnZXIuc2F2ZShub3ZvTWVtYnJvKTtcblxuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIuY29tbWl0VHJhbnNhY3Rpb24oKTtcblxuICAgICAgLy8gSW52YWxpZGFyIGNhY2hlIHJlbGFjaW9uYWRvXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVDYWNoZShjcmVhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8uY2lkYWRhb19pZCk7XG5cbiAgICAgIC8vIENvbnZlcnRlciBwYXJhIERUTyBkZSByZXNwb3N0YVxuICAgICAgY29uc3QgcmVzcG9uc2VEdG8gPSBwbGFpblRvSW5zdGFuY2UoXG4gICAgICAgIENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvLFxuICAgICAgICBtZW1icm9TYWx2byxcbiAgICAgICAge1xuICAgICAgICAgIGV4Y2x1ZGVFeHRyYW5lb3VzVmFsdWVzOiB0cnVlLFxuICAgICAgICAgIGVuYWJsZUltcGxpY2l0Q29udmVyc2lvbjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIC8vIENhY2hlYXIgbyByZXN1bHRhZG9cbiAgICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChcbiAgICAgICAgYCR7dGhpcy5DQUNIRV9QUkVGSVh9aWQ6JHttZW1icm9TYWx2by5pZH1gLFxuICAgICAgICByZXNwb25zZUR0byxcbiAgICAgICAgdGhpcy5DQUNIRV9UVEwsXG4gICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIGNyaWFkbzogJHttZW1icm9TYWx2by5pZH0gcG9yIHVzdcOhcmlvICR7dXNlcklkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2VEdG87XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLnJvbGxiYWNrVHJhbnNhY3Rpb24oKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBjcmlhciBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLnJlbGVhc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlzdGEgbWVtYnJvcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgcG9yIGNpZGFkw6NvXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cbiAgICogQHBhcmFtIG9wdGlvbnMgT3DDp8O1ZXMgZGUgcGFnaW5hw6fDo29cbiAgICogQHJldHVybnMgTGlzdGEgcGFnaW5hZGEgZGUgbWVtYnJvc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5Q2lkYWRhbyhcbiAgICBjaWRhZGFvSWQ6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IHBhZ2U6IG51bWJlcjsgbGltaXQ6IG51bWJlciB9LFxuICApOiBQcm9taXNlPENvbXBvc2ljYW9GYW1pbGlhclBhZ2luYXRlZFJlc3BvbnNlRHRvPiB7XG4gICAgY29uc3QgeyBwYWdlLCBsaW1pdCB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBvZmZzZXQgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyBjaWRhZMOjbyBleGlzdGVcbiAgICBjb25zdCBjaWRhZGFvID0gYXdhaXQgdGhpcy5jaWRhZGFvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjaWRhZGFvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghY2lkYWRhbykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDaWRhZMOjbyBuw6NvIGVuY29udHJhZG8nKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgY2FjaGVcbiAgICBjb25zdCBjYWNoZUtleSA9IGAke3RoaXMuQ0FDSEVfUFJFRklYfWNpZGFkYW86JHtjaWRhZGFvSWR9OnBhZ2U6JHtwYWdlfTpsaW1pdDoke2xpbWl0fWA7XG4gICAgY29uc3QgY2FjaGVkID1cbiAgICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmdldDxDb21wb3NpY2FvRmFtaWxpYXJQYWdpbmF0ZWRSZXNwb25zZUR0bz4oXG4gICAgICAgIGNhY2hlS2V5LFxuICAgICAgKTtcbiAgICBpZiAoY2FjaGVkKSB7XG4gICAgICByZXR1cm4gY2FjaGVkO1xuICAgIH1cblxuICAgIC8vIEJ1c2NhciBtZW1icm9zIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxuICAgIGNvbnN0IFttZW1icm9zLCB0b3RhbF0gPVxuICAgICAgYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRBbmRDb3VudCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgY2lkYWRhb19pZDogY2lkYWRhb0lkLFxuICAgICAgICAgIHJlbW92ZWRfYXQ6IElzTnVsbCgpLFxuICAgICAgICB9LFxuICAgICAgICBvcmRlcjoge1xuICAgICAgICAgIGNyZWF0ZWRfYXQ6ICdERVNDJyxcbiAgICAgICAgfSxcbiAgICAgICAgc2tpcDogb2Zmc2V0LFxuICAgICAgICB0YWtlOiBsaW1pdCxcbiAgICAgIH0pO1xuXG4gICAgLy8gQ29udmVydGVyIHBhcmEgRFRPcyBkZSByZXNwb3N0YVxuICAgIGNvbnN0IGRhdGEgPSBtZW1icm9zLm1hcCgobWVtYnJvKSA9PlxuICAgICAgcGxhaW5Ub0luc3RhbmNlKENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvLCBtZW1icm8sIHtcbiAgICAgICAgZXhjbHVkZUV4dHJhbmVvdXNWYWx1ZXM6IHRydWUsXG4gICAgICAgIGVuYWJsZUltcGxpY2l0Q29udmVyc2lvbjogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICAvLyBDYWxjdWxhciBlc3RhdMOtc3RpY2FzXG4gICAgY29uc3QgZXN0YXRpc3RpY2FzID0gYXdhaXQgdGhpcy5jYWxjdWxhckVzdGF0aXN0aWNhcyhjaWRhZGFvSWQpO1xuXG4gICAgY29uc3QgdG90YWxQYWdlcyA9IE1hdGguY2VpbCh0b3RhbCAvIGxpbWl0KTtcbiAgICBjb25zdCByZXN1bHQ6IENvbXBvc2ljYW9GYW1pbGlhclBhZ2luYXRlZFJlc3BvbnNlRHRvID0ge1xuICAgICAgZGF0YSxcbiAgICAgIG1ldGE6IHtcbiAgICAgICAgdG90YWwsXG4gICAgICAgIHBhZ2UsXG4gICAgICAgIGxpbWl0LFxuICAgICAgICB0b3RhbFBhZ2VzLFxuICAgICAgICBoYXNOZXh0OiBwYWdlIDwgdG90YWxQYWdlcyxcbiAgICAgICAgaGFzUHJldjogcGFnZSA+IDEsXG4gICAgICB9LFxuICAgICAgZXN0YXRpc3RpY2FzLFxuICAgIH07XG5cbiAgICAvLyBDYWNoZWFyIHJlc3VsdGFkb1xuICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChjYWNoZUtleSwgcmVzdWx0LCB0aGlzLkNBQ0hFX1RUTCk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIG1lbWJybyBlc3BlY8OtZmljbyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICogQHBhcmFtIGlkIElEIGRvIG1lbWJyb1xuICAgKiBAcmV0dXJucyBEYWRvcyBkbyBtZW1icm9cbiAgICovXG4gIGFzeW5jIGZpbmRPbmUoaWQ6IHN0cmluZyk6IFByb21pc2U8Q29tcG9zaWNhb0ZhbWlsaWFyUmVzcG9uc2VEdG8+IHtcbiAgICAvLyBWZXJpZmljYXIgY2FjaGVcbiAgICBjb25zdCBjYWNoZUtleSA9IGAke3RoaXMuQ0FDSEVfUFJFRklYfWlkOiR7aWR9YDtcbiAgICBjb25zdCBjYWNoZWQgPVxuICAgICAgYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0PENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvPihjYWNoZUtleSk7XG4gICAgaWYgKGNhY2hlZCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG5cbiAgICBjb25zdCBtZW1icm8gPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZCxcbiAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXG4gICAgICB9LFxuICAgICAgcmVsYXRpb25zOiBbJ2NpZGFkYW8nXSxcbiAgICB9KTtcblxuICAgIGlmICghbWVtYnJvKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgICdNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIG7Do28gZW5jb250cmFkbycsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3BvbnNlRHRvID0gcGxhaW5Ub0luc3RhbmNlKENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvLCBtZW1icm8sIHtcbiAgICAgIGV4Y2x1ZGVFeHRyYW5lb3VzVmFsdWVzOiB0cnVlLFxuICAgICAgZW5hYmxlSW1wbGljaXRDb252ZXJzaW9uOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy8gQ2FjaGVhciByZXN1bHRhZG9cbiAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoY2FjaGVLZXksIHJlc3BvbnNlRHRvLCB0aGlzLkNBQ0hFX1RUTCk7XG5cbiAgICByZXR1cm4gcmVzcG9uc2VEdG87XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW0gbWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxuICAgKiBAcGFyYW0gaWQgSUQgZG8gbWVtYnJvXG4gICAqIEBwYXJhbSB1cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8gRGFkb3MgcGFyYSBhdHVhbGl6YcOnw6NvXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGF0dWFsaXphbmRvXG4gICAqIEByZXR1cm5zIE1lbWJybyBhdHVhbGl6YWRvXG4gICAqL1xuICBhc3luYyB1cGRhdGUoXG4gICAgaWQ6IHN0cmluZyxcbiAgICB1cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG86IFVwZGF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0byxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0bz4ge1xuICAgIGNvbnN0IHF1ZXJ5UnVubmVyID0gdGhpcy5kYXRhU291cmNlLmNyZWF0ZVF1ZXJ5UnVubmVyKCk7XG4gICAgYXdhaXQgcXVlcnlSdW5uZXIuY29ubmVjdCgpO1xuICAgIGF3YWl0IHF1ZXJ5UnVubmVyLnN0YXJ0VHJhbnNhY3Rpb24oKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZW1icm8gPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaWQsXG4gICAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXG4gICAgICAgIH0sXG4gICAgICAgIHJlbGF0aW9uczogWydjaWRhZGFvJ10sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtZW1icm8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFxuICAgICAgICAgICdNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIG7Do28gZW5jb250cmFkbycsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNlIG8gQ1BGIGVzdMOhIHNlbmRvIGF0dWFsaXphZG8sIHZhbGlkYXJcbiAgICAgIGlmICh1cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8uY3BmKSB7XG4gICAgICAgIGNvbnN0IGNwZkxpbXBvID0gdXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNwZi5yZXBsYWNlKC9cXEQvZywgJycpO1xuICAgICAgICBjb25zdCBjcGZWYWxpZGF0b3IgPSBuZXcgQ1BGVmFsaWRhdG9yKCk7XG4gICAgICAgIGlmICghY3BmVmFsaWRhdG9yLnZhbGlkYXRlKGNwZkxpbXBvLCB7fSBhcyBhbnkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0NQRiBpbnbDoWxpZG8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlIG91dHJvIG1lbWJybyBjb20gbyBtZXNtbyBDUEZcbiAgICAgICAgY29uc3QgbWVtYnJvRXhpc3RlbnRlID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmRPbmUoXG4gICAgICAgICAge1xuICAgICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgICAgY2lkYWRhb19pZDogbWVtYnJvLmNpZGFkYW9faWQsXG4gICAgICAgICAgICAgIGNwZjogY3BmTGltcG8sXG4gICAgICAgICAgICAgIGlkOiBOb3QoaWQpLFxuICAgICAgICAgICAgICByZW1vdmVkX2F0OiBJc051bGwoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAobWVtYnJvRXhpc3RlbnRlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0rDoSBleGlzdGUgdW0gbWVtYnJvIGNvbSBlc3RlIENQRiBuYSBjb21wb3Npw6fDo28gZmFtaWxpYXInLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWZXJpZmljYXIgc2UgbyBDUEYgbsOjbyDDqSBvIG1lc21vIGRvIGNpZGFkw6NvIHJlc3BvbnPDoXZlbFxuICAgICAgICBpZiAobWVtYnJvLmNpZGFkYW8uY3BmID09PSBjcGZMaW1wbykge1xuICAgICAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdPIENQRiBkbyBtZW1icm8gbsOjbyBwb2RlIHNlciBpZ3VhbCBhbyBDUEYgZG8gY2lkYWTDo28gcmVzcG9uc8OhdmVsJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLmNwZiA9IGNwZkxpbXBvO1xuICAgICAgfVxuXG4gICAgICAvLyBTZSBvIG5vbWUgZXN0w6Egc2VuZG8gYXR1YWxpemFkbywgdmFsaWRhclxuICAgICAgaWYgKHVwZGF0ZUNvbXBvc2ljYW9GYW1pbGlhckR0by5ub21lKSB7XG4gICAgICAgIGNvbnN0IG5vbWVFeGlzdGVudGUgPSBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGNpZGFkYW9faWQ6IG1lbWJyby5jaWRhZGFvX2lkLFxuICAgICAgICAgICAgbm9tZTogdXBkYXRlQ29tcG9zaWNhb0ZhbWlsaWFyRHRvLm5vbWUsXG4gICAgICAgICAgICBpZDogTm90KGlkKSxcbiAgICAgICAgICAgIHJlbW92ZWRfYXQ6IElzTnVsbCgpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChub21lRXhpc3RlbnRlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0rDoSBleGlzdGUgdW0gbWVtYnJvIGNvbSBlc3RlIG5vbWUgbmEgY29tcG9zacOnw6NvIGZhbWlsaWFyJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIE5vcm1hbGl6YXIgY2FtcG9zIGRlIGVudW0gYW50ZXMgZGUgYXR1YWxpemFyXG4gICAgICBjb25zdCBkYWRvc05vcm1hbGl6YWRvcyA9IG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAuLi51cGRhdGVDb21wb3NpY2FvRmFtaWxpYXJEdG8sXG4gICAgICB9KTtcblxuICAgICAgLy8gQXR1YWxpemFyIGRhZG9zXG4gICAgICBPYmplY3QuYXNzaWduKG1lbWJybywgZGFkb3NOb3JtYWxpemFkb3MpO1xuICAgICAgbWVtYnJvLnVwZGF0ZWRfYXQgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICAvLyBWYWxpZGFyIGVudGlkYWRlXG4gICAgICBjb25zdCBlcnJvcnMgPSBhd2FpdCB2YWxpZGF0ZShtZW1icm8pO1xuICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZXMgPSBlcnJvcnNcbiAgICAgICAgICAubWFwKChlcnJvcikgPT4gT2JqZWN0LnZhbHVlcyhlcnJvci5jb25zdHJhaW50cyB8fCB7fSkuam9pbignLCAnKSlcbiAgICAgICAgICAuam9pbignOyAnKTtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYERhZG9zIGludsOhbGlkb3M6ICR7ZXJyb3JNZXNzYWdlc31gKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbWVtYnJvQXR1YWxpemFkbyA9IGF3YWl0IHF1ZXJ5UnVubmVyLm1hbmFnZXIuc2F2ZShtZW1icm8pO1xuXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb21taXRUcmFuc2FjdGlvbigpO1xuXG4gICAgICAvLyBJbnZhbGlkYXIgY2FjaGVcbiAgICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZUNhY2hlKG1lbWJyby5jaWRhZGFvX2lkLCBpZCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlRHRvID0gcGxhaW5Ub0luc3RhbmNlKFxuICAgICAgICBDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0byxcbiAgICAgICAgbWVtYnJvQXR1YWxpemFkbyxcbiAgICAgICAge1xuICAgICAgICAgIGV4Y2x1ZGVFeHRyYW5lb3VzVmFsdWVzOiB0cnVlLFxuICAgICAgICAgIGVuYWJsZUltcGxpY2l0Q29udmVyc2lvbjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIC8vIEF0dWFsaXphciBjYWNoZVxuICAgICAgYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuICAgICAgICBgJHt0aGlzLkNBQ0hFX1BSRUZJWH1pZDoke2lkfWAsXG4gICAgICAgIHJlc3BvbnNlRHRvLFxuICAgICAgICB0aGlzLkNBQ0hFX1RUTCxcbiAgICAgICk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYE1lbWJybyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXIgYXR1YWxpemFkbzogJHtpZH0gcG9yIHVzdcOhcmlvICR7dXNlcklkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2VEdG87XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLnJvbGxiYWNrVHJhbnNhY3Rpb24oKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhdHVhbGl6YXIgbWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhcjogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5yZWxlYXNlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bSBtZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIChzb2Z0IGRlbGV0ZSlcbiAgICogQHBhcmFtIGlkIElEIGRvIG1lbWJyb1xuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSByZW1vdmVuZG9cbiAgICovXG4gIGFzeW5jIHJlbW92ZShpZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG1lbWJybyA9IGF3YWl0IHRoaXMuY29tcG9zaWNhb0ZhbWlsaWFyUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkLFxuICAgICAgICByZW1vdmVkX2F0OiBJc051bGwoKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1lbWJybykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFxuICAgICAgICAnTWVtYnJvIGRhIGNvbXBvc2nDp8OjbyBmYW1pbGlhciBuw6NvIGVuY29udHJhZG8nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBTb2Z0IGRlbGV0ZVxuICAgIG1lbWJyby5yZW1vdmVkX2F0ID0gbmV3IERhdGUoKTtcbiAgICBhd2FpdCB0aGlzLmNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnkuc2F2ZShtZW1icm8pO1xuXG4gICAgLy8gSW52YWxpZGFyIGNhY2hlXG4gICAgYXdhaXQgdGhpcy5pbnZhbGlkYXRlQ2FjaGUobWVtYnJvLmNpZGFkYW9faWQsIGlkKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBNZW1icm8gZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIHJlbW92aWRvOiAke2lkfSBwb3IgdXN1w6FyaW8gJHt1c2VySWR9YCxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIG1lbWJyb3MgZGEgY29tcG9zacOnw6NvIGZhbWlsaWFyIHBvciBDUEZcbiAgICogQHBhcmFtIGNwZiBDUEYgcGFyYSBidXNjYVxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBtZW1icm9zIGVuY29udHJhZG9zXG4gICAqL1xuICBhc3luYyBmaW5kQnlDcGYoY3BmOiBzdHJpbmcpOiBQcm9taXNlPENvbXBvc2ljYW9GYW1pbGlhclJlc3BvbnNlRHRvW10+IHtcbiAgICBjb25zdCBjcGZMaW1wbyA9IGNwZi5yZXBsYWNlKC9cXEQvZywgJycpO1xuXG4gICAgaWYgKGNwZkxpbXBvLmxlbmd0aCAhPT0gMTEpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDUEYgZGV2ZSB0ZXIgMTEgZMOtZ2l0b3MnKTtcbiAgICB9XG5cbiAgICBjb25zdCBtZW1icm9zID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY3BmOiBjcGZMaW1wbyxcbiAgICAgICAgcmVtb3ZlZF9hdDogSXNOdWxsKCksXG4gICAgICB9LFxuICAgICAgcmVsYXRpb25zOiBbJ2NpZGFkYW8nXSxcbiAgICAgIG9yZGVyOiB7XG4gICAgICAgIGNyZWF0ZWRfYXQ6ICdERVNDJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbWVtYnJvcy5tYXAoKG1lbWJybykgPT5cbiAgICAgIHBsYWluVG9JbnN0YW5jZShDb21wb3NpY2FvRmFtaWxpYXJSZXNwb25zZUR0bywgbWVtYnJvLCB7XG4gICAgICAgIGV4Y2x1ZGVFeHRyYW5lb3VzVmFsdWVzOiB0cnVlLFxuICAgICAgICBlbmFibGVJbXBsaWNpdENvbnZlcnNpb246IHRydWUsXG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGEgZXN0YXTDrXN0aWNhcyBkYSBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICogQHBhcmFtIGNpZGFkYW9JZCBJRCBkbyBjaWRhZMOjb1xuICAgKiBAcmV0dXJucyBFc3RhdMOtc3RpY2FzIGNhbGN1bGFkYXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgY2FsY3VsYXJFc3RhdGlzdGljYXMoY2lkYWRhb0lkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBtZW1icm9zID0gYXdhaXQgdGhpcy5jb21wb3NpY2FvRmFtaWxpYXJSZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2lkYWRhb19pZDogY2lkYWRhb0lkLFxuICAgICAgICByZW1vdmVkX2F0OiBJc051bGwoKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCB0b3RhbE1lbWJyb3MgPSBtZW1icm9zLmxlbmd0aDtcbiAgICBjb25zdCBtZW1icm9zQ29tUmVuZGEgPSBtZW1icm9zLmZpbHRlcihcbiAgICAgIChtKSA9PiBtLnJlbmRhICYmIG0ucmVuZGEgPiAwLFxuICAgICkubGVuZ3RoO1xuICAgIGNvbnN0IHJlbmRhVG90YWwgPSBtZW1icm9zLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyAobS5yZW5kYSB8fCAwKSwgMCk7XG4gICAgY29uc3QgcmVuZGFNZWRpYSA9IG1lbWJyb3NDb21SZW5kYSA+IDAgPyByZW5kYVRvdGFsIC8gbWVtYnJvc0NvbVJlbmRhIDogMDtcbiAgICBjb25zdCBpZGFkZU1lZGlhID1cbiAgICAgIHRvdGFsTWVtYnJvcyA+IDBcbiAgICAgICAgPyBtZW1icm9zLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyBtLmlkYWRlLCAwKSAvIHRvdGFsTWVtYnJvc1xuICAgICAgICA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxNZW1icm9zLFxuICAgICAgcmVuZGFUb3RhbCxcbiAgICAgIHJlbmRhTWVkaWE6IE1hdGgucm91bmQocmVuZGFNZWRpYSAqIDEwMCkgLyAxMDAsXG4gICAgICBpZGFkZU1lZGlhOiBNYXRoLnJvdW5kKGlkYWRlTWVkaWEgKiAxMDApIC8gMTAwLFxuICAgICAgbWVtYnJvc0NvbVJlbmRhLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogSW52YWxpZGEgY2FjaGUgcmVsYWNpb25hZG8gw6AgY29tcG9zacOnw6NvIGZhbWlsaWFyXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cbiAgICogQHBhcmFtIG1lbWJyb0lkIElEIGRvIG1lbWJybyAob3BjaW9uYWwpXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGludmFsaWRhdGVDYWNoZShcbiAgICBjaWRhZGFvSWQ6IHN0cmluZyxcbiAgICBtZW1icm9JZD86IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcGF0dGVybnMgPSBbXG4gICAgICBgJHt0aGlzLkNBQ0hFX1BSRUZJWH1jaWRhZGFvOiR7Y2lkYWRhb0lkfToqYCxcbiAgICAgIGBjaWRhZGFvOmlkOiR7Y2lkYWRhb0lkfWAsXG4gICAgICBgY2lkYWRhbzpsaXN0OipgLFxuICAgIF07XG5cbiAgICBpZiAobWVtYnJvSWQpIHtcbiAgICAgIHBhdHRlcm5zLnB1c2goYCR7dGhpcy5DQUNIRV9QUkVGSVh9aWQ6JHttZW1icm9JZH1gKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgcGF0dGVybnMpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChwYXR0ZXJuKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==