b7a610811e598ac8930476f6c8486a75
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var IntegradorAuthService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.IntegradorAuthService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const integrador_token_service_1 = require("./integrador-token.service");
const token_revogado_entity_1 = require("../../../entities/token-revogado.entity");
/**
 * Serviço responsável pela autenticação e autorização de integradores.
 * Valida tokens, verifica permissões e registra acessos.
 */
let IntegradorAuthService = IntegradorAuthService_1 = class IntegradorAuthService {
    tokenService;
    tokenRevogadoRepository;
    logger = new common_1.Logger(IntegradorAuthService_1.name);
    constructor(tokenService, tokenRevogadoRepository) {
        this.tokenService = tokenService;
        this.tokenRevogadoRepository = tokenRevogadoRepository;
    }
    /**
     * Extrai o token de autorização do cabeçalho da requisição.
     * @param request Objeto de requisição HTTP
     * @returns Token extraído ou null se não encontrado
     */
    extractTokenFromHeader(request) {
        const authHeader = request.headers.authorization;
        if (!authHeader) {
            return null;
        }
        const parts = authHeader.split(' ');
        if (parts.length !== 2 || parts[0] !== 'Bearer') {
            return null;
        }
        return parts[1];
    }
    /**
     * Obtém o endereço IP real da requisição.
     * @param request Objeto de requisição HTTP
     * @returns Endereço IP
     */
    getIpFromRequest(request) {
        // Considera cabeçalhos como X-Forwarded-For para ambientes com proxy
        const xForwardedFor = request.headers['x-forwarded-for'];
        if (xForwardedFor) {
            const ips = xForwardedFor.split(',');
            return ips[0].trim();
        }
        return request.ip || request.socket.remoteAddress || '0.0.0.0';
    }
    /**
     * Valida a autenticação de uma requisição.
     * @param request Objeto de requisição HTTP
     * @returns Payload do token validado
     * @throws UnauthorizedException se a autenticação falhar
     */
    async validateRequest(request) {
        const token = this.extractTokenFromHeader(request);
        if (!token) {
            throw new common_1.UnauthorizedException('Token de autorização não fornecido');
        }
        try {
            // Validar o token e obter o payload
            const payload = await this.tokenService.validateToken(token);
            // Verificar restrições de IP
            const ipAddress = this.getIpFromRequest(request);
            if (!this.tokenService.isIpAllowed(payload.integrador, ipAddress)) {
                this.logger.warn(`Tentativa de acesso de IP não autorizado: ${ipAddress} para integrador ${payload.integrador.id}`);
                throw new common_1.UnauthorizedException(`Acesso não permitido do IP ${ipAddress}`);
            }
            // Adicionar informações à requisição para uso posterior
            request['integrador'] = payload.integrador;
            request['integradorTokenPayload'] = payload;
            return payload;
        }
        catch (error) {
            // Registrar tentativa de acesso inválida
            this.logger.warn(`Falha na autenticação de integrador: ${error.message}`);
            // Propaga a exceção original
            throw error;
        }
    }
    /**
     * Verifica se a requisição tem as permissões necessárias.
     * @param request Objeto de requisição HTTP
     * @param requiredScopes Escopos necessários para a operação
     * @returns true se autorizado, false caso contrário
     */
    checkPermissions(request, requiredScopes) {
        const payload = request['integradorTokenPayload'];
        if (!payload) {
            return false;
        }
        return this.tokenService.hasRequiredScopes(payload, requiredScopes);
    }
    /**
     * Registra uma tentativa de acesso (sucesso ou falha).
     * Este método pode ser expandido para incluir mais informações de auditoria.
     * @param tokenId ID do token (se identificado)
     * @param integradorId ID do integrador (se identificado)
     * @param success Indica se o acesso foi bem-sucedido
     * @param ipAddress Endereço IP da requisição
     * @param resource Recurso que estava sendo acessado
     * @param message Mensagem adicional
     */
    async registrarTentativaAcesso(tokenId, integradorId, success, ipAddress, resource, message) {
        // Aqui poderia ser implementada a lógica para registrar em um banco ou
        // sistema de monitoramento. Por ora, apenas logamos.
        if (success) {
            this.logger.log(`Acesso autorizado: integrador=${integradorId}, token=${tokenId}, ip=${ipAddress}, recurso=${resource}`);
        }
        else {
            this.logger.warn(`Acesso negado: integrador=${integradorId}, ip=${ipAddress}, recurso=${resource}, motivo=${message}`);
        }
    }
    /**
     * Busca na cache local se um token está revogado.
     * Este método pode ser otimizado com Redis ou outro mecanismo de cache.
     * @param tokenHash Hash do token a ser verificado
     * @returns true se o token estiver revogado, false caso contrário
     */
    async isTokenRevogado(tokenHash) {
        const revogado = await this.tokenRevogadoRepository.findOne({
            where: { tokenHash },
        });
        return !!revogado;
    }
};
exports.IntegradorAuthService = IntegradorAuthService;
exports.IntegradorAuthService = IntegradorAuthService = IntegradorAuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(1, (0, typeorm_1.InjectRepository)(token_revogado_entity_1.TokenRevogado)),
    __metadata("design:paramtypes", [typeof (_a = typeof integrador_token_service_1.IntegradorTokenService !== "undefined" && integrador_token_service_1.IntegradorTokenService) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object])
], IntegradorAuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGludGVncmFkb3JcXHNlcnZpY2VzXFxpbnRlZ3JhZG9yLWF1dGguc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUEyRTtBQUUzRSw2Q0FBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLHlFQUFvRTtBQUNwRSxtRkFBd0U7QUFFeEU7OztHQUdHO0FBRUksSUFBTSxxQkFBcUIsNkJBQTNCLE1BQU0scUJBQXFCO0lBSWI7SUFFVDtJQUxPLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyx1QkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVqRSxZQUNtQixZQUFvQyxFQUU3Qyx1QkFBa0Q7UUFGekMsaUJBQVksR0FBWixZQUFZLENBQXdCO1FBRTdDLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBMkI7SUFDekQsQ0FBQztJQUVKOzs7O09BSUc7SUFDSCxzQkFBc0IsQ0FBQyxPQUFnQjtRQUNyQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUNqRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUNoRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGdCQUFnQixDQUFDLE9BQWdCO1FBQy9CLHFFQUFxRTtRQUNyRSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsT0FBTyxD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QUssQ0FBQyxlQUFlLENBQUMsU0FBaUI7UUFDckMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxDQUFDO1lBQzFELEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRTtTQUNyQixDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUM7SUFDcEIsQ0FBQztDQUNGLENBQUE7QUFoSlksc0RBQXFCO2dDQUFyQixxQkFBcUI7SUFEakMsSUFBQSxtQkFBVSxHQUFFO0lBTVIsV0FBQSxJQUFBLDBCQUFnQixFQUFDLHFDQUFhLENBQUMsQ0FBQTt5REFERCxpREFBc0Isb0JBQXRCLGlEQUFzQixvREFFcEIsb0JBQVUsb0JBQVYsb0JBQVU7R0FObEMscUJBQXFCLENBZ0pqQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcaW50ZWdyYWRvclxcc2VydmljZXNcXGludGVncmFkb3ItYXV0aC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIFVuYXV0aG9yaXplZEV4Y2VwdGlvbiwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBJbnRlZ3JhZG9yVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi9pbnRlZ3JhZG9yLXRva2VuLnNlcnZpY2UnO1xuaW1wb3J0IHsgVG9rZW5SZXZvZ2FkbyB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3Rva2VuLXJldm9nYWRvLmVudGl0eSc7XG5cbi8qKlxuICogU2VydmnDp28gcmVzcG9uc8OhdmVsIHBlbGEgYXV0ZW50aWNhw6fDo28gZSBhdXRvcml6YcOnw6NvIGRlIGludGVncmFkb3Jlcy5cbiAqIFZhbGlkYSB0b2tlbnMsIHZlcmlmaWNhIHBlcm1pc3PDtWVzIGUgcmVnaXN0cmEgYWNlc3Nvcy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEludGVncmFkb3JBdXRoU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihJbnRlZ3JhZG9yQXV0aFNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSB0b2tlblNlcnZpY2U6IEludGVncmFkb3JUb2tlblNlcnZpY2UsXG4gICAgQEluamVjdFJlcG9zaXRvcnkoVG9rZW5SZXZvZ2FkbylcbiAgICBwcml2YXRlIHRva2VuUmV2b2dhZG9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFRva2VuUmV2b2dhZG8+LFxuICApIHt9XG5cbiAgLyoqXG4gICAqIEV4dHJhaSBvIHRva2VuIGRlIGF1dG9yaXphw6fDo28gZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gICAqIEBwYXJhbSByZXF1ZXN0IE9iamV0byBkZSByZXF1aXNpw6fDo28gSFRUUFxuICAgKiBAcmV0dXJucyBUb2tlbiBleHRyYcOtZG8gb3UgbnVsbCBzZSBuw6NvIGVuY29udHJhZG9cbiAgICovXG4gIGV4dHJhY3RUb2tlbkZyb21IZWFkZXIocmVxdWVzdDogUmVxdWVzdCk6IHN0cmluZyB8IG51bGwge1xuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXF1ZXN0LmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgICBpZiAoIWF1dGhIZWFkZXIpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcnRzID0gYXV0aEhlYWRlci5zcGxpdCgnICcpO1xuICAgIGlmIChwYXJ0cy5sZW5ndGggIT09IDIgfHwgcGFydHNbMF0gIT09ICdCZWFyZXInKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFydHNbMV07XG4gIH1cblxuICAvKipcbiAgICogT2J0w6ltIG8gZW5kZXJlw6dvIElQIHJlYWwgZGEgcmVxdWlzacOnw6NvLlxuICAgKiBAcGFyYW0gcmVxdWVzdCBPYmpldG8gZGUgcmVxdWlzacOnw6NvIEhUVFBcbiAgICogQHJldHVybnMgRW5kZXJlw6dvIElQXG4gICAqL1xuICBnZXRJcEZyb21SZXF1ZXN0KHJlcXVlc3Q6IFJlcXVlc3QpOiBzdHJpbmcge1xuICAgIC8vIENvbnNpZGVyYSBjYWJlw6dhbGhvcyBjb21vIFgtRm9yd2FyZGVkLUZvciBwYXJhIGFtYmllbnRlcyBjb20gcHJveHlcbiAgICBjb25zdCB4Rm9yd2FyZGVkRm9yID0gcmVxdWVzdC5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSBhcyBzdHJpbmc7XG4gICAgaWYgKHhGb3J3YXJkZWRGb3IpIHtcbiAgICAgIGNvbnN0IGlwcyA9IHhGb3J3YXJkZWRGb3Iuc3BsaXQoJywnKTtcbiAgICAgIHJldHVybiBpcHNbMF0udHJpbSgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXF1ZXN0LmlwIHx8IHJlcXVlc3Quc29ja2V0LnJlbW90ZUFkZHJlc3MgfHwgJzAuMC4wLjAnO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBhIGF1dGVudGljYcOnw6NvIGRlIHVtYSByZXF1aXNpw6fDo28uXG4gICAqIEBwYXJhbSByZXF1ZXN0IE9iamV0byBkZSByZXF1aXNpw6fDo28gSFRUUFxuICAgKiBAcmV0dXJucyBQYXlsb2FkIGRvIHRva2VuIHZhbGlkYWRvXG4gICAqIEB0aHJvd3MgVW5hdXRob3JpemVkRXhjZXB0aW9uIHNlIGEgYXV0ZW50aWNhw6fDo28gZmFsaGFyXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVJlcXVlc3QocmVxdWVzdDogUmVxdWVzdCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgdG9rZW4gPSB0aGlzLmV4dHJhY3RUb2tlbkZyb21IZWFkZXIocmVxdWVzdCk7XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignVG9rZW4gZGUgYXV0b3JpemHDp8OjbyBuw6NvIGZvcm5lY2lkbycpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBWYWxpZGFyIG8gdG9rZW4gZSBvYnRlciBvIHBheWxvYWRcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS52YWxpZGF0ZVRva2VuKHRva2VuKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3RyacOnw7VlcyBkZSBJUFxuICAgICAgY29uc3QgaXBBZGRyZXNzID0gdGhpcy5nZXRJcEZyb21SZXF1ZXN0KHJlcXVlc3QpO1xuICAgICAgaWYgKCF0aGlzLnRva2VuU2VydmljZS5pc0lwQWxsb3dlZChwYXlsb2FkLmludGVncmFkb3IsIGlwQWRkcmVzcykpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICBgVGVudGF0aXZhIGRlIGFjZXNzbyBkZSBJUCBuw6NvIGF1dG9yaXphZG86ICR7aXBBZGRyZXNzfSBwYXJhIGludGVncmFkb3IgJHtwYXlsb2FkLmludGVncmFkb3IuaWR9YCxcbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgICBgQWNlc3NvIG7Do28gcGVybWl0aWRvIGRvIElQICR7aXBBZGRyZXNzfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEFkaWNpb25hciBpbmZvcm1hw6fDtWVzIMOgIHJlcXVpc2nDp8OjbyBwYXJhIHVzbyBwb3N0ZXJpb3JcbiAgICAgIHJlcXVlc3RbJ2ludGVncmFkb3InXSA9IHBheWxvYWQuaW50ZWdyYWRvcjtcbiAgICAgIHJlcXVlc3RbJ2ludGVncmFkb3JUb2tlblBheWxvYWQnXSA9IHBheWxvYWQ7XG5cbiAgICAgIHJldHVybiBwYXlsb2FkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBSZWdpc3RyYXIgdGVudGF0aXZhIGRlIGFjZXNzbyBpbnbDoWxpZGFcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEZhbGhhIG5hIGF1dGVudGljYcOnw6NvIGRlIGludGVncmFkb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblxuICAgICAgLy8gUHJvcGFnYSBhIGV4Y2XDp8OjbyBvcmlnaW5hbFxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIGEgcmVxdWlzacOnw6NvIHRlbSBhcyBwZXJtaXNzw7VlcyBuZWNlc3PDoXJpYXMuXG4gICAqIEBwYXJhbSByZXF1ZXN0IE9iamV0byBkZSByZXF1aXNpw6fDo28gSFRUUFxuICAgKiBAcGFyYW0gcmVxdWlyZWRTY29wZXMgRXNjb3BvcyBuZWNlc3PDoXJpb3MgcGFyYSBhIG9wZXJhw6fDo29cbiAgICogQHJldHVybnMgdHJ1ZSBzZSBhdXRvcml6YWRvLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGNoZWNrUGVybWlzc2lvbnMocmVxdWVzdDogUmVxdWVzdCwgcmVxdWlyZWRTY29wZXM6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHJlcXVlc3RbJ2ludGVncmFkb3JUb2tlblBheWxvYWQnXTtcbiAgICBpZiAoIXBheWxvYWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy50b2tlblNlcnZpY2UuaGFzUmVxdWlyZWRTY29wZXMocGF5bG9hZCwgcmVxdWlyZWRTY29wZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdHJhIHVtYSB0ZW50YXRpdmEgZGUgYWNlc3NvIChzdWNlc3NvIG91IGZhbGhhKS5cbiAgICogRXN0ZSBtw6l0b2RvIHBvZGUgc2VyIGV4cGFuZGlkbyBwYXJhIGluY2x1aXIgbWFpcyBpbmZvcm1hw6fDtWVzIGRlIGF1ZGl0b3JpYS5cbiAgICogQHBhcmFtIHRva2VuSWQgSUQgZG8gdG9rZW4gKHNlIGlkZW50aWZpY2FkbylcbiAgICogQHBhcmFtIGludGVncmFkb3JJZCBJRCBkbyBpbnRlZ3JhZG9yIChzZSBpZGVudGlmaWNhZG8pXG4gICAqIEBwYXJhbSBzdWNjZXNzIEluZGljYSBzZSBvIGFjZXNzbyBmb2kgYmVtLXN1Y2VkaWRvXG4gICAqIEBwYXJhbSBpcEFkZHJlc3MgRW5kZXJlw6dvIElQIGRhIHJlcXVpc2nDp8Ojb1xuICAgKiBAcGFyYW0gcmVzb3VyY2UgUmVjdXJzbyBxdWUgZXN0YXZhIHNlbmRvIGFjZXNzYWRvXG4gICAqIEBwYXJhbSBtZXNzYWdlIE1lbnNhZ2VtIGFkaWNpb25hbFxuICAgKi9cbiAgYXN5bmMgcmVnaXN0cmFyVGVudGF0aXZhQWNlc3NvKFxuICAgIHRva2VuSWQ6IHN0cmluZyB8IG51bGwsXG4gICAgaW50ZWdyYWRvcklkOiBzdHJpbmcgfCBudWxsLFxuICAgIHN1Y2Nlc3M6IGJvb2xlYW4sXG4gICAgaXBBZGRyZXNzOiBzdHJpbmcsXG4gICAgcmVzb3VyY2U6IHN0cmluZyxcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEFxdWkgcG9kZXJpYSBzZXIgaW1wbGVtZW50YWRhIGEgbMOzZ2ljYSBwYXJhIHJlZ2lzdHJhciBlbSB1bSBiYW5jbyBvdVxuICAgIC8vIHNpc3RlbWEgZGUgbW9uaXRvcmFtZW50by4gUG9yIG9yYSwgYXBlbmFzIGxvZ2Ftb3MuXG4gICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYEFjZXNzbyBhdXRvcml6YWRvOiBpbnRlZ3JhZG9yPSR7aW50ZWdyYWRvcklkfSwgdG9rZW49JHt0b2tlbklkfSwgaXA9JHtpcEFkZHJlc3N9LCByZWN1cnNvPSR7cmVzb3VyY2V9YCxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgIGBBY2Vzc28gbmVnYWRvOiBpbnRlZ3JhZG9yPSR7aW50ZWdyYWRvcklkfSwgaXA9JHtpcEFkZHJlc3N9LCByZWN1cnNvPSR7cmVzb3VyY2V9LCBtb3Rpdm89JHttZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBuYSBjYWNoZSBsb2NhbCBzZSB1bSB0b2tlbiBlc3TDoSByZXZvZ2Fkby5cbiAgICogRXN0ZSBtw6l0b2RvIHBvZGUgc2VyIG90aW1pemFkbyBjb20gUmVkaXMgb3Ugb3V0cm8gbWVjYW5pc21vIGRlIGNhY2hlLlxuICAgKiBAcGFyYW0gdG9rZW5IYXNoIEhhc2ggZG8gdG9rZW4gYSBzZXIgdmVyaWZpY2Fkb1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIG8gdG9rZW4gZXN0aXZlciByZXZvZ2FkbywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyBpc1Rva2VuUmV2b2dhZG8odG9rZW5IYXNoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXZvZ2FkbyA9IGF3YWl0IHRoaXMudG9rZW5SZXZvZ2Fkb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyB0b2tlbkhhc2ggfSxcbiAgICB9KTtcblxuICAgIHJldHVybiAhIXJldm9nYWRvO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=