{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\solicitacao\\controllers\\monitoramento-aluguel-social.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\solicitacao\\controllers\\monitoramento-aluguel-social.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Body,\n  Param,\n  Req,\n  UseGuards,\n  NotFoundException,\n  BadRequestException,\n  Query,\n  Logger,\n  Patch,\n  ParseIntPipe,\n  Delete,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiParam,\n  ApiQuery,\n} from '@nestjs/swagger';\nimport { MonitoramentoAluguelSocialService } from '../services/monitoramento-aluguel-social.service';\nimport { RegistrarVisitaMonitoramentoDto } from '../dto/registrar-visita-monitoramento.dto';\nimport { AtualizarVisitaMonitoramentoDto } from '../dto/atualizar-visita-monitoramento.dto';\nimport { JwtAuthGuard } from '../../../auth/guards/jwt-auth.guard';\nimport { RequiresPermission } from '../../../auth/decorators/requires-permission.decorator';\nimport { Request } from 'express';\nimport { TipoEscopo } from '@/entities/user-permission.entity';\n\n/**\n * Controller para gerenciar o monitoramento de benefícios de Aluguel Social\n */\n@ApiTags('Monitoramento de Aluguel Social')\n@Controller('monitoramento-aluguel-social')\n@UseGuards(JwtAuthGuard)\nexport class MonitoramentoAluguelSocialController {\n  private readonly logger = new Logger(\n    MonitoramentoAluguelSocialController.name,\n  );\n\n  constructor(\n    private readonly monitoramentoService: MonitoramentoAluguelSocialService,\n  ) {}\n\n  /**\n   * Registra uma nova visita de monitoramento para uma solicitação de Aluguel Social\n   */\n  @Post('registrar-visita')\n  @RequiresPermission({\n    permissionName: 'solicitacao.registrar_visita_monitoramento',\n    scopeType: TipoEscopo.UNIDADE,\n    scopeIdExpression: 'solicitacao.unidadeId',\n  })\n  @ApiOperation({\n    summary: 'Registra visita de monitoramento',\n    description:\n      'Registra uma visita de monitoramento para uma solicitação de Aluguel Social',\n  })\n  @ApiResponse({\n    status: 201,\n    description: 'Visita registrada com sucesso',\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Solicitação inválida ou não é de Aluguel Social',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Solicitação não encontrada',\n  })\n  async registrarVisita(\n    @Body() registrarVisitaDto: RegistrarVisitaMonitoramentoDto,\n    @Req() req: Request,\n  ) {\n    this.logger.log(\n      `Registrando visita para solicitação ${registrarVisitaDto.solicitacao_id}`,\n    );\n\n    try {\n      await this.monitoramentoService.registrarVisita(\n        registrarVisitaDto.solicitacao_id,\n        registrarVisitaDto.data_visita,\n        registrarVisitaDto.observacoes,\n        req.user,\n      );\n\n      return {\n        message: 'Visita de monitoramento registrada com sucesso',\n        success: true,\n      };\n    } catch (error) {\n      if (error.message === 'Solicitação não encontrada') {\n        throw new NotFoundException(error.message);\n      }\n      if (error.message === 'Solicitação não é de Aluguel Social') {\n        throw new BadRequestException(error.message);\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * Obtém as solicitações que precisam de monitoramento\n   */\n  @Get('pendentes')\n  @RequiresPermission({\n    permissionName: 'solicitacao.listar_monitoramento_pendente',\n    scopeType: TipoEscopo.UNIDADE,\n  })\n  @ApiOperation({\n    summary: 'Lista solicitações pendentes de monitoramento',\n    description:\n      'Retorna a lista de solicitações de Aluguel Social que precisam de monitoramento',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Lista de solicitações retornada com sucesso',\n  })\n  async getSolicitacoesPendentes() {\n    const solicitacoes =\n      await this.monitoramentoService.getSolicitacoesParaMonitoramento();\n\n    return {\n      total: solicitacoes.length,\n      data: solicitacoes,\n    };\n  }\n\n  /**\n   * Obtém as solicitações com alerta de monitoramento próximo\n   */\n  @Get('alertas')\n  @RequiresPermission({\n    permissionName: 'solicitacao.listar_monitoramento_alertas',\n    scopeType: TipoEscopo.UNIDADE,\n  })\n  @ApiOperation({\n    summary: 'Lista solicitações com alerta de monitoramento',\n    description:\n      'Retorna a lista de solicitações de Aluguel Social com monitoramento próximo',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Lista de alertas retornada com sucesso',\n  })\n  async getAlertasMonitoramento() {\n    const solicitacoes =\n      await this.monitoramentoService.getSolicitacoesComAlertaMonitoramento();\n\n    return {\n      total: solicitacoes.length,\n      data: solicitacoes,\n    };\n  }\n\n  /**\n   * Verifica se uma solicitação é de Aluguel Social e requer monitoramento\n   */\n  @Get(':id/status-monitoramento')\n  @RequiresPermission({\n    permissionName: 'solicitacao.verificar_status_monitoramento',\n    scopeType: TipoEscopo.UNIDADE,\n    scopeIdExpression: 'solicitacao.unidadeId',\n  })\n  @ApiOperation({\n    summary: 'Verifica status de monitoramento',\n    description:\n      'Verifica se uma solicitação é de Aluguel Social e requer monitoramento',\n  })\n  @ApiParam({\n    name: 'id',\n    description: 'ID da solicitação a ser verificada',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Status de monitoramento retornado com sucesso',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Solicitação não encontrada',\n  })\n  async verificarStatusMonitoramento(@Param('id') id: string) {\n    const solicitacao = await this.monitoramentoService.getSolicitacaoById(id);\n\n    if (!solicitacao) {\n      throw new NotFoundException('Solicitação não encontrada');\n    }\n\n    const isAluguelSocial =\n      this.monitoramentoService.isAluguelSocial(solicitacao);\n    const requiresMonitoring =\n      this.monitoramentoService.requiresMonitoring(solicitacao);\n\n    return {\n      solicitacao_id: id,\n      is_aluguel_social: isAluguelSocial,\n      requires_monitoring: requiresMonitoring,\n      proxima_visita:\n        solicitacao.dados_complementares?.proxima_visita_monitoramento || null,\n      total_visitas:\n        solicitacao.dados_complementares?.visitas_monitoramento?.length || 0,\n      ultima_visita:\n        solicitacao.dados_complementares?.visitas_monitoramento?.length > 0\n          ? solicitacao.dados_complementares.visitas_monitoramento[\n              solicitacao.dados_complementares.visitas_monitoramento.length - 1\n            ]\n          : null,\n    };\n  }\n\n  /**\n   * Obtém o histórico de visitas de monitoramento de uma solicitação\n   */\n  @Get(':id/historico-visitas')\n  @RequiresPermission({\n    permissionName: 'solicitacao.consultar_historico_visitas',\n    scopeType: TipoEscopo.UNIDADE,\n    scopeIdExpression: 'solicitacao.unidadeId',\n  })\n  @ApiOperation({\n    summary: 'Obtém histórico de visitas',\n    description:\n      'Retorna o histórico completo de visitas de monitoramento de uma solicitação',\n  })\n  @ApiParam({\n    name: 'id',\n    description: 'ID da solicitação',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Histórico de visitas retornado com sucesso',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Solicitação não encontrada',\n  })\n  async getHistoricoVisitas(@Param('id') id: string) {\n    const solicitacao = await this.monitoramentoService.getSolicitacaoById(id);\n\n    if (!solicitacao) {\n      throw new NotFoundException('Solicitação não encontrada');\n    }\n\n    if (!this.monitoramentoService.isAluguelSocial(solicitacao)) {\n      throw new BadRequestException('Solicitação não é de Aluguel Social');\n    }\n\n    const visitas =\n      solicitacao.dados_complementares?.visitas_monitoramento || [];\n\n    return {\n      solicitacao_id: id,\n      protocolo: solicitacao.protocolo,\n      total_visitas: visitas.length,\n      proxima_visita:\n        solicitacao.dados_complementares?.proxima_visita_monitoramento || null,\n      visitas: visitas,\n    };\n  }\n\n  /**\n   * Atualiza parcialmente uma visita de monitoramento existente\n   */\n  @Patch(':id/visitas/:indice')\n  @RequiresPermission({\n    permissionName: 'solicitacao.atualizar_visita_monitoramento',\n    scopeType: TipoEscopo.UNIDADE,\n    scopeIdExpression: 'solicitacao.unidadeId',\n  })\n  @ApiOperation({\n    summary: 'Atualiza uma visita de monitoramento',\n    description:\n      'Permite atualizar parcialmente os dados de uma visita de monitoramento existente',\n  })\n  @ApiParam({\n    name: 'id',\n    description: 'ID da solicitação',\n  })\n  @ApiParam({\n    name: 'indice',\n    description: 'Índice da visita no array de visitas',\n    type: 'number',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Visita atualizada com sucesso',\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Solicitação inválida ou dados incorretos',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Solicitação ou visita não encontrada',\n  })\n  async atualizarVisita(\n    @Param('id') id: string,\n    @Param('indice', ParseIntPipe) indice: number,\n    @Body() atualizarVisitaDto: AtualizarVisitaMonitoramentoDto,\n    @Req() req: Request,\n  ) {\n    this.logger.log(`Atualizando visita ${indice} para solicitação ${id}`);\n\n    try {\n      const visitaAtualizada =\n        await this.monitoramentoService.atualizarVisitaMonitoramento(\n          id,\n          indice,\n          {\n            data_visita: atualizarVisitaDto.data_visita,\n            observacoes: atualizarVisitaDto.observacoes,\n            dados_adicionais: atualizarVisitaDto.dados_adicionais,\n          },\n          req.user,\n        );\n\n      return {\n        message: 'Visita de monitoramento atualizada com sucesso',\n        success: true,\n        visita: visitaAtualizada,\n      };\n    } catch (error) {\n      if (error.message === 'Solicitação não encontrada') {\n        throw new NotFoundException(error.message);\n      }\n      if (error.message === 'Solicitação não é de Aluguel Social') {\n        throw new BadRequestException(error.message);\n      }\n      if (\n        error.message ===\n        'Solicitação não possui visitas de monitoramento registradas'\n      ) {\n        throw new BadRequestException(error.message);\n      }\n      if (error.message === 'Visita não encontrada com o índice fornecido') {\n        throw new NotFoundException(error.message);\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * Remove uma visita de monitoramento existente\n   */\n  @Delete(':id/visitas/:indice')\n  @RequiresPermission({\n    permissionName: 'solicitacao.remover_visita_monitoramento',\n    scopeType: TipoEscopo.UNIDADE,\n    scopeIdExpression: 'solicitacao.unidadeId',\n  })\n  @ApiOperation({\n    summary: 'Remove uma visita de monitoramento',\n    description: 'Remove uma visita de monitoramento existente da solicitação',\n  })\n  @ApiParam({\n    name: 'id',\n    description: 'ID da solicitação',\n  })\n  @ApiParam({\n    name: 'indice',\n    description: 'Índice da visita no array de visitas',\n    type: 'number',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Visita removida com sucesso',\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Solicitação inválida ou operação não permitida',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Solicitação ou visita não encontrada',\n  })\n  async removerVisita(\n    @Param('id') id: string,\n    @Param('indice', ParseIntPipe) indice: number,\n    @Req() req: Request,\n  ) {\n    this.logger.log(`Removendo visita ${indice} da solicitação ${id}`);\n\n    try {\n      const resultado =\n        await this.monitoramentoService.removerVisitaMonitoramento(\n          id,\n          indice,\n          req.user,\n        );\n\n      return {\n        message: 'Visita de monitoramento removida com sucesso',\n        success: true,\n        proximaVisitaAtualizada: resultado.proximaVisitaAtualizada,\n      };\n    } catch (error) {\n      if (error.message === 'Solicitação não encontrada') {\n        throw new NotFoundException(error.message);\n      }\n      if (error.message === 'Solicitação não é de Aluguel Social') {\n        throw new BadRequestException(error.message);\n      }\n      if (\n        error.message ===\n        'Solicitação não possui visitas de monitoramento registradas'\n      ) {\n        throw new BadRequestException(error.message);\n      }\n      if (error.message === 'Visita não encontrada com o índice fornecido') {\n        throw new NotFoundException(error.message);\n      }\n      throw error;\n    }\n  }\n}\n"],"version":3}