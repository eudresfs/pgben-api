db647f7083d539ae2a7aa9e0217c6466
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.HealthController = void 0;
const common_1 = require("@nestjs/common");
const terminus_1 = require("@nestjs/terminus");
const public_decorator_1 = require("../../auth/decorators/public.decorator");
const swagger_1 = require("@nestjs/swagger");
const health_check_service_1 = require("../services/health-check.service");
// import { StorageHealthService } from '../../modules/documento/services/storage-health.service';
/**
 * Controlador de Health Check
 *
 * Fornece endpoints para verificar a sa√∫de da aplica√ß√£o
 * e seus componentes (banco de dados, mem√≥ria, disco, etc.)
 */
let HealthController = class HealthController {
    health;
    http;
    db;
    memory;
    disk;
    appHealthCheck;
    constructor(health, http, db, memory, disk, appHealthCheck) {
        this.health = health;
        this.http = http;
        this.db = db;
        this.memory = memory;
        this.disk = disk;
        this.appHealthCheck = appHealthCheck;
        console.log('üî• DEBUG: HealthController inicializado');
        console.log('üî• DEBUG: Caminho do controller:', '/health');
    }
    /**
     * Endpoint principal de health check
     * Verifica todos os componentes da aplica√ß√£o
     */
    async check() {
        console.log('üî• HEALTH CONTROLLER: check() foi chamado!');
        // Verificar disponibilidade do Redis
        const isRedisAvailable = await this.appHealthCheck.isRedisAvailable();
        const disableRedis = process.env.DISABLE_REDIS === 'true';
        return this.health.check([
            // Verificar se o banco de dados est√° funcionando
            () => this.db.pingCheck('database'),
            // Verificar se o site oficial est√° acess√≠vel
            () => this.http.pingCheck('site_oficial', 'https://www.natal.rn.gov.br/'),
            // Verificar uso de mem√≥ria
            () => this.memory.checkHeap('memory_heap', 300 * 1024 * 1024), // 300MB
            // Verificar uso de disco
            () => this.disk.checkStorage('disk', {
                path: '/',
                thresholdPercent: 0.9, // 90% de uso m√°ximo
            }),
            // Verificar Redis
            async () => {
                // Usando o formato correto para HealthIndicatorResult
                return {
                    redis: {
                        status: disableRedis
                            ? 'disabled'
                            : isRedisAvailable
                                ? 'up'
                                : 'down',
                        message: disableRedis
                            ? 'Redis desabilitado por configura√ß√£o'
                            : isRedisAvailable
                                ? 'Conex√£o com Redis estabelecida'
                                : 'N√£o foi poss√≠vel conectar ao Redis',
                    },
                }; // For√ßar tipo compat√≠vel com HealthIndicatorResult
            },
            // Verificar Storage (S3/MinIO) - Temporariamente desabilitado
            // async () => {
            //   const storageStatus = await this.storageHealth.checkHealth();
            //   return {
            //     storage: {
            //       status: storageStatus.isHealthy ? 'up' : 'down',
            //       provider: storageStatus.provider,
            //       message: storageStatus.details.error || 'OK',
            //       details: storageStatus.details,
            //       lastChecked: storageStatus.timestamp,
            //     }
            //   } as unknown as Record<string, any>;
            // },
        ]);
    }
    /**
     * Endpoint simplificado para verifica√ß√µes r√°pidas
     * Retorna apenas status OK se a aplica√ß√£o estiver funcionando
     */
    ping() {
        console.log('üî• HEALTH CONTROLLER: ping() foi chamado!');
        return {
            status: 'ok',
            timestamp: new Date().toISOString(),
            service: 'pgben-api',
            version: process.env.npm_package_version || '1.0.0',
        };
    }
    /**
     * Verifica apenas o banco de dados
     */
    checkDatabase() {
        return this.health.check([() => this.db.pingCheck('database')]);
    }
    /**
     * Verifica uso de recursos do sistema
     */
    checkSystem() {
        return this.health.check([
            () => this.memory.checkHeap('memory_heap', 300 * 1024 * 1024),
            () => this.memory.checkRSS('memory_rss', 300 * 1024 * 1024),
            () => this.disk.checkStorage('disk', {
                path: '/',
                thresholdPercent: 0.9,
            }),
        ]);
    }
    /**
     * Verifica apenas o storage (S3/MinIO) - Temporariamente desabilitado
     */
    // @Get('storage')
    // @Public()
    // async checkStorage() {
    //   const storageStatus = await this.storageHealth.checkHealth();
    //   return {
    //     storage: {
    //       status: storageStatus.isHealthy ? 'up' : 'down',
    //       provider: storageStatus.provider,
    //       message: storageStatus.details.error || 'OK',
    //       details: storageStatus.details,
    //       lastChecked: storageStatus.timestamp,
    //     }
    //   };
    // }
    /**
     * Verifica a disponibilidade do Redis
     */
    async checkRedis() {
        const isRedisAvailable = await this.appHealthCheck.isRedisAvailable();
        const disableRedis = process.env.DISABLE_REDIS === 'true';
        return {
            status: disableRedis ? 'disabled' : isRedisAvailable ? 'up' : 'down',
            info: {
                redis: {
                    status: disableRedis ? 'disabled' : isRedisAvailable ? 'up' : 'down',
                    message: disableRedis
                        ? 'Redis desabilitado por configura√ß√£o'
                        : isRedisAvailable
                            ? 'Conex√£o com Redis estabelecida'
                            : 'N√£o foi poss√≠vel conectar ao Redis',
                },
            },
        };
    }
};
exports.HealthController = HealthController;
__decorate([
    (0, common_1.Get)(),
    (0, public_decorator_1.Public)(),
    (0, terminus_1.HealthCheck)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], HealthController.prototype, "check", null);
__decorate([
    (0, common_1.Get)('ping'),
    (0, public_decorator_1.Public)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], HealthController.prototype, "ping", null);
__decorate([
    (0, common_1.Get)('db'),
    (0, public_decorator_1.Public)(),
    (0, terminus_1.HealthCheck)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], HealthController.prototype, "checkDatabase", null);
__decorate([
    (0, common_1.Get)('system'),
    (0, public_decorator_1.Public)(),
    (0, terminus_1.HealthCheck)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], HealthController.prototype, "checkSystem", null);
__decorate([
    (0, common_1.Get)('redis'),
    (0, public_decorator_1.Public)(),
    (0, terminus_1.HealthCheck)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], HealthController.prototype, "checkRedis", null);
exports.HealthController = HealthController = __decorate([
    (0, swagger_1.ApiTags)('M√©tricas e Dashboard'),
    (0, common_1.Controller)({ path: 'health', version: '1' }),
    __metadata("design:paramtypes", [typeof (_a = typeof terminus_1.HealthCheckService !== "undefined" && terminus_1.HealthCheckService) === "function" ? _a : Object, typeof (_b = typeof terminus_1.HttpHealthIndicator !== "undefined" && terminus_1.HttpHealthIndicator) === "function" ? _b : Object, typeof (_c = typeof terminus_1.TypeOrmHealthIndicator !== "undefined" && terminus_1.TypeOrmHealthIndicator) === "function" ? _c : Object, typeof (_d = typeof terminus_1.MemoryHealthIndicator !== "undefined" && terminus_1.MemoryHealthIndicator) === "function" ? _d : Object, typeof (_e = typeof terminus_1.DiskHealthIndicator !== "undefined" && terminus_1.DiskHealthIndicator) === "function" ? _e : Object, typeof (_f = typeof health_check_service_1.HealthCheckService !== "undefined" && health_check_service_1.HealthCheckService) === "function" ? _f : Object])
], HealthController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcaGVhbHRoLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFpRDtBQUNqRCwrQ0FPMEI7QUFDMUIsNkVBQWdFO0FBQ2hFLDZDQUEwQztBQUMxQywyRUFBK0Y7QUFDL0Ysa0dBQWtHO0FBRWxHOzs7OztHQUtHO0FBR0ksSUFBTSxnQkFBZ0IsR0FBdEIsTUFBTSxnQkFBZ0I7SUFFakI7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBTlYsWUFDVSxNQUEwQixFQUMxQixJQUF5QixFQUN6QixFQUEwQixFQUMxQixNQUE2QixFQUM3QixJQUF5QixFQUN6QixjQUFxQztRQUxyQyxXQUFNLEdBQU4sTUFBTSxDQUFvQjtRQUMxQixTQUFJLEdBQUosSUFBSSxDQUFxQjtRQUN6QixPQUFFLEdBQUYsRUFBRSxDQUF3QjtRQUMxQixXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQUM3QixTQUFJLEdBQUosSUFBSSxDQUFxQjtRQUN6QixtQkFBYyxHQUFkLGNBQWMsQ0FBdUI7UUFHN0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7T0FHRztJQUlHLEFBQU4sS0FBSyxDQUFDLEtBQUs7UUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7UUFFMUQscUNBQXFDO1FBQ3JDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDdEUsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEtBQUssTUFBTSxDQUFDO1FBRTFELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FB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QUU7Ozs7cURBR2I7QUFRRDtJQUhDLElBQUEsWUFBRyxFQUFDLFFBQVEsQ0FBQztJQUNiLElBQUEseUJBQU0sR0FBRTtJQUNSLElBQUEsc0JBQVcsR0FBRTs7OzttREFXYjtBQTBCSztJQUhMLElBQUEsWUFBRyxFQUFDLE9BQU8sQ0FBQztJQUNaLElBQUEseUJBQU0sR0FBRTtJQUNSLElBQUEsc0JBQVcsR0FBRTs7OztrREFrQmI7MkJBcktVLGdCQUFnQjtJQUY1QixJQUFBLGlCQUFPLEVBQUMsc0JBQXNCLENBQUM7SUFDL0IsSUFBQSxtQkFBVSxFQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUM7eURBR3pCLDZCQUFrQixvQkFBbEIsNkJBQWtCLG9EQUNwQiw4QkFBbUIsb0JBQW5CLDhCQUFtQixvREFDckIsaUNBQXNCLG9CQUF0QixpQ0FBc0Isb0RBQ2xCLGdDQUFxQixvQkFBckIsZ0NBQXFCLG9EQUN2Qiw4QkFBbUIsb0JBQW5CLDhCQUFtQixvREFDVCx5Q0FBcUIsb0JBQXJCLHlDQUFxQjtHQVBwQyxnQkFBZ0IsQ0FzSzVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXG1vbml0b3JpbmdcXGhlYWx0aC5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRyb2xsZXIsIEdldCB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7XG4gIEhlYWx0aENoZWNrU2VydmljZSxcbiAgSHR0cEhlYWx0aEluZGljYXRvcixcbiAgVHlwZU9ybUhlYWx0aEluZGljYXRvcixcbiAgSGVhbHRoQ2hlY2ssXG4gIE1lbW9yeUhlYWx0aEluZGljYXRvcixcbiAgRGlza0hlYWx0aEluZGljYXRvcixcbn0gZnJvbSAnQG5lc3Rqcy90ZXJtaW51cyc7XG5pbXBvcnQgeyBQdWJsaWMgfSBmcm9tICcuLi8uLi9hdXRoL2RlY29yYXRvcnMvcHVibGljLmRlY29yYXRvcic7XG5pbXBvcnQgeyBBcGlUYWdzIH0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcbmltcG9ydCB7IEhlYWx0aENoZWNrU2VydmljZSBhcyBBcHBIZWFsdGhDaGVja1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9oZWFsdGgtY2hlY2suc2VydmljZSc7XG4vLyBpbXBvcnQgeyBTdG9yYWdlSGVhbHRoU2VydmljZSB9IGZyb20gJy4uLy4uL21vZHVsZXMvZG9jdW1lbnRvL3NlcnZpY2VzL3N0b3JhZ2UtaGVhbHRoLnNlcnZpY2UnO1xuXG4vKipcbiAqIENvbnRyb2xhZG9yIGRlIEhlYWx0aCBDaGVja1xuICpcbiAqIEZvcm5lY2UgZW5kcG9pbnRzIHBhcmEgdmVyaWZpY2FyIGEgc2HDumRlIGRhIGFwbGljYcOnw6NvXG4gKiBlIHNldXMgY29tcG9uZW50ZXMgKGJhbmNvIGRlIGRhZG9zLCBtZW3Ds3JpYSwgZGlzY28sIGV0Yy4pXG4gKi9cbkBBcGlUYWdzKCdNw6l0cmljYXMgZSBEYXNoYm9hcmQnKVxuQENvbnRyb2xsZXIoeyBwYXRoOiAnaGVhbHRoJywgdmVyc2lvbjogJzEnIH0pXG5leHBvcnQgY2xhc3MgSGVhbHRoQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaGVhbHRoOiBIZWFsdGhDaGVja1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwSGVhbHRoSW5kaWNhdG9yLFxuICAgIHByaXZhdGUgZGI6IFR5cGVPcm1IZWFsdGhJbmRpY2F0b3IsXG4gICAgcHJpdmF0ZSBtZW1vcnk6IE1lbW9yeUhlYWx0aEluZGljYXRvcixcbiAgICBwcml2YXRlIGRpc2s6IERpc2tIZWFsdGhJbmRpY2F0b3IsXG4gICAgcHJpdmF0ZSBhcHBIZWFsdGhDaGVjazogQXBwSGVhbHRoQ2hlY2tTZXJ2aWNlLFxuICAgIC8vIHByaXZhdGUgc3RvcmFnZUhlYWx0aDogU3RvcmFnZUhlYWx0aFNlcnZpY2UsXG4gICkge1xuICAgIGNvbnNvbGUubG9nKCfwn5SlIERFQlVHOiBIZWFsdGhDb250cm9sbGVyIGluaWNpYWxpemFkbycpO1xuICAgIGNvbnNvbGUubG9nKCfwn5SlIERFQlVHOiBDYW1pbmhvIGRvIGNvbnRyb2xsZXI6JywgJy9oZWFsdGgnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbmRwb2ludCBwcmluY2lwYWwgZGUgaGVhbHRoIGNoZWNrXG4gICAqIFZlcmlmaWNhIHRvZG9zIG9zIGNvbXBvbmVudGVzIGRhIGFwbGljYcOnw6NvXG4gICAqL1xuICBAR2V0KClcbiAgQFB1YmxpYygpXG4gIEBIZWFsdGhDaGVjaygpXG4gIGFzeW5jIGNoZWNrKCkge1xuICAgIGNvbnNvbGUubG9nKCfwn5SlIEhFQUxUSCBDT05UUk9MTEVSOiBjaGVjaygpIGZvaSBjaGFtYWRvIScpO1xuXG4gICAgLy8gVmVyaWZpY2FyIGRpc3BvbmliaWxpZGFkZSBkbyBSZWRpc1xuICAgIGNvbnN0IGlzUmVkaXNBdmFpbGFibGUgPSBhd2FpdCB0aGlzLmFwcEhlYWx0aENoZWNrLmlzUmVkaXNBdmFpbGFibGUoKTtcbiAgICBjb25zdCBkaXNhYmxlUmVkaXMgPSBwcm9jZXNzLmVudi5ESVNBQkxFX1JFRElTID09PSAndHJ1ZSc7XG5cbiAgICByZXR1cm4gdGhpcy5oZWFsdGguY2hlY2soW1xuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gYmFuY28gZGUgZGFkb3MgZXN0w6EgZnVuY2lvbmFuZG9cbiAgICAgICgpID0+IHRoaXMuZGIucGluZ0NoZWNrKCdkYXRhYmFzZScpLFxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyBzaXRlIG9maWNpYWwgZXN0w6EgYWNlc3PDrXZlbFxuICAgICAgKCkgPT4gdGhpcy5odHRwLnBpbmdDaGVjaygnc2l0ZV9vZmljaWFsJywgJ2h0dHBzOi8vd3d3Lm5hdGFsLnJuLmdvdi5ici8nKSxcblxuICAgICAgLy8gVmVyaWZpY2FyIHVzbyBkZSBtZW3Ds3JpYVxuICAgICAgKCkgPT4gdGhpcy5tZW1vcnkuY2hlY2tIZWFwKCdtZW1vcnlfaGVhcCcsIDMwMCAqIDEwMjQgKiAxMDI0KSwgLy8gMzAwTUJcblxuICAgICAgLy8gVmVyaWZpY2FyIHVzbyBkZSBkaXNjb1xuICAgICAgKCkgPT5cbiAgICAgICAgdGhpcy5kaXNrLmNoZWNrU3RvcmFnZSgnZGlzaycsIHtcbiAgICAgICAgICBwYXRoOiAnLycsXG4gICAgICAgICAgdGhyZXNob2xkUGVyY2VudDogMC45LCAvLyA5MCUgZGUgdXNvIG3DoXhpbW9cbiAgICAgICAgfSksXG5cbiAgICAgIC8vIFZlcmlmaWNhciBSZWRpc1xuICAgICAgYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBVc2FuZG8gbyBmb3JtYXRvIGNvcnJldG8gcGFyYSBIZWFsdGhJbmRpY2F0b3JSZXN1bHRcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICByZWRpczoge1xuICAgICAgICAgICAgc3RhdHVzOiBkaXNhYmxlUmVkaXNcbiAgICAgICAgICAgICAgPyAnZGlzYWJsZWQnXG4gICAgICAgICAgICAgIDogaXNSZWRpc0F2YWlsYWJsZVxuICAgICAgICAgICAgICAgID8gJ3VwJ1xuICAgICAgICAgICAgICAgIDogJ2Rvd24nLFxuICAgICAgICAgICAgbWVzc2FnZTogZGlzYWJsZVJlZGlzXG4gICAgICAgICAgICAgID8gJ1JlZGlzIGRlc2FiaWxpdGFkbyBwb3IgY29uZmlndXJhw6fDo28nXG4gICAgICAgICAgICAgIDogaXNSZWRpc0F2YWlsYWJsZVxuICAgICAgICAgICAgICAgID8gJ0NvbmV4w6NvIGNvbSBSZWRpcyBlc3RhYmVsZWNpZGEnXG4gICAgICAgICAgICAgICAgOiAnTsOjbyBmb2kgcG9zc8OtdmVsIGNvbmVjdGFyIGFvIFJlZGlzJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9IGFzIHVua25vd24gYXMgUmVjb3JkPHN0cmluZywgYW55PjsgLy8gRm9yw6dhciB0aXBvIGNvbXBhdMOtdmVsIGNvbSBIZWFsdGhJbmRpY2F0b3JSZXN1bHRcbiAgICAgIH0sXG5cbiAgICAgIC8vIFZlcmlmaWNhciBTdG9yYWdlIChTMy9NaW5JTykgLSBUZW1wb3JhcmlhbWVudGUgZGVzYWJpbGl0YWRvXG4gICAgICAvLyBhc3luYyAoKSA9PiB7XG4gICAgICAvLyAgIGNvbnN0IHN0b3JhZ2VTdGF0dXMgPSBhd2FpdCB0aGlzLnN0b3JhZ2VIZWFsdGguY2hlY2tIZWFsdGgoKTtcbiAgICAgIC8vICAgcmV0dXJuIHtcbiAgICAgIC8vICAgICBzdG9yYWdlOiB7XG4gICAgICAvLyAgICAgICBzdGF0dXM6IHN0b3JhZ2VTdGF0dXMuaXNIZWFsdGh5ID8gJ3VwJyA6ICdkb3duJyxcbiAgICAgIC8vICAgICAgIHByb3ZpZGVyOiBzdG9yYWdlU3RhdHVzLnByb3ZpZGVyLFxuICAgICAgLy8gICAgICAgbWVzc2FnZTogc3RvcmFnZVN0YXR1cy5kZXRhaWxzLmVycm9yIHx8ICdPSycsXG4gICAgICAvLyAgICAgICBkZXRhaWxzOiBzdG9yYWdlU3RhdHVzLmRldGFpbHMsXG4gICAgICAvLyAgICAgICBsYXN0Q2hlY2tlZDogc3RvcmFnZVN0YXR1cy50aW1lc3RhbXAsXG4gICAgICAvLyAgICAgfVxuICAgICAgLy8gICB9IGFzIHVua25vd24gYXMgUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICAgIC8vIH0sXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogRW5kcG9pbnQgc2ltcGxpZmljYWRvIHBhcmEgdmVyaWZpY2HDp8O1ZXMgcsOhcGlkYXNcbiAgICogUmV0b3JuYSBhcGVuYXMgc3RhdHVzIE9LIHNlIGEgYXBsaWNhw6fDo28gZXN0aXZlciBmdW5jaW9uYW5kb1xuICAgKi9cbiAgQEdldCgncGluZycpXG4gIEBQdWJsaWMoKVxuICBwaW5nKCkge1xuICAgIGNvbnNvbGUubG9nKCfwn5SlIEhFQUxUSCBDT05UUk9MTEVSOiBwaW5nKCkgZm9pIGNoYW1hZG8hJyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1czogJ29rJyxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgc2VydmljZTogJ3BnYmVuLWFwaScsXG4gICAgICB2ZXJzaW9uOiBwcm9jZXNzLmVudi5ucG1fcGFja2FnZV92ZXJzaW9uIHx8ICcxLjAuMCcsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBhcGVuYXMgbyBiYW5jbyBkZSBkYWRvc1xuICAgKi9cbiAgQEdldCgnZGInKVxuICBAUHVibGljKClcbiAgQEhlYWx0aENoZWNrKClcbiAgY2hlY2tEYXRhYmFzZSgpIHtcbiAgICByZXR1cm4gdGhpcy5oZWFsdGguY2hlY2soWygpID0+IHRoaXMuZGIucGluZ0NoZWNrKCdkYXRhYmFzZScpXSk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2EgdXNvIGRlIHJlY3Vyc29zIGRvIHNpc3RlbWFcbiAgICovXG4gIEBHZXQoJ3N5c3RlbScpXG4gIEBQdWJsaWMoKVxuICBASGVhbHRoQ2hlY2soKVxuICBjaGVja1N5c3RlbSgpIHtcbiAgICByZXR1cm4gdGhpcy5oZWFsdGguY2hlY2soW1xuICAgICAgKCkgPT4gdGhpcy5tZW1vcnkuY2hlY2tIZWFwKCdtZW1vcnlfaGVhcCcsIDMwMCAqIDEwMjQgKiAxMDI0KSxcbiAgICAgICgpID0+IHRoaXMubWVtb3J5LmNoZWNrUlNTKCdtZW1vcnlfcnNzJywgMzAwICogMTAyNCAqIDEwMjQpLFxuICAgICAgKCkgPT5cbiAgICAgICAgdGhpcy5kaXNrLmNoZWNrU3RvcmFnZSgnZGlzaycsIHtcbiAgICAgICAgICBwYXRoOiAnLycsXG4gICAgICAgICAgdGhyZXNob2xkUGVyY2VudDogMC45LFxuICAgICAgICB9KSxcbiAgICBdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBhcGVuYXMgbyBzdG9yYWdlIChTMy9NaW5JTykgLSBUZW1wb3JhcmlhbWVudGUgZGVzYWJpbGl0YWRvXG4gICAqL1xuICAvLyBAR2V0KCdzdG9yYWdlJylcbiAgLy8gQFB1YmxpYygpXG4gIC8vIGFzeW5jIGNoZWNrU3RvcmFnZSgpIHtcbiAgLy8gICBjb25zdCBzdG9yYWdlU3RhdHVzID0gYXdhaXQgdGhpcy5zdG9yYWdlSGVhbHRoLmNoZWNrSGVhbHRoKCk7XG4gIC8vICAgcmV0dXJuIHtcbiAgLy8gICAgIHN0b3JhZ2U6IHtcbiAgLy8gICAgICAgc3RhdHVzOiBzdG9yYWdlU3RhdHVzLmlzSGVhbHRoeSA/ICd1cCcgOiAnZG93bicsXG4gIC8vICAgICAgIHByb3ZpZGVyOiBzdG9yYWdlU3RhdHVzLnByb3ZpZGVyLFxuICAvLyAgICAgICBtZXNzYWdlOiBzdG9yYWdlU3RhdHVzLmRldGFpbHMuZXJyb3IgfHwgJ09LJyxcbiAgLy8gICAgICAgZGV0YWlsczogc3RvcmFnZVN0YXR1cy5kZXRhaWxzLFxuICAvLyAgICAgICBsYXN0Q2hlY2tlZDogc3RvcmFnZVN0YXR1cy50aW1lc3RhbXAsXG4gIC8vICAgICB9XG4gIC8vICAgfTtcbiAgLy8gfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBhIGRpc3BvbmliaWxpZGFkZSBkbyBSZWRpc1xuICAgKi9cbiAgQEdldCgncmVkaXMnKVxuICBAUHVibGljKClcbiAgQEhlYWx0aENoZWNrKClcbiAgYXN5bmMgY2hlY2tSZWRpcygpIHtcbiAgICBjb25zdCBpc1JlZGlzQXZhaWxhYmxlID0gYXdhaXQgdGhpcy5hcHBIZWFsdGhDaGVjay5pc1JlZGlzQXZhaWxhYmxlKCk7XG4gICAgY29uc3QgZGlzYWJsZVJlZGlzID0gcHJvY2Vzcy5lbnYuRElTQUJMRV9SRURJUyA9PT0gJ3RydWUnO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1czogZGlzYWJsZVJlZGlzID8gJ2Rpc2FibGVkJyA6IGlzUmVkaXNBdmFpbGFibGUgPyAndXAnIDogJ2Rvd24nLFxuICAgICAgaW5mbzoge1xuICAgICAgICByZWRpczoge1xuICAgICAgICAgIHN0YXR1czogZGlzYWJsZVJlZGlzID8gJ2Rpc2FibGVkJyA6IGlzUmVkaXNBdmFpbGFibGUgPyAndXAnIDogJ2Rvd24nLFxuICAgICAgICAgIG1lc3NhZ2U6IGRpc2FibGVSZWRpc1xuICAgICAgICAgICAgPyAnUmVkaXMgZGVzYWJpbGl0YWRvIHBvciBjb25maWd1cmHDp8OjbydcbiAgICAgICAgICAgIDogaXNSZWRpc0F2YWlsYWJsZVxuICAgICAgICAgICAgICA/ICdDb25leMOjbyBjb20gUmVkaXMgZXN0YWJlbGVjaWRhJ1xuICAgICAgICAgICAgICA6ICdOw6NvIGZvaSBwb3Nzw612ZWwgY29uZWN0YXIgYW8gUmVkaXMnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=