{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\auth\\repositories\\user-permission.repository.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\auth\\repositories\\user-permission.repository.ts"],"sourcesContent":["import { DataSource, Repository } from 'typeorm';\nimport { Injectable } from '@nestjs/common';\nimport {\n  UserPermission,\n  ScopeType,\n  TipoEscopo,\n} from '../../entities/user-permission.entity';\n\n/**\n * Repositório para a entidade UserPermission.\n *\n * Fornece métodos para manipulação de permissões atribuídas diretamente a usuários no banco de dados,\n * incluindo busca por usuário, permissão, escopo e operações de CRUD.\n */\n@Injectable()\nexport class UserPermissionRepository extends Repository<UserPermission> {\n  constructor(private dataSource: DataSource) {\n    super(UserPermission, dataSource.createEntityManager());\n  }\n\n  /**\n   * Busca permissões por ID de usuário.\n   *\n   * @param userId ID do usuário\n   * @returns Lista de permissões encontradas\n   */\n  async findByUserId(userId: string): Promise<UserPermission[]> {\n    return this.find({ where: { usuario_id: userId } });\n  }\n\n  /**\n   * Busca permissões por ID de usuário com permissões relacionadas.\n   *\n   * @param userId ID do usuário\n   * @returns Lista de permissões encontradas com permissões relacionadas\n   */\n  async findByUserIdWithPermissions(userId: string): Promise<UserPermission[]> {\n    return this.createQueryBuilder('permissao_usuario')\n      .leftJoinAndSelect('permissao_usuario.permissao', 'permissao')\n      .where('permissao_usuario.usuario_id = :userId', { userId })\n      .getMany();\n  }\n\n  /**\n   * Busca permissões por ID de permissão.\n   *\n   * @param permissionId ID da permissão\n   * @returns Lista de permissões encontradas\n   */\n  async findByPermissionId(permissionId: string): Promise<UserPermission[]> {\n    return this.find({ where: { permissao_id: permissionId } });\n  }\n\n  /**\n   * Busca permissão por ID de usuário, ID de permissão, tipo de escopo e ID de escopo.\n   *\n   * @param userId ID do usuário\n   * @param permissionId ID da permissão\n   * @param scopeType Tipo de escopo\n   * @param scopeId ID do escopo (opcional)\n   * @returns A permissão encontrada ou null\n   */\n  async findByUserAndPermission(\n    userId: string,\n    permissionId: string,\n    scopeType: TipoEscopo,\n    scopeId?: string,\n  ): Promise<UserPermission | null> {\n    return this.findOne({\n      where: {\n        usuario_id: userId,\n        permissao_id: permissionId,\n        tipo_escopo: scopeType,\n        ...(scopeId && { escopo_id: scopeId }),\n      },\n    });\n  }\n\n  /**\n   * Busca permissões por ID de usuário e tipo de escopo.\n   *\n   * @param userId ID do usuário\n   * @param scopeType Tipo de escopo\n   * @returns Lista de permissões encontradas\n   */\n  async findByUserIdAndScopeType(\n    userId: string,\n    scopeType: TipoEscopo,\n  ): Promise<UserPermission[]> {\n    return this.find({ where: { usuario_id: userId, tipo_escopo: scopeType } });\n  }\n\n  /**\n   * Busca permissões por ID de usuário, tipo de escopo e ID de escopo.\n   *\n   * @param userId ID do usuário\n   * @param scopeType Tipo de escopo\n   * @param scopeId ID do escopo\n   * @returns Lista de permissões encontradas\n   */\n  async findByUserIdAndScope(\n    userId: string,\n    scopeType: TipoEscopo,\n    scopeId: string,\n  ): Promise<UserPermission[]> {\n    return this.find({\n      where: { usuario_id: userId, tipo_escopo: scopeType, escopo_id: scopeId },\n    });\n  }\n\n  /**\n   * Busca permissões válidas (não expiradas) por ID de usuário.\n   *\n   * @param userId ID do usuário\n   * @returns Lista de permissões válidas encontradas\n   */\n  async findValidByUserId(userId: string): Promise<UserPermission[]> {\n    const now = new Date();\n    return this.createQueryBuilder('permissao_usuario')\n      .leftJoinAndSelect('permissao_usuario.permissao', 'permissao')\n      .where('permissao_usuario.usuario_id = :userId', { userId })\n      .andWhere(\n        '(permissao_usuario.valido_ate IS NULL OR permissao_usuario.valido_ate > :now)',\n        { now },\n      )\n      .getMany();\n  }\n\n  /**\n   * Cria uma nova permissão para um usuário.\n   *\n   * @param data Dados da permissão a ser criada\n   * @returns A permissão criada\n   */\n  async createUserPermission(\n    data: Partial<UserPermission>,\n  ): Promise<UserPermission> {\n    const userPermission = this.create(data);\n    return this.save(userPermission);\n  }\n\n  /**\n   * Atualiza uma permissão existente de um usuário.\n   *\n   * @param id ID da permissão a ser atualizada\n   * @param data Dados atualizados da permissão\n   * @returns A permissão atualizada\n   */\n  async updateUserPermission(\n    id: string,\n    data: Partial<UserPermission>,\n  ): Promise<UserPermission | null> {\n    await this.update(id, data);\n    return this.findOneBy({ id });\n  }\n\n  /**\n   * Remove uma permissão de um usuário.\n   *\n   * @param id ID da permissão a ser removida\n   * @returns true se a permissão foi removida, false caso contrário\n   */\n  async removeUserPermission(id: string): Promise<boolean> {\n    const result = await this.delete(id);\n    return (\n      result.affected !== null &&\n      result.affected !== undefined &&\n      result.affected > 0\n    );\n  }\n\n  /**\n   * Remove todas as permissões de um usuário.\n   *\n   * @param userId ID do usuário\n   * @returns true se as permissões foram removidas, false caso contrário\n   */\n  async removeUserPermissionsByUserId(userId: string): Promise<boolean> {\n    const result = await this.delete({ usuario_id: userId });\n    return (\n      result.affected !== null &&\n      result.affected !== undefined &&\n      result.affected > 0\n    );\n  }\n\n  /**\n   * Remove todas as permissões de um tipo específico.\n   *\n   * @param permissionId ID da permissão\n   * @returns true se as permissões foram removidas, false caso contrário\n   */\n  async removeUserPermissionsByPermissionId(\n    permissionId: string,\n  ): Promise<boolean> {\n    const result = await this.delete({ permissao_id: permissionId });\n    return (\n      result.affected !== null &&\n      result.affected !== undefined &&\n      result.affected > 0\n    );\n  }\n\n  /**\n   * Remove todas as permissões de um escopo específico.\n   *\n   * @param scopeType Tipo de escopo\n   * @param scopeId ID do escopo\n   * @returns true se as permissões foram removidas, false caso contrário\n   */\n  async removeUserPermissionsByScope(\n    scopeType: TipoEscopo,\n    scopeId: string,\n  ): Promise<boolean> {\n    const result = await this.delete({\n      tipo_escopo: scopeType,\n      escopo_id: scopeId,\n    });\n    return (\n      result.affected !== null &&\n      result.affected !== undefined &&\n      result.affected > 0\n    );\n  }\n}\n"],"version":3}