05edfa6723a6ea30ff18ea48f38011e6
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserPermissionRepository = void 0;
const typeorm_1 = require("typeorm");
const common_1 = require("@nestjs/common");
const user_permission_entity_1 = require("../../entities/user-permission.entity");
/**
 * Repositório para a entidade UserPermission.
 *
 * Fornece métodos para manipulação de permissões atribuídas diretamente a usuários no banco de dados,
 * incluindo busca por usuário, permissão, escopo e operações de CRUD.
 */
let UserPermissionRepository = class UserPermissionRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(user_permission_entity_1.UserPermission, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Busca permissões por ID de usuário.
     *
     * @param userId ID do usuário
     * @returns Lista de permissões encontradas
     */
    async findByUserId(userId) {
        return this.find({ where: { usuario_id: userId } });
    }
    /**
     * Busca permissões por ID de usuário com permissões relacionadas.
     *
     * @param userId ID do usuário
     * @returns Lista de permissões encontradas com permissões relacionadas
     */
    async findByUserIdWithPermissions(userId) {
        return this.createQueryBuilder('permissao_usuario')
            .leftJoinAndSelect('permissao_usuario.permissao', 'permissao')
            .where('permissao_usuario.usuario_id = :userId', { userId })
            .getMany();
    }
    /**
     * Busca permissões por ID de permissão.
     *
     * @param permissionId ID da permissão
     * @returns Lista de permissões encontradas
     */
    async findByPermissionId(permissionId) {
        return this.find({ where: { permissao_id: permissionId } });
    }
    /**
     * Busca permissão por ID de usuário, ID de permissão, tipo de escopo e ID de escopo.
     *
     * @param userId ID do usuário
     * @param permissionId ID da permissão
     * @param scopeType Tipo de escopo
     * @param scopeId ID do escopo (opcional)
     * @returns A permissão encontrada ou null
     */
    async findByUserAndPermission(userId, permissionId, scopeType, scopeId) {
        return this.findOne({
            where: {
                usuario_id: userId,
                permissao_id: permissionId,
                tipo_escopo: scopeType,
                ...(scopeId && { escopo_id: scopeId }),
            },
        });
    }
    /**
     * Busca permissões por ID de usuário e tipo de escopo.
     *
     * @param userId ID do usuário
     * @param scopeType Tipo de escopo
     * @returns Lista de permissões encontradas
     */
    async findByUserIdAndScopeType(userId, scopeType) {
        return this.find({ where: { usuario_id: userId, tipo_escopo: scopeType } });
    }
    /**
     * Busca permissões por ID de usuário, tipo de escopo e ID de escopo.
     *
     * @param userId ID do usuário
     * @param scopeType Tipo de escopo
     * @param scopeId ID do escopo
     * @returns Lista de permissões encontradas
     */
    async findByUserIdAndScope(userId, scopeType, scopeId) {
        return this.find({
            where: { usuario_id: userId, tipo_escopo: scopeType, escopo_id: scopeId },
        });
    }
    /**
     * Busca permissões válidas (não expiradas) por ID de usuário.
     *
     * @param userId ID do usuário
     * @returns Lista de permissões válidas encontradas
     */
    async findValidByUserId(userId) {
        const now = new Date();
        return this.createQueryBuilder('permissao_usuario')
            .leftJoinAndSelect('permissao_usuario.permissao', 'permissao')
            .where('permissao_usuario.usuario_id = :userId', { userId })
            .andWhere('(permissao_usuario.valido_ate IS NULL OR permissao_usuario.valido_ate > :now)', { now })
            .getMany();
    }
    /**
     * Cria uma nova permissão para um usuário.
     *
     * @param data Dados da permissão a ser criada
     * @returns A permissão criada
     */
    async createUserPermission(data) {
        const userPermission = this.create(data);
        return this.save(userPermission);
    }
    /**
     * Atualiza uma permissão existente de um usuário.
     *
     * @param id ID da permissão a ser atualizada
     * @param data Dados atualizados da permissão
     * @returns A permissão atualizada
     */
    async updateUserPermission(id, data) {
        await this.update(id, data);
        return this.findOneBy({ id });
    }
    /**
     * Remove uma permissão de um usuário.
     *
     * @param id ID da permissão a ser removida
     * @returns true se a permissão foi removida, false caso contrário
     */
    async removeUserPermission(id) {
        const result = await this.delete(id);
        return (result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0);
    }
    /**
     * Remove todas as permissões de um usuário.
     *
     * @param userId ID do usuário
     * @returns true se as permissões foram removidas, false caso contrário
     */
    async removeUserPermissionsByUserId(userId) {
        const result = await this.delete({ usuario_id: userId });
        return (result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0);
    }
    /**
     * Remove todas as permissões de um tipo específico.
     *
     * @param permissionId ID da permissão
     * @returns true se as permissões foram removidas, false caso contrário
     */
    async removeUserPermissionsByPermissionId(permissionId) {
        const result = await this.delete({ permissao_id: permissionId });
        return (result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0);
    }
    /**
     * Remove todas as permissões de um escopo específico.
     *
     * @param scopeType Tipo de escopo
     * @param scopeId ID do escopo
     * @returns true se as permissões foram removidas, false caso contrário
     */
    async removeUserPermissionsByScope(scopeType, scopeId) {
        const result = await this.delete({
            tipo_escopo: scopeType,
            escopo_id: scopeId,
        });
        return (result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0);
    }
};
exports.UserPermissionRepository = UserPermissionRepository;
exports.UserPermissionRepository = UserPermissionRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], UserPermissionRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xcdXNlci1wZXJtaXNzaW9uLnJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLHFDQUFpRDtBQUNqRCwyQ0FBNEM7QUFDNUMsa0ZBSStDO0FBRS9DOzs7OztHQUtHO0FBRUksSUFBTSx3QkFBd0IsR0FBOUIsTUFBTSx3QkFBeUIsU0FBUSxvQkFBMEI7SUFDbEQ7SUFBcEIsWUFBb0IsVUFBc0I7UUFDeEMsS0FBSyxDQUFDLHVDQUFjLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUR0QyxlQUFVLEdBQVYsVUFBVSxDQUFZO0lBRTFDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBYztRQUMvQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxNQUFjO1FBQzlDLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDO2FBQ2hELGlCQUFpQixDQUFDLDZCQUE2QixFQUFFLFdBQVcsQ0FBQzthQUM3RCxLQUFLLENBQUMsd0NBQXdDLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQzthQUMzRCxPQUFPLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxZQUFvQjtRQUMzQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7Ozs7Ozs7T0FRRztJQUNILEtBQUss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LENBQ3ZDLFlBQW9CO1FBRXBCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sQ0FDTCxNQUFNLENBQUMsUUFBUSxLQUFLLElBQUk7WUFDeEIsTUFBTSxDQUFDLFFBQVEsS0FBSyxTQUFTO1lBQzdCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUNwQixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyw0QkFBNEIsQ0FDaEMsU0FBcUIsRUFDckIsT0FBZTtRQUVmLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMvQixXQUFXLEVBQUUsU0FBUztZQUN0QixTQUFTLEVBQUUsT0FBTztTQUNuQixDQUFDLENBQUM7UUFDSCxPQUFPLENBQ0wsTUFBTSxDQUFDLFFBQVEsS0FBSyxJQUFJO1lBQ3hCLE1BQU0sQ0FBQyxRQUFRLEtBQUssU0FBUztZQUM3QixNQUFNLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FDcEIsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBak5ZLDREQUF3QjttQ0FBeEIsd0JBQXdCO0lBRHBDLElBQUEsbUJBQVUsR0FBRTt5REFFcUIsb0JBQVUsb0JBQVYsb0JBQVU7R0FEL0Isd0JBQXdCLENBaU5wQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcYXV0aFxccmVwb3NpdG9yaWVzXFx1c2VyLXBlcm1pc3Npb24ucmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhU291cmNlLCBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHtcbiAgVXNlclBlcm1pc3Npb24sXG4gIFNjb3BlVHlwZSxcbiAgVGlwb0VzY29wbyxcbn0gZnJvbSAnLi4vLi4vZW50aXRpZXMvdXNlci1wZXJtaXNzaW9uLmVudGl0eSc7XG5cbi8qKlxuICogUmVwb3NpdMOzcmlvIHBhcmEgYSBlbnRpZGFkZSBVc2VyUGVybWlzc2lvbi5cbiAqXG4gKiBGb3JuZWNlIG3DqXRvZG9zIHBhcmEgbWFuaXB1bGHDp8OjbyBkZSBwZXJtaXNzw7VlcyBhdHJpYnXDrWRhcyBkaXJldGFtZW50ZSBhIHVzdcOhcmlvcyBubyBiYW5jbyBkZSBkYWRvcyxcbiAqIGluY2x1aW5kbyBidXNjYSBwb3IgdXN1w6FyaW8sIHBlcm1pc3PDo28sIGVzY29wbyBlIG9wZXJhw6fDtWVzIGRlIENSVUQuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBVc2VyUGVybWlzc2lvblJlcG9zaXRvcnkgZXh0ZW5kcyBSZXBvc2l0b3J5PFVzZXJQZXJtaXNzaW9uPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSkge1xuICAgIHN1cGVyKFVzZXJQZXJtaXNzaW9uLCBkYXRhU291cmNlLmNyZWF0ZUVudGl0eU1hbmFnZXIoKSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIElEIGRlIHVzdcOhcmlvLlxuICAgKlxuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIGVuY29udHJhZGFzXG4gICAqL1xuICBhc3luYyBmaW5kQnlVc2VySWQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXJQZXJtaXNzaW9uW10+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kKHsgd2hlcmU6IHsgdXN1YXJpb19pZDogdXNlcklkIH0gfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIElEIGRlIHVzdcOhcmlvIGNvbSBwZXJtaXNzw7VlcyByZWxhY2lvbmFkYXMuXG4gICAqXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgcGVybWlzc8O1ZXMgZW5jb250cmFkYXMgY29tIHBlcm1pc3PDtWVzIHJlbGFjaW9uYWRhc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5VXNlcklkV2l0aFBlcm1pc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUGVybWlzc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdwZXJtaXNzYW9fdXN1YXJpbycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ3Blcm1pc3Nhb191c3VhcmlvLnBlcm1pc3NhbycsICdwZXJtaXNzYW8nKVxuICAgICAgLndoZXJlKCdwZXJtaXNzYW9fdXN1YXJpby51c3VhcmlvX2lkID0gOnVzZXJJZCcsIHsgdXNlcklkIH0pXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHBlcm1pc3PDtWVzIHBvciBJRCBkZSBwZXJtaXNzw6NvLlxuICAgKlxuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgTGlzdGEgZGUgcGVybWlzc8O1ZXMgZW5jb250cmFkYXNcbiAgICovXG4gIGFzeW5jIGZpbmRCeVBlcm1pc3Npb25JZChwZXJtaXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclBlcm1pc3Npb25bXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbmQoeyB3aGVyZTogeyBwZXJtaXNzYW9faWQ6IHBlcm1pc3Npb25JZCB9IH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHBlcm1pc3PDo28gcG9yIElEIGRlIHVzdcOhcmlvLCBJRCBkZSBwZXJtaXNzw6NvLCB0aXBvIGRlIGVzY29wbyBlIElEIGRlIGVzY29wby5cbiAgICpcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHBhcmFtIHNjb3BlVHlwZSBUaXBvIGRlIGVzY29wb1xuICAgKiBAcGFyYW0gc2NvcGVJZCBJRCBkbyBlc2NvcG8gKG9wY2lvbmFsKVxuICAgKiBAcmV0dXJucyBBIHBlcm1pc3PDo28gZW5jb250cmFkYSBvdSBudWxsXG4gICAqL1xuICBhc3luYyBmaW5kQnlVc2VyQW5kUGVybWlzc2lvbihcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uSWQ6IHN0cmluZyxcbiAgICBzY29wZVR5cGU6IFRpcG9Fc2NvcG8sXG4gICAgc2NvcGVJZD86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxVc2VyUGVybWlzc2lvbiB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHVzdWFyaW9faWQ6IHVzZXJJZCxcbiAgICAgICAgcGVybWlzc2FvX2lkOiBwZXJtaXNzaW9uSWQsXG4gICAgICAgIHRpcG9fZXNjb3BvOiBzY29wZVR5cGUsXG4gICAgICAgIC4uLihzY29wZUlkICYmIHsgZXNjb3BvX2lkOiBzY29wZUlkIH0pLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBwZXJtaXNzw7VlcyBwb3IgSUQgZGUgdXN1w6FyaW8gZSB0aXBvIGRlIGVzY29wby5cbiAgICpcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gc2NvcGVUeXBlIFRpcG8gZGUgZXNjb3BvXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIGVuY29udHJhZGFzXG4gICAqL1xuICBhc3luYyBmaW5kQnlVc2VySWRBbmRTY29wZVR5cGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgc2NvcGVUeXBlOiBUaXBvRXNjb3BvLFxuICApOiBQcm9taXNlPFVzZXJQZXJtaXNzaW9uW10+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kKHsgd2hlcmU6IHsgdXN1YXJpb19pZDogdXNlcklkLCB0aXBvX2VzY29wbzogc2NvcGVUeXBlIH0gfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIElEIGRlIHVzdcOhcmlvLCB0aXBvIGRlIGVzY29wbyBlIElEIGRlIGVzY29wby5cbiAgICpcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gc2NvcGVUeXBlIFRpcG8gZGUgZXNjb3BvXG4gICAqIEBwYXJhbSBzY29wZUlkIElEIGRvIGVzY29wb1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBwZXJtaXNzw7VlcyBlbmNvbnRyYWRhc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5VXNlcklkQW5kU2NvcGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgc2NvcGVUeXBlOiBUaXBvRXNjb3BvLFxuICAgIHNjb3BlSWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxVc2VyUGVybWlzc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZCh7XG4gICAgICB3aGVyZTogeyB1c3VhcmlvX2lkOiB1c2VySWQsIHRpcG9fZXNjb3BvOiBzY29wZVR5cGUsIGVzY29wb19pZDogc2NvcGVJZCB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHBlcm1pc3PDtWVzIHbDoWxpZGFzIChuw6NvIGV4cGlyYWRhcykgcG9yIElEIGRlIHVzdcOhcmlvLlxuICAgKlxuICAgKiBAcGFyYW0gdXNlcklkIElEIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIHbDoWxpZGFzIGVuY29udHJhZGFzXG4gICAqL1xuICBhc3luYyBmaW5kVmFsaWRCeVVzZXJJZCh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8VXNlclBlcm1pc3Npb25bXT4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdwZXJtaXNzYW9fdXN1YXJpbycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ3Blcm1pc3Nhb191c3VhcmlvLnBlcm1pc3NhbycsICdwZXJtaXNzYW8nKVxuICAgICAgLndoZXJlKCdwZXJtaXNzYW9fdXN1YXJpby51c3VhcmlvX2lkID0gOnVzZXJJZCcsIHsgdXNlcklkIH0pXG4gICAgICAuYW5kV2hlcmUoXG4gICAgICAgICcocGVybWlzc2FvX3VzdWFyaW8udmFsaWRvX2F0ZSBJUyBOVUxMIE9SIHBlcm1pc3Nhb191c3VhcmlvLnZhbGlkb19hdGUgPiA6bm93KScsXG4gICAgICAgIHsgbm93IH0sXG4gICAgICApXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyaWEgdW1hIG5vdmEgcGVybWlzc8OjbyBwYXJhIHVtIHVzdcOhcmlvLlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YSBEYWRvcyBkYSBwZXJtaXNzw6NvIGEgc2VyIGNyaWFkYVxuICAgKiBAcmV0dXJucyBBIHBlcm1pc3PDo28gY3JpYWRhXG4gICAqL1xuICBhc3luYyBjcmVhdGVVc2VyUGVybWlzc2lvbihcbiAgICBkYXRhOiBQYXJ0aWFsPFVzZXJQZXJtaXNzaW9uPixcbiAgKTogUHJvbWlzZTxVc2VyUGVybWlzc2lvbj4ge1xuICAgIGNvbnN0IHVzZXJQZXJtaXNzaW9uID0gdGhpcy5jcmVhdGUoZGF0YSk7XG4gICAgcmV0dXJuIHRoaXMuc2F2ZSh1c2VyUGVybWlzc2lvbik7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW1hIHBlcm1pc3PDo28gZXhpc3RlbnRlIGRlIHVtIHVzdcOhcmlvLlxuICAgKlxuICAgKiBAcGFyYW0gaWQgSUQgZGEgcGVybWlzc8OjbyBhIHNlciBhdHVhbGl6YWRhXG4gICAqIEBwYXJhbSBkYXRhIERhZG9zIGF0dWFsaXphZG9zIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgQSBwZXJtaXNzw6NvIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHVwZGF0ZVVzZXJQZXJtaXNzaW9uKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgZGF0YTogUGFydGlhbDxVc2VyUGVybWlzc2lvbj4sXG4gICk6IFByb21pc2U8VXNlclBlcm1pc3Npb24gfCBudWxsPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGUoaWQsIGRhdGEpO1xuICAgIHJldHVybiB0aGlzLmZpbmRPbmVCeSh7IGlkIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bWEgcGVybWlzc8OjbyBkZSB1bSB1c3XDoXJpby5cbiAgICpcbiAgICogQHBhcmFtIGlkIElEIGRhIHBlcm1pc3PDo28gYSBzZXIgcmVtb3ZpZGFcbiAgICogQHJldHVybnMgdHJ1ZSBzZSBhIHBlcm1pc3PDo28gZm9pIHJlbW92aWRhLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHJlbW92ZVVzZXJQZXJtaXNzaW9uKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRlbGV0ZShpZCk7XG4gICAgcmV0dXJuIChcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gbnVsbCAmJlxuICAgICAgcmVzdWx0LmFmZmVjdGVkICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCA+IDBcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB0b2RhcyBhcyBwZXJtaXNzw7VlcyBkZSB1bSB1c3XDoXJpby5cbiAgICpcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIGFzIHBlcm1pc3PDtWVzIGZvcmFtIHJlbW92aWRhcywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyByZW1vdmVVc2VyUGVybWlzc2lvbnNCeVVzZXJJZCh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGVsZXRlKHsgdXN1YXJpb19pZDogdXNlcklkIH0pO1xuICAgIHJldHVybiAoXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgIT09IG51bGwgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgPiAwXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdG9kYXMgYXMgcGVybWlzc8O1ZXMgZGUgdW0gdGlwbyBlc3BlY8OtZmljby5cbiAgICpcbiAgICogQHBhcmFtIHBlcm1pc3Npb25JZCBJRCBkYSBwZXJtaXNzw6NvXG4gICAqIEByZXR1cm5zIHRydWUgc2UgYXMgcGVybWlzc8O1ZXMgZm9yYW0gcmVtb3ZpZGFzLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHJlbW92ZVVzZXJQZXJtaXNzaW9uc0J5UGVybWlzc2lvbklkKFxuICAgIHBlcm1pc3Npb25JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRlbGV0ZSh7IHBlcm1pc3Nhb19pZDogcGVybWlzc2lvbklkIH0pO1xuICAgIHJldHVybiAoXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgIT09IG51bGwgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgPiAwXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdG9kYXMgYXMgcGVybWlzc8O1ZXMgZGUgdW0gZXNjb3BvIGVzcGVjw61maWNvLlxuICAgKlxuICAgKiBAcGFyYW0gc2NvcGVUeXBlIFRpcG8gZGUgZXNjb3BvXG4gICAqIEBwYXJhbSBzY29wZUlkIElEIGRvIGVzY29wb1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIGFzIHBlcm1pc3PDtWVzIGZvcmFtIHJlbW92aWRhcywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyByZW1vdmVVc2VyUGVybWlzc2lvbnNCeVNjb3BlKFxuICAgIHNjb3BlVHlwZTogVGlwb0VzY29wbyxcbiAgICBzY29wZUlkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGVsZXRlKHtcbiAgICAgIHRpcG9fZXNjb3BvOiBzY29wZVR5cGUsXG4gICAgICBlc2NvcG9faWQ6IHNjb3BlSWQsXG4gICAgfSk7XG4gICAgcmV0dXJuIChcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gbnVsbCAmJlxuICAgICAgcmVzdWx0LmFmZmVjdGVkICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCA+IDBcbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=