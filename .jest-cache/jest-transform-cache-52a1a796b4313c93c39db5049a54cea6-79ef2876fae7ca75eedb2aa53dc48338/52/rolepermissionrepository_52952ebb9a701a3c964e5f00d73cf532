b4813c308a0d9ccb83d7c10f3d66e728
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RolePermissionRepository = void 0;
const typeorm_1 = require("typeorm");
const common_1 = require("@nestjs/common");
const role_permission_entity_1 = require("../../entities/role-permission.entity");
const permission_entity_1 = require("../../entities/permission.entity");
const usuario_entity_1 = require("../../entities/usuario.entity");
/**
 * Repositório para a entidade RolePermission.
 *
 * Fornece métodos para manipulação de mapeamentos entre roles e permissões no banco de dados,
 * incluindo busca por role, permissão e operações de CRUD.
 */
let RolePermissionRepository = class RolePermissionRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(role_permission_entity_1.RolePermission, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Busca mapeamentos por ID de role com cache.
     *
     * @param roleId ID da role
     * @returns Lista de mapeamentos encontrados
     */
    async findByRoleId(roleId) {
        return this.find({
            where: { role_id: roleId },
            cache: {
                id: `role_mappings_${roleId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por múltiplos IDs de role.
     *
     * @param roleIds IDs das roles
     * @returns Lista de mapeamentos encontrados
     */
    async findByRoleIds(roleIds) {
        if (roleIds.length === 0)
            return [];
        return this.find({
            where: { role_id: (0, typeorm_1.In)(roleIds) },
            cache: {
                id: `role_mappings_multiple_${roleIds.sort().join('_')}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por ID de permissão com cache.
     *
     * @param permissionId ID da permissão
     * @returns Lista de mapeamentos encontrados
     */
    async findByPermissionId(permissionId) {
        return this.find({
            where: { permissao_id: permissionId },
            cache: {
                id: `permission_mappings_${permissionId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamento por ID de role e ID de permissão.
     *
     * @param roleId ID da role
     * @param permissionId ID da permissão
     * @returns O mapeamento encontrado ou null
     */
    async findByRoleAndPermission(roleId, permissionId) {
        return this.findOne({
            where: { role_id: roleId, permissao_id: permissionId },
            cache: {
                id: `role_permission_${roleId}_${permissionId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por ID de role com permissões relacionadas.
     *
     * @param roleId ID da role
     * @returns Lista de mapeamentos encontrados com permissões relacionadas
     */
    async findByRoleIdWithPermissions(roleId) {
        return this.createQueryBuilder('role_permissao')
            .leftJoinAndSelect('role_permissao.permissao', 'permissao')
            .where('role_permissao.role_id = :roleId', { roleId })
            .cache(`role_permissions_detailed_${roleId}`, 300000)
            .getMany();
    }
    /**
     * Cria um novo mapeamento entre role e permissão.
     *
     * @param data Dados do mapeamento a ser criado
     * @returns O mapeamento criado
     */
    async createMapping(data) {
        // Verifica se já existe o mapeamento
        if (data.role_id && data.permissao_id) {
            const existing = await this.findByRoleAndPermission(data.role_id, data.permissao_id);
            if (existing) {
                return existing;
            }
        }
        const mapping = this.create(data);
        const saved = await this.save(mapping);
        // Limpa cache relacionado
        if (data.role_id) {
            await this.clearCacheForRole(data.role_id);
        }
        if (data.permissao_id) {
            await this.clearCacheForPermission(data.permissao_id);
        }
        return saved;
    }
    /**
     * Cria múltiplos mapeamentos em batch
     *
     * @param mappings Lista de mapeamentos a serem criados
     * @returns Lista de mapeamentos criados
     */
    async createMultipleMappings(mappings) {
        if (mappings.length === 0)
            return [];
        const entities = mappings.map(mapping => this.create(mapping));
        const saved = await this.save(entities);
        // Limpa cache para todas as roles e permissões afetadas
        const uniqueRoleIds = [...new Set(mappings.map(m => m.role_id).filter(Boolean))];
        const uniquePermissionIds = [...new Set(mappings.map(m => m.permissao_id).filter(Boolean))];
        await Promise.all([
            ...uniqueRoleIds.map(roleId => this.clearCacheForRole(roleId)),
            ...uniquePermissionIds.map(permissionId => this.clearCacheForPermission(permissionId))
        ]);
        return saved;
    }
    /**
     * Remove um mapeamento entre role e permissão.
     *
     * @param id ID do mapeamento a ser removido
     * @returns true se o mapeamento foi removido, false caso contrário
     */
    async removeMapping(id) {
        // Busca o mapeamento antes de remover para limpar cache
        const mapping = await this.findOne({ where: { id } });
        const result = await this.delete(id);
        const removed = result.affected !== null && result.affected !== undefined && result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed && mapping) {
            await this.clearCacheForRole(mapping.role_id);
            await this.clearCacheForPermission(mapping.permissao_id);
        }
        return removed;
    }
    /**
     * Remove todos os mapeamentos de uma role.
     *
     * @param roleId ID da role
     * @returns true se os mapeamentos foram removidos, false caso contrário
     */
    async removeMappingsByRoleId(roleId) {
        // Busca os mapeamentos antes de remover para limpar cache das permissões
        const mappings = await this.findByRoleId(roleId);
        const result = await this.delete({ role_id: roleId });
        const removed = result.affected !== null && result.affected !== undefined && result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed) {
            await this.clearCacheForRole(roleId);
            // Limpa cache das permissões afetadas
            const uniquePermissionIds = [...new Set(mappings.map(m => m.permissao_id))];
            await Promise.all(uniquePermissionIds.map(permissionId => this.clearCacheForPermission(permissionId)));
        }
        return removed;
    }
    /**
     * Remove todos os mapeamentos de uma permissão.
     *
     * @param permissionId ID da permissão
     * @returns true se os mapeamentos foram removidos, false caso contrário
     */
    async removeMappingsByPermissionId(permissionId) {
        // Busca os mapeamentos antes de remover para limpar cache das roles
        const mappings = await this.findByPermissionId(permissionId);
        const result = await this.delete({ permissao_id: permissionId });
        const removed = result.affected !== null && result.affected !== undefined && result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed) {
            await this.clearCacheForPermission(permissionId);
            // Limpa cache das roles afetadas
            const uniqueRoleIds = [...new Set(mappings.map(m => m.role_id))];
            await Promise.all(uniqueRoleIds.map(roleId => this.clearCacheForRole(roleId)));
        }
        return removed;
    }
    /**
     * Busca permissões associadas às roles de um usuário.
     *
     * @param userId ID do usuário
     * @returns Lista de permissões associadas às roles do usuário
     */
    async findPermissionsByUserRoles(userId) {
        try {
            // Buscar o usuário com sua role
            const usuario = await this.dataSource.manager.findOne(usuario_entity_1.Usuario, {
                where: { id: userId },
                relations: ['role'],
                cache: {
                    id: `usuario_role_${userId}`,
                    milliseconds: 300000, // 5 minutos
                },
            });
            if (!usuario || !usuario.role) {
                return [];
            }
            // Buscar permissões da role do usuário
            const queryResult = await this.dataSource.manager.query(`
        SELECT DISTINCT p.*
        FROM permissao p
        INNER JOIN role_permissao rp ON p.id = rp.permissao_id
        WHERE rp.role_id = $1
        ORDER BY p.nome
      `, [usuario.role.id]);
            // Converter os resultados brutos para entidades Permission
            return queryResult.map(row => {
                const permission = new permission_entity_1.Permission();
                permission.id = row.id;
                permission.nome = row.nome;
                permission.descricao = row.descricao;
                permission.created_at = row.created_at;
                permission.updated_at = row.updated_at;
                return permission;
            });
        }
        catch (error) {
            console.error('Erro ao buscar permissões do usuário:', error);
            return [];
        }
    }
    /**
     * Busca permissões por múltiplas roles
     *
     * @param roleIds IDs das roles
     * @returns Lista de permissões únicas
     */
    async findPermissionsByRoleIds(roleIds) {
        if (roleIds.length === 0)
            return [];
        return this.createQueryBuilder('role_permissao')
            .leftJoinAndSelect('role_permissao.permissao', 'permissao')
            .where('role_permissao.role_id IN (:...roleIds)', { roleIds })
            .cache(`permissions_roles_${roleIds.sort().join('_')}`, 300000)
            .getMany()
            .then(mappings => {
            const uniquePermissions = new Map();
            mappings.forEach(mapping => {
                if (mapping.permissao && !uniquePermissions.has(mapping.permissao.id)) {
                    uniquePermissions.set(mapping.permissao.id, mapping.permissao);
                }
            });
            return Array.from(uniquePermissions.values());
        });
    }
    /**
     * Limpa cache relacionado a uma role
     */
    async clearCacheForRole(roleId) {
        try {
            // Limpa cache usando o query cache do TypeORM
            await this.dataSource.queryResultCache?.remove([`role_permissions_${roleId}`, `permissions_roles_${roleId}`]);
        }
        catch (error) {
            // Cache clearing é opcional, não deve quebrar a operação
            console.warn('Erro ao limpar cache da role:', error);
        }
    }
    /**
     * Limpa cache relacionado a uma permissão
     */
    async clearCacheForPermission(permissionId) {
        try {
            // Limpa cache usando o query cache do TypeORM
            await this.dataSource.queryResultCache?.remove([`permission_roles_${permissionId}`]);
        }
        catch (error) {
            // Cache clearing é opcional, não deve quebrar a operação
            console.warn('Erro ao limpar cache da permissão:', error);
        }
    }
};
exports.RolePermissionRepository = RolePermissionRepository;
exports.RolePermissionRepository = RolePermissionRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], RolePermissionRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xccm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLHFDQUFxRDtBQUNyRCwyQ0FBNEM7QUFDNUMsa0ZBQXVFO0FBQ3ZFLHdFQUE4RDtBQUM5RCxrRUFBd0Q7QUFFeEQ7Ozs7O0dBS0c7QUFFSSxJQUFNLHdCQUF3QixHQUE5QixNQUFNLHdCQUF5QixTQUFRLG9CQUEwQjtJQUNsRDtJQUFwQixZQUFvQixVQUFzQjtRQUN4QyxLQUFLLENBQUMsdUNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBRHRDLGVBQVUsR0FBVixVQUFVLENBQVk7SUFFMUMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFjO1FBQy9CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztZQUNmLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7WUFDMUIsS0FBSyxFQUFFO2dCQUNMLEVBQUUsRUFBRSxpQkFBaUIsTUFBTSxFQUFFO2dCQUM3QixZQUFZLEVBQUUsTUFBTSxFQUFFLFlBQVk7YUFDbkM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQWlCO1FBQ25DLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFcEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2YsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUEsWUFBRSxFQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQy9CLEtBQUssRUFBRTtnQkFDTCxFQUFFLEVBQUUsMEJBQTBCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FB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Q0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLHVCQUF1QixDQUFDLFlBQW9CO1FBQ3hELElBQUksQ0FBQztZQUNILDhDQUE4QztZQUM5QyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLENBQUMsb0JBQW9CLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2RixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLHlEQUF5RDtZQUN6RCxPQUFPLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzVELENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQWxUWSw0REFBd0I7bUNBQXhCLHdCQUF3QjtJQURwQyxJQUFBLG1CQUFVLEdBQUU7eURBRXFCLG9CQUFVLG9CQUFWLG9CQUFVO0dBRC9CLHdCQUF3QixDQWtUcEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xccm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVwb3NpdG9yeSwgRGF0YVNvdXJjZSwgSW4gfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSb2xlUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3JvbGUtcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3Blcm1pc3Npb24uZW50aXR5JztcbmltcG9ydCB7IFVzdWFyaW8gfSBmcm9tICcuLi8uLi9lbnRpdGllcy91c3VhcmlvLmVudGl0eSc7XG5cbi8qKlxuICogUmVwb3NpdMOzcmlvIHBhcmEgYSBlbnRpZGFkZSBSb2xlUGVybWlzc2lvbi5cbiAqIFxuICogRm9ybmVjZSBtw6l0b2RvcyBwYXJhIG1hbmlwdWxhw6fDo28gZGUgbWFwZWFtZW50b3MgZW50cmUgcm9sZXMgZSBwZXJtaXNzw7VlcyBubyBiYW5jbyBkZSBkYWRvcyxcbiAqIGluY2x1aW5kbyBidXNjYSBwb3Igcm9sZSwgcGVybWlzc8OjbyBlIG9wZXJhw6fDtWVzIGRlIENSVUQuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnkgZXh0ZW5kcyBSZXBvc2l0b3J5PFJvbGVQZXJtaXNzaW9uPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSkge1xuICAgIHN1cGVyKFJvbGVQZXJtaXNzaW9uLCBkYXRhU291cmNlLmNyZWF0ZUVudGl0eU1hbmFnZXIoKSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgbWFwZWFtZW50b3MgcG9yIElEIGRlIHJvbGUgY29tIGNhY2hlLlxuICAgKiBcbiAgICogQHBhcmFtIHJvbGVJZCBJRCBkYSByb2xlXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIG1hcGVhbWVudG9zIGVuY29udHJhZG9zXG4gICAqL1xuICBhc3luYyBmaW5kQnlSb2xlSWQocm9sZUlkOiBzdHJpbmcpOiBQcm9taXNlPFJvbGVQZXJtaXNzaW9uW10+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kKHsgXG4gICAgICB3aGVyZTogeyByb2xlX2lkOiByb2xlSWQgfSxcbiAgICAgIGNhY2hlOiB7XG4gICAgICAgIGlkOiBgcm9sZV9tYXBwaW5nc18ke3JvbGVJZH1gLFxuICAgICAgICBtaWxsaXNlY29uZHM6IDMwMDAwMCwgLy8gNSBtaW51dG9zXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIG1hcGVhbWVudG9zIHBvciBtw7psdGlwbG9zIElEcyBkZSByb2xlLlxuICAgKiBcbiAgICogQHBhcmFtIHJvbGVJZHMgSURzIGRhcyByb2xlc1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBtYXBlYW1lbnRvcyBlbmNvbnRyYWRvc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5Um9sZUlkcyhyb2xlSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8Um9sZVBlcm1pc3Npb25bXT4ge1xuICAgIGlmIChyb2xlSWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdO1xuICAgIFxuICAgIHJldHVybiB0aGlzLmZpbmQoeyBcbiAgICAgIHdoZXJlOiB7IHJvbGVfaWQ6IEluKHJvbGVJZHMpIH0sXG4gICAgICBjYWNoZToge1xuICAgICAgICBpZDogYHJvbGVfbWFwcGluZ3NfbXVsdGlwbGVfJHtyb2xlSWRzLnNvcnQoKS5qb2luKCdfJyl9YCxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvcyBwb3IgSUQgZGUgcGVybWlzc8OjbyBjb20gY2FjaGUuXG4gICAqIFxuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgTGlzdGEgZGUgbWFwZWFtZW50b3MgZW5jb250cmFkb3NcbiAgICovXG4gIGFzeW5jIGZpbmRCeVBlcm1pc3Npb25JZChwZXJtaXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8Um9sZVBlcm1pc3Npb25bXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbmQoeyBcbiAgICAgIHdoZXJlOiB7IHBlcm1pc3Nhb19pZDogcGVybWlzc2lvbklkIH0sXG4gICAgICBjYWNoZToge1xuICAgICAgICBpZDogYHBlcm1pc3Npb25fbWFwcGluZ3NfJHtwZXJtaXNzaW9uSWR9YCxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvIHBvciBJRCBkZSByb2xlIGUgSUQgZGUgcGVybWlzc8Ojby5cbiAgICogXG4gICAqIEBwYXJhbSByb2xlSWQgSUQgZGEgcm9sZVxuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgTyBtYXBlYW1lbnRvIGVuY29udHJhZG8gb3UgbnVsbFxuICAgKi9cbiAgYXN5bmMgZmluZEJ5Um9sZUFuZFBlcm1pc3Npb24ocm9sZUlkOiBzdHJpbmcsIHBlcm1pc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbiB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kT25lKHsgXG4gICAgICB3aGVyZTogeyByb2xlX2lkOiByb2xlSWQsIHBlcm1pc3Nhb19pZDogcGVybWlzc2lvbklkIH0sXG4gICAgICBjYWNoZToge1xuICAgICAgICBpZDogYHJvbGVfcGVybWlzc2lvbl8ke3JvbGVJZH1fJHtwZXJtaXNzaW9uSWR9YCxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvcyBwb3IgSUQgZGUgcm9sZSBjb20gcGVybWlzc8O1ZXMgcmVsYWNpb25hZGFzLlxuICAgKiBcbiAgICogQHBhcmFtIHJvbGVJZCBJRCBkYSByb2xlXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIG1hcGVhbWVudG9zIGVuY29udHJhZG9zIGNvbSBwZXJtaXNzw7VlcyByZWxhY2lvbmFkYXNcbiAgICovXG4gIGFzeW5jIGZpbmRCeVJvbGVJZFdpdGhQZXJtaXNzaW9ucyhyb2xlSWQ6IHN0cmluZyk6IFByb21pc2U8Um9sZVBlcm1pc3Npb25bXT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcigncm9sZV9wZXJtaXNzYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdyb2xlX3Blcm1pc3Nhby5wZXJtaXNzYW8nLCAncGVybWlzc2FvJylcbiAgICAgIC53aGVyZSgncm9sZV9wZXJtaXNzYW8ucm9sZV9pZCA9IDpyb2xlSWQnLCB7IHJvbGVJZCB9KVxuICAgICAgLmNhY2hlKGByb2xlX3Blcm1pc3Npb25zX2RldGFpbGVkXyR7cm9sZUlkfWAsIDMwMDAwMClcbiAgICAgIC5nZXRNYW55KCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBub3ZvIG1hcGVhbWVudG8gZW50cmUgcm9sZSBlIHBlcm1pc3PDo28uXG4gICAqIFxuICAgKiBAcGFyYW0gZGF0YSBEYWRvcyBkbyBtYXBlYW1lbnRvIGEgc2VyIGNyaWFkb1xuICAgKiBAcmV0dXJucyBPIG1hcGVhbWVudG8gY3JpYWRvXG4gICAqL1xuICBhc3luYyBjcmVhdGVNYXBwaW5nKGRhdGE6IFBhcnRpYWw8Um9sZVBlcm1pc3Npb24+KTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbj4ge1xuICAgIC8vIFZlcmlmaWNhIHNlIGrDoSBleGlzdGUgbyBtYXBlYW1lbnRvXG4gICAgaWYgKGRhdGEucm9sZV9pZCAmJiBkYXRhLnBlcm1pc3Nhb19pZCkge1xuICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmZpbmRCeVJvbGVBbmRQZXJtaXNzaW9uKGRhdGEucm9sZV9pZCwgZGF0YS5wZXJtaXNzYW9faWQpO1xuICAgICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgIHJldHVybiBleGlzdGluZztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBtYXBwaW5nID0gdGhpcy5jcmVhdGUoZGF0YSk7XG4gICAgY29uc3Qgc2F2ZWQgPSBhd2FpdCB0aGlzLnNhdmUobWFwcGluZyk7XG4gICAgXG4gICAgLy8gTGltcGEgY2FjaGUgcmVsYWNpb25hZG9cbiAgICBpZiAoZGF0YS5yb2xlX2lkKSB7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKGRhdGEucm9sZV9pZCk7XG4gICAgfVxuICAgIGlmIChkYXRhLnBlcm1pc3Nhb19pZCkge1xuICAgICAgYXdhaXQgdGhpcy5jbGVhckNhY2hlRm9yUGVybWlzc2lvbihkYXRhLnBlcm1pc3Nhb19pZCk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzYXZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIG3Dumx0aXBsb3MgbWFwZWFtZW50b3MgZW0gYmF0Y2hcbiAgICogXG4gICAqIEBwYXJhbSBtYXBwaW5ncyBMaXN0YSBkZSBtYXBlYW1lbnRvcyBhIHNlcmVtIGNyaWFkb3NcbiAgICogQHJldHVybnMgTGlzdGEgZGUgbWFwZWFtZW50b3MgY3JpYWRvc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlTXVsdGlwbGVNYXBwaW5ncyhtYXBwaW5nczogUGFydGlhbDxSb2xlUGVybWlzc2lvbj5bXSk6IFByb21pc2U8Um9sZVBlcm1pc3Npb25bXT4ge1xuICAgIGlmIChtYXBwaW5ncy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcblxuICAgIGNvbnN0IGVudGl0aWVzID0gbWFwcGluZ3MubWFwKG1hcHBpbmcgPT4gdGhpcy5jcmVhdGUobWFwcGluZykpO1xuICAgIGNvbnN0IHNhdmVkID0gYXdhaXQgdGhpcy5zYXZlKGVudGl0aWVzKTtcbiAgICBcbiAgICAvLyBMaW1wYSBjYWNoZSBwYXJhIHRvZGFzIGFzIHJvbGVzIGUgcGVybWlzc8O1ZXMgYWZldGFkYXNcbiAgICBjb25zdCB1bmlxdWVSb2xlSWRzID0gWy4uLm5ldyBTZXQobWFwcGluZ3MubWFwKG0gPT4gbS5yb2xlX2lkKS5maWx0ZXIoQm9vbGVhbikpXTtcbiAgICBjb25zdCB1bmlxdWVQZXJtaXNzaW9uSWRzID0gWy4uLm5ldyBTZXQobWFwcGluZ3MubWFwKG0gPT4gbS5wZXJtaXNzYW9faWQpLmZpbHRlcihCb29sZWFuKSldO1xuICAgIFxuICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIC4uLnVuaXF1ZVJvbGVJZHMubWFwKHJvbGVJZCA9PiB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKHJvbGVJZCEpKSxcbiAgICAgIC4uLnVuaXF1ZVBlcm1pc3Npb25JZHMubWFwKHBlcm1pc3Npb25JZCA9PiB0aGlzLmNsZWFyQ2FjaGVGb3JQZXJtaXNzaW9uKHBlcm1pc3Npb25JZCEpKVxuICAgIF0pO1xuICAgIFxuICAgIHJldHVybiBzYXZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdW0gbWFwZWFtZW50byBlbnRyZSByb2xlIGUgcGVybWlzc8Ojby5cbiAgICogXG4gICAqIEBwYXJhbSBpZCBJRCBkbyBtYXBlYW1lbnRvIGEgc2VyIHJlbW92aWRvXG4gICAqIEByZXR1cm5zIHRydWUgc2UgbyBtYXBlYW1lbnRvIGZvaSByZW1vdmlkbywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyByZW1vdmVNYXBwaW5nKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBCdXNjYSBvIG1hcGVhbWVudG8gYW50ZXMgZGUgcmVtb3ZlciBwYXJhIGxpbXBhciBjYWNoZVxuICAgIGNvbnN0IG1hcHBpbmcgPSBhd2FpdCB0aGlzLmZpbmRPbmUoeyB3aGVyZTogeyBpZCB9IH0pO1xuICAgIFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGVsZXRlKGlkKTtcbiAgICBjb25zdCByZW1vdmVkID0gcmVzdWx0LmFmZmVjdGVkICE9PSBudWxsICYmIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdC5hZmZlY3RlZCA+IDA7XG4gICAgXG4gICAgLy8gTGltcGEgY2FjaGUgc2UgcmVtb3ZpZG8gY29tIHN1Y2Vzc29cbiAgICBpZiAocmVtb3ZlZCAmJiBtYXBwaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKG1hcHBpbmcucm9sZV9pZCk7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JQZXJtaXNzaW9uKG1hcHBpbmcucGVybWlzc2FvX2lkKTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHJlbW92ZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHRvZG9zIG9zIG1hcGVhbWVudG9zIGRlIHVtYSByb2xlLlxuICAgKiBcbiAgICogQHBhcmFtIHJvbGVJZCBJRCBkYSByb2xlXG4gICAqIEByZXR1cm5zIHRydWUgc2Ugb3MgbWFwZWFtZW50b3MgZm9yYW0gcmVtb3ZpZG9zLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHJlbW92ZU1hcHBpbmdzQnlSb2xlSWQocm9sZUlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBCdXNjYSBvcyBtYXBlYW1lbnRvcyBhbnRlcyBkZSByZW1vdmVyIHBhcmEgbGltcGFyIGNhY2hlIGRhcyBwZXJtaXNzw7Vlc1xuICAgIGNvbnN0IG1hcHBpbmdzID0gYXdhaXQgdGhpcy5maW5kQnlSb2xlSWQocm9sZUlkKTtcbiAgICBcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRlbGV0ZSh7IHJvbGVfaWQ6IHJvbGVJZCB9KTtcbiAgICBjb25zdCByZW1vdmVkID0gcmVzdWx0LmFmZmVjdGVkICE9PSBudWxsICYmIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdC5hZmZlY3RlZCA+IDA7XG4gICAgXG4gICAgLy8gTGltcGEgY2FjaGUgc2UgcmVtb3ZpZG8gY29tIHN1Y2Vzc29cbiAgICBpZiAocmVtb3ZlZCkge1xuICAgICAgYXdhaXQgdGhpcy5jbGVhckNhY2hlRm9yUm9sZShyb2xlSWQpO1xuICAgICAgLy8gTGltcGEgY2FjaGUgZGFzIHBlcm1pc3PDtWVzIGFmZXRhZGFzXG4gICAgICBjb25zdCB1bmlxdWVQZXJtaXNzaW9uSWRzID0gWy4uLm5ldyBTZXQobWFwcGluZ3MubWFwKG0gPT4gbS5wZXJtaXNzYW9faWQpKV07XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh1bmlxdWVQZXJtaXNzaW9uSWRzLm1hcChwZXJtaXNzaW9uSWQgPT4gdGhpcy5jbGVhckNhY2hlRm9yUGVybWlzc2lvbihwZXJtaXNzaW9uSWQpKSk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiByZW1vdmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB0b2RvcyBvcyBtYXBlYW1lbnRvcyBkZSB1bWEgcGVybWlzc8Ojby5cbiAgICogXG4gICAqIEBwYXJhbSBwZXJtaXNzaW9uSWQgSUQgZGEgcGVybWlzc8Ojb1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIG9zIG1hcGVhbWVudG9zIGZvcmFtIHJlbW92aWRvcywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyByZW1vdmVNYXBwaW5nc0J5UGVybWlzc2lvbklkKHBlcm1pc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQnVzY2Egb3MgbWFwZWFtZW50b3MgYW50ZXMgZGUgcmVtb3ZlciBwYXJhIGxpbXBhciBjYWNoZSBkYXMgcm9sZXNcbiAgICBjb25zdCBtYXBwaW5ncyA9IGF3YWl0IHRoaXMuZmluZEJ5UGVybWlzc2lvbklkKHBlcm1pc3Npb25JZCk7XG4gICAgXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kZWxldGUoeyBwZXJtaXNzYW9faWQ6IHBlcm1pc3Npb25JZCB9KTtcbiAgICBjb25zdCByZW1vdmVkID0gcmVzdWx0LmFmZmVjdGVkICE9PSBudWxsICYmIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdC5hZmZlY3RlZCA+IDA7XG4gICAgXG4gICAgLy8gTGltcGEgY2FjaGUgc2UgcmVtb3ZpZG8gY29tIHN1Y2Vzc29cbiAgICBpZiAocmVtb3ZlZCkge1xuICAgICAgYXdhaXQgdGhpcy5jbGVhckNhY2hlRm9yUGVybWlzc2lvbihwZXJtaXNzaW9uSWQpO1xuICAgICAgLy8gTGltcGEgY2FjaGUgZGFzIHJvbGVzIGFmZXRhZGFzXG4gICAgICBjb25zdCB1bmlxdWVSb2xlSWRzID0gWy4uLm5ldyBTZXQobWFwcGluZ3MubWFwKG0gPT4gbS5yb2xlX2lkKSldO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodW5pcXVlUm9sZUlkcy5tYXAocm9sZUlkID0+IHRoaXMuY2xlYXJDYWNoZUZvclJvbGUocm9sZUlkKSkpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcmVtb3ZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBwZXJtaXNzw7VlcyBhc3NvY2lhZGFzIMOgcyByb2xlcyBkZSB1bSB1c3XDoXJpby5cbiAgICogXG4gICAqIEBwYXJhbSB1c2VySWQgSUQgZG8gdXN1w6FyaW9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgcGVybWlzc8O1ZXMgYXNzb2NpYWRhcyDDoHMgcm9sZXMgZG8gdXN1w6FyaW9cbiAgICovXG4gIGFzeW5jIGZpbmRQZXJtaXNzaW9uc0J5VXNlclJvbGVzKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxQZXJtaXNzaW9uW10+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQnVzY2FyIG8gdXN1w6FyaW8gY29tIHN1YSByb2xlXG4gICAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLm1hbmFnZXIuZmluZE9uZShVc3VhcmlvLCB7XG4gICAgICAgIHdoZXJlOiB7IGlkOiB1c2VySWQgfSxcbiAgICAgICAgcmVsYXRpb25zOiBbJ3JvbGUnXSxcbiAgICAgICAgY2FjaGU6IHtcbiAgICAgICAgICBpZDogYHVzdWFyaW9fcm9sZV8ke3VzZXJJZH1gLFxuICAgICAgICAgIG1pbGxpc2Vjb25kczogMzAwMDAwLCAvLyA1IG1pbnV0b3NcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXVzdWFyaW8gfHwgIXVzdWFyaW8ucm9sZSkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG5cbiAgICAgIC8vIEJ1c2NhciBwZXJtaXNzw7VlcyBkYSByb2xlIGRvIHVzdcOhcmlvXG4gICAgICBjb25zdCBxdWVyeVJlc3VsdCA9IGF3YWl0IHRoaXMuZGF0YVNvdXJjZS5tYW5hZ2VyLnF1ZXJ5KGBcbiAgICAgICAgU0VMRUNUIERJU1RJTkNUIHAuKlxuICAgICAgICBGUk9NIHBlcm1pc3NhbyBwXG4gICAgICAgIElOTkVSIEpPSU4gcm9sZV9wZXJtaXNzYW8gcnAgT04gcC5pZCA9IHJwLnBlcm1pc3Nhb19pZFxuICAgICAgICBXSEVSRSBycC5yb2xlX2lkID0gJDFcbiAgICAgICAgT1JERVIgQlkgcC5ub21lXG4gICAgICBgLCBbdXN1YXJpby5yb2xlLmlkXSk7XG4gICAgICBcbiAgICAgIC8vIENvbnZlcnRlciBvcyByZXN1bHRhZG9zIGJydXRvcyBwYXJhIGVudGlkYWRlcyBQZXJtaXNzaW9uXG4gICAgICByZXR1cm4gcXVlcnlSZXN1bHQubWFwKHJvdyA9PiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb24gPSBuZXcgUGVybWlzc2lvbigpO1xuICAgICAgICBwZXJtaXNzaW9uLmlkID0gcm93LmlkO1xuICAgICAgICBwZXJtaXNzaW9uLm5vbWUgPSByb3cubm9tZTtcbiAgICAgICAgcGVybWlzc2lvbi5kZXNjcmljYW8gPSByb3cuZGVzY3JpY2FvO1xuICAgICAgICBwZXJtaXNzaW9uLmNyZWF0ZWRfYXQgPSByb3cuY3JlYXRlZF9hdDtcbiAgICAgICAgcGVybWlzc2lvbi51cGRhdGVkX2F0ID0gcm93LnVwZGF0ZWRfYXQ7XG4gICAgICAgIHJldHVybiBwZXJtaXNzaW9uO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gYnVzY2FyIHBlcm1pc3PDtWVzIGRvIHVzdcOhcmlvOicsIGVycm9yKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIG3Dumx0aXBsYXMgcm9sZXNcbiAgICogXG4gICAqIEBwYXJhbSByb2xlSWRzIElEcyBkYXMgcm9sZXNcbiAgICogQHJldHVybnMgTGlzdGEgZGUgcGVybWlzc8O1ZXMgw7puaWNhc1xuICAgKi9cbiAgYXN5bmMgZmluZFBlcm1pc3Npb25zQnlSb2xlSWRzKHJvbGVJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxQZXJtaXNzaW9uW10+IHtcbiAgICBpZiAocm9sZUlkcy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcblxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcigncm9sZV9wZXJtaXNzYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdyb2xlX3Blcm1pc3Nhby5wZXJtaXNzYW8nLCAncGVybWlzc2FvJylcbiAgICAgIC53aGVyZSgncm9sZV9wZXJtaXNzYW8ucm9sZV9pZCBJTiAoOi4uLnJvbGVJZHMpJywgeyByb2xlSWRzIH0pXG4gICAgICAuY2FjaGUoYHBlcm1pc3Npb25zX3JvbGVzXyR7cm9sZUlkcy5zb3J0KCkuam9pbignXycpfWAsIDMwMDAwMClcbiAgICAgIC5nZXRNYW55KClcbiAgICAgIC50aGVuKG1hcHBpbmdzID0+IHtcbiAgICAgICAgY29uc3QgdW5pcXVlUGVybWlzc2lvbnMgPSBuZXcgTWFwPHN0cmluZywgUGVybWlzc2lvbj4oKTtcbiAgICAgICAgbWFwcGluZ3MuZm9yRWFjaChtYXBwaW5nID0+IHtcbiAgICAgICAgICBpZiAobWFwcGluZy5wZXJtaXNzYW8gJiYgIXVuaXF1ZVBlcm1pc3Npb25zLmhhcyhtYXBwaW5nLnBlcm1pc3Nhby5pZCkpIHtcbiAgICAgICAgICAgIHVuaXF1ZVBlcm1pc3Npb25zLnNldChtYXBwaW5nLnBlcm1pc3Nhby5pZCwgbWFwcGluZy5wZXJtaXNzYW8pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHVuaXF1ZVBlcm1pc3Npb25zLnZhbHVlcygpKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIExpbXBhIGNhY2hlIHJlbGFjaW9uYWRvIGEgdW1hIHJvbGVcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgY2xlYXJDYWNoZUZvclJvbGUocm9sZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gTGltcGEgY2FjaGUgdXNhbmRvIG8gcXVlcnkgY2FjaGUgZG8gVHlwZU9STVxuICAgICAgYXdhaXQgdGhpcy5kYXRhU291cmNlLnF1ZXJ5UmVzdWx0Q2FjaGU/LnJlbW92ZShbYHJvbGVfcGVybWlzc2lvbnNfJHtyb2xlSWR9YCwgYHBlcm1pc3Npb25zX3JvbGVzXyR7cm9sZUlkfWBdKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gQ2FjaGUgY2xlYXJpbmcgw6kgb3BjaW9uYWwsIG7Do28gZGV2ZSBxdWVicmFyIGEgb3BlcmHDp8Ojb1xuICAgICAgY29uc29sZS53YXJuKCdFcnJvIGFvIGxpbXBhciBjYWNoZSBkYSByb2xlOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGltcGEgY2FjaGUgcmVsYWNpb25hZG8gYSB1bWEgcGVybWlzc8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjbGVhckNhY2hlRm9yUGVybWlzc2lvbihwZXJtaXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBMaW1wYSBjYWNoZSB1c2FuZG8gbyBxdWVyeSBjYWNoZSBkbyBUeXBlT1JNXG4gICAgICBhd2FpdCB0aGlzLmRhdGFTb3VyY2UucXVlcnlSZXN1bHRDYWNoZT8ucmVtb3ZlKFtgcGVybWlzc2lvbl9yb2xlc18ke3Blcm1pc3Npb25JZH1gXSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIENhY2hlIGNsZWFyaW5nIMOpIG9wY2lvbmFsLCBuw6NvIGRldmUgcXVlYnJhciBhIG9wZXJhw6fDo29cbiAgICAgIGNvbnNvbGUud2FybignRXJybyBhbyBsaW1wYXIgY2FjaGUgZGEgcGVybWlzc8OjbzonLCBlcnJvcik7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=