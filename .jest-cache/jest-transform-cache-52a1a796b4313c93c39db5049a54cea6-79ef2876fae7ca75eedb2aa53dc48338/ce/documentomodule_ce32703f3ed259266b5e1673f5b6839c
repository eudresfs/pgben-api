092883b16320842f1b0455c271f9e520
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentoModule = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const platform_express_1 = require("@nestjs/platform-express");
const documento_controller_1 = require("./controllers/documento.controller");
const documento_service_1 = require("./services/documento.service");
const storage_provider_factory_1 = require("./factories/storage-provider.factory");
const local_storage_adapter_1 = require("./adapters/local-storage.adapter");
const s3_storage_adapter_1 = require("./adapters/s3-storage.adapter");
const mime_validation_service_1 = require("./services/mime-validation.service");
const input_sanitizer_validator_1 = require("./validators/input-sanitizer.validator");
const multer_1 = require("multer");
const config_1 = require("@nestjs/config");
const entities_1 = require("../../entities");
const auth_module_1 = require("../../auth/auth.module");
const unified_logger_module_1 = require("../../shared/logging/unified-logger.module");
const unified_logger_service_1 = require("../../shared/logging/unified-logger.service");
const shared_module_1 = require("../../shared/shared.module");
/**
 * Módulo de Documentos
 *
 * Responsável por gerenciar os documentos anexados às solicitações de benefícios,
 * incluindo upload, verificação e remoção.
 */
let DocumentoModule = class DocumentoModule {
};
exports.DocumentoModule = DocumentoModule;
exports.DocumentoModule = DocumentoModule = __decorate([
    (0, common_1.Module)({
        imports: [
            typeorm_1.TypeOrmModule.forFeature([entities_1.Documento]),
            platform_express_1.MulterModule.registerAsync({
                imports: [config_1.ConfigModule],
                useFactory: async (configService) => ({
                    storage: (0, multer_1.memoryStorage)(),
                    fileFilter: (req, file, cb) => {
                        const allowedMimes = [
                            'application/pdf',
                            'image/jpeg',
                            'image/png',
                            'image/gif',
                            'application/msword',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                            'application/vnd.ms-excel',
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        ];
                        if (allowedMimes.includes(file.mimetype)) {
                            cb(null, true);
                        }
                        else {
                            cb(new Error('Tipo de arquivo não permitido'), false);
                        }
                    },
                    limits: {
                        fileSize: configService.get('MAX_FILE_SIZE') || 10 * 1024 * 1024, // 10MB
                    },
                }),
                inject: [config_1.ConfigService],
            }),
            config_1.ConfigModule,
            auth_module_1.AuthModule,
            unified_logger_module_1.UnifiedLoggerModule,
            shared_module_1.SharedModule,
        ],
        controllers: [documento_controller_1.DocumentoController],
        providers: [
            documento_service_1.DocumentoService,
            mime_validation_service_1.MimeValidationService,
            storage_provider_factory_1.StorageProviderFactory,
            local_storage_adapter_1.LocalStorageAdapter,
            {
                provide: s3_storage_adapter_1.S3StorageAdapter,
                useFactory: (configService, unifiedLoggerService) => {
                    // Verifica se todas as configurações AWS estão presentes
                    const bucketName = configService.get('AWS_S3_BUCKET');
                    const region = configService.get('AWS_REGION');
                    const accessKeyId = configService.get('AWS_ACCESS_KEY_ID');
                    const secretAccessKey = configService.get('AWS_SECRET_ACCESS_KEY');
                    if (!bucketName || !region || !accessKeyId || !secretAccessKey) {
                        // Retorna null quando AWS não está configurado completamente
                        // Isso evita erros de injeção de dependência
                        return null;
                    }
                    return new s3_storage_adapter_1.S3StorageAdapter(configService, unifiedLoggerService);
                },
                inject: [config_1.ConfigService, unified_logger_service_1.UnifiedLoggerService],
            },
            input_sanitizer_validator_1.InputSanitizerValidator,
        ],
        exports: [documento_service_1.DocumentoService, storage_provider_factory_1.StorageProviderFactory],
    })
], DocumentoModule);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGRvY3VtZW50b1xcZG9jdW1lbnRvLm1vZHVsZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBd0M7QUFDeEMsNkNBQWdEO0FBQ2hELCtEQUF3RDtBQUN4RCw2RUFBeUU7QUFDekUsb0VBQWdFO0FBQ2hFLG1GQUE4RTtBQUM5RSw0RUFBdUU7QUFDdkUsc0VBQWlFO0FBQ2pFLGdGQUEyRTtBQUMzRSxzRkFBaUY7QUFFakYsbUNBQW9EO0FBR3BELDJDQUE2RDtBQUM3RCw2Q0FBMkM7QUFDM0Msd0RBQW9EO0FBQ3BELHNGQUFpRjtBQUNqRix3RkFBbUY7QUFDbkYsOERBQTBEO0FBRTFEOzs7OztHQUtHO0FBdUVJLElBQU0sZUFBZSxHQUFyQixNQUFNLGVBQWU7Q0FBRyxDQUFBO0FBQWxCLDBDQUFlOzBCQUFmLGVBQWU7SUF0RTNCLElBQUEsZUFBTSxFQUFDO1FBQ04sT0FBTyxFQUFFO1lBQ1AsdUJBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxvQkFBUyxDQUFDLENBQUM7WUFDckMsK0JBQVksQ0FBQyxhQUFhLENBQUM7Z0JBQ3pCLE9BQU8sRUFBRSxDQUFDLHFCQUFZLENBQUM7Z0JBQ3ZCLFVBQVUsRUFBRSxLQUFLLEVBQUUsYUFBNEIsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDbkQsT0FBTyxFQUFFLElBQUEsc0JBQWEsR0FBRTtvQkFDeEIsVUFBVSxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRTt3QkFDNUIsTUFBTSxZQUFZLEdBQUc7NEJBQ25CLGlCQUFpQjs0QkFDakIsWUFBWTs0QkFDWixXQUFXOzRCQUNYLFdBQVc7NEJBQ1gsb0JBQW9COzRCQUNwQix5RUFBeUU7NEJBQ3pFLDBCQUEwQjs0QkFDMUIsbUVBQW1FO3lCQUNwRSxDQUFDO3dCQUVGLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQzs0QkFDekMsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDakIsQ0FBQzs2QkFBTSxDQUFDOzRCQUNOLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO3dCQUN4RCxDQUFDO29CQUNILENBQUM7b0JBQ0QsTUFBTSxFQUFFO3dCQUNOLFFBQVEsRUFDTixhQUFhLENBQUMsR0FBRyxDQUFTLGVBQWUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxFQUFFLE9BQU87cUJBQzFFO2lCQUNGLENBQUM7Z0JBQ0YsTUFBTSxFQUFFLENBQUMsc0JBQWEsQ0FBQzthQUN4QixDQUFDO1lBQ0YscUJBQVk7WUFDWix3QkFBVTtZQUNWLDJDQUFtQjtZQUNuQiw0QkFBWTtTQUNiO1FBQ0QsV0FBVyxFQUFFLENBQUMsMENBQW1CLENBQUM7UUFDbEMsU0FBUyxFQUFFO1lBQ1Qsb0NBQWdCO1lBQ2hCLCtDQUFxQjtZQUNyQixpREFBc0I7WUFDdEIsMkNBQW1CO1lBQ25CO2dCQUNFLE9BQU8sRUFBRSxxQ0FBZ0I7Z0JBQ3pCLFVBQVUsRUFBRSxDQUNWLGFBQTRCLEVBQzVCLG9CQUEwQyxFQUMxQyxFQUFFO29CQUNGLHlEQUF5RDtvQkFDekQsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUMsQ0FBQztvQkFDOUQsTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBUyxZQUFZLENBQUMsQ0FBQztvQkFDdkQsTUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBUyxtQkFBbUIsQ0FBQyxDQUFDO29CQUNuRSxNQUFNLGVBQWUsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUN2Qyx1QkFBdUIsQ0FDeEIsQ0FBQztvQkFFRixJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7d0JBQy9ELDZEQUE2RDt3QkFDN0QsNkNBQTZDO3dCQUM3QyxPQUFPLElBQUksQ0FBQztvQkFDZCxDQUFDO29CQUNELE9BQU8sSUFBSSxxQ0FBZ0IsQ0FBQyxhQUFhLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztnQkFDbkUsQ0FBQztnQkFDRCxNQUFNLEVBQUUsQ0FBQyxzQkFBYSxFQUFFLDZDQUFvQixDQUFDO2FBQzlDO1lBQ0QsbURBQXVCO1NBQ3hCO1FBQ0QsT0FBTyxFQUFFLENBQUMsb0NBQWdCLEVBQUUsaURBQXNCLENBQUM7S0FDcEQsQ0FBQztHQUNXLGVBQWUsQ0FBRyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcZG9jdW1lbnRvXFxkb2N1bWVudG8ubW9kdWxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFR5cGVPcm1Nb2R1bGUgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgTXVsdGVyTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy9wbGF0Zm9ybS1leHByZXNzJztcbmltcG9ydCB7IERvY3VtZW50b0NvbnRyb2xsZXIgfSBmcm9tICcuL2NvbnRyb2xsZXJzL2RvY3VtZW50by5jb250cm9sbGVyJztcbmltcG9ydCB7IERvY3VtZW50b1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2RvY3VtZW50by5zZXJ2aWNlJztcbmltcG9ydCB7IFN0b3JhZ2VQcm92aWRlckZhY3RvcnkgfSBmcm9tICcuL2ZhY3Rvcmllcy9zdG9yYWdlLXByb3ZpZGVyLmZhY3RvcnknO1xuaW1wb3J0IHsgTG9jYWxTdG9yYWdlQWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcnMvbG9jYWwtc3RvcmFnZS5hZGFwdGVyJztcbmltcG9ydCB7IFMzU3RvcmFnZUFkYXB0ZXIgfSBmcm9tICcuL2FkYXB0ZXJzL3MzLXN0b3JhZ2UuYWRhcHRlcic7XG5pbXBvcnQgeyBNaW1lVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL21pbWUtdmFsaWRhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IElucHV0U2FuaXRpemVyVmFsaWRhdG9yIH0gZnJvbSAnLi92YWxpZGF0b3JzL2lucHV0LXNhbml0aXplci52YWxpZGF0b3InO1xuaW1wb3J0IHsgVE9ET1NfTUlNRV9UWVBFU19QRVJNSVRJRE9TIH0gZnJvbSAnLi9jb25maWcvZG9jdW1lbnRvLmNvbmZpZyc7XG5pbXBvcnQgeyBkaXNrU3RvcmFnZSwgbWVtb3J5U3RvcmFnZSB9IGZyb20gJ211bHRlcic7XG5pbXBvcnQgeyBleHRuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSwgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IERvY3VtZW50byB9IGZyb20gJy4uLy4uL2VudGl0aWVzJztcbmltcG9ydCB7IEF1dGhNb2R1bGUgfSBmcm9tICcuLi8uLi9hdXRoL2F1dGgubW9kdWxlJztcbmltcG9ydCB7IFVuaWZpZWRMb2dnZXJNb2R1bGUgfSBmcm9tICcuLi8uLi9zaGFyZWQvbG9nZ2luZy91bmlmaWVkLWxvZ2dlci5tb2R1bGUnO1xuaW1wb3J0IHsgVW5pZmllZExvZ2dlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zaGFyZWQvbG9nZ2luZy91bmlmaWVkLWxvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IFNoYXJlZE1vZHVsZSB9IGZyb20gJy4uLy4uL3NoYXJlZC9zaGFyZWQubW9kdWxlJztcblxuLyoqXG4gKiBNw7NkdWxvIGRlIERvY3VtZW50b3NcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcG9yIGdlcmVuY2lhciBvcyBkb2N1bWVudG9zIGFuZXhhZG9zIMOgcyBzb2xpY2l0YcOnw7VlcyBkZSBiZW5lZsOtY2lvcyxcbiAqIGluY2x1aW5kbyB1cGxvYWQsIHZlcmlmaWNhw6fDo28gZSByZW1vw6fDo28uXG4gKi9cbkBNb2R1bGUoe1xuICBpbXBvcnRzOiBbXG4gICAgVHlwZU9ybU1vZHVsZS5mb3JGZWF0dXJlKFtEb2N1bWVudG9dKSxcbiAgICBNdWx0ZXJNb2R1bGUucmVnaXN0ZXJBc3luYyh7XG4gICAgICBpbXBvcnRzOiBbQ29uZmlnTW9kdWxlXSxcbiAgICAgIHVzZUZhY3Rvcnk6IGFzeW5jIChjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlKSA9PiAoe1xuICAgICAgICBzdG9yYWdlOiBtZW1vcnlTdG9yYWdlKCksXG4gICAgICAgIGZpbGVGaWx0ZXI6IChyZXEsIGZpbGUsIGNiKSA9PiB7XG4gICAgICAgICAgY29uc3QgYWxsb3dlZE1pbWVzID0gW1xuICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICAgICAgICAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgICAnaW1hZ2UvcG5nJyxcbiAgICAgICAgICAgICdpbWFnZS9naWYnLFxuICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL21zd29yZCcsXG4gICAgICAgICAgICAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LndvcmRwcm9jZXNzaW5nbWwuZG9jdW1lbnQnLFxuICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5tcy1leGNlbCcsXG4gICAgICAgICAgICAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQnLFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICBpZiAoYWxsb3dlZE1pbWVzLmluY2x1ZGVzKGZpbGUubWltZXR5cGUpKSB7XG4gICAgICAgICAgICBjYihudWxsLCB0cnVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2IobmV3IEVycm9yKCdUaXBvIGRlIGFycXVpdm8gbsOjbyBwZXJtaXRpZG8nKSwgZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgbGltaXRzOiB7XG4gICAgICAgICAgZmlsZVNpemU6XG4gICAgICAgICAgICBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdNQVhfRklMRV9TSVpFJykgfHwgMTAgKiAxMDI0ICogMTAyNCwgLy8gMTBNQlxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBpbmplY3Q6IFtDb25maWdTZXJ2aWNlXSxcbiAgICB9KSxcbiAgICBDb25maWdNb2R1bGUsXG4gICAgQXV0aE1vZHVsZSxcbiAgICBVbmlmaWVkTG9nZ2VyTW9kdWxlLFxuICAgIFNoYXJlZE1vZHVsZSxcbiAgXSxcbiAgY29udHJvbGxlcnM6IFtEb2N1bWVudG9Db250cm9sbGVyXSxcbiAgcHJvdmlkZXJzOiBbXG4gICAgRG9jdW1lbnRvU2VydmljZSxcbiAgICBNaW1lVmFsaWRhdGlvblNlcnZpY2UsXG4gICAgU3RvcmFnZVByb3ZpZGVyRmFjdG9yeSxcbiAgICBMb2NhbFN0b3JhZ2VBZGFwdGVyLFxuICAgIHtcbiAgICAgIHByb3ZpZGU6IFMzU3RvcmFnZUFkYXB0ZXIsXG4gICAgICB1c2VGYWN0b3J5OiAoXG4gICAgICAgIGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4gICAgICAgIHVuaWZpZWRMb2dnZXJTZXJ2aWNlOiBVbmlmaWVkTG9nZ2VyU2VydmljZSxcbiAgICAgICkgPT4ge1xuICAgICAgICAvLyBWZXJpZmljYSBzZSB0b2RhcyBhcyBjb25maWd1cmHDp8O1ZXMgQVdTIGVzdMOjbyBwcmVzZW50ZXNcbiAgICAgICAgY29uc3QgYnVja2V0TmFtZSA9IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0FXU19TM19CVUNLRVQnKTtcbiAgICAgICAgY29uc3QgcmVnaW9uID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQVdTX1JFR0lPTicpO1xuICAgICAgICBjb25zdCBhY2Nlc3NLZXlJZCA9IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0FXU19BQ0NFU1NfS0VZX0lEJyk7XG4gICAgICAgIGNvbnN0IHNlY3JldEFjY2Vzc0tleSA9IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXG4gICAgICAgICAgJ0FXU19TRUNSRVRfQUNDRVNTX0tFWScsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKCFidWNrZXROYW1lIHx8ICFyZWdpb24gfHwgIWFjY2Vzc0tleUlkIHx8ICFzZWNyZXRBY2Nlc3NLZXkpIHtcbiAgICAgICAgICAvLyBSZXRvcm5hIG51bGwgcXVhbmRvIEFXUyBuw6NvIGVzdMOhIGNvbmZpZ3VyYWRvIGNvbXBsZXRhbWVudGVcbiAgICAgICAgICAvLyBJc3NvIGV2aXRhIGVycm9zIGRlIGluamXDp8OjbyBkZSBkZXBlbmTDqm5jaWFcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFMzU3RvcmFnZUFkYXB0ZXIoY29uZmlnU2VydmljZSwgdW5pZmllZExvZ2dlclNlcnZpY2UpO1xuICAgICAgfSxcbiAgICAgIGluamVjdDogW0NvbmZpZ1NlcnZpY2UsIFVuaWZpZWRMb2dnZXJTZXJ2aWNlXSxcbiAgICB9LFxuICAgIElucHV0U2FuaXRpemVyVmFsaWRhdG9yLFxuICBdLFxuICBleHBvcnRzOiBbRG9jdW1lbnRvU2VydmljZSwgU3RvcmFnZVByb3ZpZGVyRmFjdG9yeV0sXG59KVxuZXhwb3J0IGNsYXNzIERvY3VtZW50b01vZHVsZSB7fVxuIl0sInZlcnNpb24iOjN9