dbcc36df2d56bdd3d6d655811e68574e
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var PasswordResetService_1;
var _a, _b, _c, _d, _e, _f, _g, _h, _j;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PasswordResetService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const config_1 = require("@nestjs/config");
const schedule_1 = require("@nestjs/schedule");
const jwt_1 = require("@nestjs/jwt");
const crypto = __importStar(require("crypto"));
const bcrypt = __importStar(require("bcrypt"));
const password_reset_token_entity_1 = require("../../entities/password-reset-token.entity");
const usuario_repository_1 = require("../../modules/usuario/repositories/usuario.repository");
const email_service_1 = require("../../common/services/email.service");
const audit_service_1 = require("../../audit/services/audit.service");
const audit_log_entity_1 = require("../../entities/audit-log.entity");
let PasswordResetService = PasswordResetService_1 = class PasswordResetService {
    passwordResetTokenRepository;
    usuarioRepository;
    emailService;
    auditService;
    configService;
    jwtService;
    dataSource;
    logger = new common_1.Logger(PasswordResetService_1.name);
    tokenExpirationMinutes;
    maxAttemptsPerToken;
    maxRequestsPerHour;
    constructor(passwordResetTokenRepository, usuarioRepository, emailService, auditService, configService, jwtService, dataSource) {
        this.passwordResetTokenRepository = passwordResetTokenRepository;
        this.usuarioRepository = usuarioRepository;
        this.emailService = emailService;
        this.auditService = auditService;
        this.configService = configService;
        this.jwtService = jwtService;
        this.dataSource = dataSource;
        this.tokenExpirationMinutes = this.configService.get('PASSWORD_RESET_EXPIRATION_MINUTES', 15);
        this.maxAttemptsPerToken = this.configService.get('PASSWORD_RESET_MAX_ATTEMPTS', 3);
        this.maxRequestsPerHour = this.configService.get('PASSWORD_RESET_MAX_REQUESTS_PER_HOUR', 5);
        // Iniciar limpeza automática de tokens expirados
        this.startTokenCleanup();
    }
    /**
     * Solicita recuperação de senha
     */
    async requestPasswordReset(requestDto, clientInfo) {
        const { email } = requestDto;
        try {
            // Buscar usuário pelo email
            const usuario = await this.usuarioRepository.findByEmail(email.toLowerCase());
            // Por segurança, sempre retornamos sucesso mesmo se o email não existir
            if (!usuario) {
                this.logger.warn(`Tentativa de reset para email inexistente: ${email}`, {
                    ip: clientInfo.ip,
                    userAgent: clientInfo.userAgent,
                });
                await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Tentativa de reset para email inexistente: ${email}`, undefined, audit_log_entity_1.AuditSeverity.MEDIUM, { email }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
                return {
                    message: 'Se o email existir, você receberá instruções para redefinir sua senha.',
                    expiresInMinutes: this.tokenExpirationMinutes,
                };
            }
            // Verificar rate limiting
            await this.checkRateLimit(usuario.id, clientInfo.ip);
            // Invalidar tokens anteriores do usuário
            await this.invalidateUserTokens(usuario.id, 'new_request');
            // Gerar novo token
            const token = this.generateSecureToken();
            const tokenHash = await this.hashToken(token);
            const expiresAt = new Date(Date.now() + this.tokenExpirationMinutes * 60 * 1000);
            // Salvar token no banco
            const passwordResetToken = this.passwordResetTokenRepository.create({
                token: token.substring(0, 8) + '...', // Armazenar apenas parte do token para auditoria
                token_hash: tokenHash,
                usuario_id: usuario.id,
                expires_at: expiresAt,
                client_ip: clientInfo.ip,
                user_agent: clientInfo.userAgent,
                metadata: {
                    origin: clientInfo.origin,
                    referer: clientInfo.referer,
                },
            });
            await this.passwordResetTokenRepository.save(passwordResetToken);
            // Enviar email
            await this.sendPasswordResetEmail(usuario, token, expiresAt);
            // Log de auditoria
            await this.auditService.logUserAction(usuario.id, audit_log_entity_1.AuditAction.PASSWORD_RESET, 'password_reset_token', passwordResetToken.id, 'Solicitação de recuperação de senha', { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            this.logger.log(`Token de recuperação gerado para usuário ${usuario.id}`);
            return {
                message: 'Se o email existir, você receberá instruções para redefinir sua senha.',
                expiresInMinutes: this.tokenExpirationMinutes,
            };
        }
        catch (error) {
            this.logger.error('Erro ao solicitar recuperação de senha', error.stack);
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Erro ao processar solicitação de reset: ${error.message}`, undefined, audit_log_entity_1.AuditSeverity.HIGH, { email, error: error.message }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            throw new common_1.InternalServerErrorException('Erro interno. Tente novamente mais tarde.');
        }
    }
    /**
     * Redefine a senha usando o token
     */
    async resetPassword(resetDto, clientInfo) {
        const { token, newPassword, confirmPassword } = resetDto;
        // Validar senhas
        if (newPassword !== confirmPassword) {
            throw new common_1.BadRequestException('As senhas não coincidem');
        }
        if (newPassword.length < 8) {
            throw new common_1.BadRequestException('A senha deve ter pelo menos 8 caracteres');
        }
        try {
            // Buscar token válido
            const resetToken = await this.findValidToken(token);
            if (!resetToken) {
                await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, 'Tentativa de uso de token inválido para reset de senha', undefined, audit_log_entity_1.AuditSeverity.HIGH, { tokenPrefix: token.substring(0, 8) }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
                throw new common_1.UnauthorizedException('Token inválido ou expirado');
            }
            // Carregar usuário pelo ID
            const usuario = await this.usuarioRepository.findById(resetToken.usuario_id);
            if (!usuario) {
                throw new common_1.NotFoundException('Usuário não encontrado');
            }
            // Verificar se a nova senha é diferente da atual
            const isSamePassword = await bcrypt.compare(newPassword, usuario.senhaHash);
            if (isSamePassword) {
                throw new common_1.BadRequestException('A nova senha deve ser diferente da senha atual');
            }
            // Hash da nova senha
            const hashedPassword = await bcrypt.hash(newPassword, 12);
            // Atualizar senha do usuário usando query builder
            await this.passwordResetTokenRepository.manager
                .createQueryBuilder()
                .update('usuario')
                .set({
                senha: hashedPassword,
                updated_at: new Date(),
            })
                .where('id = :id', { id: usuario.id })
                .execute();
            // Marcar token como usado
            resetToken.markAsUsed('password_changed');
            await this.passwordResetTokenRepository.save(resetToken);
            // Invalidar outros tokens do usuário
            await this.invalidateUserTokens(usuario.id, 'password_changed', resetToken.id);
            // Enviar email de confirmação
            await this.sendPasswordResetConfirmationEmail(usuario, clientInfo);
            // Log de auditoria
            await this.auditService.logUserAction(usuario.id, audit_log_entity_1.AuditAction.PASSWORD_RESET, 'usuario', usuario.id, 'Senha redefinida com sucesso', { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Senha redefinida com sucesso para o usuário ${usuario.email}`, usuario.id, audit_log_entity_1.AuditSeverity.MEDIUM, { email: usuario.email }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            this.logger.log(`Senha redefinida com sucesso para usuário ${usuario.id}`);
            return {
                message: 'Senha redefinida com sucesso. Você pode fazer login com sua nova senha.',
            };
        }
        catch (error) {
            // Registrar erro e redirecionar
            const foundToken = await this.findValidToken(token);
            if (foundToken) {
                foundToken.markAsUsed('password_reset_error');
                await this.passwordResetTokenRepository.save(foundToken);
            }
            this.logger.error('Erro ao redefinir senha', error.stack);
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Erro ao redefinir senha: ${error.message}`, foundToken?.usuario?.id, audit_log_entity_1.AuditSeverity.HIGH, { tokenPrefix: token.substring(0, 8), error: error.message }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            if (error instanceof common_1.BadRequestException ||
                error instanceof common_1.UnauthorizedException ||
                error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno. Tente novamente mais tarde.');
        }
    }
    /**
     * Valida se um token é válido
     */
    async validateToken(token) {
        try {
            const resetToken = await this.findValidToken(token);
            if (!resetToken) {
                return { valid: false };
            }
            return {
                valid: true,
                expiresInMinutes: resetToken.getMinutesUntilExpiration(),
            };
        }
        catch (error) {
            this.logger.error('Erro ao validar token', error.stack);
            return { valid: false };
        }
    }
    /**
     * Obtém estatísticas de recuperação de senha
     */
    async getPasswordResetStats() {
        const now = new Date();
        const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const [totalRequests, activeTokens, expiredTokens, usedTokens, requestsLast24h,] = await Promise.all([
            this.passwordResetTokenRepository.count(),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: { is_used: true },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    created_at: (0, typeorm_2.LessThan)(last24h),
                },
            }),
        ]);
        // Calcular tempo médio de uso
        const usedTokensWithTime = await this.passwordResetTokenRepository
            .createQueryBuilder('token')
            .select('AVG(EXTRACT(EPOCH FROM (token.used_at - token.created_at)) / 60)', 'avgMinutes')
            .where('token.is_used = true AND token.used_at IS NOT NULL')
            .getRawOne();
        const averageTimeToUse = parseFloat(usedTokensWithTime?.avgMinutes || '0');
        return {
            totalRequests,
            activeTokens,
            expiredTokens,
            usedTokens,
            requestsLast24h,
            averageTimeToUse,
        };
    }
    /**
     * Limpeza automática de tokens expirados (executa a cada hora)
     */
    async cleanupExpiredTokens() {
        try {
            const now = new Date();
            const result = await this.passwordResetTokenRepository.delete({
                expires_at: (0, typeorm_2.LessThan)(now),
                is_used: false,
            });
            if (result.affected && result.affected > 0) {
                this.logger.log(`Removidos ${result.affected} tokens de recuperação expirados`);
            }
            return result.affected || 0;
        }
        catch (error) {
            this.logger.error('Erro na limpeza de tokens expirados', error.stack);
            return 0;
        }
    }
    /**
     * Limpeza de tokens antigos usados (executa diariamente)
     */
    async cleanupOldUsedTokens() {
        try {
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const result = await this.passwordResetTokenRepository.delete({
                is_used: true,
                used_at: (0, typeorm_2.LessThan)(thirtyDaysAgo),
            });
            if (result.affected && result.affected > 0) {
                this.logger.log(`Removidos ${result.affected} tokens de recuperação antigos`);
            }
            return result.affected || 0;
        }
        catch (error) {
            this.logger.error('Erro na limpeza de tokens antigos', error.stack);
            return 0;
        }
    }
    // Métodos privados
    generateSecureToken() {
        return crypto.randomBytes(32).toString('hex');
    }
    async hashToken(token) {
        return bcrypt.hash(token, 10);
    }
    async findValidToken(token) {
        const tokens = await this.passwordResetTokenRepository.find({
            where: {
                is_used: false,
                expires_at: (0, typeorm_2.LessThan)(new Date()),
            },
            relations: ['usuario'],
        });
        for (const resetToken of tokens) {
            const isValid = await bcrypt.compare(token, resetToken.token_hash);
            if (isValid && resetToken.isValid()) {
                // Incrementar tentativas
                resetToken.incrementAttempts();
                await this.passwordResetTokenRepository.save(resetToken);
                // Verificar limite de tentativas
                if (resetToken.attempts > this.maxAttemptsPerToken) {
                    resetToken.markAsUsed('max_attempts_exceeded');
                    await this.passwordResetTokenRepository.save(resetToken);
                    return null;
                }
                return resetToken;
            }
        }
        return null;
    }
    async checkRateLimit(usuarioId, ip) {
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const recentRequests = await this.passwordResetTokenRepository.count({
            where: [
                {
                    usuario_id: usuarioId,
                    created_at: (0, typeorm_2.LessThan)(oneHourAgo),
                },
                {
                    client_ip: ip,
                    created_at: (0, typeorm_2.LessThan)(oneHourAgo),
                },
            ],
        });
        if (recentRequests >= this.maxRequestsPerHour) {
            throw new common_1.BadRequestException('Muitas solicitações de recuperação. Tente novamente mais tarde.');
        }
    }
    async invalidateUserTokens(usuarioId, reason, excludeTokenId) {
        const query = this.passwordResetTokenRepository
            .createQueryBuilder()
            .update(password_reset_token_entity_1.PasswordResetToken)
            .set({
            is_used: true,
            invalidation_reason: reason,
            updated_at: new Date(),
        })
            .where('usuario_id = :usuarioId', { usuarioId })
            .andWhere('is_used = false');
        if (excludeTokenId) {
            query.andWhere('id != :excludeTokenId', { excludeTokenId });
        }
        await query.execute();
    }
    async sendPasswordResetEmail(usuario, token, expiresAt) {
        const expiresInMinutes = Math.ceil((expiresAt.getTime() - Date.now()) / (1000 * 60));
        await this.emailService.sendPasswordResetEmail(usuario.email, usuario.nome, token, expiresInMinutes);
    }
    async sendPasswordResetConfirmationEmail(usuario, clientInfo) {
        await this.emailService.sendPasswordResetConfirmationEmail(usuario.email, usuario.nome);
    }
    /**
     * Inicia a limpeza automática de tokens expirados
     * Migrado do PasswordRecoveryService
     */
    startTokenCleanup() {
        const CLEANUP_INTERVAL = 24 * 60 * 60 * 1000; // 24 horas
        // Executar limpeza a cada 24 horas
        setInterval(async () => {
            try {
                await this.cleanupExpiredTokens();
            }
            catch (error) {
                this.logger.error(`Erro na limpeza automática de tokens: ${error.message}`);
            }
        }, CLEANUP_INTERVAL);
        // Executar limpeza de tokens usados a cada 24 horas
        setInterval(async () => {
            try {
                await this.cleanupOldUsedTokens();
            }
            catch (error) {
                this.logger.error(`Erro na limpeza de tokens usados: ${error.message}`);
            }
        }, CLEANUP_INTERVAL);
    }
    /**
     * Obtém estatísticas de tokens de recuperação
     * Migrado do PasswordRecoveryService
     * @returns Estatísticas dos tokens
     */
    async getTokenStats() {
        const now = new Date();
        const [total, active, expired, used] = await Promise.all([
            this.passwordResetTokenRepository.count(),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: true,
                },
            }),
        ]);
        return { total, active, expired, used };
    }
};
exports.PasswordResetService = PasswordResetService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_HOUR),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_h = typeof Promise !== "undefined" && Promise) === "function" ? _h : Object)
], PasswordResetService.prototype, "cleanupExpiredTokens", null);
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_DAY_AT_2AM),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_j = typeof Promise !== "undefined" && Promise) === "function" ? _j : Object)
], PasswordResetService.prototype, "cleanupOldUsedTokens", null);
exports.PasswordResetService = PasswordResetService = PasswordResetService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(password_reset_token_entity_1.PasswordResetToken)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof usuario_repository_1.UsuarioRepository !== "undefined" && usuario_repository_1.UsuarioRepository) === "function" ? _b : Object, typeof (_c = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _c : Object, typeof (_d = typeof audit_service_1.AuditService !== "undefined" && audit_service_1.AuditService) === "function" ? _d : Object, typeof (_e = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _e : Object, typeof (_f = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _f : Object, typeof (_g = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _g : Object])
], PasswordResetService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxwYXNzd29yZC1yZXNldC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBT3dCO0FBQ3hCLDZDQUFtRDtBQUNuRCxxQ0FBMkQ7QUFDM0QsMkNBQStDO0FBQy9DLCtDQUF3RDtBQUN4RCxxQ0FBeUM7QUFDekMsK0NBQWlDO0FBQ2pDLCtDQUFpQztBQUNqQyw0RkFBZ0Y7QUFFaEYsOEZBQTBGO0FBQzFGLHVFQUFtRTtBQUNuRSxzRUFBa0U7QUFFbEUsc0VBQTZFO0FBc0J0RSxJQUFNLG9CQUFvQiw0QkFBMUIsTUFBTSxvQkFBb0I7SUFRWjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxzQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxzQkFBc0IsQ0FBUztJQUMvQixtQkFBbUIsQ0FBUztJQUM1QixrQkFBa0IsQ0FBUztJQUU1QyxZQUVtQiw0QkFBNEQsRUFDNUQsaUJBQW9DLEVBQ3BDLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLGFBQTRCLEVBQzVCLFVBQXNCLEVBQ3RCLFVBQXNCO1FBTnRCLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBZ0M7UUFDNUQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFFdkMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUNsRCxtQ0FBbUMsRUFDbkMs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QixvQkFBakIsc0NBQWlCLG9EQUN0Qiw0QkFBWSxvQkFBWiw0QkFBWSxvREFDWiw0QkFBWSxvQkFBWiw0QkFBWSxvREFDWCxzQkFBYSxvQkFBYixzQkFBYSxvREFDaEIsZ0JBQVUsb0JBQVYsZ0JBQVUsb0RBQ1Ysb0JBQVUsb0JBQVYsb0JBQVU7R0FkOUIsb0JBQW9CLENBZ2xCaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxwYXNzd29yZC1yZXNldC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBVbmF1dGhvcml6ZWRFeGNlcHRpb24sXG4gIExvZ2dlcixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBMZXNzVGhhbiwgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IENyb24sIENyb25FeHByZXNzaW9uIH0gZnJvbSAnQG5lc3Rqcy9zY2hlZHVsZSc7XG5pbXBvcnQgeyBKd3RTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9qd3QnO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgKiBhcyBiY3J5cHQgZnJvbSAnYmNyeXB0JztcbmltcG9ydCB7IFBhc3N3b3JkUmVzZXRUb2tlbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3Bhc3N3b3JkLXJlc2V0LXRva2VuLmVudGl0eSc7XG5pbXBvcnQgeyBVc3VhcmlvIH0gZnJvbSAnLi4vLi4vZW50aXRpZXMvdXN1YXJpby5lbnRpdHknO1xuaW1wb3J0IHsgVXN1YXJpb1JlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9tb2R1bGVzL3VzdWFyaW8vcmVwb3NpdG9yaWVzL3VzdWFyaW8ucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBFbWFpbFNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb21tb24vc2VydmljZXMvZW1haWwuc2VydmljZSc7XG5pbXBvcnQgeyBBdWRpdFNlcnZpY2UgfSBmcm9tICcuLi8uLi9hdWRpdC9zZXJ2aWNlcy9hdWRpdC5zZXJ2aWNlJztcbmltcG9ydCB7IENsaWVudEluZm8gfSBmcm9tICcuLi8uLi9jb21tb24vaW50ZXJmYWNlcy9jbGllbnQtaW5mby5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQXVkaXRBY3Rpb24sIEF1ZGl0U2V2ZXJpdHkgfSBmcm9tICcuLi8uLi9lbnRpdGllcy9hdWRpdC1sb2cuZW50aXR5JztcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0UGFzc3dvcmRSZXNldER0byB7XG4gIGVtYWlsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzZXRQYXNzd29yZER0byB7XG4gIHRva2VuOiBzdHJpbmc7XG4gIG5ld1Bhc3N3b3JkOiBzdHJpbmc7XG4gIGNvbmZpcm1QYXNzd29yZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhc3N3b3JkUmVzZXRTdGF0cyB7XG4gIHRvdGFsUmVxdWVzdHM6IG51bWJlcjtcbiAgYWN0aXZlVG9rZW5zOiBudW1iZXI7XG4gIGV4cGlyZWRUb2tlbnM6IG51bWJlcjtcbiAgdXNlZFRva2VuczogbnVtYmVyO1xuICByZXF1ZXN0c0xhc3QyNGg6IG51bWJlcjtcbiAgYXZlcmFnZVRpbWVUb1VzZTogbnVtYmVyOyAvLyBlbSBtaW51dG9zXG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQYXNzd29yZFJlc2V0U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihQYXNzd29yZFJlc2V0U2VydmljZS5uYW1lKTtcbiAgcHJpdmF0ZSByZWFkb25seSB0b2tlbkV4cGlyYXRpb25NaW51dGVzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWF4QXR0ZW1wdHNQZXJUb2tlbjogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IG1heFJlcXVlc3RzUGVySG91cjogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFBhc3N3b3JkUmVzZXRUb2tlbilcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8UGFzc3dvcmRSZXNldFRva2VuPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzdWFyaW9SZXBvc2l0b3J5OiBVc3VhcmlvUmVwb3NpdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVtYWlsU2VydmljZTogRW1haWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXVkaXRTZXJ2aWNlOiBBdWRpdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgand0U2VydmljZTogSnd0U2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGFTb3VyY2U6IERhdGFTb3VyY2UsXG4gICkge1xuICAgIHRoaXMudG9rZW5FeHBpcmF0aW9uTWludXRlcyA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPihcbiAgICAgICdQQVNTV09SRF9SRVNFVF9FWFBJUkFUSU9OX01JTlVURVMnLFxuICAgICAgMTUsXG4gICAgKTtcbiAgICB0aGlzLm1heEF0dGVtcHRzUGVyVG9rZW4gPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXG4gICAgICAnUEFTU1dPUkRfUkVTRVRfTUFYX0FUVEVNUFRTJyxcbiAgICAgIDMsXG4gICAgKTtcbiAgICB0aGlzLm1heFJlcXVlc3RzUGVySG91ciA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPihcbiAgICAgICdQQVNTV09SRF9SRVNFVF9NQVhfUkVRVUVTVFNfUEVSX0hPVVInLFxuICAgICAgNSxcbiAgICApO1xuXG4gICAgLy8gSW5pY2lhciBsaW1wZXphIGF1dG9tw6F0aWNhIGRlIHRva2VucyBleHBpcmFkb3NcbiAgICB0aGlzLnN0YXJ0VG9rZW5DbGVhbnVwKCk7XG4gIH1cblxuICAvKipcbiAgICogU29saWNpdGEgcmVjdXBlcmHDp8OjbyBkZSBzZW5oYVxuICAgKi9cbiAgYXN5bmMgcmVxdWVzdFBhc3N3b3JkUmVzZXQoXG4gICAgcmVxdWVzdER0bzogUmVxdWVzdFBhc3N3b3JkUmVzZXREdG8sXG4gICAgY2xpZW50SW5mbzogQ2xpZW50SW5mbyxcbiAgKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZzsgZXhwaXJlc0luTWludXRlczogbnVtYmVyIH0+IHtcbiAgICBjb25zdCB7IGVtYWlsIH0gPSByZXF1ZXN0RHRvO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEJ1c2NhciB1c3XDoXJpbyBwZWxvIGVtYWlsXG4gICAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy51c3VhcmlvUmVwb3NpdG9yeS5maW5kQnlFbWFpbChcbiAgICAgICAgZW1haWwudG9Mb3dlckNhc2UoKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFBvciBzZWd1cmFuw6dhLCBzZW1wcmUgcmV0b3JuYW1vcyBzdWNlc3NvIG1lc21vIHNlIG8gZW1haWwgbsOjbyBleGlzdGlyXG4gICAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICBgVGVudGF0aXZhIGRlIHJlc2V0IHBhcmEgZW1haWwgaW5leGlzdGVudGU6ICR7ZW1haWx9YCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpcDogY2xpZW50SW5mby5pcCxcbiAgICAgICAgICAgIHVzZXJBZ2VudDogY2xpZW50SW5mby51c2VyQWdlbnQsXG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KFxuICAgICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICAgIGBUZW50YXRpdmEgZGUgcmVzZXQgcGFyYSBlbWFpbCBpbmV4aXN0ZW50ZTogJHtlbWFpbH1gLFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICBBdWRpdFNldmVyaXR5Lk1FRElVTSxcbiAgICAgICAgICB7IGVtYWlsIH0sXG4gICAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9LFxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICdTZSBvIGVtYWlsIGV4aXN0aXIsIHZvY8OqIHJlY2ViZXLDoSBpbnN0cnXDp8O1ZXMgcGFyYSByZWRlZmluaXIgc3VhIHNlbmhhLicsXG4gICAgICAgICAgZXhwaXJlc0luTWludXRlczogdGhpcy50b2tlbkV4cGlyYXRpb25NaW51dGVzLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgcmF0ZSBsaW1pdGluZ1xuICAgICAgYXdhaXQgdGhpcy5jaGVja1JhdGVMaW1pdCh1c3VhcmlvLmlkLCBjbGllbnRJbmZvLmlwKTtcblxuICAgICAgLy8gSW52YWxpZGFyIHRva2VucyBhbnRlcmlvcmVzIGRvIHVzdcOhcmlvXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVVc2VyVG9rZW5zKHVzdWFyaW8uaWQsICduZXdfcmVxdWVzdCcpO1xuXG4gICAgICAvLyBHZXJhciBub3ZvIHRva2VuXG4gICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZ2VuZXJhdGVTZWN1cmVUb2tlbigpO1xuICAgICAgY29uc3QgdG9rZW5IYXNoID0gYXdhaXQgdGhpcy5oYXNoVG9rZW4odG9rZW4pO1xuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoXG4gICAgICAgIERhdGUubm93KCkgKyB0aGlzLnRva2VuRXhwaXJhdGlvbk1pbnV0ZXMgKiA2MCAqIDEwMDAsXG4gICAgICApO1xuXG4gICAgICAvLyBTYWx2YXIgdG9rZW4gbm8gYmFuY29cbiAgICAgIGNvbnN0IHBhc3N3b3JkUmVzZXRUb2tlbiA9IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICB0b2tlbjogdG9rZW4uc3Vic3RyaW5nKDAsIDgpICsgJy4uLicsIC8vIEFybWF6ZW5hciBhcGVuYXMgcGFydGUgZG8gdG9rZW4gcGFyYSBhdWRpdG9yaWFcbiAgICAgICAgdG9rZW5faGFzaDogdG9rZW5IYXNoLFxuICAgICAgICB1c3VhcmlvX2lkOiB1c3VhcmlvLmlkLFxuICAgICAgICBleHBpcmVzX2F0OiBleHBpcmVzQXQsXG4gICAgICAgIGNsaWVudF9pcDogY2xpZW50SW5mby5pcCxcbiAgICAgICAgdXNlcl9hZ2VudDogY2xpZW50SW5mby51c2VyQWdlbnQsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgb3JpZ2luOiBjbGllbnRJbmZvLm9yaWdpbixcbiAgICAgICAgICByZWZlcmVyOiBjbGllbnRJbmZvLnJlZmVyZXIsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LnNhdmUocGFzc3dvcmRSZXNldFRva2VuKTtcblxuICAgICAgLy8gRW52aWFyIGVtYWlsXG4gICAgICBhd2FpdCB0aGlzLnNlbmRQYXNzd29yZFJlc2V0RW1haWwodXN1YXJpbywgdG9rZW4sIGV4cGlyZXNBdCk7XG5cbiAgICAgIC8vIExvZyBkZSBhdWRpdG9yaWFcbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1VzZXJBY3Rpb24oXG4gICAgICAgIHVzdWFyaW8uaWQsXG4gICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICAncGFzc3dvcmRfcmVzZXRfdG9rZW4nLFxuICAgICAgICBwYXNzd29yZFJlc2V0VG9rZW4uaWQsXG4gICAgICAgICdTb2xpY2l0YcOnw6NvIGRlIHJlY3VwZXJhw6fDo28gZGUgc2VuaGEnLFxuICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH0sXG4gICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFRva2VuIGRlIHJlY3VwZXJhw6fDo28gZ2VyYWRvIHBhcmEgdXN1w6FyaW8gJHt1c3VhcmlvLmlkfWApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdTZSBvIGVtYWlsIGV4aXN0aXIsIHZvY8OqIHJlY2ViZXLDoSBpbnN0cnXDp8O1ZXMgcGFyYSByZWRlZmluaXIgc3VhIHNlbmhhLicsXG4gICAgICAgIGV4cGlyZXNJbk1pbnV0ZXM6IHRoaXMudG9rZW5FeHBpcmF0aW9uTWludXRlcyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIGFvIHNvbGljaXRhciByZWN1cGVyYcOnw6NvIGRlIHNlbmhhJywgZXJyb3Iuc3RhY2spO1xuXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KFxuICAgICAgICBBdWRpdEFjdGlvbi5QQVNTV09SRF9SRVNFVCxcbiAgICAgICAgYEVycm8gYW8gcHJvY2Vzc2FyIHNvbGljaXRhw6fDo28gZGUgcmVzZXQ6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIEF1ZGl0U2V2ZXJpdHkuSElHSCxcbiAgICAgICAgeyBlbWFpbCwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSxcbiAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9LFxuICAgICAgKTtcblxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdFcnJvIGludGVybm8uIFRlbnRlIG5vdmFtZW50ZSBtYWlzIHRhcmRlLicsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWRlZmluZSBhIHNlbmhhIHVzYW5kbyBvIHRva2VuXG4gICAqL1xuICBhc3luYyByZXNldFBhc3N3b3JkKFxuICAgIHJlc2V0RHRvOiBSZXNldFBhc3N3b3JkRHRvLFxuICAgIGNsaWVudEluZm86IENsaWVudEluZm8sXG4gICk6IFByb21pc2U8eyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIGNvbnN0IHsgdG9rZW4sIG5ld1Bhc3N3b3JkLCBjb25maXJtUGFzc3dvcmQgfSA9IHJlc2V0RHRvO1xuXG4gICAgLy8gVmFsaWRhciBzZW5oYXNcbiAgICBpZiAobmV3UGFzc3dvcmQgIT09IGNvbmZpcm1QYXNzd29yZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0FzIHNlbmhhcyBuw6NvIGNvaW5jaWRlbScpO1xuICAgIH1cblxuICAgIGlmIChuZXdQYXNzd29yZC5sZW5ndGggPCA4KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQSBzZW5oYSBkZXZlIHRlciBwZWxvIG1lbm9zIDggY2FyYWN0ZXJlcycpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBCdXNjYXIgdG9rZW4gdsOhbGlkb1xuICAgICAgY29uc3QgcmVzZXRUb2tlbiA9IGF3YWl0IHRoaXMuZmluZFZhbGlkVG9rZW4odG9rZW4pO1xuICAgICAgaWYgKCFyZXNldFRva2VuKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoXG4gICAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVQsXG4gICAgICAgICAgJ1RlbnRhdGl2YSBkZSB1c28gZGUgdG9rZW4gaW52w6FsaWRvIHBhcmEgcmVzZXQgZGUgc2VuaGEnLFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICBBdWRpdFNldmVyaXR5LkhJR0gsXG4gICAgICAgICAgeyB0b2tlblByZWZpeDogdG9rZW4uc3Vic3RyaW5nKDAsIDgpIH0sXG4gICAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9LFxuICAgICAgICApO1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdUb2tlbiBpbnbDoWxpZG8gb3UgZXhwaXJhZG8nKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2FycmVnYXIgdXN1w6FyaW8gcGVsbyBJRFxuICAgICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHRoaXMudXN1YXJpb1JlcG9zaXRvcnkuZmluZEJ5SWQoXG4gICAgICAgIHJlc2V0VG9rZW4udXN1YXJpb19pZCxcbiAgICAgICk7XG5cbiAgICAgIGlmICghdXN1YXJpbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzdcOhcmlvIG7Do28gZW5jb250cmFkbycpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBub3ZhIHNlbmhhIMOpIGRpZmVyZW50ZSBkYSBhdHVhbFxuICAgICAgY29uc3QgaXNTYW1lUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShcbiAgICAgICAgbmV3UGFzc3dvcmQsXG4gICAgICAgIHVzdWFyaW8uc2VuaGFIYXNoLFxuICAgICAgKTtcbiAgICAgIGlmIChpc1NhbWVQYXNzd29yZCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnQSBub3ZhIHNlbmhhIGRldmUgc2VyIGRpZmVyZW50ZSBkYSBzZW5oYSBhdHVhbCcsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEhhc2ggZGEgbm92YSBzZW5oYVxuICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChuZXdQYXNzd29yZCwgMTIpO1xuXG4gICAgICAvLyBBdHVhbGl6YXIgc2VuaGEgZG8gdXN1w6FyaW8gdXNhbmRvIHF1ZXJ5IGJ1aWxkZXJcbiAgICAgIGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5tYW5hZ2VyXG4gICAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoKVxuICAgICAgICAudXBkYXRlKCd1c3VhcmlvJylcbiAgICAgICAgLnNldCh7XG4gICAgICAgICAgc2VuaGE6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0pXG4gICAgICAgIC53aGVyZSgnaWQgPSA6aWQnLCB7IGlkOiB1c3VhcmlvLmlkIH0pXG4gICAgICAgIC5leGVjdXRlKCk7XG5cbiAgICAgIC8vIE1hcmNhciB0b2tlbiBjb21vIHVzYWRvXG4gICAgICByZXNldFRva2VuLm1hcmtBc1VzZWQoJ3Bhc3N3b3JkX2NoYW5nZWQnKTtcbiAgICAgIGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5zYXZlKHJlc2V0VG9rZW4pO1xuXG4gICAgICAvLyBJbnZhbGlkYXIgb3V0cm9zIHRva2VucyBkbyB1c3XDoXJpb1xuICAgICAgYXdhaXQgdGhpcy5pbnZhbGlkYXRlVXNlclRva2VucyhcbiAgICAgICAgdXN1YXJpby5pZCxcbiAgICAgICAgJ3Bhc3N3b3JkX2NoYW5nZWQnLFxuICAgICAgICByZXNldFRva2VuLmlkLFxuICAgICAgKTtcblxuICAgICAgLy8gRW52aWFyIGVtYWlsIGRlIGNvbmZpcm1hw6fDo29cbiAgICAgIGF3YWl0IHRoaXMuc2VuZFBhc3N3b3JkUmVzZXRDb25maXJtYXRpb25FbWFpbCh1c3VhcmlvLCBjbGllbnRJbmZvKTtcblxuICAgICAgLy8gTG9nIGRlIGF1ZGl0b3JpYVxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nVXNlckFjdGlvbihcbiAgICAgICAgdXN1YXJpby5pZCxcbiAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVQsXG4gICAgICAgICd1c3VhcmlvJyxcbiAgICAgICAgdXN1YXJpby5pZCxcbiAgICAgICAgJ1NlbmhhIHJlZGVmaW5pZGEgY29tIHN1Y2Vzc28nLFxuICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH0sXG4gICAgICApO1xuXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KFxuICAgICAgICBBdWRpdEFjdGlvbi5QQVNTV09SRF9SRVNFVCxcbiAgICAgICAgYFNlbmhhIHJlZGVmaW5pZGEgY29tIHN1Y2Vzc28gcGFyYSBvIHVzdcOhcmlvICR7dXN1YXJpby5lbWFpbH1gLFxuICAgICAgICB1c3VhcmlvLmlkLFxuICAgICAgICBBdWRpdFNldmVyaXR5Lk1FRElVTSxcbiAgICAgICAgeyBlbWFpbDogdXN1YXJpby5lbWFpbCB9LFxuICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH0sXG4gICAgICApO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBTZW5oYSByZWRlZmluaWRhIGNvbSBzdWNlc3NvIHBhcmEgdXN1w6FyaW8gJHt1c3VhcmlvLmlkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdTZW5oYSByZWRlZmluaWRhIGNvbSBzdWNlc3NvLiBWb2PDqiBwb2RlIGZhemVyIGxvZ2luIGNvbSBzdWEgbm92YSBzZW5oYS4nLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gUmVnaXN0cmFyIGVycm8gZSByZWRpcmVjaW9uYXJcbiAgICAgIGNvbnN0IGZvdW5kVG9rZW4gPSBhd2FpdCB0aGlzLmZpbmRWYWxpZFRva2VuKHRva2VuKTtcbiAgICAgIGlmIChmb3VuZFRva2VuKSB7XG4gICAgICAgIGZvdW5kVG9rZW4ubWFya0FzVXNlZCgncGFzc3dvcmRfcmVzZXRfZXJyb3InKTtcbiAgICAgICAgYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LnNhdmUoZm91bmRUb2tlbik7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIGFvIHJlZGVmaW5pciBzZW5oYScsIGVycm9yLnN0YWNrKTtcblxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudChcbiAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVQsXG4gICAgICAgIGBFcnJvIGFvIHJlZGVmaW5pciBzZW5oYTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGZvdW5kVG9rZW4/LnVzdWFyaW8/LmlkLFxuICAgICAgICBBdWRpdFNldmVyaXR5LkhJR0gsXG4gICAgICAgIHsgdG9rZW5QcmVmaXg6IHRva2VuLnN1YnN0cmluZygwLCA4KSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSxcbiAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9LFxuICAgICAgKTtcblxuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvblxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJuby4gVGVudGUgbm92YW1lbnRlIG1haXMgdGFyZGUuJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBzZSB1bSB0b2tlbiDDqSB2w6FsaWRvXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVRva2VuKFxuICAgIHRva2VuOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyB2YWxpZDogYm9vbGVhbjsgZXhwaXJlc0luTWludXRlcz86IG51bWJlciB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc2V0VG9rZW4gPSBhd2FpdCB0aGlzLmZpbmRWYWxpZFRva2VuKHRva2VuKTtcblxuICAgICAgaWYgKCFyZXNldFRva2VuKSB7XG4gICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogdHJ1ZSxcbiAgICAgICAgZXhwaXJlc0luTWludXRlczogcmVzZXRUb2tlbi5nZXRNaW51dGVzVW50aWxFeHBpcmF0aW9uKCksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJybyBhbyB2YWxpZGFyIHRva2VuJywgZXJyb3Iuc3RhY2spO1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBlc3RhdMOtc3RpY2FzIGRlIHJlY3VwZXJhw6fDo28gZGUgc2VuaGFcbiAgICovXG4gIGFzeW5jIGdldFBhc3N3b3JkUmVzZXRTdGF0cygpOiBQcm9taXNlPFBhc3N3b3JkUmVzZXRTdGF0cz4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgbGFzdDI0aCA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSAyNCAqIDYwICogNjAgKiAxMDAwKTtcblxuICAgIGNvbnN0IFtcbiAgICAgIHRvdGFsUmVxdWVzdHMsXG4gICAgICBhY3RpdmVUb2tlbnMsXG4gICAgICBleHBpcmVkVG9rZW5zLFxuICAgICAgdXNlZFRva2VucyxcbiAgICAgIHJlcXVlc3RzTGFzdDI0aCxcbiAgICBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KCksXG4gICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGlzX3VzZWQ6IGZhbHNlLFxuICAgICAgICAgIGV4cGlyZXNfYXQ6IExlc3NUaGFuKG5vdyksXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICAgIHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaXNfdXNlZDogZmFsc2UsXG4gICAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgaXNfdXNlZDogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGNyZWF0ZWRfYXQ6IExlc3NUaGFuKGxhc3QyNGgpLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgXSk7XG5cbiAgICAvLyBDYWxjdWxhciB0ZW1wbyBtw6lkaW8gZGUgdXNvXG4gICAgY29uc3QgdXNlZFRva2Vuc1dpdGhUaW1lID0gYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5XG4gICAgICAuY3JlYXRlUXVlcnlCdWlsZGVyKCd0b2tlbicpXG4gICAgICAuc2VsZWN0KFxuICAgICAgICAnQVZHKEVYVFJBQ1QoRVBPQ0ggRlJPTSAodG9rZW4udXNlZF9hdCAtIHRva2VuLmNyZWF0ZWRfYXQpKSAvIDYwKScsXG4gICAgICAgICdhdmdNaW51dGVzJyxcbiAgICAgIClcbiAgICAgIC53aGVyZSgndG9rZW4uaXNfdXNlZCA9IHRydWUgQU5EIHRva2VuLnVzZWRfYXQgSVMgTk9UIE5VTEwnKVxuICAgICAgLmdldFJhd09uZSgpO1xuXG4gICAgY29uc3QgYXZlcmFnZVRpbWVUb1VzZSA9IHBhcnNlRmxvYXQodXNlZFRva2Vuc1dpdGhUaW1lPy5hdmdNaW51dGVzIHx8ICcwJyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxSZXF1ZXN0cyxcbiAgICAgIGFjdGl2ZVRva2VucyxcbiAgICAgIGV4cGlyZWRUb2tlbnMsXG4gICAgICB1c2VkVG9rZW5zLFxuICAgICAgcmVxdWVzdHNMYXN0MjRoLFxuICAgICAgYXZlcmFnZVRpbWVUb1VzZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIExpbXBlemEgYXV0b23DoXRpY2EgZGUgdG9rZW5zIGV4cGlyYWRvcyAoZXhlY3V0YSBhIGNhZGEgaG9yYSlcbiAgICovXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZX0hPVVIpXG4gIGFzeW5jIGNsZWFudXBFeHBpcmVkVG9rZW5zKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuZGVsZXRlKHtcbiAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgaXNfdXNlZDogZmFsc2UsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3VsdC5hZmZlY3RlZCAmJiByZXN1bHQuYWZmZWN0ZWQgPiAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgUmVtb3ZpZG9zICR7cmVzdWx0LmFmZmVjdGVkfSB0b2tlbnMgZGUgcmVjdXBlcmHDp8OjbyBleHBpcmFkb3NgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0LmFmZmVjdGVkIHx8IDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIG5hIGxpbXBlemEgZGUgdG9rZW5zIGV4cGlyYWRvcycsIGVycm9yLnN0YWNrKTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMaW1wZXphIGRlIHRva2VucyBhbnRpZ29zIHVzYWRvcyAoZXhlY3V0YSBkaWFyaWFtZW50ZSlcbiAgICovXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZX0RBWV9BVF8yQU0pXG4gIGFzeW5jIGNsZWFudXBPbGRVc2VkVG9rZW5zKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRoaXJ0eURheXNBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5kZWxldGUoe1xuICAgICAgICBpc191c2VkOiB0cnVlLFxuICAgICAgICB1c2VkX2F0OiBMZXNzVGhhbih0aGlydHlEYXlzQWdvKSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAocmVzdWx0LmFmZmVjdGVkICYmIHJlc3VsdC5hZmZlY3RlZCA+IDApIHtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgIGBSZW1vdmlkb3MgJHtyZXN1bHQuYWZmZWN0ZWR9IHRva2VucyBkZSByZWN1cGVyYcOnw6NvIGFudGlnb3NgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0LmFmZmVjdGVkIHx8IDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIG5hIGxpbXBlemEgZGUgdG9rZW5zIGFudGlnb3MnLCBlcnJvci5zdGFjayk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICAvLyBNw6l0b2RvcyBwcml2YWRvc1xuXG4gIHByaXZhdGUgZ2VuZXJhdGVTZWN1cmVUb2tlbigpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaGFzaFRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBiY3J5cHQuaGFzaCh0b2tlbiwgMTApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmaW5kVmFsaWRUb2tlbihcbiAgICB0b2tlbjogc3RyaW5nLFxuICApOiBQcm9taXNlPFBhc3N3b3JkUmVzZXRUb2tlbiB8IG51bGw+IHtcbiAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuZmluZCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpc191c2VkOiBmYWxzZSxcbiAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obmV3IERhdGUoKSksXG4gICAgICB9LFxuICAgICAgcmVsYXRpb25zOiBbJ3VzdWFyaW8nXSxcbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgcmVzZXRUb2tlbiBvZiB0b2tlbnMpIHtcbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZSh0b2tlbiwgcmVzZXRUb2tlbi50b2tlbl9oYXNoKTtcbiAgICAgIGlmIChpc1ZhbGlkICYmIHJlc2V0VG9rZW4uaXNWYWxpZCgpKSB7XG4gICAgICAgIC8vIEluY3JlbWVudGFyIHRlbnRhdGl2YXNcbiAgICAgICAgcmVzZXRUb2tlbi5pbmNyZW1lbnRBdHRlbXB0cygpO1xuICAgICAgICBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuc2F2ZShyZXNldFRva2VuKTtcblxuICAgICAgICAvLyBWZXJpZmljYXIgbGltaXRlIGRlIHRlbnRhdGl2YXNcbiAgICAgICAgaWYgKHJlc2V0VG9rZW4uYXR0ZW1wdHMgPiB0aGlzLm1heEF0dGVtcHRzUGVyVG9rZW4pIHtcbiAgICAgICAgICByZXNldFRva2VuLm1hcmtBc1VzZWQoJ21heF9hdHRlbXB0c19leGNlZWRlZCcpO1xuICAgICAgICAgIGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5zYXZlKHJlc2V0VG9rZW4pO1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc2V0VG9rZW47XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrUmF0ZUxpbWl0KHVzdWFyaW9JZDogc3RyaW5nLCBpcDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgb25lSG91ckFnbyA9IG5ldyBEYXRlKERhdGUubm93KCkgLSA2MCAqIDYwICogMTAwMCk7XG5cbiAgICBjb25zdCByZWNlbnRSZXF1ZXN0cyA9IGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICB3aGVyZTogW1xuICAgICAgICB7XG4gICAgICAgICAgdXN1YXJpb19pZDogdXN1YXJpb0lkLFxuICAgICAgICAgIGNyZWF0ZWRfYXQ6IExlc3NUaGFuKG9uZUhvdXJBZ28pLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgY2xpZW50X2lwOiBpcCxcbiAgICAgICAgICBjcmVhdGVkX2F0OiBMZXNzVGhhbihvbmVIb3VyQWdvKSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBpZiAocmVjZW50UmVxdWVzdHMgPj0gdGhpcy5tYXhSZXF1ZXN0c1BlckhvdXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnTXVpdGFzIHNvbGljaXRhw6fDtWVzIGRlIHJlY3VwZXJhw6fDo28uIFRlbnRlIG5vdmFtZW50ZSBtYWlzIHRhcmRlLicsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaW52YWxpZGF0ZVVzZXJUb2tlbnMoXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICAgcmVhc29uOiBzdHJpbmcsXG4gICAgZXhjbHVkZVRva2VuSWQ/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5XG4gICAgICAuY3JlYXRlUXVlcnlCdWlsZGVyKClcbiAgICAgIC51cGRhdGUoUGFzc3dvcmRSZXNldFRva2VuKVxuICAgICAgLnNldCh7XG4gICAgICAgIGlzX3VzZWQ6IHRydWUsXG4gICAgICAgIGludmFsaWRhdGlvbl9yZWFzb246IHJlYXNvbixcbiAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKSxcbiAgICAgIH0pXG4gICAgICAud2hlcmUoJ3VzdWFyaW9faWQgPSA6dXN1YXJpb0lkJywgeyB1c3VhcmlvSWQgfSlcbiAgICAgIC5hbmRXaGVyZSgnaXNfdXNlZCA9IGZhbHNlJyk7XG5cbiAgICBpZiAoZXhjbHVkZVRva2VuSWQpIHtcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKCdpZCAhPSA6ZXhjbHVkZVRva2VuSWQnLCB7IGV4Y2x1ZGVUb2tlbklkIH0pO1xuICAgIH1cblxuICAgIGF3YWl0IHF1ZXJ5LmV4ZWN1dGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFBhc3N3b3JkUmVzZXRFbWFpbChcbiAgICB1c3VhcmlvOiBVc3VhcmlvLFxuICAgIHRva2VuOiBzdHJpbmcsXG4gICAgZXhwaXJlc0F0OiBEYXRlLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBleHBpcmVzSW5NaW51dGVzID0gTWF0aC5jZWlsKFxuICAgICAgKGV4cGlyZXNBdC5nZXRUaW1lKCkgLSBEYXRlLm5vdygpKSAvICgxMDAwICogNjApLFxuICAgICk7XG5cbiAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kUGFzc3dvcmRSZXNldEVtYWlsKFxuICAgICAgdXN1YXJpby5lbWFpbCxcbiAgICAgIHVzdWFyaW8ubm9tZSxcbiAgICAgIHRva2VuLFxuICAgICAgZXhwaXJlc0luTWludXRlcyxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kUGFzc3dvcmRSZXNldENvbmZpcm1hdGlvbkVtYWlsKFxuICAgIHVzdWFyaW86IFVzdWFyaW8sXG4gICAgY2xpZW50SW5mbzogQ2xpZW50SW5mbyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5lbWFpbFNlcnZpY2Uuc2VuZFBhc3N3b3JkUmVzZXRDb25maXJtYXRpb25FbWFpbChcbiAgICAgIHVzdWFyaW8uZW1haWwsXG4gICAgICB1c3VhcmlvLm5vbWUsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmljaWEgYSBsaW1wZXphIGF1dG9tw6F0aWNhIGRlIHRva2VucyBleHBpcmFkb3NcbiAgICogTWlncmFkbyBkbyBQYXNzd29yZFJlY292ZXJ5U2VydmljZVxuICAgKi9cbiAgcHJpdmF0ZSBzdGFydFRva2VuQ2xlYW51cCgpOiB2b2lkIHtcbiAgICBjb25zdCBDTEVBTlVQX0lOVEVSVkFMID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gMjQgaG9yYXNcblxuICAgIC8vIEV4ZWN1dGFyIGxpbXBlemEgYSBjYWRhIDI0IGhvcmFzXG4gICAgc2V0SW50ZXJ2YWwoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5jbGVhbnVwRXhwaXJlZFRva2VucygpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgYEVycm8gbmEgbGltcGV6YSBhdXRvbcOhdGljYSBkZSB0b2tlbnM6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0sIENMRUFOVVBfSU5URVJWQUwpO1xuXG4gICAgLy8gRXhlY3V0YXIgbGltcGV6YSBkZSB0b2tlbnMgdXNhZG9zIGEgY2FkYSAyNCBob3Jhc1xuICAgIHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xlYW51cE9sZFVzZWRUb2tlbnMoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIG5hIGxpbXBlemEgZGUgdG9rZW5zIHVzYWRvczogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0sIENMRUFOVVBfSU5URVJWQUwpO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBlc3RhdMOtc3RpY2FzIGRlIHRva2VucyBkZSByZWN1cGVyYcOnw6NvXG4gICAqIE1pZ3JhZG8gZG8gUGFzc3dvcmRSZWNvdmVyeVNlcnZpY2VcbiAgICogQHJldHVybnMgRXN0YXTDrXN0aWNhcyBkb3MgdG9rZW5zXG4gICAqL1xuICBhc3luYyBnZXRUb2tlblN0YXRzKCk6IFByb21pc2U8e1xuICAgIHRvdGFsOiBudW1iZXI7XG4gICAgYWN0aXZlOiBudW1iZXI7XG4gICAgZXhwaXJlZDogbnVtYmVyO1xuICAgIHVzZWQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG5cbiAgICBjb25zdCBbdG90YWwsIGFjdGl2ZSwgZXhwaXJlZCwgdXNlZF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoKSxcbiAgICAgIHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaXNfdXNlZDogZmFsc2UsXG4gICAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBleHBpcmVzX2F0OiBMZXNzVGhhbihub3cpLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGlzX3VzZWQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIHJldHVybiB7IHRvdGFsLCBhY3RpdmUsIGV4cGlyZWQsIHVzZWQgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9