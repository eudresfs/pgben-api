95321a9ad0dce630439fc94d31f643e3
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PermissionRepository = void 0;
const typeorm_1 = require("typeorm");
const common_1 = require("@nestjs/common");
const permission_entity_1 = require("../../entities/permission.entity");
/**
 * Repositório para a entidade Permission.
 *
 * Fornece métodos para manipulação de permissões no banco de dados,
 * incluindo busca por nome, verificação de permissões compostas e
 * operações de CRUD.
 */
let PermissionRepository = class PermissionRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(permission_entity_1.Permission, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Busca uma permissão pelo nome.
     *
     * @param name Nome da permissão no formato `modulo.recurso.operacao`
     * @returns A permissão encontrada ou null
     */
    async findByName(name) {
        try {
            // Usar SQL nativo para evitar problemas com nomes de colunas
            const result = await this.dataSource.manager.query(`SELECT * FROM permissao WHERE nome = $1 LIMIT 1`, [name]);
            if (!result || result.length === 0) {
                return null;
            }
            // Converter o resultado para uma entidade Permission usando o método auxiliar
            return this.toEntity(result[0]);
        }
        catch (error) {
            console.error('Erro ao buscar permissão por nome:', error);
            return null;
        }
    }
    /**
     * Busca permissões por um padrão de nome (usando LIKE).
     * Útil para buscar permissões compostas como `modulo.*`.
     *
     * @param pattern Padrão de nome para busca (ex: 'cidadao.%')
     * @returns Lista de permissões que correspondem ao padrão
     */
    async findByPattern(pattern) {
        try {
            // Usar SQL nativo para evitar problemas com nomes de colunas
            const result = await this.dataSource.manager.query(`SELECT * FROM permissao WHERE nome LIKE $1`, [pattern]);
            if (!result || result.length === 0) {
                return [];
            }
            // Converter o resultado para entidades Permission usando o método auxiliar
            return result.map((row) => this.toEntity(row));
        }
        catch (error) {
            console.error('Erro ao buscar permissões por padrão:', error);
            return [];
        }
    }
    /**
     * Busca todas as permissões compostas (aquelas com nomes que contém '*').
     *
     * @returns Lista de permissões compostas
     */
    async findAllComposite() {
        try {
            // Usar SQL nativo para evitar problemas com nomes de colunas
            // Identificamos permissões compostas pelo padrão do nome (contendo '*')
            const result = await this.dataSource.manager.query(`SELECT * FROM permissao WHERE nome LIKE '%.*%'`);
            if (!result || result.length === 0) {
                return [];
            }
            // Converter o resultado para entidades Permission usando o método auxiliar
            return result.map((row) => this.toEntity(row));
        }
        catch (error) {
            console.error('Erro ao buscar permissões compostas:', error);
            return [];
        }
    }
    /**
     * Busca todas as permissões de um módulo específico.
     *
     * @param moduleName Nome do módulo
     * @returns Lista de permissões do módulo
     */
    async findByModule(moduleName) {
        try {
            // Usar SQL nativo para evitar problemas com nomes de colunas
            const result = await this.dataSource.manager.query(`SELECT * FROM permissao WHERE modulo = $1`, [moduleName]);
            if (!result || result.length === 0) {
                return [];
            }
            // Converter o resultado para entidades Permission usando o método auxiliar
            return result.map((row) => this.toEntity(row));
        }
        catch (error) {
            console.error(`Erro ao buscar permissões do módulo ${moduleName}:`, error);
            return [];
        }
    }
    /**
     * Cria uma nova permissão.
     *
     * @param data Dados da permissão a ser criada
     * @returns A permissão criada
     */
    async createPermission(data) {
        const permission = this.create(data);
        return this.save(permission);
    }
    /**
     * Atualiza uma permissão existente.
     *
     * @param id ID da permissão a ser atualizada
     * @param data Dados atualizados da permissão
     * @returns A permissão atualizada
     */
    async updatePermission(id, data) {
        await this.update(id, data);
        return this.findOneBy({ id });
    }
    /**
     * Remove uma permissão.
     *
     * @param id ID da permissão a ser removida
     * @returns true se a permissão foi removida, false caso contrário
     */
    async removePermission(id) {
        const result = await this.delete(id);
        return (result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0);
    }
    /**
     * Busca permissões por IDs.
     *
     * @param ids Lista de IDs das permissões
     * @returns Lista de permissões encontradas
     */
    /**
     * Converte um objeto de resultado de consulta SQL em uma entidade Permission
     *
     * @param row Linha de resultado da consulta SQL
     * @returns Entidade Permission
     */
    toEntity(row) {
        const permission = new permission_entity_1.Permission();
        permission.id = row.id;
        permission.nome = row.nome;
        permission.descricao = row.descricao;
        // Campos adicionais que existem no banco mas não na entidade
        // usamos casting para any para evitar erros de typescript
        permission.modulo = row.modulo;
        permission.acao = row.acao;
        permission.ativo = row.ativo;
        permission.created_at = row.created_at;
        permission.updated_at = row.updated_at;
        return permission;
    }
    async findByIds(ids) {
        if (!ids || ids.length === 0) {
            return [];
        }
        try {
            // Usar SQL nativo para evitar problemas com nomes de colunas
            const result = await this.dataSource.manager.query(`SELECT * FROM permissao WHERE id = ANY($1)`, [ids]);
            if (!result || result.length === 0) {
                return [];
            }
            // Converter o resultado para entidades Permission usando o método auxiliar
            return result.map((row) => this.toEntity(row));
        }
        catch (error) {
            console.error('Erro ao buscar permissões por IDs:', error);
            return [];
        }
    }
};
exports.PermissionRepository = PermissionRepository;
exports.PermissionRepository = PermissionRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], PermissionRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xccGVybWlzc2lvbi5yZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSxxQ0FBaUQ7QUFDakQsMkNBQTRDO0FBQzVDLHdFQUE4RDtBQUU5RDs7Ozs7O0dBTUc7QUFFSSxJQUFNLG9CQUFvQixHQUExQixNQUFNLG9CQUFxQixTQUFRLG9CQUFzQjtJQUMxQztJQUFwQixZQUFvQixVQUFzQjtRQUN4QyxLQUFLLENBQUMsOEJBQVUsRUFBRSxVQUFVLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBRGxDLGVBQVUsR0FBVixVQUFVLENBQVk7SUFFMUMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFZO1FBQzNCLElBQUksQ0FBQztZQUNILDZEQUE2RDtZQUM3RCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FDaEQsaURBQWlELEVBQ2pELENBQUMsSUFBSSxDQUFDLENBQ1AsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDbkMsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBRUQsOEVBQThFO1lBQzlFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBZTtRQUNqQyxJQUFJ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WUFDN0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQ2hELDRDQUE0QyxFQUM1QyxDQUFDLEdBQUcsQ0FBQyxDQUNOLENBQUM7WUFFRixJQUFJLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ25DLE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQztZQUVELDJFQUEyRTtZQUMzRSxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0QsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUE3TVksb0RBQW9COytCQUFwQixvQkFBb0I7SUFEaEMsSUFBQSxtQkFBVSxHQUFFO3lEQUVxQixvQkFBVSxvQkFBVixvQkFBVTtHQUQvQixvQkFBb0IsQ0E2TWhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxhdXRoXFxyZXBvc2l0b3JpZXNcXHBlcm1pc3Npb24ucmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhU291cmNlLCBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3Blcm1pc3Npb24uZW50aXR5JztcblxuLyoqXG4gKiBSZXBvc2l0w7NyaW8gcGFyYSBhIGVudGlkYWRlIFBlcm1pc3Npb24uXG4gKlxuICogRm9ybmVjZSBtw6l0b2RvcyBwYXJhIG1hbmlwdWxhw6fDo28gZGUgcGVybWlzc8O1ZXMgbm8gYmFuY28gZGUgZGFkb3MsXG4gKiBpbmNsdWluZG8gYnVzY2EgcG9yIG5vbWUsIHZlcmlmaWNhw6fDo28gZGUgcGVybWlzc8O1ZXMgY29tcG9zdGFzIGVcbiAqIG9wZXJhw6fDtWVzIGRlIENSVUQuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQZXJtaXNzaW9uUmVwb3NpdG9yeSBleHRlbmRzIFJlcG9zaXRvcnk8UGVybWlzc2lvbj4ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGFTb3VyY2U6IERhdGFTb3VyY2UpIHtcbiAgICBzdXBlcihQZXJtaXNzaW9uLCBkYXRhU291cmNlLmNyZWF0ZUVudGl0eU1hbmFnZXIoKSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdW1hIHBlcm1pc3PDo28gcGVsbyBub21lLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBOb21lIGRhIHBlcm1pc3PDo28gbm8gZm9ybWF0byBgbW9kdWxvLnJlY3Vyc28ub3BlcmFjYW9gXG4gICAqIEByZXR1cm5zIEEgcGVybWlzc8OjbyBlbmNvbnRyYWRhIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGZpbmRCeU5hbWUobmFtZTogc3RyaW5nKTogUHJvbWlzZTxQZXJtaXNzaW9uIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVc2FyIFNRTCBuYXRpdm8gcGFyYSBldml0YXIgcHJvYmxlbWFzIGNvbSBub21lcyBkZSBjb2x1bmFzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UubWFuYWdlci5xdWVyeShcbiAgICAgICAgYFNFTEVDVCAqIEZST00gcGVybWlzc2FvIFdIRVJFIG5vbWUgPSAkMSBMSU1JVCAxYCxcbiAgICAgICAgW25hbWVdLFxuICAgICAgKTtcblxuICAgICAgaWYgKCFyZXN1bHQgfHwgcmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gQ29udmVydGVyIG8gcmVzdWx0YWRvIHBhcmEgdW1hIGVudGlkYWRlIFBlcm1pc3Npb24gdXNhbmRvIG8gbcOpdG9kbyBhdXhpbGlhclxuICAgICAgcmV0dXJuIHRoaXMudG9FbnRpdHkocmVzdWx0WzBdKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyBidXNjYXIgcGVybWlzc8OjbyBwb3Igbm9tZTonLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIHVtIHBhZHLDo28gZGUgbm9tZSAodXNhbmRvIExJS0UpLlxuICAgKiDDmnRpbCBwYXJhIGJ1c2NhciBwZXJtaXNzw7VlcyBjb21wb3N0YXMgY29tbyBgbW9kdWxvLipgLlxuICAgKlxuICAgKiBAcGFyYW0gcGF0dGVybiBQYWRyw6NvIGRlIG5vbWUgcGFyYSBidXNjYSAoZXg6ICdjaWRhZGFvLiUnKVxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBwZXJtaXNzw7VlcyBxdWUgY29ycmVzcG9uZGVtIGFvIHBhZHLDo29cbiAgICovXG4gIGFzeW5jIGZpbmRCeVBhdHRlcm4ocGF0dGVybjogc3RyaW5nKTogUHJvbWlzZTxQZXJtaXNzaW9uW10+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVXNhciBTUUwgbmF0aXZvIHBhcmEgZXZpdGFyIHByb2JsZW1hcyBjb20gbm9tZXMgZGUgY29sdW5hc1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLm1hbmFnZXIucXVlcnkoXG4gICAgICAgIGBTRUxFQ1QgKiBGUk9NIHBlcm1pc3NhbyBXSEVSRSBub21lIExJS0UgJDFgLFxuICAgICAgICBbcGF0dGVybl0sXG4gICAgICApO1xuXG4gICAgICBpZiAoIXJlc3VsdCB8fCByZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgLy8gQ29udmVydGVyIG8gcmVzdWx0YWRvIHBhcmEgZW50aWRhZGVzIFBlcm1pc3Npb24gdXNhbmRvIG8gbcOpdG9kbyBhdXhpbGlhclxuICAgICAgcmV0dXJuIHJlc3VsdC5tYXAoKHJvdykgPT4gdGhpcy50b0VudGl0eShyb3cpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyBidXNjYXIgcGVybWlzc8O1ZXMgcG9yIHBhZHLDo286JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RhcyBhcyBwZXJtaXNzw7VlcyBjb21wb3N0YXMgKGFxdWVsYXMgY29tIG5vbWVzIHF1ZSBjb250w6ltICcqJykuXG4gICAqXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIGNvbXBvc3Rhc1xuICAgKi9cbiAgYXN5bmMgZmluZEFsbENvbXBvc2l0ZSgpOiBQcm9taXNlPFBlcm1pc3Npb25bXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVc2FyIFNRTCBuYXRpdm8gcGFyYSBldml0YXIgcHJvYmxlbWFzIGNvbSBub21lcyBkZSBjb2x1bmFzXG4gICAgICAvLyBJZGVudGlmaWNhbW9zIHBlcm1pc3PDtWVzIGNvbXBvc3RhcyBwZWxvIHBhZHLDo28gZG8gbm9tZSAoY29udGVuZG8gJyonKVxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLm1hbmFnZXIucXVlcnkoXG4gICAgICAgIGBTRUxFQ1QgKiBGUk9NIHBlcm1pc3NhbyBXSEVSRSBub21lIExJS0UgJyUuKiUnYCxcbiAgICAgICk7XG5cbiAgICAgIGlmICghcmVzdWx0IHx8IHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuXG4gICAgICAvLyBDb252ZXJ0ZXIgbyByZXN1bHRhZG8gcGFyYSBlbnRpZGFkZXMgUGVybWlzc2lvbiB1c2FuZG8gbyBtw6l0b2RvIGF1eGlsaWFyXG4gICAgICByZXR1cm4gcmVzdWx0Lm1hcCgocm93KSA9PiB0aGlzLnRvRW50aXR5KHJvdykpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvIGFvIGJ1c2NhciBwZXJtaXNzw7VlcyBjb21wb3N0YXM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RhcyBhcyBwZXJtaXNzw7VlcyBkZSB1bSBtw7NkdWxvIGVzcGVjw61maWNvLlxuICAgKlxuICAgKiBAcGFyYW0gbW9kdWxlTmFtZSBOb21lIGRvIG3Ds2R1bG9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgcGVybWlzc8O1ZXMgZG8gbcOzZHVsb1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5TW9kdWxlKG1vZHVsZU5hbWU6IHN0cmluZyk6IFByb21pc2U8UGVybWlzc2lvbltdPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFVzYXIgU1FMIG5hdGl2byBwYXJhIGV2aXRhciBwcm9ibGVtYXMgY29tIG5vbWVzIGRlIGNvbHVuYXNcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGF0YVNvdXJjZS5tYW5hZ2VyLnF1ZXJ5KFxuICAgICAgICBgU0VMRUNUICogRlJPTSBwZXJtaXNzYW8gV0hFUkUgbW9kdWxvID0gJDFgLFxuICAgICAgICBbbW9kdWxlTmFtZV0sXG4gICAgICApO1xuXG4gICAgICBpZiAoIXJlc3VsdCB8fCByZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgLy8gQ29udmVydGVyIG8gcmVzdWx0YWRvIHBhcmEgZW50aWRhZGVzIFBlcm1pc3Npb24gdXNhbmRvIG8gbcOpdG9kbyBhdXhpbGlhclxuICAgICAgcmV0dXJuIHJlc3VsdC5tYXAoKHJvdykgPT4gdGhpcy50b0VudGl0eShyb3cpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gYnVzY2FyIHBlcm1pc3PDtWVzIGRvIG3Ds2R1bG8gJHttb2R1bGVOYW1lfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyaWEgdW1hIG5vdmEgcGVybWlzc8Ojby5cbiAgICpcbiAgICogQHBhcmFtIGRhdGEgRGFkb3MgZGEgcGVybWlzc8OjbyBhIHNlciBjcmlhZGFcbiAgICogQHJldHVybnMgQSBwZXJtaXNzw6NvIGNyaWFkYVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUGVybWlzc2lvbihkYXRhOiBQYXJ0aWFsPFBlcm1pc3Npb24+KTogUHJvbWlzZTxQZXJtaXNzaW9uPiB7XG4gICAgY29uc3QgcGVybWlzc2lvbiA9IHRoaXMuY3JlYXRlKGRhdGEpO1xuICAgIHJldHVybiB0aGlzLnNhdmUocGVybWlzc2lvbik7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW1hIHBlcm1pc3PDo28gZXhpc3RlbnRlLlxuICAgKlxuICAgKiBAcGFyYW0gaWQgSUQgZGEgcGVybWlzc8OjbyBhIHNlciBhdHVhbGl6YWRhXG4gICAqIEBwYXJhbSBkYXRhIERhZG9zIGF0dWFsaXphZG9zIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgQSBwZXJtaXNzw6NvIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHVwZGF0ZVBlcm1pc3Npb24oXG4gICAgaWQ6IHN0cmluZyxcbiAgICBkYXRhOiBQYXJ0aWFsPFBlcm1pc3Npb24+LFxuICApOiBQcm9taXNlPFBlcm1pc3Npb24gfCBudWxsPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGUoaWQsIGRhdGEpO1xuICAgIHJldHVybiB0aGlzLmZpbmRPbmVCeSh7IGlkIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bWEgcGVybWlzc8Ojby5cbiAgICpcbiAgICogQHBhcmFtIGlkIElEIGRhIHBlcm1pc3PDo28gYSBzZXIgcmVtb3ZpZGFcbiAgICogQHJldHVybnMgdHJ1ZSBzZSBhIHBlcm1pc3PDo28gZm9pIHJlbW92aWRhLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHJlbW92ZVBlcm1pc3Npb24oaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGVsZXRlKGlkKTtcbiAgICByZXR1cm4gKFxuICAgICAgcmVzdWx0LmFmZmVjdGVkICE9PSBudWxsICYmXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgcmVzdWx0LmFmZmVjdGVkID4gMFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgcGVybWlzc8O1ZXMgcG9yIElEcy5cbiAgICpcbiAgICogQHBhcmFtIGlkcyBMaXN0YSBkZSBJRHMgZGFzIHBlcm1pc3PDtWVzXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIGVuY29udHJhZGFzXG4gICAqL1xuICAvKipcbiAgICogQ29udmVydGUgdW0gb2JqZXRvIGRlIHJlc3VsdGFkbyBkZSBjb25zdWx0YSBTUUwgZW0gdW1hIGVudGlkYWRlIFBlcm1pc3Npb25cbiAgICpcbiAgICogQHBhcmFtIHJvdyBMaW5oYSBkZSByZXN1bHRhZG8gZGEgY29uc3VsdGEgU1FMXG4gICAqIEByZXR1cm5zIEVudGlkYWRlIFBlcm1pc3Npb25cbiAgICovXG4gIHByaXZhdGUgdG9FbnRpdHkocm93OiBhbnkpOiBQZXJtaXNzaW9uIHtcbiAgICBjb25zdCBwZXJtaXNzaW9uID0gbmV3IFBlcm1pc3Npb24oKTtcbiAgICBwZXJtaXNzaW9uLmlkID0gcm93LmlkO1xuICAgIHBlcm1pc3Npb24ubm9tZSA9IHJvdy5ub21lO1xuICAgIHBlcm1pc3Npb24uZGVzY3JpY2FvID0gcm93LmRlc2NyaWNhbztcblxuICAgIC8vIENhbXBvcyBhZGljaW9uYWlzIHF1ZSBleGlzdGVtIG5vIGJhbmNvIG1hcyBuw6NvIG5hIGVudGlkYWRlXG4gICAgLy8gdXNhbW9zIGNhc3RpbmcgcGFyYSBhbnkgcGFyYSBldml0YXIgZXJyb3MgZGUgdHlwZXNjcmlwdFxuICAgIChwZXJtaXNzaW9uIGFzIGFueSkubW9kdWxvID0gcm93Lm1vZHVsbztcbiAgICAocGVybWlzc2lvbiBhcyBhbnkpLmFjYW8gPSByb3cuYWNhbztcbiAgICAocGVybWlzc2lvbiBhcyBhbnkpLmF0aXZvID0gcm93LmF0aXZvO1xuXG4gICAgcGVybWlzc2lvbi5jcmVhdGVkX2F0ID0gcm93LmNyZWF0ZWRfYXQ7XG4gICAgcGVybWlzc2lvbi51cGRhdGVkX2F0ID0gcm93LnVwZGF0ZWRfYXQ7XG4gICAgcmV0dXJuIHBlcm1pc3Npb247XG4gIH1cblxuICBhc3luYyBmaW5kQnlJZHMoaWRzOiBzdHJpbmdbXSk6IFByb21pc2U8UGVybWlzc2lvbltdPiB7XG4gICAgaWYgKCFpZHMgfHwgaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBVc2FyIFNRTCBuYXRpdm8gcGFyYSBldml0YXIgcHJvYmxlbWFzIGNvbSBub21lcyBkZSBjb2x1bmFzXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UubWFuYWdlci5xdWVyeShcbiAgICAgICAgYFNFTEVDVCAqIEZST00gcGVybWlzc2FvIFdIRVJFIGlkID0gQU5ZKCQxKWAsXG4gICAgICAgIFtpZHNdLFxuICAgICAgKTtcblxuICAgICAgaWYgKCFyZXN1bHQgfHwgcmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG5cbiAgICAgIC8vIENvbnZlcnRlciBvIHJlc3VsdGFkbyBwYXJhIGVudGlkYWRlcyBQZXJtaXNzaW9uIHVzYW5kbyBvIG3DqXRvZG8gYXV4aWxpYXJcbiAgICAgIHJldHVybiByZXN1bHQubWFwKChyb3cpID0+IHRoaXMudG9FbnRpdHkocm93KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gYnVzY2FyIHBlcm1pc3PDtWVzIHBvciBJRHM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9