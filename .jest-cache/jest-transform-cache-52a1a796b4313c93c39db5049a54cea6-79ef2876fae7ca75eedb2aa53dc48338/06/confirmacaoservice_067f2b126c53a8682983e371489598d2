3f6806f380ed279d0ad12078224f328d
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConfirmacaoService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const confirmacao_recebimento_entity_1 = require("../../../entities/confirmacao-recebimento.entity");
const comprovante_service_1 = require("./comprovante.service");
/**
 * Serviço para gerenciamento de confirmações de recebimento de pagamentos
 *
 * Implementa a lógica para registrar e consultar confirmações de recebimento
 * por parte dos beneficiários, validando regras de negócio específicas.
 *
 * @author Equipe PGBen
 */
let ConfirmacaoService = class ConfirmacaoService {
    confirmacaoRepository;
    comprovanteService;
    constructor(confirmacaoRepository, comprovanteService) {
        this.confirmacaoRepository = confirmacaoRepository;
        this.comprovanteService = comprovanteService;
    }
    /**
     * Registra uma nova confirmação de recebimento para um pagamento
     *
     * @param pagamentoId ID do pagamento
     * @param createDto Dados da confirmação
     * @param usuarioId ID do usuário que está registrando a confirmação
     * @returns Confirmação registrada
     */
    async registrarConfirmacao(pagamentoId, createDto, usuarioId) {
        // Verificar se o pagamento existe
        // const pagamento = await this.pagamentoService.findOne(pagamentoId);
        // if (!pagamento) {
        //   throw new NotFoundException('Pagamento não encontrado');
        // }
        // Verificar se o pagamento está no status adequado
        // if (pagamento.status !== StatusPagamentoEnum.LIBERADO) {
        //   throw new ConflictException(
        //     'Somente pagamentos liberados podem receber confirmação'
        //   );
        // }
        // Verificar se já existe confirmação para este pagamento
        const existingConfirmacao = await this.findByPagamento(pagamentoId);
        if (existingConfirmacao.length > 0) {
            throw new common_1.ConflictException('Este pagamento já possui uma confirmação de recebimento registrada');
        }
        // Verificar se o pagamento tem pelo menos um comprovante
        const hasComprovantes = await this.comprovanteService.hasComprovantes(pagamentoId);
        if (!hasComprovantes) {
            throw new common_1.ConflictException('É necessário anexar pelo menos um comprovante antes de confirmar o recebimento');
        }
        // Criar nova confirmação
        const confirmacao = this.confirmacaoRepository.create({
            pagamento_id: pagamentoId,
            data_confirmacao: createDto.dataConfirmacao,
            metodo_confirmacao: createDto.metodoConfirmacao,
            confirmado_por: usuarioId,
            destinatario_id: createDto.destinatarioId,
            observacoes: createDto.observacoes
        });
        // Salvar a confirmação
        const result = await this.confirmacaoRepository.save(confirmacao);
        // Atualizar o status do pagamento para CONFIRMADO
        // await this.pagamentoService.atualizarStatus(
        //   pagamentoId,
        //   StatusPagamentoEnum.CONFIRMADO,
        //   usuarioId
        // );
        // Registrar operação no log de auditoria
        // await this.auditoriaService.registrarOperacao({
        //   tipoOperacao: 'CONFIRMACAO_RECEBIMENTO',
        //   usuarioId,
        //   entidadeId: result.id,
        //   tipoEntidade: 'CONFIRMACAO_RECEBIMENTO',
        //   dadosAnteriores: null,
        //   dadosNovos: result
        // });
        return result;
    }
    /**
     * Busca uma confirmação pelo ID
     *
     * @param id ID da confirmação
     * @returns Confirmação encontrada ou null
     */
    async findOne(id) {
        return this.confirmacaoRepository.findOneBy({ id });
    }
    /**
     * Busca confirmações de um pagamento específico
     *
     * @param pagamentoId ID do pagamento
     * @returns Lista de confirmações para o pagamento
     */
    async findByPagamento(pagamentoId) {
        return this.confirmacaoRepository.find({
            where: { pagamento_id: pagamentoId },
            order: { data_confirmacao: 'DESC' }
        });
    }
    /**
     * Busca uma confirmação pelo ID com todos os relacionamentos
     *
     * @param id ID da confirmação
     * @returns Confirmação encontrada com relacionamentos ou null
     */
    async findOneWithRelations(id) {
        return this.confirmacaoRepository.findOne({
            where: { id },
            relations: ['pagamento'],
        });
    }
    /**
     * Verifica se um pagamento tem confirmação de recebimento
     *
     * @param pagamentoId ID do pagamento
     * @returns true se o pagamento tem confirmação
     */
    async temConfirmacao(pagamentoId) {
        const count = await this.confirmacaoRepository.count({
            where: { pagamento_id: pagamentoId }
        });
        return count > 0;
    }
    /**
     * Validar destinatário se diferente do beneficiário
     *
     * @param pagamentoId ID do pagamento
     * @param destinatarioId ID do destinatário
     * @returns true se o destinatário é válido
     */
    async validarDestinatario(pagamentoId, destinatarioId) {
        // Esta é uma implementação de placeholder
        // Será integrada com o CidadaoService para validar a relação entre o beneficiário e o destinatário
        if (!destinatarioId) {
            return true; // Sem destinatário específico, assume-se que é o próprio beneficiário
        }
        // Lógica para validar se o destinatário é válido (ex: familiar cadastrado)
        // const pagamento = await this.pagamentoService.findOne(pagamentoId);
        // const solicitacao = await this.solicitacaoService.findOne(pagamento.solicitacaoId);
        // const beneficiarioId = solicitacao.cidadaoId;
        // return this.cidadaoService.verificarRelacaoFamiliar(beneficiarioId, destinatarioId);
        return true; // Temporariamente retornando true
    }
};
exports.ConfirmacaoService = ConfirmacaoService;
exports.ConfirmacaoService = ConfirmacaoService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(confirmacao_recebimento_entity_1.ConfirmacaoRecebimento)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof comprovante_service_1.ComprovanteService !== "undefined" && comprovante_service_1.ComprovanteService) === "function" ? _b : Object])
], ConfirmacaoService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcc2VydmljZXNcXGNvbmZpcm1hY2FvLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFrRjtBQUNsRiw2Q0FBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLHFHQUEwRjtBQUcxRiwrREFBMkQ7QUFFM0Q7Ozs7Ozs7R0FPRztBQUVJLElBQU0sa0JBQWtCLEdBQXhCLE1BQU0sa0JBQWtCO0lBR1Y7SUFDQTtJQUhuQixZQUVtQixxQkFBeUQsRUFDekQsa0JBQXNDO1FBRHRDLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBb0M7UUFDekQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUl0RCxDQUFDO0lBRUo7Ozs7Ozs7T0FPRztJQUNILEtBQUssQ0FBQyxvQkFBb0IsQ0FDeEIsV0FBbUIsRUFDbkIsU0FBb0MsRUFDcEMsU0FBaUI7UUFFakIsa0NBQWtDO1FBQ2xDLHNFQUFzRTtRQUV0RSxvQkFBb0I7UUFDcEIsNkRBQTZEO1FBQzdELElBQUk7UUFFSixtREFBbUQ7UUFDbkQsMkRBQTJEO1FBQzNELGlDQUFpQztRQUNqQywrREFBK0Q7UUFDL0QsT0FBTztRQUNQLElBQUk7UUFFSix5REFBeUQ7UUFDekQsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFcEUsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDbkMsTUFBTSxJQUFJLDBCQUFpQixDQUN6QixvRUFBb0UsQ0FDckUsQ0FBQztRQUNKLENBQUM7UUFFRCx5REFBeUQ7UUFDekQsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRW5GLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUNyQixNQUFNLElBQUksMEJBQWlCLENBQ3pCLGdGQUFnRixDQUNqRixDQUFDO1FBQ0osQ0FBQztRQUVELHlCQUF5QjtRQUN6QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDO1lBQ3BELFlBQVksRUFBRSxXQUFXO1lBQ3pCLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxlQUFlO1lBQzNDLGtCQUFrQixFQUFFLFNBQVMsQ0FBQyxpQkFBaUI7WUFDL0MsY0FBYyxFQUFFLFNBQVM7WUFDekIsZUFBZSxFQUFFLFNBQVMsQ0FBQyxjQUFjO1lBQ3pDLFdBQVcsRUFBRSxTQUFTLENBQUMsV0FBVztTQUNuQyxDQUFDLENBQUM7UUFFSCx1QkFBdUI7UUFDdkIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWxFLGtEQUFrRDtRQUNsRCwrQ0FBK0M7UUFDL0MsaUJBQWlCO1FBQ2pCLG9DQUFvQztRQUNwQyxjQUFjO1FBQ2QsS0FBSztRQUVMLHlDQUF5QztRQUN6QyxrREFBa0Q7UUFDbEQsNkNBQTZDO1FBQzdDLGVBQWU7UUFDZiwyQkFBMkI7UUFDM0IsNkNBQTZDO1FBQzdDLDJCQUEyQjtRQUMzQix1QkFBdUI7UUFDdkIsTUFBTTtRQUVOLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBVTtRQUN0QixPQUFPLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxlQUFlLENBQUMsV0FBbUI7UUFDdkMsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDO1lBQ3JDLEtBQUssRUFBRSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUU7WUFDcEMsS0FBSyxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxFQUFVO1FBQ25DLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQztZQUN4QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUU7WUFDYixTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUM7U0FDekIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFtQjtRQUN0QyxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUM7WUFDbkQsS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRTtTQUNyQyxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNLLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxXQUFtQixFQUFFLGNBQXVCO1FBQzVFLDBDQUEwQztRQUMxQyxtR0FBbUc7UUFFbkcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sSUFBSSxDQUFDLENBQUMsc0VBQXNFO1FBQ3JGLENBQUM7UUFFRCwyRUFBMkU7UUFDM0Usc0VBQXNFO1FBQ3RFLHNGQUFzRjtRQUN0RixnREFBZ0Q7UUFFaEQsdUZBQXVGO1FBRXZGLE9BQU8sSUFBSSxDQUFDLENBQUMsa0NBQWtDO0lBQ2pELENBQUM7Q0FDRixDQUFBO0FBbEtZLGdEQUFrQjs2QkFBbEIsa0JBQWtCO0lBRDlCLElBQUEsbUJBQVUsR0FBRTtJQUdSLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyx1REFBc0IsQ0FBQyxDQUFBO3lEQUNELG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNiLHdDQUFrQixvQkFBbEIsd0NBQWtCO0dBSjlDLGtCQUFrQixDQWtLOUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcc2VydmljZXNcXGNvbmZpcm1hY2FvLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uZmxpY3RFeGNlcHRpb24sIEluamVjdGFibGUsIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBDb25maXJtYWNhb1JlY2ViaW1lbnRvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY29uZmlybWFjYW8tcmVjZWJpbWVudG8uZW50aXR5JztcbmltcG9ydCB7IFN0YXR1c1BhZ2FtZW50b0VudW0gfSBmcm9tICcuLi8uLi8uLi9lbnVtcy9zdGF0dXMtcGFnYW1lbnRvLmVudW0nO1xuaW1wb3J0IHsgQ29uZmlybWFjYW9SZWNlYmltZW50b0R0byB9IGZyb20gJy4uL2R0b3MvY29uZmlybWFjYW8tcmVjZWJpbWVudG8uZHRvJztcbmltcG9ydCB7IENvbXByb3ZhbnRlU2VydmljZSB9IGZyb20gJy4vY29tcHJvdmFudGUuc2VydmljZSc7XG5cbi8qKlxuICogU2VydmnDp28gcGFyYSBnZXJlbmNpYW1lbnRvIGRlIGNvbmZpcm1hw6fDtWVzIGRlIHJlY2ViaW1lbnRvIGRlIHBhZ2FtZW50b3NcbiAqIFxuICogSW1wbGVtZW50YSBhIGzDs2dpY2EgcGFyYSByZWdpc3RyYXIgZSBjb25zdWx0YXIgY29uZmlybWHDp8O1ZXMgZGUgcmVjZWJpbWVudG9cbiAqIHBvciBwYXJ0ZSBkb3MgYmVuZWZpY2nDoXJpb3MsIHZhbGlkYW5kbyByZWdyYXMgZGUgbmVnw7NjaW8gZXNwZWPDrWZpY2FzLlxuICogXG4gKiBAYXV0aG9yIEVxdWlwZSBQR0JlblxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29uZmlybWFjYW9TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdFJlcG9zaXRvcnkoQ29uZmlybWFjYW9SZWNlYmltZW50bylcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpcm1hY2FvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDb25maXJtYWNhb1JlY2ViaW1lbnRvPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXByb3ZhbnRlU2VydmljZTogQ29tcHJvdmFudGVTZXJ2aWNlLFxuICAgIC8vIE91dHJvcyBzZXJ2acOnb3MgbmVjZXNzw6FyaW9zIHNlcsOjbyBpbmpldGFkb3MgYXF1aVxuICAgIC8vIHByaXZhdGUgcmVhZG9ubHkgcGFnYW1lbnRvU2VydmljZTogUGFnYW1lbnRvU2VydmljZSxcbiAgICAvLyBwcml2YXRlIHJlYWRvbmx5IGF1ZGl0b3JpYVNlcnZpY2U6IEF1ZGl0b3JpYVNlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogUmVnaXN0cmEgdW1hIG5vdmEgY29uZmlybWHDp8OjbyBkZSByZWNlYmltZW50byBwYXJhIHVtIHBhZ2FtZW50b1xuICAgKiBcbiAgICogQHBhcmFtIHBhZ2FtZW50b0lkIElEIGRvIHBhZ2FtZW50b1xuICAgKiBAcGFyYW0gY3JlYXRlRHRvIERhZG9zIGRhIGNvbmZpcm1hw6fDo29cbiAgICogQHBhcmFtIHVzdWFyaW9JZCBJRCBkbyB1c3XDoXJpbyBxdWUgZXN0w6EgcmVnaXN0cmFuZG8gYSBjb25maXJtYcOnw6NvXG4gICAqIEByZXR1cm5zIENvbmZpcm1hw6fDo28gcmVnaXN0cmFkYVxuICAgKi9cbiAgYXN5bmMgcmVnaXN0cmFyQ29uZmlybWFjYW8oXG4gICAgcGFnYW1lbnRvSWQ6IHN0cmluZyxcbiAgICBjcmVhdGVEdG86IENvbmZpcm1hY2FvUmVjZWJpbWVudG9EdG8sXG4gICAgdXN1YXJpb0lkOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxDb25maXJtYWNhb1JlY2ViaW1lbnRvPiB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gcGFnYW1lbnRvIGV4aXN0ZVxuICAgIC8vIGNvbnN0IHBhZ2FtZW50byA9IGF3YWl0IHRoaXMucGFnYW1lbnRvU2VydmljZS5maW5kT25lKHBhZ2FtZW50b0lkKTtcbiAgICBcbiAgICAvLyBpZiAoIXBhZ2FtZW50bykge1xuICAgIC8vICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdQYWdhbWVudG8gbsOjbyBlbmNvbnRyYWRvJyk7XG4gICAgLy8gfVxuICAgIFxuICAgIC8vIFZlcmlmaWNhciBzZSBvIHBhZ2FtZW50byBlc3TDoSBubyBzdGF0dXMgYWRlcXVhZG9cbiAgICAvLyBpZiAocGFnYW1lbnRvLnN0YXR1cyAhPT0gU3RhdHVzUGFnYW1lbnRvRW51bS5MSUJFUkFETykge1xuICAgIC8vICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgIC8vICAgICAnU29tZW50ZSBwYWdhbWVudG9zIGxpYmVyYWRvcyBwb2RlbSByZWNlYmVyIGNvbmZpcm1hw6fDo28nXG4gICAgLy8gICApO1xuICAgIC8vIH1cblxuICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlIGNvbmZpcm1hw6fDo28gcGFyYSBlc3RlIHBhZ2FtZW50b1xuICAgIGNvbnN0IGV4aXN0aW5nQ29uZmlybWFjYW8gPSBhd2FpdCB0aGlzLmZpbmRCeVBhZ2FtZW50byhwYWdhbWVudG9JZCk7XG4gICAgXG4gICAgaWYgKGV4aXN0aW5nQ29uZmlybWFjYW8ubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAnRXN0ZSBwYWdhbWVudG8gasOhIHBvc3N1aSB1bWEgY29uZmlybWHDp8OjbyBkZSByZWNlYmltZW50byByZWdpc3RyYWRhJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyBwYWdhbWVudG8gdGVtIHBlbG8gbWVub3MgdW0gY29tcHJvdmFudGVcbiAgICBjb25zdCBoYXNDb21wcm92YW50ZXMgPSBhd2FpdCB0aGlzLmNvbXByb3ZhbnRlU2VydmljZS5oYXNDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuICAgIFxuICAgIGlmICghaGFzQ29tcHJvdmFudGVzKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICfDiSBuZWNlc3PDoXJpbyBhbmV4YXIgcGVsbyBtZW5vcyB1bSBjb21wcm92YW50ZSBhbnRlcyBkZSBjb25maXJtYXIgbyByZWNlYmltZW50bydcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ3JpYXIgbm92YSBjb25maXJtYcOnw6NvXG4gICAgY29uc3QgY29uZmlybWFjYW8gPSB0aGlzLmNvbmZpcm1hY2FvUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgcGFnYW1lbnRvX2lkOiBwYWdhbWVudG9JZCxcbiAgICAgIGRhdGFfY29uZmlybWFjYW86IGNyZWF0ZUR0by5kYXRhQ29uZmlybWFjYW8sXG4gICAgICBtZXRvZG9fY29uZmlybWFjYW86IGNyZWF0ZUR0by5tZXRvZG9Db25maXJtYWNhbyxcbiAgICAgIGNvbmZpcm1hZG9fcG9yOiB1c3VhcmlvSWQsXG4gICAgICBkZXN0aW5hdGFyaW9faWQ6IGNyZWF0ZUR0by5kZXN0aW5hdGFyaW9JZCxcbiAgICAgIG9ic2VydmFjb2VzOiBjcmVhdGVEdG8ub2JzZXJ2YWNvZXNcbiAgICB9KTtcblxuICAgIC8vIFNhbHZhciBhIGNvbmZpcm1hw6fDo29cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbmZpcm1hY2FvUmVwb3NpdG9yeS5zYXZlKGNvbmZpcm1hY2FvKTtcblxuICAgIC8vIEF0dWFsaXphciBvIHN0YXR1cyBkbyBwYWdhbWVudG8gcGFyYSBDT05GSVJNQURPXG4gICAgLy8gYXdhaXQgdGhpcy5wYWdhbWVudG9TZXJ2aWNlLmF0dWFsaXphclN0YXR1cyhcbiAgICAvLyAgIHBhZ2FtZW50b0lkLFxuICAgIC8vICAgU3RhdHVzUGFnYW1lbnRvRW51bS5DT05GSVJNQURPLFxuICAgIC8vICAgdXN1YXJpb0lkXG4gICAgLy8gKTtcblxuICAgIC8vIFJlZ2lzdHJhciBvcGVyYcOnw6NvIG5vIGxvZyBkZSBhdWRpdG9yaWFcbiAgICAvLyBhd2FpdCB0aGlzLmF1ZGl0b3JpYVNlcnZpY2UucmVnaXN0cmFyT3BlcmFjYW8oe1xuICAgIC8vICAgdGlwb09wZXJhY2FvOiAnQ09ORklSTUFDQU9fUkVDRUJJTUVOVE8nLFxuICAgIC8vICAgdXN1YXJpb0lkLFxuICAgIC8vICAgZW50aWRhZGVJZDogcmVzdWx0LmlkLFxuICAgIC8vICAgdGlwb0VudGlkYWRlOiAnQ09ORklSTUFDQU9fUkVDRUJJTUVOVE8nLFxuICAgIC8vICAgZGFkb3NBbnRlcmlvcmVzOiBudWxsLFxuICAgIC8vICAgZGFkb3NOb3ZvczogcmVzdWx0XG4gICAgLy8gfSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtYSBjb25maXJtYcOnw6NvIHBlbG8gSURcbiAgICogXG4gICAqIEBwYXJhbSBpZCBJRCBkYSBjb25maXJtYcOnw6NvXG4gICAqIEByZXR1cm5zIENvbmZpcm1hw6fDo28gZW5jb250cmFkYSBvdSBudWxsXG4gICAqL1xuICBhc3luYyBmaW5kT25lKGlkOiBzdHJpbmcpOiBQcm9taXNlPENvbmZpcm1hY2FvUmVjZWJpbWVudG8gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlybWFjYW9SZXBvc2l0b3J5LmZpbmRPbmVCeSh7IGlkIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIGNvbmZpcm1hw6fDtWVzIGRlIHVtIHBhZ2FtZW50byBlc3BlY8OtZmljb1xuICAgKiBcbiAgICogQHBhcmFtIHBhZ2FtZW50b0lkIElEIGRvIHBhZ2FtZW50b1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBjb25maXJtYcOnw7VlcyBwYXJhIG8gcGFnYW1lbnRvXG4gICAqL1xuICBhc3luYyBmaW5kQnlQYWdhbWVudG8ocGFnYW1lbnRvSWQ6IHN0cmluZyk6IFByb21pc2U8Q29uZmlybWFjYW9SZWNlYmltZW50b1tdPiB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlybWFjYW9SZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgd2hlcmU6IHsgcGFnYW1lbnRvX2lkOiBwYWdhbWVudG9JZCB9LFxuICAgICAgb3JkZXI6IHsgZGF0YV9jb25maXJtYWNhbzogJ0RFU0MnIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB1bWEgY29uZmlybWHDp8OjbyBwZWxvIElEIGNvbSB0b2RvcyBvcyByZWxhY2lvbmFtZW50b3NcbiAgICogXG4gICAqIEBwYXJhbSBpZCBJRCBkYSBjb25maXJtYcOnw6NvXG4gICAqIEByZXR1cm5zIENvbmZpcm1hw6fDo28gZW5jb250cmFkYSBjb20gcmVsYWNpb25hbWVudG9zIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGZpbmRPbmVXaXRoUmVsYXRpb25zKGlkOiBzdHJpbmcpOiBQcm9taXNlPENvbmZpcm1hY2FvUmVjZWJpbWVudG8gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlybWFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIHJlbGF0aW9uczogWydwYWdhbWVudG8nXSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSB1bSBwYWdhbWVudG8gdGVtIGNvbmZpcm1hw6fDo28gZGUgcmVjZWJpbWVudG9cbiAgICogXG4gICAqIEBwYXJhbSBwYWdhbWVudG9JZCBJRCBkbyBwYWdhbWVudG9cbiAgICogQHJldHVybnMgdHJ1ZSBzZSBvIHBhZ2FtZW50byB0ZW0gY29uZmlybWHDp8Ojb1xuICAgKi9cbiAgYXN5bmMgdGVtQ29uZmlybWFjYW8ocGFnYW1lbnRvSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGNvdW50ID0gYXdhaXQgdGhpcy5jb25maXJtYWNhb1JlcG9zaXRvcnkuY291bnQoe1xuICAgICAgd2hlcmU6IHsgcGFnYW1lbnRvX2lkOiBwYWdhbWVudG9JZCB9XG4gICAgfSk7XG4gICAgXG4gICAgcmV0dXJuIGNvdW50ID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGFyIGRlc3RpbmF0w6FyaW8gc2UgZGlmZXJlbnRlIGRvIGJlbmVmaWNpw6FyaW9cbiAgICogXG4gICAqIEBwYXJhbSBwYWdhbWVudG9JZCBJRCBkbyBwYWdhbWVudG9cbiAgICogQHBhcmFtIGRlc3RpbmF0YXJpb0lkIElEIGRvIGRlc3RpbmF0w6FyaW9cbiAgICogQHJldHVybnMgdHJ1ZSBzZSBvIGRlc3RpbmF0w6FyaW8gw6kgdsOhbGlkb1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGFyRGVzdGluYXRhcmlvKHBhZ2FtZW50b0lkOiBzdHJpbmcsIGRlc3RpbmF0YXJpb0lkPzogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gRXN0YSDDqSB1bWEgaW1wbGVtZW50YcOnw6NvIGRlIHBsYWNlaG9sZGVyXG4gICAgLy8gU2Vyw6EgaW50ZWdyYWRhIGNvbSBvIENpZGFkYW9TZXJ2aWNlIHBhcmEgdmFsaWRhciBhIHJlbGHDp8OjbyBlbnRyZSBvIGJlbmVmaWNpw6FyaW8gZSBvIGRlc3RpbmF0w6FyaW9cbiAgICBcbiAgICBpZiAoIWRlc3RpbmF0YXJpb0lkKSB7XG4gICAgICByZXR1cm4gdHJ1ZTsgLy8gU2VtIGRlc3RpbmF0w6FyaW8gZXNwZWPDrWZpY28sIGFzc3VtZS1zZSBxdWUgw6kgbyBwcsOzcHJpbyBiZW5lZmljacOhcmlvXG4gICAgfVxuICAgIFxuICAgIC8vIEzDs2dpY2EgcGFyYSB2YWxpZGFyIHNlIG8gZGVzdGluYXTDoXJpbyDDqSB2w6FsaWRvIChleDogZmFtaWxpYXIgY2FkYXN0cmFkbylcbiAgICAvLyBjb25zdCBwYWdhbWVudG8gPSBhd2FpdCB0aGlzLnBhZ2FtZW50b1NlcnZpY2UuZmluZE9uZShwYWdhbWVudG9JZCk7XG4gICAgLy8gY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvU2VydmljZS5maW5kT25lKHBhZ2FtZW50by5zb2xpY2l0YWNhb0lkKTtcbiAgICAvLyBjb25zdCBiZW5lZmljaWFyaW9JZCA9IHNvbGljaXRhY2FvLmNpZGFkYW9JZDtcbiAgICBcbiAgICAvLyByZXR1cm4gdGhpcy5jaWRhZGFvU2VydmljZS52ZXJpZmljYXJSZWxhY2FvRmFtaWxpYXIoYmVuZWZpY2lhcmlvSWQsIGRlc3RpbmF0YXJpb0lkKTtcbiAgICBcbiAgICByZXR1cm4gdHJ1ZTsgLy8gVGVtcG9yYXJpYW1lbnRlIHJldG9ybmFuZG8gdHJ1ZVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=