65755cf705369b27c89246aacc995c99
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var DeterminacaoJudicialService_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DeterminacaoJudicialService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const determinacao_judicial_entity_1 = require("../../../entities/determinacao-judicial.entity");
const solicitacao_entity_1 = require("../../../entities/solicitacao.entity");
/**
 * Serviço de Determinação Judicial
 *
 * Responsável por gerenciar as determinações judiciais relacionadas às solicitações
 * de benefício, permitindo o controle e rastreamento de processos judiciais.
 */
let DeterminacaoJudicialService = DeterminacaoJudicialService_1 = class DeterminacaoJudicialService {
    determinacaoRepository;
    solicitacaoRepository;
    dataSource;
    logger = new common_1.Logger(DeterminacaoJudicialService_1.name);
    constructor(determinacaoRepository, solicitacaoRepository, dataSource) {
        this.determinacaoRepository = determinacaoRepository;
        this.solicitacaoRepository = solicitacaoRepository;
        this.dataSource = dataSource;
    }
    /**
     * Cria uma nova determinação judicial
     * @param createDeterminacaoDto Dados da determinação judicial
     * @param usuarioId ID do usuário que está criando a determinação
     * @returns Determinação judicial criada
     */
    async create(createDeterminacaoDto, usuarioId) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            // Verificar se a solicitação existe
            const solicitacao = await this.solicitacaoRepository.findOne({
                where: { id: createDeterminacaoDto.solicitacao_id },
            });
            if (!solicitacao) {
                throw new common_1.NotFoundException('Solicitação de benefício não encontrada');
            }
            // Verificar se já existe determinação com o mesmo número de processo para a solicitação
            const determinacaoExistente = await this.determinacaoRepository.findOne({
                where: {
                    solicitacao_id: createDeterminacaoDto.solicitacao_id,
                    numero_processo: createDeterminacaoDto.numero_processo,
                },
            });
            if (determinacaoExistente) {
                throw new common_1.ConflictException('Já existe uma determinação judicial com este número de processo para esta solicitação');
            }
            // Criar a determinação judicial
            const novaDeterminacao = this.determinacaoRepository.create({
                ...createDeterminacaoDto,
                usuario_id: usuarioId,
            });
            const determinacaoSalva = await queryRunner.manager.save(novaDeterminacao);
            // Atualizar a solicitação para indicar que possui determinação judicial
            await queryRunner.manager.update(solicitacao_entity_1.Solicitacao, { id: createDeterminacaoDto.solicitacao_id }, {
                determinacao_judicial_flag: true,
                determinacao_judicial_id: determinacaoSalva.id,
            });
            await queryRunner.commitTransaction();
            return determinacaoSalva;
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.ConflictException) {
                throw error;
            }
            this.logger.error(`Erro ao criar determinação judicial: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao criar determinação judicial');
        }
        finally {
            await queryRunner.release();
        }
    }
    /**
     * Busca todas as determinações judiciais de uma solicitação
     * @param solicitacaoId ID da solicitação
     * @returns Lista de determinações judiciais
     */
    async findBySolicitacaoId(solicitacaoId) {
        try {
            // Verificar se a solicitação existe
            const solicitacao = await this.solicitacaoRepository.findOne({
                where: { id: solicitacaoId },
            });
            if (!solicitacao) {
                throw new common_1.NotFoundException('Solicitação de benefício não encontrada');
            }
            return this.determinacaoRepository.find({
                where: { solicitacao_id: solicitacaoId },
                order: { data_determinacao: 'DESC' },
            });
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            this.logger.error(`Erro ao buscar determinações judiciais: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao buscar determinações judiciais');
        }
    }
    /**
     * Busca uma determinação judicial pelo ID
     * @param id ID da determinação judicial
     * @returns Determinação judicial
     */
    async findById(id) {
        try {
            const determinacao = await this.determinacaoRepository.findOne({
                where: { id },
                relations: ['solicitacao'],
            });
            if (!determinacao) {
                throw new common_1.NotFoundException('Determinação judicial não encontrada');
            }
            return determinacao;
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            this.logger.error(`Erro ao buscar determinação judicial: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao buscar determinação judicial');
        }
    }
    /**
     * Atualiza uma determinação judicial
     * @param id ID da determinação judicial
     * @param updateDeterminacaoDto Dados para atualização
     * @returns Determinação judicial atualizada
     */
    async update(id, updateDeterminacaoDto) {
        try {
            // Verificar se a determinação existe
            const determinacao = await this.determinacaoRepository.findOne({
                where: { id },
            });
            if (!determinacao) {
                throw new common_1.NotFoundException('Determinação judicial não encontrada');
            }
            // Atualizar a determinação
            await this.determinacaoRepository.update(id, updateDeterminacaoDto);
            // Retornar a determinação atualizada
            return this.findById(id);
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            this.logger.error(`Erro ao atualizar determinação judicial: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao atualizar determinação judicial');
        }
    }
    /**
     * Registra o cumprimento de uma determinação judicial
     * @param id ID da determinação judicial
     * @param observacoes Observações sobre o cumprimento
     * @returns Determinação judicial atualizada
     */
    async registrarCumprimento(id, observacoes) {
        try {
            // Verificar se a determinação existe
            const determinacao = await this.determinacaoRepository.findOne({
                where: { id },
            });
            if (!determinacao) {
                throw new common_1.NotFoundException('Determinação judicial não encontrada');
            }
            // Atualizar a determinação com a data de cumprimento
            const updateData = {
                data_cumprimento: new Date(),
            };
            if (observacoes) {
                updateData.observacao_cumprimento = observacoes;
            }
            await this.determinacaoRepository.update(id, updateData);
            // Retornar a determinação atualizada
            return this.findById(id);
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            this.logger.error(`Erro ao registrar cumprimento de determinação judicial: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao registrar cumprimento de determinação judicial');
        }
    }
    /**
     * Remove uma determinação judicial
     * @param id ID da determinação judicial
     * @returns Void
     */
    async remove(id) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            // Verificar se a determinação existe
            const determinacao = await this.determinacaoRepository.findOne({
                where: { id },
                relations: ['solicitacao'],
            });
            if (!determinacao) {
                throw new common_1.NotFoundException('Determinação judicial não encontrada');
            }
            // Verificar se é a determinação principal da solicitação
            const solicitacao = await this.solicitacaoRepository.findOne({
                where: { determinacao_judicial_id: id },
            });
            if (solicitacao) {
                // Se for a determinação principal, verificar se há outras determinações
                const outrasDeterminacoes = await this.determinacaoRepository.find({
                    where: { solicitacao_id: determinacao.solicitacao_id },
                });
                if (outrasDeterminacoes.length > 1) {
                    // Se houver outras determinações, definir a mais recente como principal
                    const outrasDeterminacoesOrdenadas = outrasDeterminacoes
                        .filter((det) => det.id !== id)
                        .sort((a, b) => b.data_determinacao.getTime() - a.data_determinacao.getTime());
                    // Atualizar a solicitação com a nova determinação principal
                    await queryRunner.manager.update(solicitacao_entity_1.Solicitacao, { id: determinacao.solicitacao_id }, { determinacao_judicial_id: outrasDeterminacoesOrdenadas[0].id });
                }
                else {
                    // Se não houver outras determinações, remover a referência na solicitação
                    await queryRunner.manager.update(solicitacao_entity_1.Solicitacao, { id: determinacao.solicitacao_id }, {
                        determinacao_judicial_flag: false,
                        determinacao_judicial_id: null,
                    });
                }
            }
            // Remover a determinação
            await queryRunner.manager.remove(determinacao);
            await queryRunner.commitTransaction();
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            this.logger.error(`Erro ao remover determinação judicial: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao remover determinação judicial');
        }
        finally {
            await queryRunner.release();
        }
    }
};
exports.DeterminacaoJudicialService = DeterminacaoJudicialService;
exports.DeterminacaoJudicialService = DeterminacaoJudicialService = DeterminacaoJudicialService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(determinacao_judicial_entity_1.DeterminacaoJudicial)),
    __param(1, (0, typeorm_1.InjectRepository)(solicitacao_entity_1.Solicitacao)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _c : Object])
], DeterminacaoJudicialService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcZGV0ZXJtaW5hY2FvLWp1ZGljaWFsLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUFpRDtBQUNqRCxpR0FBc0Y7QUFDdEYsNkVBQW1FO0FBSW5FOzs7OztHQUtHO0FBRUksSUFBTSwyQkFBMkIsbUNBQWpDLE1BQU0sMkJBQTJCO0lBS25CO0lBRUE7SUFDQTtJQVBGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyw2QkFBMkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV2RSxZQUVtQixzQkFBd0QsRUFFeEQscUJBQThDLEVBQzlDLFVBQXNCO1FBSHRCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBa0M7UUFFeEQsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF5QjtRQUM5QyxlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQ3RDLENBQUM7SUFFSjs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQ1YscUJBQStELEVBQy9ELFNBQWlCO1FBRWpCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN4RCxNQUFNLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM1QixNQUFNLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRXJDLElBQUksQ0FBQztZQUNILG9DQUFvQztZQUNwQyxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUM7Z0JBQzNELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxxQkFBcUIsQ0FBQyxjQUFjLEVBQUU7YUFDcEQsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixNQUFNLElB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QUFDO1FBQ3hDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxXQUFXLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUV4QyxJQUFJLEtBQUssWUFBWSwwQkFBaUIsRUFBRSxDQUFDO2dCQUN2QyxNQUFNLEtBQUssQ0FBQztZQUNkLENBQUM7WUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiwwQ0FBMEMsS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUN6RCxLQUFLLENBQUMsS0FBSyxDQUNaLENBQUM7WUFDRixNQUFNLElBQUkscUNBQTRCLENBQ3BDLHVDQUF1QyxDQUN4QyxDQUFDO1FBQ0osQ0FBQztnQkFBUyxDQUFDO1lBQ1QsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUIsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBNVVZLGtFQUEyQjtzQ0FBM0IsMkJBQTJCO0lBRHZDLElBQUEsbUJBQVUsR0FBRTtJQUtSLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyxtREFBb0IsQ0FBQyxDQUFBO0lBRXRDLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyxnQ0FBVyxDQUFDLENBQUE7eURBRFcsb0JBQVUsb0JBQVYsb0JBQVUsb0RBRVgsb0JBQVUsb0JBQVYsb0JBQVUsb0RBQ3JCLG9CQUFVLG9CQUFWLG9CQUFVO0dBUjlCLDJCQUEyQixDQTRVdkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcZGV0ZXJtaW5hY2FvLWp1ZGljaWFsLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHsgRGV0ZXJtaW5hY2FvSnVkaWNpYWwgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9kZXRlcm1pbmFjYW8tanVkaWNpYWwuZW50aXR5JztcbmltcG9ydCB7IFNvbGljaXRhY2FvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvc29saWNpdGFjYW8uZW50aXR5JztcbmltcG9ydCB7IFNvbGljaXRhY2FvQ3JlYXRlRGV0ZXJtaW5hY2FvSnVkaWNpYWxEdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLWRldGVybWluYWNhby1qdWRpY2lhbC5kdG8nO1xuaW1wb3J0IHsgU29saWNpdGFjYW9VcGRhdGVEZXRlcm1pbmFjYW9KdWRpY2lhbER0byB9IGZyb20gJy4uL2R0by91cGRhdGUtZGV0ZXJtaW5hY2FvLWp1ZGljaWFsLmR0byc7XG5cbi8qKlxuICogU2VydmnDp28gZGUgRGV0ZXJtaW5hw6fDo28gSnVkaWNpYWxcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcG9yIGdlcmVuY2lhciBhcyBkZXRlcm1pbmHDp8O1ZXMganVkaWNpYWlzIHJlbGFjaW9uYWRhcyDDoHMgc29saWNpdGHDp8O1ZXNcbiAqIGRlIGJlbmVmw61jaW8sIHBlcm1pdGluZG8gbyBjb250cm9sZSBlIHJhc3RyZWFtZW50byBkZSBwcm9jZXNzb3MganVkaWNpYWlzLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGV0ZXJtaW5hY2FvSnVkaWNpYWxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKERldGVybWluYWNhb0p1ZGljaWFsU2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShEZXRlcm1pbmFjYW9KdWRpY2lhbClcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRldGVybWluYWNhb1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RGV0ZXJtaW5hY2FvSnVkaWNpYWw+LFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFNvbGljaXRhY2FvKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgc29saWNpdGFjYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFNvbGljaXRhY2FvPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGFTb3VyY2U6IERhdGFTb3VyY2UsXG4gICkge31cblxuICAvKipcbiAgICogQ3JpYSB1bWEgbm92YSBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbFxuICAgKiBAcGFyYW0gY3JlYXRlRGV0ZXJtaW5hY2FvRHRvIERhZG9zIGRhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGNyaWFuZG8gYSBkZXRlcm1pbmHDp8Ojb1xuICAgKiBAcmV0dXJucyBEZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCBjcmlhZGFcbiAgICovXG4gIGFzeW5jIGNyZWF0ZShcbiAgICBjcmVhdGVEZXRlcm1pbmFjYW9EdG86IFNvbGljaXRhY2FvQ3JlYXRlRGV0ZXJtaW5hY2FvSnVkaWNpYWxEdG8sXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8RGV0ZXJtaW5hY2FvSnVkaWNpYWw+IHtcbiAgICBjb25zdCBxdWVyeVJ1bm5lciA9IHRoaXMuZGF0YVNvdXJjZS5jcmVhdGVRdWVyeVJ1bm5lcigpO1xuICAgIGF3YWl0IHF1ZXJ5UnVubmVyLmNvbm5lY3QoKTtcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5zdGFydFRyYW5zYWN0aW9uKCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgc29saWNpdGHDp8OjbyBleGlzdGVcbiAgICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjcmVhdGVEZXRlcm1pbmFjYW9EdG8uc29saWNpdGFjYW9faWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXNvbGljaXRhY2FvKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbyBkZSBiZW5lZsOtY2lvIG7Do28gZW5jb250cmFkYScpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgasOhIGV4aXN0ZSBkZXRlcm1pbmHDp8OjbyBjb20gbyBtZXNtbyBuw7ptZXJvIGRlIHByb2Nlc3NvIHBhcmEgYSBzb2xpY2l0YcOnw6NvXG4gICAgICBjb25zdCBkZXRlcm1pbmFjYW9FeGlzdGVudGUgPSBhd2FpdCB0aGlzLmRldGVybWluYWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgc29saWNpdGFjYW9faWQ6IGNyZWF0ZURldGVybWluYWNhb0R0by5zb2xpY2l0YWNhb19pZCxcbiAgICAgICAgICBudW1lcm9fcHJvY2Vzc286IGNyZWF0ZURldGVybWluYWNhb0R0by5udW1lcm9fcHJvY2Vzc28sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGRldGVybWluYWNhb0V4aXN0ZW50ZSkge1xuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0rDoSBleGlzdGUgdW1hIGRldGVybWluYcOnw6NvIGp1ZGljaWFsIGNvbSBlc3RlIG7Dum1lcm8gZGUgcHJvY2Vzc28gcGFyYSBlc3RhIHNvbGljaXRhw6fDo28nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmlhciBhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gICAgICBjb25zdCBub3ZhRGV0ZXJtaW5hY2FvID0gdGhpcy5kZXRlcm1pbmFjYW9SZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAgIC4uLmNyZWF0ZURldGVybWluYWNhb0R0byxcbiAgICAgICAgdXN1YXJpb19pZDogdXN1YXJpb0lkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGRldGVybWluYWNhb1NhbHZhID1cbiAgICAgICAgYXdhaXQgcXVlcnlSdW5uZXIubWFuYWdlci5zYXZlKG5vdmFEZXRlcm1pbmFjYW8pO1xuXG4gICAgICAvLyBBdHVhbGl6YXIgYSBzb2xpY2l0YcOnw6NvIHBhcmEgaW5kaWNhciBxdWUgcG9zc3VpIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5tYW5hZ2VyLnVwZGF0ZShcbiAgICAgICAgU29saWNpdGFjYW8sXG4gICAgICAgIHsgaWQ6IGNyZWF0ZURldGVybWluYWNhb0R0by5zb2xpY2l0YWNhb19pZCB9LFxuICAgICAgICB7XG4gICAgICAgICAgZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2ZsYWc6IHRydWUsXG4gICAgICAgICAgZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkOiBkZXRlcm1pbmFjYW9TYWx2YS5pZCxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLmNvbW1pdFRyYW5zYWN0aW9uKCk7XG5cbiAgICAgIHJldHVybiBkZXRlcm1pbmFjYW9TYWx2YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIucm9sbGJhY2tUcmFuc2FjdGlvbigpO1xuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDb25mbGljdEV4Y2VwdGlvblxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gY3JpYXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gYW8gY3JpYXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwnLFxuICAgICAgKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIucmVsZWFzZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB0b2RhcyBhcyBkZXRlcm1pbmHDp8O1ZXMganVkaWNpYWlzIGRlIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHJldHVybnMgTGlzdGEgZGUgZGV0ZXJtaW5hw6fDtWVzIGp1ZGljaWFpc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5U29saWNpdGFjYW9JZChcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8RGV0ZXJtaW5hY2FvSnVkaWNpYWxbXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBzb2xpY2l0YcOnw6NvIGV4aXN0ZVxuICAgICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXNvbGljaXRhY2FvKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbyBkZSBiZW5lZsOtY2lvIG7Do28gZW5jb250cmFkYScpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5kZXRlcm1pbmFjYW9SZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgICB3aGVyZTogeyBzb2xpY2l0YWNhb19pZDogc29saWNpdGFjYW9JZCB9LFxuICAgICAgICBvcmRlcjogeyBkYXRhX2RldGVybWluYWNhbzogJ0RFU0MnIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBidXNjYXIgZGV0ZXJtaW5hw6fDtWVzIGp1ZGljaWFpczogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBhbyBidXNjYXIgZGV0ZXJtaW5hw6fDtWVzIGp1ZGljaWFpcycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB1bWEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgcGVsbyBJRFxuICAgKiBAcGFyYW0gaWQgSUQgZGEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICogQHJldHVybnMgRGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpOiBQcm9taXNlPERldGVybWluYWNhb0p1ZGljaWFsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRldGVybWluYWNhbyA9IGF3YWl0IHRoaXMuZGV0ZXJtaW5hY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgcmVsYXRpb25zOiBbJ3NvbGljaXRhY2FvJ10sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFkZXRlcm1pbmFjYW8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdEZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCBuw6NvIGVuY29udHJhZGEnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRldGVybWluYWNhbztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBidXNjYXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gYW8gYnVzY2FyIGRldGVybWluYcOnw6NvIGp1ZGljaWFsJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIHVtYSBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbFxuICAgKiBAcGFyYW0gaWQgSUQgZGEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICogQHBhcmFtIHVwZGF0ZURldGVybWluYWNhb0R0byBEYWRvcyBwYXJhIGF0dWFsaXphw6fDo29cbiAgICogQHJldHVybnMgRGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgYXR1YWxpemFkYVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlRGV0ZXJtaW5hY2FvRHRvOiBTb2xpY2l0YWNhb1VwZGF0ZURldGVybWluYWNhb0p1ZGljaWFsRHRvLFxuICApOiBQcm9taXNlPERldGVybWluYWNhb0p1ZGljaWFsPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBhIGRldGVybWluYcOnw6NvIGV4aXN0ZVxuICAgICAgY29uc3QgZGV0ZXJtaW5hY2FvID0gYXdhaXQgdGhpcy5kZXRlcm1pbmFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghZGV0ZXJtaW5hY2FvKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignRGV0ZXJtaW5hw6fDo28ganVkaWNpYWwgbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEF0dWFsaXphciBhIGRldGVybWluYcOnw6NvXG4gICAgICBhd2FpdCB0aGlzLmRldGVybWluYWNhb1JlcG9zaXRvcnkudXBkYXRlKGlkLCB1cGRhdGVEZXRlcm1pbmFjYW9EdG8pO1xuXG4gICAgICAvLyBSZXRvcm5hciBhIGRldGVybWluYcOnw6NvIGF0dWFsaXphZGFcbiAgICAgIHJldHVybiB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhdHVhbGl6YXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gYW8gYXR1YWxpemFyIGRldGVybWluYcOnw6NvIGp1ZGljaWFsJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdHJhIG8gY3VtcHJpbWVudG8gZGUgdW1hIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gICAqIEBwYXJhbSBpZCBJRCBkYSBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbFxuICAgKiBAcGFyYW0gb2JzZXJ2YWNvZXMgT2JzZXJ2YcOnw7VlcyBzb2JyZSBvIGN1bXByaW1lbnRvXG4gICAqIEByZXR1cm5zIERldGVybWluYcOnw6NvIGp1ZGljaWFsIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIHJlZ2lzdHJhckN1bXByaW1lbnRvKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgb2JzZXJ2YWNvZXM/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8RGV0ZXJtaW5hY2FvSnVkaWNpYWw+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgZGV0ZXJtaW5hw6fDo28gZXhpc3RlXG4gICAgICBjb25zdCBkZXRlcm1pbmFjYW8gPSBhd2FpdCB0aGlzLmRldGVybWluYWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFkZXRlcm1pbmFjYW8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdEZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCBuw6NvIGVuY29udHJhZGEnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXR1YWxpemFyIGEgZGV0ZXJtaW5hw6fDo28gY29tIGEgZGF0YSBkZSBjdW1wcmltZW50b1xuICAgICAgY29uc3QgdXBkYXRlRGF0YTogUGFydGlhbDxEZXRlcm1pbmFjYW9KdWRpY2lhbD4gPSB7XG4gICAgICAgIGRhdGFfY3VtcHJpbWVudG86IG5ldyBEYXRlKCksXG4gICAgICB9O1xuXG4gICAgICBpZiAob2JzZXJ2YWNvZXMpIHtcbiAgICAgICAgdXBkYXRlRGF0YS5vYnNlcnZhY2FvX2N1bXByaW1lbnRvID0gb2JzZXJ2YWNvZXM7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuZGV0ZXJtaW5hY2FvUmVwb3NpdG9yeS51cGRhdGUoaWQsIHVwZGF0ZURhdGEpO1xuXG4gICAgICAvLyBSZXRvcm5hciBhIGRldGVybWluYcOnw6NvIGF0dWFsaXphZGFcbiAgICAgIHJldHVybiB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyByZWdpc3RyYXIgY3VtcHJpbWVudG8gZGUgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gYW8gcmVnaXN0cmFyIGN1bXByaW1lbnRvIGRlIGRldGVybWluYcOnw6NvIGp1ZGljaWFsJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bWEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICogQHBhcmFtIGlkIElEIGRhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gICAqIEByZXR1cm5zIFZvaWRcbiAgICovXG4gIGFzeW5jIHJlbW92ZShpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcXVlcnlSdW5uZXIgPSB0aGlzLmRhdGFTb3VyY2UuY3JlYXRlUXVlcnlSdW5uZXIoKTtcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb25uZWN0KCk7XG4gICAgYXdhaXQgcXVlcnlSdW5uZXIuc3RhcnRUcmFuc2FjdGlvbigpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBhIGRldGVybWluYcOnw6NvIGV4aXN0ZVxuICAgICAgY29uc3QgZGV0ZXJtaW5hY2FvID0gYXdhaXQgdGhpcy5kZXRlcm1pbmFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICByZWxhdGlvbnM6IFsnc29saWNpdGFjYW8nXSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWRldGVybWluYWNhbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0RldGVybWluYcOnw6NvIGp1ZGljaWFsIG7Do28gZW5jb250cmFkYScpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2Ugw6kgYSBkZXRlcm1pbmHDp8OjbyBwcmluY2lwYWwgZGEgc29saWNpdGHDp8Ojb1xuICAgICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgICAgd2hlcmU6IHsgZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkOiBpZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChzb2xpY2l0YWNhbykge1xuICAgICAgICAvLyBTZSBmb3IgYSBkZXRlcm1pbmHDp8OjbyBwcmluY2lwYWwsIHZlcmlmaWNhciBzZSBow6Egb3V0cmFzIGRldGVybWluYcOnw7Vlc1xuICAgICAgICBjb25zdCBvdXRyYXNEZXRlcm1pbmFjb2VzID0gYXdhaXQgdGhpcy5kZXRlcm1pbmFjYW9SZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgICAgIHdoZXJlOiB7IHNvbGljaXRhY2FvX2lkOiBkZXRlcm1pbmFjYW8uc29saWNpdGFjYW9faWQgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKG91dHJhc0RldGVybWluYWNvZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgIC8vIFNlIGhvdXZlciBvdXRyYXMgZGV0ZXJtaW5hw6fDtWVzLCBkZWZpbmlyIGEgbWFpcyByZWNlbnRlIGNvbW8gcHJpbmNpcGFsXG4gICAgICAgICAgY29uc3Qgb3V0cmFzRGV0ZXJtaW5hY29lc09yZGVuYWRhcyA9IG91dHJhc0RldGVybWluYWNvZXNcbiAgICAgICAgICAgIC5maWx0ZXIoKGRldCkgPT4gZGV0LmlkICE9PSBpZClcbiAgICAgICAgICAgIC5zb3J0KFxuICAgICAgICAgICAgICAoYSwgYikgPT5cbiAgICAgICAgICAgICAgICBiLmRhdGFfZGV0ZXJtaW5hY2FvLmdldFRpbWUoKSAtIGEuZGF0YV9kZXRlcm1pbmFjYW8uZ2V0VGltZSgpLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIEF0dWFsaXphciBhIHNvbGljaXRhw6fDo28gY29tIGEgbm92YSBkZXRlcm1pbmHDp8OjbyBwcmluY2lwYWxcbiAgICAgICAgICBhd2FpdCBxdWVyeVJ1bm5lci5tYW5hZ2VyLnVwZGF0ZShcbiAgICAgICAgICAgIFNvbGljaXRhY2FvLFxuICAgICAgICAgICAgeyBpZDogZGV0ZXJtaW5hY2FvLnNvbGljaXRhY2FvX2lkIH0sXG4gICAgICAgICAgICB7IGRldGVybWluYWNhb19qdWRpY2lhbF9pZDogb3V0cmFzRGV0ZXJtaW5hY29lc09yZGVuYWRhc1swXS5pZCB9LFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gU2UgbsOjbyBob3V2ZXIgb3V0cmFzIGRldGVybWluYcOnw7VlcywgcmVtb3ZlciBhIHJlZmVyw6puY2lhIG5hIHNvbGljaXRhw6fDo29cbiAgICAgICAgICBhd2FpdCBxdWVyeVJ1bm5lci5tYW5hZ2VyLnVwZGF0ZShcbiAgICAgICAgICAgIFNvbGljaXRhY2FvLFxuICAgICAgICAgICAgeyBpZDogZGV0ZXJtaW5hY2FvLnNvbGljaXRhY2FvX2lkIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGRldGVybWluYWNhb19qdWRpY2lhbF9mbGFnOiBmYWxzZSxcbiAgICAgICAgICAgICAgZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkOiBudWxsIGFzIHVua25vd24gYXMgc3RyaW5nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbW92ZXIgYSBkZXRlcm1pbmHDp8Ojb1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIubWFuYWdlci5yZW1vdmUoZGV0ZXJtaW5hY2FvKTtcblxuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIuY29tbWl0VHJhbnNhY3Rpb24oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIucm9sbGJhY2tUcmFuc2FjdGlvbigpO1xuXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIHJlbW92ZXIgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gYW8gcmVtb3ZlciBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbCcsXG4gICAgICApO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5yZWxlYXNlKCk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=