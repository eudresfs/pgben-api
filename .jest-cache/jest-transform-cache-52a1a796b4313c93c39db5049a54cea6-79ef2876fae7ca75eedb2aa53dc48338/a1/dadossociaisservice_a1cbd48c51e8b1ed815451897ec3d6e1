63dac0bf39021435e7ef2a79f236543b
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var DadosSociaisService_1;
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DadosSociaisService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const dados_sociais_entity_1 = require("../../../entities/dados-sociais.entity");
const cidadao_entity_1 = require("../../../entities/cidadao.entity");
const composicao_familiar_entity_1 = require("../../../entities/composicao-familiar.entity");
const cache_service_1 = require("../../../shared/cache/cache.service");
const common_2 = require("@nestjs/common");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
/**
 * Service responsável pelo gerenciamento dos dados sociais dos cidadãos
 *
 * Implementa todas as operações CRUD para dados sociais, incluindo:
 * - Validações de negócio específicas
 * - Cálculos automáticos (renda per capita)
 * - Cache para otimização de performance
 * - Integração com auditoria
 */
let DadosSociaisService = DadosSociaisService_1 = class DadosSociaisService {
    dadosSociaisRepository;
    cidadaoRepository;
    composicaoFamiliarRepository;
    cacheService;
    dataSource;
    logger = new common_2.Logger(DadosSociaisService_1.name);
    CACHE_TTL = 300; // 5 minutos
    constructor(dadosSociaisRepository, cidadaoRepository, composicaoFamiliarRepository, cacheService, dataSource) {
        this.dadosSociaisRepository = dadosSociaisRepository;
        this.cidadaoRepository = cidadaoRepository;
        this.composicaoFamiliarRepository = composicaoFamiliarRepository;
        this.cacheService = cacheService;
        this.dataSource = dataSource;
    }
    /**
     * Cria dados sociais para um cidadão específico
     *
     * Valida se o cidadão existe e se não possui dados sociais já cadastrados.
     * Calcula automaticamente a renda per capita baseada na composição familiar.
     */
    async create(cidadaoId, createDadosSociaisDto) {
        this.logger.log(`Criando dados sociais para cidadão ${cidadaoId}`);
        // Usar transação para garantir consistência
        return await this.dataSource.transaction(async (manager) => {
            // Verificar se o cidadão existe
            const cidadao = await manager.findOne(cidadao_entity_1.Cidadao, {
                where: { id: cidadaoId },
            });
            if (!cidadao) {
                throw new common_1.NotFoundException(`Cidadão com ID ${cidadaoId} não encontrado`);
            }
            // Verificar se já existem dados sociais para este cidadão
            const dadosExistentes = await manager.findOne(dados_sociais_entity_1.DadosSociais, {
                where: { cidadao_id: cidadaoId },
                withDeleted: false,
            });
            if (dadosExistentes) {
                throw new common_1.ConflictException(`Cidadão ${cidadaoId} já possui dados sociais cadastrados`);
            }
            // Validar dados de benefícios
            this.validateBeneficiosData(createDadosSociaisDto);
            // Normalizar enums para minúsculo antes de criar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)({
                ...createDadosSociaisDto,
                cidadao_id: cidadaoId,
            });
            // Criar os dados sociais
            const dadosSociais = manager.create(dados_sociais_entity_1.DadosSociais, dadosNormalizados);
            const savedDadosSociais = await manager.save(dados_sociais_entity_1.DadosSociais, dadosSociais);
            // Calcular e atualizar renda per capita
            await this.calculateAndUpdateRendaPerCapita(cidadaoId, manager);
            // Invalidar cache
            await this.invalidateCache(cidadaoId);
            this.logger.log(`Dados sociais criados com sucesso para cidadão ${cidadaoId}`);
            return savedDadosSociais;
        });
    }
    /**
     * Busca os dados sociais de um cidadão específico
     *
     * Utiliza cache para otimizar performance em consultas frequentes.
     */
    async findByCidadaoId(cidadaoId) {
        this.logger.log(`Buscando dados sociais do cidadão ${cidadaoId}`);
        // Tentar buscar no cache primeiro
        const cacheKey = `dados-sociais:${cidadaoId}`;
        const cachedData = await this.cacheService.get(cacheKey);
        if (cachedData) {
            this.logger.log(`Dados sociais encontrados no cache para cidadão ${cidadaoId}`);
            return cachedData;
        }
        // Verificar se o cidadão existe
        const cidadao = await this.cidadaoRepository.findOne({
            where: { id: cidadaoId },
        });
        if (!cidadao) {
            throw new common_1.NotFoundException(`Cidadão com ID ${cidadaoId} não encontrado`);
        }
        // Buscar dados sociais
        const dadosSociais = await this.dadosSociaisRepository.findOne({
            where: { cidadao_id: cidadaoId },
            relations: ['cidadao'],
        });
        if (!dadosSociais) {
            throw new common_1.NotFoundException(`Dados sociais não encontrados para o cidadão ${cidadaoId}`);
        }
        // Armazenar no cache
        await this.cacheService.set(cacheKey, dadosSociais, this.CACHE_TTL);
        return dadosSociais;
    }
    /**
     * Atualiza os dados sociais de um cidadão
     *
     * Permite atualização parcial dos dados sociais.
     * Recalcula automaticamente valores derivados como renda per capita.
     */
    async update(cidadaoId, updateDadosSociaisDto) {
        this.logger.log(`Atualizando dados sociais do cidadão ${cidadaoId}`);
        return await this.dataSource.transaction(async (manager) => {
            // Buscar dados sociais existentes
            const dadosSociais = await manager.findOne(dados_sociais_entity_1.DadosSociais, {
                where: { cidadao_id: cidadaoId },
            });
            if (!dadosSociais) {
                throw new common_1.NotFoundException(`Dados sociais não encontrados para o cidadão ${cidadaoId}`);
            }
            // Validar dados de benefícios se estiverem sendo atualizados
            if (this.hasBeneficiosData(updateDadosSociaisDto)) {
                this.validateBeneficiosData({
                    ...dadosSociais,
                    ...updateDadosSociaisDto,
                });
            }
            // Normalizar enums para minúsculo antes de atualizar
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)(updateDadosSociaisDto);
            // Atualizar dados
            Object.assign(dadosSociais, dadosNormalizados);
            const updatedDadosSociais = await manager.save(dados_sociais_entity_1.DadosSociais, dadosSociais);
            // Recalcular renda per capita se a renda foi alterada
            if (updateDadosSociaisDto.renda !== undefined) {
                await this.calculateAndUpdateRendaPerCapita(cidadaoId, manager);
            }
            // Invalidar cache
            await this.invalidateCache(cidadaoId);
            this.logger.log(`Dados sociais atualizados com sucesso para cidadão ${cidadaoId}`);
            return updatedDadosSociais;
        });
    }
    /**
     * Remove os dados sociais de um cidadão
     *
     * Realiza soft delete dos dados sociais, mantendo histórico para auditoria.
     * Verifica dependências antes da remoção.
     */
    async remove(cidadaoId) {
        this.logger.log(`Removendo dados sociais do cidadão ${cidadaoId}`);
        return await this.dataSource.transaction(async (manager) => {
            // Buscar dados sociais existentes
            const dadosSociais = await manager.findOne(dados_sociais_entity_1.DadosSociais, {
                where: { cidadao_id: cidadaoId },
            });
            if (!dadosSociais) {
                throw new common_1.NotFoundException(`Dados sociais não encontrados para o cidadão ${cidadaoId}`);
            }
            // Verificar dependências (ex: solicitações ativas)
            await this.checkDependencies(cidadaoId, manager);
            // Realizar soft delete
            await manager.softDelete(dados_sociais_entity_1.DadosSociais, { cidadao_id: cidadaoId });
            // Invalidar cache
            await this.invalidateCache(cidadaoId);
            this.logger.log(`Dados sociais removidos com sucesso para cidadão ${cidadaoId}`);
        });
    }
    /**
     * Calcula e atualiza a renda per capita baseada na composição familiar
     */
    async calculateAndUpdateRendaPerCapita(cidadaoId, manager) {
        const repository = manager || this.dataSource.manager;
        // Buscar composição familiar
        const composicaoFamiliar = await repository.find(composicao_familiar_entity_1.ComposicaoFamiliar, {
            where: { cidadao_id: cidadaoId },
        });
        // Buscar dados sociais
        const dadosSociais = await repository.findOne(dados_sociais_entity_1.DadosSociais, {
            where: { cidadao_id: cidadaoId },
        });
        if (dadosSociais && dadosSociais.renda) {
            // Total de pessoas = cidadão + membros da família
            const totalPessoas = composicaoFamiliar.length + 1;
            const rendaPerCapita = dadosSociais.renda / totalPessoas;
            // Atualizar campo calculado (se existir na entidade)
            // Note: Este campo precisa ser adicionado à entidade se necessário
            this.logger.log(`Renda per capita calculada para cidadão ${cidadaoId}: R$ ${rendaPerCapita.toFixed(2)}`);
        }
    }
    /**
     * Valida dados de benefícios (PBF e BPC) com validações aprimoradas
     */
    validateBeneficiosData(data) {
        const errors = [];
        // Validar PBF com verificações mais robustas
        if (data.recebe_pbf === true) {
            if (!data.valor_pbf || data.valor_pbf <= 0) {
                errors.push('Valor do PBF é obrigatório e deve ser maior que zero quando recebe_pbf é verdadeiro');
            }
            else if (data.valor_pbf > 10000) {
                errors.push('Valor do PBF não pode exceder R$ 10.000,00');
            }
            else if (data.valor_pbf < 50) {
                errors.push('Valor do PBF parece muito baixo. Verifique se o valor está correto (mínimo R$ 50,00)');
            }
        }
        if (data.recebe_pbf === false && data.valor_pbf) {
            if (data.valor_pbf > 0) {
                errors.push('Valor do PBF não deve ser informado quando recebe_pbf é falso');
            }
        }
        // Validar BPC com verificações mais robustas
        if (data.recebe_bpc === true) {
            if (!data.valor_bpc || data.valor_bpc <= 0) {
                errors.push('Valor do BPC é obrigatório e deve ser maior que zero quando recebe_bpc é verdadeiro');
            }
            else if (data.valor_bpc > 10000) {
                errors.push('Valor do BPC não pode exceder R$ 10.000,00');
            }
            if (!data.tipo_bpc || data.tipo_bpc.trim().length === 0) {
                errors.push('Tipo do BPC é obrigatório quando recebe_bpc é verdadeiro');
            }
            else if (data.tipo_bpc.length > 100) {
                errors.push('Tipo do BPC deve ter no máximo 100 caracteres');
            }
        }
        if (data.recebe_bpc === false) {
            if (data.valor_bpc && data.valor_bpc > 0) {
                errors.push('Valor do BPC não deve ser informado quando recebe_bpc é falso');
            }
            if (data.tipo_bpc && data.tipo_bpc.trim().length > 0) {
                errors.push('Tipo do BPC não deve ser informado quando recebe_bpc é falso');
            }
        }
        // Validação de consistência entre benefícios
        if (data.recebe_pbf === true && data.recebe_bpc === true) {
            this.logger.warn(`Cidadão recebe tanto PBF quanto BPC - verificar elegibilidade`);
        }
        // Lançar erro com todas as validações que falharam
        if (errors.length > 0) {
            throw new common_1.BadRequestException({
                message: 'Dados de benefícios inválidos',
                errors: errors,
                statusCode: 400,
            });
        }
    }
    /**
     * Verifica se o DTO contém dados de benefícios
     */
    hasBeneficiosData(data) {
        return (data.recebe_pbf !== undefined ||
            data.valor_pbf !== undefined ||
            data.recebe_bpc !== undefined ||
            data.valor_bpc !== undefined ||
            data.tipo_bpc !== undefined);
    }
    /**
     * Verifica dependências antes da remoção
     */
    async checkDependencies(cidadaoId, manager) {
        // Aqui você pode adicionar verificações específicas
        // Por exemplo: verificar se há solicitações ativas
        // const solicitacoesAtivas = await manager.count(Solicitacao, {
        //   where: { cidadao_id: cidadaoId, status: 'ATIVA' }
        // });
        //
        // if (solicitacoesAtivas > 0) {
        //   throw new ConflictException(
        //     'Não é possível remover dados sociais de cidadão com solicitações ativas'
        //   );
        // }
        this.logger.log(`Verificação de dependências concluída para cidadão ${cidadaoId}`);
    }
    /**
     * Invalida cache relacionado aos dados sociais
     */
    async invalidateCache(cidadaoId) {
        const cacheKey = `dados-sociais:${cidadaoId}`;
        await this.cacheService.del(cacheKey);
        // Invalidar outros caches relacionados se necessário
        await this.cacheService.del(`cidadao:${cidadaoId}`);
    }
};
exports.DadosSociaisService = DadosSociaisService;
exports.DadosSociaisService = DadosSociaisService = DadosSociaisService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(dados_sociais_entity_1.DadosSociais)),
    __param(1, (0, typeorm_1.InjectRepository)(cidadao_entity_1.Cidadao)),
    __param(2, (0, typeorm_1.InjectRepository)(composicao_familiar_entity_1.ComposicaoFamiliar)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof cache_service_1.CacheService !== "undefined" && cache_service_1.CacheService) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _e : Object])
], DadosSociaisService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHNlcnZpY2VzXFxkYWRvcy1zb2NpYWlzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FLd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUFpRDtBQUNqRCxpRkFBc0U7QUFDdEUscUVBQTJEO0FBQzNELDZGQUFrRjtBQUdsRix1RUFBbUU7QUFDbkUsMkNBQXdDO0FBQ3hDLHFGQUFpRjtBQUVqRjs7Ozs7Ozs7R0FRRztBQUVJLElBQU0sbUJBQW1CLDJCQUF6QixNQUFNLG1CQUFtQjtJQU1YO0lBRUE7SUFFQTtJQUNBO0lBQ0E7SUFYRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMscUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxDQUFDLFlBQVk7SUFFOUMsWUFFbUIsc0JBQWdELEVBRWhELGlCQUFzQyxFQUV0Qyw0QkFBNEQsRUFDNUQsWUFBMEIsRUFDMUIsVUFBc0I7UUFOdEIsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUEwQjtRQUVoRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBRXRDLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBZ0M7UUFDNUQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtJQUN0QyxDQUFDO0lBRUo7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsTUFBTSxDQUNWLFNBQWlCLEVBQ2pCLHFCQUE0QztRQUU1QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUVuRSw0Q0FBNEM7UUFDNUMsT0FBTyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUN6RCxnQ0FBZ0M7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SUFBQSwwQkFBZ0IsRUFBQywrQ0FBa0IsQ0FBQyxDQUFBO3lEQUhJLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVmLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVDLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUMxQiw0QkFBWSxvQkFBWiw0QkFBWSxvREFDZCxvQkFBVSxvQkFBVixvQkFBVTtHQVo5QixtQkFBbUIsQ0FxWC9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxjaWRhZGFvXFxzZXJ2aWNlc1xcZGFkb3Mtc29jaWFpcy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBDb25mbGljdEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBEYXRhU291cmNlIH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBEYWRvc1NvY2lhaXMgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9kYWRvcy1zb2NpYWlzLmVudGl0eSc7XG5pbXBvcnQgeyBDaWRhZGFvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY2lkYWRhby5lbnRpdHknO1xuaW1wb3J0IHsgQ29tcG9zaWNhb0ZhbWlsaWFyIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY29tcG9zaWNhby1mYW1pbGlhci5lbnRpdHknO1xuaW1wb3J0IHsgQ3JlYXRlRGFkb3NTb2NpYWlzRHRvIH0gZnJvbSAnLi4vZHRvL2NyZWF0ZS1kYWRvcy1zb2NpYWlzLmR0byc7XG5pbXBvcnQgeyBVcGRhdGVEYWRvc1NvY2lhaXNEdG8gfSBmcm9tICcuLi9kdG8vdXBkYXRlLWRhZG9zLXNvY2lhaXMuZHRvJztcbmltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9jYWNoZS9jYWNoZS5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IG5vcm1hbGl6ZUVudW1GaWVsZHMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvZW51bS1ub3JtYWxpemVyLnV0aWwnO1xuXG4vKipcbiAqIFNlcnZpY2UgcmVzcG9uc8OhdmVsIHBlbG8gZ2VyZW5jaWFtZW50byBkb3MgZGFkb3Mgc29jaWFpcyBkb3MgY2lkYWTDo29zXG4gKlxuICogSW1wbGVtZW50YSB0b2RhcyBhcyBvcGVyYcOnw7VlcyBDUlVEIHBhcmEgZGFkb3Mgc29jaWFpcywgaW5jbHVpbmRvOlxuICogLSBWYWxpZGHDp8O1ZXMgZGUgbmVnw7NjaW8gZXNwZWPDrWZpY2FzXG4gKiAtIEPDoWxjdWxvcyBhdXRvbcOhdGljb3MgKHJlbmRhIHBlciBjYXBpdGEpXG4gKiAtIENhY2hlIHBhcmEgb3RpbWl6YcOnw6NvIGRlIHBlcmZvcm1hbmNlXG4gKiAtIEludGVncmHDp8OjbyBjb20gYXVkaXRvcmlhXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEYWRvc1NvY2lhaXNTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKERhZG9zU29jaWFpc1NlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FDSEVfVFRMID0gMzAwOyAvLyA1IG1pbnV0b3NcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShEYWRvc1NvY2lhaXMpXG4gICAgcHJpdmF0ZSByZWFkb25seSBkYWRvc1NvY2lhaXNSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PERhZG9zU29jaWFpcz4sXG4gICAgQEluamVjdFJlcG9zaXRvcnkoQ2lkYWRhbylcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNpZGFkYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PENpZGFkYW8+LFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KENvbXBvc2ljYW9GYW1pbGlhcilcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXBvc2ljYW9GYW1pbGlhclJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Q29tcG9zaWNhb0ZhbWlsaWFyPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVNvdXJjZTogRGF0YVNvdXJjZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBDcmlhIGRhZG9zIHNvY2lhaXMgcGFyYSB1bSBjaWRhZMOjbyBlc3BlY8OtZmljb1xuICAgKlxuICAgKiBWYWxpZGEgc2UgbyBjaWRhZMOjbyBleGlzdGUgZSBzZSBuw6NvIHBvc3N1aSBkYWRvcyBzb2NpYWlzIGrDoSBjYWRhc3RyYWRvcy5cbiAgICogQ2FsY3VsYSBhdXRvbWF0aWNhbWVudGUgYSByZW5kYSBwZXIgY2FwaXRhIGJhc2VhZGEgbmEgY29tcG9zacOnw6NvIGZhbWlsaWFyLlxuICAgKi9cbiAgYXN5bmMgY3JlYXRlKFxuICAgIGNpZGFkYW9JZDogc3RyaW5nLFxuICAgIGNyZWF0ZURhZG9zU29jaWFpc0R0bzogQ3JlYXRlRGFkb3NTb2NpYWlzRHRvLFxuICApOiBQcm9taXNlPERhZG9zU29jaWFpcz4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgQ3JpYW5kbyBkYWRvcyBzb2NpYWlzIHBhcmEgY2lkYWTDo28gJHtjaWRhZGFvSWR9YCk7XG5cbiAgICAvLyBVc2FyIHRyYW5zYcOnw6NvIHBhcmEgZ2FyYW50aXIgY29uc2lzdMOqbmNpYVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudHJhbnNhY3Rpb24oYXN5bmMgKG1hbmFnZXIpID0+IHtcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvIGNpZGFkw6NvIGV4aXN0ZVxuICAgICAgY29uc3QgY2lkYWRhbyA9IGF3YWl0IG1hbmFnZXIuZmluZE9uZShDaWRhZGFvLCB7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjaWRhZGFvSWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWNpZGFkYW8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFxuICAgICAgICAgIGBDaWRhZMOjbyBjb20gSUQgJHtjaWRhZGFvSWR9IG7Do28gZW5jb250cmFkb2AsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlbSBkYWRvcyBzb2NpYWlzIHBhcmEgZXN0ZSBjaWRhZMOjb1xuICAgICAgY29uc3QgZGFkb3NFeGlzdGVudGVzID0gYXdhaXQgbWFuYWdlci5maW5kT25lKERhZG9zU29jaWFpcywge1xuICAgICAgICB3aGVyZTogeyBjaWRhZGFvX2lkOiBjaWRhZGFvSWQgfSxcbiAgICAgICAgd2l0aERlbGV0ZWQ6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChkYWRvc0V4aXN0ZW50ZXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgIGBDaWRhZMOjbyAke2NpZGFkYW9JZH0gasOhIHBvc3N1aSBkYWRvcyBzb2NpYWlzIGNhZGFzdHJhZG9zYCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhciBkYWRvcyBkZSBiZW5lZsOtY2lvc1xuICAgICAgdGhpcy52YWxpZGF0ZUJlbmVmaWNpb3NEYXRhKGNyZWF0ZURhZG9zU29jaWFpc0R0byk7XG5cbiAgICAgIC8vIE5vcm1hbGl6YXIgZW51bXMgcGFyYSBtaW7DunNjdWxvIGFudGVzIGRlIGNyaWFyXG4gICAgICBjb25zdCBkYWRvc05vcm1hbGl6YWRvcyA9IG5vcm1hbGl6ZUVudW1GaWVsZHMoe1xuICAgICAgICAuLi5jcmVhdGVEYWRvc1NvY2lhaXNEdG8sXG4gICAgICAgIGNpZGFkYW9faWQ6IGNpZGFkYW9JZCxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDcmlhciBvcyBkYWRvcyBzb2NpYWlzXG4gICAgICBjb25zdCBkYWRvc1NvY2lhaXMgPSBtYW5hZ2VyLmNyZWF0ZShEYWRvc1NvY2lhaXMsIGRhZG9zTm9ybWFsaXphZG9zKTtcblxuICAgICAgY29uc3Qgc2F2ZWREYWRvc1NvY2lhaXMgPSBhd2FpdCBtYW5hZ2VyLnNhdmUoRGFkb3NTb2NpYWlzLCBkYWRvc1NvY2lhaXMpO1xuXG4gICAgICAvLyBDYWxjdWxhciBlIGF0dWFsaXphciByZW5kYSBwZXIgY2FwaXRhXG4gICAgICBhd2FpdCB0aGlzLmNhbGN1bGF0ZUFuZFVwZGF0ZVJlbmRhUGVyQ2FwaXRhKGNpZGFkYW9JZCwgbWFuYWdlcik7XG5cbiAgICAgIC8vIEludmFsaWRhciBjYWNoZVxuICAgICAgYXdhaXQgdGhpcy5pbnZhbGlkYXRlQ2FjaGUoY2lkYWRhb0lkKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgRGFkb3Mgc29jaWFpcyBjcmlhZG9zIGNvbSBzdWNlc3NvIHBhcmEgY2lkYWTDo28gJHtjaWRhZGFvSWR9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gc2F2ZWREYWRvc1NvY2lhaXM7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2Egb3MgZGFkb3Mgc29jaWFpcyBkZSB1bSBjaWRhZMOjbyBlc3BlY8OtZmljb1xuICAgKlxuICAgKiBVdGlsaXphIGNhY2hlIHBhcmEgb3RpbWl6YXIgcGVyZm9ybWFuY2UgZW0gY29uc3VsdGFzIGZyZXF1ZW50ZXMuXG4gICAqL1xuICBhc3luYyBmaW5kQnlDaWRhZGFvSWQoY2lkYWRhb0lkOiBzdHJpbmcpOiBQcm9taXNlPERhZG9zU29jaWFpcz4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgQnVzY2FuZG8gZGFkb3Mgc29jaWFpcyBkbyBjaWRhZMOjbyAke2NpZGFkYW9JZH1gKTtcblxuICAgIC8vIFRlbnRhciBidXNjYXIgbm8gY2FjaGUgcHJpbWVpcm9cbiAgICBjb25zdCBjYWNoZUtleSA9IGBkYWRvcy1zb2NpYWlzOiR7Y2lkYWRhb0lkfWA7XG4gICAgY29uc3QgY2FjaGVkRGF0YSA9IGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmdldChjYWNoZUtleSk7XG5cbiAgICBpZiAoY2FjaGVkRGF0YSkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgRGFkb3Mgc29jaWFpcyBlbmNvbnRyYWRvcyBubyBjYWNoZSBwYXJhIGNpZGFkw6NvICR7Y2lkYWRhb0lkfWAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIGNhY2hlZERhdGEgYXMgRGFkb3NTb2NpYWlzO1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciBzZSBvIGNpZGFkw6NvIGV4aXN0ZVxuICAgIGNvbnN0IGNpZGFkYW8gPSBhd2FpdCB0aGlzLmNpZGFkYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGNpZGFkYW9JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFjaWRhZGFvKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYENpZGFkw6NvIGNvbSBJRCAke2NpZGFkYW9JZH0gbsOjbyBlbmNvbnRyYWRvYCk7XG4gICAgfVxuXG4gICAgLy8gQnVzY2FyIGRhZG9zIHNvY2lhaXNcbiAgICBjb25zdCBkYWRvc1NvY2lhaXMgPSBhd2FpdCB0aGlzLmRhZG9zU29jaWFpc1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBjaWRhZGFvX2lkOiBjaWRhZGFvSWQgfSxcbiAgICAgIHJlbGF0aW9uczogWydjaWRhZGFvJ10sXG4gICAgfSk7XG5cbiAgICBpZiAoIWRhZG9zU29jaWFpcykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFxuICAgICAgICBgRGFkb3Mgc29jaWFpcyBuw6NvIGVuY29udHJhZG9zIHBhcmEgbyBjaWRhZMOjbyAke2NpZGFkYW9JZH1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBBcm1hemVuYXIgbm8gY2FjaGVcbiAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoY2FjaGVLZXksIGRhZG9zU29jaWFpcywgdGhpcy5DQUNIRV9UVEwpO1xuXG4gICAgcmV0dXJuIGRhZG9zU29jaWFpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHVhbGl6YSBvcyBkYWRvcyBzb2NpYWlzIGRlIHVtIGNpZGFkw6NvXG4gICAqXG4gICAqIFBlcm1pdGUgYXR1YWxpemHDp8OjbyBwYXJjaWFsIGRvcyBkYWRvcyBzb2NpYWlzLlxuICAgKiBSZWNhbGN1bGEgYXV0b21hdGljYW1lbnRlIHZhbG9yZXMgZGVyaXZhZG9zIGNvbW8gcmVuZGEgcGVyIGNhcGl0YS5cbiAgICovXG4gIGFzeW5jIHVwZGF0ZShcbiAgICBjaWRhZGFvSWQ6IHN0cmluZyxcbiAgICB1cGRhdGVEYWRvc1NvY2lhaXNEdG86IFVwZGF0ZURhZG9zU29jaWFpc0R0byxcbiAgKTogUHJvbWlzZTxEYWRvc1NvY2lhaXM+IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coYEF0dWFsaXphbmRvIGRhZG9zIHNvY2lhaXMgZG8gY2lkYWTDo28gJHtjaWRhZGFvSWR9YCk7XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAvLyBCdXNjYXIgZGFkb3Mgc29jaWFpcyBleGlzdGVudGVzXG4gICAgICBjb25zdCBkYWRvc1NvY2lhaXMgPSBhd2FpdCBtYW5hZ2VyLmZpbmRPbmUoRGFkb3NTb2NpYWlzLCB7XG4gICAgICAgIHdoZXJlOiB7IGNpZGFkYW9faWQ6IGNpZGFkYW9JZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghZGFkb3NTb2NpYWlzKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgICBgRGFkb3Mgc29jaWFpcyBuw6NvIGVuY29udHJhZG9zIHBhcmEgbyBjaWRhZMOjbyAke2NpZGFkYW9JZH1gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGFyIGRhZG9zIGRlIGJlbmVmw61jaW9zIHNlIGVzdGl2ZXJlbSBzZW5kbyBhdHVhbGl6YWRvc1xuICAgICAgaWYgKHRoaXMuaGFzQmVuZWZpY2lvc0RhdGEodXBkYXRlRGFkb3NTb2NpYWlzRHRvKSkge1xuICAgICAgICB0aGlzLnZhbGlkYXRlQmVuZWZpY2lvc0RhdGEoe1xuICAgICAgICAgIC4uLmRhZG9zU29jaWFpcyxcbiAgICAgICAgICAuLi51cGRhdGVEYWRvc1NvY2lhaXNEdG8sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBOb3JtYWxpemFyIGVudW1zIHBhcmEgbWluw7pzY3VsbyBhbnRlcyBkZSBhdHVhbGl6YXJcbiAgICAgIGNvbnN0IGRhZG9zTm9ybWFsaXphZG9zID0gbm9ybWFsaXplRW51bUZpZWxkcyh1cGRhdGVEYWRvc1NvY2lhaXNEdG8pO1xuXG4gICAgICAvLyBBdHVhbGl6YXIgZGFkb3NcbiAgICAgIE9iamVjdC5hc3NpZ24oZGFkb3NTb2NpYWlzLCBkYWRvc05vcm1hbGl6YWRvcyk7XG4gICAgICBjb25zdCB1cGRhdGVkRGFkb3NTb2NpYWlzID0gYXdhaXQgbWFuYWdlci5zYXZlKFxuICAgICAgICBEYWRvc1NvY2lhaXMsXG4gICAgICAgIGRhZG9zU29jaWFpcyxcbiAgICAgICk7XG5cbiAgICAgIC8vIFJlY2FsY3VsYXIgcmVuZGEgcGVyIGNhcGl0YSBzZSBhIHJlbmRhIGZvaSBhbHRlcmFkYVxuICAgICAgaWYgKHVwZGF0ZURhZG9zU29jaWFpc0R0by5yZW5kYSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2FsY3VsYXRlQW5kVXBkYXRlUmVuZGFQZXJDYXBpdGEoY2lkYWRhb0lkLCBtYW5hZ2VyKTtcbiAgICAgIH1cblxuICAgICAgLy8gSW52YWxpZGFyIGNhY2hlXG4gICAgICBhd2FpdCB0aGlzLmludmFsaWRhdGVDYWNoZShjaWRhZGFvSWQpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBEYWRvcyBzb2NpYWlzIGF0dWFsaXphZG9zIGNvbSBzdWNlc3NvIHBhcmEgY2lkYWTDo28gJHtjaWRhZGFvSWR9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gdXBkYXRlZERhZG9zU29jaWFpcztcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgb3MgZGFkb3Mgc29jaWFpcyBkZSB1bSBjaWRhZMOjb1xuICAgKlxuICAgKiBSZWFsaXphIHNvZnQgZGVsZXRlIGRvcyBkYWRvcyBzb2NpYWlzLCBtYW50ZW5kbyBoaXN0w7NyaWNvIHBhcmEgYXVkaXRvcmlhLlxuICAgKiBWZXJpZmljYSBkZXBlbmTDqm5jaWFzIGFudGVzIGRhIHJlbW/Dp8Ojby5cbiAgICovXG4gIGFzeW5jIHJlbW92ZShjaWRhZGFvSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgUmVtb3ZlbmRvIGRhZG9zIHNvY2lhaXMgZG8gY2lkYWTDo28gJHtjaWRhZGFvSWR9YCk7XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRyYW5zYWN0aW9uKGFzeW5jIChtYW5hZ2VyKSA9PiB7XG4gICAgICAvLyBCdXNjYXIgZGFkb3Mgc29jaWFpcyBleGlzdGVudGVzXG4gICAgICBjb25zdCBkYWRvc1NvY2lhaXMgPSBhd2FpdCBtYW5hZ2VyLmZpbmRPbmUoRGFkb3NTb2NpYWlzLCB7XG4gICAgICAgIHdoZXJlOiB7IGNpZGFkYW9faWQ6IGNpZGFkYW9JZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghZGFkb3NTb2NpYWlzKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgICBgRGFkb3Mgc29jaWFpcyBuw6NvIGVuY29udHJhZG9zIHBhcmEgbyBjaWRhZMOjbyAke2NpZGFkYW9JZH1gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgZGVwZW5kw6puY2lhcyAoZXg6IHNvbGljaXRhw6fDtWVzIGF0aXZhcylcbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tEZXBlbmRlbmNpZXMoY2lkYWRhb0lkLCBtYW5hZ2VyKTtcblxuICAgICAgLy8gUmVhbGl6YXIgc29mdCBkZWxldGVcbiAgICAgIGF3YWl0IG1hbmFnZXIuc29mdERlbGV0ZShEYWRvc1NvY2lhaXMsIHsgY2lkYWRhb19pZDogY2lkYWRhb0lkIH0pO1xuXG4gICAgICAvLyBJbnZhbGlkYXIgY2FjaGVcbiAgICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZUNhY2hlKGNpZGFkYW9JZCk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYERhZG9zIHNvY2lhaXMgcmVtb3ZpZG9zIGNvbSBzdWNlc3NvIHBhcmEgY2lkYWTDo28gJHtjaWRhZGFvSWR9YCxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBlIGF0dWFsaXphIGEgcmVuZGEgcGVyIGNhcGl0YSBiYXNlYWRhIG5hIGNvbXBvc2nDp8OjbyBmYW1pbGlhclxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjYWxjdWxhdGVBbmRVcGRhdGVSZW5kYVBlckNhcGl0YShcbiAgICBjaWRhZGFvSWQ6IHN0cmluZyxcbiAgICBtYW5hZ2VyPzogYW55LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gbWFuYWdlciB8fCB0aGlzLmRhdGFTb3VyY2UubWFuYWdlcjtcblxuICAgIC8vIEJ1c2NhciBjb21wb3Npw6fDo28gZmFtaWxpYXJcbiAgICBjb25zdCBjb21wb3NpY2FvRmFtaWxpYXIgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmQoQ29tcG9zaWNhb0ZhbWlsaWFyLCB7XG4gICAgICB3aGVyZTogeyBjaWRhZGFvX2lkOiBjaWRhZGFvSWQgfSxcbiAgICB9KTtcblxuICAgIC8vIEJ1c2NhciBkYWRvcyBzb2NpYWlzXG4gICAgY29uc3QgZGFkb3NTb2NpYWlzID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kT25lKERhZG9zU29jaWFpcywge1xuICAgICAgd2hlcmU6IHsgY2lkYWRhb19pZDogY2lkYWRhb0lkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoZGFkb3NTb2NpYWlzICYmIGRhZG9zU29jaWFpcy5yZW5kYSkge1xuICAgICAgLy8gVG90YWwgZGUgcGVzc29hcyA9IGNpZGFkw6NvICsgbWVtYnJvcyBkYSBmYW3DrWxpYVxuICAgICAgY29uc3QgdG90YWxQZXNzb2FzID0gY29tcG9zaWNhb0ZhbWlsaWFyLmxlbmd0aCArIDE7XG4gICAgICBjb25zdCByZW5kYVBlckNhcGl0YSA9IGRhZG9zU29jaWFpcy5yZW5kYSAvIHRvdGFsUGVzc29hcztcblxuICAgICAgLy8gQXR1YWxpemFyIGNhbXBvIGNhbGN1bGFkbyAoc2UgZXhpc3RpciBuYSBlbnRpZGFkZSlcbiAgICAgIC8vIE5vdGU6IEVzdGUgY2FtcG8gcHJlY2lzYSBzZXIgYWRpY2lvbmFkbyDDoCBlbnRpZGFkZSBzZSBuZWNlc3PDoXJpb1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgUmVuZGEgcGVyIGNhcGl0YSBjYWxjdWxhZGEgcGFyYSBjaWRhZMOjbyAke2NpZGFkYW9JZH06IFIkICR7cmVuZGFQZXJDYXBpdGEudG9GaXhlZCgyKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIGRhZG9zIGRlIGJlbmVmw61jaW9zIChQQkYgZSBCUEMpIGNvbSB2YWxpZGHDp8O1ZXMgYXByaW1vcmFkYXNcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVCZW5lZmljaW9zRGF0YShkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBWYWxpZGFyIFBCRiBjb20gdmVyaWZpY2HDp8O1ZXMgbWFpcyByb2J1c3Rhc1xuICAgIGlmIChkYXRhLnJlY2ViZV9wYmYgPT09IHRydWUpIHtcbiAgICAgIGlmICghZGF0YS52YWxvcl9wYmYgfHwgZGF0YS52YWxvcl9wYmYgPD0gMCkge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICAnVmFsb3IgZG8gUEJGIMOpIG9icmlnYXTDs3JpbyBlIGRldmUgc2VyIG1haW9yIHF1ZSB6ZXJvIHF1YW5kbyByZWNlYmVfcGJmIMOpIHZlcmRhZGVpcm8nLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChkYXRhLnZhbG9yX3BiZiA+IDEwMDAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdWYWxvciBkbyBQQkYgbsOjbyBwb2RlIGV4Y2VkZXIgUiQgMTAuMDAwLDAwJyk7XG4gICAgICB9IGVsc2UgaWYgKGRhdGEudmFsb3JfcGJmIDwgNTApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgJ1ZhbG9yIGRvIFBCRiBwYXJlY2UgbXVpdG8gYmFpeG8uIFZlcmlmaXF1ZSBzZSBvIHZhbG9yIGVzdMOhIGNvcnJldG8gKG3DrW5pbW8gUiQgNTAsMDApJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZGF0YS5yZWNlYmVfcGJmID09PSBmYWxzZSAmJiBkYXRhLnZhbG9yX3BiZikge1xuICAgICAgaWYgKGRhdGEudmFsb3JfcGJmID4gMCkge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICAnVmFsb3IgZG8gUEJGIG7Do28gZGV2ZSBzZXIgaW5mb3JtYWRvIHF1YW5kbyByZWNlYmVfcGJmIMOpIGZhbHNvJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBWYWxpZGFyIEJQQyBjb20gdmVyaWZpY2HDp8O1ZXMgbWFpcyByb2J1c3Rhc1xuICAgIGlmIChkYXRhLnJlY2ViZV9icGMgPT09IHRydWUpIHtcbiAgICAgIGlmICghZGF0YS52YWxvcl9icGMgfHwgZGF0YS52YWxvcl9icGMgPD0gMCkge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICAnVmFsb3IgZG8gQlBDIMOpIG9icmlnYXTDs3JpbyBlIGRldmUgc2VyIG1haW9yIHF1ZSB6ZXJvIHF1YW5kbyByZWNlYmVfYnBjIMOpIHZlcmRhZGVpcm8nLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChkYXRhLnZhbG9yX2JwYyA+IDEwMDAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdWYWxvciBkbyBCUEMgbsOjbyBwb2RlIGV4Y2VkZXIgUiQgMTAuMDAwLDAwJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghZGF0YS50aXBvX2JwYyB8fCBkYXRhLnRpcG9fYnBjLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ1RpcG8gZG8gQlBDIMOpIG9icmlnYXTDs3JpbyBxdWFuZG8gcmVjZWJlX2JwYyDDqSB2ZXJkYWRlaXJvJyk7XG4gICAgICB9IGVsc2UgaWYgKGRhdGEudGlwb19icGMubGVuZ3RoID4gMTAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdUaXBvIGRvIEJQQyBkZXZlIHRlciBubyBtw6F4aW1vIDEwMCBjYXJhY3RlcmVzJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGRhdGEucmVjZWJlX2JwYyA9PT0gZmFsc2UpIHtcbiAgICAgIGlmIChkYXRhLnZhbG9yX2JwYyAmJiBkYXRhLnZhbG9yX2JwYyA+IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgJ1ZhbG9yIGRvIEJQQyBuw6NvIGRldmUgc2VyIGluZm9ybWFkbyBxdWFuZG8gcmVjZWJlX2JwYyDDqSBmYWxzbycsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS50aXBvX2JwYyAmJiBkYXRhLnRpcG9fYnBjLnRyaW0oKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgICdUaXBvIGRvIEJQQyBuw6NvIGRldmUgc2VyIGluZm9ybWFkbyBxdWFuZG8gcmVjZWJlX2JwYyDDqSBmYWxzbycsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhw6fDo28gZGUgY29uc2lzdMOqbmNpYSBlbnRyZSBiZW5lZsOtY2lvc1xuICAgIGlmIChkYXRhLnJlY2ViZV9wYmYgPT09IHRydWUgJiYgZGF0YS5yZWNlYmVfYnBjID09PSB0cnVlKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgQ2lkYWTDo28gcmVjZWJlIHRhbnRvIFBCRiBxdWFudG8gQlBDIC0gdmVyaWZpY2FyIGVsZWdpYmlsaWRhZGVgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBMYW7Dp2FyIGVycm8gY29tIHRvZGFzIGFzIHZhbGlkYcOnw7VlcyBxdWUgZmFsaGFyYW1cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKHtcbiAgICAgICAgbWVzc2FnZTogJ0RhZG9zIGRlIGJlbmVmw61jaW9zIGludsOhbGlkb3MnLFxuICAgICAgICBlcnJvcnM6IGVycm9ycyxcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gRFRPIGNvbnTDqW0gZGFkb3MgZGUgYmVuZWbDrWNpb3NcbiAgICovXG4gIHByaXZhdGUgaGFzQmVuZWZpY2lvc0RhdGEoZGF0YTogVXBkYXRlRGFkb3NTb2NpYWlzRHRvKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIGRhdGEucmVjZWJlX3BiZiAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICBkYXRhLnZhbG9yX3BiZiAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICBkYXRhLnJlY2ViZV9icGMgIT09IHVuZGVmaW5lZCB8fFxuICAgICAgZGF0YS52YWxvcl9icGMgIT09IHVuZGVmaW5lZCB8fFxuICAgICAgZGF0YS50aXBvX2JwYyAhPT0gdW5kZWZpbmVkXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBkZXBlbmTDqm5jaWFzIGFudGVzIGRhIHJlbW/Dp8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjaGVja0RlcGVuZGVuY2llcyhcbiAgICBjaWRhZGFvSWQ6IHN0cmluZyxcbiAgICBtYW5hZ2VyOiBhbnksXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEFxdWkgdm9jw6ogcG9kZSBhZGljaW9uYXIgdmVyaWZpY2HDp8O1ZXMgZXNwZWPDrWZpY2FzXG4gICAgLy8gUG9yIGV4ZW1wbG86IHZlcmlmaWNhciBzZSBow6Egc29saWNpdGHDp8O1ZXMgYXRpdmFzXG4gICAgLy8gY29uc3Qgc29saWNpdGFjb2VzQXRpdmFzID0gYXdhaXQgbWFuYWdlci5jb3VudChTb2xpY2l0YWNhbywge1xuICAgIC8vICAgd2hlcmU6IHsgY2lkYWRhb19pZDogY2lkYWRhb0lkLCBzdGF0dXM6ICdBVElWQScgfVxuICAgIC8vIH0pO1xuICAgIC8vXG4gICAgLy8gaWYgKHNvbGljaXRhY29lc0F0aXZhcyA+IDApIHtcbiAgICAvLyAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbihcbiAgICAvLyAgICAgJ07Do28gw6kgcG9zc8OtdmVsIHJlbW92ZXIgZGFkb3Mgc29jaWFpcyBkZSBjaWRhZMOjbyBjb20gc29saWNpdGHDp8O1ZXMgYXRpdmFzJ1xuICAgIC8vICAgKTtcbiAgICAvLyB9XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgVmVyaWZpY2HDp8OjbyBkZSBkZXBlbmTDqm5jaWFzIGNvbmNsdcOtZGEgcGFyYSBjaWRhZMOjbyAke2NpZGFkYW9JZH1gLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogSW52YWxpZGEgY2FjaGUgcmVsYWNpb25hZG8gYW9zIGRhZG9zIHNvY2lhaXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaW52YWxpZGF0ZUNhY2hlKGNpZGFkYW9JZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBgZGFkb3Mtc29jaWFpczoke2NpZGFkYW9JZH1gO1xuICAgIGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChjYWNoZUtleSk7XG5cbiAgICAvLyBJbnZhbGlkYXIgb3V0cm9zIGNhY2hlcyByZWxhY2lvbmFkb3Mgc2UgbmVjZXNzw6FyaW9cbiAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5kZWwoYGNpZGFkYW86JHtjaWRhZGFvSWR9YCk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==