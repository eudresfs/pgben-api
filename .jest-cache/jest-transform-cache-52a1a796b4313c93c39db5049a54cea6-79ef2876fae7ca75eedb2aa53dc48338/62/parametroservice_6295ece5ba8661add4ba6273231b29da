6ba93ce2571d27f4f7960a53cf3644c0
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ParametroService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ParametroService = void 0;
const common_1 = require("@nestjs/common");
const parametro_repository_1 = require("../repositories/parametro.repository");
const parametro_entity_1 = require("../../../entities/parametro.entity");
const parametro_response_dto_1 = require("../dtos/parametro/parametro-response.dto");
const parametro_nao_encontrado_exception_1 = require("../exceptions/parametro-nao-encontrado.exception");
const parametro_tipo_invalido_exception_1 = require("../exceptions/parametro-tipo-invalido.exception");
const parametro_tipo_enum_1 = require("../../../enums/parametro-tipo.enum");
const converters_1 = require("../util/converters");
const exceptions_1 = require("../../../shared/exceptions");
/**
 * Serviço para gerenciamento de parâmetros do sistema
 *
 * Responsável por:
 * - Operações CRUD para parâmetros
 * - Sistema de cache para otimização
 * - Conversão de tipos dinâmica
 * - Validação de parâmetros
 */
let ParametroService = ParametroService_1 = class ParametroService {
    parametroRepository;
    logger = new common_1.Logger(ParametroService_1.name);
    // Cache em memória para parâmetros (chave -> valor)
    cache = new Map();
    // Tempo padrão de expiração do cache em milissegundos (5 minutos)
    CACHE_TTL = 5 * 60 * 1000;
    constructor(parametroRepository) {
        this.parametroRepository = parametroRepository;
    }
    /**
     * Limpa todo o cache de parâmetros
     */
    limparCache() {
        this.cache.clear();
        this.logger.log('Cache de parâmetros limpo');
    }
    /**
     * Remove um item específico do cache
     * @param chave Chave do parâmetro a ser removido do cache
     */
    invalidarCache(chave) {
        this.cache.delete(chave);
        this.logger.debug(`Cache para parâmetro '${chave}' invalidado`);
    }
    /**
     * Busca todos os parâmetros, convertendo-os para DTOs de resposta
     * @param categoria Categoria opcional para filtrar
     * @returns Lista de DTOs de resposta de parâmetros
     */
    async buscarTodos(categoria) {
        const parametros = await this.parametroRepository.findAll(categoria);
        return parametros.map(p => this.mapearParaDto(p));
    }
    /**
     * Busca um parâmetro por sua chave
     * @param chave Chave do parâmetro
     * @returns DTO de resposta do parâmetro
     * @throws ParametroNaoEncontradoException se o parâmetro não existir
     */
    async buscarPorChave(chave) {
        const parametro = await this.parametroRepository.findByChave(chave);
        if (!parametro) {
            throw new parametro_nao_encontrado_exception_1.ParametroNaoEncontradoException(chave);
        }
        return this.mapearParaDto(parametro);
    }
    /**
     * Cria um novo parâmetro
     * @param dto DTO com dados para criação
     * @returns DTO de resposta do parâmetro criado
     */
    async criar(dto) {
        // Verificar se já existe parâmetro com mesma chave
        const existente = await this.parametroRepository.existsByChave(dto.chave);
        if (existente) {
            throw new exceptions_1.ValidationErrorException('chave', dto.chave, 'string', `Parâmetro com chave '${dto.chave}' já existe`);
        }
        // Converter valor para string antes de salvar
        const valorString = converters_1.ParametroConverter.paraString(dto.valor, dto.tipo);
        const parametro = new parametro_entity_1.Parametro();
        parametro.chave = dto.chave;
        parametro.descricao = dto.descricao;
        parametro.tipo = dto.tipo;
        parametro.valor = valorString;
        parametro.categoria = dto.categoria;
        // Escopo e editável não estão presentes na entidade Parametro ainda
        const salvo = await this.parametroRepository.save(parametro);
        return this.mapearParaDto(salvo);
    }
    /**
     * Atualiza um parâmetro existente
     * @param chave Chave do parâmetro
     * @param dto DTO com dados para atualização
     * @returns DTO de resposta do parâmetro atualizado
     * @throws ParametroNaoEncontradoException se o parâmetro não existir
     */
    async atualizar(chave, dto) {
        const parametro = await this.parametroRepository.findByChave(chave);
        if (!parametro) {
            throw new parametro_nao_encontrado_exception_1.ParametroNaoEncontradoException(chave);
        }
        // Verificar se o parâmetro é editável (implementação futura)
        const editavel = true; // Placeholder para implementação futura
        if (!editavel) {
            throw new exceptions_1.InvalidOperationException('editar parâmetro', `Parâmetro '${chave}' não é editável`, 'não editável', 'editável');
        }
        // Converter valor para string antes de salvar (se fornecido)
        if (dto.valor !== undefined) {
            parametro.valor = converters_1.ParametroConverter.paraString(dto.valor, parametro.tipo);
        }
        if (dto.descricao !== undefined) {
            parametro.descricao = dto.descricao;
        }
        if (dto.categoria !== undefined) {
            parametro.categoria = dto.categoria;
        }
        // Escopo será implementado posteriormente
        // if (dto.escopo !== undefined) {
        //   parametro.escopo = dto.escopo;
        // }
        const salvo = await this.parametroRepository.save(parametro);
        // Invalidar cache para este parâmetro
        this.invalidarCache(chave);
        return this.mapearParaDto(salvo);
    }
    /**
     * Remove um parâmetro
     * @param chave Chave do parâmetro
     * @throws ParametroNaoEncontradoException se o parâmetro não existir
     */
    async remover(chave) {
        const parametro = await this.parametroRepository.findByChave(chave);
        if (!parametro) {
            throw new parametro_nao_encontrado_exception_1.ParametroNaoEncontradoException(chave);
        }
        // Verificar se o parâmetro é editável (implementação futura)
        const editavel = true; // Placeholder para implementação futura
        if (!editavel) {
            throw new exceptions_1.InvalidOperationException('remover parâmetro', `Parâmetro '${chave}' não pode ser removido pois não é editável`, 'não editável', 'editável');
        }
        await this.parametroRepository.remove(parametro.id);
        // Invalidar cache para este parâmetro
        this.invalidarCache(chave);
        this.logger.log(`Parâmetro '${chave}' removido`);
    }
    /**
     * Busca o valor tipado de um parâmetro
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional caso o parâmetro não exista
     * @returns Valor do parâmetro com tipo correto
     */
    async obterValor(chave, padrao) {
        try {
            // Verificar se está no cache
            const cacheItem = this.cache.get(chave);
            if (cacheItem && cacheItem.expiraEm > Date.now()) {
                return cacheItem.valor;
            }
            const parametro = await this.parametroRepository.findByChave(chave);
            if (!parametro) {
                if (padrao !== undefined) {
                    return padrao;
                }
                throw new parametro_nao_encontrado_exception_1.ParametroNaoEncontradoException(chave);
            }
            // Converter para o tipo correto
            const valorConvertido = converters_1.ParametroConverter.paraValorTipado(chave, parametro.valor, parametro.tipo);
            // Armazenar no cache
            this.cache.set(chave, {
                valor: valorConvertido,
                expiraEm: Date.now() + this.CACHE_TTL
            });
            return valorConvertido;
        }
        catch (error) {
            if (error instanceof parametro_nao_encontrado_exception_1.ParametroNaoEncontradoException && padrao !== undefined) {
                return padrao;
            }
            throw error;
        }
    }
    /**
     * Busca um valor booleano
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional
     * @returns Valor booleano
     */
    async obterBooleano(chave, padrao) {
        const valor = await this.obterValor(chave, padrao);
        if (typeof valor === 'boolean') {
            return valor;
        }
        throw new parametro_tipo_invalido_exception_1.ParametroTipoInvalidoException(chave, valor, parametro_tipo_enum_1.ParametroTipoEnum.BOOLEAN);
    }
    /**
     * Busca um valor numérico
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional
     * @returns Valor numérico
     */
    async obterNumero(chave, padrao) {
        const valor = await this.obterValor(chave, padrao);
        if (typeof valor === 'number') {
            return valor;
        }
        throw new parametro_tipo_invalido_exception_1.ParametroTipoInvalidoException(chave, valor, parametro_tipo_enum_1.ParametroTipoEnum.NUMBER);
    }
    /**
     * Busca um valor string
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional
     * @returns Valor string
     */
    async obterTexto(chave, padrao) {
        const valor = await this.obterValor(chave, padrao);
        if (typeof valor === 'string') {
            return valor;
        }
        throw new parametro_tipo_invalido_exception_1.ParametroTipoInvalidoException(chave, valor, parametro_tipo_enum_1.ParametroTipoEnum.STRING);
    }
    /**
     * Busca um valor data
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional
     * @returns Valor data
     */
    async obterData(chave, padrao) {
        const valor = await this.obterValor(chave, padrao);
        if (valor instanceof Date) {
            return valor;
        }
        throw new parametro_tipo_invalido_exception_1.ParametroTipoInvalidoException(chave, valor, parametro_tipo_enum_1.ParametroTipoEnum.DATE);
    }
    /**
     * Busca um valor JSON
     * @param chave Chave do parâmetro
     * @param padrao Valor padrão opcional
     * @returns Valor JSON (objeto ou array)
     */
    async obterJson(chave, padrao) {
        const valor = await this.obterValor(chave, padrao);
        if (typeof valor === 'object') {
            return valor;
        }
        throw new parametro_tipo_invalido_exception_1.ParametroTipoInvalidoException(chave, valor, parametro_tipo_enum_1.ParametroTipoEnum.JSON);
    }
    /**
     * Define um tempo personalizado para expiração do cache
     * @param ttlMs Tempo de vida em milissegundos
     */
    definirTempoCacheMs(ttlMs) {
        if (ttlMs <= 0) {
            throw new exceptions_1.ValidationErrorException('ttlMs', ttlMs, 'number', 'Tempo de cache deve ser maior que zero');
        }
        this.logger.log(`Tempo de cache alterado para ${ttlMs}ms`);
    }
    /**
     * Converte uma entidade Parametro para um DTO de resposta
     * @param parametro Entidade a ser convertida
     * @returns DTO de resposta
     */
    mapearParaDto(parametro) {
        const dto = new parametro_response_dto_1.ParametroResponseDto();
        dto.chave = parametro.chave;
        dto.descricao = parametro.descricao;
        dto.tipo = parametro.tipo;
        dto.valor = converters_1.ParametroConverter.paraValorTipado(parametro.chave, parametro.valor, parametro.tipo);
        dto.valor_formatado = converters_1.ParametroConverter.formatarParaExibicao(dto.valor, parametro.tipo);
        dto.categoria = parametro.categoria;
        // Escopo e editável serão implementados posteriormente
        // dto.escopo = parametro.escopo;
        // dto.editavel = parametro.editavel;
        dto.created_at = parametro.created_at;
        dto.updated_at = parametro.updated_at;
        return dto;
    }
};
exports.ParametroService = ParametroService;
exports.ParametroService = ParametroService = ParametroService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof parametro_repository_1.ParametroRepository !== "undefined" && parametro_repository_1.ParametroRepository) === "function" ? _a : Object])
], ParametroService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNvbmZpZ3VyYWNhb1xcc2VydmljZXNcXHBhcmFtZXRyby5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELCtFQUEyRTtBQUMzRSx5RUFBK0Q7QUFHL0QscUZBQWdGO0FBQ2hGLHlHQUFtRztBQUNuRyx1R0FBaUc7QUFDakcsNEVBQXVFO0FBQ3ZFLG1EQUF3RDtBQUN4RCwyREFBaUc7QUFFakc7Ozs7Ozs7O0dBUUc7QUFFSSxJQUFNLGdCQUFnQix3QkFBdEIsTUFBTSxnQkFBZ0I7SUFTRTtJQVJaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxrQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU1RCxvREFBb0Q7SUFDNUMsS0FBSyxHQUFrRCxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRXpFLGtFQUFrRTtJQUNqRCxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFFM0MsWUFBNkIsbUJBQXdDO1FBQXhDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7SUFBRyxDQUFDO0lBRXpFOztPQUVHO0lBQ0gsV0FBVztRQUNULElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsY0FBYyxDQUFDLEtBQWE7UUFDMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEtBQUssY0FBYyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsV0FBVyxDQUFDLFNBQWtCO1FBQ2xDLE1B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QyxNQUFNLEdBQUcsR0FBRyxJQUFJLDZDQUFvQixFQUFFLENBQUM7UUFDdkMsR0FBRyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQzVCLEdBQUcsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQztRQUNwQyxHQUFHLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDMUIsR0FBRyxDQUFDLEtBQUssR0FBRywrQkFBa0IsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRyxHQUFHLENBQUMsZUFBZSxHQUFHLCtCQUFrQixDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pGLEdBQUcsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQztRQUNwQyx1REFBdUQ7UUFDdkQsaUNBQWlDO1FBQ2pDLHFDQUFxQztRQUNyQyxHQUFHLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUM7UUFDdEMsR0FBRyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDO1FBQ3RDLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztDQUNGLENBQUE7QUF0VFksNENBQWdCOzJCQUFoQixnQkFBZ0I7SUFENUIsSUFBQSxtQkFBVSxHQUFFO3lEQVV1QywwQ0FBbUIsb0JBQW5CLDBDQUFtQjtHQVQxRCxnQkFBZ0IsQ0FzVDVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxjb25maWd1cmFjYW9cXHNlcnZpY2VzXFxwYXJhbWV0cm8uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQYXJhbWV0cm9SZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yaWVzL3BhcmFtZXRyby5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFBhcmFtZXRybyB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3BhcmFtZXRyby5lbnRpdHknO1xuaW1wb3J0IHsgUGFyYW1ldHJvQ3JlYXRlRHRvIH0gZnJvbSAnLi4vZHRvcy9wYXJhbWV0cm8vcGFyYW1ldHJvLWNyZWF0ZS5kdG8nO1xuaW1wb3J0IHsgUGFyYW1ldHJvVXBkYXRlRHRvIH0gZnJvbSAnLi4vZHRvcy9wYXJhbWV0cm8vcGFyYW1ldHJvLXVwZGF0ZS5kdG8nO1xuaW1wb3J0IHsgUGFyYW1ldHJvUmVzcG9uc2VEdG8gfSBmcm9tICcuLi9kdG9zL3BhcmFtZXRyby9wYXJhbWV0cm8tcmVzcG9uc2UuZHRvJztcbmltcG9ydCB7IFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24gfSBmcm9tICcuLi9leGNlcHRpb25zL3BhcmFtZXRyby1uYW8tZW5jb250cmFkby5leGNlcHRpb24nO1xuaW1wb3J0IHsgUGFyYW1ldHJvVGlwb0ludmFsaWRvRXhjZXB0aW9uIH0gZnJvbSAnLi4vZXhjZXB0aW9ucy9wYXJhbWV0cm8tdGlwby1pbnZhbGlkby5leGNlcHRpb24nO1xuaW1wb3J0IHsgUGFyYW1ldHJvVGlwb0VudW0gfSBmcm9tICcuLi8uLi8uLi9lbnVtcy9wYXJhbWV0cm8tdGlwby5lbnVtJztcbmltcG9ydCB7IFBhcmFtZXRyb0NvbnZlcnRlciB9IGZyb20gJy4uL3V0aWwvY29udmVydGVycyc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3JFeGNlcHRpb24sIEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24gfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvZXhjZXB0aW9ucyc7XG5cbi8qKlxuICogU2VydmnDp28gcGFyYSBnZXJlbmNpYW1lbnRvIGRlIHBhcsOibWV0cm9zIGRvIHNpc3RlbWFcbiAqIFxuICogUmVzcG9uc8OhdmVsIHBvcjpcbiAqIC0gT3BlcmHDp8O1ZXMgQ1JVRCBwYXJhIHBhcsOibWV0cm9zXG4gKiAtIFNpc3RlbWEgZGUgY2FjaGUgcGFyYSBvdGltaXphw6fDo29cbiAqIC0gQ29udmVyc8OjbyBkZSB0aXBvcyBkaW7Dom1pY2FcbiAqIC0gVmFsaWRhw6fDo28gZGUgcGFyw6JtZXRyb3NcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBhcmFtZXRyb1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoUGFyYW1ldHJvU2VydmljZS5uYW1lKTtcbiAgXG4gIC8vIENhY2hlIGVtIG1lbcOzcmlhIHBhcmEgcGFyw6JtZXRyb3MgKGNoYXZlIC0+IHZhbG9yKVxuICBwcml2YXRlIGNhY2hlOiBNYXA8c3RyaW5nLCB7IHZhbG9yOiBhbnk7IGV4cGlyYUVtOiBudW1iZXIgfT4gPSBuZXcgTWFwKCk7XG4gIFxuICAvLyBUZW1wbyBwYWRyw6NvIGRlIGV4cGlyYcOnw6NvIGRvIGNhY2hlIGVtIG1pbGlzc2VndW5kb3MgKDUgbWludXRvcylcbiAgcHJpdmF0ZSByZWFkb25seSBDQUNIRV9UVEwgPSA1ICogNjAgKiAxMDAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcGFyYW1ldHJvUmVwb3NpdG9yeTogUGFyYW1ldHJvUmVwb3NpdG9yeSkge31cblxuICAvKipcbiAgICogTGltcGEgdG9kbyBvIGNhY2hlIGRlIHBhcsOibWV0cm9zXG4gICAqL1xuICBsaW1wYXJDYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gICAgdGhpcy5sb2dnZXIubG9nKCdDYWNoZSBkZSBwYXLDom1ldHJvcyBsaW1wbycpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bSBpdGVtIGVzcGVjw61maWNvIGRvIGNhY2hlXG4gICAqIEBwYXJhbSBjaGF2ZSBDaGF2ZSBkbyBwYXLDom1ldHJvIGEgc2VyIHJlbW92aWRvIGRvIGNhY2hlXG4gICAqL1xuICBpbnZhbGlkYXJDYWNoZShjaGF2ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5jYWNoZS5kZWxldGUoY2hhdmUpO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDYWNoZSBwYXJhIHBhcsOibWV0cm8gJyR7Y2hhdmV9JyBpbnZhbGlkYWRvYCk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdG9kb3Mgb3MgcGFyw6JtZXRyb3MsIGNvbnZlcnRlbmRvLW9zIHBhcmEgRFRPcyBkZSByZXNwb3N0YVxuICAgKiBAcGFyYW0gY2F0ZWdvcmlhIENhdGVnb3JpYSBvcGNpb25hbCBwYXJhIGZpbHRyYXJcbiAgICogQHJldHVybnMgTGlzdGEgZGUgRFRPcyBkZSByZXNwb3N0YSBkZSBwYXLDom1ldHJvc1xuICAgKi9cbiAgYXN5bmMgYnVzY2FyVG9kb3MoY2F0ZWdvcmlhPzogc3RyaW5nKTogUHJvbWlzZTxQYXJhbWV0cm9SZXNwb25zZUR0b1tdPiB7XG4gICAgY29uc3QgcGFyYW1ldHJvcyA9IGF3YWl0IHRoaXMucGFyYW1ldHJvUmVwb3NpdG9yeS5maW5kQWxsKGNhdGVnb3JpYSk7XG4gICAgcmV0dXJuIHBhcmFtZXRyb3MubWFwKHAgPT4gdGhpcy5tYXBlYXJQYXJhRHRvKHApKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB1bSBwYXLDom1ldHJvIHBvciBzdWEgY2hhdmVcbiAgICogQHBhcmFtIGNoYXZlIENoYXZlIGRvIHBhcsOibWV0cm9cbiAgICogQHJldHVybnMgRFRPIGRlIHJlc3Bvc3RhIGRvIHBhcsOibWV0cm9cbiAgICogQHRocm93cyBQYXJhbWV0cm9OYW9FbmNvbnRyYWRvRXhjZXB0aW9uIHNlIG8gcGFyw6JtZXRybyBuw6NvIGV4aXN0aXJcbiAgICovXG4gIGFzeW5jIGJ1c2NhclBvckNoYXZlKGNoYXZlOiBzdHJpbmcpOiBQcm9taXNlPFBhcmFtZXRyb1Jlc3BvbnNlRHRvPiB7XG4gICAgY29uc3QgcGFyYW1ldHJvID0gYXdhaXQgdGhpcy5wYXJhbWV0cm9SZXBvc2l0b3J5LmZpbmRCeUNoYXZlKGNoYXZlKTtcbiAgICBpZiAoIXBhcmFtZXRybykge1xuICAgICAgdGhyb3cgbmV3IFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24oY2hhdmUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5tYXBlYXJQYXJhRHRvKHBhcmFtZXRybyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBub3ZvIHBhcsOibWV0cm9cbiAgICogQHBhcmFtIGR0byBEVE8gY29tIGRhZG9zIHBhcmEgY3JpYcOnw6NvXG4gICAqIEByZXR1cm5zIERUTyBkZSByZXNwb3N0YSBkbyBwYXLDom1ldHJvIGNyaWFkb1xuICAgKi9cbiAgYXN5bmMgY3JpYXIoZHRvOiBQYXJhbWV0cm9DcmVhdGVEdG8pOiBQcm9taXNlPFBhcmFtZXRyb1Jlc3BvbnNlRHRvPiB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIGrDoSBleGlzdGUgcGFyw6JtZXRybyBjb20gbWVzbWEgY2hhdmVcbiAgICBjb25zdCBleGlzdGVudGUgPSBhd2FpdCB0aGlzLnBhcmFtZXRyb1JlcG9zaXRvcnkuZXhpc3RzQnlDaGF2ZShkdG8uY2hhdmUpO1xuICAgIGlmIChleGlzdGVudGUpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdjaGF2ZScsXG4gICAgICAgIGR0by5jaGF2ZSxcbiAgICAgICAgJ3N0cmluZycsXG4gICAgICAgIGBQYXLDom1ldHJvIGNvbSBjaGF2ZSAnJHtkdG8uY2hhdmV9JyBqw6EgZXhpc3RlYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0ZXIgdmFsb3IgcGFyYSBzdHJpbmcgYW50ZXMgZGUgc2FsdmFyXG4gICAgY29uc3QgdmFsb3JTdHJpbmcgPSBQYXJhbWV0cm9Db252ZXJ0ZXIucGFyYVN0cmluZyhkdG8udmFsb3IsIGR0by50aXBvKTtcblxuICAgIGNvbnN0IHBhcmFtZXRybyA9IG5ldyBQYXJhbWV0cm8oKTtcbiAgICBwYXJhbWV0cm8uY2hhdmUgPSBkdG8uY2hhdmU7XG4gICAgcGFyYW1ldHJvLmRlc2NyaWNhbyA9IGR0by5kZXNjcmljYW87XG4gICAgcGFyYW1ldHJvLnRpcG8gPSBkdG8udGlwbztcbiAgICBwYXJhbWV0cm8udmFsb3IgPSB2YWxvclN0cmluZztcbiAgICBwYXJhbWV0cm8uY2F0ZWdvcmlhID0gZHRvLmNhdGVnb3JpYTtcbiAgICAvLyBFc2NvcG8gZSBlZGl0w6F2ZWwgbsOjbyBlc3TDo28gcHJlc2VudGVzIG5hIGVudGlkYWRlIFBhcmFtZXRybyBhaW5kYVxuXG4gICAgY29uc3Qgc2Fsdm8gPSBhd2FpdCB0aGlzLnBhcmFtZXRyb1JlcG9zaXRvcnkuc2F2ZShwYXJhbWV0cm8pO1xuICAgIHJldHVybiB0aGlzLm1hcGVhclBhcmFEdG8oc2Fsdm8pO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIHVtIHBhcsOibWV0cm8gZXhpc3RlbnRlXG4gICAqIEBwYXJhbSBjaGF2ZSBDaGF2ZSBkbyBwYXLDom1ldHJvXG4gICAqIEBwYXJhbSBkdG8gRFRPIGNvbSBkYWRvcyBwYXJhIGF0dWFsaXphw6fDo29cbiAgICogQHJldHVybnMgRFRPIGRlIHJlc3Bvc3RhIGRvIHBhcsOibWV0cm8gYXR1YWxpemFkb1xuICAgKiBAdGhyb3dzIFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24gc2UgbyBwYXLDom1ldHJvIG7Do28gZXhpc3RpclxuICAgKi9cbiAgYXN5bmMgYXR1YWxpemFyKGNoYXZlOiBzdHJpbmcsIGR0bzogUGFyYW1ldHJvVXBkYXRlRHRvKTogUHJvbWlzZTxQYXJhbWV0cm9SZXNwb25zZUR0bz4ge1xuICAgIGNvbnN0IHBhcmFtZXRybyA9IGF3YWl0IHRoaXMucGFyYW1ldHJvUmVwb3NpdG9yeS5maW5kQnlDaGF2ZShjaGF2ZSk7XG4gICAgaWYgKCFwYXJhbWV0cm8pIHtcbiAgICAgIHRocm93IG5ldyBQYXJhbWV0cm9OYW9FbmNvbnRyYWRvRXhjZXB0aW9uKGNoYXZlKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyBwYXLDom1ldHJvIMOpIGVkaXTDoXZlbCAoaW1wbGVtZW50YcOnw6NvIGZ1dHVyYSlcbiAgICBjb25zdCBlZGl0YXZlbCA9IHRydWU7IC8vIFBsYWNlaG9sZGVyIHBhcmEgaW1wbGVtZW50YcOnw6NvIGZ1dHVyYVxuICAgIGlmICghZWRpdGF2ZWwpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKFxuICAgICAgICAnZWRpdGFyIHBhcsOibWV0cm8nLFxuICAgICAgICBgUGFyw6JtZXRybyAnJHtjaGF2ZX0nIG7Do28gw6kgZWRpdMOhdmVsYCxcbiAgICAgICAgJ27Do28gZWRpdMOhdmVsJyxcbiAgICAgICAgJ2VkaXTDoXZlbCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ29udmVydGVyIHZhbG9yIHBhcmEgc3RyaW5nIGFudGVzIGRlIHNhbHZhciAoc2UgZm9ybmVjaWRvKVxuICAgIGlmIChkdG8udmFsb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcGFyYW1ldHJvLnZhbG9yID0gUGFyYW1ldHJvQ29udmVydGVyLnBhcmFTdHJpbmcoZHRvLnZhbG9yLCBwYXJhbWV0cm8udGlwbyk7XG4gICAgfVxuXG4gICAgaWYgKGR0by5kZXNjcmljYW8gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcGFyYW1ldHJvLmRlc2NyaWNhbyA9IGR0by5kZXNjcmljYW87XG4gICAgfVxuXG4gICAgaWYgKGR0by5jYXRlZ29yaWEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcGFyYW1ldHJvLmNhdGVnb3JpYSA9IGR0by5jYXRlZ29yaWE7XG4gICAgfVxuXG4gICAgLy8gRXNjb3BvIHNlcsOhIGltcGxlbWVudGFkbyBwb3N0ZXJpb3JtZW50ZVxuICAgIC8vIGlmIChkdG8uZXNjb3BvICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyAgIHBhcmFtZXRyby5lc2NvcG8gPSBkdG8uZXNjb3BvO1xuICAgIC8vIH1cblxuICAgIGNvbnN0IHNhbHZvID0gYXdhaXQgdGhpcy5wYXJhbWV0cm9SZXBvc2l0b3J5LnNhdmUocGFyYW1ldHJvKTtcbiAgICBcbiAgICAvLyBJbnZhbGlkYXIgY2FjaGUgcGFyYSBlc3RlIHBhcsOibWV0cm9cbiAgICB0aGlzLmludmFsaWRhckNhY2hlKGNoYXZlKTtcbiAgICBcbiAgICByZXR1cm4gdGhpcy5tYXBlYXJQYXJhRHRvKHNhbHZvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdW0gcGFyw6JtZXRyb1xuICAgKiBAcGFyYW0gY2hhdmUgQ2hhdmUgZG8gcGFyw6JtZXRyb1xuICAgKiBAdGhyb3dzIFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24gc2UgbyBwYXLDom1ldHJvIG7Do28gZXhpc3RpclxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlcihjaGF2ZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcGFyYW1ldHJvID0gYXdhaXQgdGhpcy5wYXJhbWV0cm9SZXBvc2l0b3J5LmZpbmRCeUNoYXZlKGNoYXZlKTtcbiAgICBpZiAoIXBhcmFtZXRybykge1xuICAgICAgdGhyb3cgbmV3IFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24oY2hhdmUpO1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciBzZSBvIHBhcsOibWV0cm8gw6kgZWRpdMOhdmVsIChpbXBsZW1lbnRhw6fDo28gZnV0dXJhKVxuICAgIGNvbnN0IGVkaXRhdmVsID0gdHJ1ZTsgLy8gUGxhY2Vob2xkZXIgcGFyYSBpbXBsZW1lbnRhw6fDo28gZnV0dXJhXG4gICAgaWYgKCFlZGl0YXZlbCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oXG4gICAgICAgICdyZW1vdmVyIHBhcsOibWV0cm8nLFxuICAgICAgICBgUGFyw6JtZXRybyAnJHtjaGF2ZX0nIG7Do28gcG9kZSBzZXIgcmVtb3ZpZG8gcG9pcyBuw6NvIMOpIGVkaXTDoXZlbGAsXG4gICAgICAgICduw6NvIGVkaXTDoXZlbCcsXG4gICAgICAgICdlZGl0w6F2ZWwnXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucGFyYW1ldHJvUmVwb3NpdG9yeS5yZW1vdmUocGFyYW1ldHJvLmlkIGFzIHVua25vd24gYXMgbnVtYmVyKTtcbiAgICBcbiAgICAvLyBJbnZhbGlkYXIgY2FjaGUgcGFyYSBlc3RlIHBhcsOibWV0cm9cbiAgICB0aGlzLmludmFsaWRhckNhY2hlKGNoYXZlKTtcbiAgICBcbiAgICB0aGlzLmxvZ2dlci5sb2coYFBhcsOibWV0cm8gJyR7Y2hhdmV9JyByZW1vdmlkb2ApO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIG8gdmFsb3IgdGlwYWRvIGRlIHVtIHBhcsOibWV0cm9cbiAgICogQHBhcmFtIGNoYXZlIENoYXZlIGRvIHBhcsOibWV0cm9cbiAgICogQHBhcmFtIHBhZHJhbyBWYWxvciBwYWRyw6NvIG9wY2lvbmFsIGNhc28gbyBwYXLDom1ldHJvIG7Do28gZXhpc3RhXG4gICAqIEByZXR1cm5zIFZhbG9yIGRvIHBhcsOibWV0cm8gY29tIHRpcG8gY29ycmV0b1xuICAgKi9cbiAgYXN5bmMgb2J0ZXJWYWxvcjxUPihjaGF2ZTogc3RyaW5nLCBwYWRyYW8/OiBUKTogUHJvbWlzZTxUPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBlc3TDoSBubyBjYWNoZVxuICAgICAgY29uc3QgY2FjaGVJdGVtID0gdGhpcy5jYWNoZS5nZXQoY2hhdmUpO1xuICAgICAgaWYgKGNhY2hlSXRlbSAmJiBjYWNoZUl0ZW0uZXhwaXJhRW0gPiBEYXRlLm5vdygpKSB7XG4gICAgICAgIHJldHVybiBjYWNoZUl0ZW0udmFsb3IgYXMgVDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFyYW1ldHJvID0gYXdhaXQgdGhpcy5wYXJhbWV0cm9SZXBvc2l0b3J5LmZpbmRCeUNoYXZlKGNoYXZlKTtcbiAgICAgIGlmICghcGFyYW1ldHJvKSB7XG4gICAgICAgIGlmIChwYWRyYW8gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiBwYWRyYW87XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IFBhcmFtZXRyb05hb0VuY29udHJhZG9FeGNlcHRpb24oY2hhdmUpO1xuICAgICAgfVxuXG4gICAgICAvLyBDb252ZXJ0ZXIgcGFyYSBvIHRpcG8gY29ycmV0b1xuICAgICAgY29uc3QgdmFsb3JDb252ZXJ0aWRvID0gUGFyYW1ldHJvQ29udmVydGVyLnBhcmFWYWxvclRpcGFkbyhjaGF2ZSwgcGFyYW1ldHJvLnZhbG9yLCBwYXJhbWV0cm8udGlwbyk7XG4gICAgICBcbiAgICAgIC8vIEFybWF6ZW5hciBubyBjYWNoZVxuICAgICAgdGhpcy5jYWNoZS5zZXQoY2hhdmUsIHtcbiAgICAgICAgdmFsb3I6IHZhbG9yQ29udmVydGlkbyxcbiAgICAgICAgZXhwaXJhRW06IERhdGUubm93KCkgKyB0aGlzLkNBQ0hFX1RUTFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHJldHVybiB2YWxvckNvbnZlcnRpZG8gYXMgVDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgUGFyYW1ldHJvTmFvRW5jb250cmFkb0V4Y2VwdGlvbiAmJiBwYWRyYW8gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gcGFkcmFvO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHZhbG9yIGJvb2xlYW5vXG4gICAqIEBwYXJhbSBjaGF2ZSBDaGF2ZSBkbyBwYXLDom1ldHJvXG4gICAqIEBwYXJhbSBwYWRyYW8gVmFsb3IgcGFkcsOjbyBvcGNpb25hbFxuICAgKiBAcmV0dXJucyBWYWxvciBib29sZWFub1xuICAgKi9cbiAgYXN5bmMgb2J0ZXJCb29sZWFubyhjaGF2ZTogc3RyaW5nLCBwYWRyYW8/OiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgdmFsb3IgPSBhd2FpdCB0aGlzLm9idGVyVmFsb3I8YW55PihjaGF2ZSwgcGFkcmFvKTtcbiAgICBpZiAodHlwZW9mIHZhbG9yID09PSAnYm9vbGVhbicpIHtcbiAgICAgIHJldHVybiB2YWxvcjtcbiAgICB9XG4gICAgdGhyb3cgbmV3IFBhcmFtZXRyb1RpcG9JbnZhbGlkb0V4Y2VwdGlvbihjaGF2ZSwgdmFsb3IsIFBhcmFtZXRyb1RpcG9FbnVtLkJPT0xFQU4pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHZhbG9yIG51bcOpcmljb1xuICAgKiBAcGFyYW0gY2hhdmUgQ2hhdmUgZG8gcGFyw6JtZXRyb1xuICAgKiBAcGFyYW0gcGFkcmFvIFZhbG9yIHBhZHLDo28gb3BjaW9uYWxcbiAgICogQHJldHVybnMgVmFsb3IgbnVtw6lyaWNvXG4gICAqL1xuICBhc3luYyBvYnRlck51bWVybyhjaGF2ZTogc3RyaW5nLCBwYWRyYW8/OiBudW1iZXIpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHZhbG9yID0gYXdhaXQgdGhpcy5vYnRlclZhbG9yPGFueT4oY2hhdmUsIHBhZHJhbyk7XG4gICAgaWYgKHR5cGVvZiB2YWxvciA9PT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiB2YWxvcjtcbiAgICB9XG4gICAgdGhyb3cgbmV3IFBhcmFtZXRyb1RpcG9JbnZhbGlkb0V4Y2VwdGlvbihjaGF2ZSwgdmFsb3IsIFBhcmFtZXRyb1RpcG9FbnVtLk5VTUJFUik7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdW0gdmFsb3Igc3RyaW5nXG4gICAqIEBwYXJhbSBjaGF2ZSBDaGF2ZSBkbyBwYXLDom1ldHJvXG4gICAqIEBwYXJhbSBwYWRyYW8gVmFsb3IgcGFkcsOjbyBvcGNpb25hbFxuICAgKiBAcmV0dXJucyBWYWxvciBzdHJpbmdcbiAgICovXG4gIGFzeW5jIG9idGVyVGV4dG8oY2hhdmU6IHN0cmluZywgcGFkcmFvPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB2YWxvciA9IGF3YWl0IHRoaXMub2J0ZXJWYWxvcjxhbnk+KGNoYXZlLCBwYWRyYW8pO1xuICAgIGlmICh0eXBlb2YgdmFsb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdmFsb3I7XG4gICAgfVxuICAgIHRocm93IG5ldyBQYXJhbWV0cm9UaXBvSW52YWxpZG9FeGNlcHRpb24oY2hhdmUsIHZhbG9yLCBQYXJhbWV0cm9UaXBvRW51bS5TVFJJTkcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHZhbG9yIGRhdGFcbiAgICogQHBhcmFtIGNoYXZlIENoYXZlIGRvIHBhcsOibWV0cm9cbiAgICogQHBhcmFtIHBhZHJhbyBWYWxvciBwYWRyw6NvIG9wY2lvbmFsXG4gICAqIEByZXR1cm5zIFZhbG9yIGRhdGFcbiAgICovXG4gIGFzeW5jIG9idGVyRGF0YShjaGF2ZTogc3RyaW5nLCBwYWRyYW8/OiBEYXRlKTogUHJvbWlzZTxEYXRlPiB7XG4gICAgY29uc3QgdmFsb3IgPSBhd2FpdCB0aGlzLm9idGVyVmFsb3I8YW55PihjaGF2ZSwgcGFkcmFvKTtcbiAgICBpZiAodmFsb3IgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICByZXR1cm4gdmFsb3I7XG4gICAgfVxuICAgIHRocm93IG5ldyBQYXJhbWV0cm9UaXBvSW52YWxpZG9FeGNlcHRpb24oY2hhdmUsIHZhbG9yLCBQYXJhbWV0cm9UaXBvRW51bS5EQVRFKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB1bSB2YWxvciBKU09OXG4gICAqIEBwYXJhbSBjaGF2ZSBDaGF2ZSBkbyBwYXLDom1ldHJvXG4gICAqIEBwYXJhbSBwYWRyYW8gVmFsb3IgcGFkcsOjbyBvcGNpb25hbFxuICAgKiBAcmV0dXJucyBWYWxvciBKU09OIChvYmpldG8gb3UgYXJyYXkpXG4gICAqL1xuICBhc3luYyBvYnRlckpzb248VCA9IGFueT4oY2hhdmU6IHN0cmluZywgcGFkcmFvPzogVCk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IHZhbG9yID0gYXdhaXQgdGhpcy5vYnRlclZhbG9yPGFueT4oY2hhdmUsIHBhZHJhbyk7XG4gICAgaWYgKHR5cGVvZiB2YWxvciA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiB2YWxvciBhcyBUO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgUGFyYW1ldHJvVGlwb0ludmFsaWRvRXhjZXB0aW9uKGNoYXZlLCB2YWxvciwgUGFyYW1ldHJvVGlwb0VudW0uSlNPTik7XG4gIH1cblxuICAvKipcbiAgICogRGVmaW5lIHVtIHRlbXBvIHBlcnNvbmFsaXphZG8gcGFyYSBleHBpcmHDp8OjbyBkbyBjYWNoZVxuICAgKiBAcGFyYW0gdHRsTXMgVGVtcG8gZGUgdmlkYSBlbSBtaWxpc3NlZ3VuZG9zXG4gICAqL1xuICBkZWZpbmlyVGVtcG9DYWNoZU1zKHR0bE1zOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodHRsTXMgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ3R0bE1zJyxcbiAgICAgICAgdHRsTXMsXG4gICAgICAgICdudW1iZXInLFxuICAgICAgICAnVGVtcG8gZGUgY2FjaGUgZGV2ZSBzZXIgbWFpb3IgcXVlIHplcm8nXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci5sb2coYFRlbXBvIGRlIGNhY2hlIGFsdGVyYWRvIHBhcmEgJHt0dGxNc31tc2ApO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRlIHVtYSBlbnRpZGFkZSBQYXJhbWV0cm8gcGFyYSB1bSBEVE8gZGUgcmVzcG9zdGFcbiAgICogQHBhcmFtIHBhcmFtZXRybyBFbnRpZGFkZSBhIHNlciBjb252ZXJ0aWRhXG4gICAqIEByZXR1cm5zIERUTyBkZSByZXNwb3N0YVxuICAgKi9cbiAgcHJpdmF0ZSBtYXBlYXJQYXJhRHRvKHBhcmFtZXRybzogUGFyYW1ldHJvKTogUGFyYW1ldHJvUmVzcG9uc2VEdG8ge1xuICAgIGNvbnN0IGR0byA9IG5ldyBQYXJhbWV0cm9SZXNwb25zZUR0bygpO1xuICAgIGR0by5jaGF2ZSA9IHBhcmFtZXRyby5jaGF2ZTtcbiAgICBkdG8uZGVzY3JpY2FvID0gcGFyYW1ldHJvLmRlc2NyaWNhbztcbiAgICBkdG8udGlwbyA9IHBhcmFtZXRyby50aXBvO1xuICAgIGR0by52YWxvciA9IFBhcmFtZXRyb0NvbnZlcnRlci5wYXJhVmFsb3JUaXBhZG8ocGFyYW1ldHJvLmNoYXZlLCBwYXJhbWV0cm8udmFsb3IsIHBhcmFtZXRyby50aXBvKTtcbiAgICBkdG8udmFsb3JfZm9ybWF0YWRvID0gUGFyYW1ldHJvQ29udmVydGVyLmZvcm1hdGFyUGFyYUV4aWJpY2FvKGR0by52YWxvciwgcGFyYW1ldHJvLnRpcG8pO1xuICAgIGR0by5jYXRlZ29yaWEgPSBwYXJhbWV0cm8uY2F0ZWdvcmlhO1xuICAgIC8vIEVzY29wbyBlIGVkaXTDoXZlbCBzZXLDo28gaW1wbGVtZW50YWRvcyBwb3N0ZXJpb3JtZW50ZVxuICAgIC8vIGR0by5lc2NvcG8gPSBwYXJhbWV0cm8uZXNjb3BvO1xuICAgIC8vIGR0by5lZGl0YXZlbCA9IHBhcmFtZXRyby5lZGl0YXZlbDtcbiAgICBkdG8uY3JlYXRlZF9hdCA9IHBhcmFtZXRyby5jcmVhdGVkX2F0O1xuICAgIGR0by51cGRhdGVkX2F0ID0gcGFyYW1ldHJvLnVwZGF0ZWRfYXQ7XG4gICAgcmV0dXJuIGR0bztcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9