cad179504b5462f41a9d43c5e5cf3231
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const supertest_1 = __importDefault(require("supertest"));
const typeorm_1 = require("@nestjs/typeorm");
const jwt_1 = require("@nestjs/jwt");
const config_1 = require("@nestjs/config");
const entities_1 = require("../../../entities");
const integrador_module_1 = require("../integrador.module");
const integrador_service_1 = require("../services/integrador.service");
const integrador_token_service_1 = require("../services/integrador-token.service");
const role_enum_1 = require("../../../auth/enums/role.enum");
/**
 * Testes de integração (E2E) para o módulo de integradores.
 * Testa o fluxo completo de criação, validação e uso de tokens.
 */
describe('Integrador E2E', () => {
    let app;
    let jwtService;
    let integradorService;
    let tokenService;
    let integradorRepository;
    let tokenRepository;
    let tokenRevogadoRepository;
    let adminToken;
    let integrador;
    let integradorToken;
    // Mock dos repositórios
    const mockIntegradorRepository = {
        create: jest.fn(),
        save: jest.fn(),
        find: jest.fn(),
        findOne: jest.fn(),
        remove: jest.fn(),
        update: jest.fn(),
    };
    const mockTokenRepository = {
        create: jest.fn(),
        save: jest.fn(),
        find: jest.fn(),
        findOne: jest.fn(),
        remove: jest.fn(),
    };
    const mockTokenRevogadoRepository = {
        create: jest.fn(),
        save: jest.fn(),
        findOne: jest.fn(),
        createQueryBuilder: jest.fn().mockReturnThis(),
        delete: jest.fn().mockReturnThis(),
        from: jest.fn().mockReturnThis(),
        where: jest.fn().mockReturnThis(),
        execute: jest.fn(),
    };
    // Configuração do módulo de teste
    beforeAll(async () => {
        const moduleRef = await testing_1.Test.createTestingModule({
            imports: [
                config_1.ConfigModule.forRoot({
                    isGlobal: true,
                    envFilePath: '.env.test',
                }),
                jwt_1.JwtModule.registerAsync({
                    imports: [config_1.ConfigModule],
                    inject: [config_1.ConfigService],
                    useFactory: () => ({
                        secret: 'test-secret',
                        signOptions: { expiresIn: '1d' },
                    }),
                }),
                integrador_module_1.IntegradorModule,
            ],
            providers: [
                {
                    provide: (0, typeorm_1.getRepositoryToken)(entities_1.Integrador),
                    useValue: mockIntegradorRepository,
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(entities_1.IntegradorToken),
                    useValue: mockTokenRepository,
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(entities_1.TokenRevogado),
                    useValue: mockTokenRevogadoRepository,
                },
            ],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
        jwtService = moduleRef.get(jwt_1.JwtService);
        integradorService = moduleRef.get(integrador_service_1.IntegradorService);
        tokenService = moduleRef.get(integrador_token_service_1.IntegradorTokenService);
        integradorRepository = moduleRef.get((0, typeorm_1.getRepositoryToken)(entities_1.Integrador));
        tokenRepository = moduleRef.get((0, typeorm_1.getRepositoryToken)(entities_1.IntegradorToken));
        tokenRevogadoRepository = moduleRef.get((0, typeorm_1.getRepositoryToken)(entities_1.TokenRevogado));
        // Criar token de admin para testes
        adminToken = jwtService.sign({
            sub: 'test-user',
            name: 'Test Admin',
            roles: [role_enum_1.Role.ADMIN],
        });
        // Configurar mock para o serviço de integrador
        integrador = {
            id: 'test-integrador-id',
            nome: 'Integrador de Teste',
            descricao: 'Integrador para testes de integração',
            ativo: true,
            permissoesEscopo: ['read:dados_basicos', 'read:cidadaos'],
            ipPermitidos: [],
            dataCriacao: new Date(),
            dataAtualizacao: new Date(),
        };
        // Mock para o repository
        mockIntegradorRepository.findOne.mockImplementation((query) => {
            if (query?.where?.id === 'test-integrador-id') {
                return Promise.resolve(integrador);
            }
            if (query?.where?.nome === 'Integrador de Teste') {
                return Promise.resolve(integrador);
            }
            return Promise.resolve(null);
        });
        mockIntegradorRepository.save.mockImplementation((entity) => {
            return Promise.resolve({
                ...entity,
                id: entity.id || 'test-integrador-id',
            });
        });
        mockIntegradorRepository.create.mockImplementation((dto) => {
            return {
                ...dto,
                id: 'test-integrador-id',
            };
        });
        // Configurar mocks para o repositório de tokens
        mockTokenRepository.save.mockImplementation((entity) => {
            return Promise.resolve({
                ...entity,
                id: entity.id || 'test-token-id',
            });
        });
        mockTokenRepository.create.mockImplementation((dto) => {
            return {
                ...dto,
                id: 'test-token-id',
            };
        });
        mockTokenRepository.findOne.mockImplementation((query) => {
            if (query?.where?.tokenHash) {
                return Promise.resolve({
                    id: 'test-token-id',
                    integradorId: 'test-integrador-id',
                    nome: 'Token de Teste',
                    tokenHash: query.where.tokenHash,
                    escopos: ['read:dados_basicos'],
                    revogado: false,
                    ultimoUso: null,
                    dataCriacao: new Date(),
                });
            }
            return Promise.resolve(null);
        });
        // Mock para o repository de tokens revogados
        mockTokenRevogadoRepository.findOne.mockResolvedValue(null);
        // Criar token de integrador para testes
        const createTokenDto = {
            nome: 'Token de Teste',
            descricao: 'Token para testes de integração',
            escopos: ['read:dados_basicos'],
            diasValidade: 30,
        };
        const tokenResult = await tokenService.createToken('test-integrador-id', createTokenDto);
        integradorToken = tokenResult.token;
    });
    afterAll(async () => {
        await app.close();
    });
    it('deve estar definido', () => {
        expect(app).toBeDefined();
        expect(integradorService).toBeDefined();
        expect(tokenService).toBeDefined();
    });
    describe('API de Gerenciamento de Integradores', () => {
        it('GET /integradores - deve retornar lista de integradores para admin', async () => {
            // Configurar mock
            mockIntegradorRepository.find.mockResolvedValue([integrador]);
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .get('/integradores')
                .set('Authorization', `Bearer ${adminToken}`)
                .expect(200)
                .expect((res) => {
                expect(res.body).toBeInstanceOf(Array);
                expect(res.body.length).toBe(1);
                expect(res.body[0].id).toBe(integrador.id);
            });
            expect(mockIntegradorRepository.find).toHaveBeenCalled();
        });
        it('POST /integradores - deve criar um novo integrador', async () => {
            // Configurar mock para evitar conflito
            mockIntegradorRepository.findOne.mockResolvedValueOnce(null);
            const createDto = {
                nome: 'Novo Integrador',
                descricao: 'Descrição do novo integrador',
                permissoesEscopo: ['read:dados_basicos'],
                ativo: true,
            };
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .post('/integradores')
                .set('Authorization', `Bearer ${adminToken}`)
                .send(createDto)
                .expect(201)
                .expect((res) => {
                expect(res.body.nome).toBe(createDto.nome);
                expect(res.body.descricao).toBe(createDto.descricao);
            });
            expect(mockIntegradorRepository.findOne).toHaveBeenCalled();
            expect(mockIntegradorRepository.create).toHaveBeenCalledWith(createDto);
            expect(mockIntegradorRepository.save).toHaveBeenCalled();
        });
        it('GET /integradores/:id - deve retornar um integrador pelo ID', async () => {
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .get(`/integradores/test-integrador-id`)
                .set('Authorization', `Bearer ${adminToken}`)
                .expect(200)
                .expect((res) => {
                expect(res.body.id).toBe(integrador.id);
                expect(res.body.nome).toBe(integrador.nome);
            });
            expect(mockIntegradorRepository.findOne).toHaveBeenCalledWith({
                where: { id: 'test-integrador-id' },
            });
        });
    });
    describe('API de Tokens', () => {
        it('POST /integradores/:id/tokens - deve criar um novo token', async () => {
            const createTokenDto = {
                nome: 'Novo Token',
                descricao: 'Token para acesso à API',
                escopos: ['read:dados_basicos'],
                diasValidade: 30,
            };
            // Configurar jwtService.sign para retornar um token específico
            jest.spyOn(jwtService, 'sign').mockReturnValueOnce('mock-token-jwt');
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .post(`/integradores/test-integrador-id/tokens`)
                .set('Authorization', `Bearer ${adminToken}`)
                .send(createTokenDto)
                .expect(201)
                .expect((res) => {
                expect(res.body.token).toBe('mock-token-jwt');
                expect(res.body.tokenInfo).toBeDefined();
                expect(res.body.tokenInfo.nome).toBe(createTokenDto.nome);
            });
        });
        it('GET /integradores/:id/tokens - deve listar tokens de um integrador', async () => {
            // Configurar mock
            mockTokenRepository.find.mockResolvedValue([
                {
                    id: 'test-token-id',
                    nome: 'Token de Teste',
                    escopos: ['read:dados_basicos'],
                    dataCriacao: new Date(),
                },
            ]);
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .get(`/integradores/test-integrador-id/tokens`)
                .set('Authorization', `Bearer ${adminToken}`)
                .expect(200)
                .expect((res) => {
                expect(res.body).toBeInstanceOf(Array);
                expect(res.body.length).toBe(1);
                expect(res.body[0].id).toBe('test-token-id');
            });
            expect(mockTokenRepository.find).toHaveBeenCalledWith({
                where: { integradorId: 'test-integrador-id' },
                order: { dataCriacao: 'DESC' },
            });
        });
    });
    describe('API protegida por IntegradorAuthGuard', () => {
        // Configurar um endpoint de teste protegido pelo guard
        beforeAll(() => {
            const mockApiController = {
                getDadosBasicos: (req) => {
                    return {
                        message: 'Dados básicos disponíveis',
                        integrador: req.integrador.nome,
                        timestamp: new Date().toISOString(),
                        dados: { exemplo: 'dados de teste' },
                    };
                },
            };
            const mockGuard = {
                canActivate: jest.fn().mockImplementation(async () => {
                    return true;
                }),
            };
            app.use('/api/exemplo/dados-basicos', (req, res, next) => {
                req.integrador = integrador;
                req.integradorTokenPayload = {
                    sub: `integrador:${integrador.id}`,
                    scopes: ['read:dados_basicos'],
                };
                next();
            });
            app.get('/api/exemplo/dados-basicos', (req, res) => {
                res.json(mockApiController.getDadosBasicos(req));
            });
        });
        it('GET /api/exemplo/dados-basicos - deve permitir acesso com token válido', async () => {
            // Test
            await (0, supertest_1.default)(app.getHttpServer())
                .get('/api/exemplo/dados-basicos')
                .set('Authorization', `Bearer ${integradorToken}`)
                .expect(200)
                .expect((res) => {
                expect(res.body.message).toBe('Dados básicos disponíveis');
                expect(res.body.dados).toBeDefined();
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGludGVncmFkb3JcXHRlc3RzXFxpbnRlZ3JhZG9yLWUyZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNkNBQXNEO0FBRXRELDBEQUFnQztBQUNoQyw2Q0FBcUQ7QUFDckQscUNBQW9EO0FBQ3BELDJDQUE2RDtBQUM3RCxnREFBK0U7QUFDL0UsNERBQXdEO0FBQ3hELHVFQUFtRTtBQUNuRSxtRkFBOEU7QUFHOUUsNkRBQXFEO0FBRXJEOzs7R0FHRztBQUNILFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxHQUFxQixDQUFDO0lBQzFCLElBQUksVUFBc0IsQ0FBQztJQUMzQixJQUFJLGlCQUFvQyxDQUFDO0lBQ3pDLElBQUksWUFBb0MsQ0FBQztJQUN6QyxJQUFJLG9CQUF5QixDQUFDO0lBQzlCLElBQUksZUFBb0IsQ0FBQztJQUN6QixJQUFJLHVCQUE0QixDQUFDO0lBQ2pDLElBQUksVUFBa0IsQ0FBQztJQUN2QixJQUFJLFVBQWUsQ0FBQztJQUNwQixJQUFJLGVBQXVCLENBQUM7SUFFNUIsd0JBQXdCO0lBQ3hCLE1BQU0sd0JBQXdCLEdBQUc7UUFDL0IsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2xCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2pCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2xCLENBQUM7SUFFRixNQUFNLG1CQUFtQixHQUFHO1FBQzFCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2pCLElBQUksRUFBRSxJQUFJLENBQUMsRUFB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SCxFQUFFLENBQUMsd0VBQXdFLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDdEYsT0FBTztZQUNQLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztpQkFDL0IsR0FBRyxDQUFDLDRCQUE0QixDQUFDO2lCQUNqQyxHQUFHLENBQUMsZUFBZSxFQUFFLFVBQVUsZUFBZSxFQUFFLENBQUM7aUJBQ2pELE1BQU0sQ0FBQyxHQUFHLENBQUM7aUJBQ1gsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ2QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7Z0JBQzNELE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxpbnRlZ3JhZG9yXFx0ZXN0c1xcaW50ZWdyYWRvci1lMmUuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuaW1wb3J0IHsgZ2V0UmVwb3NpdG9yeVRva2VuIH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcbmltcG9ydCB7IEp3dE1vZHVsZSwgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSwgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IEludGVncmFkb3IsIEludGVncmFkb3JUb2tlbiwgVG9rZW5SZXZvZ2FkbyB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzJztcbmltcG9ydCB7IEludGVncmFkb3JNb2R1bGUgfSBmcm9tICcuLi9pbnRlZ3JhZG9yLm1vZHVsZSc7XG5pbXBvcnQgeyBJbnRlZ3JhZG9yU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2ludGVncmFkb3Iuc2VydmljZSc7XG5pbXBvcnQgeyBJbnRlZ3JhZG9yVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvaW50ZWdyYWRvci10b2tlbi5zZXJ2aWNlJztcbmltcG9ydCB7IENyZWF0ZUludGVncmFkb3JEdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLWludGVncmFkb3IuZHRvJztcbmltcG9ydCB7IENyZWF0ZVRva2VuRHRvIH0gZnJvbSAnLi4vZHRvL2NyZWF0ZS10b2tlbi5kdG8nO1xuaW1wb3J0IHsgUm9sZSB9IGZyb20gJy4uLy4uLy4uL2F1dGgvZW51bXMvcm9sZS5lbnVtJztcblxuLyoqXG4gKiBUZXN0ZXMgZGUgaW50ZWdyYcOnw6NvIChFMkUpIHBhcmEgbyBtw7NkdWxvIGRlIGludGVncmFkb3Jlcy5cbiAqIFRlc3RhIG8gZmx1eG8gY29tcGxldG8gZGUgY3JpYcOnw6NvLCB2YWxpZGHDp8OjbyBlIHVzbyBkZSB0b2tlbnMuXG4gKi9cbmRlc2NyaWJlKCdJbnRlZ3JhZG9yIEUyRScsICgpID0+IHtcbiAgbGV0IGFwcDogSU5lc3RBcHBsaWNhdGlvbjtcbiAgbGV0IGp3dFNlcnZpY2U6IEp3dFNlcnZpY2U7XG4gIGxldCBpbnRlZ3JhZG9yU2VydmljZTogSW50ZWdyYWRvclNlcnZpY2U7XG4gIGxldCB0b2tlblNlcnZpY2U6IEludGVncmFkb3JUb2tlblNlcnZpY2U7XG4gIGxldCBpbnRlZ3JhZG9yUmVwb3NpdG9yeTogYW55O1xuICBsZXQgdG9rZW5SZXBvc2l0b3J5OiBhbnk7XG4gIGxldCB0b2tlblJldm9nYWRvUmVwb3NpdG9yeTogYW55O1xuICBsZXQgYWRtaW5Ub2tlbjogc3RyaW5nO1xuICBsZXQgaW50ZWdyYWRvcjogYW55O1xuICBsZXQgaW50ZWdyYWRvclRva2VuOiBzdHJpbmc7XG5cbiAgLy8gTW9jayBkb3MgcmVwb3NpdMOzcmlvc1xuICBjb25zdCBtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnkgPSB7XG4gICAgY3JlYXRlOiBqZXN0LmZuKCksXG4gICAgc2F2ZTogamVzdC5mbigpLFxuICAgIGZpbmQ6IGplc3QuZm4oKSxcbiAgICBmaW5kT25lOiBqZXN0LmZuKCksXG4gICAgcmVtb3ZlOiBqZXN0LmZuKCksXG4gICAgdXBkYXRlOiBqZXN0LmZuKCksXG4gIH07XG5cbiAgY29uc3QgbW9ja1Rva2VuUmVwb3NpdG9yeSA9IHtcbiAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICBzYXZlOiBqZXN0LmZuKCksXG4gICAgZmluZDogamVzdC5mbigpLFxuICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcbiAgICByZW1vdmU6IGplc3QuZm4oKSxcbiAgfTtcblxuICBjb25zdCBtb2NrVG9rZW5SZXZvZ2Fkb1JlcG9zaXRvcnkgPSB7XG4gICAgY3JlYXRlOiBqZXN0LmZuKCksXG4gICAgc2F2ZTogamVzdC5mbigpLFxuICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcbiAgICBjcmVhdGVRdWVyeUJ1aWxkZXI6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIGRlbGV0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgZnJvbTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIGV4ZWN1dGU6IGplc3QuZm4oKSxcbiAgfTtcblxuICAvLyBDb25maWd1cmHDp8OjbyBkbyBtw7NkdWxvIGRlIHRlc3RlXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9kdWxlUmVmOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtcbiAgICAgICAgQ29uZmlnTW9kdWxlLmZvclJvb3Qoe1xuICAgICAgICAgIGlzR2xvYmFsOiB0cnVlLFxuICAgICAgICAgIGVudkZpbGVQYXRoOiAnLmVudi50ZXN0JyxcbiAgICAgICAgfSksXG4gICAgICAgIEp3dE1vZHVsZS5yZWdpc3RlckFzeW5jKHtcbiAgICAgICAgICBpbXBvcnRzOiBbQ29uZmlnTW9kdWxlXSxcbiAgICAgICAgICBpbmplY3Q6IFtDb25maWdTZXJ2aWNlXSxcbiAgICAgICAgICB1c2VGYWN0b3J5OiAoKSA9PiAoe1xuICAgICAgICAgICAgc2VjcmV0OiAndGVzdC1zZWNyZXQnLFxuICAgICAgICAgICAgc2lnbk9wdGlvbnM6IHsgZXhwaXJlc0luOiAnMWQnIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgICBJbnRlZ3JhZG9yTW9kdWxlLFxuICAgICAgXSxcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKEludGVncmFkb3IpLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oSW50ZWdyYWRvclRva2VuKSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja1Rva2VuUmVwb3NpdG9yeSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihUb2tlblJldm9nYWRvKSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja1Rva2VuUmV2b2dhZG9SZXBvc2l0b3J5LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhcHAgPSBtb2R1bGVSZWYuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XG4gICAgYXdhaXQgYXBwLmluaXQoKTtcblxuICAgIGp3dFNlcnZpY2UgPSBtb2R1bGVSZWYuZ2V0PEp3dFNlcnZpY2U+KEp3dFNlcnZpY2UpO1xuICAgIGludGVncmFkb3JTZXJ2aWNlID0gbW9kdWxlUmVmLmdldDxJbnRlZ3JhZG9yU2VydmljZT4oSW50ZWdyYWRvclNlcnZpY2UpO1xuICAgIHRva2VuU2VydmljZSA9IG1vZHVsZVJlZi5nZXQ8SW50ZWdyYWRvclRva2VuU2VydmljZT4oXG4gICAgICBJbnRlZ3JhZG9yVG9rZW5TZXJ2aWNlLFxuICAgICk7XG4gICAgaW50ZWdyYWRvclJlcG9zaXRvcnkgPSBtb2R1bGVSZWYuZ2V0KGdldFJlcG9zaXRvcnlUb2tlbihJbnRlZ3JhZG9yKSk7XG4gICAgdG9rZW5SZXBvc2l0b3J5ID0gbW9kdWxlUmVmLmdldChnZXRSZXBvc2l0b3J5VG9rZW4oSW50ZWdyYWRvclRva2VuKSk7XG4gICAgdG9rZW5SZXZvZ2Fkb1JlcG9zaXRvcnkgPSBtb2R1bGVSZWYuZ2V0KGdldFJlcG9zaXRvcnlUb2tlbihUb2tlblJldm9nYWRvKSk7XG5cbiAgICAvLyBDcmlhciB0b2tlbiBkZSBhZG1pbiBwYXJhIHRlc3Rlc1xuICAgIGFkbWluVG9rZW4gPSBqd3RTZXJ2aWNlLnNpZ24oe1xuICAgICAgc3ViOiAndGVzdC11c2VyJyxcbiAgICAgIG5hbWU6ICdUZXN0IEFkbWluJyxcbiAgICAgIHJvbGVzOiBbUm9sZS5BRE1JTl0sXG4gICAgfSk7XG5cbiAgICAvLyBDb25maWd1cmFyIG1vY2sgcGFyYSBvIHNlcnZpw6dvIGRlIGludGVncmFkb3JcbiAgICBpbnRlZ3JhZG9yID0ge1xuICAgICAgaWQ6ICd0ZXN0LWludGVncmFkb3ItaWQnLFxuICAgICAgbm9tZTogJ0ludGVncmFkb3IgZGUgVGVzdGUnLFxuICAgICAgZGVzY3JpY2FvOiAnSW50ZWdyYWRvciBwYXJhIHRlc3RlcyBkZSBpbnRlZ3Jhw6fDo28nLFxuICAgICAgYXRpdm86IHRydWUsXG4gICAgICBwZXJtaXNzb2VzRXNjb3BvOiBbJ3JlYWQ6ZGFkb3NfYmFzaWNvcycsICdyZWFkOmNpZGFkYW9zJ10sXG4gICAgICBpcFBlcm1pdGlkb3M6IFtdLFxuICAgICAgZGF0YUNyaWFjYW86IG5ldyBEYXRlKCksXG4gICAgICBkYXRhQXR1YWxpemFjYW86IG5ldyBEYXRlKCksXG4gICAgfTtcblxuICAgIC8vIE1vY2sgcGFyYSBvIHJlcG9zaXRvcnlcbiAgICBtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnkuZmluZE9uZS5tb2NrSW1wbGVtZW50YXRpb24oKHF1ZXJ5KSA9PiB7XG4gICAgICBpZiAocXVlcnk/LndoZXJlPy5pZCA9PT0gJ3Rlc3QtaW50ZWdyYWRvci1pZCcpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShpbnRlZ3JhZG9yKTtcbiAgICAgIH1cbiAgICAgIGlmIChxdWVyeT8ud2hlcmU/Lm5vbWUgPT09ICdJbnRlZ3JhZG9yIGRlIFRlc3RlJykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGludGVncmFkb3IpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9KTtcblxuICAgIG1vY2tJbnRlZ3JhZG9yUmVwb3NpdG9yeS5zYXZlLm1vY2tJbXBsZW1lbnRhdGlvbigoZW50aXR5KSA9PiB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgLi4uZW50aXR5LFxuICAgICAgICBpZDogZW50aXR5LmlkIHx8ICd0ZXN0LWludGVncmFkb3ItaWQnLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnkuY3JlYXRlLm1vY2tJbXBsZW1lbnRhdGlvbigoZHRvKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5kdG8sXG4gICAgICAgIGlkOiAndGVzdC1pbnRlZ3JhZG9yLWlkJyxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICAvLyBDb25maWd1cmFyIG1vY2tzIHBhcmEgbyByZXBvc2l0w7NyaW8gZGUgdG9rZW5zXG4gICAgbW9ja1Rva2VuUmVwb3NpdG9yeS5zYXZlLm1vY2tJbXBsZW1lbnRhdGlvbigoZW50aXR5KSA9PiB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgLi4uZW50aXR5LFxuICAgICAgICBpZDogZW50aXR5LmlkIHx8ICd0ZXN0LXRva2VuLWlkJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgbW9ja1Rva2VuUmVwb3NpdG9yeS5jcmVhdGUubW9ja0ltcGxlbWVudGF0aW9uKChkdG8pID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmR0byxcbiAgICAgICAgaWQ6ICd0ZXN0LXRva2VuLWlkJyxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICBtb2NrVG9rZW5SZXBvc2l0b3J5LmZpbmRPbmUubW9ja0ltcGxlbWVudGF0aW9uKChxdWVyeSkgPT4ge1xuICAgICAgaWYgKHF1ZXJ5Py53aGVyZT8udG9rZW5IYXNoKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIGlkOiAndGVzdC10b2tlbi1pZCcsXG4gICAgICAgICAgaW50ZWdyYWRvcklkOiAndGVzdC1pbnRlZ3JhZG9yLWlkJyxcbiAgICAgICAgICBub21lOiAnVG9rZW4gZGUgVGVzdGUnLFxuICAgICAgICAgIHRva2VuSGFzaDogcXVlcnkud2hlcmUudG9rZW5IYXNoLFxuICAgICAgICAgIGVzY29wb3M6IFsncmVhZDpkYWRvc19iYXNpY29zJ10sXG4gICAgICAgICAgcmV2b2dhZG86IGZhbHNlLFxuICAgICAgICAgIHVsdGltb1VzbzogbnVsbCxcbiAgICAgICAgICBkYXRhQ3JpYWNhbzogbmV3IERhdGUoKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgIH0pO1xuXG4gICAgLy8gTW9jayBwYXJhIG8gcmVwb3NpdG9yeSBkZSB0b2tlbnMgcmV2b2dhZG9zXG4gICAgbW9ja1Rva2VuUmV2b2dhZG9SZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAvLyBDcmlhciB0b2tlbiBkZSBpbnRlZ3JhZG9yIHBhcmEgdGVzdGVzXG4gICAgY29uc3QgY3JlYXRlVG9rZW5EdG86IENyZWF0ZVRva2VuRHRvID0ge1xuICAgICAgbm9tZTogJ1Rva2VuIGRlIFRlc3RlJyxcbiAgICAgIGRlc2NyaWNhbzogJ1Rva2VuIHBhcmEgdGVzdGVzIGRlIGludGVncmHDp8OjbycsXG4gICAgICBlc2NvcG9zOiBbJ3JlYWQ6ZGFkb3NfYmFzaWNvcyddLFxuICAgICAgZGlhc1ZhbGlkYWRlOiAzMCxcbiAgICB9O1xuXG4gICAgY29uc3QgdG9rZW5SZXN1bHQgPSBhd2FpdCB0b2tlblNlcnZpY2UuY3JlYXRlVG9rZW4oXG4gICAgICAndGVzdC1pbnRlZ3JhZG9yLWlkJyxcbiAgICAgIGNyZWF0ZVRva2VuRHRvLFxuICAgICk7XG4gICAgaW50ZWdyYWRvclRva2VuID0gdG9rZW5SZXN1bHQudG9rZW47XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhcHAuY2xvc2UoKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgZXN0YXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KGFwcCkudG9CZURlZmluZWQoKTtcbiAgICBleHBlY3QoaW50ZWdyYWRvclNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KHRva2VuU2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSSBkZSBHZXJlbmNpYW1lbnRvIGRlIEludGVncmFkb3JlcycsICgpID0+IHtcbiAgICBpdCgnR0VUIC9pbnRlZ3JhZG9yZXMgLSBkZXZlIHJldG9ybmFyIGxpc3RhIGRlIGludGVncmFkb3JlcyBwYXJhIGFkbWluJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrXG4gICAgICBtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnkuZmluZC5tb2NrUmVzb2x2ZWRWYWx1ZShbaW50ZWdyYWRvcl0pO1xuXG4gICAgICAvLyBUZXN0XG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5nZXQoJy9pbnRlZ3JhZG9yZXMnKVxuICAgICAgICAuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke2FkbWluVG9rZW59YClcbiAgICAgICAgLmV4cGVjdCgyMDApXG4gICAgICAgIC5leHBlY3QoKHJlcykgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keSkudG9CZUluc3RhbmNlT2YoQXJyYXkpO1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keS5sZW5ndGgpLnRvQmUoMSk7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5WzBdLmlkKS50b0JlKGludGVncmFkb3IuaWQpO1xuICAgICAgICB9KTtcblxuICAgICAgZXhwZWN0KG1vY2tJbnRlZ3JhZG9yUmVwb3NpdG9yeS5maW5kKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnUE9TVCAvaW50ZWdyYWRvcmVzIC0gZGV2ZSBjcmlhciB1bSBub3ZvIGludGVncmFkb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgcGFyYSBldml0YXIgY29uZmxpdG9cbiAgICAgIG1vY2tJbnRlZ3JhZG9yUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlT25jZShudWxsKTtcblxuICAgICAgY29uc3QgY3JlYXRlRHRvOiBDcmVhdGVJbnRlZ3JhZG9yRHRvID0ge1xuICAgICAgICBub21lOiAnTm92byBJbnRlZ3JhZG9yJyxcbiAgICAgICAgZGVzY3JpY2FvOiAnRGVzY3Jpw6fDo28gZG8gbm92byBpbnRlZ3JhZG9yJyxcbiAgICAgICAgcGVybWlzc29lc0VzY29wbzogWydyZWFkOmRhZG9zX2Jhc2ljb3MnXSxcbiAgICAgICAgYXRpdm86IHRydWUsXG4gICAgICB9O1xuXG4gICAgICAvLyBUZXN0XG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5wb3N0KCcvaW50ZWdyYWRvcmVzJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthZG1pblRva2VufWApXG4gICAgICAgIC5zZW5kKGNyZWF0ZUR0bylcbiAgICAgICAgLmV4cGVjdCgyMDEpXG4gICAgICAgIC5leHBlY3QoKHJlcykgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keS5ub21lKS50b0JlKGNyZWF0ZUR0by5ub21lKTtcbiAgICAgICAgICBleHBlY3QocmVzLmJvZHkuZGVzY3JpY2FvKS50b0JlKGNyZWF0ZUR0by5kZXNjcmljYW8pO1xuICAgICAgICB9KTtcblxuICAgICAgZXhwZWN0KG1vY2tJbnRlZ3JhZG9yUmVwb3NpdG9yeS5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja0ludGVncmFkb3JSZXBvc2l0b3J5LmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY3JlYXRlRHRvKTtcbiAgICAgIGV4cGVjdChtb2NrSW50ZWdyYWRvclJlcG9zaXRvcnkuc2F2ZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ0dFVCAvaW50ZWdyYWRvcmVzLzppZCAtIGRldmUgcmV0b3JuYXIgdW0gaW50ZWdyYWRvciBwZWxvIElEJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVGVzdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAuZ2V0KGAvaW50ZWdyYWRvcmVzL3Rlc3QtaW50ZWdyYWRvci1pZGApXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YWRtaW5Ub2tlbn1gKVxuICAgICAgICAuZXhwZWN0KDIwMClcbiAgICAgICAgLmV4cGVjdCgocmVzKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5LmlkKS50b0JlKGludGVncmFkb3IuaWQpO1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keS5ub21lKS50b0JlKGludGVncmFkb3Iubm9tZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICBleHBlY3QobW9ja0ludGVncmFkb3JSZXBvc2l0b3J5LmZpbmRPbmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6ICd0ZXN0LWludGVncmFkb3ItaWQnIH0sXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSSBkZSBUb2tlbnMnLCAoKSA9PiB7XG4gICAgaXQoJ1BPU1QgL2ludGVncmFkb3Jlcy86aWQvdG9rZW5zIC0gZGV2ZSBjcmlhciB1bSBub3ZvIHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY3JlYXRlVG9rZW5EdG86IENyZWF0ZVRva2VuRHRvID0ge1xuICAgICAgICBub21lOiAnTm92byBUb2tlbicsXG4gICAgICAgIGRlc2NyaWNhbzogJ1Rva2VuIHBhcmEgYWNlc3NvIMOgIEFQSScsXG4gICAgICAgIGVzY29wb3M6IFsncmVhZDpkYWRvc19iYXNpY29zJ10sXG4gICAgICAgIGRpYXNWYWxpZGFkZTogMzAsXG4gICAgICB9O1xuXG4gICAgICAvLyBDb25maWd1cmFyIGp3dFNlcnZpY2Uuc2lnbiBwYXJhIHJldG9ybmFyIHVtIHRva2VuIGVzcGVjw61maWNvXG4gICAgICBqZXN0LnNweU9uKGp3dFNlcnZpY2UsICdzaWduJykubW9ja1JldHVyblZhbHVlT25jZSgnbW9jay10b2tlbi1qd3QnKTtcblxuICAgICAgLy8gVGVzdFxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdChgL2ludGVncmFkb3Jlcy90ZXN0LWludGVncmFkb3ItaWQvdG9rZW5zYClcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthZG1pblRva2VufWApXG4gICAgICAgIC5zZW5kKGNyZWF0ZVRva2VuRHRvKVxuICAgICAgICAuZXhwZWN0KDIwMSlcbiAgICAgICAgLmV4cGVjdCgocmVzKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5LnRva2VuKS50b0JlKCdtb2NrLXRva2VuLWp3dCcpO1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keS50b2tlbkluZm8pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5LnRva2VuSW5mby5ub21lKS50b0JlKGNyZWF0ZVRva2VuRHRvLm5vbWUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdHRVQgL2ludGVncmFkb3Jlcy86aWQvdG9rZW5zIC0gZGV2ZSBsaXN0YXIgdG9rZW5zIGRlIHVtIGludGVncmFkb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2tcbiAgICAgIG1vY2tUb2tlblJlcG9zaXRvcnkuZmluZC5tb2NrUmVzb2x2ZWRWYWx1ZShbXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ3Rlc3QtdG9rZW4taWQnLFxuICAgICAgICAgIG5vbWU6ICdUb2tlbiBkZSBUZXN0ZScsXG4gICAgICAgICAgZXNjb3BvczogWydyZWFkOmRhZG9zX2Jhc2ljb3MnXSxcbiAgICAgICAgICBkYXRhQ3JpYWNhbzogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBUZXN0XG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5nZXQoYC9pbnRlZ3JhZG9yZXMvdGVzdC1pbnRlZ3JhZG9yLWlkL3Rva2Vuc2ApXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YWRtaW5Ub2tlbn1gKVxuICAgICAgICAuZXhwZWN0KDIwMClcbiAgICAgICAgLmV4cGVjdCgocmVzKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5KS50b0JlSW5zdGFuY2VPZihBcnJheSk7XG4gICAgICAgICAgZXhwZWN0KHJlcy5ib2R5Lmxlbmd0aCkudG9CZSgxKTtcbiAgICAgICAgICBleHBlY3QocmVzLmJvZHlbMF0uaWQpLnRvQmUoJ3Rlc3QtdG9rZW4taWQnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChtb2NrVG9rZW5SZXBvc2l0b3J5LmZpbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgaW50ZWdyYWRvcklkOiAndGVzdC1pbnRlZ3JhZG9yLWlkJyB9LFxuICAgICAgICBvcmRlcjogeyBkYXRhQ3JpYWNhbzogJ0RFU0MnIH0sXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSSBwcm90ZWdpZGEgcG9yIEludGVncmFkb3JBdXRoR3VhcmQnLCAoKSA9PiB7XG4gICAgLy8gQ29uZmlndXJhciB1bSBlbmRwb2ludCBkZSB0ZXN0ZSBwcm90ZWdpZG8gcGVsbyBndWFyZFxuICAgIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQXBpQ29udHJvbGxlciA9IHtcbiAgICAgICAgZ2V0RGFkb3NCYXNpY29zOiAocmVxKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdEYWRvcyBiw6FzaWNvcyBkaXNwb27DrXZlaXMnLFxuICAgICAgICAgICAgaW50ZWdyYWRvcjogcmVxLmludGVncmFkb3Iubm9tZSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgZGFkb3M6IHsgZXhlbXBsbzogJ2RhZG9zIGRlIHRlc3RlJyB9LFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtb2NrR3VhcmQgPSB7XG4gICAgICAgIGNhbkFjdGl2YXRlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICBhcHAudXNlKCcvYXBpL2V4ZW1wbG8vZGFkb3MtYmFzaWNvcycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICByZXEuaW50ZWdyYWRvciA9IGludGVncmFkb3I7XG4gICAgICAgIHJlcS5pbnRlZ3JhZG9yVG9rZW5QYXlsb2FkID0ge1xuICAgICAgICAgIHN1YjogYGludGVncmFkb3I6JHtpbnRlZ3JhZG9yLmlkfWAsXG4gICAgICAgICAgc2NvcGVzOiBbJ3JlYWQ6ZGFkb3NfYmFzaWNvcyddLFxuICAgICAgICB9O1xuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcblxuICAgICAgYXBwLmdldCgnL2FwaS9leGVtcGxvL2RhZG9zLWJhc2ljb3MnLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgcmVzLmpzb24obW9ja0FwaUNvbnRyb2xsZXIuZ2V0RGFkb3NCYXNpY29zKHJlcSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnR0VUIC9hcGkvZXhlbXBsby9kYWRvcy1iYXNpY29zIC0gZGV2ZSBwZXJtaXRpciBhY2Vzc28gY29tIHRva2VuIHbDoWxpZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUZXN0XG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcC5nZXRIdHRwU2VydmVyKCkpXG4gICAgICAgIC5nZXQoJy9hcGkvZXhlbXBsby9kYWRvcy1iYXNpY29zJylcbiAgICAgICAgLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHtpbnRlZ3JhZG9yVG9rZW59YClcbiAgICAgICAgLmV4cGVjdCgyMDApXG4gICAgICAgIC5leHBlY3QoKHJlcykgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXMuYm9keS5tZXNzYWdlKS50b0JlKCdEYWRvcyBiw6FzaWNvcyBkaXNwb27DrXZlaXMnKTtcbiAgICAgICAgICBleHBlY3QocmVzLmJvZHkuZGFkb3MpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9