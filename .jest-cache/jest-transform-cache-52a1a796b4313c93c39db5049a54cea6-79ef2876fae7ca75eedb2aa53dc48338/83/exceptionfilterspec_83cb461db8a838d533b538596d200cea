ebb17d7cab095eaf4aefbd46ce94f6e2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const exception_filter_1 = require("../exception.filter");
const logging_service_1 = require("../logging.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para o filtro de exceções global
 *
 * Verifica o comportamento do filtro ao capturar diferentes tipos de exceções
 * e formatar as respostas de erro apropriadamente
 */
describe('GlobalExceptionFilter', () => {
    let filter;
    let loggingService;
    // Mock do serviço de logging
    const mockLoggingService = {
        error: jest.fn(),
    };
    beforeEach(async () => {
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            providers: [
                exception_filter_1.GlobalExceptionFilter,
                {
                    provide: logging_service_1.LoggingService,
                    useValue: mockLoggingService,
                },
            ],
        }).compile();
        filter = module.get(exception_filter_1.GlobalExceptionFilter);
        loggingService = module.get(logging_service_1.LoggingService);
    });
    it('deve ser definido', () => {
        expect(filter).toBeDefined();
    });
    describe('catch', () => {
        it('deve lidar com HttpException', () => {
            // Mock da exceção HTTP
            const exception = new common_1.HttpException('Mensagem de erro', common_1.HttpStatus.BAD_REQUEST);
            // Mock da resposta
            const mockResponse = {
                status: jest.fn().mockReturnThis(),
                json: jest.fn(),
            };
            // Mock da requisição
            const mockRequest = {
                url: '/api/test',
                method: 'GET',
                ip: '127.0.0.1',
                headers: {
                    'user-agent': 'test-agent',
                },
                user: {
                    id: 'user-123',
                },
            };
            // Mock do host de argumentos
            const mockArgumentsHost = {
                switchToHttp: jest.fn().mockReturnValue({
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                }),
            };
            // Executar o filtro
            filter.catch(exception, mockArgumentsHost);
            // Verificar se o status e o corpo da resposta foram definidos corretamente
            expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.BAD_REQUEST);
            expect(mockResponse.json).toHaveBeenCalled();
            // Capturar o argumento passado para json
            const jsonArg = mockResponse.json.mock.calls[0][0];
            expect(jsonArg).toEqual(expect.objectContaining({
                statusCode: common_1.HttpStatus.BAD_REQUEST,
                message: 'Mensagem de erro',
                path: '/api/test',
            }));
            // Verificar se o erro foi registrado
            expect(mockLoggingService.error).toHaveBeenCalled();
            const errorCall = mockLoggingService.error.mock.calls[0];
            expect(errorCall[0]).toContain('Exceção capturada');
            expect(errorCall[0]).toContain('GET');
            expect(errorCall[0]).toContain('/api/test');
            expect(errorCall[2]).toBe('ExceptionFilter');
        });
        it('deve lidar com exceções internas do servidor', () => {
            // Mock de uma exceção interna
            const exception = new Error('Erro interno');
            // Mock da resposta
            const mockResponse = {
                status: jest.fn().mockReturnThis(),
                json: jest.fn(),
            };
            // Mock da requisição
            const mockRequest = {
                url: '/api/test',
                method: 'POST',
                ip: '127.0.0.1',
                headers: {},
            };
            // Mock do host de argumentos
            const mockArgumentsHost = {
                switchToHttp: jest.fn().mockReturnValue({
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                }),
            };
            // Executar o filtro
            filter.catch(exception, mockArgumentsHost);
            // Verificar se o status e o corpo da resposta foram definidos corretamente
            expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
            expect(mockResponse.json).toHaveBeenCalled();
            // Capturar o argumento passado para json
            const jsonArg = mockResponse.json.mock.calls[0][0];
            expect(jsonArg).toEqual(expect.objectContaining({
                statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                message: 'Erro interno do servidor',
                path: '/api/test',
            }));
            // Verificar se o erro foi registrado
            expect(mockLoggingService.error).toHaveBeenCalled();
            const errorCall = mockLoggingService.error.mock.calls[0];
            expect(errorCall[0]).toContain('Exceção capturada');
            expect(errorCall[0]).toContain('POST');
            expect(errorCall[0]).toContain('/api/test');
            expect(errorCall[2]).toBe('ExceptionFilter');
        });
        it('deve preservar a mensagem de erro original para InternalServerErrorException', () => {
            // Mock de uma exceção interna do NestJS
            const exception = new common_1.InternalServerErrorException('Erro específico do servidor');
            // Mock da resposta
            const mockResponse = {
                status: jest.fn().mockReturnThis(),
                json: jest.fn(),
            };
            // Mock da requisição
            const mockRequest = {
                url: '/api/test',
                method: 'PUT',
                ip: '127.0.0.1',
                headers: {},
            };
            // Mock do host de argumentos
            const mockArgumentsHost = {
                switchToHttp: jest.fn().mockReturnValue({
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                }),
            };
            // Executar o filtro
            filter.catch(exception, mockArgumentsHost);
            // Verificar se o status e o corpo da resposta foram definidos corretamente
            expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
            expect(mockResponse.json).toHaveBeenCalled();
            // Capturar o argumento passado para json
            const jsonArg = mockResponse.json.mock.calls[0][0];
            expect(jsonArg).toEqual(expect.objectContaining({
                statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                message: 'Erro específico do servidor',
                path: '/api/test',
            }));
            // Verificar se o erro foi registrado
            expect(mockLoggingService.error).toHaveBeenCalled();
            const errorCall = mockLoggingService.error.mock.calls[0];
            expect(errorCall[0]).toContain('Exceção capturada');
            expect(errorCall[0]).toContain('PUT');
            expect(errorCall[0]).toContain('/api/test');
            expect(errorCall[2]).toBe('ExceptionFilter');
        });
        it('deve lidar com exceções em ambiente de produção', () => {
            // Salvar o ambiente original
            const originalEnv = process.env.NODE_ENV;
            // Definir o ambiente como produção
            process.env.NODE_ENV = 'production';
            // Mock de uma exceção interna
            const exception = new Error('Detalhes sensíveis do erro');
            // Mock da resposta
            const mockResponse = {
                status: jest.fn().mockReturnThis(),
                json: jest.fn(),
            };
            // Mock da requisição
            const mockRequest = {
                url: '/api/test',
                method: 'DELETE',
                ip: '127.0.0.1',
                headers: {},
            };
            // Mock do host de argumentos
            const mockArgumentsHost = {
                switchToHttp: jest.fn().mockReturnValue({
                    getResponse: jest.fn().mockReturnValue(mockResponse),
                    getRequest: jest.fn().mockReturnValue(mockRequest),
                }),
            };
            // Executar o filtro
            filter.catch(exception, mockArgumentsHost);
            // Verificar se o status e o corpo da resposta foram definidos corretamente
            // Em produção, não devemos expor detalhes do erro
            expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
            expect(mockResponse.json).toHaveBeenCalled();
            // Capturar o argumento passado para json
            const jsonArg = mockResponse.json.mock.calls[0][0];
            expect(jsonArg).toEqual(expect.objectContaining({
                statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                message: 'Erro interno do servidor',
                path: '/api/test',
            }));
            // Verificar se o erro foi registrado com os detalhes completos
            expect(mockLoggingService.error).toHaveBeenCalled();
            const errorCall = mockLoggingService.error.mock.calls[0];
            expect(errorCall[0]).toContain('Exceção capturada');
            expect(errorCall[0]).toContain('DELETE');
            expect(errorCall[0]).toContain('/api/test');
            expect(errorCall[2]).toBe('ExceptionFilter');
            // Restaurar o ambiente original
            process.env.NODE_ENV = originalEnv;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbG9nZ2luZ1xcdGVzdHNcXGV4Y2VwdGlvbi5maWx0ZXIuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCwwREFBNEQ7QUFDNUQsd0RBQW9EO0FBQ3BELDJDQUt3QjtBQUd4Qjs7Ozs7R0FLRztBQUNILFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDckMsSUFBSSxNQUE2QixDQUFDO0lBQ2xDLElBQUksY0FBOEIsQ0FBQztJQUVuQyw2QkFBNkI7SUFDN0IsTUFBTSxrQkFBa0IsR0FBRztRQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNqQixDQUFDO0lBRUYsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUVyQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULHdDQUFxQjtnQkFDckI7b0JBQ0UsT0FBTyxFQUFFLGdDQUFjO29CQUN2QixRQUFRLEVBQUUsa0JBQWtCO2lCQUM3QjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQXdCLHdDQUFxQixDQUFDLENBQUM7UUFDbEUsY0FBYyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWlCLGdDQUFjLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9CLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7UUFDckIsRUFBRSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtZQUN0Qyx1QkFBdUI7WUFDdkIsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBYSxDQUNqQyxrQkFBa0IsRUFDbEIsbUJBQVUsQ0FBQyxXQUFXLENBQ3ZCLENBQUM7WUFFRixtQkFBbUI7WUFDbkIsTUFBTSxZQUFZLEdBQUc7Z0JBQ25CLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO2dCQUNsQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNPLENBQUM7WUFFekIscUJBQXFCO1lBQ3JCLE1BQU0sV0FBVyxHQUFHO2dCQUNsQixHQUFHLEVBQUUsV0FBVztnQkFDaEIsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsRUFBRSxFQUFFLFdBQVc7Z0JBQ2YsT0FBTyxFQUFFO29CQUNQLFlBQVksRUFBRSxZQUFZO2lCQUMzQjtnQkFDRCxJQUFJLEVBQUU7b0JBQ0osRUFBRSxFQUFFLFVBQVU7aUJBQ2Y7YUFDb0IsQ0FBQztZQUV4Qiw2QkFBNkI7WUFDN0IsTUFBTSxpQkFBaUIsR0FBRztnQkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ3RDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQztvQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDO2lCQUNuRCxDQUFDO2FBQ3lCLENBQUM7WUFFOUIsb0JBQW9CO1lBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFFM0MsMkVBQTJFO1lBQzNFLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsbUJBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN6RSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFN0MseUNBQXlDO1lBQ3pDLE1BQU0sT0FBTyxHQUFJLFlBQVksQ0FBQyxJQUFrQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FDckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixVQUFVLEVBQUUsbUJBQVUsQ0FBQyxXQUFXO2dCQUNsQyxPQUFPLEVBQUUsa0JBQWtCO2dCQUMzQixJQUFJLEVBQUUsV0FBVzthQUNsQixDQUFDLENBQ0gsQ0FBQztZQUVGLHFDQUFxQztZQUNyQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNwRCxNQUFNLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6RCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDcEQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw4Q0FBOEMsRUFBRSxHQUFHLEVBQUU7WUFDdEQsOEJBQThCO1lBQzlCLE1BQU0sU0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRTVDLG1CQUFtQjtZQUNuQixNQUFNLFlBQVksR0FBRztnQkFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7Z0JBQ2xDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ08sQ0FBQztZQUV6QixxQkFBcUI7WUFDckIsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLEdBQUcsRUFBRSxXQUFXO2dCQUNoQixNQUFNLEVBQUUsTUFBTTtnQkFDZCxFQUFFLEVBQUUsV0FBVztnQkFDZixPQUFPLEVBQUUsRUFBRTthQUNVLENBQUM7WUFFeEIsNkJBQTZCO1lBQzdCLE1BQU0saUJBQWlCLEdBQUc7Z0JBQ3hCLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUN0QyxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUM7b0JBQ3BELFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQztpQkFDbkQsQ0FBQzthQUN5QixDQUFDO1lBRTlCLG9CQUFvQjtZQUNwQixNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1lBRTNDLDJFQUEyRTtZQUMzRSxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUM5QyxtQkFBVSxDQUFDLHFCQUFxQixDQUNqQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBRTdDLHlDQUF5QztZQUN6QyxNQUFNLE9BQU8sR0FBSSxZQUFZLENBQUMsSUFBa0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQ3JCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsVUFBVSxFQUFFLG1CQUFVLENBQUMscUJBQXFCO2dCQUM1QyxPQUFPLEVBQUUsMEJBQTBCO2dCQUNuQyxJQUFJLEVBQUUsV0FBVzthQUNsQixDQUFDLENBQ0gsQ0FBQztZQUVGLHFDQUFxQztZQUNyQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNwRCxNQUFNLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6RCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDcEQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN2QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw4RUFBOEUsRUFBRSxHQUFHLEVBQUU7WUFDdEYsd0NBQXdDO1lBQ3hDLE1BQU0sU0FBUyxHQUFHLElBQUkscUNBQTRCLENBQ2hELDZCQUE2QixDQUM5QixDQUFDO1lBRUYsbUJBQW1CO1lBQ25CLE1BQU0sWUFBWSxHQUFHO2dCQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtnQkFDbEMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDTyxDQUFDO1lBRXpCLHFCQUFxQjtZQUNyQixNQUFNLFdBQVcsR0FBRztnQkFDbEIsR0FBRyxFQUFFLFdBQVc7Z0JBQ2hCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLEVBQUUsRUFBRSxXQUFXO2dCQUNmLE9BQU8sRUFBRSxFQUFFO2FBQ1UsQ0FBQztZQUV4Qiw2QkFBNkI7WUFDN0IsTUFBTSxpQkFBaUIsR0FBRztnQkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ3RDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQztvQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDO2lCQUNuRCxDQUFDO2FBQ3lCLENBQUM7WUFFOUIsb0JBQW9CO1lBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFFM0MsMkVBQTJFO1lBQzNFLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQzlDLG1CQUFVLENBQUMscUJBQXFCLENBQ2pDLENBQUM7WUFDRixNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFN0MseUNBQXlDO1lBQ3pDLE1BQU0sT0FBTyxHQUFJLFlBQVksQ0FBQyxJQUFrQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FDckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixVQUFVLEVBQUUsbUJBQVUsQ0FBQyxxQkFBcUI7Z0JBQzVDLE9BQU8sRUFBRSw2QkFBNkI7Z0JBQ3RDLElBQUksRUFBRSxXQUFXO2FBQ2xCLENBQUMsQ0FDSCxDQUFDO1lBRUYscUNBQXFDO1lBQ3JDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3BELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUNwRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDNUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGlEQUFpRCxFQUFFLEdBQUcsRUFBRTtZQUN6RCw2QkFBNkI7WUFDN0IsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7WUFFekMsbUNBQW1DO1lBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQztZQUVwQyw4QkFBOEI7WUFDOUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztZQUUxRCxtQkFBbUI7WUFDbkIsTUFBTSxZQUFZLEdBQUc7Z0JBQ25CLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO2dCQUNsQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNPLENBQUM7WUFFekIscUJBQXFCO1lBQ3JCLE1BQU0sV0FBVyxHQUFHO2dCQUNsQixHQUFHLEVBQUUsV0FBVztnQkFDaEIsTUFBTSxFQUFFLFFBQVE7Z0JBQ2hCLEVBQUUsRUFBRSxXQUFXO2dCQUNmLE9BQU8sRUFBRSxFQUFFO2FBQ1UsQ0FBQztZQUV4Qiw2QkFBNkI7WUFDN0IsTUFBTSxpQkFBaUIsR0FBRztnQkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ3RDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQztvQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDO2lCQUNuRCxDQUFDO2FBQ3lCLENBQUM7WUFFOUIsb0JBQW9CO1lBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFFM0MsMkVBQTJFO1lBQzNFLGtEQUFrRDtZQUNsRCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUM5QyxtQkFBVSxDQUFDLHFCQUFxQixDQUNqQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBRTdDLHlDQUF5QztZQUN6QyxNQUFNLE9BQU8sR0FBSSxZQUFZLENBQUMsSUFBa0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQ3JCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsVUFBVSxFQUFFLG1CQUFVLENBQUMscUJBQXFCO2dCQUM1QyxPQUFPLEVBQUUsMEJBQTBCO2dCQUNuQyxJQUFJLEVBQUUsV0FBVzthQUNsQixDQUFDLENBQ0gsQ0FBQztZQUVGLCtEQUErRDtZQUMvRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNwRCxNQUFNLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6RCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDcEQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN6QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUU3QyxnQ0FBZ0M7WUFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcc2hhcmVkXFxsb2dnaW5nXFx0ZXN0c1xcZXhjZXB0aW9uLmZpbHRlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgR2xvYmFsRXhjZXB0aW9uRmlsdGVyIH0gZnJvbSAnLi4vZXhjZXB0aW9uLmZpbHRlcic7XG5pbXBvcnQgeyBMb2dnaW5nU2VydmljZSB9IGZyb20gJy4uL2xvZ2dpbmcuc2VydmljZSc7XG5pbXBvcnQge1xuICBBcmd1bWVudHNIb3N0LFxuICBIdHRwRXhjZXB0aW9uLFxuICBIdHRwU3RhdHVzLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgbyBmaWx0cm8gZGUgZXhjZcOnw7VlcyBnbG9iYWxcbiAqXG4gKiBWZXJpZmljYSBvIGNvbXBvcnRhbWVudG8gZG8gZmlsdHJvIGFvIGNhcHR1cmFyIGRpZmVyZW50ZXMgdGlwb3MgZGUgZXhjZcOnw7Vlc1xuICogZSBmb3JtYXRhciBhcyByZXNwb3N0YXMgZGUgZXJybyBhcHJvcHJpYWRhbWVudGVcbiAqL1xuZGVzY3JpYmUoJ0dsb2JhbEV4Y2VwdGlvbkZpbHRlcicsICgpID0+IHtcbiAgbGV0IGZpbHRlcjogR2xvYmFsRXhjZXB0aW9uRmlsdGVyO1xuICBsZXQgbG9nZ2luZ1NlcnZpY2U6IExvZ2dpbmdTZXJ2aWNlO1xuXG4gIC8vIE1vY2sgZG8gc2VydmnDp28gZGUgbG9nZ2luZ1xuICBjb25zdCBtb2NrTG9nZ2luZ1NlcnZpY2UgPSB7XG4gICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgR2xvYmFsRXhjZXB0aW9uRmlsdGVyLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogTG9nZ2luZ1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tMb2dnaW5nU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgZmlsdGVyID0gbW9kdWxlLmdldDxHbG9iYWxFeGNlcHRpb25GaWx0ZXI+KEdsb2JhbEV4Y2VwdGlvbkZpbHRlcik7XG4gICAgbG9nZ2luZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PExvZ2dpbmdTZXJ2aWNlPihMb2dnaW5nU2VydmljZSk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIHNlciBkZWZpbmlkbycsICgpID0+IHtcbiAgICBleHBlY3QoZmlsdGVyKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2F0Y2gnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgbGlkYXIgY29tIEh0dHBFeGNlcHRpb24nLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGRhIGV4Y2XDp8OjbyBIVFRQXG4gICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgJ01lbnNhZ2VtIGRlIGVycm8nLFxuICAgICAgICBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxuICAgICAgKTtcblxuICAgICAgLy8gTW9jayBkYSByZXNwb3N0YVxuICAgICAgY29uc3QgbW9ja1Jlc3BvbnNlID0ge1xuICAgICAgICBzdGF0dXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgICBqc29uOiBqZXN0LmZuKCksXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVzcG9uc2U7XG5cbiAgICAgIC8vIE1vY2sgZGEgcmVxdWlzacOnw6NvXG4gICAgICBjb25zdCBtb2NrUmVxdWVzdCA9IHtcbiAgICAgICAgdXJsOiAnL2FwaS90ZXN0JyxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgaXA6ICcxMjcuMC4wLjEnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ3VzZXItYWdlbnQnOiAndGVzdC1hZ2VudCcsXG4gICAgICAgIH0sXG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBpZDogJ3VzZXItMTIzJyxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBSZXF1ZXN0O1xuXG4gICAgICAvLyBNb2NrIGRvIGhvc3QgZGUgYXJndW1lbnRvc1xuICAgICAgY29uc3QgbW9ja0FyZ3VtZW50c0hvc3QgPSB7XG4gICAgICAgIHN3aXRjaFRvSHR0cDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgZ2V0UmVzcG9uc2U6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja1Jlc3BvbnNlKSxcbiAgICAgICAgICBnZXRSZXF1ZXN0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tSZXF1ZXN0KSxcbiAgICAgICAgfSksXG4gICAgICB9IGFzIHVua25vd24gYXMgQXJndW1lbnRzSG9zdDtcblxuICAgICAgLy8gRXhlY3V0YXIgbyBmaWx0cm9cbiAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIG1vY2tBcmd1bWVudHNIb3N0KTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gc3RhdHVzIGUgbyBjb3JwbyBkYSByZXNwb3N0YSBmb3JhbSBkZWZpbmlkb3MgY29ycmV0YW1lbnRlXG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgLy8gQ2FwdHVyYXIgbyBhcmd1bWVudG8gcGFzc2FkbyBwYXJhIGpzb25cbiAgICAgIGNvbnN0IGpzb25BcmcgPSAobW9ja1Jlc3BvbnNlLmpzb24gYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGpzb25BcmcpLnRvRXF1YWwoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxuICAgICAgICAgIG1lc3NhZ2U6ICdNZW5zYWdlbSBkZSBlcnJvJyxcbiAgICAgICAgICBwYXRoOiAnL2FwaS90ZXN0JyxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyBlcnJvIGZvaSByZWdpc3RyYWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dpbmdTZXJ2aWNlLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBjb25zdCBlcnJvckNhbGwgPSBtb2NrTG9nZ2luZ1NlcnZpY2UuZXJyb3IubW9jay5jYWxsc1swXTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMF0pLnRvQ29udGFpbignRXhjZcOnw6NvIGNhcHR1cmFkYScpO1xuICAgICAgZXhwZWN0KGVycm9yQ2FsbFswXSkudG9Db250YWluKCdHRVQnKTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMF0pLnRvQ29udGFpbignL2FwaS90ZXN0Jyk7XG4gICAgICBleHBlY3QoZXJyb3JDYWxsWzJdKS50b0JlKCdFeGNlcHRpb25GaWx0ZXInKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxpZGFyIGNvbSBleGNlw6fDtWVzIGludGVybmFzIGRvIHNlcnZpZG9yJywgKCkgPT4ge1xuICAgICAgLy8gTW9jayBkZSB1bWEgZXhjZcOnw6NvIGludGVybmFcbiAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignRXJybyBpbnRlcm5vJyk7XG5cbiAgICAgIC8vIE1vY2sgZGEgcmVzcG9zdGFcbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgc3RhdHVzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAganNvbjogamVzdC5mbigpLFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlc3BvbnNlO1xuXG4gICAgICAvLyBNb2NrIGRhIHJlcXVpc2nDp8Ojb1xuICAgICAgY29uc3QgbW9ja1JlcXVlc3QgPSB7XG4gICAgICAgIHVybDogJy9hcGkvdGVzdCcsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBpcDogJzEyNy4wLjAuMScsXG4gICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlcXVlc3Q7XG5cbiAgICAgIC8vIE1vY2sgZG8gaG9zdCBkZSBhcmd1bWVudG9zXG4gICAgICBjb25zdCBtb2NrQXJndW1lbnRzSG9zdCA9IHtcbiAgICAgICAgc3dpdGNoVG9IdHRwOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICBnZXRSZXNwb25zZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrUmVzcG9uc2UpLFxuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja1JlcXVlc3QpLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBBcmd1bWVudHNIb3N0O1xuXG4gICAgICAvLyBFeGVjdXRhciBvIGZpbHRyb1xuICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgbW9ja0FyZ3VtZW50c0hvc3QpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyBzdGF0dXMgZSBvIGNvcnBvIGRhIHJlc3Bvc3RhIGZvcmFtIGRlZmluaWRvcyBjb3JyZXRhbWVudGVcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIENhcHR1cmFyIG8gYXJndW1lbnRvIHBhc3NhZG8gcGFyYSBqc29uXG4gICAgICBjb25zdCBqc29uQXJnID0gKG1vY2tSZXNwb25zZS5qc29uIGFzIGplc3QuTW9jaykubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChqc29uQXJnKS50b0VxdWFsKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgbWVzc2FnZTogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicsXG4gICAgICAgICAgcGF0aDogJy9hcGkvdGVzdCcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gZXJybyBmb2kgcmVnaXN0cmFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnaW5nU2VydmljZS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgY29uc3QgZXJyb3JDYWxsID0gbW9ja0xvZ2dpbmdTZXJ2aWNlLmVycm9yLm1vY2suY2FsbHNbMF07XG4gICAgICBleHBlY3QoZXJyb3JDYWxsWzBdKS50b0NvbnRhaW4oJ0V4Y2XDp8OjbyBjYXB0dXJhZGEnKTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMF0pLnRvQ29udGFpbignUE9TVCcpO1xuICAgICAgZXhwZWN0KGVycm9yQ2FsbFswXSkudG9Db250YWluKCcvYXBpL3Rlc3QnKTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMl0pLnRvQmUoJ0V4Y2VwdGlvbkZpbHRlcicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcHJlc2VydmFyIGEgbWVuc2FnZW0gZGUgZXJybyBvcmlnaW5hbCBwYXJhIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24nLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGRlIHVtYSBleGNlw6fDo28gaW50ZXJuYSBkbyBOZXN0SlNcbiAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBlc3BlY8OtZmljbyBkbyBzZXJ2aWRvcicsXG4gICAgICApO1xuXG4gICAgICAvLyBNb2NrIGRhIHJlc3Bvc3RhXG4gICAgICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgICAgIHN0YXR1czogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgIGpzb246IGplc3QuZm4oKSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBSZXNwb25zZTtcblxuICAgICAgLy8gTW9jayBkYSByZXF1aXNpw6fDo29cbiAgICAgIGNvbnN0IG1vY2tSZXF1ZXN0ID0ge1xuICAgICAgICB1cmw6ICcvYXBpL3Rlc3QnLFxuICAgICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgICBpcDogJzEyNy4wLjAuMScsXG4gICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlcXVlc3Q7XG5cbiAgICAgIC8vIE1vY2sgZG8gaG9zdCBkZSBhcmd1bWVudG9zXG4gICAgICBjb25zdCBtb2NrQXJndW1lbnRzSG9zdCA9IHtcbiAgICAgICAgc3dpdGNoVG9IdHRwOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICBnZXRSZXNwb25zZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrUmVzcG9uc2UpLFxuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja1JlcXVlc3QpLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBBcmd1bWVudHNIb3N0O1xuXG4gICAgICAvLyBFeGVjdXRhciBvIGZpbHRyb1xuICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgbW9ja0FyZ3VtZW50c0hvc3QpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgbyBzdGF0dXMgZSBvIGNvcnBvIGRhIHJlc3Bvc3RhIGZvcmFtIGRlZmluaWRvcyBjb3JyZXRhbWVudGVcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIENhcHR1cmFyIG8gYXJndW1lbnRvIHBhc3NhZG8gcGFyYSBqc29uXG4gICAgICBjb25zdCBqc29uQXJnID0gKG1vY2tSZXNwb25zZS5qc29uIGFzIGplc3QuTW9jaykubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChqc29uQXJnKS50b0VxdWFsKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgbWVzc2FnZTogJ0Vycm8gZXNwZWPDrWZpY28gZG8gc2Vydmlkb3InLFxuICAgICAgICAgIHBhdGg6ICcvYXBpL3Rlc3QnLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvIGVycm8gZm9pIHJlZ2lzdHJhZG9cbiAgICAgIGV4cGVjdChtb2NrTG9nZ2luZ1NlcnZpY2UuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGNvbnN0IGVycm9yQ2FsbCA9IG1vY2tMb2dnaW5nU2VydmljZS5lcnJvci5tb2NrLmNhbGxzWzBdO1xuICAgICAgZXhwZWN0KGVycm9yQ2FsbFswXSkudG9Db250YWluKCdFeGNlw6fDo28gY2FwdHVyYWRhJyk7XG4gICAgICBleHBlY3QoZXJyb3JDYWxsWzBdKS50b0NvbnRhaW4oJ1BVVCcpO1xuICAgICAgZXhwZWN0KGVycm9yQ2FsbFswXSkudG9Db250YWluKCcvYXBpL3Rlc3QnKTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMl0pLnRvQmUoJ0V4Y2VwdGlvbkZpbHRlcicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGlkYXIgY29tIGV4Y2XDp8O1ZXMgZW0gYW1iaWVudGUgZGUgcHJvZHXDp8OjbycsICgpID0+IHtcbiAgICAgIC8vIFNhbHZhciBvIGFtYmllbnRlIG9yaWdpbmFsXG4gICAgICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WO1xuXG4gICAgICAvLyBEZWZpbmlyIG8gYW1iaWVudGUgY29tbyBwcm9kdcOnw6NvXG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdwcm9kdWN0aW9uJztcblxuICAgICAgLy8gTW9jayBkZSB1bWEgZXhjZcOnw6NvIGludGVybmFcbiAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignRGV0YWxoZXMgc2Vuc8OtdmVpcyBkbyBlcnJvJyk7XG5cbiAgICAgIC8vIE1vY2sgZGEgcmVzcG9zdGFcbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgc3RhdHVzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAganNvbjogamVzdC5mbigpLFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlc3BvbnNlO1xuXG4gICAgICAvLyBNb2NrIGRhIHJlcXVpc2nDp8Ojb1xuICAgICAgY29uc3QgbW9ja1JlcXVlc3QgPSB7XG4gICAgICAgIHVybDogJy9hcGkvdGVzdCcsXG4gICAgICAgIG1ldGhvZDogJ0RFTEVURScsXG4gICAgICAgIGlwOiAnMTI3LjAuMC4xJyxcbiAgICAgICAgaGVhZGVyczoge30sXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVxdWVzdDtcblxuICAgICAgLy8gTW9jayBkbyBob3N0IGRlIGFyZ3VtZW50b3NcbiAgICAgIGNvbnN0IG1vY2tBcmd1bWVudHNIb3N0ID0ge1xuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlc3BvbnNlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tSZXNwb25zZSksXG4gICAgICAgICAgZ2V0UmVxdWVzdDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrUmVxdWVzdCksXG4gICAgICAgIH0pLFxuICAgICAgfSBhcyB1bmtub3duIGFzIEFyZ3VtZW50c0hvc3Q7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIG8gZmlsdHJvXG4gICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBtb2NrQXJndW1lbnRzSG9zdCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvIHN0YXR1cyBlIG8gY29ycG8gZGEgcmVzcG9zdGEgZm9yYW0gZGVmaW5pZG9zIGNvcnJldGFtZW50ZVxuICAgICAgLy8gRW0gcHJvZHXDp8OjbywgbsOjbyBkZXZlbW9zIGV4cG9yIGRldGFsaGVzIGRvIGVycm9cbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAgIC8vIENhcHR1cmFyIG8gYXJndW1lbnRvIHBhc3NhZG8gcGFyYSBqc29uXG4gICAgICBjb25zdCBqc29uQXJnID0gKG1vY2tSZXNwb25zZS5qc29uIGFzIGplc3QuTW9jaykubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChqc29uQXJnKS50b0VxdWFsKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgbWVzc2FnZTogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicsXG4gICAgICAgICAgcGF0aDogJy9hcGkvdGVzdCcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gZXJybyBmb2kgcmVnaXN0cmFkbyBjb20gb3MgZGV0YWxoZXMgY29tcGxldG9zXG4gICAgICBleHBlY3QobW9ja0xvZ2dpbmdTZXJ2aWNlLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBjb25zdCBlcnJvckNhbGwgPSBtb2NrTG9nZ2luZ1NlcnZpY2UuZXJyb3IubW9jay5jYWxsc1swXTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMF0pLnRvQ29udGFpbignRXhjZcOnw6NvIGNhcHR1cmFkYScpO1xuICAgICAgZXhwZWN0KGVycm9yQ2FsbFswXSkudG9Db250YWluKCdERUxFVEUnKTtcbiAgICAgIGV4cGVjdChlcnJvckNhbGxbMF0pLnRvQ29udGFpbignL2FwaS90ZXN0Jyk7XG4gICAgICBleHBlY3QoZXJyb3JDYWxsWzJdKS50b0JlKCdFeGNlcHRpb25GaWx0ZXInKTtcblxuICAgICAgLy8gUmVzdGF1cmFyIG8gYW1iaWVudGUgb3JpZ2luYWxcbiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gb3JpZ2luYWxFbnY7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=