db6da194576fa1e43ce23350fcb7cd01
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PermissionModule_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PermissionModule = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const cache_manager_1 = require("@nestjs/cache-manager");
const config_1 = require("@nestjs/config");
// Entities
const permission_entity_1 = require("../entities/permission.entity");
const permission_group_entity_1 = require("../entities/permission-group.entity");
const permission_group_mapping_entity_1 = require("../entities/permission-group-mapping.entity");
const role_permission_entity_1 = require("../entities/role-permission.entity");
const user_permission_entity_1 = require("../entities/user-permission.entity");
const permission_scope_entity_1 = require("../entities/permission-scope.entity");
// Repositories
const permission_repository_1 = require("./repositories/permission.repository");
const permission_group_repository_1 = require("./repositories/permission-group.repository");
const permission_group_mapping_repository_1 = require("./repositories/permission-group-mapping.repository");
const role_permission_repository_1 = require("./repositories/role-permission.repository");
const user_permission_repository_1 = require("./repositories/user-permission.repository");
const permission_scope_repository_1 = require("./repositories/permission-scope.repository");
// Services
const permission_service_1 = require("./services/permission.service");
// Guards
const permission_guard_1 = require("./guards/permission.guard");
// Constants
const PERMISSION_CACHE_CONFIG = {
    TTL_SECONDS: 300, // 5 minutos
    MAX_ITEMS: 1000,
    STORE: 'memory',
};
/**
 * M√≥dulo de Permiss√µes Granulares
 *
 * Respons√°vel por:
 * - Gerenciamento de permiss√µes granulares por usu√°rio e role
 * - Sistema de cache para otimiza√ß√£o de performance
 * - Guards para controle de acesso baseado em permiss√µes
 * - Reposit√≥rios especializados para queries de permiss√µes
 * - Integra√ß√£o com sistema de escopos (unidade, regional, etc.)
 *
 * @example
 * ```typescript
 * // Uso do guard em controllers
 * @UseGuards(PermissionGuard)
 * @RequiresPermission({
 *   permissionName: 'user.create',
 *   scopeType: TipoEscopo.UNIDADE,
 *   scopeIdExpression: 'params.unidadeId'
 * })
 * async createUser() { ... }
 * ```
 */
let PermissionModule = PermissionModule_1 = class PermissionModule {
    permissionService;
    logger = new common_1.Logger(PermissionModule_1.name);
    constructor(permissionService) {
        this.permissionService = permissionService;
    }
    /**
     * Inicializa√ß√£o do m√≥dulo com valida√ß√µes de integridade
     */
    async onModuleInit() {
        this.logger.log('üîê Inicializando PermissionModule...');
        try {
            await this.validateModuleIntegrity();
            await this.performStartupTasks();
            this.logger.log('‚úÖ PermissionModule inicializado com sucesso');
        }
        catch (error) {
            this.logger.error(`‚ùå Erro cr√≠tico durante inicializa√ß√£o do PermissionModule: ${error.message}`, error.stack);
            // Em caso de erro cr√≠tico, n√£o permitir que a aplica√ß√£o continue
            // pois permiss√µes s√£o fundamentais para seguran√ßa
            throw new Error(`PermissionModule falhou na inicializa√ß√£o: ${error.message}`);
        }
    }
    /**
     * Valida a integridade do m√≥dulo e suas depend√™ncias
     * @private
     */
    async validateModuleIntegrity() {
        this.logger.debug('Validando integridade do m√≥dulo...');
        // Verifica se o PermissionService foi injetado corretamente
        if (!this.permissionService) {
            throw new Error('PermissionService n√£o foi injetado corretamente. Verifique as depend√™ncias.');
        }
        // Testa conectividade b√°sica com o banco de dados
        try {
            // Chama getAllPermissions sem argumentos (conforme assinatura correta)
            await this.permissionService.getAllPermissions();
            this.logger.debug('‚úì Conectividade com PermissionService validada');
        }
        catch (error) {
            this.logger.warn(`Aviso na valida√ß√£o de conectividade: ${error.message}. Continuando inicializa√ß√£o...`);
            // N√£o falha a inicializa√ß√£o por problemas de valida√ß√£o b√°sica
            // A valida√ß√£o mais rigorosa ser√° feita quando o servi√ßo for efetivamente usado
        }
    }
    /**
     * Executa tarefas de inicializa√ß√£o necess√°rias
     * @private
     */
    async performStartupTasks() {
        this.logger.debug('Executando tarefas de inicializa√ß√£o...');
        try {
            // Como clearPermissionCache requer um permissionName espec√≠fico,
            // n√£o executamos limpeza geral de cache na inicializa√ß√£o para evitar
            // problemas. O cache ser√° gerenciado naturalmente pelo TTL configurado.
            this.logger.debug('‚úì Cache ser√° gerenciado pelo TTL configurado');
            // Pode incluir outras tarefas como:
            // - Sincroniza√ß√£o de permiss√µes padr√£o
            // - Verifica√ß√£o de integridade de dados
            // - Valida√ß√£o de permiss√µes cr√≠ticas do sistema
        }
        catch (error) {
            this.logger.warn(`Aviso durante tarefas de inicializa√ß√£o: ${error.message}`);
            // Tarefas de inicializa√ß√£o podem falhar sem comprometer o m√≥dulo
        }
    }
};
exports.PermissionModule = PermissionModule;
exports.PermissionModule = PermissionModule = PermissionModule_1 = __decorate([
    (0, common_1.Module)({
        imports: [
            // Configura√ß√£o das entidades
            typeorm_1.TypeOrmModule.forFeature([
                permission_entity_1.Permission,
                permission_group_entity_1.PermissionGroup,
                permission_group_mapping_entity_1.PermissionGroupMapping,
                role_permission_entity_1.RolePermission,
                user_permission_entity_1.UserPermission,
                permission_scope_entity_1.PermissionScope,
            ]),
            // Cache configur√°vel para permiss√µes
            cache_manager_1.CacheModule.registerAsync({
                imports: [config_1.ConfigModule],
                inject: [config_1.ConfigService],
                useFactory: (configService) => ({
                    ttl: configService.get('PERMISSION_CACHE_TTL', PERMISSION_CACHE_CONFIG.TTL_SECONDS * 1000),
                    max: configService.get('PERMISSION_CACHE_MAX_ITEMS', PERMISSION_CACHE_CONFIG.MAX_ITEMS),
                    store: PERMISSION_CACHE_CONFIG.STORE,
                    isGlobal: false, // Scoped para evitar conflitos
                }),
            }),
            config_1.ConfigModule,
        ],
        providers: [
            // Reposit√≥rios customizados
            permission_repository_1.PermissionRepository,
            permission_group_repository_1.PermissionGroupRepository,
            permission_group_mapping_repository_1.PermissionGroupMappingRepository,
            role_permission_repository_1.RolePermissionRepository,
            user_permission_repository_1.UserPermissionRepository,
            permission_scope_repository_1.PermissionScopeRepository,
            // Servi√ßo principal
            permission_service_1.PermissionService,
            // Guards
            permission_guard_1.PermissionGuard,
        ],
        exports: [
            // Servi√ßo para uso em outros m√≥dulos
            permission_service_1.PermissionService,
            // Guard para controle de acesso
            permission_guard_1.PermissionGuard,
            // Reposit√≥rios para uso avan√ßado
            permission_repository_1.PermissionRepository,
            role_permission_repository_1.RolePermissionRepository,
            user_permission_repository_1.UserPermissionRepository,
            permission_scope_repository_1.PermissionScopeRepository,
        ],
    }),
    __metadata("design:paramtypes", [typeof (_a = typeof permission_service_1.PermissionService !== "undefined" && permission_service_1.PermissionService) === "function" ? _a : Object])
], PermissionModule);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHBlcm1pc3Npb24ubW9kdWxlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQThEO0FBQzlELDZDQUFnRDtBQUNoRCx5REFBb0Q7QUFDcEQsMkNBQTZEO0FBRTdELFdBQVc7QUFDWCxxRUFBMkQ7QUFDM0QsaUZBQXNFO0FBQ3RFLGlHQUFxRjtBQUNyRiwrRUFBb0U7QUFDcEUsK0VBQW9FO0FBQ3BFLGlGQUFzRTtBQUV0RSxlQUFlO0FBQ2YsZ0ZBQTRFO0FBQzVFLDRGQUF1RjtBQUN2Riw0R0FBc0c7QUFDdEcsMEZBQXFGO0FBQ3JGLDBGQUFxRjtBQUNyRiw0RkFBdUY7QUFFdkYsV0FBVztBQUNYLHNFQUFrRTtBQUVsRSxTQUFTO0FBQ1QsZ0VBQTREO0FBRTVELFlBQVk7QUFDWixNQUFNLHVCQUF1QixHQUFHO0lBQzlCLFdBQVcsRUFBRSxHQUFHLEVBQUUsWUFBWTtJQUM5QixTQUFTLEVBQUUsSUFBSTtJQUNmLEtBQUssRUFBRSxRQUFpQjtDQUN6QixDQUFDO0FBRUY7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXFCRztBQWdFSSxJQUFNLGdCQUFnQix3QkFBdEIsTUFBTSxnQkFBZ0I7SUFHRTtJQUZaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxrQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU1RCxZQUE2QixpQkFBb0M7UUFBcEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtJQUFHLENBQUM7SUFFckU7O09BRUc7SUFDSCxLQUFLLENBQUMsWUFBWTtRQUNoQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO1FBRXhELElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7WUFDckMsTUFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUVqQyxJ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Q1QsNEJBQTRCO1lBQzVCLDRDQUFvQjtZQUNwQix1REFBeUI7WUFDekIsc0VBQWdDO1lBQ2hDLHFEQUF3QjtZQUN4QixxREFBd0I7WUFDeEIsdURBQXlCO1lBRXpCLG9CQUFvQjtZQUNwQixzQ0FBaUI7WUFFakIsU0FBUztZQUNULGtDQUFlO1NBQ2hCO1FBRUQsT0FBTyxFQUFFO1lBQ1AscUNBQXFDO1lBQ3JDLHNDQUFpQjtZQUVqQixnQ0FBZ0M7WUFDaEMsa0NBQWU7WUFFZixpQ0FBaUM7WUFDakMsNENBQW9CO1lBQ3BCLHFEQUF3QjtZQUN4QixxREFBd0I7WUFDeEIsdURBQXlCO1NBQzFCO0tBQ0YsQ0FBQzt5REFJZ0Qsc0NBQWlCLG9CQUFqQixzQ0FBaUI7R0FIdEQsZ0JBQWdCLENBa0Y1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcYXV0aFxccGVybWlzc2lvbi5tb2R1bGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kdWxlLCBMb2dnZXIsIE9uTW9kdWxlSW5pdCB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFR5cGVPcm1Nb2R1bGUgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgQ2FjaGVNb2R1bGUgfSBmcm9tICdAbmVzdGpzL2NhY2hlLW1hbmFnZXInO1xuaW1wb3J0IHsgQ29uZmlnTW9kdWxlLCBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuXG4vLyBFbnRpdGllc1xuaW1wb3J0IHsgUGVybWlzc2lvbiB9IGZyb20gJy4uL2VudGl0aWVzL3Blcm1pc3Npb24uZW50aXR5JztcbmltcG9ydCB7IFBlcm1pc3Npb25Hcm91cCB9IGZyb20gJy4uL2VudGl0aWVzL3Blcm1pc3Npb24tZ3JvdXAuZW50aXR5JztcbmltcG9ydCB7IFBlcm1pc3Npb25Hcm91cE1hcHBpbmcgfSBmcm9tICcuLi9lbnRpdGllcy9wZXJtaXNzaW9uLWdyb3VwLW1hcHBpbmcuZW50aXR5JztcbmltcG9ydCB7IFJvbGVQZXJtaXNzaW9uIH0gZnJvbSAnLi4vZW50aXRpZXMvcm9sZS1wZXJtaXNzaW9uLmVudGl0eSc7XG5pbXBvcnQgeyBVc2VyUGVybWlzc2lvbiB9IGZyb20gJy4uL2VudGl0aWVzL3VzZXItcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgUGVybWlzc2lvblNjb3BlIH0gZnJvbSAnLi4vZW50aXRpZXMvcGVybWlzc2lvbi1zY29wZS5lbnRpdHknO1xuXG4vLyBSZXBvc2l0b3JpZXNcbmltcG9ydCB7IFBlcm1pc3Npb25SZXBvc2l0b3J5IH0gZnJvbSAnLi9yZXBvc2l0b3JpZXMvcGVybWlzc2lvbi5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFBlcm1pc3Npb25Hcm91cFJlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcy9wZXJtaXNzaW9uLWdyb3VwLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgUGVybWlzc2lvbkdyb3VwTWFwcGluZ1JlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcy9wZXJtaXNzaW9uLWdyb3VwLW1hcHBpbmcucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcy9yb2xlLXBlcm1pc3Npb24ucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBVc2VyUGVybWlzc2lvblJlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcy91c2VyLXBlcm1pc3Npb24ucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5IH0gZnJvbSAnLi9yZXBvc2l0b3JpZXMvcGVybWlzc2lvbi1zY29wZS5yZXBvc2l0b3J5JztcblxuLy8gU2VydmljZXNcbmltcG9ydCB7IFBlcm1pc3Npb25TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9wZXJtaXNzaW9uLnNlcnZpY2UnO1xuXG4vLyBHdWFyZHNcbmltcG9ydCB7IFBlcm1pc3Npb25HdWFyZCB9IGZyb20gJy4vZ3VhcmRzL3Blcm1pc3Npb24uZ3VhcmQnO1xuXG4vLyBDb25zdGFudHNcbmNvbnN0IFBFUk1JU1NJT05fQ0FDSEVfQ09ORklHID0ge1xuICBUVExfU0VDT05EUzogMzAwLCAvLyA1IG1pbnV0b3NcbiAgTUFYX0lURU1TOiAxMDAwLFxuICBTVE9SRTogJ21lbW9yeScgYXMgY29uc3QsXG59O1xuXG4vKipcbiAqIE3Ds2R1bG8gZGUgUGVybWlzc8O1ZXMgR3JhbnVsYXJlc1xuICpcbiAqIFJlc3BvbnPDoXZlbCBwb3I6XG4gKiAtIEdlcmVuY2lhbWVudG8gZGUgcGVybWlzc8O1ZXMgZ3JhbnVsYXJlcyBwb3IgdXN1w6FyaW8gZSByb2xlXG4gKiAtIFNpc3RlbWEgZGUgY2FjaGUgcGFyYSBvdGltaXphw6fDo28gZGUgcGVyZm9ybWFuY2VcbiAqIC0gR3VhcmRzIHBhcmEgY29udHJvbGUgZGUgYWNlc3NvIGJhc2VhZG8gZW0gcGVybWlzc8O1ZXNcbiAqIC0gUmVwb3NpdMOzcmlvcyBlc3BlY2lhbGl6YWRvcyBwYXJhIHF1ZXJpZXMgZGUgcGVybWlzc8O1ZXNcbiAqIC0gSW50ZWdyYcOnw6NvIGNvbSBzaXN0ZW1hIGRlIGVzY29wb3MgKHVuaWRhZGUsIHJlZ2lvbmFsLCBldGMuKVxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiAvLyBVc28gZG8gZ3VhcmQgZW0gY29udHJvbGxlcnNcbiAqIEBVc2VHdWFyZHMoUGVybWlzc2lvbkd1YXJkKVxuICogQFJlcXVpcmVzUGVybWlzc2lvbih7XG4gKiAgIHBlcm1pc3Npb25OYW1lOiAndXNlci5jcmVhdGUnLFxuICogICBzY29wZVR5cGU6IFRpcG9Fc2NvcG8uVU5JREFERSxcbiAqICAgc2NvcGVJZEV4cHJlc3Npb246ICdwYXJhbXMudW5pZGFkZUlkJ1xuICogfSlcbiAqIGFzeW5jIGNyZWF0ZVVzZXIoKSB7IC4uLiB9XG4gKiBgYGBcbiAqL1xuQE1vZHVsZSh7XG4gIGltcG9ydHM6IFtcbiAgICAvLyBDb25maWd1cmHDp8OjbyBkYXMgZW50aWRhZGVzXG4gICAgVHlwZU9ybU1vZHVsZS5mb3JGZWF0dXJlKFtcbiAgICAgIFBlcm1pc3Npb24sXG4gICAgICBQZXJtaXNzaW9uR3JvdXAsXG4gICAgICBQZXJtaXNzaW9uR3JvdXBNYXBwaW5nLFxuICAgICAgUm9sZVBlcm1pc3Npb24sXG4gICAgICBVc2VyUGVybWlzc2lvbixcbiAgICAgIFBlcm1pc3Npb25TY29wZSxcbiAgICBdKSxcblxuICAgIC8vIENhY2hlIGNvbmZpZ3Vyw6F2ZWwgcGFyYSBwZXJtaXNzw7Vlc1xuICAgIENhY2hlTW9kdWxlLnJlZ2lzdGVyQXN5bmMoe1xuICAgICAgaW1wb3J0czogW0NvbmZpZ01vZHVsZV0sXG4gICAgICBpbmplY3Q6IFtDb25maWdTZXJ2aWNlXSxcbiAgICAgIHVzZUZhY3Rvcnk6IChjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlKSA9PiAoe1xuICAgICAgICB0dGw6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXG4gICAgICAgICAgJ1BFUk1JU1NJT05fQ0FDSEVfVFRMJyxcbiAgICAgICAgICBQRVJNSVNTSU9OX0NBQ0hFX0NPTkZJRy5UVExfU0VDT05EUyAqIDEwMDAsXG4gICAgICAgICksXG4gICAgICAgIG1heDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPihcbiAgICAgICAgICAnUEVSTUlTU0lPTl9DQUNIRV9NQVhfSVRFTVMnLFxuICAgICAgICAgIFBFUk1JU1NJT05fQ0FDSEVfQ09ORklHLk1BWF9JVEVNUyxcbiAgICAgICAgKSxcbiAgICAgICAgc3RvcmU6IFBFUk1JU1NJT05fQ0FDSEVfQ09ORklHLlNUT1JFLFxuICAgICAgICBpc0dsb2JhbDogZmFsc2UsIC8vIFNjb3BlZCBwYXJhIGV2aXRhciBjb25mbGl0b3NcbiAgICAgIH0pLFxuICAgIH0pLFxuXG4gICAgQ29uZmlnTW9kdWxlLFxuICBdLFxuXG4gIHByb3ZpZGVyczogW1xuICAgIC8vIFJlcG9zaXTDs3Jpb3MgY3VzdG9taXphZG9zXG4gICAgUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgUGVybWlzc2lvbkdyb3VwUmVwb3NpdG9yeSxcbiAgICBQZXJtaXNzaW9uR3JvdXBNYXBwaW5nUmVwb3NpdG9yeSxcbiAgICBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgVXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LFxuICAgIFBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnksXG5cbiAgICAvLyBTZXJ2acOnbyBwcmluY2lwYWxcbiAgICBQZXJtaXNzaW9uU2VydmljZSxcblxuICAgIC8vIEd1YXJkc1xuICAgIFBlcm1pc3Npb25HdWFyZCxcbiAgXSxcblxuICBleHBvcnRzOiBbXG4gICAgLy8gU2VydmnDp28gcGFyYSB1c28gZW0gb3V0cm9zIG3Ds2R1bG9zXG4gICAgUGVybWlzc2lvblNlcnZpY2UsXG5cbiAgICAvLyBHdWFyZCBwYXJhIGNvbnRyb2xlIGRlIGFjZXNzb1xuICAgIFBlcm1pc3Npb25HdWFyZCxcblxuICAgIC8vIFJlcG9zaXTDs3Jpb3MgcGFyYSB1c28gYXZhbsOnYWRvXG4gICAgUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgUm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5LFxuICAgIFVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeSxcbiAgICBQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5LFxuICBdLFxufSlcbmV4cG9ydCBjbGFzcyBQZXJtaXNzaW9uTW9kdWxlIGltcGxlbWVudHMgT25Nb2R1bGVJbml0IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFBlcm1pc3Npb25Nb2R1bGUubmFtZSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uU2VydmljZTogUGVybWlzc2lvblNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIEluaWNpYWxpemHDp8OjbyBkbyBtw7NkdWxvIGNvbSB2YWxpZGHDp8O1ZXMgZGUgaW50ZWdyaWRhZGVcbiAgICovXG4gIGFzeW5jIG9uTW9kdWxlSW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coJ/CflJAgSW5pY2lhbGl6YW5kbyBQZXJtaXNzaW9uTW9kdWxlLi4uJyk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy52YWxpZGF0ZU1vZHVsZUludGVncml0eSgpO1xuICAgICAgYXdhaXQgdGhpcy5wZXJmb3JtU3RhcnR1cFRhc2tzKCk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZygn4pyFIFBlcm1pc3Npb25Nb2R1bGUgaW5pY2lhbGl6YWRvIGNvbSBzdWNlc3NvJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBg4p2MIEVycm8gY3LDrXRpY28gZHVyYW50ZSBpbmljaWFsaXphw6fDo28gZG8gUGVybWlzc2lvbk1vZHVsZTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcblxuICAgICAgLy8gRW0gY2FzbyBkZSBlcnJvIGNyw610aWNvLCBuw6NvIHBlcm1pdGlyIHF1ZSBhIGFwbGljYcOnw6NvIGNvbnRpbnVlXG4gICAgICAvLyBwb2lzIHBlcm1pc3PDtWVzIHPDo28gZnVuZGFtZW50YWlzIHBhcmEgc2VndXJhbsOnYVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgUGVybWlzc2lvbk1vZHVsZSBmYWxob3UgbmEgaW5pY2lhbGl6YcOnw6NvOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBhIGludGVncmlkYWRlIGRvIG3Ds2R1bG8gZSBzdWFzIGRlcGVuZMOqbmNpYXNcbiAgICogQHByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgdmFsaWRhdGVNb2R1bGVJbnRlZ3JpdHkoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ1ZhbGlkYW5kbyBpbnRlZ3JpZGFkZSBkbyBtw7NkdWxvLi4uJyk7XG5cbiAgICAvLyBWZXJpZmljYSBzZSBvIFBlcm1pc3Npb25TZXJ2aWNlIGZvaSBpbmpldGFkbyBjb3JyZXRhbWVudGVcbiAgICBpZiAoIXRoaXMucGVybWlzc2lvblNlcnZpY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1Blcm1pc3Npb25TZXJ2aWNlIG7Do28gZm9pIGluamV0YWRvIGNvcnJldGFtZW50ZS4gVmVyaWZpcXVlIGFzIGRlcGVuZMOqbmNpYXMuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVGVzdGEgY29uZWN0aXZpZGFkZSBiw6FzaWNhIGNvbSBvIGJhbmNvIGRlIGRhZG9zXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoYW1hIGdldEFsbFBlcm1pc3Npb25zIHNlbSBhcmd1bWVudG9zIChjb25mb3JtZSBhc3NpbmF0dXJhIGNvcnJldGEpXG4gICAgICBhd2FpdCB0aGlzLnBlcm1pc3Npb25TZXJ2aWNlLmdldEFsbFBlcm1pc3Npb25zKCk7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1Zygn4pyTIENvbmVjdGl2aWRhZGUgY29tIFBlcm1pc3Npb25TZXJ2aWNlIHZhbGlkYWRhJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgIGBBdmlzbyBuYSB2YWxpZGHDp8OjbyBkZSBjb25lY3RpdmlkYWRlOiAke2Vycm9yLm1lc3NhZ2V9LiBDb250aW51YW5kbyBpbmljaWFsaXphw6fDo28uLi5gLFxuICAgICAgKTtcbiAgICAgIC8vIE7Do28gZmFsaGEgYSBpbmljaWFsaXphw6fDo28gcG9yIHByb2JsZW1hcyBkZSB2YWxpZGHDp8OjbyBiw6FzaWNhXG4gICAgICAvLyBBIHZhbGlkYcOnw6NvIG1haXMgcmlnb3Jvc2Egc2Vyw6EgZmVpdGEgcXVhbmRvIG8gc2VydmnDp28gZm9yIGVmZXRpdmFtZW50ZSB1c2Fkb1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRhIHRhcmVmYXMgZGUgaW5pY2lhbGl6YcOnw6NvIG5lY2Vzc8Ohcmlhc1xuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwZXJmb3JtU3RhcnR1cFRhc2tzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdFeGVjdXRhbmRvIHRhcmVmYXMgZGUgaW5pY2lhbGl6YcOnw6NvLi4uJyk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ29tbyBjbGVhclBlcm1pc3Npb25DYWNoZSByZXF1ZXIgdW0gcGVybWlzc2lvbk5hbWUgZXNwZWPDrWZpY28sXG4gICAgICAvLyBuw6NvIGV4ZWN1dGFtb3MgbGltcGV6YSBnZXJhbCBkZSBjYWNoZSBuYSBpbmljaWFsaXphw6fDo28gcGFyYSBldml0YXJcbiAgICAgIC8vIHByb2JsZW1hcy4gTyBjYWNoZSBzZXLDoSBnZXJlbmNpYWRvIG5hdHVyYWxtZW50ZSBwZWxvIFRUTCBjb25maWd1cmFkby5cbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCfinJMgQ2FjaGUgc2Vyw6EgZ2VyZW5jaWFkbyBwZWxvIFRUTCBjb25maWd1cmFkbycpO1xuXG4gICAgICAvLyBQb2RlIGluY2x1aXIgb3V0cmFzIHRhcmVmYXMgY29tbzpcbiAgICAgIC8vIC0gU2luY3Jvbml6YcOnw6NvIGRlIHBlcm1pc3PDtWVzIHBhZHLDo29cbiAgICAgIC8vIC0gVmVyaWZpY2HDp8OjbyBkZSBpbnRlZ3JpZGFkZSBkZSBkYWRvc1xuICAgICAgLy8gLSBWYWxpZGHDp8OjbyBkZSBwZXJtaXNzw7VlcyBjcsOtdGljYXMgZG8gc2lzdGVtYVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgQXZpc28gZHVyYW50ZSB0YXJlZmFzIGRlIGluaWNpYWxpemHDp8OjbzogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgICAgLy8gVGFyZWZhcyBkZSBpbmljaWFsaXphw6fDo28gcG9kZW0gZmFsaGFyIHNlbSBjb21wcm9tZXRlciBvIG3Ds2R1bG9cbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==