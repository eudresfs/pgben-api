e6c75a6c1929d22c4252fa507b1c324d
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PixValidator = void 0;
const common_1 = require("@nestjs/common");
const uuid_1 = require("uuid");
/**
 * Serviço para validação de chaves PIX
 *
 * Implementa funções para validar os diferentes tipos de chaves PIX
 * (CPF, e-mail, telefone, chave aleatória) de acordo com as regras do Bacen.
 *
 * @author Equipe PGBen
 */
let PixValidator = class PixValidator {
    validarChavePix(arg0, arg1) {
        throw new Error('Method not implemented.');
    }
    mascaraChavePix(arg0, arg1) {
        throw new Error('Method not implemented.');
    }
    obterTipoChavePix(arg0) {
        // Mascara UUID: mostra apenas os primeiros 8 caracteres
        throw new Error('Method not implemented.');
    }
    /**
     * Valida uma chave PIX baseada no seu tipo
     *
     * @param key Chave PIX a ser validada
     * @param keyType Tipo da chave PIX ('cpf', 'email', 'telefone', 'aleatorio')
     * @returns true se a chave for válida para o tipo especificado, false caso contrário
     */
    validatePixKey(key, keyType) {
        if (!key) {
            return false;
        }
        switch (keyType) {
            case 'cpf':
                return this.validateCpfKey(key);
            case 'email':
                return this.validateEmailKey(key);
            case 'telefone':
                return this.validatePhoneKey(key);
            case 'aleatorio':
                return this.validateRandomKey(key);
            default:
                return false;
        }
    }
    /**
     * Valida uma chave PIX do tipo CPF
     *
     * @param key Chave PIX do tipo CPF (apenas números, 11 dígitos)
     * @returns true se for um CPF válido, false caso contrário
     */
    validateCpfKey(key) {
        // Remove caracteres não numéricos
        const cpf = key.replace(/\D/g, '');
        // Verifica se tem 11 dígitos
        if (cpf.length !== 11) {
            return false;
        }
        // Verifica se todos os dígitos são iguais (caso inválido)
        if (/^(\d)\1+$/.test(cpf)) {
            return false;
        }
        // Algoritmo de validação do CPF
        let sum = 0;
        let remainder;
        // Primeiro dígito verificador
        for (let i = 1; i <= 9; i++) {
            sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        }
        remainder = (sum * 10) % 11;
        if (remainder === 10 || remainder === 11) {
            remainder = 0;
        }
        if (remainder !== parseInt(cpf.substring(9, 10))) {
            return false;
        }
        // Segundo dígito verificador
        sum = 0;
        for (let i = 1; i <= 10; i++) {
            sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        }
        remainder = (sum * 10) % 11;
        if (remainder === 10 || remainder === 11) {
            remainder = 0;
        }
        if (remainder !== parseInt(cpf.substring(10, 11))) {
            return false;
        }
        return true;
    }
    /**
     * Valida uma chave PIX do tipo e-mail
     *
     * @param key Chave PIX do tipo e-mail
     * @returns true se for um e-mail válido, false caso contrário
     */
    validateEmailKey(key) {
        // Regex para validação básica de e-mail
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        // Verifica o formato básico do e-mail
        if (!emailRegex.test(key)) {
            return false;
        }
        // Verificações adicionais
        if (key.length > 77) {
            // Limitação do Bacen
            return false;
        }
        // Não pode ter espaços
        if (/\s/.test(key)) {
            return false;
        }
        return true;
    }
    /**
     * Valida uma chave PIX do tipo telefone brasileiro
     *
     * @param key Chave PIX do tipo telefone (formato +5599999999999)
     * @returns true se for um telefone válido, false caso contrário
     */
    validatePhoneKey(key) {
        // Regex para validação de telefone no formato +55 seguido de DDD e número
        const phoneRegex = /^\+55[1-9]{2}9?[0-9]{8}$/;
        // Remove caracteres não numéricos exceto o "+"
        const phone = key.replace(/[^\d+]/g, '');
        // Verifica o formato do telefone
        return phoneRegex.test(phone);
    }
    /**
     * Valida uma chave PIX do tipo aleatório (UUID)
     *
     * @param key Chave PIX do tipo aleatório (UUID)
     * @returns true se for um UUID válido, false caso contrário
     */
    validateRandomKey(key) {
        // Verifica se é um UUID válido
        return (0, uuid_1.validate)(key);
    }
    /**
     * Mascara uma chave PIX para exibição segura
     *
     * @param key Chave PIX original
     * @param keyType Tipo da chave PIX ('cpf', 'email', 'telefone', 'aleatorio')
     * @returns Chave mascarada para exibição
     */
    maskPixKey(key, keyType) {
        if (!key) {
            return '';
        }
        switch (keyType) {
            case 'cpf':
                // Mascara CPF: 123.456.789-00 -> ***.456.789-**
                return key.replace(/^(\d{3})\.(\d{3})\.(\d{3})-(\d{2})$/, '***.$2.$3-**');
            case 'email':
                // Mascara email: usuario@dominio.com -> u****@****.com
                return key.replace(/^([a-zA-Z0-9])[a-zA-Z0-9._%+-]+@([a-zA-Z0-9])[a-zA-Z0-9.-]+(\.[a-zA-Z]{2,})$/, '$1****@$2****$3');
            case 'telefone':
                // Mascara telefone: +5599999999999 -> +55*****99999
                return key.replace(/^\+55([0-9]{2})([0-9]{5})([0-9]{4})$/, '+55$1*****$3');
            case 'aleatorio':
                // Mascara UUID: mostra apenas os primeiros 8 caracteres
                return key.substring(0, 8) + '********-****-****-****-************';
            default:
                return '********';
        }
    }
};
exports.PixValidator = PixValidator;
exports.PixValidator = PixValidator = __decorate([
    (0, common_1.Injectable)()
], PixValidator);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdmFsaWRhdG9yc1xccGl4LXZhbGlkYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMsK0JBQWdEO0FBRWhEOzs7Ozs7O0dBT0c7QUFFSSxJQUFNLFlBQVksR0FBbEIsTUFBTSxZQUFZO0lBQ3ZCLGVBQWUsQ0FBQyxJQUFZLEVBQUUsSUFBWTtRQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUNELGVBQWUsQ0FBQyxJQUFZLEVBQUUsSUFBWTtRQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUNELGlCQUFpQixDQUFDLElBQVk7UUFDNUIsd0RBQXdEO1FBQ3hELE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBQ0Q7Ozs7OztPQU1HO0lBQ0gsY0FBYyxDQUNaLEdBQVcsRUFDWCxPQUFtRDtRQUVuRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDVCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxRQUFRLE9BQU8sRUFBRSxDQUFDO1lBQ2hCLEtBQUssS0FBSztnQkFDUixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEMsS0FBSyxPQUFPO2dCQUNWLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BDLEtBQUssVUFBVTtnQkFDYixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQyxLQUFLLFdBQVc7Z0JBQ2QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckM7Z0JBQ0UsT0FBTyxLQUFLLENBQUM7UUFD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O3VCQUFaLFlBQVk7SUFEeEIsSUFBQSxtQkFBVSxHQUFFO0dBQ0EsWUFBWSxDQXNNeEIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdmFsaWRhdG9yc1xccGl4LXZhbGlkYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgdmFsaWRhdGUgYXMgdmFsaWRhdGVVVUlEIH0gZnJvbSAndXVpZCc7XG5cbi8qKlxuICogU2VydmnDp28gcGFyYSB2YWxpZGHDp8OjbyBkZSBjaGF2ZXMgUElYXG4gKlxuICogSW1wbGVtZW50YSBmdW7Dp8O1ZXMgcGFyYSB2YWxpZGFyIG9zIGRpZmVyZW50ZXMgdGlwb3MgZGUgY2hhdmVzIFBJWFxuICogKENQRiwgZS1tYWlsLCB0ZWxlZm9uZSwgY2hhdmUgYWxlYXTDs3JpYSkgZGUgYWNvcmRvIGNvbSBhcyByZWdyYXMgZG8gQmFjZW4uXG4gKlxuICogQGF1dGhvciBFcXVpcGUgUEdCZW5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBpeFZhbGlkYXRvciB7XG4gIHZhbGlkYXJDaGF2ZVBpeChhcmcwOiBzdHJpbmcsIGFyZzE6IHN0cmluZyk6IGFueSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIG1hc2NhcmFDaGF2ZVBpeChhcmcwOiBzdHJpbmcsIGFyZzE6IHN0cmluZykge1xuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcbiAgfVxuICBvYnRlclRpcG9DaGF2ZVBpeChhcmcwOiBzdHJpbmcpOiBhbnkge1xuICAgIC8vIE1hc2NhcmEgVVVJRDogbW9zdHJhIGFwZW5hcyBvcyBwcmltZWlyb3MgOCBjYXJhY3RlcmVzXG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIC8qKlxuICAgKiBWYWxpZGEgdW1hIGNoYXZlIFBJWCBiYXNlYWRhIG5vIHNldSB0aXBvXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgQ2hhdmUgUElYIGEgc2VyIHZhbGlkYWRhXG4gICAqIEBwYXJhbSBrZXlUeXBlIFRpcG8gZGEgY2hhdmUgUElYICgnY3BmJywgJ2VtYWlsJywgJ3RlbGVmb25lJywgJ2FsZWF0b3JpbycpXG4gICAqIEByZXR1cm5zIHRydWUgc2UgYSBjaGF2ZSBmb3IgdsOhbGlkYSBwYXJhIG8gdGlwbyBlc3BlY2lmaWNhZG8sIGZhbHNlIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgdmFsaWRhdGVQaXhLZXkoXG4gICAga2V5OiBzdHJpbmcsXG4gICAga2V5VHlwZTogJ2NwZicgfCAnZW1haWwnIHwgJ3RlbGVmb25lJyB8ICdhbGVhdG9yaW8nLFxuICApOiBib29sZWFuIHtcbiAgICBpZiAoIWtleSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHN3aXRjaCAoa2V5VHlwZSkge1xuICAgICAgY2FzZSAnY3BmJzpcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVDcGZLZXkoa2V5KTtcbiAgICAgIGNhc2UgJ2VtYWlsJzpcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVFbWFpbEtleShrZXkpO1xuICAgICAgY2FzZSAndGVsZWZvbmUnOlxuICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBob25lS2V5KGtleSk7XG4gICAgICBjYXNlICdhbGVhdG9yaW8nOlxuICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVJhbmRvbUtleShrZXkpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgdW1hIGNoYXZlIFBJWCBkbyB0aXBvIENQRlxuICAgKlxuICAgKiBAcGFyYW0ga2V5IENoYXZlIFBJWCBkbyB0aXBvIENQRiAoYXBlbmFzIG7Dum1lcm9zLCAxMSBkw61naXRvcylcbiAgICogQHJldHVybnMgdHJ1ZSBzZSBmb3IgdW0gQ1BGIHbDoWxpZG8sIGZhbHNlIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZUNwZktleShrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIC8vIFJlbW92ZSBjYXJhY3RlcmVzIG7Do28gbnVtw6lyaWNvc1xuICAgIGNvbnN0IGNwZiA9IGtleS5yZXBsYWNlKC9cXEQvZywgJycpO1xuXG4gICAgLy8gVmVyaWZpY2Egc2UgdGVtIDExIGTDrWdpdG9zXG4gICAgaWYgKGNwZi5sZW5ndGggIT09IDExKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2Egc2UgdG9kb3Mgb3MgZMOtZ2l0b3Mgc8OjbyBpZ3VhaXMgKGNhc28gaW52w6FsaWRvKVxuICAgIGlmICgvXihcXGQpXFwxKyQvLnRlc3QoY3BmKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIEFsZ29yaXRtbyBkZSB2YWxpZGHDp8OjbyBkbyBDUEZcbiAgICBsZXQgc3VtID0gMDtcbiAgICBsZXQgcmVtYWluZGVyO1xuXG4gICAgLy8gUHJpbWVpcm8gZMOtZ2l0byB2ZXJpZmljYWRvclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IDk7IGkrKykge1xuICAgICAgc3VtICs9IHBhcnNlSW50KGNwZi5zdWJzdHJpbmcoaSAtIDEsIGkpKSAqICgxMSAtIGkpO1xuICAgIH1cblxuICAgIHJlbWFpbmRlciA9IChzdW0gKiAxMCkgJSAxMTtcbiAgICBpZiAocmVtYWluZGVyID09PSAxMCB8fCByZW1haW5kZXIgPT09IDExKSB7XG4gICAgICByZW1haW5kZXIgPSAwO1xuICAgIH1cblxuICAgIGlmIChyZW1haW5kZXIgIT09IHBhcnNlSW50KGNwZi5zdWJzdHJpbmcoOSwgMTApKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFNlZ3VuZG8gZMOtZ2l0byB2ZXJpZmljYWRvclxuICAgIHN1bSA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gMTA7IGkrKykge1xuICAgICAgc3VtICs9IHBhcnNlSW50KGNwZi5zdWJzdHJpbmcoaSAtIDEsIGkpKSAqICgxMiAtIGkpO1xuICAgIH1cblxuICAgIHJlbWFpbmRlciA9IChzdW0gKiAxMCkgJSAxMTtcbiAgICBpZiAocmVtYWluZGVyID09PSAxMCB8fCByZW1haW5kZXIgPT09IDExKSB7XG4gICAgICByZW1haW5kZXIgPSAwO1xuICAgIH1cblxuICAgIGlmIChyZW1haW5kZXIgIT09IHBhcnNlSW50KGNwZi5zdWJzdHJpbmcoMTAsIDExKSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgdW1hIGNoYXZlIFBJWCBkbyB0aXBvIGUtbWFpbFxuICAgKlxuICAgKiBAcGFyYW0ga2V5IENoYXZlIFBJWCBkbyB0aXBvIGUtbWFpbFxuICAgKiBAcmV0dXJucyB0cnVlIHNlIGZvciB1bSBlLW1haWwgdsOhbGlkbywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRW1haWxLZXkoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBSZWdleCBwYXJhIHZhbGlkYcOnw6NvIGLDoXNpY2EgZGUgZS1tYWlsXG4gICAgY29uc3QgZW1haWxSZWdleCA9IC9eW2EtekEtWjAtOS5fJSstXStAW2EtekEtWjAtOS4tXStcXC5bYS16QS1aXXsyLH0kLztcblxuICAgIC8vIFZlcmlmaWNhIG8gZm9ybWF0byBiw6FzaWNvIGRvIGUtbWFpbFxuICAgIGlmICghZW1haWxSZWdleC50ZXN0KGtleSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYcOnw7VlcyBhZGljaW9uYWlzXG4gICAgaWYgKGtleS5sZW5ndGggPiA3Nykge1xuICAgICAgLy8gTGltaXRhw6fDo28gZG8gQmFjZW5cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBOw6NvIHBvZGUgdGVyIGVzcGHDp29zXG4gICAgaWYgKC9cXHMvLnRlc3Qoa2V5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSB1bWEgY2hhdmUgUElYIGRvIHRpcG8gdGVsZWZvbmUgYnJhc2lsZWlyb1xuICAgKlxuICAgKiBAcGFyYW0ga2V5IENoYXZlIFBJWCBkbyB0aXBvIHRlbGVmb25lIChmb3JtYXRvICs1NTk5OTk5OTk5OTk5KVxuICAgKiBAcmV0dXJucyB0cnVlIHNlIGZvciB1bSB0ZWxlZm9uZSB2w6FsaWRvLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVQaG9uZUtleShrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIC8vIFJlZ2V4IHBhcmEgdmFsaWRhw6fDo28gZGUgdGVsZWZvbmUgbm8gZm9ybWF0byArNTUgc2VndWlkbyBkZSBEREQgZSBuw7ptZXJvXG4gICAgY29uc3QgcGhvbmVSZWdleCA9IC9eXFwrNTVbMS05XXsyfTk/WzAtOV17OH0kLztcblxuICAgIC8vIFJlbW92ZSBjYXJhY3RlcmVzIG7Do28gbnVtw6lyaWNvcyBleGNldG8gbyBcIitcIlxuICAgIGNvbnN0IHBob25lID0ga2V5LnJlcGxhY2UoL1teXFxkK10vZywgJycpO1xuXG4gICAgLy8gVmVyaWZpY2EgbyBmb3JtYXRvIGRvIHRlbGVmb25lXG4gICAgcmV0dXJuIHBob25lUmVnZXgudGVzdChwaG9uZSk7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIHVtYSBjaGF2ZSBQSVggZG8gdGlwbyBhbGVhdMOzcmlvIChVVUlEKVxuICAgKlxuICAgKiBAcGFyYW0ga2V5IENoYXZlIFBJWCBkbyB0aXBvIGFsZWF0w7NyaW8gKFVVSUQpXG4gICAqIEByZXR1cm5zIHRydWUgc2UgZm9yIHVtIFVVSUQgdsOhbGlkbywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlUmFuZG9tS2V5KGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgLy8gVmVyaWZpY2Egc2Ugw6kgdW0gVVVJRCB2w6FsaWRvXG4gICAgcmV0dXJuIHZhbGlkYXRlVVVJRChrZXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hc2NhcmEgdW1hIGNoYXZlIFBJWCBwYXJhIGV4aWJpw6fDo28gc2VndXJhXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgQ2hhdmUgUElYIG9yaWdpbmFsXG4gICAqIEBwYXJhbSBrZXlUeXBlIFRpcG8gZGEgY2hhdmUgUElYICgnY3BmJywgJ2VtYWlsJywgJ3RlbGVmb25lJywgJ2FsZWF0b3JpbycpXG4gICAqIEByZXR1cm5zIENoYXZlIG1hc2NhcmFkYSBwYXJhIGV4aWJpw6fDo29cbiAgICovXG4gIG1hc2tQaXhLZXkoXG4gICAga2V5OiBzdHJpbmcsXG4gICAga2V5VHlwZTogJ2NwZicgfCAnZW1haWwnIHwgJ3RlbGVmb25lJyB8ICdhbGVhdG9yaW8nLFxuICApOiBzdHJpbmcge1xuICAgIGlmICgha2V5KSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgc3dpdGNoIChrZXlUeXBlKSB7XG4gICAgICBjYXNlICdjcGYnOlxuICAgICAgICAvLyBNYXNjYXJhIENQRjogMTIzLjQ1Ni43ODktMDAgLT4gKioqLjQ1Ni43ODktKipcbiAgICAgICAgcmV0dXJuIGtleS5yZXBsYWNlKFxuICAgICAgICAgIC9eKFxcZHszfSlcXC4oXFxkezN9KVxcLihcXGR7M30pLShcXGR7Mn0pJC8sXG4gICAgICAgICAgJyoqKi4kMi4kMy0qKicsXG4gICAgICAgICk7XG5cbiAgICAgIGNhc2UgJ2VtYWlsJzpcbiAgICAgICAgLy8gTWFzY2FyYSBlbWFpbDogdXN1YXJpb0Bkb21pbmlvLmNvbSAtPiB1KioqKkAqKioqLmNvbVxuICAgICAgICByZXR1cm4ga2V5LnJlcGxhY2UoXG4gICAgICAgICAgL14oW2EtekEtWjAtOV0pW2EtekEtWjAtOS5fJSstXStAKFthLXpBLVowLTldKVthLXpBLVowLTkuLV0rKFxcLlthLXpBLVpdezIsfSkkLyxcbiAgICAgICAgICAnJDEqKioqQCQyKioqKiQzJyxcbiAgICAgICAgKTtcblxuICAgICAgY2FzZSAndGVsZWZvbmUnOlxuICAgICAgICAvLyBNYXNjYXJhIHRlbGVmb25lOiArNTU5OTk5OTk5OTk5OSAtPiArNTUqKioqKjk5OTk5XG4gICAgICAgIHJldHVybiBrZXkucmVwbGFjZShcbiAgICAgICAgICAvXlxcKzU1KFswLTldezJ9KShbMC05XXs1fSkoWzAtOV17NH0pJC8sXG4gICAgICAgICAgJys1NSQxKioqKiokMycsXG4gICAgICAgICk7XG5cbiAgICAgIGNhc2UgJ2FsZWF0b3Jpbyc6XG4gICAgICAgIC8vIE1hc2NhcmEgVVVJRDogbW9zdHJhIGFwZW5hcyBvcyBwcmltZWlyb3MgOCBjYXJhY3RlcmVzXG4gICAgICAgIHJldHVybiBrZXkuc3Vic3RyaW5nKDAsIDgpICsgJyoqKioqKioqLSoqKiotKioqKi0qKioqLSoqKioqKioqKioqKic7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiAnKioqKioqKionO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9