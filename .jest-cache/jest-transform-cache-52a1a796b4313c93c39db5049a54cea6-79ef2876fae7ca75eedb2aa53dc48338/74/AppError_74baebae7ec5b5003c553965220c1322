7ca3370907cd8b5ec2c593a41e8bf84b
"use strict";
/**
 * Classe base para erros padronizados do sistema SEMTAS
 *
 * Implementa o padrão de erro estruturado conforme definido
 * no catálogo de erros, com suporte a contexto dinâmico,
 * localização e observabilidade.
 *
 * @see docs/ADRs/catalogo-erros.md
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppError = void 0;
const common_1 = require("@nestjs/common");
const catalog_1 = require("./catalog");
/**
 * Classe principal para erros padronizados do sistema
 */
class AppError extends common_1.HttpException {
    /** Código único do erro conforme catálogo */
    errorCode;
    /** Definição completa do erro do catálogo */
    definition;
    /** Contexto dinâmico do erro */
    context;
    /** Timestamp de quando o erro ocorreu */
    timestamp;
    /** Mensagem localizada (se disponível) */
    localizedMessage;
    constructor(errorCode, context = {}, acceptedLanguage = 'pt-BR') {
        const definition = catalog_1.ERROR_CATALOG[errorCode];
        if (!definition) {
            throw new Error(`Código de erro não encontrado no catálogo: ${errorCode}`);
        }
        // Interpolar dados na mensagem se fornecidos
        const message = context.data
            ? AppError.interpolateMessage(definition.message, context.data)
            : definition.message;
        super(message, definition.httpStatus);
        this.name = 'AppError';
        this.errorCode = errorCode;
        this.definition = definition;
        this.context = context;
        this.timestamp = new Date();
        // Definir mensagem localizada
        if (definition.localizedMessages?.[acceptedLanguage]) {
            this.localizedMessage = context.data
                ? AppError.interpolateMessage(definition.localizedMessages[acceptedLanguage], context.data)
                : definition.localizedMessages[acceptedLanguage];
        }
        // Preservar stack trace da causa raiz
        if (context.cause) {
            this.stack = context.cause.stack;
        }
    }
    /**
     * Interpola dados dinâmicos na mensagem usando placeholders
     * Formato: "Erro no campo {fieldName} com valor {value}"
     */
    static interpolateMessage(template, data) {
        return template.replace(/\{([^}]+)\}/g, (match, key) => {
            return data[key]?.toString() || match;
        });
    }
    /**
     * Retorna representação JSON estruturada do erro
     */
    toJSON() {
        return {
            errorCode: this.errorCode,
            message: this.message,
            localizedMessage: this.localizedMessage,
            httpStatus: this.getStatus(),
            category: this.definition.category,
            severity: this.definition.severity,
            timestamp: this.timestamp.toISOString(),
            context: {
                data: this.context.data,
                metadata: this.context.metadata,
                requestId: this.context.requestId,
                userId: this.context.userId,
                operationalContext: this.context.operationalContext,
            },
            legalReference: this.definition.legalReference,
        };
    }
    /**
     * Retorna dados estruturados para logging
     */
    getLogData() {
        return {
            errorCode: this.errorCode,
            category: this.definition.category,
            severity: this.definition.severity,
            httpStatus: this.getStatus(),
            message: this.message,
            localizedMessage: this.localizedMessage,
            timestamp: this.timestamp.toISOString(),
            requestId: this.context.requestId,
            userId: this.context.userId,
            operationalContext: this.context.operationalContext,
            metadata: this.context.metadata,
            legalReference: this.definition.legalReference,
            causedBy: this.context.cause?.message,
        };
    }
    /**
     * Retorna dados seguros para resposta da API (sem informações sensíveis)
     */
    getApiResponse(includeDetails = false) {
        const response = {
            code: this.errorCode,
            message: this.localizedMessage || this.message,
            category: this.definition.category,
            timestamp: this.timestamp.toISOString(),
        };
        if (includeDetails && this.context.data) {
            // Filtrar dados sensíveis antes de incluir
            const safeData = this.filterSensitiveData(this.context.data);
            if (Object.keys(safeData).length > 0) {
                response.details = safeData;
            }
        }
        if (this.definition.legalReference) {
            response.legalReference = this.definition.legalReference;
        }
        return response;
    }
    /**
     * Remove dados sensíveis do contexto para exposição segura
     */
    filterSensitiveData(data) {
        const sensitiveKeys = [
            'password', 'senha', 'token', 'secret', 'key', 'cpf', 'rg',
            'email', 'telefone', 'endereco', 'address', 'phone'
        ];
        const filtered = {};
        for (const [key, value] of Object.entries(data)) {
            const isSensitive = sensitiveKeys.some(sensitiveKey => key.toLowerCase().includes(sensitiveKey.toLowerCase()));
            if (!isSensitive) {
                filtered[key] = value;
            }
        }
        return filtered;
    }
    /**
     * Verifica se o erro é crítico baseado na severidade
     */
    isCritical() {
        return this.definition.severity === catalog_1.ErrorSeverity.CRITICAL;
    }
    /**
     * Verifica se o erro é de alta severidade
     */
    isHighSeverity() {
        return this.definition.severity === catalog_1.ErrorSeverity.HIGH || this.isCritical();
    }
    /**
     * Verifica se o erro pertence a uma categoria específica
     */
    isCategory(category) {
        return this.definition.category === category;
    }
    /**
     * Cria uma nova instância do erro com contexto adicional
     */
    withContext(additionalContext) {
        const mergedContext = {
            ...this.context,
            ...additionalContext,
            data: { ...this.context.data, ...additionalContext.data },
            metadata: { ...this.context.metadata, ...additionalContext.metadata },
        };
        return new AppError(this.errorCode, mergedContext);
    }
    /**
     * Factory method para criar erro a partir de código PostgreSQL
     */
    static fromPostgresError(postgresCode, context = {}, acceptedLanguage = 'pt-BR') {
        // Importar o mapa aqui para evitar dependência circular
        const { POSTGRES_ERROR_MAP } = require('./catalog');
        const errorCode = POSTGRES_ERROR_MAP[postgresCode];
        if (!errorCode) {
            // Fallback para erro genérico de sistema
            return new AppError('SYSTEM_DATABASE_ERROR', {
                ...context,
                metadata: {
                    ...context.metadata,
                    postgresCode,
                },
            }, acceptedLanguage);
        }
        return new AppError(errorCode, {
            ...context,
            metadata: {
                ...context.metadata,
                postgresCode,
            },
        }, acceptedLanguage);
    }
}
exports.AppError = AppError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZXhjZXB0aW9uc1xcZXJyb3ItY2F0YWxvZ1xcQXBwRXJyb3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7OztHQVFHOzs7QUFFSCwyQ0FBK0M7QUFDL0MsdUNBQXlGO0FBeUJ6Rjs7R0FFRztBQUNILE1BQWEsUUFBUyxTQUFRLHNCQUFhO0lBQ3pDLDZDQUE2QztJQUM3QixTQUFTLENBQVM7SUFFbEMsNkNBQTZDO0lBQzdCLFVBQVUsQ0FBa0I7SUFFNUMsZ0NBQWdDO0lBQ2hCLE9BQU8sQ0FBZTtJQUV0Qyx5Q0FBeUM7SUFDekIsU0FBUyxDQUFPO0lBRWhDLDBDQUEwQztJQUMxQixnQkFBZ0IsQ0FBVTtJQUUxQyxZQUNFLFNBQWlCLEVBQ2pCLFVBQXdCLEVBQUUsRUFDMUIsbUJBQTJCLE9BQU87UUFFbEMsTUFBTSxVQUFVLEdBQUcsdUJBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUM3RSxDQUFDO1FBRUQsNkNBQTZDO1FBQzdDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJO1lBQzFCLENBQUMsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQy9ELENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDO1FBRXZCLEtBQUssQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUks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T0FBTyxDQUFDLFFBQVEsRUFBRSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsRUFBRTtTQUN0RSxDQUFDO1FBRUYsT0FBTyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRDs7T0FFRztJQUNJLE1BQU0sQ0FBQyxpQkFBaUIsQ0FDN0IsWUFBb0IsRUFDcEIsVUFBd0IsRUFBRSxFQUMxQixtQkFBMkIsT0FBTztRQUVsQyx3REFBd0Q7UUFDeEQsTUFBTSxFQUFFLGtCQUFrQixFQUFFLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXBELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRW5ELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLHlDQUF5QztZQUN6QyxPQUFPLElBQUksUUFBUSxDQUFDLHVCQUF1QixFQUFFO2dCQUMzQyxHQUFHLE9BQU87Z0JBQ1YsUUFBUSxFQUFFO29CQUNSLEdBQUcsT0FBTyxDQUFDLFFBQVE7b0JBQ25CLFlBQVk7aUJBQ2I7YUFDRixFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDdkIsQ0FBQztRQUVELE9BQU8sSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFO1lBQzdCLEdBQUcsT0FBTztZQUNWLFFBQVEsRUFBRTtnQkFDUixHQUFHLE9BQU8sQ0FBQyxRQUFRO2dCQUNuQixZQUFZO2FBQ2I7U0FDRixFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBaE9ELDRCQWdPQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcc2hhcmVkXFxleGNlcHRpb25zXFxlcnJvci1jYXRhbG9nXFxBcHBFcnJvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENsYXNzZSBiYXNlIHBhcmEgZXJyb3MgcGFkcm9uaXphZG9zIGRvIHNpc3RlbWEgU0VNVEFTXG4gKiBcbiAqIEltcGxlbWVudGEgbyBwYWRyw6NvIGRlIGVycm8gZXN0cnV0dXJhZG8gY29uZm9ybWUgZGVmaW5pZG9cbiAqIG5vIGNhdMOhbG9nbyBkZSBlcnJvcywgY29tIHN1cG9ydGUgYSBjb250ZXh0byBkaW7Dom1pY28sXG4gKiBsb2NhbGl6YcOnw6NvIGUgb2JzZXJ2YWJpbGlkYWRlLlxuICogXG4gKiBAc2VlIGRvY3MvQURScy9jYXRhbG9nby1lcnJvcy5tZFxuICovXG5cbmltcG9ydCB7IEh0dHBFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBFUlJPUl9DQVRBTE9HLCBFcnJvckRlZmluaXRpb24sIEVycm9yQ2F0ZWdvcnksIEVycm9yU2V2ZXJpdHkgfSBmcm9tICcuL2NhdGFsb2cnO1xuXG4vKipcbiAqIENvbnRleHRvIGRpbsOibWljbyBwYXJhIHBlcnNvbmFsaXphw6fDo28gZGUgZXJyb3NcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFcnJvckNvbnRleHQge1xuICAvKiogRGFkb3MgZXNwZWPDrWZpY29zIGRvIGVycm8gcGFyYSBpbnRlcnBvbGHDp8OjbyBuYSBtZW5zYWdlbSAqL1xuICBkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgLyoqIENhdXNhIHJhaXogZG8gZXJybyAocGFyYSBlbmNhZGVhbWVudG8pICovXG4gIGNhdXNlPzogRXJyb3I7XG4gIC8qKiBNZXRhZGFkb3MgYWRpY2lvbmFpcyBwYXJhIGxvZ2dpbmcgZSBkZWJ1Z2dpbmcgKi9cbiAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAvKiogSUQgZGEgcmVxdWlzacOnw6NvIHBhcmEgcmFzdHJlYWJpbGlkYWRlICovXG4gIHJlcXVlc3RJZD86IHN0cmluZztcbiAgLyoqIElEIGRvIHVzdcOhcmlvIHF1ZSBjYXVzb3UgbyBlcnJvICovXG4gIHVzZXJJZD86IHN0cmluZztcbiAgLyoqIENvbnRleHRvIG9wZXJhY2lvbmFsIGFkaWNpb25hbCAqL1xuICBvcGVyYXRpb25hbENvbnRleHQ/OiB7XG4gICAgbW9kdWxlPzogc3RyaW5nO1xuICAgIG9wZXJhdGlvbj86IHN0cmluZztcbiAgICBlbnRpdHlJZD86IHN0cmluZztcbiAgICBlbnRpdHlUeXBlPzogc3RyaW5nO1xuICB9O1xufVxuXG4vKipcbiAqIENsYXNzZSBwcmluY2lwYWwgcGFyYSBlcnJvcyBwYWRyb25pemFkb3MgZG8gc2lzdGVtYVxuICovXG5leHBvcnQgY2xhc3MgQXBwRXJyb3IgZXh0ZW5kcyBIdHRwRXhjZXB0aW9uIHtcbiAgLyoqIEPDs2RpZ28gw7puaWNvIGRvIGVycm8gY29uZm9ybWUgY2F0w6Fsb2dvICovXG4gIHB1YmxpYyByZWFkb25seSBlcnJvckNvZGU6IHN0cmluZztcbiAgXG4gIC8qKiBEZWZpbmnDp8OjbyBjb21wbGV0YSBkbyBlcnJvIGRvIGNhdMOhbG9nbyAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZGVmaW5pdGlvbjogRXJyb3JEZWZpbml0aW9uO1xuICBcbiAgLyoqIENvbnRleHRvIGRpbsOibWljbyBkbyBlcnJvICovXG4gIHB1YmxpYyByZWFkb25seSBjb250ZXh0OiBFcnJvckNvbnRleHQ7XG4gIFxuICAvKiogVGltZXN0YW1wIGRlIHF1YW5kbyBvIGVycm8gb2NvcnJldSAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdGltZXN0YW1wOiBEYXRlO1xuICBcbiAgLyoqIE1lbnNhZ2VtIGxvY2FsaXphZGEgKHNlIGRpc3BvbsOtdmVsKSAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbG9jYWxpemVkTWVzc2FnZT86IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBlcnJvckNvZGU6IHN0cmluZyxcbiAgICBjb250ZXh0OiBFcnJvckNvbnRleHQgPSB7fSxcbiAgICBhY2NlcHRlZExhbmd1YWdlOiBzdHJpbmcgPSAncHQtQlInXG4gICkge1xuICAgIGNvbnN0IGRlZmluaXRpb24gPSBFUlJPUl9DQVRBTE9HW2Vycm9yQ29kZV07XG4gICAgXG4gICAgaWYgKCFkZWZpbml0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEPDs2RpZ28gZGUgZXJybyBuw6NvIGVuY29udHJhZG8gbm8gY2F0w6Fsb2dvOiAke2Vycm9yQ29kZX1gKTtcbiAgICB9XG5cbiAgICAvLyBJbnRlcnBvbGFyIGRhZG9zIG5hIG1lbnNhZ2VtIHNlIGZvcm5lY2lkb3NcbiAgICBjb25zdCBtZXNzYWdlID0gY29udGV4dC5kYXRhIFxuICAgICAgPyBBcHBFcnJvci5pbnRlcnBvbGF0ZU1lc3NhZ2UoZGVmaW5pdGlvbi5tZXNzYWdlLCBjb250ZXh0LmRhdGEpXG4gICAgICA6IGRlZmluaXRpb24ubWVzc2FnZTtcblxuICAgIHN1cGVyKG1lc3NhZ2UsIGRlZmluaXRpb24uaHR0cFN0YXR1cyk7XG5cbiAgICB0aGlzLm5hbWUgPSAnQXBwRXJyb3InO1xuICAgIHRoaXMuZXJyb3JDb2RlID0gZXJyb3JDb2RlO1xuICAgIHRoaXMuZGVmaW5pdGlvbiA9IGRlZmluaXRpb247XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLnRpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XG4gICAgXG4gICAgLy8gRGVmaW5pciBtZW5zYWdlbSBsb2NhbGl6YWRhXG4gICAgaWYgKGRlZmluaXRpb24ubG9jYWxpemVkTWVzc2FnZXM/LlthY2NlcHRlZExhbmd1YWdlXSkge1xuICAgICAgdGhpcy5sb2NhbGl6ZWRNZXNzYWdlID0gY29udGV4dC5kYXRhXG4gICAgICAgID8gQXBwRXJyb3IuaW50ZXJwb2xhdGVNZXNzYWdlKGRlZmluaXRpb24ubG9jYWxpemVkTWVzc2FnZXNbYWNjZXB0ZWRMYW5ndWFnZV0sIGNvbnRleHQuZGF0YSlcbiAgICAgICAgOiBkZWZpbml0aW9uLmxvY2FsaXplZE1lc3NhZ2VzW2FjY2VwdGVkTGFuZ3VhZ2VdO1xuICAgIH1cblxuICAgIC8vIFByZXNlcnZhciBzdGFjayB0cmFjZSBkYSBjYXVzYSByYWl6XG4gICAgaWYgKGNvbnRleHQuY2F1c2UpIHtcbiAgICAgIHRoaXMuc3RhY2sgPSBjb250ZXh0LmNhdXNlLnN0YWNrO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnRlcnBvbGEgZGFkb3MgZGluw6JtaWNvcyBuYSBtZW5zYWdlbSB1c2FuZG8gcGxhY2Vob2xkZXJzXG4gICAqIEZvcm1hdG86IFwiRXJybyBubyBjYW1wbyB7ZmllbGROYW1lfSBjb20gdmFsb3Ige3ZhbHVlfVwiXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBpbnRlcnBvbGF0ZU1lc3NhZ2UodGVtcGxhdGU6IHN0cmluZywgZGF0YTogUmVjb3JkPHN0cmluZywgYW55Pik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRlbXBsYXRlLnJlcGxhY2UoL1xceyhbXn1dKylcXH0vZywgKG1hdGNoLCBrZXkpID0+IHtcbiAgICAgIHJldHVybiBkYXRhW2tleV0/LnRvU3RyaW5nKCkgfHwgbWF0Y2g7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSByZXByZXNlbnRhw6fDo28gSlNPTiBlc3RydXR1cmFkYSBkbyBlcnJvXG4gICAqL1xuICBwdWJsaWMgdG9KU09OKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB7XG4gICAgICBlcnJvckNvZGU6IHRoaXMuZXJyb3JDb2RlLFxuICAgICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLFxuICAgICAgbG9jYWxpemVkTWVzc2FnZTogdGhpcy5sb2NhbGl6ZWRNZXNzYWdlLFxuICAgICAgaHR0cFN0YXR1czogdGhpcy5nZXRTdGF0dXMoKSxcbiAgICAgIGNhdGVnb3J5OiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnksXG4gICAgICBzZXZlcml0eTogdGhpcy5kZWZpbml0aW9uLnNldmVyaXR5LFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcC50b0lTT1N0cmluZygpLFxuICAgICAgY29udGV4dDoge1xuICAgICAgICBkYXRhOiB0aGlzLmNvbnRleHQuZGF0YSxcbiAgICAgICAgbWV0YWRhdGE6IHRoaXMuY29udGV4dC5tZXRhZGF0YSxcbiAgICAgICAgcmVxdWVzdElkOiB0aGlzLmNvbnRleHQucmVxdWVzdElkLFxuICAgICAgICB1c2VySWQ6IHRoaXMuY29udGV4dC51c2VySWQsXG4gICAgICAgIG9wZXJhdGlvbmFsQ29udGV4dDogdGhpcy5jb250ZXh0Lm9wZXJhdGlvbmFsQ29udGV4dCxcbiAgICAgIH0sXG4gICAgICBsZWdhbFJlZmVyZW5jZTogdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBkYWRvcyBlc3RydXR1cmFkb3MgcGFyYSBsb2dnaW5nXG4gICAqL1xuICBwdWJsaWMgZ2V0TG9nRGF0YSgpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgZXJyb3JDb2RlOiB0aGlzLmVycm9yQ29kZSxcbiAgICAgIGNhdGVnb3J5OiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnksXG4gICAgICBzZXZlcml0eTogdGhpcy5kZWZpbml0aW9uLnNldmVyaXR5LFxuICAgICAgaHR0cFN0YXR1czogdGhpcy5nZXRTdGF0dXMoKSxcbiAgICAgIG1lc3NhZ2U6IHRoaXMubWVzc2FnZSxcbiAgICAgIGxvY2FsaXplZE1lc3NhZ2U6IHRoaXMubG9jYWxpemVkTWVzc2FnZSxcbiAgICAgIHRpbWVzdGFtcDogdGhpcy50aW1lc3RhbXAudG9JU09TdHJpbmcoKSxcbiAgICAgIHJlcXVlc3RJZDogdGhpcy5jb250ZXh0LnJlcXVlc3RJZCxcbiAgICAgIHVzZXJJZDogdGhpcy5jb250ZXh0LnVzZXJJZCxcbiAgICAgIG9wZXJhdGlvbmFsQ29udGV4dDogdGhpcy5jb250ZXh0Lm9wZXJhdGlvbmFsQ29udGV4dCxcbiAgICAgIG1ldGFkYXRhOiB0aGlzLmNvbnRleHQubWV0YWRhdGEsXG4gICAgICBsZWdhbFJlZmVyZW5jZTogdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlLFxuICAgICAgY2F1c2VkQnk6IHRoaXMuY29udGV4dC5jYXVzZT8ubWVzc2FnZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgZGFkb3Mgc2VndXJvcyBwYXJhIHJlc3Bvc3RhIGRhIEFQSSAoc2VtIGluZm9ybWHDp8O1ZXMgc2Vuc8OtdmVpcylcbiAgICovXG4gIHB1YmxpYyBnZXRBcGlSZXNwb25zZShpbmNsdWRlRGV0YWlsczogYm9vbGVhbiA9IGZhbHNlKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICBjb2RlOiB0aGlzLmVycm9yQ29kZSxcbiAgICAgIG1lc3NhZ2U6IHRoaXMubG9jYWxpemVkTWVzc2FnZSB8fCB0aGlzLm1lc3NhZ2UsXG4gICAgICBjYXRlZ29yeTogdGhpcy5kZWZpbml0aW9uLmNhdGVnb3J5LFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcC50b0lTT1N0cmluZygpLFxuICAgIH07XG5cbiAgICBpZiAoaW5jbHVkZURldGFpbHMgJiYgdGhpcy5jb250ZXh0LmRhdGEpIHtcbiAgICAgIC8vIEZpbHRyYXIgZGFkb3Mgc2Vuc8OtdmVpcyBhbnRlcyBkZSBpbmNsdWlyXG4gICAgICBjb25zdCBzYWZlRGF0YSA9IHRoaXMuZmlsdGVyU2Vuc2l0aXZlRGF0YSh0aGlzLmNvbnRleHQuZGF0YSk7XG4gICAgICBpZiAoT2JqZWN0LmtleXMoc2FmZURhdGEpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgKHJlc3BvbnNlIGFzIGFueSkuZGV0YWlscyA9IHNhZmVEYXRhO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmRlZmluaXRpb24ubGVnYWxSZWZlcmVuY2UpIHtcbiAgICAgIChyZXNwb25zZSBhcyBhbnkpLmxlZ2FsUmVmZXJlbmNlID0gdGhpcy5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlO1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgZGFkb3Mgc2Vuc8OtdmVpcyBkbyBjb250ZXh0byBwYXJhIGV4cG9zacOnw6NvIHNlZ3VyYVxuICAgKi9cbiAgcHJpdmF0ZSBmaWx0ZXJTZW5zaXRpdmVEYXRhKGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICBjb25zdCBzZW5zaXRpdmVLZXlzID0gW1xuICAgICAgJ3Bhc3N3b3JkJywgJ3NlbmhhJywgJ3Rva2VuJywgJ3NlY3JldCcsICdrZXknLCAnY3BmJywgJ3JnJywgXG4gICAgICAnZW1haWwnLCAndGVsZWZvbmUnLCAnZW5kZXJlY28nLCAnYWRkcmVzcycsICdwaG9uZSdcbiAgICBdO1xuICAgIFxuICAgIGNvbnN0IGZpbHRlcmVkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGF0YSkpIHtcbiAgICAgIGNvbnN0IGlzU2Vuc2l0aXZlID0gc2Vuc2l0aXZlS2V5cy5zb21lKHNlbnNpdGl2ZUtleSA9PiBcbiAgICAgICAga2V5LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2Vuc2l0aXZlS2V5LnRvTG93ZXJDYXNlKCkpXG4gICAgICApO1xuICAgICAgXG4gICAgICBpZiAoIWlzU2Vuc2l0aXZlKSB7XG4gICAgICAgIGZpbHRlcmVkW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGZpbHRlcmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gZXJybyDDqSBjcsOtdGljbyBiYXNlYWRvIG5hIHNldmVyaWRhZGVcbiAgICovXG4gIHB1YmxpYyBpc0NyaXRpY2FsKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuQ1JJVElDQUw7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgbyBlcnJvIMOpIGRlIGFsdGEgc2V2ZXJpZGFkZVxuICAgKi9cbiAgcHVibGljIGlzSGlnaFNldmVyaXR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuSElHSCB8fCB0aGlzLmlzQ3JpdGljYWwoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIGVycm8gcGVydGVuY2UgYSB1bWEgY2F0ZWdvcmlhIGVzcGVjw61maWNhXG4gICAqL1xuICBwdWJsaWMgaXNDYXRlZ29yeShjYXRlZ29yeTogRXJyb3JDYXRlZ29yeSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb24uY2F0ZWdvcnkgPT09IGNhdGVnb3J5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyaWEgdW1hIG5vdmEgaW5zdMOibmNpYSBkbyBlcnJvIGNvbSBjb250ZXh0byBhZGljaW9uYWxcbiAgICovXG4gIHB1YmxpYyB3aXRoQ29udGV4dChhZGRpdGlvbmFsQ29udGV4dDogUGFydGlhbDxFcnJvckNvbnRleHQ+KTogQXBwRXJyb3Ige1xuICAgIGNvbnN0IG1lcmdlZENvbnRleHQ6IEVycm9yQ29udGV4dCA9IHtcbiAgICAgIC4uLnRoaXMuY29udGV4dCxcbiAgICAgIC4uLmFkZGl0aW9uYWxDb250ZXh0LFxuICAgICAgZGF0YTogeyAuLi50aGlzLmNvbnRleHQuZGF0YSwgLi4uYWRkaXRpb25hbENvbnRleHQuZGF0YSB9LFxuICAgICAgbWV0YWRhdGE6IHsgLi4udGhpcy5jb250ZXh0Lm1ldGFkYXRhLCAuLi5hZGRpdGlvbmFsQ29udGV4dC5tZXRhZGF0YSB9LFxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IEFwcEVycm9yKHRoaXMuZXJyb3JDb2RlLCBtZXJnZWRDb250ZXh0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGYWN0b3J5IG1ldGhvZCBwYXJhIGNyaWFyIGVycm8gYSBwYXJ0aXIgZGUgY8OzZGlnbyBQb3N0Z3JlU1FMXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21Qb3N0Z3Jlc0Vycm9yKFxuICAgIHBvc3RncmVzQ29kZTogc3RyaW5nLFxuICAgIGNvbnRleHQ6IEVycm9yQ29udGV4dCA9IHt9LFxuICAgIGFjY2VwdGVkTGFuZ3VhZ2U6IHN0cmluZyA9ICdwdC1CUidcbiAgKTogQXBwRXJyb3Ige1xuICAgIC8vIEltcG9ydGFyIG8gbWFwYSBhcXVpIHBhcmEgZXZpdGFyIGRlcGVuZMOqbmNpYSBjaXJjdWxhclxuICAgIGNvbnN0IHsgUE9TVEdSRVNfRVJST1JfTUFQIH0gPSByZXF1aXJlKCcuL2NhdGFsb2cnKTtcbiAgICBcbiAgICBjb25zdCBlcnJvckNvZGUgPSBQT1NUR1JFU19FUlJPUl9NQVBbcG9zdGdyZXNDb2RlXTtcbiAgICBcbiAgICBpZiAoIWVycm9yQ29kZSkge1xuICAgICAgLy8gRmFsbGJhY2sgcGFyYSBlcnJvIGdlbsOpcmljbyBkZSBzaXN0ZW1hXG4gICAgICByZXR1cm4gbmV3IEFwcEVycm9yKCdTWVNURU1fREFUQUJBU0VfRVJST1InLCB7XG4gICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgLi4uY29udGV4dC5tZXRhZGF0YSxcbiAgICAgICAgICBwb3N0Z3Jlc0NvZGUsXG4gICAgICAgIH0sXG4gICAgICB9LCBhY2NlcHRlZExhbmd1YWdlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEFwcEVycm9yKGVycm9yQ29kZSwge1xuICAgICAgLi4uY29udGV4dCxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIC4uLmNvbnRleHQubWV0YWRhdGEsXG4gICAgICAgIHBvc3RncmVzQ29kZSxcbiAgICAgIH0sXG4gICAgfSwgYWNjZXB0ZWRMYW5ndWFnZSk7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=