937568a8cd8ce039aebc7d91ca1c2007
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const metrics_service_1 = require("../metrics.service");
const client = __importStar(require("prom-client"));
/**
 * Testes unitários para o serviço de métricas
 *
 * Verifica o funcionamento dos métodos de coleta e exposição de métricas
 * da aplicação usando Prometheus
 */
describe('MetricsService', () => {
    // Mock das classes do Prometheus
    jest.mock('prom-client', () => ({
        Counter: jest.fn().mockImplementation(() => mockCounter),
        Gauge: jest.fn().mockImplementation(() => mockGauge),
        Histogram: jest.fn().mockImplementation(() => mockHistogram),
        Registry: jest.fn().mockImplementation(() => mockRegistry),
        collectDefaultMetrics: jest.fn(),
    }));
    let service;
    // Mocks para os contadores e medidores do Prometheus
    const mockCounter = {
        inc: jest.fn(),
    };
    const mockGauge = {
        inc: jest.fn(),
        dec: jest.fn(),
    };
    const mockHistogram = {
        observe: jest.fn(),
    };
    const mockRegistry = {
        metrics: jest.fn().mockResolvedValue('metrics_data'),
        registerMetric: jest.fn(),
        clear: jest.fn(),
    };
    beforeEach(async () => {
        jest.clearAllMocks();
        // Restaurar os mocks originais
        jest.spyOn(client, 'Counter').mockImplementation(() => mockCounter);
        jest.spyOn(client, 'Gauge').mockImplementation(() => mockGauge);
        jest
            .spyOn(client, 'Histogram')
            .mockImplementation(() => mockHistogram);
        jest
            .spyOn(client, 'Registry')
            .mockImplementation(() => mockRegistry);
        jest.spyOn(client, 'collectDefaultMetrics').mockImplementation(() => { });
        const module = await testing_1.Test.createTestingModule({
            providers: [metrics_service_1.MetricsService],
        }).compile();
        service = module.get(metrics_service_1.MetricsService);
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    it('deve ser definido', () => {
        expect(service).toBeDefined();
    });
    describe('constructor', () => {
        it('deve inicializar o registro e as métricas padrão', () => {
            expect(client.Registry).toHaveBeenCalled();
            expect(client.collectDefaultMetrics).toHaveBeenCalled();
            // Verificar se os contadores e medidores foram criados com os parâmetros corretos
            // Sem verificar os valores exatos, pois a implementação pode mudar
            expect(client.Counter).toHaveBeenCalled();
            expect(client.Histogram).toHaveBeenCalled();
            expect(client.Gauge).toHaveBeenCalled();
        });
    });
    describe('recordHttpRequest', () => {
        it('deve incrementar o contador de requisições HTTP', () => {
            service.recordHttpRequest('GET', '/api/cidadaos', 200);
            expect(mockCounter.inc).toHaveBeenCalled();
        });
    });
    describe('recordHttpRequestDuration', () => {
        it('deve registrar a duração de uma requisição HTTP', () => {
            service.recordHttpRequestDuration('POST', '/api/cidadaos', 200, 0.5);
            expect(mockHistogram.observe).toHaveBeenCalled();
        });
    });
    describe('incrementHttpRequestsInProgress', () => {
        it('deve incrementar o medidor de requisições em andamento', () => {
            service.incrementHttpRequestsInProgress('PUT', '/api/cidadaos/1');
            expect(mockGauge.inc).toHaveBeenCalled();
        });
    });
    describe('decrementHttpRequestsInProgress', () => {
        it('deve decrementar o medidor de requisições em andamento', () => {
            service.decrementHttpRequestsInProgress('DELETE', '/api/cidadaos/1');
            expect(mockGauge.dec).toHaveBeenCalled();
        });
    });
    describe('getMetrics', () => {
        it('deve retornar as métricas coletadas', async () => {
            const result = await service.getMetrics();
            expect(result).toBe('metrics_data');
            expect(mockRegistry.metrics).toHaveBeenCalled();
        });
    });
    describe('recordDatabaseQuery', () => {
        it('deve incrementar o contador de consultas ao banco de dados', () => {
            service.recordDatabaseQuery('Usuario', 'SELECT');
            expect(mockCounter.inc).toHaveBeenCalled();
        });
    });
    describe('recordDatabaseQueryDuration', () => {
        it('deve registrar a duração de uma consulta ao banco de dados', () => {
            service.recordDatabaseQueryDuration('Usuario', 'SELECT', 0.3);
            expect(mockHistogram.observe).toHaveBeenCalled();
        });
    });
    describe('getRegister', () => {
        it('deve retornar o registro de métricas', () => {
            const result = service.getRegister();
            expect(result).toBe(mockRegistry);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcdGVzdHNcXG1ldHJpY3Muc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkNBQXNEO0FBQ3RELHdEQUFvRDtBQUNwRCxvREFBc0M7QUFFdEM7Ozs7O0dBS0c7QUFDSCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBdUI5QixpQ0FBaUM7SUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUM5QixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQztRQUN4RCxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQztRQUNwRCxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQztRQUM1RCxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQztRQUMxRCxxQkFBcUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBN0JKLElBQUksT0FBdUIsQ0FBQztJQUU1QixxREFBcUQ7SUFDckQsTUFBTSxXQUFXLEdBQUc7UUFDbEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDZixDQUFDO0lBRUYsTUFBTSxTQUFTLEdBQUc7UUFDaEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUs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QUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxFQUFFLENBQUMsNERBQTRELEVBQUUsR0FBRyxFQUFFO1lBQ3BFLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFakQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsNkJBQTZCLEVBQUUsR0FBRyxFQUFFO1FBQzNDLEVBQUUsQ0FBQyw0REFBNEQsRUFBRSxHQUFHLEVBQUU7WUFDcEUsT0FBTyxDQUFDLDJCQUEyQixDQUFDLFNBQVMsRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFOUQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtRQUMzQixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzlDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUVyQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcc2hhcmVkXFxtb25pdG9yaW5nXFx0ZXN0c1xcbWV0cmljcy5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBNZXRyaWNzU2VydmljZSB9IGZyb20gJy4uL21ldHJpY3Muc2VydmljZSc7XG5pbXBvcnQgKiBhcyBjbGllbnQgZnJvbSAncHJvbS1jbGllbnQnO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgbyBzZXJ2acOnbyBkZSBtw6l0cmljYXNcbiAqXG4gKiBWZXJpZmljYSBvIGZ1bmNpb25hbWVudG8gZG9zIG3DqXRvZG9zIGRlIGNvbGV0YSBlIGV4cG9zacOnw6NvIGRlIG3DqXRyaWNhc1xuICogZGEgYXBsaWNhw6fDo28gdXNhbmRvIFByb21ldGhldXNcbiAqL1xuZGVzY3JpYmUoJ01ldHJpY3NTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogTWV0cmljc1NlcnZpY2U7XG5cbiAgLy8gTW9ja3MgcGFyYSBvcyBjb250YWRvcmVzIGUgbWVkaWRvcmVzIGRvIFByb21ldGhldXNcbiAgY29uc3QgbW9ja0NvdW50ZXIgPSB7XG4gICAgaW5jOiBqZXN0LmZuKCksXG4gIH07XG5cbiAgY29uc3QgbW9ja0dhdWdlID0ge1xuICAgIGluYzogamVzdC5mbigpLFxuICAgIGRlYzogamVzdC5mbigpLFxuICB9O1xuXG4gIGNvbnN0IG1vY2tIaXN0b2dyYW0gPSB7XG4gICAgb2JzZXJ2ZTogamVzdC5mbigpLFxuICB9O1xuXG4gIGNvbnN0IG1vY2tSZWdpc3RyeSA9IHtcbiAgICBtZXRyaWNzOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ21ldHJpY3NfZGF0YScpLFxuICAgIHJlZ2lzdGVyTWV0cmljOiBqZXN0LmZuKCksXG4gICAgY2xlYXI6IGplc3QuZm4oKSxcbiAgfTtcblxuICAvLyBNb2NrIGRhcyBjbGFzc2VzIGRvIFByb21ldGhldXNcbiAgamVzdC5tb2NrKCdwcm9tLWNsaWVudCcsICgpID0+ICh7XG4gICAgQ291bnRlcjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQ291bnRlciksXG4gICAgR2F1Z2U6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0dhdWdlKSxcbiAgICBIaXN0b2dyYW06IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0hpc3RvZ3JhbSksXG4gICAgUmVnaXN0cnk6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja1JlZ2lzdHJ5KSxcbiAgICBjb2xsZWN0RGVmYXVsdE1ldHJpY3M6IGplc3QuZm4oKSxcbiAgfSkpO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuXG4gICAgLy8gUmVzdGF1cmFyIG9zIG1vY2tzIG9yaWdpbmFpc1xuICAgIGplc3Quc3B5T24oY2xpZW50LCAnQ291bnRlcicpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQ291bnRlciBhcyBhbnkpO1xuICAgIGplc3Quc3B5T24oY2xpZW50LCAnR2F1Z2UnKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0dhdWdlIGFzIGFueSk7XG4gICAgamVzdFxuICAgICAgLnNweU9uKGNsaWVudCwgJ0hpc3RvZ3JhbScpXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tIaXN0b2dyYW0gYXMgYW55KTtcbiAgICBqZXN0XG4gICAgICAuc3B5T24oY2xpZW50LCAnUmVnaXN0cnknKVxuICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrUmVnaXN0cnkgYXMgYW55KTtcbiAgICBqZXN0LnNweU9uKGNsaWVudCwgJ2NvbGxlY3REZWZhdWx0TWV0cmljcycpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7fSk7XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbTWV0cmljc1NlcnZpY2VdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PE1ldHJpY3NTZXJ2aWNlPihNZXRyaWNzU2VydmljZSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5yZXN0b3JlQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgc2VyIGRlZmluaWRvJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY29uc3RydWN0b3InLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgaW5pY2lhbGl6YXIgbyByZWdpc3RybyBlIGFzIG3DqXRyaWNhcyBwYWRyw6NvJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGNsaWVudC5SZWdpc3RyeSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGNsaWVudC5jb2xsZWN0RGVmYXVsdE1ldHJpY3MpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG9zIGNvbnRhZG9yZXMgZSBtZWRpZG9yZXMgZm9yYW0gY3JpYWRvcyBjb20gb3MgcGFyw6JtZXRyb3MgY29ycmV0b3NcbiAgICAgIC8vIFNlbSB2ZXJpZmljYXIgb3MgdmFsb3JlcyBleGF0b3MsIHBvaXMgYSBpbXBsZW1lbnRhw6fDo28gcG9kZSBtdWRhclxuICAgICAgZXhwZWN0KGNsaWVudC5Db3VudGVyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoY2xpZW50Lkhpc3RvZ3JhbSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGNsaWVudC5HYXVnZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVjb3JkSHR0cFJlcXVlc3QnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgaW5jcmVtZW50YXIgbyBjb250YWRvciBkZSByZXF1aXNpw6fDtWVzIEhUVFAnLCAoKSA9PiB7XG4gICAgICBzZXJ2aWNlLnJlY29yZEh0dHBSZXF1ZXN0KCdHRVQnLCAnL2FwaS9jaWRhZGFvcycsIDIwMCk7XG5cbiAgICAgIGV4cGVjdChtb2NrQ291bnRlci5pbmMpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JlY29yZEh0dHBSZXF1ZXN0RHVyYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGEgZHVyYcOnw6NvIGRlIHVtYSByZXF1aXNpw6fDo28gSFRUUCcsICgpID0+IHtcbiAgICAgIHNlcnZpY2UucmVjb3JkSHR0cFJlcXVlc3REdXJhdGlvbignUE9TVCcsICcvYXBpL2NpZGFkYW9zJywgMjAwLCAwLjUpO1xuXG4gICAgICBleHBlY3QobW9ja0hpc3RvZ3JhbS5vYnNlcnZlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdpbmNyZW1lbnRIdHRwUmVxdWVzdHNJblByb2dyZXNzJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIGluY3JlbWVudGFyIG8gbWVkaWRvciBkZSByZXF1aXNpw6fDtWVzIGVtIGFuZGFtZW50bycsICgpID0+IHtcbiAgICAgIHNlcnZpY2UuaW5jcmVtZW50SHR0cFJlcXVlc3RzSW5Qcm9ncmVzcygnUFVUJywgJy9hcGkvY2lkYWRhb3MvMScpO1xuXG4gICAgICBleHBlY3QobW9ja0dhdWdlLmluYykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGVjcmVtZW50SHR0cFJlcXVlc3RzSW5Qcm9ncmVzcycsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBkZWNyZW1lbnRhciBvIG1lZGlkb3IgZGUgcmVxdWlzacOnw7VlcyBlbSBhbmRhbWVudG8nLCAoKSA9PiB7XG4gICAgICBzZXJ2aWNlLmRlY3JlbWVudEh0dHBSZXF1ZXN0c0luUHJvZ3Jlc3MoJ0RFTEVURScsICcvYXBpL2NpZGFkYW9zLzEnKTtcblxuICAgICAgZXhwZWN0KG1vY2tHYXVnZS5kZWMpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldE1ldHJpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgYXMgbcOpdHJpY2FzIGNvbGV0YWRhcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ2V0TWV0cmljcygpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKCdtZXRyaWNzX2RhdGEnKTtcbiAgICAgIGV4cGVjdChtb2NrUmVnaXN0cnkubWV0cmljcykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVjb3JkRGF0YWJhc2VRdWVyeScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBpbmNyZW1lbnRhciBvIGNvbnRhZG9yIGRlIGNvbnN1bHRhcyBhbyBiYW5jbyBkZSBkYWRvcycsICgpID0+IHtcbiAgICAgIHNlcnZpY2UucmVjb3JkRGF0YWJhc2VRdWVyeSgnVXN1YXJpbycsICdTRUxFQ1QnKTtcblxuICAgICAgZXhwZWN0KG1vY2tDb3VudGVyLmluYykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVjb3JkRGF0YWJhc2VRdWVyeUR1cmF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBhIGR1cmHDp8OjbyBkZSB1bWEgY29uc3VsdGEgYW8gYmFuY28gZGUgZGFkb3MnLCAoKSA9PiB7XG4gICAgICBzZXJ2aWNlLnJlY29yZERhdGFiYXNlUXVlcnlEdXJhdGlvbignVXN1YXJpbycsICdTRUxFQ1QnLCAwLjMpO1xuXG4gICAgICBleHBlY3QobW9ja0hpc3RvZ3JhbS5vYnNlcnZlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRSZWdpc3RlcicsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZXRvcm5hciBvIHJlZ2lzdHJvIGRlIG3DqXRyaWNhcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UuZ2V0UmVnaXN0ZXIoKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShtb2NrUmVnaXN0cnkpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9