79a48bbf4617f80f89da40a29eef39d1
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var AuditoriaModule_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditoriaModule = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const bull_1 = require("@nestjs/bull");
const jwt_1 = require("@nestjs/jwt");
const config_1 = require("@nestjs/config");
const schedule_adapter_module_1 = require("../../shared/schedule/schedule-adapter.module");
const auth_module_1 = require("../../auth/auth.module");
// Entidades
const entities_1 = require("../../entities");
// Serviços Core
const auditoria_service_1 = require("./services/auditoria.service");
const auditoria_queue_service_1 = require("./services/auditoria-queue.service");
const auditoria_queue_processor_1 = require("./services/auditoria-queue.processor");
// Serviços Especializados
const auditoria_signature_service_1 = require("./services/auditoria-signature.service");
const auditoria_exportacao_service_1 = require("./services/auditoria-exportacao.service");
const auditoria_monitoramento_service_1 = require("./services/auditoria-monitoramento.service");
// Controladores
const auditoria_controller_1 = require("./controllers/auditoria.controller");
const auditoria_exportacao_controller_1 = require("./controllers/auditoria-exportacao.controller");
const auditoria_monitoramento_controller_1 = require("./controllers/auditoria-monitoramento.controller");
// Middleware
const auditoria_middleware_1 = require("./middlewares/auditoria.middleware");
// Repositórios
const log_auditoria_repository_1 = require("./repositories/log-auditoria.repository");
/**
 * Módulo de Auditoria Unificado
 *
 * Responsável por registrar e gerenciar logs de auditoria do sistema,
 * garantindo a rastreabilidade das operações e compliance com LGPD.
 *
 * Funcionalidades:
 * - Registro automático de operações via middleware e interceptores
 * - Proteção contra tampering usando assinaturas JWT
 * - Compressão de dados para otimização de espaço
 * - Particionamento de tabelas para melhor performance
 * - Exportação de logs em diferentes formatos
 * - Monitoramento de performance e integridade
 * - Processamento assíncrono via filas
 *
 * Este módulo é global e deve ser importado apenas pelo módulo principal (AppModule).
 * Os serviços são exportados para serem usados em qualquer outro módulo sem necessidade de reimportação.
 */
let AuditoriaModule = AuditoriaModule_1 = class AuditoriaModule {
    logger = new common_1.Logger(AuditoriaModule_1.name);
    /**
     * Configura o middleware de auditoria para todas as rotas da API
     * Restaurado com tratamento de erros
     */
    configure(consumer) {
        try {
            consumer
                .apply(auditoria_middleware_1.AuditoriaMiddleware)
                .exclude({ path: 'health', method: common_1.RequestMethod.ALL }, { path: 'metrics', method: common_1.RequestMethod.ALL }, { path: 'api-docs', method: common_1.RequestMethod.ALL }, { path: 'auditoria/monitoramento', method: common_1.RequestMethod.ALL })
                .forRoutes({ path: '*', method: common_1.RequestMethod.ALL });
            this.logger.log('Middleware de auditoria configurado com sucesso');
        }
        catch (error) {
            this.logger.error(`Erro ao configurar middleware de auditoria: ${error.message}`);
            // Não propagar erro para não bloquear a inicialização da aplicação
        }
    }
};
exports.AuditoriaModule = AuditoriaModule;
exports.AuditoriaModule = AuditoriaModule = AuditoriaModule_1 = __decorate([
    (0, common_1.Global)(),
    (0, common_1.Module)({
        imports: [
            // Configuração do TypeORM para entidades do módulo
            typeorm_1.TypeOrmModule.forFeature([entities_1.LogAuditoria]),
            // Configuração assíncrona do BullModule
            bull_1.BullModule.registerQueueAsync({
                name: 'auditoria',
                imports: [config_1.ConfigModule],
                useFactory: (configService) => ({
                    redis: {
                        host: configService.get('REDIS_HOST', 'localhost'),
                        port: configService.get('REDIS_PORT', 6379),
                    },
                }),
                inject: [config_1.ConfigService],
            }),
            // Módulo de agendamento de tarefas
            schedule_adapter_module_1.ScheduleAdapterModule,
            // Módulo de autenticação (para JwtAuthGuard e JwtBlacklistService)
            (0, common_1.forwardRef)(() => auth_module_1.AuthModule),
            // Configuração assíncrona do JwtModule
            jwt_1.JwtModule.registerAsync({
                imports: [config_1.ConfigModule],
                useFactory: (configService) => ({
                    secret: configService.get('JWT_SECRET'),
                    signOptions: { expiresIn: '1d' },
                }),
                inject: [config_1.ConfigService],
            }),
        ],
        controllers: [
            auditoria_controller_1.AuditoriaController,
            auditoria_exportacao_controller_1.AuditoriaExportacaoController,
            auditoria_monitoramento_controller_1.AuditoriaMonitoramentoController,
        ],
        providers: [
            // Serviços Core
            auditoria_service_1.AuditoriaService,
            auditoria_queue_service_1.AuditoriaQueueService,
            auditoria_queue_processor_1.AuditoriaQueueProcessor,
            // Repositórios
            log_auditoria_repository_1.LogAuditoriaRepository,
            // Serviços Especializados
            auditoria_signature_service_1.AuditoriaSignatureService,
            auditoria_exportacao_service_1.AuditoriaExportacaoService,
            auditoria_monitoramento_service_1.AuditoriaMonitoramentoService,
        ],
        exports: [
            // Exporta os serviços principais para uso em outros módulos
            auditoria_service_1.AuditoriaService,
            auditoria_queue_service_1.AuditoriaQueueService,
            log_auditoria_repository_1.LogAuditoriaRepository,
            auditoria_signature_service_1.AuditoriaSignatureService,
        ],
    })
], AuditoriaModule);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcYXVkaXRvcmlhLm1vZHVsZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsMkNBUXdCO0FBQ3hCLDZDQUFnRDtBQUNoRCx1Q0FBMEM7QUFDMUMscUNBQXdDO0FBQ3hDLDJDQUE2RDtBQUM3RCwyRkFBc0Y7QUFDdEYsd0RBQW9EO0FBR3BELFlBQVk7QUFDWiw2Q0FBOEM7QUFFOUMsZ0JBQWdCO0FBQ2hCLG9FQUFnRTtBQUNoRSxnRkFBMkU7QUFDM0Usb0ZBQStFO0FBRS9FLDBCQUEwQjtBQUMxQix3RkFBbUY7QUFDbkYsMEZBQXFGO0FBQ3JGLGdHQUEyRjtBQUUzRixnQkFBZ0I7QUFDaEIsNkVBQXlFO0FBQ3pFLG1HQUE4RjtBQUM5Rix5R0FBb0c7QUFFcEcsYUFBYTtBQUNiLDZFQUF5RTtBQUV6RSxlQUFlO0FBQ2Ysc0ZBQWlGO0FBRWpGOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQStESSxJQUFNLGVBQWUsdUJBQXJCLE1BQU0sZUFBZTtJQUNULE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNEOzs7T0FHRztJQUNILFNBQVMsQ0FBQyxRQUE0QjtRQUNwQyxJQUFJLENBQUM7WUFDSCxRQUFRO2lCQUNMLEtBQUssQ0FBQywwQ0FBbUIsQ0FBQztpQkFDMUIsT0FBTyxDQUNOLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsc0JBQWEsQ0FBQyxHQUFHLEVBQUUsRUFDN0MsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxzQkFBYSxDQUFDLEdBQUcsRUFBRSxFQUM5QyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLHNCQUFhLENBQUMsR0FBRyxFQUFFLEVBQy9DLEVBQUUsSUFBSSxFQUFFLHlCQUF5QixFQUFFLE1BQU0sRUFBRSxzQkFBYSxDQUFDLEdBQUcsRUFBRSxDQUMvRDtpQkFDQSxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxzQkFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFFdkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsaURBQWlELENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLCtDQUErQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUNsRixtRUFBbUU7UUFDckUsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBeEJZLDBDQUFlOzBCQUFmLGVBQWU7SUE5RDNCLElBQUEsZUFBTSxHQUFFO0lBQ1IsSUFBQSxlQUFNLEVBQUM7UUFDTixPQUFPLEVBQUU7WUFDUCxtREFBbUQ7WUFDbkQsdUJBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyx1QkFBWSxDQUFDLENBQUM7WUFFeEMsd0NBQXdDO1lBQ3hDLGlCQUFVLENBQUMsa0JBQWtCLENBQUM7Z0JBQzVCLElBQUksRUFBRSxXQUFXO2dCQUNqQixPQUFPLEVBQUUsQ0FBQyxxQkFBWSxDQUFDO2dCQUN2QixVQUFVLEVBQUUsQ0FBQyxhQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUM3QyxLQUFLLEVBQUU7d0JBQ0wsSUFBSSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMsWUFBWSxFQUFFLFdBQVcsQ0FBQzt3QkFDMUQsSUFBSSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMsWUFBWSxFQUFFLElBQUksQ0FBQztxQkFDcEQ7aUJBQ0YsQ0FBQztnQkFDRixNQUFNLEVBQUUsQ0FBQyxzQkFBYSxDQUFDO2FBQ3hCLENBQUM7WUFFRixtQ0FBbUM7WUFDbkMsK0NBQXFCO1lBRXJCLG1FQUFtRTtZQUNuRSxJQUFBLG1CQUFVLEVBQUMsR0FBRyxFQUFFLENBQUMsd0JBQVUsQ0FBQztZQUU1Qix1Q0FBdUM7WUFDdkMsZUFBUyxDQUFDLGFBQWEsQ0FBQztnQkFDdEIsT0FBTyxFQUFFLENBQUMscUJBQVksQ0FBQztnQkFDdkIsVUFBVSxFQUFFLENBQUMsYUFBNEIsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDN0MsTUFBTSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMsWUFBWSxDQUFDO29CQUMvQyxXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFO2lCQUNqQyxDQUFDO2dCQUNGLE1BQU0sRUFBRSxDQUFDLHNCQUFhLENBQUM7YUFDeEIsQ0FBQztTQUNIO1FBQ0QsV0FBVyxFQUFFO1lBQ1gsMENBQW1CO1lBQ25CLCtEQUE2QjtZQUM3QixxRUFBZ0M7U0FDakM7UUFDRCxTQUFTLEVBQUU7WUFDVCxnQkFBZ0I7WUFDaEIsb0NBQWdCO1lBQ2hCLCtDQUFxQjtZQUNyQixtREFBdUI7WUFFdkIsZUFBZTtZQUNmLGlEQUFzQjtZQUV0QiwwQkFBMEI7WUFDMUIsdURBQXlCO1lBQ3pCLHlEQUEwQjtZQUMxQiwrREFBNkI7U0FDOUI7UUFDRCxPQUFPLEVBQUU7WUFDUCw0REFBNEQ7WUFDNUQsb0NBQWdCO1lBQ2hCLCtDQUFxQjtZQUNyQixpREFBc0I7WUFDdEIsdURBQXlCO1NBQzFCO0tBQ0YsQ0FBQztHQUNXLGVBQWUsQ0F3QjNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxhdWRpdG9yaWFcXGF1ZGl0b3JpYS5tb2R1bGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgR2xvYmFsLFxuICBNb2R1bGUsXG4gIE5lc3RNb2R1bGUsXG4gIE1pZGRsZXdhcmVDb25zdW1lcixcbiAgUmVxdWVzdE1ldGhvZCxcbiAgTG9nZ2VyLFxuICBmb3J3YXJkUmVmXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFR5cGVPcm1Nb2R1bGUgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgQnVsbE1vZHVsZSB9IGZyb20gJ0BuZXN0anMvYnVsbCc7XG5pbXBvcnQgeyBKd3RNb2R1bGUgfSBmcm9tICdAbmVzdGpzL2p3dCc7XG5pbXBvcnQgeyBDb25maWdNb2R1bGUsIENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBTY2hlZHVsZUFkYXB0ZXJNb2R1bGUgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZWR1bGUvc2NoZWR1bGUtYWRhcHRlci5tb2R1bGUnO1xuaW1wb3J0IHsgQXV0aE1vZHVsZSB9IGZyb20gJy4uLy4uL2F1dGgvYXV0aC5tb2R1bGUnO1xuXG5cbi8vIEVudGlkYWRlc1xuaW1wb3J0IHsgTG9nQXVkaXRvcmlhIH0gZnJvbSAnLi4vLi4vZW50aXRpZXMnO1xuXG4vLyBTZXJ2acOnb3MgQ29yZVxuaW1wb3J0IHsgQXVkaXRvcmlhU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvYXVkaXRvcmlhLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXVkaXRvcmlhUXVldWVTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9hdWRpdG9yaWEtcXVldWUuc2VydmljZSc7XG5pbXBvcnQgeyBBdWRpdG9yaWFRdWV1ZVByb2Nlc3NvciB9IGZyb20gJy4vc2VydmljZXMvYXVkaXRvcmlhLXF1ZXVlLnByb2Nlc3Nvcic7XG5cbi8vIFNlcnZpw6dvcyBFc3BlY2lhbGl6YWRvc1xuaW1wb3J0IHsgQXVkaXRvcmlhU2lnbmF0dXJlU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvYXVkaXRvcmlhLXNpZ25hdHVyZS5zZXJ2aWNlJztcbmltcG9ydCB7IEF1ZGl0b3JpYUV4cG9ydGFjYW9TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9hdWRpdG9yaWEtZXhwb3J0YWNhby5zZXJ2aWNlJztcbmltcG9ydCB7IEF1ZGl0b3JpYU1vbml0b3JhbWVudG9TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9hdWRpdG9yaWEtbW9uaXRvcmFtZW50by5zZXJ2aWNlJztcblxuLy8gQ29udHJvbGFkb3Jlc1xuaW1wb3J0IHsgQXVkaXRvcmlhQ29udHJvbGxlciB9IGZyb20gJy4vY29udHJvbGxlcnMvYXVkaXRvcmlhLmNvbnRyb2xsZXInO1xuaW1wb3J0IHsgQXVkaXRvcmlhRXhwb3J0YWNhb0NvbnRyb2xsZXIgfSBmcm9tICcuL2NvbnRyb2xsZXJzL2F1ZGl0b3JpYS1leHBvcnRhY2FvLmNvbnRyb2xsZXInO1xuaW1wb3J0IHsgQXVkaXRvcmlhTW9uaXRvcmFtZW50b0NvbnRyb2xsZXIgfSBmcm9tICcuL2NvbnRyb2xsZXJzL2F1ZGl0b3JpYS1tb25pdG9yYW1lbnRvLmNvbnRyb2xsZXInO1xuXG4vLyBNaWRkbGV3YXJlXG5pbXBvcnQgeyBBdWRpdG9yaWFNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlcy9hdWRpdG9yaWEubWlkZGxld2FyZSc7XG5cbi8vIFJlcG9zaXTDs3Jpb3NcbmltcG9ydCB7IExvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcy9sb2ctYXVkaXRvcmlhLnJlcG9zaXRvcnknO1xuXG4vKipcbiAqIE3Ds2R1bG8gZGUgQXVkaXRvcmlhIFVuaWZpY2Fkb1xuICpcbiAqIFJlc3BvbnPDoXZlbCBwb3IgcmVnaXN0cmFyIGUgZ2VyZW5jaWFyIGxvZ3MgZGUgYXVkaXRvcmlhIGRvIHNpc3RlbWEsXG4gKiBnYXJhbnRpbmRvIGEgcmFzdHJlYWJpbGlkYWRlIGRhcyBvcGVyYcOnw7VlcyBlIGNvbXBsaWFuY2UgY29tIExHUEQuXG4gKlxuICogRnVuY2lvbmFsaWRhZGVzOlxuICogLSBSZWdpc3RybyBhdXRvbcOhdGljbyBkZSBvcGVyYcOnw7VlcyB2aWEgbWlkZGxld2FyZSBlIGludGVyY2VwdG9yZXNcbiAqIC0gUHJvdGXDp8OjbyBjb250cmEgdGFtcGVyaW5nIHVzYW5kbyBhc3NpbmF0dXJhcyBKV1RcbiAqIC0gQ29tcHJlc3PDo28gZGUgZGFkb3MgcGFyYSBvdGltaXphw6fDo28gZGUgZXNwYcOnb1xuICogLSBQYXJ0aWNpb25hbWVudG8gZGUgdGFiZWxhcyBwYXJhIG1lbGhvciBwZXJmb3JtYW5jZVxuICogLSBFeHBvcnRhw6fDo28gZGUgbG9ncyBlbSBkaWZlcmVudGVzIGZvcm1hdG9zXG4gKiAtIE1vbml0b3JhbWVudG8gZGUgcGVyZm9ybWFuY2UgZSBpbnRlZ3JpZGFkZVxuICogLSBQcm9jZXNzYW1lbnRvIGFzc8OtbmNyb25vIHZpYSBmaWxhc1xuICpcbiAqIEVzdGUgbcOzZHVsbyDDqSBnbG9iYWwgZSBkZXZlIHNlciBpbXBvcnRhZG8gYXBlbmFzIHBlbG8gbcOzZHVsbyBwcmluY2lwYWwgKEFwcE1vZHVsZSkuXG4gKiBPcyBzZXJ2acOnb3Mgc8OjbyBleHBvcnRhZG9zIHBhcmEgc2VyZW0gdXNhZG9zIGVtIHF1YWxxdWVyIG91dHJvIG3Ds2R1bG8gc2VtIG5lY2Vzc2lkYWRlIGRlIHJlaW1wb3J0YcOnw6NvLlxuICovXG5AR2xvYmFsKClcbkBNb2R1bGUoe1xuICBpbXBvcnRzOiBbXG4gICAgLy8gQ29uZmlndXJhw6fDo28gZG8gVHlwZU9STSBwYXJhIGVudGlkYWRlcyBkbyBtw7NkdWxvXG4gICAgVHlwZU9ybU1vZHVsZS5mb3JGZWF0dXJlKFtMb2dBdWRpdG9yaWFdKSxcbiAgICBcbiAgICAvLyBDb25maWd1cmHDp8OjbyBhc3PDrW5jcm9uYSBkbyBCdWxsTW9kdWxlXG4gICAgQnVsbE1vZHVsZS5yZWdpc3RlclF1ZXVlQXN5bmMoe1xuICAgICAgbmFtZTogJ2F1ZGl0b3JpYScsXG4gICAgICBpbXBvcnRzOiBbQ29uZmlnTW9kdWxlXSxcbiAgICAgIHVzZUZhY3Rvcnk6IChjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlKSA9PiAoe1xuICAgICAgICByZWRpczoge1xuICAgICAgICAgIGhvc3Q6IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ1JFRElTX0hPU1QnLCAnbG9jYWxob3N0JyksXG4gICAgICAgICAgcG9ydDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignUkVESVNfUE9SVCcsIDYzNzkpLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBpbmplY3Q6IFtDb25maWdTZXJ2aWNlXSxcbiAgICB9KSxcbiAgICBcbiAgICAvLyBNw7NkdWxvIGRlIGFnZW5kYW1lbnRvIGRlIHRhcmVmYXNcbiAgICBTY2hlZHVsZUFkYXB0ZXJNb2R1bGUsXG4gICAgXG4gICAgLy8gTcOzZHVsbyBkZSBhdXRlbnRpY2HDp8OjbyAocGFyYSBKd3RBdXRoR3VhcmQgZSBKd3RCbGFja2xpc3RTZXJ2aWNlKVxuICAgIGZvcndhcmRSZWYoKCkgPT4gQXV0aE1vZHVsZSksXG4gICAgXG4gICAgLy8gQ29uZmlndXJhw6fDo28gYXNzw61uY3JvbmEgZG8gSnd0TW9kdWxlXG4gICAgSnd0TW9kdWxlLnJlZ2lzdGVyQXN5bmMoe1xuICAgICAgaW1wb3J0czogW0NvbmZpZ01vZHVsZV0sXG4gICAgICB1c2VGYWN0b3J5OiAoY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSkgPT4gKHtcbiAgICAgICAgc2VjcmV0OiBjb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdKV1RfU0VDUkVUJyksXG4gICAgICAgIHNpZ25PcHRpb25zOiB7IGV4cGlyZXNJbjogJzFkJyB9LFxuICAgICAgfSksXG4gICAgICBpbmplY3Q6IFtDb25maWdTZXJ2aWNlXSxcbiAgICB9KSxcbiAgXSxcbiAgY29udHJvbGxlcnM6IFtcbiAgICBBdWRpdG9yaWFDb250cm9sbGVyLFxuICAgIEF1ZGl0b3JpYUV4cG9ydGFjYW9Db250cm9sbGVyLFxuICAgIEF1ZGl0b3JpYU1vbml0b3JhbWVudG9Db250cm9sbGVyLFxuICBdLFxuICBwcm92aWRlcnM6IFtcbiAgICAvLyBTZXJ2acOnb3MgQ29yZVxuICAgIEF1ZGl0b3JpYVNlcnZpY2UsXG4gICAgQXVkaXRvcmlhUXVldWVTZXJ2aWNlLFxuICAgIEF1ZGl0b3JpYVF1ZXVlUHJvY2Vzc29yLFxuICAgIFxuICAgIC8vIFJlcG9zaXTDs3Jpb3NcbiAgICBMb2dBdWRpdG9yaWFSZXBvc2l0b3J5LFxuICAgIFxuICAgIC8vIFNlcnZpw6dvcyBFc3BlY2lhbGl6YWRvc1xuICAgIEF1ZGl0b3JpYVNpZ25hdHVyZVNlcnZpY2UsXG4gICAgQXVkaXRvcmlhRXhwb3J0YWNhb1NlcnZpY2UsXG4gICAgQXVkaXRvcmlhTW9uaXRvcmFtZW50b1NlcnZpY2UsXG4gIF0sXG4gIGV4cG9ydHM6IFtcbiAgICAvLyBFeHBvcnRhIG9zIHNlcnZpw6dvcyBwcmluY2lwYWlzIHBhcmEgdXNvIGVtIG91dHJvcyBtw7NkdWxvc1xuICAgIEF1ZGl0b3JpYVNlcnZpY2UsXG4gICAgQXVkaXRvcmlhUXVldWVTZXJ2aWNlLFxuICAgIExvZ0F1ZGl0b3JpYVJlcG9zaXRvcnksXG4gICAgQXVkaXRvcmlhU2lnbmF0dXJlU2VydmljZSxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgQXVkaXRvcmlhTW9kdWxlIGltcGxlbWVudHMgTmVzdE1vZHVsZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihBdWRpdG9yaWFNb2R1bGUubmFtZSk7XG4gIC8qKlxuICAgKiBDb25maWd1cmEgbyBtaWRkbGV3YXJlIGRlIGF1ZGl0b3JpYSBwYXJhIHRvZGFzIGFzIHJvdGFzIGRhIEFQSVxuICAgKiBSZXN0YXVyYWRvIGNvbSB0cmF0YW1lbnRvIGRlIGVycm9zXG4gICAqL1xuICBjb25maWd1cmUoY29uc3VtZXI6IE1pZGRsZXdhcmVDb25zdW1lcikge1xuICAgIHRyeSB7XG4gICAgICBjb25zdW1lclxuICAgICAgICAuYXBwbHkoQXVkaXRvcmlhTWlkZGxld2FyZSlcbiAgICAgICAgLmV4Y2x1ZGUoXG4gICAgICAgICAgeyBwYXRoOiAnaGVhbHRoJywgbWV0aG9kOiBSZXF1ZXN0TWV0aG9kLkFMTCB9LFxuICAgICAgICAgIHsgcGF0aDogJ21ldHJpY3MnLCBtZXRob2Q6IFJlcXVlc3RNZXRob2QuQUxMIH0sXG4gICAgICAgICAgeyBwYXRoOiAnYXBpLWRvY3MnLCBtZXRob2Q6IFJlcXVlc3RNZXRob2QuQUxMIH0sXG4gICAgICAgICAgeyBwYXRoOiAnYXVkaXRvcmlhL21vbml0b3JhbWVudG8nLCBtZXRob2Q6IFJlcXVlc3RNZXRob2QuQUxMIH0sIC8vIEV2aXRhciByZWN1cnPDo29cbiAgICAgICAgKVxuICAgICAgICAuZm9yUm91dGVzKHsgcGF0aDogJyonLCBtZXRob2Q6IFJlcXVlc3RNZXRob2QuQUxMIH0pO1xuICAgICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygnTWlkZGxld2FyZSBkZSBhdWRpdG9yaWEgY29uZmlndXJhZG8gY29tIHN1Y2Vzc28nKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gY29uZmlndXJhciBtaWRkbGV3YXJlIGRlIGF1ZGl0b3JpYTogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgLy8gTsOjbyBwcm9wYWdhciBlcnJvIHBhcmEgbsOjbyBibG9xdWVhciBhIGluaWNpYWxpemHDp8OjbyBkYSBhcGxpY2HDp8Ojb1xuICAgIH1cbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==