90d951abaa29190ca870ec047489248e
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UsuarioRepository = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("typeorm");
const usuario_entity_1 = require("../../../entities/usuario.entity");
const usuario_errors_1 = require("../../../shared/exceptions/error-catalog/domains/usuario.errors");
/**
 * Repositório de usuários
 *
 * Responsável por operações de acesso a dados relacionadas a usuários
 */
let UsuarioRepository = class UsuarioRepository {
    dataSource;
    repository;
    constructor(dataSource) {
        this.dataSource = dataSource;
        this.repository = this.dataSource.getRepository(usuario_entity_1.Usuario);
    }
    /**
     * Busca todos os usuários com filtros e paginação
     * @param options Opções de filtro e paginação
     * @returns Lista de usuários paginada
     */
    async findAll(options) {
        const { skip = 0, take = 10, where = {}, order = { created_at: 'DESC' }, } = options || {};
        return this.repository.findAndCount({
            skip,
            take,
            where,
            order,
        });
    }
    /**
     * Busca um usuário pelo ID
     * @param id ID do usuário
     * @returns Usuário encontrado
     * @throws UsuarioError quando usuário não encontrado
     */
    async findById(id) {
        const usuario = await this.repository.findOne({
            where: { id },
            relations: ['unidade', 'setor'],
        });
        if (!usuario) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
        return usuario;
    }
    /**
     * Busca um usuário pelo email
     * @param email Email do usuário
     * @returns Usuário encontrado ou null
     */
    async findByEmail(email) {
        return this.repository.findOne({ where: { email } });
    }
    /**
     * Busca um usuário pelo CPF
     * @param cpf CPF do usuário
     * @returns Usuário encontrado ou null
     */
    async findByCpf(cpf) {
        return this.repository.findOne({ where: { cpf } });
    }
    /**
     * Busca um usuário pela matrícula
     * @param matricula Matrícula do usuário
     * @returns Usuário encontrado ou null
     */
    async findByMatricula(matricula) {
        return this.repository.findOne({ where: { matricula } });
    }
    /**
     * Cria um novo usuário
     * @param data Dados do usuário
     * @returns Usuário criado
     */
    async create(data) {
        const usuario = this.repository.create(data);
        return this.repository.save(usuario);
    }
    /**
     * Atualiza um usuário existente
     * @param id ID do usuário
     * @param data Dados a serem atualizados
     * @returns Usuário atualizado
     */
    async update(id, data) {
        const result = await this.repository.update(id, data);
        if (result.affected === 0) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
        const usuario = await this.findById(id);
        if (!usuario) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
        return usuario;
    }
    /**
     * Atualiza o status de um usuário
     * @param id ID do usuário
     * @param status Novo status
     * @returns Usuário atualizado
     */
    async updateStatus(id, status) {
        const dadosAtualizacao = { status };
        await this.repository.update(id, dadosAtualizacao);
        const usuario = await this.findById(id);
        if (!usuario) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
        return usuario;
    }
    /**
     * Atualiza a senha de um usuário
     * @param id ID do usuário
     * @param senhaHash Hash da nova senha
     * @returns Usuário atualizado
     */
    async updateSenha(id, senhaHash) {
        const dadosAtualizacao = {
            senhaHash,
            primeiro_acesso: false,
        };
        await this.repository.update(id, dadosAtualizacao);
        const usuario = await this.findById(id);
        if (!usuario) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
        return usuario;
    }
    /**
     * Remove um usuário (soft delete)
     * @param id ID do usuário
     * @returns Resultado da operação
     */
    async remove(id) {
        const result = await this.repository.softDelete(id);
        if (result.affected === 0) {
            (0, usuario_errors_1.throwUserNotFound)(id);
        }
    }
    /**
     * Conta o total de usuários
     * @param where Condições de filtro
     * @returns Número total de usuários
     */
    async count(where) {
        return this.repository.count({ where });
    }
};
exports.UsuarioRepository = UsuarioRepository;
exports.UsuarioRepository = UsuarioRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], UsuarioRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHJlcG9zaXRvcmllc1xcdXN1YXJpby5yZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMscUNBQThEO0FBRTlELHFFQUEyRDtBQUUzRCxvR0FBb0c7QUFFcEc7Ozs7R0FJRztBQUVJLElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBR1I7SUFGWixVQUFVLENBQXNCO0lBRXhDLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDeEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyx3QkFBTyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BS2I7UUFDQyxNQUFNLEVBQ0osSUFBSSxHQUFHLENBQUMsRUFDUixJQUFJLEdBQUcsRUFBRSxFQUNULEtBQUssR0FBRyxFQUFFLEVBQ1YsS0FBSyxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUMvQixHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFFbEIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQztZQUNsQyxJQUFJO1lBQ0osSUFBSTtZQUNKLEtBQUs7WUFDTCxLQUFLO1NBQ04sQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFVO1FBQ3ZCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7WUFDNUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO1lBQ2IsU0FBUyxFQUFFLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQztTQUNoQyxDQUFDLENBQUM7UUFFSCxJQUFJLENB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T0FJRztJQUNILEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBVTtRQUNyQixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUMxQixJQUFBLGtDQUFpQixFQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLENBQUM7SUFDSCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUMxQyxDQUFDO0NBQ0YsQ0FBQTtBQXBLWSw4Q0FBaUI7NEJBQWpCLGlCQUFpQjtJQUQ3QixJQUFBLG1CQUFVLEdBQUU7eURBSXFCLG9CQUFVLG9CQUFWLG9CQUFVO0dBSC9CLGlCQUFpQixDQW9LN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHVzdWFyaW9cXHJlcG9zaXRvcmllc1xcdXN1YXJpby5yZXBvc2l0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBEYXRhU291cmNlLCBEZWVwUGFydGlhbCB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBVc3VhcmlvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvdXN1YXJpby5lbnRpdHknO1xuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvc3RhdHVzLmVudW0nO1xuaW1wb3J0IHsgdGhyb3dVc2VyTm90Rm91bmQgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvZXhjZXB0aW9ucy9lcnJvci1jYXRhbG9nL2RvbWFpbnMvdXN1YXJpby5lcnJvcnMnO1xuXG4vKipcbiAqIFJlcG9zaXTDs3JpbyBkZSB1c3XDoXJpb3NcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcG9yIG9wZXJhw6fDtWVzIGRlIGFjZXNzbyBhIGRhZG9zIHJlbGFjaW9uYWRhcyBhIHVzdcOhcmlvc1xuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVXN1YXJpb1JlcG9zaXRvcnkge1xuICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VXN1YXJpbz47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhU291cmNlOiBEYXRhU291cmNlKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy5kYXRhU291cmNlLmdldFJlcG9zaXRvcnkoVXN1YXJpbyk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdG9kb3Mgb3MgdXN1w6FyaW9zIGNvbSBmaWx0cm9zIGUgcGFnaW5hw6fDo29cbiAgICogQHBhcmFtIG9wdGlvbnMgT3DDp8O1ZXMgZGUgZmlsdHJvIGUgcGFnaW5hw6fDo29cbiAgICogQHJldHVybnMgTGlzdGEgZGUgdXN1w6FyaW9zIHBhZ2luYWRhXG4gICAqL1xuICBhc3luYyBmaW5kQWxsKG9wdGlvbnM/OiB7XG4gICAgc2tpcD86IG51bWJlcjtcbiAgICB0YWtlPzogbnVtYmVyO1xuICAgIHdoZXJlPzogYW55O1xuICAgIG9yZGVyPzogYW55O1xuICB9KTogUHJvbWlzZTxbVXN1YXJpb1tdLCBudW1iZXJdPiB7XG4gICAgY29uc3Qge1xuICAgICAgc2tpcCA9IDAsXG4gICAgICB0YWtlID0gMTAsXG4gICAgICB3aGVyZSA9IHt9LFxuICAgICAgb3JkZXIgPSB7IGNyZWF0ZWRfYXQ6ICdERVNDJyB9LFxuICAgIH0gPSBvcHRpb25zIHx8IHt9O1xuXG4gICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeS5maW5kQW5kQ291bnQoe1xuICAgICAgc2tpcCxcbiAgICAgIHRha2UsXG4gICAgICB3aGVyZSxcbiAgICAgIG9yZGVyLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbG8gSURcbiAgICogQHBhcmFtIGlkIElEIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGVuY29udHJhZG9cbiAgICogQHRocm93cyBVc3VhcmlvRXJyb3IgcXVhbmRvIHVzdcOhcmlvIG7Do28gZW5jb250cmFkb1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8VXN1YXJpbz4ge1xuICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgcmVsYXRpb25zOiBbJ3VuaWRhZGUnLCAnc2V0b3InXSxcbiAgICB9KTtcblxuICAgIGlmICghdXN1YXJpbykge1xuICAgICAgdGhyb3dVc2VyTm90Rm91bmQoaWQpO1xuICAgIH1cblxuICAgIHJldHVybiB1c3VhcmlvO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbG8gZW1haWxcbiAgICogQHBhcmFtIGVtYWlsIEVtYWlsIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGVuY29udHJhZG8gb3UgbnVsbFxuICAgKi9cbiAgYXN5bmMgZmluZEJ5RW1haWwoZW1haWw6IHN0cmluZyk6IFByb21pc2U8VXN1YXJpbyB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LmZpbmRPbmUoeyB3aGVyZTogeyBlbWFpbCB9IH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbG8gQ1BGXG4gICAqIEBwYXJhbSBjcGYgQ1BGIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGVuY29udHJhZG8gb3UgbnVsbFxuICAgKi9cbiAgYXN5bmMgZmluZEJ5Q3BmKGNwZjogc3RyaW5nKTogUHJvbWlzZTxVc3VhcmlvIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGNwZiB9IH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIHVzdcOhcmlvIHBlbGEgbWF0csOtY3VsYVxuICAgKiBAcGFyYW0gbWF0cmljdWxhIE1hdHLDrWN1bGEgZG8gdXN1w6FyaW9cbiAgICogQHJldHVybnMgVXN1w6FyaW8gZW5jb250cmFkbyBvdSBudWxsXG4gICAqL1xuICBhc3luYyBmaW5kQnlNYXRyaWN1bGEobWF0cmljdWxhOiBzdHJpbmcpOiBQcm9taXNlPFVzdWFyaW8gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeS5maW5kT25lKHsgd2hlcmU6IHsgbWF0cmljdWxhIH0gfSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBub3ZvIHVzdcOhcmlvXG4gICAqIEBwYXJhbSBkYXRhIERhZG9zIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGNyaWFkb1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlKGRhdGE6IFBhcnRpYWw8VXN1YXJpbz4pOiBQcm9taXNlPFVzdWFyaW8+IHtcbiAgICBjb25zdCB1c3VhcmlvID0gdGhpcy5yZXBvc2l0b3J5LmNyZWF0ZShkYXRhKTtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LnNhdmUodXN1YXJpbyk7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW0gdXN1w6FyaW8gZXhpc3RlbnRlXG4gICAqIEBwYXJhbSBpZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gZGF0YSBEYWRvcyBhIHNlcmVtIGF0dWFsaXphZG9zXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGF0dWFsaXphZG9cbiAgICovXG4gIGFzeW5jIHVwZGF0ZShpZDogc3RyaW5nLCBkYXRhOiBQYXJ0aWFsPFVzdWFyaW8+KTogUHJvbWlzZTxVc3VhcmlvPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZShpZCwgZGF0YSk7XG4gICAgaWYgKHJlc3VsdC5hZmZlY3RlZCA9PT0gMCkge1xuICAgICAgdGhyb3dVc2VyTm90Rm91bmQoaWQpO1xuICAgIH1cbiAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy5maW5kQnlJZChpZCk7XG4gICAgaWYgKCF1c3VhcmlvKSB7XG4gICAgICB0aHJvd1VzZXJOb3RGb3VuZChpZCk7XG4gICAgfVxuICAgIHJldHVybiB1c3VhcmlvO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dWFsaXphIG8gc3RhdHVzIGRlIHVtIHVzdcOhcmlvXG4gICAqIEBwYXJhbSBpZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcGFyYW0gc3RhdHVzIE5vdm8gc3RhdHVzXG4gICAqIEByZXR1cm5zIFVzdcOhcmlvIGF0dWFsaXphZG9cbiAgICovXG4gIGFzeW5jIHVwZGF0ZVN0YXR1cyhpZDogc3RyaW5nLCBzdGF0dXM6IFN0YXR1cyk6IFByb21pc2U8VXN1YXJpbz4ge1xuICAgIGNvbnN0IGRhZG9zQXR1YWxpemFjYW86IERlZXBQYXJ0aWFsPFVzdWFyaW8+ID0geyBzdGF0dXMgfTtcblxuICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeS51cGRhdGUoaWQsIGRhZG9zQXR1YWxpemFjYW8pO1xuICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgIHRocm93VXNlck5vdEZvdW5kKGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHVzdWFyaW87XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgYSBzZW5oYSBkZSB1bSB1c3XDoXJpb1xuICAgKiBAcGFyYW0gaWQgSUQgZG8gdXN1w6FyaW9cbiAgICogQHBhcmFtIHNlbmhhSGFzaCBIYXNoIGRhIG5vdmEgc2VuaGFcbiAgICogQHJldHVybnMgVXN1w6FyaW8gYXR1YWxpemFkb1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlU2VuaGEoaWQ6IHN0cmluZywgc2VuaGFIYXNoOiBzdHJpbmcpOiBQcm9taXNlPFVzdWFyaW8+IHtcbiAgICBjb25zdCBkYWRvc0F0dWFsaXphY2FvOiBEZWVwUGFydGlhbDxVc3VhcmlvPiA9IHtcbiAgICAgIHNlbmhhSGFzaCxcbiAgICAgIHByaW1laXJvX2FjZXNzbzogZmFsc2UsXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMucmVwb3NpdG9yeS51cGRhdGUoaWQsIGRhZG9zQXR1YWxpemFjYW8pO1xuICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgIHRocm93VXNlck5vdEZvdW5kKGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHVzdWFyaW87XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHVtIHVzdcOhcmlvIChzb2Z0IGRlbGV0ZSlcbiAgICogQHBhcmFtIGlkIElEIGRvIHVzdcOhcmlvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSBvcGVyYcOnw6NvXG4gICAqL1xuICBhc3luYyByZW1vdmUoaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5zb2Z0RGVsZXRlKGlkKTtcbiAgICBpZiAocmVzdWx0LmFmZmVjdGVkID09PSAwKSB7XG4gICAgICB0aHJvd1VzZXJOb3RGb3VuZChpZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvbnRhIG8gdG90YWwgZGUgdXN1w6FyaW9zXG4gICAqIEBwYXJhbSB3aGVyZSBDb25kacOnw7VlcyBkZSBmaWx0cm9cbiAgICogQHJldHVybnMgTsO6bWVybyB0b3RhbCBkZSB1c3XDoXJpb3NcbiAgICovXG4gIGFzeW5jIGNvdW50KHdoZXJlPzogYW55KTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LmNvdW50KHsgd2hlcmUgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==