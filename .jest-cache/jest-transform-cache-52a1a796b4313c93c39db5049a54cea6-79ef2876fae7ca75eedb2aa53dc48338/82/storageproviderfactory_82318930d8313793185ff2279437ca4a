b4d0a3d128b65ad70e846df6a8fa17e7
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var StorageProviderFactory_1;
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageProviderFactory = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const storage_provider_interface_1 = require("../interfaces/storage-provider.interface");
const s3_storage_adapter_1 = require("../adapters/s3-storage.adapter");
const local_storage_adapter_1 = require("../adapters/local-storage.adapter");
const minio_service_1 = require("../../../shared/services/minio.service");
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
/**
 * Factory para criação de provedores de armazenamento
 *
 * Permite selecionar o provedor de armazenamento adequado
 * com base na configuração do sistema
 */
let StorageProviderFactory = StorageProviderFactory_1 = class StorageProviderFactory {
    configService;
    s3StorageAdapter;
    localStorageAdapter;
    minioService;
    logger = new common_1.Logger(StorageProviderFactory_1.name);
    defaultProvider;
    constructor(configService, s3StorageAdapter, localStorageAdapter, minioService) {
        this.configService = configService;
        this.s3StorageAdapter = s3StorageAdapter;
        this.localStorageAdapter = localStorageAdapter;
        this.minioService = minioService;
        this.defaultProvider = this.configService.get('STORAGE_PROVIDER', storage_provider_interface_1.TipoStorageProvider.MINIO);
        this.logger.log(`Provedor de armazenamento padrão: ${this.defaultProvider}`);
        // Inicializar o diretório de uploads local se necessário
        if (this.defaultProvider === storage_provider_interface_1.TipoStorageProvider.LOCAL) {
            const uploadsDir = this.configService.get('UPLOADS_DIR', path.join(process.cwd(), 'uploads'));
            if (!fs.existsSync(uploadsDir)) {
                fs.mkdirSync(uploadsDir, { recursive: true });
                this.logger.log(`Diretório de uploads criado: ${uploadsDir}`);
            }
        }
    }
    /**
     * Obtém o provedor de armazenamento padrão
     * @returns Provedor de armazenamento
     */
    getProvider() {
        return this.createProvider(this.defaultProvider);
    }
    /**
     * Cria um provedor de armazenamento com base no tipo especificado
     * @param type Tipo de provedor de armazenamento (opcional, usa o padrão se não especificado)
     * @returns Provedor de armazenamento
     */
    createProvider(type) {
        const providerType = type || this.defaultProvider;
        this.logger.debug(`Criando provedor de armazenamento: ${providerType}`);
        switch (providerType) {
            case storage_provider_interface_1.TipoStorageProvider.S3:
                if (!this.s3StorageAdapter) {
                    this.logger.warn('S3 não está configurado. Usando armazenamento local como fallback.');
                    return this.localStorageAdapter;
                }
                return this.s3StorageAdapter;
            case storage_provider_interface_1.TipoStorageProvider.MINIO:
                return this.createMinioAdapter();
            case storage_provider_interface_1.TipoStorageProvider.LOCAL:
                return this.localStorageAdapter;
            default:
                this.logger.warn(`Tipo de provedor desconhecido: ${providerType}. Usando provedor padrão: ${this.defaultProvider}`);
                // Evitar recursão infinita usando diretamente o provedor padrão
                if (this.defaultProvider === storage_provider_interface_1.TipoStorageProvider.S3) {
                    if (!this.s3StorageAdapter) {
                        this.logger.warn('S3 não está configurado. Usando armazenamento local como fallback.');
                        return this.localStorageAdapter;
                    }
                    return this.s3StorageAdapter;
                }
                else if (this.defaultProvider === storage_provider_interface_1.TipoStorageProvider.MINIO) {
                    return this.createMinioAdapter();
                }
                else {
                    return this.localStorageAdapter;
                }
        }
    }
    /**
     * Cria um adaptador para o MinIO que implementa a interface StorageProvider
     * @returns Adaptador para o MinIO
     */
    createMinioAdapter() {
        // Adaptar o MinioService para a interface StorageProvider
        return {
            nome: 'MinIO',
            salvarArquivo: async (buffer, nomeArquivo, mimetype, metadados) => {
                // Extrair solicitação ID e tipo de documento dos metadados, se disponíveis
                const solicitacaoId = metadados?.solicitacaoId || 'default';
                const tipoDocumento = metadados?.tipoDocumento || 'OUTRO';
                // Fazer upload usando o MinioService
                const resultado = await this.minioService.uploadArquivo(buffer, nomeArquivo, solicitacaoId, tipoDocumento);
                return resultado.nomeArquivo;
            },
            obterArquivo: async (caminho) => {
                // Fazer download usando o MinioService
                const resultado = await this.minioService.downloadArquivo(caminho);
                return resultado.arquivo;
            },
            removerArquivo: async (caminho) => {
                await this.minioService.removerArquivo(caminho);
            },
            upload: async (buffer, key, mimetype, metadata) => {
                // Usar o método salvarArquivo para manter consistência
                return this.minioService
                    .uploadArquivo(buffer, key, 'default', 'OUTRO')
                    .then((result) => result.nomeArquivo);
            },
            download: async (key) => {
                // Usar o método obterArquivo para manter consistência
                return this.minioService
                    .downloadArquivo(key)
                    .then((result) => result.arquivo);
            },
            delete: async (key) => {
                // Usar o método removerArquivo para manter consistência
                return this.minioService.removerArquivo(key);
            },
            getUrl: async (key, expiresIn) => {
                return this.minioService.gerarUrlPreAssinada(key, expiresIn || 3600);
            },
            exists: async (key) => {
                try {
                    // Tentar fazer download para verificar se existe
                    await this.minioService.downloadArquivo(key);
                    return true;
                }
                catch (error) {
                    if (error.message && error.message.includes('not found')) {
                        return false;
                    }
                    throw error; // Propagar outros erros
                }
            },
            copy: async (sourceKey, destinationKey) => {
                // Implementar cópia baixando e fazendo upload novamente
                const resultado = await this.minioService.downloadArquivo(sourceKey);
                // Extrair partes da chave de destino
                const parts = destinationKey.split('/');
                const solicitacaoId = parts[0] || 'default';
                const tipoDocumento = parts[1] || 'OUTRO';
                const nomeOriginal = parts.length > 2 ? parts[2] : destinationKey;
                // Fazer upload com a nova chave
                const resultadoUpload = await this.minioService.uploadArquivo(resultado.arquivo, nomeOriginal, solicitacaoId, tipoDocumento);
                return resultadoUpload.nomeArquivo;
            },
            list: async (prefix, maxKeys) => {
                try {
                    // Implementação básica usando cliente Minio diretamente
                    const client = minio_service_1.MinioService.client;
                    if (client && typeof client.listObjects === 'function') {
                        const objects = [];
                        const stream = client.listObjects(process.env.MINIO_BUCKET_NAME || 'documents', prefix, true);
                        return new Promise((resolve, reject) => {
                            stream.on('data', (obj) => {
                                if (obj.name && (!maxKeys || objects.length < maxKeys)) {
                                    objects.push(obj.name);
                                }
                            });
                            stream.on('end', () => resolve(objects));
                            stream.on('error', reject);
                        });
                    }
                    this.logger.warn('Cliente MinIO não disponível para listagem');
                    return [];
                }
                catch (error) {
                    this.logger.error('Erro ao listar arquivos no MinIO:', error);
                    return [];
                }
            },
        };
    }
};
exports.StorageProviderFactory = StorageProviderFactory;
exports.StorageProviderFactory = StorageProviderFactory = StorageProviderFactory_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof s3_storage_adapter_1.S3StorageAdapter !== "undefined" && s3_storage_adapter_1.S3StorageAdapter) === "function" ? _b : Object, typeof (_c = typeof local_storage_adapter_1.LocalStorageAdapter !== "undefined" && local_storage_adapter_1.LocalStorageAdapter) === "function" ? _c : Object, typeof (_d = typeof minio_service_1.MinioService !== "undefined" && minio_service_1.MinioService) === "function" ? _d : Object])
], StorageProviderFactory);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGRvY3VtZW50b1xcZmFjdG9yaWVzXFxzdG9yYWdlLXByb3ZpZGVyLmZhY3RvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQsMkNBQStDO0FBQy9DLHlGQUdrRDtBQUNsRCx1RUFBa0U7QUFDbEUsNkVBQXdFO0FBQ3hFLDBFQUFzRTtBQUN0RSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBRTdCOzs7OztHQUtHO0FBRUksSUFBTSxzQkFBc0IsOEJBQTVCLE1BQU0sc0JBQXNCO0lBS2Q7SUFDQTtJQUNBO0lBQ0E7SUFQRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsd0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsZUFBZSxDQUFzQjtJQUV0RCxZQUNtQixhQUE0QixFQUM1QixnQkFBa0MsRUFDbEMsbUJBQXdDLEVBQ3hDLFlBQTBCO1FBSDFCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUUzQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUMzQyxrQkFBa0IsRUFDbEIsZ0RBQW1CLENBQUMsS0FBSyxDQUMxQixDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IscUNBQXFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FDNUQsQ0FBQztRQUVGLHlEQUF5RDtRQUN6RCxJQUFJLElBQUksQ0FBQyxlQUFlLEtBQUssZ0RBQW1CLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdkQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEs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QUMsQ0FBQzs0QkFDekMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7d0JBQzdCLENBQUMsQ0FBQyxDQUFDO29CQUNMLENBQUM7b0JBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsNENBQTRDLENBQUMsQ0FBQztvQkFDL0QsT0FBTyxFQUFFLENBQUM7Z0JBQ1osQ0FBQztnQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO29CQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUM5RCxPQUFPLEVBQUUsQ0FBQztnQkFDWixDQUFDO1lBQ0gsQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQS9OWSx3REFBc0I7aUNBQXRCLHNCQUFzQjtJQURsQyxJQUFBLG1CQUFVLEdBQUU7eURBTXVCLHNCQUFhLG9CQUFiLHNCQUFhLG9EQUNWLHFDQUFnQixvQkFBaEIscUNBQWdCLG9EQUNiLDJDQUFtQixvQkFBbkIsMkNBQW1CLG9EQUMxQiw0QkFBWSxvQkFBWiw0QkFBWTtHQVJsQyxzQkFBc0IsQ0ErTmxDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxkb2N1bWVudG9cXGZhY3Rvcmllc1xcc3RvcmFnZS1wcm92aWRlci5mYWN0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQge1xuICBTdG9yYWdlUHJvdmlkZXIsXG4gIFRpcG9TdG9yYWdlUHJvdmlkZXIsXG59IGZyb20gJy4uL2ludGVyZmFjZXMvc3RvcmFnZS1wcm92aWRlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUzNTdG9yYWdlQWRhcHRlciB9IGZyb20gJy4uL2FkYXB0ZXJzL3MzLXN0b3JhZ2UuYWRhcHRlcic7XG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VBZGFwdGVyIH0gZnJvbSAnLi4vYWRhcHRlcnMvbG9jYWwtc3RvcmFnZS5hZGFwdGVyJztcbmltcG9ydCB7IE1pbmlvU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9zZXJ2aWNlcy9taW5pby5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbi8qKlxuICogRmFjdG9yeSBwYXJhIGNyaWHDp8OjbyBkZSBwcm92ZWRvcmVzIGRlIGFybWF6ZW5hbWVudG9cbiAqXG4gKiBQZXJtaXRlIHNlbGVjaW9uYXIgbyBwcm92ZWRvciBkZSBhcm1hemVuYW1lbnRvIGFkZXF1YWRvXG4gKiBjb20gYmFzZSBuYSBjb25maWd1cmHDp8OjbyBkbyBzaXN0ZW1hXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdG9yYWdlUHJvdmlkZXJGYWN0b3J5IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFN0b3JhZ2VQcm92aWRlckZhY3RvcnkubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFByb3ZpZGVyOiBUaXBvU3RvcmFnZVByb3ZpZGVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHMzU3RvcmFnZUFkYXB0ZXI6IFMzU3RvcmFnZUFkYXB0ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBsb2NhbFN0b3JhZ2VBZGFwdGVyOiBMb2NhbFN0b3JhZ2VBZGFwdGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWluaW9TZXJ2aWNlOiBNaW5pb1NlcnZpY2UsXG4gICkge1xuICAgIHRoaXMuZGVmYXVsdFByb3ZpZGVyID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxUaXBvU3RvcmFnZVByb3ZpZGVyPihcbiAgICAgICdTVE9SQUdFX1BST1ZJREVSJyxcbiAgICAgIFRpcG9TdG9yYWdlUHJvdmlkZXIuTUlOSU8sXG4gICAgKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBQcm92ZWRvciBkZSBhcm1hemVuYW1lbnRvIHBhZHLDo286ICR7dGhpcy5kZWZhdWx0UHJvdmlkZXJ9YCxcbiAgICApO1xuXG4gICAgLy8gSW5pY2lhbGl6YXIgbyBkaXJldMOzcmlvIGRlIHVwbG9hZHMgbG9jYWwgc2UgbmVjZXNzw6FyaW9cbiAgICBpZiAodGhpcy5kZWZhdWx0UHJvdmlkZXIgPT09IFRpcG9TdG9yYWdlUHJvdmlkZXIuTE9DQUwpIHtcbiAgICAgIGNvbnN0IHVwbG9hZHNEaXIgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXG4gICAgICAgICdVUExPQURTX0RJUicsXG4gICAgICAgIHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAndXBsb2FkcycpLFxuICAgICAgKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh1cGxvYWRzRGlyKSkge1xuICAgICAgICBmcy5ta2RpclN5bmModXBsb2Fkc0RpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgRGlyZXTDs3JpbyBkZSB1cGxvYWRzIGNyaWFkbzogJHt1cGxvYWRzRGlyfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gbyBwcm92ZWRvciBkZSBhcm1hemVuYW1lbnRvIHBhZHLDo29cbiAgICogQHJldHVybnMgUHJvdmVkb3IgZGUgYXJtYXplbmFtZW50b1xuICAgKi9cbiAgZ2V0UHJvdmlkZXIoKTogU3RvcmFnZVByb3ZpZGVyIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm92aWRlcih0aGlzLmRlZmF1bHRQcm92aWRlcik7XG4gIH1cblxuICAvKipcbiAgICogQ3JpYSB1bSBwcm92ZWRvciBkZSBhcm1hemVuYW1lbnRvIGNvbSBiYXNlIG5vIHRpcG8gZXNwZWNpZmljYWRvXG4gICAqIEBwYXJhbSB0eXBlIFRpcG8gZGUgcHJvdmVkb3IgZGUgYXJtYXplbmFtZW50byAob3BjaW9uYWwsIHVzYSBvIHBhZHLDo28gc2UgbsOjbyBlc3BlY2lmaWNhZG8pXG4gICAqIEByZXR1cm5zIFByb3ZlZG9yIGRlIGFybWF6ZW5hbWVudG9cbiAgICovXG4gIGNyZWF0ZVByb3ZpZGVyKHR5cGU/OiBUaXBvU3RvcmFnZVByb3ZpZGVyKTogU3RvcmFnZVByb3ZpZGVyIHtcbiAgICBjb25zdCBwcm92aWRlclR5cGUgPSB0eXBlIHx8IHRoaXMuZGVmYXVsdFByb3ZpZGVyO1xuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYENyaWFuZG8gcHJvdmVkb3IgZGUgYXJtYXplbmFtZW50bzogJHtwcm92aWRlclR5cGV9YCk7XG5cbiAgICBzd2l0Y2ggKHByb3ZpZGVyVHlwZSkge1xuICAgICAgY2FzZSBUaXBvU3RvcmFnZVByb3ZpZGVyLlMzOlxuICAgICAgICBpZiAoIXRoaXMuczNTdG9yYWdlQWRhcHRlcikge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAnUzMgbsOjbyBlc3TDoSBjb25maWd1cmFkby4gVXNhbmRvIGFybWF6ZW5hbWVudG8gbG9jYWwgY29tbyBmYWxsYmFjay4nLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdG9yYWdlQWRhcHRlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zM1N0b3JhZ2VBZGFwdGVyO1xuXG4gICAgICBjYXNlIFRpcG9TdG9yYWdlUHJvdmlkZXIuTUlOSU86XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU1pbmlvQWRhcHRlcigpO1xuXG4gICAgICBjYXNlIFRpcG9TdG9yYWdlUHJvdmlkZXIuTE9DQUw6XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsU3RvcmFnZUFkYXB0ZXI7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYFRpcG8gZGUgcHJvdmVkb3IgZGVzY29uaGVjaWRvOiAke3Byb3ZpZGVyVHlwZX0uIFVzYW5kbyBwcm92ZWRvciBwYWRyw6NvOiAke3RoaXMuZGVmYXVsdFByb3ZpZGVyfWAsXG4gICAgICAgICk7XG4gICAgICAgIC8vIEV2aXRhciByZWN1cnPDo28gaW5maW5pdGEgdXNhbmRvIGRpcmV0YW1lbnRlIG8gcHJvdmVkb3IgcGFkcsOjb1xuICAgICAgICBpZiAodGhpcy5kZWZhdWx0UHJvdmlkZXIgPT09IFRpcG9TdG9yYWdlUHJvdmlkZXIuUzMpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuczNTdG9yYWdlQWRhcHRlcikge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICAgICAgJ1MzIG7Do28gZXN0w6EgY29uZmlndXJhZG8uIFVzYW5kbyBhcm1hemVuYW1lbnRvIGxvY2FsIGNvbW8gZmFsbGJhY2suJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbFN0b3JhZ2VBZGFwdGVyO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdGhpcy5zM1N0b3JhZ2VBZGFwdGVyO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGVmYXVsdFByb3ZpZGVyID09PSBUaXBvU3RvcmFnZVByb3ZpZGVyLk1JTklPKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTWluaW9BZGFwdGVyKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdG9yYWdlQWRhcHRlcjtcbiAgICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtIGFkYXB0YWRvciBwYXJhIG8gTWluSU8gcXVlIGltcGxlbWVudGEgYSBpbnRlcmZhY2UgU3RvcmFnZVByb3ZpZGVyXG4gICAqIEByZXR1cm5zIEFkYXB0YWRvciBwYXJhIG8gTWluSU9cbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTWluaW9BZGFwdGVyKCk6IFN0b3JhZ2VQcm92aWRlciB7XG4gICAgLy8gQWRhcHRhciBvIE1pbmlvU2VydmljZSBwYXJhIGEgaW50ZXJmYWNlIFN0b3JhZ2VQcm92aWRlclxuICAgIHJldHVybiB7XG4gICAgICBub21lOiAnTWluSU8nLFxuXG4gICAgICBzYWx2YXJBcnF1aXZvOiBhc3luYyAoXG4gICAgICAgIGJ1ZmZlcjogQnVmZmVyLFxuICAgICAgICBub21lQXJxdWl2bzogc3RyaW5nLFxuICAgICAgICBtaW1ldHlwZTogc3RyaW5nLFxuICAgICAgICBtZXRhZGFkb3M/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgICAgKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgICAgICAgLy8gRXh0cmFpciBzb2xpY2l0YcOnw6NvIElEIGUgdGlwbyBkZSBkb2N1bWVudG8gZG9zIG1ldGFkYWRvcywgc2UgZGlzcG9uw612ZWlzXG4gICAgICAgIGNvbnN0IHNvbGljaXRhY2FvSWQgPSBtZXRhZGFkb3M/LnNvbGljaXRhY2FvSWQgfHwgJ2RlZmF1bHQnO1xuICAgICAgICBjb25zdCB0aXBvRG9jdW1lbnRvID0gbWV0YWRhZG9zPy50aXBvRG9jdW1lbnRvIHx8ICdPVVRSTyc7XG5cbiAgICAgICAgLy8gRmF6ZXIgdXBsb2FkIHVzYW5kbyBvIE1pbmlvU2VydmljZVxuICAgICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCB0aGlzLm1pbmlvU2VydmljZS51cGxvYWRBcnF1aXZvKFxuICAgICAgICAgIGJ1ZmZlcixcbiAgICAgICAgICBub21lQXJxdWl2byxcbiAgICAgICAgICBzb2xpY2l0YWNhb0lkLFxuICAgICAgICAgIHRpcG9Eb2N1bWVudG8sXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdGFkby5ub21lQXJxdWl2bztcbiAgICAgIH0sXG5cbiAgICAgIG9idGVyQXJxdWl2bzogYXN5bmMgKGNhbWluaG86IHN0cmluZyk6IFByb21pc2U8QnVmZmVyPiA9PiB7XG4gICAgICAgIC8vIEZhemVyIGRvd25sb2FkIHVzYW5kbyBvIE1pbmlvU2VydmljZVxuICAgICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCB0aGlzLm1pbmlvU2VydmljZS5kb3dubG9hZEFycXVpdm8oY2FtaW5obyk7XG4gICAgICAgIHJldHVybiByZXN1bHRhZG8uYXJxdWl2bztcbiAgICAgIH0sXG5cbiAgICAgIHJlbW92ZXJBcnF1aXZvOiBhc3luYyAoY2FtaW5obzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMubWluaW9TZXJ2aWNlLnJlbW92ZXJBcnF1aXZvKGNhbWluaG8pO1xuICAgICAgfSxcbiAgICAgIHVwbG9hZDogYXN5bmMgKFxuICAgICAgICBidWZmZXI6IEJ1ZmZlcixcbiAgICAgICAga2V5OiBzdHJpbmcsXG4gICAgICAgIG1pbWV0eXBlOiBzdHJpbmcsXG4gICAgICAgIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICAgICk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgICAgIC8vIFVzYXIgbyBtw6l0b2RvIHNhbHZhckFycXVpdm8gcGFyYSBtYW50ZXIgY29uc2lzdMOqbmNpYVxuICAgICAgICByZXR1cm4gdGhpcy5taW5pb1NlcnZpY2VcbiAgICAgICAgICAudXBsb2FkQXJxdWl2byhidWZmZXIsIGtleSwgJ2RlZmF1bHQnLCAnT1VUUk8nKVxuICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHJlc3VsdC5ub21lQXJxdWl2byk7XG4gICAgICB9LFxuXG4gICAgICBkb3dubG9hZDogYXN5bmMgKGtleTogc3RyaW5nKTogUHJvbWlzZTxCdWZmZXI+ID0+IHtcbiAgICAgICAgLy8gVXNhciBvIG3DqXRvZG8gb2J0ZXJBcnF1aXZvIHBhcmEgbWFudGVyIGNvbnNpc3TDqm5jaWFcbiAgICAgICAgcmV0dXJuIHRoaXMubWluaW9TZXJ2aWNlXG4gICAgICAgICAgLmRvd25sb2FkQXJxdWl2byhrZXkpXG4gICAgICAgICAgLnRoZW4oKHJlc3VsdCkgPT4gcmVzdWx0LmFycXVpdm8pO1xuICAgICAgfSxcblxuICAgICAgZGVsZXRlOiBhc3luYyAoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgLy8gVXNhciBvIG3DqXRvZG8gcmVtb3ZlckFycXVpdm8gcGFyYSBtYW50ZXIgY29uc2lzdMOqbmNpYVxuICAgICAgICByZXR1cm4gdGhpcy5taW5pb1NlcnZpY2UucmVtb3ZlckFycXVpdm8oa2V5KTtcbiAgICAgIH0sXG5cbiAgICAgIGdldFVybDogYXN5bmMgKGtleTogc3RyaW5nLCBleHBpcmVzSW4/OiBudW1iZXIpOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5taW5pb1NlcnZpY2UuZ2VyYXJVcmxQcmVBc3NpbmFkYShrZXksIGV4cGlyZXNJbiB8fCAzNjAwKTtcbiAgICAgIH0sXG5cbiAgICAgIGV4aXN0czogYXN5bmMgKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gVGVudGFyIGZhemVyIGRvd25sb2FkIHBhcmEgdmVyaWZpY2FyIHNlIGV4aXN0ZVxuICAgICAgICAgIGF3YWl0IHRoaXMubWluaW9TZXJ2aWNlLmRvd25sb2FkQXJxdWl2byhrZXkpO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ25vdCBmb3VuZCcpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRocm93IGVycm9yOyAvLyBQcm9wYWdhciBvdXRyb3MgZXJyb3NcbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgY29weTogYXN5bmMgKFxuICAgICAgICBzb3VyY2VLZXk6IHN0cmluZyxcbiAgICAgICAgZGVzdGluYXRpb25LZXk6IHN0cmluZyxcbiAgICAgICk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgICAgIC8vIEltcGxlbWVudGFyIGPDs3BpYSBiYWl4YW5kbyBlIGZhemVuZG8gdXBsb2FkIG5vdmFtZW50ZVxuICAgICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCB0aGlzLm1pbmlvU2VydmljZS5kb3dubG9hZEFycXVpdm8oc291cmNlS2V5KTtcblxuICAgICAgICAvLyBFeHRyYWlyIHBhcnRlcyBkYSBjaGF2ZSBkZSBkZXN0aW5vXG4gICAgICAgIGNvbnN0IHBhcnRzID0gZGVzdGluYXRpb25LZXkuc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3Qgc29saWNpdGFjYW9JZCA9IHBhcnRzWzBdIHx8ICdkZWZhdWx0JztcbiAgICAgICAgY29uc3QgdGlwb0RvY3VtZW50byA9IHBhcnRzWzFdIHx8ICdPVVRSTyc7XG4gICAgICAgIGNvbnN0IG5vbWVPcmlnaW5hbCA9IHBhcnRzLmxlbmd0aCA+IDIgPyBwYXJ0c1syXSA6IGRlc3RpbmF0aW9uS2V5O1xuXG4gICAgICAgIC8vIEZhemVyIHVwbG9hZCBjb20gYSBub3ZhIGNoYXZlXG4gICAgICAgIGNvbnN0IHJlc3VsdGFkb1VwbG9hZCA9IGF3YWl0IHRoaXMubWluaW9TZXJ2aWNlLnVwbG9hZEFycXVpdm8oXG4gICAgICAgICAgcmVzdWx0YWRvLmFycXVpdm8sXG4gICAgICAgICAgbm9tZU9yaWdpbmFsLFxuICAgICAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICAgICAgdGlwb0RvY3VtZW50byxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0YWRvVXBsb2FkLm5vbWVBcnF1aXZvO1xuICAgICAgfSxcblxuICAgICAgbGlzdDogYXN5bmMgKHByZWZpeDogc3RyaW5nLCBtYXhLZXlzPzogbnVtYmVyKTogUHJvbWlzZTxzdHJpbmdbXT4gPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIEltcGxlbWVudGHDp8OjbyBiw6FzaWNhIHVzYW5kbyBjbGllbnRlIE1pbmlvIGRpcmV0YW1lbnRlXG4gICAgICAgICAgY29uc3QgY2xpZW50ID0gKE1pbmlvU2VydmljZSBhcyBhbnkpLmNsaWVudDtcbiAgICAgICAgICBpZiAoY2xpZW50ICYmIHR5cGVvZiBjbGllbnQubGlzdE9iamVjdHMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNvbnN0IG9iamVjdHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICBjb25zdCBzdHJlYW0gPSBjbGllbnQubGlzdE9iamVjdHMoXG4gICAgICAgICAgICAgIHByb2Nlc3MuZW52Lk1JTklPX0JVQ0tFVF9OQU1FIHx8ICdkb2N1bWVudHMnLFxuICAgICAgICAgICAgICBwcmVmaXgsXG4gICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLCAob2JqOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob2JqLm5hbWUgJiYgKCFtYXhLZXlzIHx8IG9iamVjdHMubGVuZ3RoIDwgbWF4S2V5cykpIHtcbiAgICAgICAgICAgICAgICAgIG9iamVjdHMucHVzaChvYmoubmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKG9iamVjdHMpKTtcbiAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKCdDbGllbnRlIE1pbklPIG7Do28gZGlzcG9uw612ZWwgcGFyYSBsaXN0YWdlbScpO1xuICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJybyBhbyBsaXN0YXIgYXJxdWl2b3Mgbm8gTWluSU86JywgZXJyb3IpO1xuICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=