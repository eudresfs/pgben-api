425f27af608350ff1051ed4405915b52
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuditoriaMiddleware_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditoriaMiddleware = void 0;
const common_1 = require("@nestjs/common");
const auditoria_service_1 = require("../services/auditoria.service");
const auditoria_queue_service_1 = require("../services/auditoria-queue.service");
const tipo_operacao_enum_1 = require("../../../enums/tipo-operacao.enum");
/**
 * Middleware de Auditoria - VERSÃO CORRIGIDA
 *
 * Responsável por interceptar as requisições HTTP e registrar logs de auditoria
 * automaticamente, garantindo a rastreabilidade das operações realizadas no sistema.
 */
let AuditoriaMiddleware = AuditoriaMiddleware_1 = class AuditoriaMiddleware {
    auditoriaService;
    auditoriaQueueService;
    logger = new common_1.Logger(AuditoriaMiddleware_1.name);
    // Lista de endpoints que não devem ser auditados
    excludedEndpoints = [
        '/api/health',
        '/api/metrics',
        '/api-docs',
        '/api/v1/auth/login',
        '/api/v1/auditoria/monitoramento', // Evitar recursão
    ];
    // Lista de campos sensíveis
    camposSensiveis = [
        'cpf',
        'rg',
        'data_nascimento',
        'renda_familiar',
        'telefone',
        'endereco',
        'email',
        'senha',
        'numero_nis',
        'composicao_familiar',
        'vulnerabilidades',
        'documentos',
    ];
    constructor(auditoriaService, auditoriaQueueService) {
        this.auditoriaService = auditoriaService;
        this.auditoriaQueueService = auditoriaQueueService;
    }
    /**
     * Método principal do middleware - VERSÃO CORRIGIDA
     */
    use(req, res, next) {
        // ← CORREÇÃO: Remover async/await da assinatura principal
        // Verifica se deve auditar ANTES de fazer qualquer coisa
        if (!this.shouldAudit(req)) {
            return next(); // ← CORREÇÃO: Return direto sem processamento
        }
        try {
            // Captura dados da requisição
            const { method, originalUrl, body, user } = req;
            const ip = req.ip || req.connection.remoteAddress || 'desconhecido'; // ← CORREÇÃO: Garante string
            const userAgent = req.headers['user-agent'];
            const tipoOperacao = this.mapHttpMethodToOperationType(method);
            const { entidade, entidadeId } = this.extractEntityInfo(originalUrl);
            const dadosSensiveis = this.detectarDadosSensiveis(body);
            // ← CORREÇÃO: Usar uma abordagem não-intrusiva para capturar resposta
            let responseBody = undefined;
            // Intercepta res.json de forma mais segura
            const originalJson = res.json;
            res.json = function (body) {
                responseBody = body;
                return originalJson.call(this, body);
            };
            // ← CORREÇÃO: Configurar o listener ANTES de chamar next()
            res.on('finish', () => {
                // ← CORREÇÃO: Usar setImmediate para não bloquear o ciclo de evento
                setImmediate(() => {
                    this.processarAuditoriaAsync(method, originalUrl, body, responseBody, user, ip, userAgent, tipoOperacao, entidade, entidadeId, dadosSensiveis, res.statusCode).catch(error => {
                        // ← CORREÇÃO: Capturar erros sem travar a aplicação
                        this.logger.error(`Erro ao processar auditoria: ${error.message}`, error.stack);
                    });
                });
            });
            // ← CORREÇÃO: Chamar next() após configurar tudo
            next();
        }
        catch (error) {
            // ← CORREÇÃO: Em caso de erro, apenas logar e continuar
            this.logger.error(`Erro no middleware de auditoria: ${error.message}`, error.stack);
            next(); // Continuar mesmo com erro
        }
    }
    /**
     * Processa a auditoria de forma assíncrona e isolada
     */
    async processarAuditoriaAsync(method, originalUrl, body, responseBody, user, ip, userAgent, tipoOperacao, entidade, entidadeId, dadosSensiveis, statusCode) {
        try {
            // Só registra operações bem-sucedidas
            if (statusCode < 200 || statusCode >= 300) {
                return;
            }
            // ← CORREÇÃO: Criar DTO de forma simples, sem plainToInstance
            const logAuditoriaDto = {
                tipo_operacao: tipoOperacao,
                entidade_afetada: entidade,
                entidade_id: entidadeId || '',
                dados_anteriores: (method === 'PUT' || method === 'PATCH') ? body : undefined,
                dados_novos: (method === 'POST' || method === 'PUT' || method === 'PATCH') ? responseBody : undefined,
                usuario_id: user?.id,
                ip_origem: ip, // ← Agora sempre será string
                user_agent: userAgent,
                endpoint: originalUrl,
                metodo_http: method,
                descricao: `${method} em ${entidade}${entidadeId ? ` (ID: ${entidadeId})` : ''}`,
                dados_sensiveis_acessados: dadosSensiveis.length > 0 ? dadosSensiveis : undefined,
                validar: function (validationGroup) {
                    throw new Error('Function not implemented.');
                }
            };
            // ← CORREÇÃO: Usar Promise.allSettled para não travar se uma falhar
            const promises = [
                this.auditoriaQueueService.enfileirarLogAuditoria(logAuditoriaDto)
            ];
            // Se houver dados sensíveis, adiciona à fila
            if (dadosSensiveis.length > 0 && user?.id) {
                promises.push(this.auditoriaQueueService.enfileirarAcessoDadosSensiveis(user.id, entidade, entidadeId || '', dadosSensiveis, ip, // ← Agora sempre será string
                userAgent, originalUrl, method));
            }
            // Executa todas as operações em paralelo
            const results = await Promise.allSettled(promises);
            // Loga erros das operações que falharam
            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    this.logger.error(`Erro na operação de auditoria ${index}: ${result.reason.message}`, result.reason.stack);
                }
            });
        }
        catch (error) {
            this.logger.error(`Erro crítico no processamento de auditoria: ${error.message}`, error.stack);
        }
    }
    /**
     * Verifica se o endpoint deve ser auditado
     */
    shouldAudit(req) {
        const { originalUrl } = req;
        // Não audita endpoints excluídos
        for (const excluded of this.excludedEndpoints) {
            if (originalUrl.startsWith(excluded)) {
                return false;
            }
        }
        // Não audita requisições OPTIONS (CORS)
        if (req.method === 'OPTIONS') {
            return false;
        }
        return true;
    }
    /**
     * Mapeia o método HTTP para o tipo de operação de auditoria
     */
    mapHttpMethodToOperationType(method) {
        switch (method.toUpperCase()) {
            case 'POST':
                return tipo_operacao_enum_1.TipoOperacao.CREATE;
            case 'GET':
                return tipo_operacao_enum_1.TipoOperacao.READ;
            case 'PUT':
            case 'PATCH':
                return tipo_operacao_enum_1.TipoOperacao.UPDATE;
            case 'DELETE':
                return tipo_operacao_enum_1.TipoOperacao.DELETE;
            default:
                return tipo_operacao_enum_1.TipoOperacao.READ;
        }
    }
    /**
     * Extrai informações da entidade com base na URL
     */
    extractEntityInfo(url) {
        // Remove o prefixo da API
        const path = url.replace(/^\/api\/v\d+\//, '');
        // Divide o caminho em segmentos
        const segments = path.split('/').filter(Boolean);
        if (segments.length === 0) {
            return { entidade: 'Desconhecido', entidadeId: undefined };
        }
        // O primeiro segmento geralmente é o nome da entidade
        const entidade = this.normalizeEntityName(segments[0]);
        // Se houver um segundo segmento e for um UUID, é o ID da entidade
        let entidadeId = undefined;
        if (segments.length > 1) {
            const potentialId = segments[1];
            // Verifica se parece um UUID ou ID numérico
            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(potentialId) ||
                /^\d+$/.test(potentialId)) {
                entidadeId = potentialId;
            }
        }
        return { entidade, entidadeId };
    }
    /**
     * Normaliza o nome da entidade para um formato padronizado
     */
    normalizeEntityName(name) {
        // Remove plural e converte para formato PascalCase
        const singular = name.endsWith('s') ? name.slice(0, -1) : name;
        return singular.charAt(0).toUpperCase() + singular.slice(1);
    }
    /**
     * Detecta campos sensíveis no corpo da requisição
     */
    detectarDadosSensiveis(body) {
        if (!body || typeof body !== 'object') {
            return [];
        }
        const camposEncontrados = new Set();
        // Função recursiva para procurar campos sensíveis
        const procurarCamposSensiveis = (obj, caminho = '') => {
            if (!obj || typeof obj !== 'object') {
                return;
            }
            for (const [chave, valor] of Object.entries(obj)) {
                const caminhoCompleto = caminho ? `${caminho}.${chave}` : chave;
                // Verifica se o campo atual é sensível
                if (this.camposSensiveis.includes(chave) && valor) {
                    camposEncontrados.add(chave);
                }
                // Se for um objeto ou array, continua a busca recursivamente
                if (valor && typeof valor === 'object') {
                    procurarCamposSensiveis(valor, caminhoCompleto);
                }
            }
        };
        procurarCamposSensiveis(body);
        return Array.from(camposEncontrados);
    }
};
exports.AuditoriaMiddleware = AuditoriaMiddleware;
exports.AuditoriaMiddleware = AuditoriaMiddleware = AuditoriaMiddleware_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof auditoria_service_1.AuditoriaService !== "undefined" && auditoria_service_1.AuditoriaService) === "function" ? _a : Object, typeof (_b = typeof auditoria_queue_service_1.AuditoriaQueueService !== "undefined" && auditoria_queue_service_1.AuditoriaQueueService) === "function" ? _b : Object])
], AuditoriaMiddleware);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcbWlkZGxld2FyZXNcXGF1ZGl0b3JpYS5taWRkbGV3YXJlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9FO0FBRXBFLHFFQUFpRTtBQUNqRSxpRkFBNEU7QUFDNUUsMEVBQWlFO0FBR2pFOzs7OztHQUtHO0FBRUksSUFBTSxtQkFBbUIsMkJBQXpCLE1BQU0sbUJBQW1CO0lBNkJYO0lBQ0E7SUE3QkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLHFCQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRS9ELGlEQUFpRDtJQUNoQyxpQkFBaUIsR0FBRztRQUNuQyxhQUFhO1FBQ2IsY0FBYztRQUNkLFdBQVc7UUFDWCxvQkFBb0I7UUFDcEIsaUNBQWlDLEVBQUUsa0JBQWtCO0tBQ3RELENBQUM7SUFFRiw0QkFBNEI7SUFDWCxlQUFlLEdBQUc7UUFDakMsS0FBSztRQUNMLElBQUk7UUFDSixpQkFBaUI7UUFDakIsZ0JBQWdCO1FBQ2hCLFVBQVU7UUFDVixVQUFVO1FBQ1YsT0FBTztRQUNQLE9BQU87UUFDUCxZQUFZO1FBQ1oscUJBQXFCO1FBQ3JCLGtCQUFrQjtRQUNsQixZQUFZO0tBQ2IsQ0FBQztJQUVGLFlBQ21CLGdCQUFrQyxFQUNsQyxxQkFBNEM7UUFENUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO0lBQzVELENBQUM7SUFFSjs7T0FFRztJQUNILEdBQUcsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO1FBQ2pELDBEQUEwRDtRQUUxRCx5REFBeUQ7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUMzQixPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsOENBQThDO1FBQy9E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TSxlQUFlLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUVoRSx1Q0FBdUM7Z0JBQ3ZDLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxFQUFFLENBQUM7b0JBQ2xELGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDL0IsQ0FBQztnQkFFRCw2REFBNkQ7Z0JBQzdELElBQUksS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO29CQUN2Qyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7Z0JBQ2xELENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDO1FBRUYsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUIsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGLENBQUE7QUFyVFksa0RBQW1COzhCQUFuQixtQkFBbUI7SUFEL0IsSUFBQSxtQkFBVSxHQUFFO3lEQThCMEIsb0NBQWdCLG9CQUFoQixvQ0FBZ0Isb0RBQ1gsK0NBQXFCLG9CQUFyQiwrQ0FBcUI7R0E5QnBELG1CQUFtQixDQXFUL0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcbWlkZGxld2FyZXNcXGF1ZGl0b3JpYS5taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5lc3RNaWRkbGV3YXJlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBBdWRpdG9yaWFTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYXVkaXRvcmlhLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXVkaXRvcmlhUXVldWVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYXVkaXRvcmlhLXF1ZXVlLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGlwb09wZXJhY2FvIH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvdGlwby1vcGVyYWNhby5lbnVtJztcbmltcG9ydCB7IENyZWF0ZUxvZ0F1ZGl0b3JpYUR0byB9IGZyb20gJy4uL2R0by9jcmVhdGUtbG9nLWF1ZGl0b3JpYS5kdG8nO1xuXG4vKipcbiAqIE1pZGRsZXdhcmUgZGUgQXVkaXRvcmlhIC0gVkVSU8ODTyBDT1JSSUdJREFcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcG9yIGludGVyY2VwdGFyIGFzIHJlcXVpc2nDp8O1ZXMgSFRUUCBlIHJlZ2lzdHJhciBsb2dzIGRlIGF1ZGl0b3JpYVxuICogYXV0b21hdGljYW1lbnRlLCBnYXJhbnRpbmRvIGEgcmFzdHJlYWJpbGlkYWRlIGRhcyBvcGVyYcOnw7VlcyByZWFsaXphZGFzIG5vIHNpc3RlbWEuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdWRpdG9yaWFNaWRkbGV3YXJlIGltcGxlbWVudHMgTmVzdE1pZGRsZXdhcmUge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQXVkaXRvcmlhTWlkZGxld2FyZS5uYW1lKTtcblxuICAvLyBMaXN0YSBkZSBlbmRwb2ludHMgcXVlIG7Do28gZGV2ZW0gc2VyIGF1ZGl0YWRvc1xuICBwcml2YXRlIHJlYWRvbmx5IGV4Y2x1ZGVkRW5kcG9pbnRzID0gW1xuICAgICcvYXBpL2hlYWx0aCcsXG4gICAgJy9hcGkvbWV0cmljcycsXG4gICAgJy9hcGktZG9jcycsXG4gICAgJy9hcGkvdjEvYXV0aC9sb2dpbicsXG4gICAgJy9hcGkvdjEvYXVkaXRvcmlhL21vbml0b3JhbWVudG8nLCAvLyBFdml0YXIgcmVjdXJzw6NvXG4gIF07XG5cbiAgLy8gTGlzdGEgZGUgY2FtcG9zIHNlbnPDrXZlaXNcbiAgcHJpdmF0ZSByZWFkb25seSBjYW1wb3NTZW5zaXZlaXMgPSBbXG4gICAgJ2NwZicsXG4gICAgJ3JnJyxcbiAgICAnZGF0YV9uYXNjaW1lbnRvJyxcbiAgICAncmVuZGFfZmFtaWxpYXInLFxuICAgICd0ZWxlZm9uZScsXG4gICAgJ2VuZGVyZWNvJyxcbiAgICAnZW1haWwnLFxuICAgICdzZW5oYScsXG4gICAgJ251bWVyb19uaXMnLFxuICAgICdjb21wb3NpY2FvX2ZhbWlsaWFyJyxcbiAgICAndnVsbmVyYWJpbGlkYWRlcycsXG4gICAgJ2RvY3VtZW50b3MnLFxuICBdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXVkaXRvcmlhU2VydmljZTogQXVkaXRvcmlhU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1ZGl0b3JpYVF1ZXVlU2VydmljZTogQXVkaXRvcmlhUXVldWVTZXJ2aWNlLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIE3DqXRvZG8gcHJpbmNpcGFsIGRvIG1pZGRsZXdhcmUgLSBWRVJTw4NPIENPUlJJR0lEQVxuICAgKi9cbiAgdXNlKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgLy8g4oaQIENPUlJFw4fDg086IFJlbW92ZXIgYXN5bmMvYXdhaXQgZGEgYXNzaW5hdHVyYSBwcmluY2lwYWxcbiAgICBcbiAgICAvLyBWZXJpZmljYSBzZSBkZXZlIGF1ZGl0YXIgQU5URVMgZGUgZmF6ZXIgcXVhbHF1ZXIgY29pc2FcbiAgICBpZiAoIXRoaXMuc2hvdWxkQXVkaXQocmVxKSkge1xuICAgICAgcmV0dXJuIG5leHQoKTsgLy8g4oaQIENPUlJFw4fDg086IFJldHVybiBkaXJldG8gc2VtIHByb2Nlc3NhbWVudG9cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2FwdHVyYSBkYWRvcyBkYSByZXF1aXNpw6fDo29cbiAgICAgIGNvbnN0IHsgbWV0aG9kLCBvcmlnaW5hbFVybCwgYm9keSwgdXNlciB9ID0gcmVxO1xuICAgICAgY29uc3QgaXAgPSByZXEuaXAgfHwgcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyB8fCAnZGVzY29uaGVjaWRvJzsgLy8g4oaQIENPUlJFw4fDg086IEdhcmFudGUgc3RyaW5nXG4gICAgICBjb25zdCB1c2VyQWdlbnQgPSByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddIGFzIHN0cmluZztcbiAgICAgIGNvbnN0IHRpcG9PcGVyYWNhbyA9IHRoaXMubWFwSHR0cE1ldGhvZFRvT3BlcmF0aW9uVHlwZShtZXRob2QpO1xuICAgICAgY29uc3QgeyBlbnRpZGFkZSwgZW50aWRhZGVJZCB9ID0gdGhpcy5leHRyYWN0RW50aXR5SW5mbyhvcmlnaW5hbFVybCk7XG4gICAgICBjb25zdCBkYWRvc1NlbnNpdmVpcyA9IHRoaXMuZGV0ZWN0YXJEYWRvc1NlbnNpdmVpcyhib2R5KTtcblxuICAgICAgLy8g4oaQIENPUlJFw4fDg086IFVzYXIgdW1hIGFib3JkYWdlbSBuw6NvLWludHJ1c2l2YSBwYXJhIGNhcHR1cmFyIHJlc3Bvc3RhXG4gICAgICBsZXQgcmVzcG9uc2VCb2R5OiBhbnkgPSB1bmRlZmluZWQ7XG5cbiAgICAgIC8vIEludGVyY2VwdGEgcmVzLmpzb24gZGUgZm9ybWEgbWFpcyBzZWd1cmFcbiAgICAgIGNvbnN0IG9yaWdpbmFsSnNvbiA9IHJlcy5qc29uO1xuICAgICAgcmVzLmpzb24gPSBmdW5jdGlvbihib2R5KSB7XG4gICAgICAgIHJlc3BvbnNlQm9keSA9IGJvZHk7XG4gICAgICAgIHJldHVybiBvcmlnaW5hbEpzb24uY2FsbCh0aGlzLCBib2R5KTtcbiAgICAgIH07XG5cbiAgICAgIC8vIOKGkCBDT1JSRcOHw4NPOiBDb25maWd1cmFyIG8gbGlzdGVuZXIgQU5URVMgZGUgY2hhbWFyIG5leHQoKVxuICAgICAgcmVzLm9uKCdmaW5pc2gnLCAoKSA9PiB7XG4gICAgICAgIC8vIOKGkCBDT1JSRcOHw4NPOiBVc2FyIHNldEltbWVkaWF0ZSBwYXJhIG7Do28gYmxvcXVlYXIgbyBjaWNsbyBkZSBldmVudG9cbiAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NhckF1ZGl0b3JpYUFzeW5jKFxuICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgb3JpZ2luYWxVcmwsXG4gICAgICAgICAgICBib2R5LFxuICAgICAgICAgICAgcmVzcG9uc2VCb2R5LFxuICAgICAgICAgICAgdXNlcixcbiAgICAgICAgICAgIGlwLFxuICAgICAgICAgICAgdXNlckFnZW50LFxuICAgICAgICAgICAgdGlwb09wZXJhY2FvLFxuICAgICAgICAgICAgZW50aWRhZGUsXG4gICAgICAgICAgICBlbnRpZGFkZUlkLFxuICAgICAgICAgICAgZGFkb3NTZW5zaXZlaXMsXG4gICAgICAgICAgICByZXMuc3RhdHVzQ29kZVxuICAgICAgICAgICkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgLy8g4oaQIENPUlJFw4fDg086IENhcHR1cmFyIGVycm9zIHNlbSB0cmF2YXIgYSBhcGxpY2HDp8Ojb1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAgIGBFcnJvIGFvIHByb2Nlc3NhciBhdWRpdG9yaWE6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIOKGkCBDT1JSRcOHw4NPOiBDaGFtYXIgbmV4dCgpIGFww7NzIGNvbmZpZ3VyYXIgdHVkb1xuICAgICAgbmV4dCgpO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIOKGkCBDT1JSRcOHw4NPOiBFbSBjYXNvIGRlIGVycm8sIGFwZW5hcyBsb2dhciBlIGNvbnRpbnVhclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIG5vIG1pZGRsZXdhcmUgZGUgYXVkaXRvcmlhOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgbmV4dCgpOyAvLyBDb250aW51YXIgbWVzbW8gY29tIGVycm9cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUHJvY2Vzc2EgYSBhdWRpdG9yaWEgZGUgZm9ybWEgYXNzw61uY3JvbmEgZSBpc29sYWRhXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHByb2Nlc3NhckF1ZGl0b3JpYUFzeW5jKFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIG9yaWdpbmFsVXJsOiBzdHJpbmcsXG4gICAgYm9keTogYW55LFxuICAgIHJlc3BvbnNlQm9keTogYW55LFxuICAgIHVzZXI6IGFueSxcbiAgICBpcDogc3RyaW5nLFxuICAgIHVzZXJBZ2VudDogc3RyaW5nLFxuICAgIHRpcG9PcGVyYWNhbzogVGlwb09wZXJhY2FvLFxuICAgIGVudGlkYWRlOiBzdHJpbmcsXG4gICAgZW50aWRhZGVJZDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIGRhZG9zU2Vuc2l2ZWlzOiBzdHJpbmdbXSxcbiAgICBzdGF0dXNDb2RlOiBudW1iZXJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFPDsyByZWdpc3RyYSBvcGVyYcOnw7VlcyBiZW0tc3VjZWRpZGFzXG4gICAgICBpZiAoc3RhdHVzQ29kZSA8IDIwMCB8fCBzdGF0dXNDb2RlID49IDMwMCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIOKGkCBDT1JSRcOHw4NPOiBDcmlhciBEVE8gZGUgZm9ybWEgc2ltcGxlcywgc2VtIHBsYWluVG9JbnN0YW5jZVxuICAgICAgY29uc3QgbG9nQXVkaXRvcmlhRHRvOiBDcmVhdGVMb2dBdWRpdG9yaWFEdG8gPSB7XG4gICAgICAgIHRpcG9fb3BlcmFjYW86IHRpcG9PcGVyYWNhbyxcbiAgICAgICAgZW50aWRhZGVfYWZldGFkYTogZW50aWRhZGUsXG4gICAgICAgIGVudGlkYWRlX2lkOiBlbnRpZGFkZUlkIHx8ICcnLFxuICAgICAgICBkYWRvc19hbnRlcmlvcmVzOiAobWV0aG9kID09PSAnUFVUJyB8fCBtZXRob2QgPT09ICdQQVRDSCcpID8gYm9keSA6IHVuZGVmaW5lZCxcbiAgICAgICAgZGFkb3Nfbm92b3M6IChtZXRob2QgPT09ICdQT1NUJyB8fCBtZXRob2QgPT09ICdQVVQnIHx8IG1ldGhvZCA9PT0gJ1BBVENIJykgPyByZXNwb25zZUJvZHkgOiB1bmRlZmluZWQsXG4gICAgICAgIHVzdWFyaW9faWQ6IHVzZXI/LmlkLFxuICAgICAgICBpcF9vcmlnZW06IGlwLCAvLyDihpAgQWdvcmEgc2VtcHJlIHNlcsOhIHN0cmluZ1xuICAgICAgICB1c2VyX2FnZW50OiB1c2VyQWdlbnQsXG4gICAgICAgIGVuZHBvaW50OiBvcmlnaW5hbFVybCxcbiAgICAgICAgbWV0b2RvX2h0dHA6IG1ldGhvZCxcbiAgICAgICAgZGVzY3JpY2FvOiBgJHttZXRob2R9IGVtICR7ZW50aWRhZGV9JHtlbnRpZGFkZUlkID8gYCAoSUQ6ICR7ZW50aWRhZGVJZH0pYCA6ICcnfWAsXG4gICAgICAgIGRhZG9zX3NlbnNpdmVpc19hY2Vzc2Fkb3M6IGRhZG9zU2Vuc2l2ZWlzLmxlbmd0aCA+IDAgPyBkYWRvc1NlbnNpdmVpcyA6IHVuZGVmaW5lZCxcbiAgICAgICAgdmFsaWRhcjogZnVuY3Rpb24gKHZhbGlkYXRpb25Hcm91cD86IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRnVuY3Rpb24gbm90IGltcGxlbWVudGVkLicpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICAvLyDihpAgQ09SUkXDh8ODTzogVXNhciBQcm9taXNlLmFsbFNldHRsZWQgcGFyYSBuw6NvIHRyYXZhciBzZSB1bWEgZmFsaGFyXG4gICAgICBjb25zdCBwcm9taXNlcyA9IFtcbiAgICAgICAgdGhpcy5hdWRpdG9yaWFRdWV1ZVNlcnZpY2UuZW5maWxlaXJhckxvZ0F1ZGl0b3JpYShsb2dBdWRpdG9yaWFEdG8pXG4gICAgICBdO1xuXG4gICAgICAvLyBTZSBob3V2ZXIgZGFkb3Mgc2Vuc8OtdmVpcywgYWRpY2lvbmEgw6AgZmlsYVxuICAgICAgaWYgKGRhZG9zU2Vuc2l2ZWlzLmxlbmd0aCA+IDAgJiYgdXNlcj8uaWQpIHtcbiAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICB0aGlzLmF1ZGl0b3JpYVF1ZXVlU2VydmljZS5lbmZpbGVpcmFyQWNlc3NvRGFkb3NTZW5zaXZlaXMoXG4gICAgICAgICAgICB1c2VyLmlkLFxuICAgICAgICAgICAgZW50aWRhZGUsXG4gICAgICAgICAgICBlbnRpZGFkZUlkIHx8ICcnLFxuICAgICAgICAgICAgZGFkb3NTZW5zaXZlaXMsXG4gICAgICAgICAgICBpcCwgLy8g4oaQIEFnb3JhIHNlbXByZSBzZXLDoSBzdHJpbmdcbiAgICAgICAgICAgIHVzZXJBZ2VudCxcbiAgICAgICAgICAgIG9yaWdpbmFsVXJsLFxuICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gRXhlY3V0YSB0b2RhcyBhcyBvcGVyYcOnw7VlcyBlbSBwYXJhbGVsb1xuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwcm9taXNlcyk7XG4gICAgICBcbiAgICAgIC8vIExvZ2EgZXJyb3MgZGFzIG9wZXJhw6fDtWVzIHF1ZSBmYWxoYXJhbVxuICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQsIGluZGV4KSA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSAncmVqZWN0ZWQnKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBgRXJybyBuYSBvcGVyYcOnw6NvIGRlIGF1ZGl0b3JpYSAke2luZGV4fTogJHtyZXN1bHQucmVhc29uLm1lc3NhZ2V9YCxcbiAgICAgICAgICAgIHJlc3VsdC5yZWFzb24uc3RhY2ssXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGNyw610aWNvIG5vIHByb2Nlc3NhbWVudG8gZGUgYXVkaXRvcmlhOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIGVuZHBvaW50IGRldmUgc2VyIGF1ZGl0YWRvXG4gICAqL1xuICBwcml2YXRlIHNob3VsZEF1ZGl0KHJlcTogUmVxdWVzdCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgb3JpZ2luYWxVcmwgfSA9IHJlcTtcblxuICAgIC8vIE7Do28gYXVkaXRhIGVuZHBvaW50cyBleGNsdcOtZG9zXG4gICAgZm9yIChjb25zdCBleGNsdWRlZCBvZiB0aGlzLmV4Y2x1ZGVkRW5kcG9pbnRzKSB7XG4gICAgICBpZiAob3JpZ2luYWxVcmwuc3RhcnRzV2l0aChleGNsdWRlZCkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE7Do28gYXVkaXRhIHJlcXVpc2nDp8O1ZXMgT1BUSU9OUyAoQ09SUylcbiAgICBpZiAocmVxLm1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogTWFwZWlhIG8gbcOpdG9kbyBIVFRQIHBhcmEgbyB0aXBvIGRlIG9wZXJhw6fDo28gZGUgYXVkaXRvcmlhXG4gICAqL1xuICBwcml2YXRlIG1hcEh0dHBNZXRob2RUb09wZXJhdGlvblR5cGUobWV0aG9kOiBzdHJpbmcpOiBUaXBvT3BlcmFjYW8ge1xuICAgIHN3aXRjaCAobWV0aG9kLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgIGNhc2UgJ1BPU1QnOlxuICAgICAgICByZXR1cm4gVGlwb09wZXJhY2FvLkNSRUFURTtcbiAgICAgIGNhc2UgJ0dFVCc6XG4gICAgICAgIHJldHVybiBUaXBvT3BlcmFjYW8uUkVBRDtcbiAgICAgIGNhc2UgJ1BVVCc6XG4gICAgICBjYXNlICdQQVRDSCc6XG4gICAgICAgIHJldHVybiBUaXBvT3BlcmFjYW8uVVBEQVRFO1xuICAgICAgY2FzZSAnREVMRVRFJzpcbiAgICAgICAgcmV0dXJuIFRpcG9PcGVyYWNhby5ERUxFVEU7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gVGlwb09wZXJhY2FvLlJFQUQ7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhaSBpbmZvcm1hw6fDtWVzIGRhIGVudGlkYWRlIGNvbSBiYXNlIG5hIFVSTFxuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0RW50aXR5SW5mbyh1cmw6IHN0cmluZyk6IHtcbiAgICBlbnRpZGFkZTogc3RyaW5nO1xuICAgIGVudGlkYWRlSWQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfSB7XG4gICAgLy8gUmVtb3ZlIG8gcHJlZml4byBkYSBBUElcbiAgICBjb25zdCBwYXRoID0gdXJsLnJlcGxhY2UoL15cXC9hcGlcXC92XFxkK1xcLy8sICcnKTtcblxuICAgIC8vIERpdmlkZSBvIGNhbWluaG8gZW0gc2VnbWVudG9zXG4gICAgY29uc3Qgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHsgZW50aWRhZGU6ICdEZXNjb25oZWNpZG8nLCBlbnRpZGFkZUlkOiB1bmRlZmluZWQgfTtcbiAgICB9XG5cbiAgICAvLyBPIHByaW1laXJvIHNlZ21lbnRvIGdlcmFsbWVudGUgw6kgbyBub21lIGRhIGVudGlkYWRlXG4gICAgY29uc3QgZW50aWRhZGUgPSB0aGlzLm5vcm1hbGl6ZUVudGl0eU5hbWUoc2VnbWVudHNbMF0pO1xuXG4gICAgLy8gU2UgaG91dmVyIHVtIHNlZ3VuZG8gc2VnbWVudG8gZSBmb3IgdW0gVVVJRCwgw6kgbyBJRCBkYSBlbnRpZGFkZVxuICAgIGxldCBlbnRpZGFkZUlkOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIGNvbnN0IHBvdGVudGlhbElkID0gc2VnbWVudHNbMV07XG4gICAgICAvLyBWZXJpZmljYSBzZSBwYXJlY2UgdW0gVVVJRCBvdSBJRCBudW3DqXJpY29cbiAgICAgIGlmIChcbiAgICAgICAgL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXsxMn0kL2kudGVzdChcbiAgICAgICAgICBwb3RlbnRpYWxJZCxcbiAgICAgICAgKSB8fFxuICAgICAgICAvXlxcZCskLy50ZXN0KHBvdGVudGlhbElkKVxuICAgICAgKSB7XG4gICAgICAgIGVudGlkYWRlSWQgPSBwb3RlbnRpYWxJZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBlbnRpZGFkZSwgZW50aWRhZGVJZCB9O1xuICB9XG5cbiAgLyoqXG4gICAqIE5vcm1hbGl6YSBvIG5vbWUgZGEgZW50aWRhZGUgcGFyYSB1bSBmb3JtYXRvIHBhZHJvbml6YWRvXG4gICAqL1xuICBwcml2YXRlIG5vcm1hbGl6ZUVudGl0eU5hbWUobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBSZW1vdmUgcGx1cmFsIGUgY29udmVydGUgcGFyYSBmb3JtYXRvIFBhc2NhbENhc2VcbiAgICBjb25zdCBzaW5ndWxhciA9IG5hbWUuZW5kc1dpdGgoJ3MnKSA/IG5hbWUuc2xpY2UoMCwgLTEpIDogbmFtZTtcbiAgICByZXR1cm4gc2luZ3VsYXIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzaW5ndWxhci5zbGljZSgxKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3RhIGNhbXBvcyBzZW5zw612ZWlzIG5vIGNvcnBvIGRhIHJlcXVpc2nDp8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBkZXRlY3RhckRhZG9zU2Vuc2l2ZWlzKGJvZHk6IGFueSk6IHN0cmluZ1tdIHtcbiAgICBpZiAoIWJvZHkgfHwgdHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgY2FtcG9zRW5jb250cmFkb3MgPSBuZXcgU2V0PHN0cmluZz4oKTtcblxuICAgIC8vIEZ1bsOnw6NvIHJlY3Vyc2l2YSBwYXJhIHByb2N1cmFyIGNhbXBvcyBzZW5zw612ZWlzXG4gICAgY29uc3QgcHJvY3VyYXJDYW1wb3NTZW5zaXZlaXMgPSAob2JqOiBhbnksIGNhbWluaG8gPSAnJykgPT4ge1xuICAgICAgaWYgKCFvYmogfHwgdHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IFtjaGF2ZSwgdmFsb3JdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICAgICAgY29uc3QgY2FtaW5ob0NvbXBsZXRvID0gY2FtaW5obyA/IGAke2NhbWluaG99LiR7Y2hhdmV9YCA6IGNoYXZlO1xuXG4gICAgICAgIC8vIFZlcmlmaWNhIHNlIG8gY2FtcG8gYXR1YWwgw6kgc2Vuc8OtdmVsXG4gICAgICAgIGlmICh0aGlzLmNhbXBvc1NlbnNpdmVpcy5pbmNsdWRlcyhjaGF2ZSkgJiYgdmFsb3IpIHtcbiAgICAgICAgICBjYW1wb3NFbmNvbnRyYWRvcy5hZGQoY2hhdmUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2UgZm9yIHVtIG9iamV0byBvdSBhcnJheSwgY29udGludWEgYSBidXNjYSByZWN1cnNpdmFtZW50ZVxuICAgICAgICBpZiAodmFsb3IgJiYgdHlwZW9mIHZhbG9yID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgIHByb2N1cmFyQ2FtcG9zU2Vuc2l2ZWlzKHZhbG9yLCBjYW1pbmhvQ29tcGxldG8pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIHByb2N1cmFyQ2FtcG9zU2Vuc2l2ZWlzKGJvZHkpO1xuXG4gICAgcmV0dXJuIEFycmF5LmZyb20oY2FtcG9zRW5jb250cmFkb3MpO1xuICB9XG59Il0sInZlcnNpb24iOjN9