dd8eb0d62e0576c728e30f3319ac26ad
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const health_controller_1 = require("../health.controller");
const terminus_1 = require("@nestjs/terminus");
const axios_1 = require("@nestjs/axios");
const terminus_2 = require("@nestjs/terminus");
/**
 * Testes unitários para o controlador de saúde
 *
 * Verifica o funcionamento dos endpoints de verificação de saúde
 * da aplicação, incluindo verificações de banco de dados, disco e memória
 */
describe('HealthController', () => {
    let controller;
    let healthCheckService;
    let diskHealthIndicator;
    let memoryHealthIndicator;
    // Mocks para os serviços de verificação de saúde
    const mockHealthCheckService = {
        check: jest.fn(),
    };
    const mockDiskHealthIndicator = {
        checkStorage: jest.fn(),
    };
    const mockMemoryHealthIndicator = {
        checkHeap: jest.fn(),
        checkRSS: jest.fn(),
    };
    // Mock para o TypeOrmHealthIndicator
    const mockTypeOrmHealthIndicator = {
        pingCheck: jest.fn(),
    };
    beforeEach(async () => {
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            imports: [terminus_1.TerminusModule, axios_1.HttpModule],
            controllers: [health_controller_1.HealthController],
            providers: [
                {
                    provide: terminus_2.HealthCheckService,
                    useValue: mockHealthCheckService,
                },
                {
                    provide: terminus_2.DiskHealthIndicator,
                    useValue: mockDiskHealthIndicator,
                },
                {
                    provide: terminus_2.MemoryHealthIndicator,
                    useValue: mockMemoryHealthIndicator,
                },
                {
                    provide: 'TypeOrmHealthIndicator',
                    useValue: mockTypeOrmHealthIndicator,
                },
            ],
        }).compile();
        controller = module.get(health_controller_1.HealthController);
        healthCheckService = module.get(terminus_2.HealthCheckService);
        diskHealthIndicator = module.get(terminus_2.DiskHealthIndicator);
        memoryHealthIndicator = module.get(terminus_2.MemoryHealthIndicator);
    });
    it('deve ser definido', () => {
        expect(controller).toBeDefined();
    });
    describe('check', () => {
        it('deve verificar a saúde do banco de dados', async () => {
            const mockHealthCheckResult = {
                status: 'ok',
                info: {
                    database: {
                        status: 'up',
                    },
                },
            };
            mockHealthCheckService.check.mockResolvedValue(mockHealthCheckResult);
            const result = await controller.check();
            expect(result).toEqual(mockHealthCheckResult);
            expect(mockHealthCheckService.check).toHaveBeenCalled();
            expect(mockTypeOrmHealthIndicator.pingCheck).not.toHaveBeenCalled(); // Chamado dentro da função check
        });
    });
    describe('checkSystem', () => {
        it('deve verificar o espaço em disco e memória', async () => {
            const mockHealthCheckResult = {
                status: 'ok',
                info: {
                    disk: {
                        status: 'up',
                        details: {
                            free: 100000000,
                            total: 500000000,
                        },
                    },
                    memory_heap: {
                        status: 'up',
                    },
                    memory_rss: {
                        status: 'up',
                    },
                },
            };
            mockHealthCheckService.check.mockResolvedValue(mockHealthCheckResult);
            const result = await controller.checkSystem();
            expect(result).toEqual(mockHealthCheckResult);
            expect(mockHealthCheckService.check).toHaveBeenCalled();
            expect(mockDiskHealthIndicator.checkStorage).not.toHaveBeenCalled(); // Chamado dentro da função check
            expect(mockMemoryHealthIndicator.checkHeap).not.toHaveBeenCalled(); // Chamado dentro da função check
            expect(mockMemoryHealthIndicator.checkRSS).not.toHaveBeenCalled(); // Chamado dentro da função check
        });
    });
    describe('checkDatabase', () => {
        it('deve verificar a conexão com o banco de dados', async () => {
            const mockHealthCheckResult = {
                status: 'ok',
                info: {
                    database: {
                        status: 'up',
                    },
                },
            };
            mockHealthCheckService.check.mockResolvedValue(mockHealthCheckResult);
            const result = await controller.checkDatabase();
            expect(result).toEqual(mockHealthCheckResult);
            expect(mockHealthCheckService.check).toHaveBeenCalled();
            expect(mockTypeOrmHealthIndicator.pingCheck).not.toHaveBeenCalled(); // Chamado dentro da função check
        });
    });
    describe('ping', () => {
        it('deve retornar status ok e informações básicas', async () => {
            const result = controller.ping();
            expect(result).toHaveProperty('status', 'ok');
            expect(result).toHaveProperty('timestamp');
            expect(result).toHaveProperty('service', 'pgben-api');
            expect(result).toHaveProperty('version');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcdGVzdHNcXGhlYWx0aC5jb250cm9sbGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsNERBQXdEO0FBQ3hELCtDQUFrRDtBQUNsRCx5Q0FBMkM7QUFDM0MsK0NBSTBCO0FBRTFCOzs7OztHQUtHO0FBQ0gsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUNoQyxJQUFJLFVBQTRCLENBQUM7SUFDakMsSUFBSSxrQkFBc0MsQ0FBQztJQUMzQyxJQUFJLG1CQUF3QyxDQUFDO0lBQzdDLElBQUkscUJBQTRDLENBQUM7SUFFakQsaURBQWlEO0lBQ2pELE1BQU0sc0JBQXNCLEdBQUc7UUFDN0IsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDakIsQ0FBQztJQUVGLE1BQU0sdUJBQXVCLEdBQUc7UUFDOUIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDeEIsQ0FBQztJQUVGLE1BQU0seUJBQXlCLEdBQUc7UUFDaEMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDcEIsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDcEIsQ0FBQztJQUVGLHFDQUFxQztJQUNyQyxNQUFNLDBCQUEwQixHQUFHO1FBQ2pDLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ3JCLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxPQUFPLEVBQUUsQ0FBQyx5QkFBYyxFQUFFLGtCQUFVLENBQUM7WUFDckMsV0FBVyxFQUFFLENBQUMsb0NBQWdCLENBQUM7WUFDL0IsU0FBUyxFQUFFO2dC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QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM5QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ3RELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXG1vbml0b3JpbmdcXHRlc3RzXFxoZWFsdGguY29udHJvbGxlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgSGVhbHRoQ29udHJvbGxlciB9IGZyb20gJy4uL2hlYWx0aC5jb250cm9sbGVyJztcbmltcG9ydCB7IFRlcm1pbnVzTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXJtaW51cyc7XG5pbXBvcnQgeyBIdHRwTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy9heGlvcyc7XG5pbXBvcnQge1xuICBEaXNrSGVhbHRoSW5kaWNhdG9yLFxuICBNZW1vcnlIZWFsdGhJbmRpY2F0b3IsXG4gIEhlYWx0aENoZWNrU2VydmljZSxcbn0gZnJvbSAnQG5lc3Rqcy90ZXJtaW51cyc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIGNvbnRyb2xhZG9yIGRlIHNhw7pkZVxuICpcbiAqIFZlcmlmaWNhIG8gZnVuY2lvbmFtZW50byBkb3MgZW5kcG9pbnRzIGRlIHZlcmlmaWNhw6fDo28gZGUgc2HDumRlXG4gKiBkYSBhcGxpY2HDp8OjbywgaW5jbHVpbmRvIHZlcmlmaWNhw6fDtWVzIGRlIGJhbmNvIGRlIGRhZG9zLCBkaXNjbyBlIG1lbcOzcmlhXG4gKi9cbmRlc2NyaWJlKCdIZWFsdGhDb250cm9sbGVyJywgKCkgPT4ge1xuICBsZXQgY29udHJvbGxlcjogSGVhbHRoQ29udHJvbGxlcjtcbiAgbGV0IGhlYWx0aENoZWNrU2VydmljZTogSGVhbHRoQ2hlY2tTZXJ2aWNlO1xuICBsZXQgZGlza0hlYWx0aEluZGljYXRvcjogRGlza0hlYWx0aEluZGljYXRvcjtcbiAgbGV0IG1lbW9yeUhlYWx0aEluZGljYXRvcjogTWVtb3J5SGVhbHRoSW5kaWNhdG9yO1xuXG4gIC8vIE1vY2tzIHBhcmEgb3Mgc2VydmnDp29zIGRlIHZlcmlmaWNhw6fDo28gZGUgc2HDumRlXG4gIGNvbnN0IG1vY2tIZWFsdGhDaGVja1NlcnZpY2UgPSB7XG4gICAgY2hlY2s6IGplc3QuZm4oKSxcbiAgfTtcblxuICBjb25zdCBtb2NrRGlza0hlYWx0aEluZGljYXRvciA9IHtcbiAgICBjaGVja1N0b3JhZ2U6IGplc3QuZm4oKSxcbiAgfTtcblxuICBjb25zdCBtb2NrTWVtb3J5SGVhbHRoSW5kaWNhdG9yID0ge1xuICAgIGNoZWNrSGVhcDogamVzdC5mbigpLFxuICAgIGNoZWNrUlNTOiBqZXN0LmZuKCksXG4gIH07XG5cbiAgLy8gTW9jayBwYXJhIG8gVHlwZU9ybUhlYWx0aEluZGljYXRvclxuICBjb25zdCBtb2NrVHlwZU9ybUhlYWx0aEluZGljYXRvciA9IHtcbiAgICBwaW5nQ2hlY2s6IGplc3QuZm4oKSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbVGVybWludXNNb2R1bGUsIEh0dHBNb2R1bGVdLFxuICAgICAgY29udHJvbGxlcnM6IFtIZWFsdGhDb250cm9sbGVyXSxcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogSGVhbHRoQ2hlY2tTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSGVhbHRoQ2hlY2tTZXJ2aWNlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogRGlza0hlYWx0aEluZGljYXRvcixcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0Rpc2tIZWFsdGhJbmRpY2F0b3IsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBNZW1vcnlIZWFsdGhJbmRpY2F0b3IsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tNZW1vcnlIZWFsdGhJbmRpY2F0b3IsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiAnVHlwZU9ybUhlYWx0aEluZGljYXRvcicsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tUeXBlT3JtSGVhbHRoSW5kaWNhdG9yLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBjb250cm9sbGVyID0gbW9kdWxlLmdldDxIZWFsdGhDb250cm9sbGVyPihIZWFsdGhDb250cm9sbGVyKTtcbiAgICBoZWFsdGhDaGVja1NlcnZpY2UgPSBtb2R1bGUuZ2V0PEhlYWx0aENoZWNrU2VydmljZT4oSGVhbHRoQ2hlY2tTZXJ2aWNlKTtcbiAgICBkaXNrSGVhbHRoSW5kaWNhdG9yID0gbW9kdWxlLmdldDxEaXNrSGVhbHRoSW5kaWNhdG9yPihEaXNrSGVhbHRoSW5kaWNhdG9yKTtcbiAgICBtZW1vcnlIZWFsdGhJbmRpY2F0b3IgPSBtb2R1bGUuZ2V0PE1lbW9yeUhlYWx0aEluZGljYXRvcj4oXG4gICAgICBNZW1vcnlIZWFsdGhJbmRpY2F0b3IsXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgc2VyIGRlZmluaWRvJywgKCkgPT4ge1xuICAgIGV4cGVjdChjb250cm9sbGVyKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2hlY2snLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgdmVyaWZpY2FyIGEgc2HDumRlIGRvIGJhbmNvIGRlIGRhZG9zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0hlYWx0aENoZWNrUmVzdWx0ID0ge1xuICAgICAgICBzdGF0dXM6ICdvaycsXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICBkYXRhYmFzZToge1xuICAgICAgICAgICAgc3RhdHVzOiAndXAnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBtb2NrSGVhbHRoQ2hlY2tTZXJ2aWNlLmNoZWNrLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tIZWFsdGhDaGVja1Jlc3VsdCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbnRyb2xsZXIuY2hlY2soKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrSGVhbHRoQ2hlY2tSZXN1bHQpO1xuICAgICAgZXhwZWN0KG1vY2tIZWFsdGhDaGVja1NlcnZpY2UuY2hlY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrVHlwZU9ybUhlYWx0aEluZGljYXRvci5waW5nQ2hlY2spLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7IC8vIENoYW1hZG8gZGVudHJvIGRhIGZ1bsOnw6NvIGNoZWNrXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjaGVja1N5c3RlbScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgbyBlc3Bhw6dvIGVtIGRpc2NvIGUgbWVtw7NyaWEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrSGVhbHRoQ2hlY2tSZXN1bHQgPSB7XG4gICAgICAgIHN0YXR1czogJ29rJyxcbiAgICAgICAgaW5mbzoge1xuICAgICAgICAgIGRpc2s6IHtcbiAgICAgICAgICAgIHN0YXR1czogJ3VwJyxcbiAgICAgICAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgICAgICAgZnJlZTogMTAwMDAwMDAwLFxuICAgICAgICAgICAgICB0b3RhbDogNTAwMDAwMDAwLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1lbW9yeV9oZWFwOiB7XG4gICAgICAgICAgICBzdGF0dXM6ICd1cCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZW1vcnlfcnNzOiB7XG4gICAgICAgICAgICBzdGF0dXM6ICd1cCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIG1vY2tIZWFsdGhDaGVja1NlcnZpY2UuY2hlY2subW9ja1Jlc29sdmVkVmFsdWUobW9ja0hlYWx0aENoZWNrUmVzdWx0KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29udHJvbGxlci5jaGVja1N5c3RlbSgpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tIZWFsdGhDaGVja1Jlc3VsdCk7XG4gICAgICBleHBlY3QobW9ja0hlYWx0aENoZWNrU2VydmljZS5jaGVjaykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KG1vY2tEaXNrSGVhbHRoSW5kaWNhdG9yLmNoZWNrU3RvcmFnZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTsgLy8gQ2hhbWFkbyBkZW50cm8gZGEgZnVuw6fDo28gY2hlY2tcbiAgICAgIGV4cGVjdChtb2NrTWVtb3J5SGVhbHRoSW5kaWNhdG9yLmNoZWNrSGVhcCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTsgLy8gQ2hhbWFkbyBkZW50cm8gZGEgZnVuw6fDo28gY2hlY2tcbiAgICAgIGV4cGVjdChtb2NrTWVtb3J5SGVhbHRoSW5kaWNhdG9yLmNoZWNrUlNTKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpOyAvLyBDaGFtYWRvIGRlbnRybyBkYSBmdW7Dp8OjbyBjaGVja1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2hlY2tEYXRhYmFzZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgYSBjb25leMOjbyBjb20gbyBiYW5jbyBkZSBkYWRvcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tIZWFsdGhDaGVja1Jlc3VsdCA9IHtcbiAgICAgICAgc3RhdHVzOiAnb2snLFxuICAgICAgICBpbmZvOiB7XG4gICAgICAgICAgZGF0YWJhc2U6IHtcbiAgICAgICAgICAgIHN0YXR1czogJ3VwJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgbW9ja0hlYWx0aENoZWNrU2VydmljZS5jaGVjay5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrSGVhbHRoQ2hlY2tSZXN1bHQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb250cm9sbGVyLmNoZWNrRGF0YWJhc2UoKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrSGVhbHRoQ2hlY2tSZXN1bHQpO1xuICAgICAgZXhwZWN0KG1vY2tIZWFsdGhDaGVja1NlcnZpY2UuY2hlY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrVHlwZU9ybUhlYWx0aEluZGljYXRvci5waW5nQ2hlY2spLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7IC8vIENoYW1hZG8gZGVudHJvIGRhIGZ1bsOnw6NvIGNoZWNrXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdwaW5nJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIHN0YXR1cyBvayBlIGluZm9ybWHDp8O1ZXMgYsOhc2ljYXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBjb250cm9sbGVyLnBpbmcoKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3N0YXR1cycsICdvaycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3RpbWVzdGFtcCcpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3NlcnZpY2UnLCAncGdiZW4tYXBpJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgndmVyc2lvbicpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9