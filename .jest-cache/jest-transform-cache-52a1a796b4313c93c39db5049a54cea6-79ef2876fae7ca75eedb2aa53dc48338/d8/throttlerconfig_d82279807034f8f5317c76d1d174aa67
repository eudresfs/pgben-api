33d483b2f89cebb7569b62eb337b2063
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RATE_LIMIT_HEADERS = exports.getClientIp = exports.API_THROTTLE_CONFIG = exports.UPLOAD_THROTTLE_CONFIG = exports.AUTH_THROTTLE_CONFIG = exports.createThrottlerConfig = void 0;
/**
 * Configuração do Rate Limiting para o Sistema SEMTAS
 *
 * Implementa diferentes limites para diferentes tipos de endpoints:
 * - Autenticação: Mais restritivo para prevenir ataques de força bruta
 * - API Geral: Limite padrão para operações normais
 * - Upload: Limite específico para uploads de documentos
 *
 * Utiliza Redis como storage para permitir rate limiting distribuído
 */
const createThrottlerConfig = (configService) => {
    const nodeEnv = configService.get('NODE_ENV', 'development');
    // Configuração do throttler com armazenamento em memória
    const config = {
        throttlers: [
            {
                name: 'default',
                ttl: configService.get('THROTTLE_TTL', 60) * 1000, // Converter para ms
                limit: configService.get('THROTTLE_LIMIT', 100),
            },
            {
                name: 'auth',
                ttl: configService.get('THROTTLE_AUTH_TTL', 300) * 1000, // 5 minutos
                limit: configService.get('THROTTLE_AUTH_LIMIT', 5), // 5 tentativas por 5 min
            },
            {
                name: 'upload',
                ttl: configService.get('THROTTLE_UPLOAD_TTL', 60) * 1000, // 1 minuto
                limit: configService.get('THROTTLE_UPLOAD_LIMIT', 10), // 10 uploads por minuto
            },
            {
                name: 'api',
                ttl: configService.get('THROTTLE_API_TTL', 60) * 1000, // 1 minuto
                limit: configService.get('THROTTLE_API_LIMIT', 200), // 200 requests por minuto
            },
        ],
        skipIf: (context) => {
            // Pular rate limiting em desenvolvimento se configurado
            if (nodeEnv === 'development') {
                const skipInDev = configService.get('THROTTLE_SKIP_DEV', false);
                if (skipInDev) {
                    return true;
                }
            }
            // Pular para health checks
            const request = context.switchToHttp().getRequest();
            const isHealthCheck = request.url?.includes('/health') ||
                request.url?.includes('/metrics') ||
                request.url?.includes('/status');
            return isHealthCheck;
        },
        errorMessage: 'Muitas tentativas. Tente novamente em alguns minutos.',
    };
    console.log('ℹ️ Rate limiting configurado com armazenamento em memória');
    return config;
};
exports.createThrottlerConfig = createThrottlerConfig;
/**
 * Configuração de rate limiting específica para endpoints de autenticação
 */
exports.AUTH_THROTTLE_CONFIG = {
    default: {
        limit: 5,
        ttl: 300000, // 5 minutos em ms
    },
};
/**
 * Configuração de rate limiting específica para uploads
 */
exports.UPLOAD_THROTTLE_CONFIG = {
    default: {
        limit: 10,
        ttl: 60000, // 1 minuto em ms
    },
};
/**
 * Configuração de rate limiting específica para API geral
 */
exports.API_THROTTLE_CONFIG = {
    default: {
        limit: 200,
        ttl: 60000, // 1 minuto em ms
    },
};
/**
 * Utilitário para obter IP real do cliente considerando proxies
 */
const getClientIp = (request) => {
    return (request.headers['x-forwarded-for']?.split(',')[0] ||
        request.headers['x-real-ip'] ||
        request.connection?.remoteAddress ||
        request.socket?.remoteAddress ||
        request.ip ||
        'unknown');
};
exports.getClientIp = getClientIp;
/**
 * Configuração de headers de resposta para rate limiting
 */
exports.RATE_LIMIT_HEADERS = {
    LIMIT: 'X-RateLimit-Limit',
    REMAINING: 'X-RateLimit-Remaining',
    RESET: 'X-RateLimit-Reset',
    RETRY_AFTER: 'Retry-After',
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGNvbmZpZ1xcdGhyb3R0bGVyLmNvbmZpZy50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQTs7Ozs7Ozs7O0dBU0c7QUFDSSxNQUFNLHFCQUFxQixHQUFHLENBQ25DLGFBQTRCLEVBQ0osRUFBRTtJQUMxQixNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFTLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVyRSx5REFBeUQ7SUFDekQsTUFBTSxNQUFNLEdBQTJCO1FBQ3JDLFVBQVUsRUFBRTtZQUNWO2dCQUNFLElBQUksRUFBRSxTQUFTO2dCQUNmLEdBQUcsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLGNBQWMsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsb0JBQW9CO2dCQUMvRSxLQUFLLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxnQkFBZ0IsRUFBRSxHQUFHLENBQUM7YUFDeEQ7WUFDRDtnQkFDRSxJQUFJLEVBQUUsTUFBTTtnQkFDWixHQUFHLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxtQkFBbUIsRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLEVBQUUsWUFBWTtnQkFDN0UsS0FBSyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDLEVBQUUseUJBQXlCO2FBQ3RGO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsR0FBRyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMscUJBQXFCLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLFdBQVc7Z0JBQzdFLEtBQUssRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLHVCQUF1QixFQUFFLEVBQUUsQ0FBQyxFQUFFLHdCQUF3QjthQUN4RjtZQUNEO2dCQUNFLElBQUksRUFBRSxLQUFLO2dCQUNYLEdBQUcsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLGtCQUFrQixFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxXQUFXO2dCQUMxRSxLQUFLLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxvQkFBb0IsRUFBRSxHQUFHLENBQUMsRUFBRSwwQkFBMEI7YUFDeEY7U0FDRjtRQUNELE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ2xCLHdEQUF3RDtZQUN4RCxJQUFJLE9BQU8sS0FBSyxhQUFhLEVBQUUsQ0FBQztnQkFDOUIsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBVSxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDekUsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxPQUFPLElBQUksQ0FBQztnQkFDZCxDQUFDO1lBQ0gsQ0FBQztZQUVELDJCQUEyQjtZQUMzQixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDcEQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsU0FBUyxDQUFDO2dCQUNqQyxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxVQUFVLENBQUM7Z0JBQ2pDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXRELE9BQU8sYUFBYSxDQUFDO1FBQ3ZCLENBQUM7UUFDRCxZQUFZLEVBQUUsdURBQXVEO0tBQ3RFLENBQUM7SUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7SUFDekUsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBbkRXLFFBQUEscUJBQXFCLHlCQW1EaEM7QUFFRjs7R0FFRztBQUNVLFFBQUEsb0JBQW9CLEdBQUc7SUFDbEMsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLENBQUM7UUFDUixHQUFHLEVBQUUsTUFBTSxFQUFFLGtCQUFrQjtLQUNoQztDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNVLFFBQUEsc0JBQXNCLEdBQUc7SUFDcEMsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLEVBQUU7UUFDVCxHQUFHLEVBQUUsS0FBSyxFQUFFLGlCQUFpQjtLQUM5QjtDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNVLFFBQUEsbUJBQW1CLEdBQUc7SUFDakMsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLEdBQUc7UUFDVixHQUFHLEVBQUUsS0FBSyxFQUFFLGlCQUFpQjtLQUM5QjtDQUNGLENBQUM7QUFFRjs7R0FFRztBQUNJLE1BQU0sV0FBVyxHQUFHLENBQUMsT0FBWSxFQUFVLEVBQUU7SUFDbEQsT0FBTyxDQUNMLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pELE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxVQUFVLEVBQUUsYUFBYTtRQUNqQyxPQUFPLENBQUMsTUFBTSxFQUFFLGFBQWE7UUFDN0IsT0FBTyxDQUFDLEVBQUU7UUFDVixTQUFTLENBQ1YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQVRXLFFBQUEsV0FBVyxlQVN0QjtBQUVGOztHQUVHO0FBQ1UsUUFBQSxrQkFBa0IsR0FBRztJQUNoQyxLQUFLLEVBQUUsbUJBQW1CO0lBQzFCLFNBQVMsRUFBRSx1QkFBdUI7SUFDbEMsS0FBSyxFQUFFLG1CQUFtQjtJQUMxQixXQUFXLEVBQUUsYUFBYTtDQUMzQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxjb25maWdcXHRocm90dGxlci5jb25maWcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IFRocm90dGxlck1vZHVsZU9wdGlvbnMgfSBmcm9tICdAbmVzdGpzL3Rocm90dGxlcic7XG5cbi8qKlxuICogQ29uZmlndXJhw6fDo28gZG8gUmF0ZSBMaW1pdGluZyBwYXJhIG8gU2lzdGVtYSBTRU1UQVNcbiAqIFxuICogSW1wbGVtZW50YSBkaWZlcmVudGVzIGxpbWl0ZXMgcGFyYSBkaWZlcmVudGVzIHRpcG9zIGRlIGVuZHBvaW50czpcbiAqIC0gQXV0ZW50aWNhw6fDo286IE1haXMgcmVzdHJpdGl2byBwYXJhIHByZXZlbmlyIGF0YXF1ZXMgZGUgZm9yw6dhIGJydXRhXG4gKiAtIEFQSSBHZXJhbDogTGltaXRlIHBhZHLDo28gcGFyYSBvcGVyYcOnw7VlcyBub3JtYWlzXG4gKiAtIFVwbG9hZDogTGltaXRlIGVzcGVjw61maWNvIHBhcmEgdXBsb2FkcyBkZSBkb2N1bWVudG9zXG4gKiBcbiAqIFV0aWxpemEgUmVkaXMgY29tbyBzdG9yYWdlIHBhcmEgcGVybWl0aXIgcmF0ZSBsaW1pdGluZyBkaXN0cmlidcOtZG9cbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVRocm90dGxlckNvbmZpZyA9IChcbiAgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbik6IFRocm90dGxlck1vZHVsZU9wdGlvbnMgPT4ge1xuICBjb25zdCBub2RlRW52ID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignTk9ERV9FTlYnLCAnZGV2ZWxvcG1lbnQnKTtcbiAgXG4gIC8vIENvbmZpZ3VyYcOnw6NvIGRvIHRocm90dGxlciBjb20gYXJtYXplbmFtZW50byBlbSBtZW3Ds3JpYVxuICBjb25zdCBjb25maWc6IFRocm90dGxlck1vZHVsZU9wdGlvbnMgPSB7XG4gICAgdGhyb3R0bGVyczogW1xuICAgICAge1xuICAgICAgICBuYW1lOiAnZGVmYXVsdCcsXG4gICAgICAgIHR0bDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfVFRMJywgNjApICogMTAwMCwgLy8gQ29udmVydGVyIHBhcmEgbXNcbiAgICAgICAgbGltaXQ6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ1RIUk9UVExFX0xJTUlUJywgMTAwKSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdhdXRoJyxcbiAgICAgICAgdHRsOiBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdUSFJPVFRMRV9BVVRIX1RUTCcsIDMwMCkgKiAxMDAwLCAvLyA1IG1pbnV0b3NcbiAgICAgICAgbGltaXQ6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ1RIUk9UVExFX0FVVEhfTElNSVQnLCA1KSwgLy8gNSB0ZW50YXRpdmFzIHBvciA1IG1pblxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ3VwbG9hZCcsXG4gICAgICAgIHR0bDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfVVBMT0FEX1RUTCcsIDYwKSAqIDEwMDAsIC8vIDEgbWludXRvXG4gICAgICAgIGxpbWl0OiBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdUSFJPVFRMRV9VUExPQURfTElNSVQnLCAxMCksIC8vIDEwIHVwbG9hZHMgcG9yIG1pbnV0b1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ2FwaScsXG4gICAgICAgIHR0bDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfQVBJX1RUTCcsIDYwKSAqIDEwMDAsIC8vIDEgbWludXRvXG4gICAgICAgIGxpbWl0OiBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdUSFJPVFRMRV9BUElfTElNSVQnLCAyMDApLCAvLyAyMDAgcmVxdWVzdHMgcG9yIG1pbnV0b1xuICAgICAgfSxcbiAgICBdLFxuICAgIHNraXBJZjogKGNvbnRleHQpID0+IHtcbiAgICAgIC8vIFB1bGFyIHJhdGUgbGltaXRpbmcgZW0gZGVzZW52b2x2aW1lbnRvIHNlIGNvbmZpZ3VyYWRvXG4gICAgICBpZiAobm9kZUVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICBjb25zdCBza2lwSW5EZXYgPSBjb25maWdTZXJ2aWNlLmdldDxib29sZWFuPignVEhST1RUTEVfU0tJUF9ERVYnLCBmYWxzZSk7XG4gICAgICAgIGlmIChza2lwSW5EZXYpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBQdWxhciBwYXJhIGhlYWx0aCBjaGVja3NcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBjb250ZXh0LnN3aXRjaFRvSHR0cCgpLmdldFJlcXVlc3QoKTtcbiAgICAgIGNvbnN0IGlzSGVhbHRoQ2hlY2sgPSByZXF1ZXN0LnVybD8uaW5jbHVkZXMoJy9oZWFsdGgnKSB8fCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QudXJsPy5pbmNsdWRlcygnL21ldHJpY3MnKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC51cmw/LmluY2x1ZGVzKCcvc3RhdHVzJyk7XG4gICAgICBcbiAgICAgIHJldHVybiBpc0hlYWx0aENoZWNrO1xuICAgIH0sXG4gICAgZXJyb3JNZXNzYWdlOiAnTXVpdGFzIHRlbnRhdGl2YXMuIFRlbnRlIG5vdmFtZW50ZSBlbSBhbGd1bnMgbWludXRvcy4nLFxuICB9O1xuXG4gIGNvbnNvbGUubG9nKCfihLnvuI8gUmF0ZSBsaW1pdGluZyBjb25maWd1cmFkbyBjb20gYXJtYXplbmFtZW50byBlbSBtZW3Ds3JpYScpO1xuICByZXR1cm4gY29uZmlnO1xufTtcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBkZSByYXRlIGxpbWl0aW5nIGVzcGVjw61maWNhIHBhcmEgZW5kcG9pbnRzIGRlIGF1dGVudGljYcOnw6NvXG4gKi9cbmV4cG9ydCBjb25zdCBBVVRIX1RIUk9UVExFX0NPTkZJRyA9IHtcbiAgZGVmYXVsdDoge1xuICAgIGxpbWl0OiA1LFxuICAgIHR0bDogMzAwMDAwLCAvLyA1IG1pbnV0b3MgZW0gbXNcbiAgfSxcbn07XG5cbi8qKlxuICogQ29uZmlndXJhw6fDo28gZGUgcmF0ZSBsaW1pdGluZyBlc3BlY8OtZmljYSBwYXJhIHVwbG9hZHNcbiAqL1xuZXhwb3J0IGNvbnN0IFVQTE9BRF9USFJPVFRMRV9DT05GSUcgPSB7XG4gIGRlZmF1bHQ6IHtcbiAgICBsaW1pdDogMTAsXG4gICAgdHRsOiA2MDAwMCwgLy8gMSBtaW51dG8gZW0gbXNcbiAgfSxcbn07XG5cbi8qKlxuICogQ29uZmlndXJhw6fDo28gZGUgcmF0ZSBsaW1pdGluZyBlc3BlY8OtZmljYSBwYXJhIEFQSSBnZXJhbFxuICovXG5leHBvcnQgY29uc3QgQVBJX1RIUk9UVExFX0NPTkZJRyA9IHtcbiAgZGVmYXVsdDoge1xuICAgIGxpbWl0OiAyMDAsXG4gICAgdHRsOiA2MDAwMCwgLy8gMSBtaW51dG8gZW0gbXNcbiAgfSxcbn07XG5cbi8qKlxuICogVXRpbGl0w6FyaW8gcGFyYSBvYnRlciBJUCByZWFsIGRvIGNsaWVudGUgY29uc2lkZXJhbmRvIHByb3hpZXNcbiAqL1xuZXhwb3J0IGNvbnN0IGdldENsaWVudElwID0gKHJlcXVlc3Q6IGFueSk6IHN0cmluZyA9PiB7XG4gIHJldHVybiAoXG4gICAgcmVxdWVzdC5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXT8uc3BsaXQoJywnKVswXSB8fFxuICAgIHJlcXVlc3QuaGVhZGVyc1sneC1yZWFsLWlwJ10gfHxcbiAgICByZXF1ZXN0LmNvbm5lY3Rpb24/LnJlbW90ZUFkZHJlc3MgfHxcbiAgICByZXF1ZXN0LnNvY2tldD8ucmVtb3RlQWRkcmVzcyB8fFxuICAgIHJlcXVlc3QuaXAgfHxcbiAgICAndW5rbm93bidcbiAgKTtcbn07XG5cbi8qKlxuICogQ29uZmlndXJhw6fDo28gZGUgaGVhZGVycyBkZSByZXNwb3N0YSBwYXJhIHJhdGUgbGltaXRpbmdcbiAqL1xuZXhwb3J0IGNvbnN0IFJBVEVfTElNSVRfSEVBREVSUyA9IHtcbiAgTElNSVQ6ICdYLVJhdGVMaW1pdC1MaW1pdCcsXG4gIFJFTUFJTklORzogJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsXG4gIFJFU0VUOiAnWC1SYXRlTGltaXQtUmVzZXQnLFxuICBSRVRSWV9BRlRFUjogJ1JldHJ5LUFmdGVyJyxcbn07Il0sInZlcnNpb24iOjN9