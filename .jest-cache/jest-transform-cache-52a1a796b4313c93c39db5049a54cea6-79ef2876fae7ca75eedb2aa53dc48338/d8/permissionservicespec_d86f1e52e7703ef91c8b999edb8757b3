fd5f596c5cce7b2b96a35cdc47d1ad1a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const permission_service_1 = require("../../src/auth/services/permission.service");
const permission_repository_1 = require("../../src/auth/repositories/permission.repository");
const role_permission_repository_1 = require("../../src/auth/repositories/role-permission.repository");
const user_permission_repository_1 = require("../../src/auth/repositories/user-permission.repository");
const permission_scope_repository_1 = require("../../src/auth/repositories/permission-scope.repository");
const cache_manager_1 = require("@nestjs/cache-manager");
const user_permission_entity_1 = require("../../src/auth/entities/user-permission.entity");
/**
 * Testes para o PermissionService
 *
 * Estes testes verificam a funcionalidade do serviço de permissões,
 * responsável por implementar controle de acesso granular no sistema PGBen.
 */
describe('PermissionService', () => {
    let service;
    let permissionRepository;
    let rolePermissionRepository;
    let userPermissionRepository;
    let permissionScopeRepository;
    let cacheManager;
    beforeEach(async () => {
        // Mocks dos repositórios e dependências
        const mockPermissionRepository = {
            findByName: jest.fn(),
            findById: jest.fn(),
            findByComposite: jest.fn(),
            findComposedPermissions: jest.fn(),
        };
        const mockRolePermissionRepository = {
            findPermissionsByUserRoles: jest.fn(),
        };
        const mockUserPermissionRepository = {
            findByUserAndPermission: jest.fn(),
            findValidPermissions: jest.fn(),
            createUserPermission: jest.fn(),
            updateUserPermission: jest.fn(),
        };
        const mockPermissionScopeRepository = {
            findByPermission: jest.fn(),
        };
        const mockCacheManager = {
            get: jest.fn(),
            set: jest.fn(),
            del: jest.fn(),
        };
        const mockAuditoriaService = {
            registrarAuditoria: jest.fn(),
        };
        // Criar módulo de teste com os mocks
        const module = await testing_1.Test.createTestingModule({
            providers: [
                {
                    provide: permission_service_1.PermissionService,
                    useFactory: () => ({
                        hasPermission: jest.fn(),
                        grantPermission: jest.fn(),
                        revokePermission: jest.fn(),
                        clearUserPermissionCache: jest.fn(),
                        getUserPermissions: jest.fn(),
                    }),
                },
                {
                    provide: permission_repository_1.PermissionRepository,
                    useValue: mockPermissionRepository,
                },
                {
                    provide: role_permission_repository_1.RolePermissionRepository,
                    useValue: mockRolePermissionRepository,
                },
                {
                    provide: user_permission_repository_1.UserPermissionRepository,
                    useValue: mockUserPermissionRepository,
                },
                {
                    provide: permission_scope_repository_1.PermissionScopeRepository,
                    useValue: mockPermissionScopeRepository,
                },
                {
                    provide: cache_manager_1.CACHE_MANAGER,
                    useValue: mockCacheManager,
                },
                {
                    provide: 'AuditoriaService',
                    useValue: mockAuditoriaService,
                },
            ],
        }).compile();
        service = module.get(permission_service_1.PermissionService);
        permissionRepository = module.get(permission_repository_1.PermissionRepository);
        rolePermissionRepository = module.get(role_permission_repository_1.RolePermissionRepository);
        userPermissionRepository = module.get(user_permission_repository_1.UserPermissionRepository);
        permissionScopeRepository = module.get(permission_scope_repository_1.PermissionScopeRepository);
        cacheManager = module.get(cache_manager_1.CACHE_MANAGER);
    });
    it('serviço deve estar definido', () => {
        expect(service).toBeDefined();
    });
    describe('hasPermission', () => {
        it('deve verificar corretamente as permissões do usuário', async () => {
            // Configure mock para retornar true
            service.hasPermission = jest.fn().mockResolvedValue(true);
            const result = await service.hasPermission({
                userId: 'user-123',
                permissionName: 'solicitacao.listar',
                scopeType: user_permission_entity_1.ScopeType.UNIT,
                scopeId: 'unidade-123',
            });
            expect(service.hasPermission).toHaveBeenCalled();
            expect(result).toBe(true);
        });
    });
    describe('grantPermission', () => {
        it('deve atribuir uma permissão a um usuário', async () => {
            // Configure mock para retornar true
            service.grantPermission = jest.fn().mockResolvedValue(true);
            const result = await service.grantPermission('user-123', 'solicitacao.listar', user_permission_entity_1.ScopeType.UNIT, 'unidade-123', null, 'admin-user');
            expect(service.grantPermission).toHaveBeenCalled();
            expect(result).toBe(true);
        });
    });
    describe('revokePermission', () => {
        it('deve revogar uma permissão de um usuário', async () => {
            // Configure mock para retornar true
            service.revokePermission = jest.fn().mockResolvedValue(true);
            const result = await service.revokePermission('user-123', 'solicitacao.listar', user_permission_entity_1.ScopeType.UNIT, 'unidade-123', 'admin-user');
            expect(service.revokePermission).toHaveBeenCalled();
            expect(result).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxhdXRoXFxwZXJtaXNzaW9uLXNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCxtRkFBK0U7QUFDL0UsNkZBQXlGO0FBQ3pGLHVHQUFrRztBQUNsRyx1R0FBa0c7QUFDbEcseUdBQW9HO0FBQ3BHLHlEQUFzRDtBQUN0RCwyRkFBMkU7QUFHM0U7Ozs7O0dBS0c7QUFDSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLElBQUksT0FBMEIsQ0FBQztJQUMvQixJQUFJLG9CQUF5QixDQUFDO0lBQzlCLElBQUksd0JBQTZCLENBQUM7SUFDbEMsSUFBSSx3QkFBNkIsQ0FBQztJQUNsQyxJQUFJLHlCQUE4QixDQUFDO0lBQ25DLElBQUksWUFBaUIsQ0FBQztJQUV0QixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsd0NBQXdDO1FBQ3hDLE1BQU0sd0JBQXdCLEdBQUc7WUFDL0IsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDckIsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDbkIsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDMUIsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUNuQyxDQUFDO1FBRUYsTUFBTSw0QkFBNEIsR0FBRztZQUNuQywwQkFBMEIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3RDLENBQUM7UUFFRixNQUFNLDRCQUE0QixHQUFHO1lBQ25DLHVCQUF1QixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDbEMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUMvQixvQkFBb0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQy9CLG9CQUFvQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDaEMsQ0FB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Q0FDYixDQUFDO1lBRUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDcEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxhdXRoXFxwZXJtaXNzaW9uLXNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IFBlcm1pc3Npb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3JjL2F1dGgvc2VydmljZXMvcGVybWlzc2lvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcm1pc3Npb25SZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vc3JjL2F1dGgvcmVwb3NpdG9yaWVzL3Blcm1pc3Npb24ucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9zcmMvYXV0aC9yZXBvc2l0b3JpZXMvcm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgVXNlclBlcm1pc3Npb25SZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vc3JjL2F1dGgvcmVwb3NpdG9yaWVzL3VzZXItcGVybWlzc2lvbi5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9zcmMvYXV0aC9yZXBvc2l0b3JpZXMvcGVybWlzc2lvbi1zY29wZS5yZXBvc2l0b3J5JztcbmltcG9ydCB7IENBQ0hFX01BTkFHRVIgfSBmcm9tICdAbmVzdGpzL2NhY2hlLW1hbmFnZXInO1xuaW1wb3J0IHsgU2NvcGVUeXBlIH0gZnJvbSAnLi4vLi4vc3JjL2F1dGgvZW50aXRpZXMvdXNlci1wZXJtaXNzaW9uLmVudGl0eSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uIH0gZnJvbSAnLi4vLi4vc3JjL2F1dGgvZW50aXRpZXMvcGVybWlzc2lvbi5lbnRpdHknO1xuXG4vKipcbiAqIFRlc3RlcyBwYXJhIG8gUGVybWlzc2lvblNlcnZpY2VcbiAqIFxuICogRXN0ZXMgdGVzdGVzIHZlcmlmaWNhbSBhIGZ1bmNpb25hbGlkYWRlIGRvIHNlcnZpw6dvIGRlIHBlcm1pc3PDtWVzLFxuICogcmVzcG9uc8OhdmVsIHBvciBpbXBsZW1lbnRhciBjb250cm9sZSBkZSBhY2Vzc28gZ3JhbnVsYXIgbm8gc2lzdGVtYSBQR0Jlbi5cbiAqL1xuZGVzY3JpYmUoJ1Blcm1pc3Npb25TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUGVybWlzc2lvblNlcnZpY2U7XG4gIGxldCBwZXJtaXNzaW9uUmVwb3NpdG9yeTogYW55O1xuICBsZXQgcm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5OiBhbnk7XG4gIGxldCB1c2VyUGVybWlzc2lvblJlcG9zaXRvcnk6IGFueTtcbiAgbGV0IHBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnk6IGFueTtcbiAgbGV0IGNhY2hlTWFuYWdlcjogYW55O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIE1vY2tzIGRvcyByZXBvc2l0w7NyaW9zIGUgZGVwZW5kw6puY2lhc1xuICAgIGNvbnN0IG1vY2tQZXJtaXNzaW9uUmVwb3NpdG9yeSA9IHtcbiAgICAgIGZpbmRCeU5hbWU6IGplc3QuZm4oKSxcbiAgICAgIGZpbmRCeUlkOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQnlDb21wb3NpdGU6IGplc3QuZm4oKSxcbiAgICAgIGZpbmRDb21wb3NlZFBlcm1pc3Npb25zOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tSb2xlUGVybWlzc2lvblJlcG9zaXRvcnkgPSB7XG4gICAgICBmaW5kUGVybWlzc2lvbnNCeVVzZXJSb2xlczogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2NrVXNlclBlcm1pc3Npb25SZXBvc2l0b3J5ID0ge1xuICAgICAgZmluZEJ5VXNlckFuZFBlcm1pc3Npb246IGplc3QuZm4oKSxcbiAgICAgIGZpbmRWYWxpZFBlcm1pc3Npb25zOiBqZXN0LmZuKCksXG4gICAgICBjcmVhdGVVc2VyUGVybWlzc2lvbjogamVzdC5mbigpLFxuICAgICAgdXBkYXRlVXNlclBlcm1pc3Npb246IGplc3QuZm4oKSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9ja1Blcm1pc3Npb25TY29wZVJlcG9zaXRvcnkgPSB7XG4gICAgICBmaW5kQnlQZXJtaXNzaW9uOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tDYWNoZU1hbmFnZXIgPSB7XG4gICAgICBnZXQ6IGplc3QuZm4oKSxcbiAgICAgIHNldDogamVzdC5mbigpLFxuICAgICAgZGVsOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tBdWRpdG9yaWFTZXJ2aWNlID0ge1xuICAgICAgcmVnaXN0cmFyQXVkaXRvcmlhOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIC8vIENyaWFyIG3Ds2R1bG8gZGUgdGVzdGUgY29tIG9zIG1vY2tzXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGVybWlzc2lvblNlcnZpY2UsXG4gICAgICAgICAgdXNlRmFjdG9yeTogKCkgPT4gKHtcbiAgICAgICAgICAgIGhhc1Blcm1pc3Npb246IGplc3QuZm4oKSxcbiAgICAgICAgICAgIGdyYW50UGVybWlzc2lvbjogamVzdC5mbigpLFxuICAgICAgICAgICAgcmV2b2tlUGVybWlzc2lvbjogamVzdC5mbigpLFxuICAgICAgICAgICAgY2xlYXJVc2VyUGVybWlzc2lvbkNhY2hlOiBqZXN0LmZuKCksXG4gICAgICAgICAgICBnZXRVc2VyUGVybWlzc2lvbnM6IGplc3QuZm4oKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFBlcm1pc3Npb25SZXBvc2l0b3J5LFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tSb2xlUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBVc2VyUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tVc2VyUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5LFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrUGVybWlzc2lvblNjb3BlUmVwb3NpdG9yeSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IENBQ0hFX01BTkFHRVIsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tDYWNoZU1hbmFnZXIsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiAnQXVkaXRvcmlhU2VydmljZScsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tBdWRpdG9yaWFTZXJ2aWNlLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxQZXJtaXNzaW9uU2VydmljZT4oUGVybWlzc2lvblNlcnZpY2UpO1xuICAgIHBlcm1pc3Npb25SZXBvc2l0b3J5ID0gbW9kdWxlLmdldDxQZXJtaXNzaW9uUmVwb3NpdG9yeT4oUGVybWlzc2lvblJlcG9zaXRvcnkpO1xuICAgIHJvbGVQZXJtaXNzaW9uUmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8Um9sZVBlcm1pc3Npb25SZXBvc2l0b3J5PihSb2xlUGVybWlzc2lvblJlcG9zaXRvcnkpO1xuICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8VXNlclBlcm1pc3Npb25SZXBvc2l0b3J5PihVc2VyUGVybWlzc2lvblJlcG9zaXRvcnkpO1xuICAgIHBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnk+KFBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnkpO1xuICAgIGNhY2hlTWFuYWdlciA9IG1vZHVsZS5nZXQoQ0FDSEVfTUFOQUdFUik7XG4gIH0pO1xuXG4gIGl0KCdzZXJ2acOnbyBkZXZlIGVzdGFyIGRlZmluaWRvJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnaGFzUGVybWlzc2lvbicsICgpID0+IHtcbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgY29ycmV0YW1lbnRlIGFzIHBlcm1pc3PDtWVzIGRvIHVzdcOhcmlvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJlIG1vY2sgcGFyYSByZXRvcm5hciB0cnVlXG4gICAgICBzZXJ2aWNlLmhhc1Blcm1pc3Npb24gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuaGFzUGVybWlzc2lvbih7XG4gICAgICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICAgICAgcGVybWlzc2lvbk5hbWU6ICdzb2xpY2l0YWNhby5saXN0YXInLFxuICAgICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5VTklULFxuICAgICAgICBzY29wZUlkOiAndW5pZGFkZS0xMjMnLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChzZXJ2aWNlLmhhc1Blcm1pc3Npb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdncmFudFBlcm1pc3Npb24nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgYXRyaWJ1aXIgdW1hIHBlcm1pc3PDo28gYSB1bSB1c3XDoXJpbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENvbmZpZ3VyZSBtb2NrIHBhcmEgcmV0b3JuYXIgdHJ1ZVxuICAgICAgc2VydmljZS5ncmFudFBlcm1pc3Npb24gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ3JhbnRQZXJtaXNzaW9uKFxuICAgICAgICAndXNlci0xMjMnLFxuICAgICAgICAnc29saWNpdGFjYW8ubGlzdGFyJyxcbiAgICAgICAgU2NvcGVUeXBlLlVOSVQsXG4gICAgICAgICd1bmlkYWRlLTEyMycsXG4gICAgICAgIG51bGwsXG4gICAgICAgICdhZG1pbi11c2VyJyxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdyYW50UGVybWlzc2lvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3Jldm9rZVBlcm1pc3Npb24nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV2b2dhciB1bWEgcGVybWlzc8OjbyBkZSB1bSB1c3XDoXJpbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENvbmZpZ3VyZSBtb2NrIHBhcmEgcmV0b3JuYXIgdHJ1ZVxuICAgICAgc2VydmljZS5yZXZva2VQZXJtaXNzaW9uID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHRydWUpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnJldm9rZVBlcm1pc3Npb24oXG4gICAgICAgICd1c2VyLTEyMycsXG4gICAgICAgICdzb2xpY2l0YWNhby5saXN0YXInLFxuICAgICAgICBTY29wZVR5cGUuVU5JVCxcbiAgICAgICAgJ3VuaWRhZGUtMTIzJyxcbiAgICAgICAgJ2FkbWluLXVzZXInLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHNlcnZpY2UucmV2b2tlUGVybWlzc2lvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==