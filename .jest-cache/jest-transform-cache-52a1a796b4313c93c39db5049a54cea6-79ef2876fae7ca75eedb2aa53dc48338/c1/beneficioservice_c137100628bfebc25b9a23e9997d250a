1853a405363361f55896b5bee2965708
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BeneficioService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const tipo_beneficio_entity_1 = require("../../../entities/tipo-beneficio.entity");
const requisito_documento_entity_1 = require("../../../entities/requisito-documento.entity");
const fluxo_beneficio_entity_1 = require("../../../entities/fluxo-beneficio.entity");
const enums_1 = require("@/enums");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
const tipo_beneficio_schema_entity_1 = require("../../../entities/tipo-beneficio-schema.entity");
/**
 * Serviço de Benefícios
 *
 * Responsável pela lógica de negócio relacionada aos tipos de benefícios,
 * requisitos documentais e fluxos de aprovação.
 */
let BeneficioService = class BeneficioService {
    tipoBeneficioRepository;
    requisitoDocumentoRepository;
    fluxoBeneficioRepository;
    tipoBeneficioSchemaRepository;
    constructor(tipoBeneficioRepository, requisitoDocumentoRepository, fluxoBeneficioRepository, tipoBeneficioSchemaRepository) {
        this.tipoBeneficioRepository = tipoBeneficioRepository;
        this.requisitoDocumentoRepository = requisitoDocumentoRepository;
        this.fluxoBeneficioRepository = fluxoBeneficioRepository;
        this.tipoBeneficioSchemaRepository = tipoBeneficioSchemaRepository;
    }
    /**
     * Lista todos os tipos de benefícios com paginação e filtros
     * Inclui schema ativo e requisitos de documento para cada benefício
     */
    async findAll(options) {
        const { page = 1, limit = 10, search, ativo } = options;
        const queryBuilder = this.tipoBeneficioRepository.createQueryBuilder('tipo_beneficio')
            .leftJoinAndSelect('tipo_beneficio.requisito_documento', 'requisito_documento');
        // Aplicar filtros
        if (search) {
            queryBuilder.where('tipo_beneficio.nome ILIKE :search', {
                search: `%${search}%`,
            });
        }
        if (ativo !== undefined) {
            queryBuilder.andWhere('tipo_beneficio.ativo = :ativo', { ativo });
        }
        // Calcular paginação
        const skip = (page - 1) * limit;
        queryBuilder.skip(skip).take(limit);
        // Ordenação padrão
        queryBuilder.orderBy('tipo_beneficio.created_at', 'DESC');
        // Executar consulta
        const result = await queryBuilder.getManyAndCount();
        const items = result[0];
        const total = result[1];
        // Enriquecer cada item com schema ativo
        const itemsEnriquecidos = await Promise.all(items.map(async (item) => {
            // Obter schema ativo para o tipo de benefício
            const schemaAtivo = await this.tipoBeneficioSchemaRepository.findOne({
                where: { tipo_beneficio_id: item.id, ativo: true },
            });
            return {
                ...item,
                schema: schemaAtivo,
            };
        }));
        return {
            items: itemsEnriquecidos,
            meta: {
                total,
                page,
                limit,
                pages: Math.ceil(total / limit),
            },
        };
    }
    /**
     * Busca um tipo de benefício por ID com schema
     */
    async findById(id) {
        const tipoBeneficio = await this.tipoBeneficioRepository.findOne({
            where: { id },
            relations: ['requisito_documento'],
        });
        if (!tipoBeneficio) {
            throw new common_1.NotFoundException(`Tipo de benefício com ID ${id} não encontrado`);
        }
        // Obter schema ativo do benefício
        const schema = await this.tipoBeneficioSchemaRepository.findOne({
            where: { tipo_beneficio_id: id, ativo: true },
        });
        return {
            ...tipoBeneficio,
            schema: schema ? { ...schema.schema_estrutura } : null
        };
    }
    /**
     * Cria um novo tipo de benefício
     */
    async create(createTipoBeneficioDto) {
        // Verificar se já existe um benefício com o mesmo nome
        const existingBeneficio = await this.tipoBeneficioRepository.findOne({
            where: { nome: createTipoBeneficioDto.nome },
        });
        if (existingBeneficio) {
            throw new common_1.ConflictException(`Já existe um tipo de benefício com o nome '${createTipoBeneficioDto.nome}'`);
        }
        // Normalizar campos de enum antes de criar
        const normalizedData = (0, enum_normalizer_util_1.normalizeEnumFields)(createTipoBeneficioDto);
        // Gera um código se não for fornecido
        if (!normalizedData.codigo) {
            normalizedData.codigo = normalizedData.nome
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove accents
                .toUpperCase()
                .replace(/\s+/g, '_'); // Replace spaces with underscore
        }
        // Define o status como ativo por padrão
        if (!normalizedData.status) {
            normalizedData.status = enums_1.Status.ATIVO;
        }
        // Criar novo tipo de benefício
        const tipoBeneficio = this.tipoBeneficioRepository.create(normalizedData);
        return this.tipoBeneficioRepository.save(tipoBeneficio);
    }
    /**
     * Atualiza um tipo de benefício existente
     */
    async update(id, updateTipoBeneficioDto) {
        // Verificar se o benefício existe
        const tipoBeneficio = await this.findById(id);
        // Se estiver alterando o nome, verificar se já existe outro com o mesmo nome
        if (updateTipoBeneficioDto.nome &&
            updateTipoBeneficioDto.nome !== tipoBeneficio.nome) {
            const existingBeneficio = await this.tipoBeneficioRepository.findOne({
                where: { nome: updateTipoBeneficioDto.nome },
            });
            if (existingBeneficio && existingBeneficio.id !== id) {
                throw new common_1.ConflictException(`Já existe um tipo de benefício com o nome '${updateTipoBeneficioDto.nome}'`);
            }
        }
        // Normalizar campos de enum antes de atualizar
        const normalizedData = (0, enum_normalizer_util_1.normalizeEnumFields)(updateTipoBeneficioDto);
        // Atualizar e salvar
        Object.assign(tipoBeneficio, normalizedData);
        return this.tipoBeneficioRepository.save(tipoBeneficio);
    }
    /**
     * Lista requisitos documentais de um benefício
     */
    async findRequisitosByBeneficioId(beneficioId) {
        // Verificar se o benefício existe
        await this.findById(beneficioId);
        // Buscar requisitos
        return this.requisitoDocumentoRepository.find({
            where: { tipo_beneficio: { id: beneficioId } },
            order: { obrigatorio: 'DESC', tipo_documento: 'ASC' },
        });
    }
    /**
     * Adiciona requisito documental a um benefício
     */
    async addRequisito(beneficioId, createRequisitoDocumentoDto) {
        // Verificar se o benefício existe
        const tipoBeneficio = await this.findById(beneficioId);
        // Verificar se já existe um requisito com o mesmo tipo de documento para este benefício
        const existingRequisito = await this.requisitoDocumentoRepository.findOne({
            where: {
                tipo_documento: createRequisitoDocumentoDto.tipo_documento,
                tipo_beneficio: { id: beneficioId },
            },
        });
        if (existingRequisito) {
            throw new common_1.ConflictException(`Já existe um requisito com o tipo de documento '${createRequisitoDocumentoDto.tipo_documento}' para este benefício`);
        }
        // Criar e salvar o requisito
        const requisito = this.requisitoDocumentoRepository.create({
            ...createRequisitoDocumentoDto,
            tipo_beneficio: tipoBeneficio,
        });
        return this.requisitoDocumentoRepository.save(requisito);
    }
    /**
     * Configura fluxo de aprovação de um benefício
     */
    async configurarFluxo(beneficioId, configurarFluxoDto) {
        // Verificar se o benefício existe
        const tipoBeneficio = await this.findById(beneficioId);
        // Validar etapas do fluxo
        if (!configurarFluxoDto.etapas || configurarFluxoDto.etapas.length === 0) {
            throw new common_1.BadRequestException('O fluxo deve conter pelo menos uma etapa');
        }
        // Verificar se já existe um fluxo para este benefício
        const fluxos = await this.fluxoBeneficioRepository.find({
            where: { tipo_beneficio: { id: beneficioId } },
            order: { ordem: 'ASC' },
        });
        // Remover fluxos existentes
        if (fluxos && fluxos.length > 0) {
            await this.fluxoBeneficioRepository.remove(fluxos);
        }
        // Criar novas etapas do fluxo
        const novasEtapas = configurarFluxoDto.etapas.map((etapa, index) => {
            return this.fluxoBeneficioRepository.create({
                tipo_beneficio: tipoBeneficio,
                nome_etapa: etapa.nome,
                tipo_etapa: etapa.tipo_aprovador, // Converter o tipo de aprovador para tipo de etapa
                perfil_responsavel: etapa.tipo_aprovador, // Converter o tipo de aprovador para perfil responsável
                ordem: etapa.ordem || index + 1,
                descricao: etapa.descricao,
                obrigatorio: true, // Valor padrão
                permite_retorno: false, // Valor padrão
                setor_id: etapa.prazo_dias ? etapa.prazo_dias.toString() : undefined, // Usar prazo_dias como setor_id temporário
            });
        });
        // Salvar as novas etapas
        return this.fluxoBeneficioRepository.save(novasEtapas);
    }
};
exports.BeneficioService = BeneficioService;
exports.BeneficioService = BeneficioService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(tipo_beneficio_entity_1.TipoBeneficio)),
    __param(1, (0, typeorm_1.InjectRepository)(requisito_documento_entity_1.RequisitoDocumento)),
    __param(2, (0, typeorm_1.InjectRepository)(fluxo_beneficio_entity_1.FluxoBeneficio)),
    __param(3, (0, typeorm_1.InjectRepository)(tipo_beneficio_schema_entity_1.TipoBeneficioSchema)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _d : Object])
], BeneficioService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xcc2VydmljZXNcXGJlbmVmaWNpby5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FLd0I7QUFDeEIsNkNBQW1EO0FBQ25ELHFDQUFxQztBQUNyQyxtRkFBd0U7QUFDeEUsNkZBQWtGO0FBQ2xGLHFGQUEwRTtBQUkxRSxtQ0FBb0Q7QUFJcEQscUZBQWlGO0FBQ2pGLGlHQUFxRjtBQUdyRjs7Ozs7R0FLRztBQUVJLElBQU0sZ0JBQWdCLEdBQXRCLE1BQU0sZ0JBQWdCO0lBR2pCO0lBR0E7SUFHQTtJQUdBO0lBWFYsWUFFVSx1QkFBa0QsRUFHbEQsNEJBQTRELEVBRzVELHdCQUFvRCxFQUdwRCw2QkFBOEQ7UUFUOUQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUEyQjtRQUdsRCxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQWdDO1FBRzVELDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBNEI7UUFHcEQsa0NBQTZCLEdBQTdCLDZCQUE2QixDQUFpQztJQUNyRSxDQUFDO0lBRUo7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUtiO1FBQ0MsTUFBTSxFQUFFLElBQUksR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBRXhELE1BQU0sWUFBWSxHQUNoQixJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLENBQUM7YUFDOUQsaUJBQWlCLENBQUMsb0NBQW9DLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQUVwRixrQkFBa0I7UUFDbEIsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLFlBQVksQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEVBQUU7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLE1BQU0sR0FBRzth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MEJBQWdCLEVBQUMscUNBQWEsQ0FBQyxDQUFBO0lBRy9CLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQywrQ0FBa0IsQ0FBQyxDQUFBO0lBR3BDLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyx1Q0FBYyxDQUFDLENBQUE7SUFHaEMsV0FBQSxJQUFBLDBCQUFnQixFQUFDLGtEQUFtQixDQUFDLENBQUE7eURBUkwsb0JBQVUsb0JBQVYsb0JBQVUsb0RBR0wsb0JBQVUsb0JBQVYsb0JBQVUsb0RBR2Qsb0JBQVUsb0JBQVYsb0JBQVUsb0RBR0wsb0JBQVUsb0JBQVYsb0JBQVU7R0FaeEMsZ0JBQWdCLENBNFE1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcYmVuZWZpY2lvXFxzZXJ2aWNlc1xcYmVuZWZpY2lvLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IFRpcG9CZW5lZmljaW8gfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy90aXBvLWJlbmVmaWNpby5lbnRpdHknO1xuaW1wb3J0IHsgUmVxdWlzaXRvRG9jdW1lbnRvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvcmVxdWlzaXRvLWRvY3VtZW50by5lbnRpdHknO1xuaW1wb3J0IHsgRmx1eG9CZW5lZmljaW8gfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9mbHV4by1iZW5lZmljaW8uZW50aXR5JztcbmltcG9ydCB7IENyZWF0ZVRpcG9CZW5lZmljaW9EdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLXRpcG8tYmVuZWZpY2lvLmR0byc7XG5pbXBvcnQgeyBVcGRhdGVUaXBvQmVuZWZpY2lvRHRvIH0gZnJvbSAnLi4vZHRvL3VwZGF0ZS10aXBvLWJlbmVmaWNpby5kdG8nO1xuaW1wb3J0IHsgQ3JlYXRlUmVxdWlzaXRvRG9jdW1lbnRvRHRvIH0gZnJvbSAnLi4vZHRvL2NyZWF0ZS1yZXF1aXNpdG8tZG9jdW1lbnRvLmR0byc7XG5pbXBvcnQgeyBTdGF0dXMsIFRpcG9Eb2N1bWVudG9FbnVtIH0gZnJvbSAnQC9lbnVtcyc7XG5pbXBvcnQgeyBUaXBvRXRhcGEgfSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9mbHV4by1iZW5lZmljaW8uZW50aXR5JztcbmltcG9ydCB7IENvbmZpZ3VyYXJGbHV4b0R0byB9IGZyb20gJy4uL2R0by9jb25maWd1cmFyLWZsdXhvLmR0byc7XG5pbXBvcnQgeyBSb2xlIGFzIFBlcmZpbFJlc3BvbnNhdmVsIH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvcm9sZS5lbnVtJztcbmltcG9ydCB7IG5vcm1hbGl6ZUVudW1GaWVsZHMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvZW51bS1ub3JtYWxpemVyLnV0aWwnO1xuaW1wb3J0IHsgVGlwb0JlbmVmaWNpb1NjaGVtYSB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3RpcG8tYmVuZWZpY2lvLXNjaGVtYS5lbnRpdHknO1xuXG5cbi8qKlxuICogU2VydmnDp28gZGUgQmVuZWbDrWNpb3NcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcGVsYSBsw7NnaWNhIGRlIG5lZ8OzY2lvIHJlbGFjaW9uYWRhIGFvcyB0aXBvcyBkZSBiZW5lZsOtY2lvcyxcbiAqIHJlcXVpc2l0b3MgZG9jdW1lbnRhaXMgZSBmbHV4b3MgZGUgYXByb3Zhw6fDo28uXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCZW5lZmljaW9TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdFJlcG9zaXRvcnkoVGlwb0JlbmVmaWNpbylcbiAgICBwcml2YXRlIHRpcG9CZW5lZmljaW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFRpcG9CZW5lZmljaW8+LFxuXG4gICAgQEluamVjdFJlcG9zaXRvcnkoUmVxdWlzaXRvRG9jdW1lbnRvKVxuICAgIHByaXZhdGUgcmVxdWlzaXRvRG9jdW1lbnRvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxSZXF1aXNpdG9Eb2N1bWVudG8+LFxuXG4gICAgQEluamVjdFJlcG9zaXRvcnkoRmx1eG9CZW5lZmljaW8pXG4gICAgcHJpdmF0ZSBmbHV4b0JlbmVmaWNpb1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Rmx1eG9CZW5lZmljaW8+LFxuXG4gICAgQEluamVjdFJlcG9zaXRvcnkoVGlwb0JlbmVmaWNpb1NjaGVtYSlcbiAgICBwcml2YXRlIHRpcG9CZW5lZmljaW9TY2hlbWFSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFRpcG9CZW5lZmljaW9TY2hlbWE+LFxuICApIHt9XG5cbiAgLyoqXG4gICAqIExpc3RhIHRvZG9zIG9zIHRpcG9zIGRlIGJlbmVmw61jaW9zIGNvbSBwYWdpbmHDp8OjbyBlIGZpbHRyb3NcbiAgICogSW5jbHVpIHNjaGVtYSBhdGl2byBlIHJlcXVpc2l0b3MgZGUgZG9jdW1lbnRvIHBhcmEgY2FkYSBiZW5lZsOtY2lvXG4gICAqL1xuICBhc3luYyBmaW5kQWxsKG9wdGlvbnM6IHtcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICAgIHNlYXJjaD86IHN0cmluZztcbiAgICBhdGl2bz86IGJvb2xlYW47XG4gIH0pIHtcbiAgICBjb25zdCB7IHBhZ2UgPSAxLCBsaW1pdCA9IDEwLCBzZWFyY2gsIGF0aXZvIH0gPSBvcHRpb25zO1xuXG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID1cbiAgICAgIHRoaXMudGlwb0JlbmVmaWNpb1JlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKCd0aXBvX2JlbmVmaWNpbycpXG4gICAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgndGlwb19iZW5lZmljaW8ucmVxdWlzaXRvX2RvY3VtZW50bycsICdyZXF1aXNpdG9fZG9jdW1lbnRvJyk7XG5cbiAgICAvLyBBcGxpY2FyIGZpbHRyb3NcbiAgICBpZiAoc2VhcmNoKSB7XG4gICAgICBxdWVyeUJ1aWxkZXIud2hlcmUoJ3RpcG9fYmVuZWZpY2lvLm5vbWUgSUxJS0UgOnNlYXJjaCcsIHtcbiAgICAgICAgc2VhcmNoOiBgJSR7c2VhcmNofSVgLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGF0aXZvICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHF1ZXJ5QnVpbGRlci5hbmRXaGVyZSgndGlwb19iZW5lZmljaW8uYXRpdm8gPSA6YXRpdm8nLCB7IGF0aXZvIH0pO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGFyIHBhZ2luYcOnw6NvXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcbiAgICBxdWVyeUJ1aWxkZXIuc2tpcChza2lwKS50YWtlKGxpbWl0KTtcblxuICAgIC8vIE9yZGVuYcOnw6NvIHBhZHLDo29cbiAgICBxdWVyeUJ1aWxkZXIub3JkZXJCeSgndGlwb19iZW5lZmljaW8uY3JlYXRlZF9hdCcsICdERVNDJyk7XG5cbiAgICAvLyBFeGVjdXRhciBjb25zdWx0YVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHF1ZXJ5QnVpbGRlci5nZXRNYW55QW5kQ291bnQoKTtcbiAgICBjb25zdCBpdGVtcyA9IHJlc3VsdFswXTtcbiAgICBjb25zdCB0b3RhbCA9IHJlc3VsdFsxXTtcblxuICAgIC8vIEVucmlxdWVjZXIgY2FkYSBpdGVtIGNvbSBzY2hlbWEgYXRpdm9cbiAgICBjb25zdCBpdGVtc0VucmlxdWVjaWRvcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgaXRlbXMubWFwKGFzeW5jIChpdGVtKSA9PiB7XG4gICAgICAgIC8vIE9idGVyIHNjaGVtYSBhdGl2byBwYXJhIG8gdGlwbyBkZSBiZW5lZsOtY2lvXG4gICAgICAgIGNvbnN0IHNjaGVtYUF0aXZvID0gYXdhaXQgdGhpcy50aXBvQmVuZWZpY2lvU2NoZW1hUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgICAgICB3aGVyZTogeyB0aXBvX2JlbmVmaWNpb19pZDogaXRlbS5pZCwgYXRpdm86IHRydWUgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgc2NoZW1hOiBzY2hlbWFBdGl2byxcbiAgICAgICAgfTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpdGVtczogaXRlbXNFbnJpcXVlY2lkb3MsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIHRvdGFsLFxuICAgICAgICBwYWdlLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgcGFnZXM6IE1hdGguY2VpbCh0b3RhbCAvIGxpbWl0KSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSB1bSB0aXBvIGRlIGJlbmVmw61jaW8gcG9yIElEIGNvbSBzY2hlbWFcbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0aXBvQmVuZWZpY2lvID0gYXdhaXQgdGhpcy50aXBvQmVuZWZpY2lvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICByZWxhdGlvbnM6IFsncmVxdWlzaXRvX2RvY3VtZW50byddLFxuICAgIH0pO1xuXG4gICAgaWYgKCF0aXBvQmVuZWZpY2lvKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgIGBUaXBvIGRlIGJlbmVmw61jaW8gY29tIElEICR7aWR9IG7Do28gZW5jb250cmFkb2AsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE9idGVyIHNjaGVtYSBhdGl2byBkbyBiZW5lZsOtY2lvXG4gICAgY29uc3Qgc2NoZW1hID0gYXdhaXQgdGhpcy50aXBvQmVuZWZpY2lvU2NoZW1hUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IHRpcG9fYmVuZWZpY2lvX2lkOiBpZCwgYXRpdm86IHRydWUgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi50aXBvQmVuZWZpY2lvLFxuICAgICAgc2NoZW1hOiBzY2hlbWEgPyB7IC4uLnNjaGVtYS5zY2hlbWFfZXN0cnV0dXJhIH0gOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtIG5vdm8gdGlwbyBkZSBiZW5lZsOtY2lvXG4gICAqL1xuICBhc3luYyBjcmVhdGUoY3JlYXRlVGlwb0JlbmVmaWNpb0R0bzogQ3JlYXRlVGlwb0JlbmVmaWNpb0R0bykge1xuICAgIC8vIFZlcmlmaWNhciBzZSBqw6EgZXhpc3RlIHVtIGJlbmVmw61jaW8gY29tIG8gbWVzbW8gbm9tZVxuICAgIGNvbnN0IGV4aXN0aW5nQmVuZWZpY2lvID0gYXdhaXQgdGhpcy50aXBvQmVuZWZpY2lvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IG5vbWU6IGNyZWF0ZVRpcG9CZW5lZmljaW9EdG8ubm9tZSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKGV4aXN0aW5nQmVuZWZpY2lvKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgIGBKw6EgZXhpc3RlIHVtIHRpcG8gZGUgYmVuZWbDrWNpbyBjb20gbyBub21lICcke2NyZWF0ZVRpcG9CZW5lZmljaW9EdG8ubm9tZX0nYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gTm9ybWFsaXphciBjYW1wb3MgZGUgZW51bSBhbnRlcyBkZSBjcmlhclxuICAgIGNvbnN0IG5vcm1hbGl6ZWREYXRhID0gbm9ybWFsaXplRW51bUZpZWxkcyhjcmVhdGVUaXBvQmVuZWZpY2lvRHRvKTtcblxuICAgIC8vIEdlcmEgdW0gY8OzZGlnbyBzZSBuw6NvIGZvciBmb3JuZWNpZG9cbiAgICBpZiAoIW5vcm1hbGl6ZWREYXRhLmNvZGlnbykge1xuICAgICAgbm9ybWFsaXplZERhdGEuY29kaWdvID0gbm9ybWFsaXplZERhdGEubm9tZVxuICAgICAgICAubm9ybWFsaXplKCdORkQnKVxuICAgICAgICAucmVwbGFjZSgvW1xcdTAzMDAtXFx1MDM2Zl0vZywgJycpIC8vIFJlbW92ZSBhY2NlbnRzXG4gICAgICAgIC50b1VwcGVyQ2FzZSgpXG4gICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICdfJyk7IC8vIFJlcGxhY2Ugc3BhY2VzIHdpdGggdW5kZXJzY29yZVxuICAgIH1cblxuICAgIC8vIERlZmluZSBvIHN0YXR1cyBjb21vIGF0aXZvIHBvciBwYWRyw6NvXG4gICAgaWYgKCFub3JtYWxpemVkRGF0YS5zdGF0dXMpIHtcbiAgICAgIG5vcm1hbGl6ZWREYXRhLnN0YXR1cyA9IFN0YXR1cy5BVElWTztcbiAgICB9XG4gICAgXG4gICAgLy8gQ3JpYXIgbm92byB0aXBvIGRlIGJlbmVmw61jaW9cbiAgICBjb25zdCB0aXBvQmVuZWZpY2lvID0gdGhpcy50aXBvQmVuZWZpY2lvUmVwb3NpdG9yeS5jcmVhdGUoXG4gICAgICBub3JtYWxpemVkRGF0YSxcbiAgICApO1xuICAgIHJldHVybiB0aGlzLnRpcG9CZW5lZmljaW9SZXBvc2l0b3J5LnNhdmUodGlwb0JlbmVmaWNpbyk7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW0gdGlwbyBkZSBiZW5lZsOtY2lvIGV4aXN0ZW50ZVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKGlkOiBzdHJpbmcsIHVwZGF0ZVRpcG9CZW5lZmljaW9EdG86IFVwZGF0ZVRpcG9CZW5lZmljaW9EdG8pIHtcbiAgICAvLyBWZXJpZmljYXIgc2UgbyBiZW5lZsOtY2lvIGV4aXN0ZVxuICAgIGNvbnN0IHRpcG9CZW5lZmljaW8gPSBhd2FpdCB0aGlzLmZpbmRCeUlkKGlkKTtcblxuICAgIC8vIFNlIGVzdGl2ZXIgYWx0ZXJhbmRvIG8gbm9tZSwgdmVyaWZpY2FyIHNlIGrDoSBleGlzdGUgb3V0cm8gY29tIG8gbWVzbW8gbm9tZVxuICAgIGlmIChcbiAgICAgIHVwZGF0ZVRpcG9CZW5lZmljaW9EdG8ubm9tZSAmJlxuICAgICAgdXBkYXRlVGlwb0JlbmVmaWNpb0R0by5ub21lICE9PSB0aXBvQmVuZWZpY2lvLm5vbWVcbiAgICApIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nQmVuZWZpY2lvID0gYXdhaXQgdGhpcy50aXBvQmVuZWZpY2lvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgICAgd2hlcmU6IHsgbm9tZTogdXBkYXRlVGlwb0JlbmVmaWNpb0R0by5ub21lIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGV4aXN0aW5nQmVuZWZpY2lvICYmIGV4aXN0aW5nQmVuZWZpY2lvLmlkICE9PSBpZCkge1xuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgYErDoSBleGlzdGUgdW0gdGlwbyBkZSBiZW5lZsOtY2lvIGNvbSBvIG5vbWUgJyR7dXBkYXRlVGlwb0JlbmVmaWNpb0R0by5ub21lfSdgLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vcm1hbGl6YXIgY2FtcG9zIGRlIGVudW0gYW50ZXMgZGUgYXR1YWxpemFyXG4gICAgY29uc3Qgbm9ybWFsaXplZERhdGEgPSBub3JtYWxpemVFbnVtRmllbGRzKHVwZGF0ZVRpcG9CZW5lZmljaW9EdG8pO1xuICAgIFxuICAgIC8vIEF0dWFsaXphciBlIHNhbHZhclxuICAgIE9iamVjdC5hc3NpZ24odGlwb0JlbmVmaWNpbywgbm9ybWFsaXplZERhdGEpO1xuICAgIHJldHVybiB0aGlzLnRpcG9CZW5lZmljaW9SZXBvc2l0b3J5LnNhdmUodGlwb0JlbmVmaWNpbyk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdGEgcmVxdWlzaXRvcyBkb2N1bWVudGFpcyBkZSB1bSBiZW5lZsOtY2lvXG4gICAqL1xuICBhc3luYyBmaW5kUmVxdWlzaXRvc0J5QmVuZWZpY2lvSWQoYmVuZWZpY2lvSWQ6IHN0cmluZykge1xuICAgIC8vIFZlcmlmaWNhciBzZSBvIGJlbmVmw61jaW8gZXhpc3RlXG4gICAgYXdhaXQgdGhpcy5maW5kQnlJZChiZW5lZmljaW9JZCk7XG5cbiAgICAvLyBCdXNjYXIgcmVxdWlzaXRvc1xuICAgIHJldHVybiB0aGlzLnJlcXVpc2l0b0RvY3VtZW50b1JlcG9zaXRvcnkuZmluZCh7XG4gICAgICB3aGVyZTogeyB0aXBvX2JlbmVmaWNpbzogeyBpZDogYmVuZWZpY2lvSWQgfSB9LFxuICAgICAgb3JkZXI6IHsgb2JyaWdhdG9yaW86ICdERVNDJywgdGlwb19kb2N1bWVudG86ICdBU0MnIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRpY2lvbmEgcmVxdWlzaXRvIGRvY3VtZW50YWwgYSB1bSBiZW5lZsOtY2lvXG4gICAqL1xuICBhc3luYyBhZGRSZXF1aXNpdG8oXG4gICAgYmVuZWZpY2lvSWQ6IHN0cmluZyxcbiAgICBjcmVhdGVSZXF1aXNpdG9Eb2N1bWVudG9EdG86IENyZWF0ZVJlcXVpc2l0b0RvY3VtZW50b0R0byxcbiAgKSB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gYmVuZWbDrWNpbyBleGlzdGVcbiAgICBjb25zdCB0aXBvQmVuZWZpY2lvID0gYXdhaXQgdGhpcy5maW5kQnlJZChiZW5lZmljaW9JZCk7XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgasOhIGV4aXN0ZSB1bSByZXF1aXNpdG8gY29tIG8gbWVzbW8gdGlwbyBkZSBkb2N1bWVudG8gcGFyYSBlc3RlIGJlbmVmw61jaW9cbiAgICBjb25zdCBleGlzdGluZ1JlcXVpc2l0byA9IGF3YWl0IHRoaXMucmVxdWlzaXRvRG9jdW1lbnRvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHRpcG9fZG9jdW1lbnRvOiBjcmVhdGVSZXF1aXNpdG9Eb2N1bWVudG9EdG8udGlwb19kb2N1bWVudG8sXG4gICAgICAgIHRpcG9fYmVuZWZpY2lvOiB7IGlkOiBiZW5lZmljaW9JZCB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChleGlzdGluZ1JlcXVpc2l0bykge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICBgSsOhIGV4aXN0ZSB1bSByZXF1aXNpdG8gY29tIG8gdGlwbyBkZSBkb2N1bWVudG8gJyR7Y3JlYXRlUmVxdWlzaXRvRG9jdW1lbnRvRHRvLnRpcG9fZG9jdW1lbnRvfScgcGFyYSBlc3RlIGJlbmVmw61jaW9gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDcmlhciBlIHNhbHZhciBvIHJlcXVpc2l0b1xuICAgIGNvbnN0IHJlcXVpc2l0byA9IHRoaXMucmVxdWlzaXRvRG9jdW1lbnRvUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgLi4uY3JlYXRlUmVxdWlzaXRvRG9jdW1lbnRvRHRvLFxuICAgICAgdGlwb19iZW5lZmljaW86IHRpcG9CZW5lZmljaW8sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1aXNpdG9Eb2N1bWVudG9SZXBvc2l0b3J5LnNhdmUocmVxdWlzaXRvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25maWd1cmEgZmx1eG8gZGUgYXByb3Zhw6fDo28gZGUgdW0gYmVuZWbDrWNpb1xuICAgKi9cbiAgYXN5bmMgY29uZmlndXJhckZsdXhvKFxuICAgIGJlbmVmaWNpb0lkOiBzdHJpbmcsXG4gICAgY29uZmlndXJhckZsdXhvRHRvOiBDb25maWd1cmFyRmx1eG9EdG8sXG4gICkge1xuICAgIC8vIFZlcmlmaWNhciBzZSBvIGJlbmVmw61jaW8gZXhpc3RlXG4gICAgY29uc3QgdGlwb0JlbmVmaWNpbyA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoYmVuZWZpY2lvSWQpO1xuXG4gICAgLy8gVmFsaWRhciBldGFwYXMgZG8gZmx1eG9cbiAgICBpZiAoIWNvbmZpZ3VyYXJGbHV4b0R0by5ldGFwYXMgfHwgY29uZmlndXJhckZsdXhvRHRvLmV0YXBhcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdPIGZsdXhvIGRldmUgY29udGVyIHBlbG8gbWVub3MgdW1hIGV0YXBhJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIGrDoSBleGlzdGUgdW0gZmx1eG8gcGFyYSBlc3RlIGJlbmVmw61jaW9cbiAgICBjb25zdCBmbHV4b3MgPSBhd2FpdCB0aGlzLmZsdXhvQmVuZWZpY2lvUmVwb3NpdG9yeS5maW5kKHtcbiAgICAgIHdoZXJlOiB7IHRpcG9fYmVuZWZpY2lvOiB7IGlkOiBiZW5lZmljaW9JZCB9IH0sXG4gICAgICBvcmRlcjogeyBvcmRlbTogJ0FTQycgfSxcbiAgICB9KTtcblxuICAgIC8vIFJlbW92ZXIgZmx1eG9zIGV4aXN0ZW50ZXNcbiAgICBpZiAoZmx1eG9zICYmIGZsdXhvcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmZsdXhvQmVuZWZpY2lvUmVwb3NpdG9yeS5yZW1vdmUoZmx1eG9zKTtcbiAgICB9XG5cbiAgICAvLyBDcmlhciBub3ZhcyBldGFwYXMgZG8gZmx1eG9cbiAgICBjb25zdCBub3Zhc0V0YXBhcyA9IGNvbmZpZ3VyYXJGbHV4b0R0by5ldGFwYXMubWFwKChldGFwYSwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmZsdXhvQmVuZWZpY2lvUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICB0aXBvX2JlbmVmaWNpbzogdGlwb0JlbmVmaWNpbyxcbiAgICAgICAgbm9tZV9ldGFwYTogZXRhcGEubm9tZSxcbiAgICAgICAgdGlwb19ldGFwYTogZXRhcGEudGlwb19hcHJvdmFkb3IgYXMgdW5rbm93biBhcyBUaXBvRXRhcGEsIC8vIENvbnZlcnRlciBvIHRpcG8gZGUgYXByb3ZhZG9yIHBhcmEgdGlwbyBkZSBldGFwYVxuICAgICAgICBwZXJmaWxfcmVzcG9uc2F2ZWw6XG4gICAgICAgICAgZXRhcGEudGlwb19hcHJvdmFkb3IgYXMgdW5rbm93biBhcyBQZXJmaWxSZXNwb25zYXZlbCwgLy8gQ29udmVydGVyIG8gdGlwbyBkZSBhcHJvdmFkb3IgcGFyYSBwZXJmaWwgcmVzcG9uc8OhdmVsXG4gICAgICAgIG9yZGVtOiBldGFwYS5vcmRlbSB8fCBpbmRleCArIDEsXG4gICAgICAgIGRlc2NyaWNhbzogZXRhcGEuZGVzY3JpY2FvLFxuICAgICAgICBvYnJpZ2F0b3JpbzogdHJ1ZSwgLy8gVmFsb3IgcGFkcsOjb1xuICAgICAgICBwZXJtaXRlX3JldG9ybm86IGZhbHNlLCAvLyBWYWxvciBwYWRyw6NvXG4gICAgICAgIHNldG9yX2lkOiBldGFwYS5wcmF6b19kaWFzID8gZXRhcGEucHJhem9fZGlhcy50b1N0cmluZygpIDogdW5kZWZpbmVkLCAvLyBVc2FyIHByYXpvX2RpYXMgY29tbyBzZXRvcl9pZCB0ZW1wb3LDoXJpb1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBTYWx2YXIgYXMgbm92YXMgZXRhcGFzXG4gICAgcmV0dXJuIHRoaXMuZmx1eG9CZW5lZmljaW9SZXBvc2l0b3J5LnNhdmUobm92YXNFdGFwYXMpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=