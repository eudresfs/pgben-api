3fe9b77016d0438da8e991b2c4f09fdf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var CidadaoAuditInterceptor_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CidadaoAuditInterceptor = void 0;
const common_1 = require("@nestjs/common");
const operators_1 = require("rxjs/operators");
const auditoria_queue_service_1 = require("../../auditoria/services/auditoria-queue.service");
const tipo_operacao_enum_1 = require("../../../enums/tipo-operacao.enum");
const create_log_auditoria_dto_1 = require("../../auditoria/dto/create-log-auditoria.dto");
/**
 * Interceptor para auditoria de acesso a dados sensíveis de cidadãos
 *
 * Registra todas as operações de acesso a dados sensíveis para compliance com LGPD
 *
 * NOTA DE PERFORMANCE: Este interceptor foi identificado como possível causa de lentidão
 * em endpoints críticos. Versão otimizada para diagnóstico e performance.
 */
let CidadaoAuditInterceptor = CidadaoAuditInterceptor_1 = class CidadaoAuditInterceptor {
    auditoriaQueueService;
    logger = new common_1.Logger(CidadaoAuditInterceptor_1.name);
    constructor(auditoriaQueueService) {
        this.auditoriaQueueService = auditoriaQueueService;
    }
    /**
     * Intercepta requisições para auditoria LGPD, usando padrão totalmente não-bloqueante
     *
     * OTIMIZAÇÃO DE PERFORMANCE:
     * - Processo executado em segundo plano com setTimeout
     * - Não bloqueia ou atrasa a resposta para o usuário
     * - Logging mínimo para evitar sobrecarga do log
     *
     * @param context Contexto da execução
     * @param next Handler para a próxima etapa
     * @returns Observable da resposta processada
     */
    intercept(context, next) {
        // Capturar dados básicos da requisição
        const request = context.switchToHttp().getRequest();
        const { method, url } = request;
        // Verificação preliminar rápida para determinar se a operação precisa ser auditada
        // Esta etapa é mantida síncrona por ser muito rápida (microssegundos)
        const needsAudit = this.isSensitiveOperation(method, url);
        // Se não precisar de auditoria, simplesmente prosseguir
        if (!needsAudit) {
            return next.handle();
        }
        // Capturar timestamp inicial para medição de tempo
        const startTime = Date.now();
        const requestId = `${method}-${url.substring(0, 30)}-${startTime}`;
        // Processar a requisição normalmente e fazer a auditoria em segundo plano
        return next.handle().pipe((0, operators_1.tap)({
            next: (data) => {
                // Executar auditoria em segundo plano (não-bloqueante)
                setTimeout(() => {
                    try {
                        const duration = Date.now() - startTime;
                        const { params, query, body, user } = request;
                        const userId = user?.id || 'anônimo';
                        const userRole = user?.role_id || 'não autenticado';
                        // Log mínimo para diagnóstico
                        if (duration > 500) {
                            this.logger.log(`AUDIT-SUCCESS [${requestId}] Duração: ${duration}ms, Usuário: ${userId}`);
                        }
                        // Registrar em sistema de auditoria
                        this.registerAuditEvent({
                            userId,
                            userRole,
                            method,
                            url,
                            params,
                            query,
                            body: this.sanitizeBody(body),
                            timestamp: new Date(),
                            duration,
                            status: 'success',
                            requestId,
                        });
                    }
                    catch (auditError) {
                        // Erro na auditoria não deve afetar o fluxo principal
                        this.logger.warn(`Erro na auditoria [${requestId}]: ${auditError.message}`);
                    }
                }, 10); // Pequeno delay para garantir que não bloqueie
            },
            error: (error) => {
                // Auditoria de erro em segundo plano (não-bloqueante)
                setTimeout(() => {
                    try {
                        const duration = Date.now() - startTime;
                        const { params, query, body, user } = request;
                        const userId = user?.id || 'anônimo';
                        const userRole = user?.role_id || 'não autenticado';
                        // Log mínimo para erros importantes
                        this.logger.warn(`AUDIT-ERROR [${requestId}] Duração: ${duration}ms, Erro: ${error.message.substring(0, 50)}`);
                        // Registrar erro em sistema de auditoria
                        this.registerAuditEvent({
                            userId,
                            userRole,
                            method,
                            url,
                            params,
                            query,
                            body: this.sanitizeBody(body),
                            timestamp: new Date(),
                            duration,
                            status: 'error',
                            errorMessage: error.message,
                            requestId,
                        });
                    }
                    catch (auditError) {
                        // Erro na auditoria não deve afetar o fluxo principal
                        this.logger.warn(`Erro na auditoria de erro [${requestId}]: ${auditError.message}`);
                    }
                }, 10); // Pequeno delay para garantir que não bloqueie
            },
        }));
    }
    /**
     * Verifica se a operação é sensível do ponto de vista da LGPD
     */
    isSensitiveOperation(method, url) {
        // Operações de leitura de dados pessoais
        if (url.includes('/v1/cidadao/') &&
            (method === 'GET' || method === 'POST')) {
            return true;
        }
        // Operações de modificação de dados pessoais
        if (url.includes('/v1/cidadao') &&
            (method === 'PUT' || method === 'DELETE')) {
            return true;
        }
        // Busca por CPF ou NIS (dados sensíveis)
        if (url.includes('/v1/cidadao/cpf/') || url.includes('/v1/cidadao/nis/')) {
            return true;
        }
        return false;
    }
    /**
     * Extrai o ID da entidade da URL
     */
    extractEntityId(url) {
        // Padrão para extrair UUID da URL
        const uuidPattern = /\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i;
        const match = url.match(uuidPattern);
        if (match && match[1]) {
            return match[1];
        }
        // Se não encontrou UUID, tenta extrair CPF ou NIS
        if (url.includes('/cpf/')) {
            const cpfMatch = url.match(/\/cpf\/([^/]+)/);
            return cpfMatch ? cpfMatch[1] : 'desconhecido';
        }
        if (url.includes('/nis/')) {
            const nisMatch = url.match(/\/nis\/([^/]+)/);
            return nisMatch ? nisMatch[1] : 'desconhecido';
        }
        return 'desconhecido';
    }
    /**
     * Verifica se o corpo da requisição contém dados sensíveis
     */
    containsSensitiveData(body) {
        if (!body) {
            return false;
        }
        const sensitiveFields = [
            'cpf',
            'nis',
            'rg',
            'data_nascimento',
            'renda',
            'composicao_familiar',
        ];
        return sensitiveFields.some((field) => field in body);
    }
    /**
     * Extrai os campos sensíveis do corpo da requisição
     */
    extractSensitiveFields(body) {
        if (!body) {
            return [];
        }
        const sensitiveFields = [
            'cpf',
            'nis',
            'rg',
            'data_nascimento',
            'renda',
            'composicao_familiar',
            'telefone',
            'email',
            'endereco',
        ];
        return sensitiveFields.filter((field) => field in body);
    }
    /**
     * Remove dados sensíveis do corpo da requisição para o log de auditoria
     */
    sanitizeBody(body) {
        if (!body) {
            return null;
        }
        const sanitized = { ...body };
        // Mascarar dados sensíveis
        if (sanitized.cpf) {
            sanitized.cpf = this.maskCPF(sanitized.cpf);
        }
        if (sanitized.nis) {
            sanitized.nis = this.maskNIS(sanitized.nis);
        }
        if (sanitized.rg) {
            sanitized.rg = '***MASKED***';
        }
        if (sanitized.telefone) {
            sanitized.telefone = '***MASKED***';
        }
        if (sanitized.email) {
            sanitized.email = '***MASKED***';
        }
        return sanitized;
    }
    /**
     * Mascara o CPF para exibir apenas os primeiros e últimos dígitos
     */
    maskCPF(cpf) {
        if (!cpf) {
            return '';
        }
        const cpfLimpo = cpf.replace(/\D/g, '');
        if (cpfLimpo.length !== 11) {
            return '***INVALID***';
        }
        return `${cpfLimpo.substring(0, 3)}.***.${cpfLimpo.substring(9)}`;
    }
    /**
     * Mascara o NIS para exibir apenas os primeiros e últimos dígitos
     */
    maskNIS(nis) {
        if (!nis) {
            return '';
        }
        const nisLimpo = nis.replace(/\D/g, '');
        if (nisLimpo.length !== 11) {
            return '***INVALID***';
        }
        return `${nisLimpo.substring(0, 3)}.***.${nisLimpo.substring(9)}`;
    }
    /**
     * Registra evento de auditoria no sistema
     * (Implementação futura - integração com sistema de auditoria)
     */
    /**
     * Versão otimizada e não bloqueante do registro de auditoria
     * Esta implementação não bloqueia o fluxo principal da aplicação
     */
    registerAuditEvent(event) {
        // Execute de forma não bloqueante em um processo assíncrono separado
        setTimeout(async () => {
            const requestId = `${event.method}-${event.url}-${Date.now()}`;
            console.time(`AUDIT-EVENT-${requestId}`);
            try {
                // Versão simplificada para diagnóstico
                const logAuditoriaDto = new create_log_auditoria_dto_1.CreateLogAuditoriaDto();
                // Configuração básica
                logAuditoriaDto.tipo_operacao = event.method === 'GET' ? tipo_operacao_enum_1.TipoOperacao.READ :
                    event.method === 'POST' ? tipo_operacao_enum_1.TipoOperacao.CREATE :
                        event.method === 'DELETE' ? tipo_operacao_enum_1.TipoOperacao.DELETE :
                            tipo_operacao_enum_1.TipoOperacao.UPDATE;
                logAuditoriaDto.entidade_afetada = 'Cidadao';
                logAuditoriaDto.entidade_id = this.extractEntityId(event.url);
                logAuditoriaDto.usuario_id = event.userId;
                logAuditoriaDto.endpoint = event.url;
                logAuditoriaDto.metodo_http = event.method;
                // Enfileirar sem aguardar resultado (fire and forget)
                this.auditoriaQueueService.enfileirarLogAuditoria(logAuditoriaDto)
                    .catch(err => this.logger.warn(`Erro em auditoria: ${err.message}`));
            }
            catch (error) {
                // Apenas log, não interrompe o fluxo principal
                this.logger.warn(`Erro ao registrar auditoria: ${error.message}`);
            }
            finally {
                console.timeEnd(`AUDIT-EVENT-${requestId}`);
            }
        }, 5); // Executa após 5ms para não bloquear
    }
};
exports.CidadaoAuditInterceptor = CidadaoAuditInterceptor;
exports.CidadaoAuditInterceptor = CidadaoAuditInterceptor = CidadaoAuditInterceptor_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof auditoria_queue_service_1.AuditoriaQueueService !== "undefined" && auditoria_queue_service_1.AuditoriaQueueService) === "function" ? _a : Object])
], CidadaoAuditInterceptor);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXGludGVyY2VwdG9yc1xcY2lkYWRhby1hdWRpdC5pbnRlcmNlcHRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUV4Qiw4Q0FBcUM7QUFFckMsOEZBQXlGO0FBQ3pGLDBFQUFpRTtBQUNqRSwyRkFBcUY7QUFFckY7Ozs7Ozs7R0FPRztBQUVJLElBQU0sdUJBQXVCLCtCQUE3QixNQUFNLHVCQUF1QjtJQUdMO0lBRlosTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLHlCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRW5FLFlBQTZCLHFCQUE0QztRQUE1QywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO0lBQUcsQ0FBQztJQUU3RTs7Ozs7Ozs7Ozs7T0FXRztJQUNILFNBQVMsQ0FBQyxPQUF5QixFQUFFLElBQWlCO1FBQ3BELHVDQUF1QztRQUN2QyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFXLENBQUM7UUFDN0QsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFFaEMsbUZBQW1GO1FBQ25GLHNFQUFzRTtRQUN0RSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRTFELHdEQUF3RDtRQUN4RCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDdkIsQ0FBQztRQUVELG1EQUFtRDtRQUNuRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDN0IsTUFBTSxTQUFTLEdBQUcsR0FBRyxNQUFNLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFB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Q0FBQyxlQUFlLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDOUMsQ0FBQztRQUNILENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLHFDQUFxQztJQUM5QyxDQUFDO0NBQ0YsQ0FBQTtBQWpUWSwwREFBdUI7a0NBQXZCLHVCQUF1QjtJQURuQyxJQUFBLG1CQUFVLEdBQUU7eURBSXlDLCtDQUFxQixvQkFBckIsK0NBQXFCO0dBSDlELHVCQUF1QixDQWlUbkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXGludGVyY2VwdG9yc1xcY2lkYWRhby1hdWRpdC5pbnRlcmNlcHRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOZXN0SW50ZXJjZXB0b3IsXG4gIEV4ZWN1dGlvbkNvbnRleHQsXG4gIENhbGxIYW5kbGVyLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEF1ZGl0b3JpYVF1ZXVlU2VydmljZSB9IGZyb20gJy4uLy4uL2F1ZGl0b3JpYS9zZXJ2aWNlcy9hdWRpdG9yaWEtcXVldWUuc2VydmljZSc7XG5pbXBvcnQgeyBUaXBvT3BlcmFjYW8gfSBmcm9tICcuLi8uLi8uLi9lbnVtcy90aXBvLW9wZXJhY2FvLmVudW0nO1xuaW1wb3J0IHsgQ3JlYXRlTG9nQXVkaXRvcmlhRHRvIH0gZnJvbSAnLi4vLi4vYXVkaXRvcmlhL2R0by9jcmVhdGUtbG9nLWF1ZGl0b3JpYS5kdG8nO1xuXG4vKipcbiAqIEludGVyY2VwdG9yIHBhcmEgYXVkaXRvcmlhIGRlIGFjZXNzbyBhIGRhZG9zIHNlbnPDrXZlaXMgZGUgY2lkYWTDo29zXG4gKlxuICogUmVnaXN0cmEgdG9kYXMgYXMgb3BlcmHDp8O1ZXMgZGUgYWNlc3NvIGEgZGFkb3Mgc2Vuc8OtdmVpcyBwYXJhIGNvbXBsaWFuY2UgY29tIExHUERcbiAqXG4gKiBOT1RBIERFIFBFUkZPUk1BTkNFOiBFc3RlIGludGVyY2VwdG9yIGZvaSBpZGVudGlmaWNhZG8gY29tbyBwb3Nzw612ZWwgY2F1c2EgZGUgbGVudGlkw6NvXG4gKiBlbSBlbmRwb2ludHMgY3LDrXRpY29zLiBWZXJzw6NvIG90aW1pemFkYSBwYXJhIGRpYWduw7NzdGljbyBlIHBlcmZvcm1hbmNlLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ2lkYWRhb0F1ZGl0SW50ZXJjZXB0b3IgaW1wbGVtZW50cyBOZXN0SW50ZXJjZXB0b3Ige1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQ2lkYWRhb0F1ZGl0SW50ZXJjZXB0b3IubmFtZSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhdWRpdG9yaWFRdWV1ZVNlcnZpY2U6IEF1ZGl0b3JpYVF1ZXVlU2VydmljZSkge31cblxuICAvKipcbiAgICogSW50ZXJjZXB0YSByZXF1aXNpw6fDtWVzIHBhcmEgYXVkaXRvcmlhIExHUEQsIHVzYW5kbyBwYWRyw6NvIHRvdGFsbWVudGUgbsOjby1ibG9xdWVhbnRlXG4gICAqIFxuICAgKiBPVElNSVpBw4fDg08gREUgUEVSRk9STUFOQ0U6XG4gICAqIC0gUHJvY2Vzc28gZXhlY3V0YWRvIGVtIHNlZ3VuZG8gcGxhbm8gY29tIHNldFRpbWVvdXRcbiAgICogLSBOw6NvIGJsb3F1ZWlhIG91IGF0cmFzYSBhIHJlc3Bvc3RhIHBhcmEgbyB1c3XDoXJpb1xuICAgKiAtIExvZ2dpbmcgbcOtbmltbyBwYXJhIGV2aXRhciBzb2JyZWNhcmdhIGRvIGxvZ1xuICAgKiBcbiAgICogQHBhcmFtIGNvbnRleHQgQ29udGV4dG8gZGEgZXhlY3XDp8Ojb1xuICAgKiBAcGFyYW0gbmV4dCBIYW5kbGVyIHBhcmEgYSBwcsOzeGltYSBldGFwYVxuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIGRhIHJlc3Bvc3RhIHByb2Nlc3NhZGFcbiAgICovXG4gIGludGVyY2VwdChjb250ZXh0OiBFeGVjdXRpb25Db250ZXh0LCBuZXh0OiBDYWxsSGFuZGxlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgLy8gQ2FwdHVyYXIgZGFkb3MgYsOhc2ljb3MgZGEgcmVxdWlzacOnw6NvXG4gICAgY29uc3QgcmVxdWVzdCA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdDxSZXF1ZXN0PigpO1xuICAgIGNvbnN0IHsgbWV0aG9kLCB1cmwgfSA9IHJlcXVlc3Q7XG4gICAgXG4gICAgLy8gVmVyaWZpY2HDp8OjbyBwcmVsaW1pbmFyIHLDoXBpZGEgcGFyYSBkZXRlcm1pbmFyIHNlIGEgb3BlcmHDp8OjbyBwcmVjaXNhIHNlciBhdWRpdGFkYVxuICAgIC8vIEVzdGEgZXRhcGEgw6kgbWFudGlkYSBzw61uY3JvbmEgcG9yIHNlciBtdWl0byByw6FwaWRhIChtaWNyb3NzZWd1bmRvcylcbiAgICBjb25zdCBuZWVkc0F1ZGl0ID0gdGhpcy5pc1NlbnNpdGl2ZU9wZXJhdGlvbihtZXRob2QsIHVybCk7XG4gICAgXG4gICAgLy8gU2UgbsOjbyBwcmVjaXNhciBkZSBhdWRpdG9yaWEsIHNpbXBsZXNtZW50ZSBwcm9zc2VndWlyXG4gICAgaWYgKCFuZWVkc0F1ZGl0KSB7XG4gICAgICByZXR1cm4gbmV4dC5oYW5kbGUoKTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2FwdHVyYXIgdGltZXN0YW1wIGluaWNpYWwgcGFyYSBtZWRpw6fDo28gZGUgdGVtcG9cbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGAke21ldGhvZH0tJHt1cmwuc3Vic3RyaW5nKDAsIDMwKX0tJHtzdGFydFRpbWV9YDtcbiAgICBcbiAgICAvLyBQcm9jZXNzYXIgYSByZXF1aXNpw6fDo28gbm9ybWFsbWVudGUgZSBmYXplciBhIGF1ZGl0b3JpYSBlbSBzZWd1bmRvIHBsYW5vXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKCkucGlwZShcbiAgICAgIHRhcCh7XG4gICAgICAgIG5leHQ6IChkYXRhKSA9PiB7XG4gICAgICAgICAgLy8gRXhlY3V0YXIgYXVkaXRvcmlhIGVtIHNlZ3VuZG8gcGxhbm8gKG7Do28tYmxvcXVlYW50ZSlcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgY29uc3QgeyBwYXJhbXMsIHF1ZXJ5LCBib2R5LCB1c2VyIH0gPSByZXF1ZXN0O1xuICAgICAgICAgICAgICBjb25zdCB1c2VySWQgPSB1c2VyPy5pZCB8fCAnYW7DtG5pbW8nO1xuICAgICAgICAgICAgICBjb25zdCB1c2VyUm9sZSA9IHVzZXI/LnJvbGVfaWQgfHwgJ27Do28gYXV0ZW50aWNhZG8nO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgLy8gTG9nIG3DrW5pbW8gcGFyYSBkaWFnbsOzc3RpY29cbiAgICAgICAgICAgICAgaWYgKGR1cmF0aW9uID4gNTAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgICAgICAgICAgYEFVRElULVNVQ0NFU1MgWyR7cmVxdWVzdElkfV0gRHVyYcOnw6NvOiAke2R1cmF0aW9ufW1zLCBVc3XDoXJpbzogJHt1c2VySWR9YCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAvLyBSZWdpc3RyYXIgZW0gc2lzdGVtYSBkZSBhdWRpdG9yaWFcbiAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlckF1ZGl0RXZlbnQoe1xuICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICB1c2VyUm9sZSxcbiAgICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICAgICAgICBib2R5OiB0aGlzLnNhbml0aXplQm9keShib2R5KSxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgZHVyYXRpb24sXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXG4gICAgICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGF1ZGl0RXJyb3IpIHtcbiAgICAgICAgICAgICAgLy8gRXJybyBuYSBhdWRpdG9yaWEgbsOjbyBkZXZlIGFmZXRhciBvIGZsdXhvIHByaW5jaXBhbFxuICAgICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBFcnJvIG5hIGF1ZGl0b3JpYSBbJHtyZXF1ZXN0SWR9XTogJHthdWRpdEVycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgMTApOyAvLyBQZXF1ZW5vIGRlbGF5IHBhcmEgZ2FyYW50aXIgcXVlIG7Do28gYmxvcXVlaWVcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChlcnJvcikgPT4ge1xuICAgICAgICAgIC8vIEF1ZGl0b3JpYSBkZSBlcnJvIGVtIHNlZ3VuZG8gcGxhbm8gKG7Do28tYmxvcXVlYW50ZSlcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgY29uc3QgeyBwYXJhbXMsIHF1ZXJ5LCBib2R5LCB1c2VyIH0gPSByZXF1ZXN0O1xuICAgICAgICAgICAgICBjb25zdCB1c2VySWQgPSB1c2VyPy5pZCB8fCAnYW7DtG5pbW8nO1xuICAgICAgICAgICAgICBjb25zdCB1c2VyUm9sZSA9IHVzZXI/LnJvbGVfaWQgfHwgJ27Do28gYXV0ZW50aWNhZG8nO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgLy8gTG9nIG3DrW5pbW8gcGFyYSBlcnJvcyBpbXBvcnRhbnRlc1xuICAgICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgIGBBVURJVC1FUlJPUiBbJHtyZXF1ZXN0SWR9XSBEdXJhw6fDo286ICR7ZHVyYXRpb259bXMsIEVycm86ICR7ZXJyb3IubWVzc2FnZS5zdWJzdHJpbmcoMCwgNTApfWAsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAvLyBSZWdpc3RyYXIgZXJybyBlbSBzaXN0ZW1hIGRlIGF1ZGl0b3JpYVxuICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQXVkaXRFdmVudCh7XG4gICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgIHVzZXJSb2xlLFxuICAgICAgICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgIHF1ZXJ5LFxuICAgICAgICAgICAgICAgIGJvZHk6IHRoaXMuc2FuaXRpemVCb2R5KGJvZHkpLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdlcnJvcicsXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGNhdGNoIChhdWRpdEVycm9yKSB7XG4gICAgICAgICAgICAgIC8vIEVycm8gbmEgYXVkaXRvcmlhIG7Do28gZGV2ZSBhZmV0YXIgbyBmbHV4byBwcmluY2lwYWxcbiAgICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgRXJybyBuYSBhdWRpdG9yaWEgZGUgZXJybyBbJHtyZXF1ZXN0SWR9XTogJHthdWRpdEVycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgMTApOyAvLyBQZXF1ZW5vIGRlbGF5IHBhcmEgZ2FyYW50aXIgcXVlIG7Do28gYmxvcXVlaWVcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgYSBvcGVyYcOnw6NvIMOpIHNlbnPDrXZlbCBkbyBwb250byBkZSB2aXN0YSBkYSBMR1BEXG4gICAqL1xuICBwcml2YXRlIGlzU2Vuc2l0aXZlT3BlcmF0aW9uKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIC8vIE9wZXJhw6fDtWVzIGRlIGxlaXR1cmEgZGUgZGFkb3MgcGVzc29haXNcbiAgICBpZiAoXG4gICAgICB1cmwuaW5jbHVkZXMoJy92MS9jaWRhZGFvLycpICYmXG4gICAgICAobWV0aG9kID09PSAnR0VUJyB8fCBtZXRob2QgPT09ICdQT1NUJylcbiAgICApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIE9wZXJhw6fDtWVzIGRlIG1vZGlmaWNhw6fDo28gZGUgZGFkb3MgcGVzc29haXNcbiAgICBpZiAoXG4gICAgICB1cmwuaW5jbHVkZXMoJy92MS9jaWRhZGFvJykgJiZcbiAgICAgIChtZXRob2QgPT09ICdQVVQnIHx8IG1ldGhvZCA9PT0gJ0RFTEVURScpXG4gICAgKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBCdXNjYSBwb3IgQ1BGIG91IE5JUyAoZGFkb3Mgc2Vuc8OtdmVpcylcbiAgICBpZiAodXJsLmluY2x1ZGVzKCcvdjEvY2lkYWRhby9jcGYvJykgfHwgdXJsLmluY2x1ZGVzKCcvdjEvY2lkYWRhby9uaXMvJykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWkgbyBJRCBkYSBlbnRpZGFkZSBkYSBVUkxcbiAgICovXG4gIHByaXZhdGUgZXh0cmFjdEVudGl0eUlkKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBQYWRyw6NvIHBhcmEgZXh0cmFpciBVVUlEIGRhIFVSTFxuICAgIGNvbnN0IHV1aWRQYXR0ZXJuID1cbiAgICAgIC9cXC8oWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9KS9pO1xuICAgIGNvbnN0IG1hdGNoID0gdXJsLm1hdGNoKHV1aWRQYXR0ZXJuKTtcblxuICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xuICAgICAgcmV0dXJuIG1hdGNoWzFdO1xuICAgIH1cblxuICAgIC8vIFNlIG7Do28gZW5jb250cm91IFVVSUQsIHRlbnRhIGV4dHJhaXIgQ1BGIG91IE5JU1xuICAgIGlmICh1cmwuaW5jbHVkZXMoJy9jcGYvJykpIHtcbiAgICAgIGNvbnN0IGNwZk1hdGNoID0gdXJsLm1hdGNoKC9cXC9jcGZcXC8oW14vXSspLyk7XG4gICAgICByZXR1cm4gY3BmTWF0Y2ggPyBjcGZNYXRjaFsxXSA6ICdkZXNjb25oZWNpZG8nO1xuICAgIH1cblxuICAgIGlmICh1cmwuaW5jbHVkZXMoJy9uaXMvJykpIHtcbiAgICAgIGNvbnN0IG5pc01hdGNoID0gdXJsLm1hdGNoKC9cXC9uaXNcXC8oW14vXSspLyk7XG4gICAgICByZXR1cm4gbmlzTWF0Y2ggPyBuaXNNYXRjaFsxXSA6ICdkZXNjb25oZWNpZG8nO1xuICAgIH1cblxuICAgIHJldHVybiAnZGVzY29uaGVjaWRvJztcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvIGNvcnBvIGRhIHJlcXVpc2nDp8OjbyBjb250w6ltIGRhZG9zIHNlbnPDrXZlaXNcbiAgICovXG4gIHByaXZhdGUgY29udGFpbnNTZW5zaXRpdmVEYXRhKGJvZHk6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmICghYm9keSkge3JldHVybiBmYWxzZTt9XG5cbiAgICBjb25zdCBzZW5zaXRpdmVGaWVsZHMgPSBbXG4gICAgICAnY3BmJyxcbiAgICAgICduaXMnLFxuICAgICAgJ3JnJyxcbiAgICAgICdkYXRhX25hc2NpbWVudG8nLFxuICAgICAgJ3JlbmRhJyxcbiAgICAgICdjb21wb3NpY2FvX2ZhbWlsaWFyJyxcbiAgICBdO1xuXG4gICAgcmV0dXJuIHNlbnNpdGl2ZUZpZWxkcy5zb21lKChmaWVsZCkgPT4gZmllbGQgaW4gYm9keSk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFpIG9zIGNhbXBvcyBzZW5zw612ZWlzIGRvIGNvcnBvIGRhIHJlcXVpc2nDp8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0U2Vuc2l0aXZlRmllbGRzKGJvZHk6IGFueSk6IHN0cmluZ1tdIHtcbiAgICBpZiAoIWJvZHkpIHtyZXR1cm4gW107fVxuXG4gICAgY29uc3Qgc2Vuc2l0aXZlRmllbGRzID0gW1xuICAgICAgJ2NwZicsXG4gICAgICAnbmlzJyxcbiAgICAgICdyZycsXG4gICAgICAnZGF0YV9uYXNjaW1lbnRvJyxcbiAgICAgICdyZW5kYScsXG4gICAgICAnY29tcG9zaWNhb19mYW1pbGlhcicsXG4gICAgICAndGVsZWZvbmUnLFxuICAgICAgJ2VtYWlsJyxcbiAgICAgICdlbmRlcmVjbycsXG4gICAgXTtcblxuICAgIHJldHVybiBzZW5zaXRpdmVGaWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQgaW4gYm9keSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGRhZG9zIHNlbnPDrXZlaXMgZG8gY29ycG8gZGEgcmVxdWlzacOnw6NvIHBhcmEgbyBsb2cgZGUgYXVkaXRvcmlhXG4gICAqL1xuICBwcml2YXRlIHNhbml0aXplQm9keShib2R5OiBhbnkpOiBhbnkge1xuICAgIGlmICghYm9keSkge3JldHVybiBudWxsO31cblxuICAgIGNvbnN0IHNhbml0aXplZCA9IHsgLi4uYm9keSB9O1xuXG4gICAgLy8gTWFzY2FyYXIgZGFkb3Mgc2Vuc8OtdmVpc1xuICAgIGlmIChzYW5pdGl6ZWQuY3BmKSB7XG4gICAgICBzYW5pdGl6ZWQuY3BmID0gdGhpcy5tYXNrQ1BGKHNhbml0aXplZC5jcGYpO1xuICAgIH1cblxuICAgIGlmIChzYW5pdGl6ZWQubmlzKSB7XG4gICAgICBzYW5pdGl6ZWQubmlzID0gdGhpcy5tYXNrTklTKHNhbml0aXplZC5uaXMpO1xuICAgIH1cblxuICAgIGlmIChzYW5pdGl6ZWQucmcpIHtcbiAgICAgIHNhbml0aXplZC5yZyA9ICcqKipNQVNLRUQqKionO1xuICAgIH1cblxuICAgIGlmIChzYW5pdGl6ZWQudGVsZWZvbmUpIHtcbiAgICAgIHNhbml0aXplZC50ZWxlZm9uZSA9ICcqKipNQVNLRUQqKionO1xuICAgIH1cblxuICAgIGlmIChzYW5pdGl6ZWQuZW1haWwpIHtcbiAgICAgIHNhbml0aXplZC5lbWFpbCA9ICcqKipNQVNLRUQqKionO1xuICAgIH1cblxuICAgIHJldHVybiBzYW5pdGl6ZWQ7XG4gIH1cblxuICAvKipcbiAgICogTWFzY2FyYSBvIENQRiBwYXJhIGV4aWJpciBhcGVuYXMgb3MgcHJpbWVpcm9zIGUgw7psdGltb3MgZMOtZ2l0b3NcbiAgICovXG4gIHByaXZhdGUgbWFza0NQRihjcGY6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFjcGYpIHtyZXR1cm4gJyc7fVxuXG4gICAgY29uc3QgY3BmTGltcG8gPSBjcGYucmVwbGFjZSgvXFxEL2csICcnKTtcbiAgICBpZiAoY3BmTGltcG8ubGVuZ3RoICE9PSAxMSkge3JldHVybiAnKioqSU5WQUxJRCoqKic7fVxuXG4gICAgcmV0dXJuIGAke2NwZkxpbXBvLnN1YnN0cmluZygwLCAzKX0uKioqLiR7Y3BmTGltcG8uc3Vic3RyaW5nKDkpfWA7XG4gIH1cblxuICAvKipcbiAgICogTWFzY2FyYSBvIE5JUyBwYXJhIGV4aWJpciBhcGVuYXMgb3MgcHJpbWVpcm9zIGUgw7psdGltb3MgZMOtZ2l0b3NcbiAgICovXG4gIHByaXZhdGUgbWFza05JUyhuaXM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFuaXMpIHtyZXR1cm4gJyc7fVxuXG4gICAgY29uc3QgbmlzTGltcG8gPSBuaXMucmVwbGFjZSgvXFxEL2csICcnKTtcbiAgICBpZiAobmlzTGltcG8ubGVuZ3RoICE9PSAxMSkge3JldHVybiAnKioqSU5WQUxJRCoqKic7fVxuXG4gICAgcmV0dXJuIGAke25pc0xpbXBvLnN1YnN0cmluZygwLCAzKX0uKioqLiR7bmlzTGltcG8uc3Vic3RyaW5nKDkpfWA7XG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0cmEgZXZlbnRvIGRlIGF1ZGl0b3JpYSBubyBzaXN0ZW1hXG4gICAqIChJbXBsZW1lbnRhw6fDo28gZnV0dXJhIC0gaW50ZWdyYcOnw6NvIGNvbSBzaXN0ZW1hIGRlIGF1ZGl0b3JpYSlcbiAgICovXG4gIC8qKlxuICAgKiBWZXJzw6NvIG90aW1pemFkYSBlIG7Do28gYmxvcXVlYW50ZSBkbyByZWdpc3RybyBkZSBhdWRpdG9yaWFcbiAgICogRXN0YSBpbXBsZW1lbnRhw6fDo28gbsOjbyBibG9xdWVpYSBvIGZsdXhvIHByaW5jaXBhbCBkYSBhcGxpY2HDp8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSByZWdpc3RlckF1ZGl0RXZlbnQoZXZlbnQ6IGFueSk6IHZvaWQge1xuICAgIC8vIEV4ZWN1dGUgZGUgZm9ybWEgbsOjbyBibG9xdWVhbnRlIGVtIHVtIHByb2Nlc3NvIGFzc8OtbmNyb25vIHNlcGFyYWRvXG4gICAgc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0SWQgPSBgJHtldmVudC5tZXRob2R9LSR7ZXZlbnQudXJsfS0ke0RhdGUubm93KCl9YDtcbiAgICAgIGNvbnNvbGUudGltZShgQVVESVQtRVZFTlQtJHtyZXF1ZXN0SWR9YCk7XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIFZlcnPDo28gc2ltcGxpZmljYWRhIHBhcmEgZGlhZ27Ds3N0aWNvXG4gICAgICAgIGNvbnN0IGxvZ0F1ZGl0b3JpYUR0byA9IG5ldyBDcmVhdGVMb2dBdWRpdG9yaWFEdG8oKTtcbiAgICAgICAgXG4gICAgICAgIC8vIENvbmZpZ3VyYcOnw6NvIGLDoXNpY2FcbiAgICAgICAgbG9nQXVkaXRvcmlhRHRvLnRpcG9fb3BlcmFjYW8gPSBldmVudC5tZXRob2QgPT09ICdHRVQnID8gVGlwb09wZXJhY2FvLlJFQUQgOiBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50Lm1ldGhvZCA9PT0gJ1BPU1QnID8gVGlwb09wZXJhY2FvLkNSRUFURSA6IFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQubWV0aG9kID09PSAnREVMRVRFJyA/IFRpcG9PcGVyYWNhby5ERUxFVEUgOiBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRpcG9PcGVyYWNhby5VUERBVEU7XG4gICAgICAgIFxuICAgICAgICBsb2dBdWRpdG9yaWFEdG8uZW50aWRhZGVfYWZldGFkYSA9ICdDaWRhZGFvJztcbiAgICAgICAgbG9nQXVkaXRvcmlhRHRvLmVudGlkYWRlX2lkID0gdGhpcy5leHRyYWN0RW50aXR5SWQoZXZlbnQudXJsKTtcbiAgICAgICAgbG9nQXVkaXRvcmlhRHRvLnVzdWFyaW9faWQgPSBldmVudC51c2VySWQ7XG4gICAgICAgIGxvZ0F1ZGl0b3JpYUR0by5lbmRwb2ludCA9IGV2ZW50LnVybDtcbiAgICAgICAgbG9nQXVkaXRvcmlhRHRvLm1ldG9kb19odHRwID0gZXZlbnQubWV0aG9kO1xuICAgICAgICBcbiAgICAgICAgLy8gRW5maWxlaXJhciBzZW0gYWd1YXJkYXIgcmVzdWx0YWRvIChmaXJlIGFuZCBmb3JnZXQpXG4gICAgICAgIHRoaXMuYXVkaXRvcmlhUXVldWVTZXJ2aWNlLmVuZmlsZWlyYXJMb2dBdWRpdG9yaWEobG9nQXVkaXRvcmlhRHRvKVxuICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5sb2dnZXIud2FybihgRXJybyBlbSBhdWRpdG9yaWE6ICR7ZXJyLm1lc3NhZ2V9YCkpO1xuICAgICAgICBcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIEFwZW5hcyBsb2csIG7Do28gaW50ZXJyb21wZSBvIGZsdXhvIHByaW5jaXBhbFxuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBFcnJvIGFvIHJlZ2lzdHJhciBhdWRpdG9yaWE6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGNvbnNvbGUudGltZUVuZChgQVVESVQtRVZFTlQtJHtyZXF1ZXN0SWR9YCk7XG4gICAgICB9XG4gICAgfSwgNSk7IC8vIEV4ZWN1dGEgYXDDs3MgNW1zIHBhcmEgbsOjbyBibG9xdWVhclxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=