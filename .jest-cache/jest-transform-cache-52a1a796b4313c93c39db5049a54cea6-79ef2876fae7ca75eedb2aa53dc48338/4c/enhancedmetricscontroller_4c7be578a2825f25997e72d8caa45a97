542edbc3fa9ab5154297d24c00623da9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnhancedMetricsController = void 0;
const common_1 = require("@nestjs/common");
const express_1 = require("express");
const enhanced_metrics_service_1 = require("./enhanced-metrics.service");
const public_decorator_1 = require("../../auth/decorators/public.decorator");
const swagger_1 = require("@nestjs/swagger");
/**
 * Controlador de Métricas Aprimorado
 *
 * Expõe endpoints para acesso às métricas avançadas da aplicação
 * no formato do Prometheus, com foco em segurança e compliance LGPD
 */
let EnhancedMetricsController = class EnhancedMetricsController {
    metricsService;
    constructor(metricsService) {
        this.metricsService = metricsService;
    }
    /**
     * Retorna todas as métricas no formato do Prometheus
     */
    async getMetrics(response) {
        const metrics = await this.metricsService.getMetrics();
        response.setHeader('Content-Type', 'text/plain');
        return response.send(metrics);
    }
    /**
     * Retorna métricas específicas de segurança e compliance LGPD
     */
    async getSecurityMetrics(response) {
        const metrics = await this.metricsService.getMetrics();
        // Filtrar apenas métricas de segurança
        const securityMetrics = metrics
            .split('\n')
            .filter((line) => line.includes('security_') ||
            line.includes('lgpd_') ||
            line.includes('authentication_') ||
            line.includes('authorization_'))
            .join('\n');
        response.setHeader('Content-Type', 'text/plain');
        return response.send(securityMetrics);
    }
    /**
     * Retorna métricas específicas de documentos
     */
    async getDocumentMetrics(response) {
        const metrics = await this.metricsService.getMetrics();
        // Filtrar apenas métricas de documentos
        const documentMetrics = metrics
            .split('\n')
            .filter((line) => line.includes('document_'))
            .join('\n');
        response.setHeader('Content-Type', 'text/plain');
        return response.send(documentMetrics);
    }
    /**
     * Retorna métricas específicas de sistema
     */
    async getSystemMetrics(response) {
        // Atualizar métricas de sistema antes de retornar
        this.metricsService.updateMemoryUsage();
        const metrics = await this.metricsService.getMetrics();
        // Filtrar apenas métricas de sistema
        const systemMetrics = metrics
            .split('\n')
            .filter((line) => line.includes('system_') ||
            line.includes('process_') ||
            line.includes('nodejs_'))
            .join('\n');
        response.setHeader('Content-Type', 'text/plain');
        return response.send(systemMetrics);
    }
    /**
     * Retorna métricas específicas de cache
     */
    async getCacheMetrics(response) {
        const metrics = await this.metricsService.getMetrics();
        // Filtrar apenas métricas de cache
        const cacheMetrics = metrics
            .split('\n')
            .filter((line) => line.includes('cache_'))
            .join('\n');
        response.setHeader('Content-Type', 'text/plain');
        return response.send(cacheMetrics);
    }
};
exports.EnhancedMetricsController = EnhancedMetricsController;
__decorate([
    (0, common_1.Get)(),
    (0, public_decorator_1.Public)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Obter métricas da aplicação',
        description: 'Retorna todas as métricas da aplicação no formato do Prometheus',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Métricas retornadas com sucesso no formato do Prometheus',
    }),
    __param(0, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_b = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _b : Object]),
    __metadata("design:returntype", Promise)
], EnhancedMetricsController.prototype, "getMetrics", null);
__decorate([
    (0, common_1.Get)('security'),
    (0, public_decorator_1.Public)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Obter métricas de segurança',
        description: 'Retorna métricas relacionadas à segurança e compliance LGPD',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Métricas de segurança retornadas com sucesso',
    }),
    __param(0, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_c = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _c : Object]),
    __metadata("design:returntype", Promise)
], EnhancedMetricsController.prototype, "getSecurityMetrics", null);
__decorate([
    (0, common_1.Get)('documents'),
    (0, public_decorator_1.Public)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Obter métricas de documentos',
        description: 'Retorna métricas relacionadas a operações com documentos',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Métricas de documentos retornadas com sucesso',
    }),
    __param(0, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_d = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _d : Object]),
    __metadata("design:returntype", Promise)
], EnhancedMetricsController.prototype, "getDocumentMetrics", null);
__decorate([
    (0, common_1.Get)('system'),
    (0, public_decorator_1.Public)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Obter métricas de sistema',
        description: 'Retorna métricas relacionadas ao sistema (memória, CPU)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Métricas de sistema retornadas com sucesso',
    }),
    __param(0, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_e = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _e : Object]),
    __metadata("design:returntype", Promise)
], EnhancedMetricsController.prototype, "getSystemMetrics", null);
__decorate([
    (0, common_1.Get)('cache'),
    (0, public_decorator_1.Public)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Obter métricas de cache',
        description: 'Retorna métricas relacionadas ao cache (Redis ou em memória)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Métricas de cache retornadas com sucesso',
    }),
    __param(0, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_f = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _f : Object]),
    __metadata("design:returntype", Promise)
], EnhancedMetricsController.prototype, "getCacheMetrics", null);
exports.EnhancedMetricsController = EnhancedMetricsController = __decorate([
    (0, swagger_1.ApiTags)('Métricas e Dashboard'),
    (0, common_1.Controller)('monitoramento/metricas'),
    __metadata("design:paramtypes", [typeof (_a = typeof enhanced_metrics_service_1.EnhancedMetricsService !== "undefined" && enhanced_metrics_service_1.EnhancedMetricsService) === "function" ? _a : Object])
], EnhancedMetricsController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcZW5oYW5jZWQtbWV0cmljcy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBc0Q7QUFDdEQscUNBQW1DO0FBQ25DLHlFQUFvRTtBQUNwRSw2RUFBZ0U7QUFDaEUsNkNBQXFFO0FBRXJFOzs7OztHQUtHO0FBR0ksSUFBTSx5QkFBeUIsR0FBL0IsTUFBTSx5QkFBeUI7SUFDUDtJQUE3QixZQUE2QixjQUFzQztRQUF0QyxtQkFBYyxHQUFkLGNBQWMsQ0FBd0I7SUFBRyxDQUFDO0lBRXZFOztPQUVHO0lBWUcsQUFBTixLQUFLLENBQUMsVUFBVSxDQUFRLFFBQWtCO1FBQ3hDLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN2RCxRQUFRLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNqRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBV0csQUFBTixLQUFLLENBQUMsa0JBQWtCLENBQVEsUUFBa0I7UUFDaEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRXZELHVDQUF1QztRQUN2QyxNQUFNLGVBQWUsR0FBRyxPQUFPO2FBQzVCLEtBQUssQ0FBQyxJQUFJLENBQUM7YUFDWCxNQUFNLENBQ0wsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNQLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO1lBQzFCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUM7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxn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UUFDWCxNQUFNLEVBQUUsR0FBRztRQUNYLFdBQVcsRUFBRSwwQ0FBMEM7S0FDeEQsQ0FBQztJQUNxQixXQUFBLElBQUEsWUFBRyxHQUFFLENBQUE7O3lEQUFXLGtCQUFRLG9CQUFSLGtCQUFROztnRUFXOUM7b0NBM0lVLHlCQUF5QjtJQUZyQyxJQUFBLGlCQUFPLEVBQUMsc0JBQXNCLENBQUM7SUFDL0IsSUFBQSxtQkFBVSxFQUFDLHdCQUF3QixDQUFDO3lEQUVVLGlEQUFzQixvQkFBdEIsaURBQXNCO0dBRHhELHlCQUF5QixDQTRJckMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcZW5oYW5jZWQtbWV0cmljcy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRyb2xsZXIsIEdldCwgUmVzIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEVuaGFuY2VkTWV0cmljc1NlcnZpY2UgfSBmcm9tICcuL2VuaGFuY2VkLW1ldHJpY3Muc2VydmljZSc7XG5pbXBvcnQgeyBQdWJsaWMgfSBmcm9tICcuLi8uLi9hdXRoL2RlY29yYXRvcnMvcHVibGljLmRlY29yYXRvcic7XG5pbXBvcnQgeyBBcGlUYWdzLCBBcGlPcGVyYXRpb24sIEFwaVJlc3BvbnNlIH0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcblxuLyoqXG4gKiBDb250cm9sYWRvciBkZSBNw6l0cmljYXMgQXByaW1vcmFkb1xuICpcbiAqIEV4cMO1ZSBlbmRwb2ludHMgcGFyYSBhY2Vzc28gw6BzIG3DqXRyaWNhcyBhdmFuw6dhZGFzIGRhIGFwbGljYcOnw6NvXG4gKiBubyBmb3JtYXRvIGRvIFByb21ldGhldXMsIGNvbSBmb2NvIGVtIHNlZ3VyYW7Dp2EgZSBjb21wbGlhbmNlIExHUERcbiAqL1xuQEFwaVRhZ3MoJ03DqXRyaWNhcyBlIERhc2hib2FyZCcpXG5AQ29udHJvbGxlcignbW9uaXRvcmFtZW50by9tZXRyaWNhcycpXG5leHBvcnQgY2xhc3MgRW5oYW5jZWRNZXRyaWNzQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgbWV0cmljc1NlcnZpY2U6IEVuaGFuY2VkTWV0cmljc1NlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgdG9kYXMgYXMgbcOpdHJpY2FzIG5vIGZvcm1hdG8gZG8gUHJvbWV0aGV1c1xuICAgKi9cbiAgQEdldCgpXG4gIEBQdWJsaWMoKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnT2J0ZXIgbcOpdHJpY2FzIGRhIGFwbGljYcOnw6NvJyxcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgICdSZXRvcm5hIHRvZGFzIGFzIG3DqXRyaWNhcyBkYSBhcGxpY2HDp8OjbyBubyBmb3JtYXRvIGRvIFByb21ldGhldXMnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnTcOpdHJpY2FzIHJldG9ybmFkYXMgY29tIHN1Y2Vzc28gbm8gZm9ybWF0byBkbyBQcm9tZXRoZXVzJyxcbiAgfSlcbiAgYXN5bmMgZ2V0TWV0cmljcyhAUmVzKCkgcmVzcG9uc2U6IFJlc3BvbnNlKSB7XG4gICAgY29uc3QgbWV0cmljcyA9IGF3YWl0IHRoaXMubWV0cmljc1NlcnZpY2UuZ2V0TWV0cmljcygpO1xuICAgIHJlc3BvbnNlLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKTtcbiAgICByZXR1cm4gcmVzcG9uc2Uuc2VuZChtZXRyaWNzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIG3DqXRyaWNhcyBlc3BlY8OtZmljYXMgZGUgc2VndXJhbsOnYSBlIGNvbXBsaWFuY2UgTEdQRFxuICAgKi9cbiAgQEdldCgnc2VjdXJpdHknKVxuICBAUHVibGljKClcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ09idGVyIG3DqXRyaWNhcyBkZSBzZWd1cmFuw6dhJyxcbiAgICBkZXNjcmlwdGlvbjogJ1JldG9ybmEgbcOpdHJpY2FzIHJlbGFjaW9uYWRhcyDDoCBzZWd1cmFuw6dhIGUgY29tcGxpYW5jZSBMR1BEJyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBkZXNjcmlwdGlvbjogJ03DqXRyaWNhcyBkZSBzZWd1cmFuw6dhIHJldG9ybmFkYXMgY29tIHN1Y2Vzc28nLFxuICB9KVxuICBhc3luYyBnZXRTZWN1cml0eU1ldHJpY3MoQFJlcygpIHJlc3BvbnNlOiBSZXNwb25zZSkge1xuICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLm1ldHJpY3NTZXJ2aWNlLmdldE1ldHJpY3MoKTtcblxuICAgIC8vIEZpbHRyYXIgYXBlbmFzIG3DqXRyaWNhcyBkZSBzZWd1cmFuw6dhXG4gICAgY29uc3Qgc2VjdXJpdHlNZXRyaWNzID0gbWV0cmljc1xuICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgLmZpbHRlcihcbiAgICAgICAgKGxpbmUpID0+XG4gICAgICAgICAgbGluZS5pbmNsdWRlcygnc2VjdXJpdHlfJykgfHxcbiAgICAgICAgICBsaW5lLmluY2x1ZGVzKCdsZ3BkXycpIHx8XG4gICAgICAgICAgbGluZS5pbmNsdWRlcygnYXV0aGVudGljYXRpb25fJykgfHxcbiAgICAgICAgICBsaW5lLmluY2x1ZGVzKCdhdXRob3JpemF0aW9uXycpLFxuICAgICAgKVxuICAgICAgLmpvaW4oJ1xcbicpO1xuXG4gICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbicpO1xuICAgIHJldHVybiByZXNwb25zZS5zZW5kKHNlY3VyaXR5TWV0cmljcyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBtw6l0cmljYXMgZXNwZWPDrWZpY2FzIGRlIGRvY3VtZW50b3NcbiAgICovXG4gIEBHZXQoJ2RvY3VtZW50cycpXG4gIEBQdWJsaWMoKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnT2J0ZXIgbcOpdHJpY2FzIGRlIGRvY3VtZW50b3MnLFxuICAgIGRlc2NyaXB0aW9uOiAnUmV0b3JuYSBtw6l0cmljYXMgcmVsYWNpb25hZGFzIGEgb3BlcmHDp8O1ZXMgY29tIGRvY3VtZW50b3MnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnTcOpdHJpY2FzIGRlIGRvY3VtZW50b3MgcmV0b3JuYWRhcyBjb20gc3VjZXNzbycsXG4gIH0pXG4gIGFzeW5jIGdldERvY3VtZW50TWV0cmljcyhAUmVzKCkgcmVzcG9uc2U6IFJlc3BvbnNlKSB7XG4gICAgY29uc3QgbWV0cmljcyA9IGF3YWl0IHRoaXMubWV0cmljc1NlcnZpY2UuZ2V0TWV0cmljcygpO1xuXG4gICAgLy8gRmlsdHJhciBhcGVuYXMgbcOpdHJpY2FzIGRlIGRvY3VtZW50b3NcbiAgICBjb25zdCBkb2N1bWVudE1ldHJpY3MgPSBtZXRyaWNzXG4gICAgICAuc3BsaXQoJ1xcbicpXG4gICAgICAuZmlsdGVyKChsaW5lKSA9PiBsaW5lLmluY2x1ZGVzKCdkb2N1bWVudF8nKSlcbiAgICAgIC5qb2luKCdcXG4nKTtcblxuICAgIHJlc3BvbnNlLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKTtcbiAgICByZXR1cm4gcmVzcG9uc2Uuc2VuZChkb2N1bWVudE1ldHJpY3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgbcOpdHJpY2FzIGVzcGVjw61maWNhcyBkZSBzaXN0ZW1hXG4gICAqL1xuICBAR2V0KCdzeXN0ZW0nKVxuICBAUHVibGljKClcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ09idGVyIG3DqXRyaWNhcyBkZSBzaXN0ZW1hJyxcbiAgICBkZXNjcmlwdGlvbjogJ1JldG9ybmEgbcOpdHJpY2FzIHJlbGFjaW9uYWRhcyBhbyBzaXN0ZW1hIChtZW3Ds3JpYSwgQ1BVKScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdNw6l0cmljYXMgZGUgc2lzdGVtYSByZXRvcm5hZGFzIGNvbSBzdWNlc3NvJyxcbiAgfSlcbiAgYXN5bmMgZ2V0U3lzdGVtTWV0cmljcyhAUmVzKCkgcmVzcG9uc2U6IFJlc3BvbnNlKSB7XG4gICAgLy8gQXR1YWxpemFyIG3DqXRyaWNhcyBkZSBzaXN0ZW1hIGFudGVzIGRlIHJldG9ybmFyXG4gICAgdGhpcy5tZXRyaWNzU2VydmljZS51cGRhdGVNZW1vcnlVc2FnZSgpO1xuXG4gICAgY29uc3QgbWV0cmljcyA9IGF3YWl0IHRoaXMubWV0cmljc1NlcnZpY2UuZ2V0TWV0cmljcygpO1xuXG4gICAgLy8gRmlsdHJhciBhcGVuYXMgbcOpdHJpY2FzIGRlIHNpc3RlbWFcbiAgICBjb25zdCBzeXN0ZW1NZXRyaWNzID0gbWV0cmljc1xuICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgLmZpbHRlcihcbiAgICAgICAgKGxpbmUpID0+XG4gICAgICAgICAgbGluZS5pbmNsdWRlcygnc3lzdGVtXycpIHx8XG4gICAgICAgICAgbGluZS5pbmNsdWRlcygncHJvY2Vzc18nKSB8fFxuICAgICAgICAgIGxpbmUuaW5jbHVkZXMoJ25vZGVqc18nKSxcbiAgICAgIClcbiAgICAgIC5qb2luKCdcXG4nKTtcblxuICAgIHJlc3BvbnNlLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKTtcbiAgICByZXR1cm4gcmVzcG9uc2Uuc2VuZChzeXN0ZW1NZXRyaWNzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIG3DqXRyaWNhcyBlc3BlY8OtZmljYXMgZGUgY2FjaGVcbiAgICovXG4gIEBHZXQoJ2NhY2hlJylcbiAgQFB1YmxpYygpXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdPYnRlciBtw6l0cmljYXMgZGUgY2FjaGUnLFxuICAgIGRlc2NyaXB0aW9uOiAnUmV0b3JuYSBtw6l0cmljYXMgcmVsYWNpb25hZGFzIGFvIGNhY2hlIChSZWRpcyBvdSBlbSBtZW3Ds3JpYSknLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnTcOpdHJpY2FzIGRlIGNhY2hlIHJldG9ybmFkYXMgY29tIHN1Y2Vzc28nLFxuICB9KVxuICBhc3luYyBnZXRDYWNoZU1ldHJpY3MoQFJlcygpIHJlc3BvbnNlOiBSZXNwb25zZSkge1xuICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLm1ldHJpY3NTZXJ2aWNlLmdldE1ldHJpY3MoKTtcblxuICAgIC8vIEZpbHRyYXIgYXBlbmFzIG3DqXRyaWNhcyBkZSBjYWNoZVxuICAgIGNvbnN0IGNhY2hlTWV0cmljcyA9IG1ldHJpY3NcbiAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgIC5maWx0ZXIoKGxpbmUpID0+IGxpbmUuaW5jbHVkZXMoJ2NhY2hlXycpKVxuICAgICAgLmpvaW4oJ1xcbicpO1xuXG4gICAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbicpO1xuICAgIHJldHVybiByZXNwb25zZS5zZW5kKGNhY2hlTWV0cmljcyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==