76c55f69a198315515c4041f0fceda83
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const auditoria_pagamento_service_1 = require("../../services/auditoria-pagamento.service");
const config_1 = require("@nestjs/config");
const common_1 = require("@nestjs/common");
const status_pagamento_enum_1 = require("../../enums/status-pagamento.enum");
const metodo_pagamento_enum_1 = require("../../enums/metodo-pagamento.enum");
/**
 * Testes unitários para o serviço de auditoria de pagamento
 *
 * Verifica o funcionamento correto das operações de registro de logs
 * para ações sensíveis relacionadas a pagamentos.
 *
 * @author Equipe PGBen
 */
describe('AuditoriaPagamentoService', () => {
    let service;
    let logger;
    let configService;
    // Mock do Logger
    const mockLogger = {
        log: jest.fn(),
        warn: jest.fn(),
        error: jest.fn(),
        debug: jest.fn()
    };
    // Mock do ConfigService
    const mockConfigService = {
        get: jest.fn().mockImplementation((key) => {
            if (key === 'auditoria.nivel') {
                return 'completo';
            }
            if (key === 'auditoria.mascaraDados') {
                return true;
            }
            return null;
        })
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                auditoria_pagamento_service_1.AuditoriaPagamentoService,
                {
                    provide: common_1.Logger,
                    useValue: mockLogger
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService
                }
            ],
        }).compile();
        service = module.get(auditoria_pagamento_service_1.AuditoriaPagamentoService);
        logger = module.get(common_1.Logger);
        configService = module.get(config_1.ConfigService);
        // Limpar mocks antes de cada teste
        jest.clearAllMocks();
    });
    describe('logCriacaoPagamento', () => {
        const pagamento = {
            id: 'pagamento-id',
            solicitacaoId: 'solicitacao-id',
            valor: 500.00,
            status: status_pagamento_enum_1.StatusPagamentoEnum.AGENDADO,
            metodoPagamento: metodo_pagamento_enum_1.MetodoPagamentoEnum.PIX,
            dadosBancarios: {
                pixTipo: 'cpf',
                pixChave: '12345678909'
            }
        };
        const usuarioId = 'usuario-id';
        it('deve registrar log de criação de pagamento com dados mascarados', () => {
            // Executar método
            service.logCriacaoPagamento(pagamento, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Pagamento criado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém dados mascarados
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).not.toContain('12345678909');
            expect(logMessage).toContain('***');
        });
        it('deve registrar log sem mascaramento quando configurado', () => {
            // Alterar configuração para não mascarar dados
            mockConfigService.get.mockImplementation((key) => {
                if (key === 'auditoria.nivel') {
                    return 'completo';
                }
                if (key === 'auditoria.mascaraDados') {
                    return false;
                }
                return null;
            });
            // Executar método
            service.logCriacaoPagamento(pagamento, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Pagamento criado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém dados completos
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamento.id);
            expect(logMessage).toContain(pagamento.solicitacaoId);
        });
    });
    describe('logMudancaStatus', () => {
        const pagamentoId = 'pagamento-id';
        const statusAntigo = status_pagamento_enum_1.StatusPagamentoEnum.AGENDADO;
        const statusNovo = status_pagamento_enum_1.StatusPagamentoEnum.LIBERADO;
        const usuarioId = 'usuario-id';
        it('deve registrar log de mudança de status', () => {
            // Executar método
            service.logMudancaStatus(pagamentoId, statusAntigo, statusNovo, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Status alterado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os status
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(statusAntigo);
            expect(logMessage).toContain(statusNovo);
            expect(logMessage).toContain(pagamentoId);
        });
    });
    describe('logCancelamentoPagamento', () => {
        const pagamentoId = 'pagamento-id';
        const motivo = 'Pagamento cancelado a pedido do beneficiário';
        const usuarioId = 'usuario-id';
        it('deve registrar log de cancelamento de pagamento', () => {
            // Executar método
            service.logCancelamentoPagamento(pagamentoId, motivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Pagamento cancelado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém o motivo
            const logMessage = mockLogger.warn.mock.calls[0][0];
            expect(logMessage).toContain(motivo);
            expect(logMessage).toContain(pagamentoId);
        });
    });
    describe('logUploadComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const comprovanteId = 'comprovante-id';
        const usuarioId = 'usuario-id';
        const nomeArquivo = 'comprovante.pdf';
        it('deve registrar log de upload de comprovante', () => {
            // Executar método
            service.logUploadComprovante(pagamentoId, comprovanteId, nomeArquivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Comprovante enviado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados do comprovante
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(comprovanteId);
            expect(logMessage).toContain(nomeArquivo);
        });
    });
    describe('logRemocaoComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const comprovanteId = 'comprovante-id';
        const usuarioId = 'usuario-id';
        const motivo = 'Documento incorreto';
        it('deve registrar log de remoção de comprovante', () => {
            // Executar método
            service.logRemocaoComprovante(pagamentoId, comprovanteId, motivo, usuarioId);
            // Verificar resultado
            expect(mockLogger.warn).toHaveBeenCalledWith(expect.stringContaining('Comprovante removido'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados da remoção
            const logMessage = mockLogger.warn.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(comprovanteId);
            expect(logMessage).toContain(motivo);
        });
    });
    describe('logConfirmacaoRecebimento', () => {
        const pagamentoId = 'pagamento-id';
        const confirmacaoId = 'confirmacao-id';
        const usuarioId = 'usuario-id';
        it('deve registrar log de confirmação de recebimento', () => {
            // Executar método
            service.logConfirmacaoRecebimento(pagamentoId, confirmacaoId, usuarioId);
            // Verificar resultado
            expect(mockLogger.log).toHaveBeenCalledWith(expect.stringContaining('Recebimento confirmado'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados da confirmação
            const logMessage = mockLogger.log.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(confirmacaoId);
        });
    });
    describe('logErroProcessamento', () => {
        const pagamentoId = 'pagamento-id';
        const erro = new Error('Erro ao processar pagamento');
        const contexto = 'atualizarStatus';
        it('deve registrar log de erro de processamento', () => {
            // Executar método
            service.logErroProcessamento(pagamentoId, erro, contexto);
            // Verificar resultado
            expect(mockLogger.error).toHaveBeenCalledWith(expect.stringContaining('Erro ao processar pagamento'), expect.stringContaining('AuditoriaPagamento'));
            // Verificar que o log contém os dados do erro
            const logMessage = mockLogger.error.mock.calls[0][0];
            expect(logMessage).toContain(pagamentoId);
            expect(logMessage).toContain(contexto);
            expect(logMessage).toContain(erro.message);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxhdWRpdG9yaWEtcGFnYW1lbnRvLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCw0RkFBdUY7QUFDdkYsMkNBQStDO0FBQy9DLDJDQUF3QztBQUN4Qyw2RUFBd0U7QUFDeEUsNkVBQXdFO0FBRXhFOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksT0FBa0MsQ0FBQztJQUN2QyxJQUFJLE1BQWMsQ0FBQztJQUNuQixJQUFJLGFBQTRCLENBQUM7SUFFakMsaUJBQWlCO0lBQ2pCLE1BQU0sVUFBVSxHQUFHO1FBQ2pCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNqQixDQUFDO0lBRUYsd0JBQXdCO0lBQ3hCLE1BQU0saUJBQWlCLEdBQUc7UUFDeEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3hDLElBQUksR0FBRyxLQUFLLGlCQUFpQixFQUFFLENBQUM7Z0JBQUEsT0FBTyxVQUFVLENBQUM7WUFBQSxDQUFDO1lBQ25ELElBQUksR0FBRyxLQUFLLHdCQUF3QixFQUFFLENBQUM7Z0JBQUEsT0FBTyxJQUFJLENBQUM7WUFBQSxDQUFDO1lBQ3BELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDO0tBQ0gsQ0FBQztJQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFB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Q0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxwYWdhbWVudG9cXHRlc3RzXFxzZXJ2aWNlc1xcYXVkaXRvcmlhLXBhZ2FtZW50by5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBBdWRpdG9yaWFQYWdhbWVudG9TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvYXVkaXRvcmlhLXBhZ2FtZW50by5zZXJ2aWNlJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBTdGF0dXNQYWdhbWVudG9FbnVtIH0gZnJvbSAnLi4vLi4vZW51bXMvc3RhdHVzLXBhZ2FtZW50by5lbnVtJztcbmltcG9ydCB7IE1ldG9kb1BhZ2FtZW50b0VudW0gfSBmcm9tICcuLi8uLi9lbnVtcy9tZXRvZG8tcGFnYW1lbnRvLmVudW0nO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgbyBzZXJ2acOnbyBkZSBhdWRpdG9yaWEgZGUgcGFnYW1lbnRvXG4gKiBcbiAqIFZlcmlmaWNhIG8gZnVuY2lvbmFtZW50byBjb3JyZXRvIGRhcyBvcGVyYcOnw7VlcyBkZSByZWdpc3RybyBkZSBsb2dzXG4gKiBwYXJhIGHDp8O1ZXMgc2Vuc8OtdmVpcyByZWxhY2lvbmFkYXMgYSBwYWdhbWVudG9zLlxuICogXG4gKiBAYXV0aG9yIEVxdWlwZSBQR0JlblxuICovXG5kZXNjcmliZSgnQXVkaXRvcmlhUGFnYW1lbnRvU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2U7XG4gIGxldCBsb2dnZXI6IExvZ2dlcjtcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2U7XG5cbiAgLy8gTW9jayBkbyBMb2dnZXJcbiAgY29uc3QgbW9ja0xvZ2dlciA9IHtcbiAgICBsb2c6IGplc3QuZm4oKSxcbiAgICB3YXJuOiBqZXN0LmZuKCksXG4gICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICBkZWJ1ZzogamVzdC5mbigpXG4gIH07XG5cbiAgLy8gTW9jayBkbyBDb25maWdTZXJ2aWNlXG4gIGNvbnN0IG1vY2tDb25maWdTZXJ2aWNlID0ge1xuICAgIGdldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoa2V5KSA9PiB7XG4gICAgICBpZiAoa2V5ID09PSAnYXVkaXRvcmlhLm5pdmVsJykge3JldHVybiAnY29tcGxldG8nO31cbiAgICAgIGlmIChrZXkgPT09ICdhdWRpdG9yaWEubWFzY2FyYURhZG9zJykge3JldHVybiB0cnVlO31cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0pXG4gIH07XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBBdWRpdG9yaWFQYWdhbWVudG9TZXJ2aWNlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogTG9nZ2VyLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrTG9nZ2VyXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQ29uZmlnU2VydmljZVxuICAgICAgICB9XG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2U+KEF1ZGl0b3JpYVBhZ2FtZW50b1NlcnZpY2UpO1xuICAgIGxvZ2dlciA9IG1vZHVsZS5nZXQ8TG9nZ2VyPihMb2dnZXIpO1xuICAgIGNvbmZpZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PENvbmZpZ1NlcnZpY2U+KENvbmZpZ1NlcnZpY2UpO1xuXG4gICAgLy8gTGltcGFyIG1vY2tzIGFudGVzIGRlIGNhZGEgdGVzdGVcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ0NyaWFjYW9QYWdhbWVudG8nLCAoKSA9PiB7XG4gICAgY29uc3QgcGFnYW1lbnRvID0ge1xuICAgICAgaWQ6ICdwYWdhbWVudG8taWQnLFxuICAgICAgc29saWNpdGFjYW9JZDogJ3NvbGljaXRhY2FvLWlkJyxcbiAgICAgIHZhbG9yOiA1MDAuMDAsXG4gICAgICBzdGF0dXM6IFN0YXR1c1BhZ2FtZW50b0VudW0uQUdFTkRBRE8sXG4gICAgICBtZXRvZG9QYWdhbWVudG86IE1ldG9kb1BhZ2FtZW50b0VudW0uUElYLFxuICAgICAgZGFkb3NCYW5jYXJpb3M6IHtcbiAgICAgICAgcGl4VGlwbzogJ2NwZicsXG4gICAgICAgIHBpeENoYXZlOiAnMTIzNDU2Nzg5MDknXG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB1c3VhcmlvSWQgPSAndXN1YXJpby1pZCc7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIGNyaWHDp8OjbyBkZSBwYWdhbWVudG8gY29tIGRhZG9zIG1hc2NhcmFkb3MnLCAoKSA9PiB7XG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBzZXJ2aWNlLmxvZ0NyaWFjYW9QYWdhbWVudG8ocGFnYW1lbnRvLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnUGFnYW1lbnRvIGNyaWFkbycpLFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXVkaXRvcmlhUGFnYW1lbnRvJylcbiAgICAgICk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBkYWRvcyBtYXNjYXJhZG9zXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci5sb2cubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS5ub3QudG9Db250YWluKCcxMjM0NTY3ODkwOScpO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbignKioqJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIHNlbSBtYXNjYXJhbWVudG8gcXVhbmRvIGNvbmZpZ3VyYWRvJywgKCkgPT4ge1xuICAgICAgLy8gQWx0ZXJhciBjb25maWd1cmHDp8OjbyBwYXJhIG7Do28gbWFzY2FyYXIgZGFkb3NcbiAgICAgIG1vY2tDb25maWdTZXJ2aWNlLmdldC5tb2NrSW1wbGVtZW50YXRpb24oKGtleSkgPT4ge1xuICAgICAgICBpZiAoa2V5ID09PSAnYXVkaXRvcmlhLm5pdmVsJykge3JldHVybiAnY29tcGxldG8nO31cbiAgICAgICAgaWYgKGtleSA9PT0gJ2F1ZGl0b3JpYS5tYXNjYXJhRGFkb3MnKSB7cmV0dXJuIGZhbHNlO31cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9KTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dDcmlhY2FvUGFnYW1lbnRvKHBhZ2FtZW50bywgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIubG9nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1BhZ2FtZW50byBjcmlhZG8nKSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0F1ZGl0b3JpYVBhZ2FtZW50bycpXG4gICAgICApO1xuICAgICAgXG4gICAgICAvLyBWZXJpZmljYXIgcXVlIG8gbG9nIGNvbnTDqW0gZGFkb3MgY29tcGxldG9zXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci5sb2cubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvLmlkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvLnNvbGljaXRhY2FvSWQpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbG9nTXVkYW5jYVN0YXR1cycsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQnO1xuICAgIGNvbnN0IHN0YXR1c0FudGlnbyA9IFN0YXR1c1BhZ2FtZW50b0VudW0uQUdFTkRBRE87XG4gICAgY29uc3Qgc3RhdHVzTm92byA9IFN0YXR1c1BhZ2FtZW50b0VudW0uTElCRVJBRE87XG4gICAgY29uc3QgdXN1YXJpb0lkID0gJ3VzdWFyaW8taWQnO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSBtdWRhbsOnYSBkZSBzdGF0dXMnLCAoKSA9PiB7XG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBzZXJ2aWNlLmxvZ011ZGFuY2FTdGF0dXMocGFnYW1lbnRvSWQsIHN0YXR1c0FudGlnbywgc3RhdHVzTm92bywgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIubG9nKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ1N0YXR1cyBhbHRlcmFkbycpLFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXVkaXRvcmlhUGFnYW1lbnRvJylcbiAgICAgICk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBzdGF0dXNcbiAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBtb2NrTG9nZ2VyLmxvZy5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihzdGF0dXNBbnRpZ28pO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihzdGF0dXNOb3ZvKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbG9nQ2FuY2VsYW1lbnRvUGFnYW1lbnRvJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgbW90aXZvID0gJ1BhZ2FtZW50byBjYW5jZWxhZG8gYSBwZWRpZG8gZG8gYmVuZWZpY2nDoXJpbyc7XG4gICAgY29uc3QgdXN1YXJpb0lkID0gJ3VzdWFyaW8taWQnO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSBjYW5jZWxhbWVudG8gZGUgcGFnYW1lbnRvJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dDYW5jZWxhbWVudG9QYWdhbWVudG8ocGFnYW1lbnRvSWQsIG1vdGl2bywgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdQYWdhbWVudG8gY2FuY2VsYWRvJyksXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBdWRpdG9yaWFQYWdhbWVudG8nKVxuICAgICAgKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZpY2FyIHF1ZSBvIGxvZyBjb250w6ltIG8gbW90aXZvXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci53YXJuLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKG1vdGl2byk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50b0lkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ1VwbG9hZENvbXByb3ZhbnRlJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgY29tcHJvdmFudGVJZCA9ICdjb21wcm92YW50ZS1pZCc7XG4gICAgY29uc3QgdXN1YXJpb0lkID0gJ3VzdWFyaW8taWQnO1xuICAgIGNvbnN0IG5vbWVBcnF1aXZvID0gJ2NvbXByb3ZhbnRlLnBkZic7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIHVwbG9hZCBkZSBjb21wcm92YW50ZScsICgpID0+IHtcbiAgICAgIC8vIEV4ZWN1dGFyIG3DqXRvZG9cbiAgICAgIHNlcnZpY2UubG9nVXBsb2FkQ29tcHJvdmFudGUocGFnYW1lbnRvSWQsIGNvbXByb3ZhbnRlSWQsIG5vbWVBcnF1aXZvLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQ29tcHJvdmFudGUgZW52aWFkbycpLFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXVkaXRvcmlhUGFnYW1lbnRvJylcbiAgICAgICk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBkYWRvcyBkbyBjb21wcm92YW50ZVxuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIubG9nLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50b0lkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4oY29tcHJvdmFudGVJZCk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKG5vbWVBcnF1aXZvKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ1JlbW9jYW9Db21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQnO1xuICAgIGNvbnN0IGNvbXByb3ZhbnRlSWQgPSAnY29tcHJvdmFudGUtaWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcbiAgICBjb25zdCBtb3Rpdm8gPSAnRG9jdW1lbnRvIGluY29ycmV0byc7XG5cbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgbG9nIGRlIHJlbW/Dp8OjbyBkZSBjb21wcm92YW50ZScsICgpID0+IHtcbiAgICAgIC8vIEV4ZWN1dGFyIG3DqXRvZG9cbiAgICAgIHNlcnZpY2UubG9nUmVtb2Nhb0NvbXByb3ZhbnRlKHBhZ2FtZW50b0lkLCBjb21wcm92YW50ZUlkLCBtb3Rpdm8sIHVzdWFyaW9JZCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLndhcm4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQ29tcHJvdmFudGUgcmVtb3ZpZG8nKSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0F1ZGl0b3JpYVBhZ2FtZW50bycpXG4gICAgICApO1xuICAgICAgXG4gICAgICAvLyBWZXJpZmljYXIgcXVlIG8gbG9nIGNvbnTDqW0gb3MgZGFkb3MgZGEgcmVtb8Onw6NvXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci53YXJuLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKHBhZ2FtZW50b0lkKTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4oY29tcHJvdmFudGVJZCk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKG1vdGl2byk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsb2dDb25maXJtYWNhb1JlY2ViaW1lbnRvJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgY29uZmlybWFjYW9JZCA9ICdjb25maXJtYWNhby1pZCc7XG4gICAgY29uc3QgdXN1YXJpb0lkID0gJ3VzdWFyaW8taWQnO1xuXG4gICAgaXQoJ2RldmUgcmVnaXN0cmFyIGxvZyBkZSBjb25maXJtYcOnw6NvIGRlIHJlY2ViaW1lbnRvJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dDb25maXJtYWNhb1JlY2ViaW1lbnRvKHBhZ2FtZW50b0lkLCBjb25maXJtYWNhb0lkLCB1c3VhcmlvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnUmVjZWJpbWVudG8gY29uZmlybWFkbycpLFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnQXVkaXRvcmlhUGFnYW1lbnRvJylcbiAgICAgICk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmaWNhciBxdWUgbyBsb2cgY29udMOpbSBvcyBkYWRvcyBkYSBjb25maXJtYcOnw6NvXG4gICAgICBjb25zdCBsb2dNZXNzYWdlID0gbW9ja0xvZ2dlci5sb2cubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihjb25maXJtYWNhb0lkKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZ0Vycm9Qcm9jZXNzYW1lbnRvJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZCc7XG4gICAgY29uc3QgZXJybyA9IG5ldyBFcnJvcignRXJybyBhbyBwcm9jZXNzYXIgcGFnYW1lbnRvJyk7XG4gICAgY29uc3QgY29udGV4dG8gPSAnYXR1YWxpemFyU3RhdHVzJztcblxuICAgIGl0KCdkZXZlIHJlZ2lzdHJhciBsb2cgZGUgZXJybyBkZSBwcm9jZXNzYW1lbnRvJywgKCkgPT4ge1xuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgc2VydmljZS5sb2dFcnJvUHJvY2Vzc2FtZW50byhwYWdhbWVudG9JZCwgZXJybywgY29udGV4dG8pO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdFcnJvIGFvIHByb2Nlc3NhciBwYWdhbWVudG8nKSxcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ0F1ZGl0b3JpYVBhZ2FtZW50bycpXG4gICAgICApO1xuICAgICAgXG4gICAgICAvLyBWZXJpZmljYXIgcXVlIG8gbG9nIGNvbnTDqW0gb3MgZGFkb3MgZG8gZXJyb1xuICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IG1vY2tMb2dnZXIuZXJyb3IubW9jay5jYWxsc1swXVswXTtcbiAgICAgIGV4cGVjdChsb2dNZXNzYWdlKS50b0NvbnRhaW4ocGFnYW1lbnRvSWQpO1xuICAgICAgZXhwZWN0KGxvZ01lc3NhZ2UpLnRvQ29udGFpbihjb250ZXh0byk7XG4gICAgICBleHBlY3QobG9nTWVzc2FnZSkudG9Db250YWluKGVycm8ubWVzc2FnZSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=