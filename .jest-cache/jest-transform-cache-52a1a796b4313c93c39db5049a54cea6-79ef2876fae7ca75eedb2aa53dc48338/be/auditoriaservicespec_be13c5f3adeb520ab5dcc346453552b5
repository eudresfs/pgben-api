c62221d37ef2e632985e00f7f4fd9e44
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const auditoria_service_1 = require("../services/auditoria.service");
const entities_1 = require("../../../entities");
const create_log_auditoria_dto_1 = require("../dto/create-log-auditoria.dto");
const tipo_operacao_enum_1 = require("../../auditoria/enums/tipo-operacao.enum");
const mockLogAuditoriaRepository = () => ({
    create: jest.fn(),
    save: jest.fn(),
    findOne: jest.fn(),
    find: jest.fn(),
    createQueryBuilder: jest.fn(() => ({
        where: jest.fn().mockReturnThis(),
        andWhere: jest.fn().mockReturnThis(),
        orderBy: jest.fn().mockReturnThis(),
        skip: jest.fn().mockReturnThis(),
        take: jest.fn().mockReturnThis(),
        getManyAndCount: jest.fn(),
    })),
});
describe('AuditoriaService', () => {
    let service;
    let repository;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                auditoria_service_1.AuditoriaService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(entities_1.LogAuditoria),
                    useFactory: mockLogAuditoriaRepository,
                },
            ],
        }).compile();
        service = module.get(auditoria_service_1.AuditoriaService);
        repository = module.get((0, typeorm_1.getRepositoryToken)(entities_1.LogAuditoria));
    });
    it('deve ser definido', () => {
        expect(service).toBeDefined();
    });
    describe('create', () => {
        it('deve criar um log de auditoria', async () => {
            const dto = new create_log_auditoria_dto_1.CreateLogAuditoriaDto();
            dto.tipo_operacao = tipo_operacao_enum_1.TipoOperacao.CREATE;
            dto.entidade_afetada = 'Documento';
            dto.entidade_id = '123';
            dto.descricao = 'Criação de documento';
            dto.dados_anteriores = {};
            dto.dados_novos = { nome: 'Documento 1' };
            dto.usuario_id = 'user-123';
            dto.ip_origem = '127.0.0.1';
            const createLogAuditoriaDto = dto;
            const logAuditoria = new entities_1.LogAuditoria();
            Object.assign(logAuditoria, createLogAuditoriaDto, { id: 'log-123' });
            jest.spyOn(repository, 'create').mockReturnValue(logAuditoria);
            jest.spyOn(repository, 'save').mockResolvedValue(logAuditoria);
            const result = await service.create(createLogAuditoriaDto);
            expect(repository.create).toHaveBeenCalledWith(createLogAuditoriaDto);
            expect(repository.save).toHaveBeenCalledWith(logAuditoria);
            expect(result).toEqual(logAuditoria);
        });
    });
    describe('findAll', () => {
        it('deve retornar logs de auditoria paginados', async () => {
            const queryParams = {
                pagina: 1,
                itens_por_pagina: 10,
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'Documento',
                usuario_id: 'user-123',
                data_inicial: '2025-01-01T00:00:00Z',
                data_final: '2025-01-31T23:59:59Z',
            };
            const logs = [new entities_1.LogAuditoria(), new entities_1.LogAuditoria()];
            const count = 2;
            const queryBuilder = repository.createQueryBuilder();
            jest
                .spyOn(queryBuilder, 'getManyAndCount')
                .mockResolvedValue([logs, count]);
            const result = await service.findAll(queryParams);
            expect(repository.createQueryBuilder).toHaveBeenCalled();
            expect(queryBuilder.where).toHaveBeenCalled();
            expect(queryBuilder.andWhere).toHaveBeenCalledTimes(4);
            expect(queryBuilder.orderBy).toHaveBeenCalled();
            expect(queryBuilder.skip).toHaveBeenCalledWith(0);
            expect(queryBuilder.take).toHaveBeenCalledWith(10);
            expect(result).toEqual({
                data: logs,
                total: count,
                page: 1,
                limit: 10,
                totalPages: 1,
            });
        });
    });
    describe('findOne', () => {
        it('deve retornar um log de auditoria pelo ID', async () => {
            const logId = 'log-123';
            const logAuditoria = new entities_1.LogAuditoria();
            logAuditoria.id = logId;
            jest.spyOn(repository, 'findOne').mockResolvedValue(logAuditoria);
            const result = await service.findOne(logId);
            expect(repository.findOne).toHaveBeenCalledWith({ where: { id: logId } });
            expect(result).toEqual(logAuditoria);
        });
        it('deve retornar null quando o log não existe', async () => {
            const logId = 'non-existent-id';
            jest.spyOn(repository, 'findOne').mockResolvedValue(null);
            const result = await service.findOne(logId);
            expect(repository.findOne).toHaveBeenCalledWith({ where: { id: logId } });
            expect(result).toBeNull();
        });
    });
    describe('exportarLogs', () => {
        it('deve exportar logs de auditoria', async () => {
            const queryParams = {
                tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                entidade_afetada: 'Documento',
                usuario_id: 'user-123',
                data_inicial: '2025-01-01T00:00:00Z',
                data_final: '2025-01-31T23:59:59Z',
            };
            const logs = [
                {
                    id: 'log-1',
                    tipo_operacao: tipo_operacao_enum_1.TipoOperacao.CREATE,
                    entidade_afetada: 'Documento',
                    entidade_id: 'doc-1',
                    descricao: 'Criação de documento',
                    created_at: new Date('2025-01-15'),
                    usuario_id: 'user-123',
                },
                {
                    id: 'log-2',
                    tipo_operacao: tipo_operacao_enum_1.TipoOperacao.UPDATE,
                    entidade_afetada: 'Documento',
                    entidade_id: 'doc-1',
                    descricao: 'Atualização de documento',
                    created_at: new Date('2025-01-16'),
                    usuario_id: 'user-123',
                },
            ];
            jest.spyOn(repository, 'find').mockResolvedValue(logs);
            // Adicionando o método exportarLogs ao serviço para o teste
            service['exportarLogs'] = jest.fn().mockResolvedValue(logs);
            const result = await service['exportarLogs'](queryParams);
            expect(repository.find).toHaveBeenCalled();
            expect(result).toHaveLength(2);
            expect(result[0]).toHaveProperty('id', 'log-1');
            expect(result[1]).toHaveProperty('id', 'log-2');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcdGVzdHNcXGF1ZGl0b3JpYS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsNkNBQXFEO0FBRXJELHFFQUFpRTtBQUNqRSxnREFBaUQ7QUFDakQsOEVBQXdFO0FBQ3hFLGlGQUF3RTtBQUd4RSxNQUFNLDBCQUEwQixHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNmLGtCQUFrQixFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNqQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNqQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNwQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNuQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNoQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNoQyxlQUFlLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUMzQixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO0lBQ2hDLElBQUksT0FBeUIsQ0FBQztJQUM5QixJQUFJLFVBQW9DLENBQUM7SUFFekMsVUFBVSxDQUFDLEtBQUssSUFBSSxF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LFdBQVcsQ0FBQyxDQUFDO1lBRTFELE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMzQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcYXVkaXRvcmlhXFx0ZXN0c1xcYXVkaXRvcmlhLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQgeyBBdWRpdG9yaWFTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYXVkaXRvcmlhLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nQXVkaXRvcmlhIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMnO1xuaW1wb3J0IHsgQ3JlYXRlTG9nQXVkaXRvcmlhRHRvIH0gZnJvbSAnLi4vZHRvL2NyZWF0ZS1sb2ctYXVkaXRvcmlhLmR0byc7XG5pbXBvcnQgeyBUaXBvT3BlcmFjYW8gfSBmcm9tICcuLi8uLi9hdWRpdG9yaWEvZW51bXMvdGlwby1vcGVyYWNhby5lbnVtJztcbmltcG9ydCB7IFF1ZXJ5TG9nQXVkaXRvcmlhRHRvIH0gZnJvbSAnLi4vZHRvL3F1ZXJ5LWxvZy1hdWRpdG9yaWEuZHRvJztcblxuY29uc3QgbW9ja0xvZ0F1ZGl0b3JpYVJlcG9zaXRvcnkgPSAoKSA9PiAoe1xuICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgc2F2ZTogamVzdC5mbigpLFxuICBmaW5kT25lOiBqZXN0LmZuKCksXG4gIGZpbmQ6IGplc3QuZm4oKSxcbiAgY3JlYXRlUXVlcnlCdWlsZGVyOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIGFuZFdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICBvcmRlckJ5OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICBza2lwOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICB0YWtlOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICBnZXRNYW55QW5kQ291bnQ6IGplc3QuZm4oKSxcbiAgfSkpLFxufSk7XG5cbmRlc2NyaWJlKCdBdWRpdG9yaWFTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogQXVkaXRvcmlhU2VydmljZTtcbiAgbGV0IHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8TG9nQXVkaXRvcmlhPjtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIEF1ZGl0b3JpYVNlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oTG9nQXVkaXRvcmlhKSxcbiAgICAgICAgICB1c2VGYWN0b3J5OiBtb2NrTG9nQXVkaXRvcmlhUmVwb3NpdG9yeSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8QXVkaXRvcmlhU2VydmljZT4oQXVkaXRvcmlhU2VydmljZSk7XG4gICAgcmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8UmVwb3NpdG9yeTxMb2dBdWRpdG9yaWE+PihcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihMb2dBdWRpdG9yaWEpLFxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIHNlciBkZWZpbmlkbycsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZScsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBjcmlhciB1bSBsb2cgZGUgYXVkaXRvcmlhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZHRvID0gbmV3IENyZWF0ZUxvZ0F1ZGl0b3JpYUR0bygpO1xuICAgICAgZHRvLnRpcG9fb3BlcmFjYW8gPSBUaXBvT3BlcmFjYW8uQ1JFQVRFO1xuICAgICAgZHRvLmVudGlkYWRlX2FmZXRhZGEgPSAnRG9jdW1lbnRvJztcbiAgICAgIGR0by5lbnRpZGFkZV9pZCA9ICcxMjMnO1xuICAgICAgZHRvLmRlc2NyaWNhbyA9ICdDcmlhw6fDo28gZGUgZG9jdW1lbnRvJztcbiAgICAgIGR0by5kYWRvc19hbnRlcmlvcmVzID0ge307XG4gICAgICBkdG8uZGFkb3Nfbm92b3MgPSB7IG5vbWU6ICdEb2N1bWVudG8gMScgfTtcbiAgICAgIGR0by51c3VhcmlvX2lkID0gJ3VzZXItMTIzJztcbiAgICAgIGR0by5pcF9vcmlnZW0gPSAnMTI3LjAuMC4xJztcblxuICAgICAgY29uc3QgY3JlYXRlTG9nQXVkaXRvcmlhRHRvID0gZHRvO1xuXG4gICAgICBjb25zdCBsb2dBdWRpdG9yaWEgPSBuZXcgTG9nQXVkaXRvcmlhKCk7XG4gICAgICBPYmplY3QuYXNzaWduKGxvZ0F1ZGl0b3JpYSwgY3JlYXRlTG9nQXVkaXRvcmlhRHRvLCB7IGlkOiAnbG9nLTEyMycgfSk7XG5cbiAgICAgIGplc3Quc3B5T24ocmVwb3NpdG9yeSwgJ2NyZWF0ZScpLm1vY2tSZXR1cm5WYWx1ZShsb2dBdWRpdG9yaWEpO1xuICAgICAgamVzdC5zcHlPbihyZXBvc2l0b3J5LCAnc2F2ZScpLm1vY2tSZXNvbHZlZFZhbHVlKGxvZ0F1ZGl0b3JpYSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuY3JlYXRlKGNyZWF0ZUxvZ0F1ZGl0b3JpYUR0byk7XG5cbiAgICAgIGV4cGVjdChyZXBvc2l0b3J5LmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY3JlYXRlTG9nQXVkaXRvcmlhRHRvKTtcbiAgICAgIGV4cGVjdChyZXBvc2l0b3J5LnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGxvZ0F1ZGl0b3JpYSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGxvZ0F1ZGl0b3JpYSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdmaW5kQWxsJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIGxvZ3MgZGUgYXVkaXRvcmlhIHBhZ2luYWRvcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zOiBRdWVyeUxvZ0F1ZGl0b3JpYUR0byA9IHtcbiAgICAgICAgcGFnaW5hOiAxLFxuICAgICAgICBpdGVuc19wb3JfcGFnaW5hOiAxMCxcbiAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLkNSRUFURSxcbiAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ0RvY3VtZW50bycsXG4gICAgICAgIHVzdWFyaW9faWQ6ICd1c2VyLTEyMycsXG4gICAgICAgIGRhdGFfaW5pY2lhbDogJzIwMjUtMDEtMDFUMDA6MDA6MDBaJyxcbiAgICAgICAgZGF0YV9maW5hbDogJzIwMjUtMDEtMzFUMjM6NTk6NTlaJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGxvZ3MgPSBbbmV3IExvZ0F1ZGl0b3JpYSgpLCBuZXcgTG9nQXVkaXRvcmlhKCldO1xuICAgICAgY29uc3QgY291bnQgPSAyO1xuXG4gICAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSByZXBvc2l0b3J5LmNyZWF0ZVF1ZXJ5QnVpbGRlcigpO1xuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocXVlcnlCdWlsZGVyLCAnZ2V0TWFueUFuZENvdW50JylcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKFtsb2dzLCBjb3VudF0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmZpbmRBbGwocXVlcnlQYXJhbXMpO1xuXG4gICAgICBleHBlY3QocmVwb3NpdG9yeS5jcmVhdGVRdWVyeUJ1aWxkZXIpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChxdWVyeUJ1aWxkZXIud2hlcmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChxdWVyeUJ1aWxkZXIuYW5kV2hlcmUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcyg0KTtcbiAgICAgIGV4cGVjdChxdWVyeUJ1aWxkZXIub3JkZXJCeSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHF1ZXJ5QnVpbGRlci5za2lwKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgwKTtcbiAgICAgIGV4cGVjdChxdWVyeUJ1aWxkZXIudGFrZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoMTApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICAgIGRhdGE6IGxvZ3MsXG4gICAgICAgIHRvdGFsOiBjb3VudCxcbiAgICAgICAgcGFnZTogMSxcbiAgICAgICAgbGltaXQ6IDEwLFxuICAgICAgICB0b3RhbFBhZ2VzOiAxLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdmaW5kT25lJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIHVtIGxvZyBkZSBhdWRpdG9yaWEgcGVsbyBJRCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ0lkID0gJ2xvZy0xMjMnO1xuICAgICAgY29uc3QgbG9nQXVkaXRvcmlhID0gbmV3IExvZ0F1ZGl0b3JpYSgpO1xuICAgICAgbG9nQXVkaXRvcmlhLmlkID0gbG9nSWQ7XG5cbiAgICAgIGplc3Quc3B5T24ocmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShsb2dBdWRpdG9yaWEpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmZpbmRPbmUobG9nSWQpO1xuXG4gICAgICBleHBlY3QocmVwb3NpdG9yeS5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IHdoZXJlOiB7IGlkOiBsb2dJZCB9IH0pO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChsb2dBdWRpdG9yaWEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgbnVsbCBxdWFuZG8gbyBsb2cgbsOjbyBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dJZCA9ICdub24tZXhpc3RlbnQtaWQnO1xuXG4gICAgICBqZXN0LnNweU9uKHJlcG9zaXRvcnksICdmaW5kT25lJykubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZmluZE9uZShsb2dJZCk7XG5cbiAgICAgIGV4cGVjdChyZXBvc2l0b3J5LmZpbmRPbmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgd2hlcmU6IHsgaWQ6IGxvZ0lkIH0gfSk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZXhwb3J0YXJMb2dzJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIGV4cG9ydGFyIGxvZ3MgZGUgYXVkaXRvcmlhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnlQYXJhbXM6IFF1ZXJ5TG9nQXVkaXRvcmlhRHRvID0ge1xuICAgICAgICB0aXBvX29wZXJhY2FvOiBUaXBvT3BlcmFjYW8uQ1JFQVRFLFxuICAgICAgICBlbnRpZGFkZV9hZmV0YWRhOiAnRG9jdW1lbnRvJyxcbiAgICAgICAgdXN1YXJpb19pZDogJ3VzZXItMTIzJyxcbiAgICAgICAgZGF0YV9pbmljaWFsOiAnMjAyNS0wMS0wMVQwMDowMDowMFonLFxuICAgICAgICBkYXRhX2ZpbmFsOiAnMjAyNS0wMS0zMVQyMzo1OTo1OVonLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbG9ncyA9IFtcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAnbG9nLTEnLFxuICAgICAgICAgIHRpcG9fb3BlcmFjYW86IFRpcG9PcGVyYWNhby5DUkVBVEUsXG4gICAgICAgICAgZW50aWRhZGVfYWZldGFkYTogJ0RvY3VtZW50bycsXG4gICAgICAgICAgZW50aWRhZGVfaWQ6ICdkb2MtMScsXG4gICAgICAgICAgZGVzY3JpY2FvOiAnQ3JpYcOnw6NvIGRlIGRvY3VtZW50bycsXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoJzIwMjUtMDEtMTUnKSxcbiAgICAgICAgICB1c3VhcmlvX2lkOiAndXNlci0xMjMnLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdsb2ctMicsXG4gICAgICAgICAgdGlwb19vcGVyYWNhbzogVGlwb09wZXJhY2FvLlVQREFURSxcbiAgICAgICAgICBlbnRpZGFkZV9hZmV0YWRhOiAnRG9jdW1lbnRvJyxcbiAgICAgICAgICBlbnRpZGFkZV9pZDogJ2RvYy0xJyxcbiAgICAgICAgICBkZXNjcmljYW86ICdBdHVhbGl6YcOnw6NvIGRlIGRvY3VtZW50bycsXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoJzIwMjUtMDEtMTYnKSxcbiAgICAgICAgICB1c3VhcmlvX2lkOiAndXNlci0xMjMnLFxuICAgICAgICB9LFxuICAgICAgXTtcblxuICAgICAgamVzdC5zcHlPbihyZXBvc2l0b3J5LCAnZmluZCcpLm1vY2tSZXNvbHZlZFZhbHVlKGxvZ3MgYXMgTG9nQXVkaXRvcmlhW10pO1xuXG4gICAgICAvLyBBZGljaW9uYW5kbyBvIG3DqXRvZG8gZXhwb3J0YXJMb2dzIGFvIHNlcnZpw6dvIHBhcmEgbyB0ZXN0ZVxuICAgICAgc2VydmljZVsnZXhwb3J0YXJMb2dzJ10gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobG9ncyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2VbJ2V4cG9ydGFyTG9ncyddKHF1ZXJ5UGFyYW1zKTtcblxuICAgICAgZXhwZWN0KHJlcG9zaXRvcnkuZmluZCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlTGVuZ3RoKDIpO1xuICAgICAgZXhwZWN0KHJlc3VsdFswXSkudG9IYXZlUHJvcGVydHkoJ2lkJywgJ2xvZy0xJyk7XG4gICAgICBleHBlY3QocmVzdWx0WzFdKS50b0hhdmVQcm9wZXJ0eSgnaWQnLCAnbG9nLTInKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==