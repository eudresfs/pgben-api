7ac18bb57e2f0651bc659b821a6a23d7
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DadosNatalidadeRepository = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("typeorm");
const dados_natalidade_entity_1 = require("../../../entities/dados-natalidade.entity");
/**
 * Repositório customizado para DadosNatalidade
 * Extende o repositório base do TypeORM com métodos específicos
 */
let DadosNatalidadeRepository = class DadosNatalidadeRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(dados_natalidade_entity_1.DadosNatalidade, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Buscar dados de natalidade por solicitação com relacionamentos
     */
    async findBySolicitacaoWithRelations(solicitacaoId) {
        return this.findOne({
            where: { solicitacao_id: solicitacaoId },
            relations: [
                'solicitacao',
                'solicitacao.cidadao',
                'solicitacao.tipo_beneficio',
            ],
        });
    }
    /**
     * Buscar dados de natalidade por período de nascimento
     */
    async findByPeriodoNascimento(dataInicio, dataFim) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.data_nascimento BETWEEN :dataInicio AND :dataFim', {
            dataInicio,
            dataFim,
        })
            .orderBy('dados.data_nascimento', 'DESC')
            .getMany();
    }
    /**
     * Buscar dados de natalidade por tipo de parto
     */
    async findByTipoParto(tipoParto) {
        return this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao')
            .where('dados.tipo_parto = :tipoParto', { tipoParto })
            .orderBy('dados.created_at', 'DESC')
            .getMany();
    }
    /**
     * Contar solicitações por hospital
     */
    async countByHospital() {
        return this.createQueryBuilder('dados')
            .select('dados.hospital_nascimento', 'hospital')
            .addSelect('COUNT(*)', 'total')
            .groupBy('dados.hospital_nascimento')
            .orderBy('total', 'DESC')
            .getRawMany();
    }
    /**
     * Buscar estatísticas de natalidade
     */
    async getEstatisticas() {
        const totalNascimentos = await this.count();
        // Estatísticas por tipo de parto
        const porTipoPartoResult = await this.createQueryBuilder('dados')
            .select('dados.tipo_parto', 'tipo')
            .addSelect('COUNT(*)', 'quantidade')
            .groupBy('dados.tipo_parto')
            .getRawMany();
        const porTipoParto = porTipoPartoResult.reduce((acc, item) => {
            acc[item.tipo] = parseInt(item.quantidade);
            return acc;
        }, {});
        // Estatísticas por hospital
        const porHospitalResult = await this.createQueryBuilder('dados')
            .select('dados.hospital_nascimento', 'hospital')
            .addSelect('COUNT(*)', 'quantidade')
            .groupBy('dados.hospital_nascimento')
            .getRawMany();
        const porHospital = porHospitalResult.reduce((acc, item) => {
            acc[item.hospital] = parseInt(item.quantidade);
            return acc;
        }, {});
        // Média de idade gestacional
        const mediaIdadeResult = await this.createQueryBuilder('dados')
            .select('AVG(dados.idade_gestacional)', 'media')
            .where('dados.idade_gestacional IS NOT NULL')
            .getRawOne();
        const mediaIdadeGestacional = parseFloat(mediaIdadeResult.media) || 0;
        return {
            totalNascimentos,
            porTipoParto,
            porHospital,
            mediaIdadeGestacional,
        };
    }
    /**
     * Verificar duplicatas por dados do bebê
     */
    async findDuplicatesByBaby(nomeBebe, dataNascimento, excludeId) {
        const query = this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .where('LOWER(dados.nome_completo_bebe) = LOWER(:nomeBebe)', { nomeBebe })
            .andWhere('dados.data_nascimento = :dataNascimento', { dataNascimento });
        if (excludeId) {
            query.andWhere('dados.id != :excludeId', { excludeId });
        }
        return query.getMany();
    }
    /**
     * Buscar dados de natalidade com filtros avançados
     */
    async findWithFilters(filters) {
        const query = this.createQueryBuilder('dados')
            .leftJoinAndSelect('dados.solicitacao', 'solicitacao')
            .leftJoinAndSelect('solicitacao.cidadao', 'cidadao');
        if (filters.dataInicio && filters.dataFim) {
            query.andWhere('dados.data_nascimento BETWEEN :dataInicio AND :dataFim', {
                dataInicio: filters.dataInicio,
                dataFim: filters.dataFim,
            });
        }
        if (filters.tipoParto) {
            query.andWhere('dados.tipo_parto = :tipoParto', {
                tipoParto: filters.tipoParto,
            });
        }
        if (filters.hospital) {
            query.andWhere('LOWER(dados.hospital_nascimento) LIKE LOWER(:hospital)', {
                hospital: `%${filters.hospital}%`,
            });
        }
        if (filters.idadeGestacionalMin) {
            query.andWhere('dados.idade_gestacional >= :idadeMin', {
                idadeMin: filters.idadeGestacionalMin,
            });
        }
        if (filters.idadeGestacionalMax) {
            query.andWhere('dados.idade_gestacional <= :idadeMax', {
                idadeMax: filters.idadeGestacionalMax,
            });
        }
        const total = await query.getCount();
        if (filters.page && filters.limit) {
            query.skip((filters.page - 1) * filters.limit).take(filters.limit);
        }
        query.orderBy('dados.data_nascimento', 'DESC');
        const data = await query.getMany();
        return { data, total };
    }
};
exports.DadosNatalidadeRepository = DadosNatalidadeRepository;
exports.DadosNatalidadeRepository = DadosNatalidadeRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], DadosNatalidadeRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xccmVwb3NpdG9yaWVzXFxkYWRvcy1uYXRhbGlkYWRlLnJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxxQ0FBaUQ7QUFDakQsdUZBQTRFO0FBRTVFOzs7R0FHRztBQUVJLElBQU0seUJBQXlCLEdBQS9CLE1BQU0seUJBQTBCLFNBQVEsb0JBQTJCO0lBQ3BEO0lBQXBCLFlBQW9CLFVBQXNCO1FBQ3hDLEtBQUssQ0FBQyx5Q0FBZSxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7UUFEdkMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtJQUUxQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsOEJBQThCLENBQ2xDLGFBQXFCO1FBRXJCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNsQixLQUFLLEVBQUUsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFO1lBQ3hDLFNBQVMsRUFBRTtnQkFDVCxhQUFhO2dCQUNiLHFCQUFxQjtnQkFDckIsNEJBQTRCO2FBQzdCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLHVCQUF1QixDQUMzQixVQUFnQixFQUNoQixPQUFhO1FBRWIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDO2FBQ3BDLGlCQUFpQixDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQzthQUNyRCxpQkFBaUIsQ0FBQyxxQkFBcUIsRUFBRSxTQUFTLENBQUM7YUFDbkQsS0FBSyxDQUFDLHdEQUF3RCxFQUFFO1lBQy9ELFVBQVU7WUFDVixPQUFPO1NBQ1IsQ0FBQzthQUNELE9BQU8sQ0FBQyx1QkFBdUIsRUFBRSxNQUFNLENBQUM7YUFDeEMsT0FBTyxFQUFFLENBQUM7SUFDZixDQUFDO0lB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LE9BQU8sQ0FBQyxRQUFRLEdBQUc7YUFDbEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDaEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxzQ0FBc0MsRUFBRTtnQkFDckQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxtQkFBbUI7YUFDdEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDaEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxzQ0FBc0MsRUFBRTtnQkFDckQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxtQkFBbUI7YUFDdEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLE1BQU0sS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXJDLElBQUksT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELEtBQUssQ0FBQyxPQUFPLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFL0MsTUFBTSxJQUFJLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFbkMsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUN6QixDQUFDO0NBQ0YsQ0FBQTtBQWxNWSw4REFBeUI7b0NBQXpCLHlCQUF5QjtJQURyQyxJQUFBLG1CQUFVLEdBQUU7eURBRXFCLG9CQUFVLG9CQUFWLG9CQUFVO0dBRC9CLHlCQUF5QixDQWtNckMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xccmVwb3NpdG9yaWVzXFxkYWRvcy1uYXRhbGlkYWRlLnJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IERhdGFTb3VyY2UsIFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IERhZG9zTmF0YWxpZGFkZSB9IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL2RhZG9zLW5hdGFsaWRhZGUuZW50aXR5JztcblxuLyoqXG4gKiBSZXBvc2l0w7NyaW8gY3VzdG9taXphZG8gcGFyYSBEYWRvc05hdGFsaWRhZGVcbiAqIEV4dGVuZGUgbyByZXBvc2l0w7NyaW8gYmFzZSBkbyBUeXBlT1JNIGNvbSBtw6l0b2RvcyBlc3BlY8OtZmljb3NcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhZG9zTmF0YWxpZGFkZVJlcG9zaXRvcnkgZXh0ZW5kcyBSZXBvc2l0b3J5PERhZG9zTmF0YWxpZGFkZT4ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGFTb3VyY2U6IERhdGFTb3VyY2UpIHtcbiAgICBzdXBlcihEYWRvc05hdGFsaWRhZGUsIGRhdGFTb3VyY2UuY3JlYXRlRW50aXR5TWFuYWdlcigpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgZGUgbmF0YWxpZGFkZSBwb3Igc29saWNpdGHDp8OjbyBjb20gcmVsYWNpb25hbWVudG9zXG4gICAqL1xuICBhc3luYyBmaW5kQnlTb2xpY2l0YWNhb1dpdGhSZWxhdGlvbnMoXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPERhZG9zTmF0YWxpZGFkZSB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IHNvbGljaXRhY2FvX2lkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgICByZWxhdGlvbnM6IFtcbiAgICAgICAgJ3NvbGljaXRhY2FvJyxcbiAgICAgICAgJ3NvbGljaXRhY2FvLmNpZGFkYW8nLFxuICAgICAgICAnc29saWNpdGFjYW8udGlwb19iZW5lZmljaW8nLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZGFkb3MgZGUgbmF0YWxpZGFkZSBwb3IgcGVyw61vZG8gZGUgbmFzY2ltZW50b1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5UGVyaW9kb05hc2NpbWVudG8oXG4gICAgZGF0YUluaWNpbzogRGF0ZSxcbiAgICBkYXRhRmltOiBEYXRlLFxuICApOiBQcm9taXNlPERhZG9zTmF0YWxpZGFkZVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ2RhZG9zLnNvbGljaXRhY2FvJywgJ3NvbGljaXRhY2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8uY2lkYWRhbycsICdjaWRhZGFvJylcbiAgICAgIC53aGVyZSgnZGFkb3MuZGF0YV9uYXNjaW1lbnRvIEJFVFdFRU4gOmRhdGFJbmljaW8gQU5EIDpkYXRhRmltJywge1xuICAgICAgICBkYXRhSW5pY2lvLFxuICAgICAgICBkYXRhRmltLFxuICAgICAgfSlcbiAgICAgIC5vcmRlckJ5KCdkYWRvcy5kYXRhX25hc2NpbWVudG8nLCAnREVTQycpXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciBkYWRvcyBkZSBuYXRhbGlkYWRlIHBvciB0aXBvIGRlIHBhcnRvXG4gICAqL1xuICBhc3luYyBmaW5kQnlUaXBvUGFydG8odGlwb1BhcnRvOiBzdHJpbmcpOiBQcm9taXNlPERhZG9zTmF0YWxpZGFkZVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ2RhZG9zLnNvbGljaXRhY2FvJywgJ3NvbGljaXRhY2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8uY2lkYWRhbycsICdjaWRhZGFvJylcbiAgICAgIC53aGVyZSgnZGFkb3MudGlwb19wYXJ0byA9IDp0aXBvUGFydG8nLCB7IHRpcG9QYXJ0byB9KVxuICAgICAgLm9yZGVyQnkoJ2RhZG9zLmNyZWF0ZWRfYXQnLCAnREVTQycpXG4gICAgICAuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnRhciBzb2xpY2l0YcOnw7VlcyBwb3IgaG9zcGl0YWxcbiAgICovXG4gIGFzeW5jIGNvdW50QnlIb3NwaXRhbCgpOiBQcm9taXNlPHsgaG9zcGl0YWw6IHN0cmluZzsgdG90YWw6IG51bWJlciB9W10+IHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5zZWxlY3QoJ2RhZG9zLmhvc3BpdGFsX25hc2NpbWVudG8nLCAnaG9zcGl0YWwnKVxuICAgICAgLmFkZFNlbGVjdCgnQ09VTlQoKiknLCAndG90YWwnKVxuICAgICAgLmdyb3VwQnkoJ2RhZG9zLmhvc3BpdGFsX25hc2NpbWVudG8nKVxuICAgICAgLm9yZGVyQnkoJ3RvdGFsJywgJ0RFU0MnKVxuICAgICAgLmdldFJhd01hbnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYXIgZXN0YXTDrXN0aWNhcyBkZSBuYXRhbGlkYWRlXG4gICAqL1xuICBhc3luYyBnZXRFc3RhdGlzdGljYXMoKTogUHJvbWlzZTx7XG4gICAgdG90YWxOYXNjaW1lbnRvczogbnVtYmVyO1xuICAgIHBvclRpcG9QYXJ0bzogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBwb3JIb3NwaXRhbDogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBtZWRpYUlkYWRlR2VzdGFjaW9uYWw6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IHRvdGFsTmFzY2ltZW50b3MgPSBhd2FpdCB0aGlzLmNvdW50KCk7XG5cbiAgICAvLyBFc3RhdMOtc3RpY2FzIHBvciB0aXBvIGRlIHBhcnRvXG4gICAgY29uc3QgcG9yVGlwb1BhcnRvUmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ2RhZG9zJylcbiAgICAgIC5zZWxlY3QoJ2RhZG9zLnRpcG9fcGFydG8nLCAndGlwbycpXG4gICAgICAuYWRkU2VsZWN0KCdDT1VOVCgqKScsICdxdWFudGlkYWRlJylcbiAgICAgIC5ncm91cEJ5KCdkYWRvcy50aXBvX3BhcnRvJylcbiAgICAgIC5nZXRSYXdNYW55KCk7XG5cbiAgICBjb25zdCBwb3JUaXBvUGFydG8gPSBwb3JUaXBvUGFydG9SZXN1bHQucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICAgIGFjY1tpdGVtLnRpcG9dID0gcGFyc2VJbnQoaXRlbS5xdWFudGlkYWRlKTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30pO1xuXG4gICAgLy8gRXN0YXTDrXN0aWNhcyBwb3IgaG9zcGl0YWxcbiAgICBjb25zdCBwb3JIb3NwaXRhbFJlc3VsdCA9IGF3YWl0IHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAuc2VsZWN0KCdkYWRvcy5ob3NwaXRhbF9uYXNjaW1lbnRvJywgJ2hvc3BpdGFsJylcbiAgICAgIC5hZGRTZWxlY3QoJ0NPVU5UKCopJywgJ3F1YW50aWRhZGUnKVxuICAgICAgLmdyb3VwQnkoJ2RhZG9zLmhvc3BpdGFsX25hc2NpbWVudG8nKVxuICAgICAgLmdldFJhd01hbnkoKTtcblxuICAgIGNvbnN0IHBvckhvc3BpdGFsID0gcG9ySG9zcGl0YWxSZXN1bHQucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICAgIGFjY1tpdGVtLmhvc3BpdGFsXSA9IHBhcnNlSW50KGl0ZW0ucXVhbnRpZGFkZSk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcblxuICAgIC8vIE3DqWRpYSBkZSBpZGFkZSBnZXN0YWNpb25hbFxuICAgIGNvbnN0IG1lZGlhSWRhZGVSZXN1bHQgPSBhd2FpdCB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcignZGFkb3MnKVxuICAgICAgLnNlbGVjdCgnQVZHKGRhZG9zLmlkYWRlX2dlc3RhY2lvbmFsKScsICdtZWRpYScpXG4gICAgICAud2hlcmUoJ2RhZG9zLmlkYWRlX2dlc3RhY2lvbmFsIElTIE5PVCBOVUxMJylcbiAgICAgIC5nZXRSYXdPbmUoKTtcblxuICAgIGNvbnN0IG1lZGlhSWRhZGVHZXN0YWNpb25hbCA9IHBhcnNlRmxvYXQobWVkaWFJZGFkZVJlc3VsdC5tZWRpYSkgfHwgMDtcblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbE5hc2NpbWVudG9zLFxuICAgICAgcG9yVGlwb1BhcnRvLFxuICAgICAgcG9ySG9zcGl0YWwsXG4gICAgICBtZWRpYUlkYWRlR2VzdGFjaW9uYWwsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYXIgZHVwbGljYXRhcyBwb3IgZGFkb3MgZG8gYmViw6pcbiAgICovXG4gIGFzeW5jIGZpbmREdXBsaWNhdGVzQnlCYWJ5KFxuICAgIG5vbWVCZWJlOiBzdHJpbmcsXG4gICAgZGF0YU5hc2NpbWVudG86IERhdGUsXG4gICAgZXhjbHVkZUlkPzogc3RyaW5nLFxuICApOiBQcm9taXNlPERhZG9zTmF0YWxpZGFkZVtdPiB7XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLmNyZWF0ZVF1ZXJ5QnVpbGRlcignZGFkb3MnKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdkYWRvcy5zb2xpY2l0YWNhbycsICdzb2xpY2l0YWNhbycpXG4gICAgICAud2hlcmUoJ0xPV0VSKGRhZG9zLm5vbWVfY29tcGxldG9fYmViZSkgPSBMT1dFUig6bm9tZUJlYmUpJywgeyBub21lQmViZSB9KVxuICAgICAgLmFuZFdoZXJlKCdkYWRvcy5kYXRhX25hc2NpbWVudG8gPSA6ZGF0YU5hc2NpbWVudG8nLCB7IGRhdGFOYXNjaW1lbnRvIH0pO1xuXG4gICAgaWYgKGV4Y2x1ZGVJZCkge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ2RhZG9zLmlkICE9IDpleGNsdWRlSWQnLCB7IGV4Y2x1ZGVJZCB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcXVlcnkuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhciBkYWRvcyBkZSBuYXRhbGlkYWRlIGNvbSBmaWx0cm9zIGF2YW7Dp2Fkb3NcbiAgICovXG4gIGFzeW5jIGZpbmRXaXRoRmlsdGVycyhmaWx0ZXJzOiB7XG4gICAgZGF0YUluaWNpbz86IERhdGU7XG4gICAgZGF0YUZpbT86IERhdGU7XG4gICAgdGlwb1BhcnRvPzogc3RyaW5nO1xuICAgIGhvc3BpdGFsPzogc3RyaW5nO1xuICAgIGlkYWRlR2VzdGFjaW9uYWxNaW4/OiBudW1iZXI7XG4gICAgaWRhZGVHZXN0YWNpb25hbE1heD86IG51bWJlcjtcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICB9KTogUHJvbWlzZTx7IGRhdGE6IERhZG9zTmF0YWxpZGFkZVtdOyB0b3RhbDogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdkYWRvcycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ2RhZG9zLnNvbGljaXRhY2FvJywgJ3NvbGljaXRhY2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8uY2lkYWRhbycsICdjaWRhZGFvJyk7XG5cbiAgICBpZiAoZmlsdGVycy5kYXRhSW5pY2lvICYmIGZpbHRlcnMuZGF0YUZpbSkge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ2RhZG9zLmRhdGFfbmFzY2ltZW50byBCRVRXRUVOIDpkYXRhSW5pY2lvIEFORCA6ZGF0YUZpbScsIHtcbiAgICAgICAgZGF0YUluaWNpbzogZmlsdGVycy5kYXRhSW5pY2lvLFxuICAgICAgICBkYXRhRmltOiBmaWx0ZXJzLmRhdGFGaW0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZmlsdGVycy50aXBvUGFydG8pIHtcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKCdkYWRvcy50aXBvX3BhcnRvID0gOnRpcG9QYXJ0bycsIHtcbiAgICAgICAgdGlwb1BhcnRvOiBmaWx0ZXJzLnRpcG9QYXJ0byxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChmaWx0ZXJzLmhvc3BpdGFsKSB7XG4gICAgICBxdWVyeS5hbmRXaGVyZSgnTE9XRVIoZGFkb3MuaG9zcGl0YWxfbmFzY2ltZW50bykgTElLRSBMT1dFUig6aG9zcGl0YWwpJywge1xuICAgICAgICBob3NwaXRhbDogYCUke2ZpbHRlcnMuaG9zcGl0YWx9JWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZmlsdGVycy5pZGFkZUdlc3RhY2lvbmFsTWluKSB7XG4gICAgICBxdWVyeS5hbmRXaGVyZSgnZGFkb3MuaWRhZGVfZ2VzdGFjaW9uYWwgPj0gOmlkYWRlTWluJywge1xuICAgICAgICBpZGFkZU1pbjogZmlsdGVycy5pZGFkZUdlc3RhY2lvbmFsTWluLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGZpbHRlcnMuaWRhZGVHZXN0YWNpb25hbE1heCkge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ2RhZG9zLmlkYWRlX2dlc3RhY2lvbmFsIDw9IDppZGFkZU1heCcsIHtcbiAgICAgICAgaWRhZGVNYXg6IGZpbHRlcnMuaWRhZGVHZXN0YWNpb25hbE1heCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHRvdGFsID0gYXdhaXQgcXVlcnkuZ2V0Q291bnQoKTtcblxuICAgIGlmIChmaWx0ZXJzLnBhZ2UgJiYgZmlsdGVycy5saW1pdCkge1xuICAgICAgcXVlcnkuc2tpcCgoZmlsdGVycy5wYWdlIC0gMSkgKiBmaWx0ZXJzLmxpbWl0KS50YWtlKGZpbHRlcnMubGltaXQpO1xuICAgIH1cblxuICAgIHF1ZXJ5Lm9yZGVyQnkoJ2RhZG9zLmRhdGFfbmFzY2ltZW50bycsICdERVNDJyk7XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcXVlcnkuZ2V0TWFueSgpO1xuXG4gICAgcmV0dXJuIHsgZGF0YSwgdG90YWwgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9