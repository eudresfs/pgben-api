f35f4644c10061dc810d801b2e8e10ac
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const pagamento_access_guard_1 = require("../../../guards/pagamento-access.guard");
const pagamento_service_1 = require("../../../services/pagamento.service");
const integracao_solicitacao_service_1 = require("../../../services/integracao-solicitacao.service");
const integracao_cidadao_service_1 = require("../../../services/integracao-cidadao.service");
const pagamento_access_decorator_1 = require("../../../decorators/pagamento-access.decorator");
/**
 * Testes unitários para PagamentoAccessGuard
 *
 * Valida o correto funcionamento do controle de acesso baseado em perfis
 * e unidades para recursos do módulo de pagamento.
 *
 * @author Equipe PGBen
 */
describe('PagamentoAccessGuard', () => {
    let guard;
    let pagamentoService;
    let solicitacaoService;
    let cidadaoService;
    let reflector;
    // Mocks para os testes
    const mockPagamento = {
        id: 'pagamento-id-1',
        solicitacaoId: 'solicitacao-id-1',
        valor: 500,
        status: 'LIBERADO',
    };
    const mockSolicitacaoStatus = {
        id: 'solicitacao-id-1',
        unidadeId: 'unidade-id-1',
        status: 'APROVADA',
    };
    const mockCidadao = {
        id: 'cidadao-id-1',
        nome: 'Maria Silva',
        cpf: '123.456.789-09',
        unidadeId: 'unidade-id-1',
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                pagamento_access_guard_1.PagamentoAccessGuard,
                {
                    provide: core_1.Reflector,
                    useValue: {
                        getAllAndOverride: jest.fn(),
                    },
                },
                {
                    provide: pagamento_service_1.PagamentoService,
                    useValue: {
                        findOneWithRelations: jest.fn().mockResolvedValue(mockPagamento),
                        findOne: jest.fn().mockResolvedValue(mockPagamento),
                    },
                },
                {
                    provide: integracao_solicitacao_service_1.IntegracaoSolicitacaoService,
                    useValue: {
                        verificarSolicitacaoAprovada: jest
                            .fn()
                            .mockResolvedValue(mockSolicitacaoStatus),
                    },
                },
                {
                    provide: integracao_cidadao_service_1.IntegracaoCidadaoService,
                    useValue: {
                        obterDadosPessoais: jest.fn().mockResolvedValue(mockCidadao),
                    },
                },
            ],
        }).compile();
        guard = module.get(pagamento_access_guard_1.PagamentoAccessGuard);
        reflector = module.get(core_1.Reflector);
        pagamentoService = module.get(pagamento_service_1.PagamentoService);
        solicitacaoService = module.get(integracao_solicitacao_service_1.IntegracaoSolicitacaoService);
        cidadaoService = module.get(integracao_cidadao_service_1.IntegracaoCidadaoService);
    });
    it('deve estar definido', () => {
        expect(guard).toBeDefined();
    });
    describe('canActivate', () => {
        // Mock do contexto de execução
        const mockExecutionContext = {
            switchToHttp: jest.fn().mockReturnValue({
                getRequest: jest.fn().mockReturnValue({
                    user: {
                        id: 'usuario-id-1',
                        perfil: 'operador',
                        unidadeId: 'unidade-id-1',
                    },
                    params: {
                        pagamentoId: 'pagamento-id-1',
                    },
                    method: 'GET',
                    route: {
                        path: '/pagamentos/:pagamentoId',
                    },
                }),
            }),
            getHandler: jest.fn(),
            getClass: jest.fn(),
        };
        it('deve permitir acesso quando usuário tem perfil permitido', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            // Act
            const resultado = await guard.canActivate(mockExecutionContext);
            // Assert
            expect(resultado).toBeTruthy();
            expect(reflector.getAllAndOverride).toHaveBeenCalledWith(pagamento_access_decorator_1.PERFIS_PERMITIDOS_KEY, [mockExecutionContext.getHandler(), mockExecutionContext.getClass()]);
        });
        it('deve negar acesso quando usuário não tem perfil permitido', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin']) // PERFIS_PERMITIDOS_KEY - apenas admin pode acessar
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            // Mudar o perfil do usuário para um não permitido
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'atendente', // Perfil não presente na lista de permitidos
                            unidadeId: 'unidade-id-1',
                        },
                        params: {
                            pagamentoId: 'pagamento-id-1',
                        },
                    }),
                }),
            };
            // Act & Assert
            await expect(guard.canActivate(mockContext)).rejects.toThrow(common_1.ForbiddenException);
        });
        it('deve permitir acesso para admin independente da unidade', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            // Admin de outra unidade
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'admin', // Admin pode acessar qualquer unidade
                            unidadeId: 'unidade-id-2', // Unidade diferente
                        },
                        params: {
                            pagamentoId: 'pagamento-id-1',
                        },
                    }),
                }),
            };
            // Act
            const resultado = await guard.canActivate(mockContext);
            // Assert
            expect(resultado).toBeTruthy();
        });
        it('deve negar acesso quando usuário não é da mesma unidade', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            // Operador de outra unidade
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'operador',
                            unidadeId: 'unidade-id-2', // Unidade diferente
                        },
                        params: {
                            pagamentoId: 'pagamento-id-1',
                        },
                    }),
                }),
            };
            // Act & Assert
            await expect(guard.canActivate(mockContext)).rejects.toThrow(common_1.ForbiddenException);
        });
        it('deve lançar erro quando pagamento não existe', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            jest
                .spyOn(pagamentoService, 'findOneWithRelations')
                .mockResolvedValue(null);
            // Act & Assert
            await expect(guard.canActivate(mockExecutionContext)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve lançar erro quando solicitação não existe', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            jest
                .spyOn(solicitacaoService, 'verificarSolicitacaoAprovada')
                .mockResolvedValue(null);
            // Act & Assert
            await expect(guard.canActivate(mockExecutionContext)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve validar acesso baseado em beneficiário', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            // Request com beneficiário
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'operador',
                            unidadeId: 'unidade-id-1',
                        },
                        params: {
                            beneficiarioId: 'cidadao-id-1', // Agora usamos um beneficiário em vez de pagamento
                        },
                    }),
                }),
            };
            // Act
            const resultado = await guard.canActivate(mockContext);
            // Assert
            expect(resultado).toBeTruthy();
            expect(cidadaoService.obterDadosPessoais).toHaveBeenCalledWith('cidadao-id-1');
        });
        it('deve lançar erro quando beneficiário não existe', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(true); // VERIFICAR_UNIDADE_KEY
            jest.spyOn(cidadaoService, 'obterDadosPessoais').mockResolvedValue(null);
            // Request com beneficiário
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'operador',
                            unidadeId: 'unidade-id-1',
                        },
                        params: {
                            beneficiarioId: 'cidadao-inexistente',
                        },
                    }),
                }),
            };
            // Act & Assert
            await expect(guard.canActivate(mockContext)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve permitir acesso quando verificação de unidade está desativada', async () => {
            // Arrange
            jest
                .spyOn(reflector, 'getAllAndOverride')
                .mockReturnValueOnce(['admin', 'operador']) // PERFIS_PERMITIDOS_KEY
                .mockReturnValueOnce(false); // VERIFICAR_UNIDADE_KEY - desativado
            // Operador de outra unidade (normalmente seria negado)
            const mockContext = {
                ...mockExecutionContext,
                switchToHttp: jest.fn().mockReturnValue({
                    getRequest: jest.fn().mockReturnValue({
                        user: {
                            id: 'usuario-id-1',
                            perfil: 'operador',
                            unidadeId: 'unidade-id-2', // Unidade diferente
                        },
                        params: {
                            pagamentoId: 'pagamento-id-1',
                        },
                    }),
                }),
            };
            // Act
            const resultado = await guard.canActivate(mockContext);
            // Assert
            expect(resultado).toBeTruthy();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHVuaXRcXGd1YXJkc1xccGFnYW1lbnRvLWFjY2Vzcy5ndWFyZC5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELDJDQUl3QjtBQUN4Qix1Q0FBeUM7QUFFekMsbUZBQThFO0FBQzlFLDJFQUF1RTtBQUN2RSxxR0FBZ0c7QUFDaEcsNkZBQXdGO0FBQ3hGLCtGQUd3RDtBQUV4RDs7Ozs7OztHQU9HO0FBQ0gsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUNwQyxJQUFJLEtBQTJCLENBQUM7SUFDaEMsSUFBSSxnQkFBa0MsQ0FBQztJQUN2QyxJQUFJLGtCQUFnRCxDQUFDO0lBQ3JELElBQUksY0FBd0MsQ0FBQztJQUM3QyxJQUFJLFNBQW9CLENBQUM7SUFFekIsdUJBQXVCO0lBQ3ZCLE1BQU0sYUFBYSxHQUFHO1FBQ3BCLEVBQUUsRUFBRSxnQkFBZ0I7UUFDcEIsYUFBYSxFQUFFLGtCQUFrQjtRQUNqQyxLQUFLLEVBQUUsR0FBRztRQUNWLE1BQU0sRUFBRSxVQUFVO0tBQ25CLENBQUM7SUFFRixNQUFNLHFCQUFxQixHQUFHO1FBQzVCLEVBQUUsRUFBRSxrQkFBa0I7UUFDdEIsU0FBUyxFQUFFLGNBQWM7UUFDekIsTUFBTSxFQUFFLFVBQVU7S0FDbkIsQ0FBQztJQUVGLE1BQU0sV0FBVyxHQUFHO1FBQ2xCLEVBQUUsRUFBRSxjQUFjO1FBQ2xCLElBQUksRUFBRSxhQUFhO1FBQ25CLEdBQUcsRUFBRSxnQkFBZ0I7UUFDckIsU0FBUyxFQUFFLGNBQWM7S0FDMUIsQ0FBQztJQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULDZDQUFvQjtnQkFDcEI7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QUFpQixDQUNsQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsb0VBQW9FLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDbEYsVUFBVTtZQUNWLElBQUk7aUJBQ0QsS0FBSyxDQUFDLFNBQVMsRUFBRSxtQkFBbUIsQ0FBQztpQkFDckMsbUJBQW1CLENBQUMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyx3QkFBd0I7aUJBQ25FLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMscUNBQXFDO1lBRXBFLHVEQUF1RDtZQUN2RCxNQUFNLFdBQVcsR0FBRztnQkFDbEIsR0FBRyxvQkFBb0I7Z0JBQ3ZCLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUN0QyxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQzt3QkFDcEMsSUFBSSxFQUFFOzRCQUNKLEVBQUUsRUFBRSxjQUFjOzRCQUNsQixNQUFNLEVBQUUsVUFBVTs0QkFDbEIsU0FBUyxFQUFFLGNBQWMsRUFBRSxvQkFBb0I7eUJBQ2hEO3dCQUNELE1BQU0sRUFBRTs0QkFDTixXQUFXLEVBQUUsZ0JBQWdCO3lCQUM5QjtxQkFDRixDQUFDO2lCQUNILENBQUM7YUFDNEIsQ0FBQztZQUVqQyxNQUFNO1lBQ04sTUFBTSxTQUFTLEdBQUcsTUFBTSxLQUFLLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXZELFNBQVM7WUFDVCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDakMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxwYWdhbWVudG9cXHRlc3RzXFx1bml0XFxndWFyZHNcXHBhZ2FtZW50by1hY2Nlc3MuZ3VhcmQuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7XG4gIEV4ZWN1dGlvbkNvbnRleHQsXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFJlZmxlY3RvciB9IGZyb20gJ0BuZXN0anMvY29yZSc7XG5cbmltcG9ydCB7IFBhZ2FtZW50b0FjY2Vzc0d1YXJkIH0gZnJvbSAnLi4vLi4vLi4vZ3VhcmRzL3BhZ2FtZW50by1hY2Nlc3MuZ3VhcmQnO1xuaW1wb3J0IHsgUGFnYW1lbnRvU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL3BhZ2FtZW50by5zZXJ2aWNlJztcbmltcG9ydCB7IEludGVncmFjYW9Tb2xpY2l0YWNhb1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9pbnRlZ3JhY2FvLXNvbGljaXRhY2FvLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW50ZWdyYWNhb0NpZGFkYW9TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvaW50ZWdyYWNhby1jaWRhZGFvLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgUEVSRklTX1BFUk1JVElET1NfS0VZLFxuICBWRVJJRklDQVJfVU5JREFERV9LRVksXG59IGZyb20gJy4uLy4uLy4uL2RlY29yYXRvcnMvcGFnYW1lbnRvLWFjY2Vzcy5kZWNvcmF0b3InO1xuXG4vKipcbiAqIFRlc3RlcyB1bml0w6FyaW9zIHBhcmEgUGFnYW1lbnRvQWNjZXNzR3VhcmRcbiAqXG4gKiBWYWxpZGEgbyBjb3JyZXRvIGZ1bmNpb25hbWVudG8gZG8gY29udHJvbGUgZGUgYWNlc3NvIGJhc2VhZG8gZW0gcGVyZmlzXG4gKiBlIHVuaWRhZGVzIHBhcmEgcmVjdXJzb3MgZG8gbcOzZHVsbyBkZSBwYWdhbWVudG8uXG4gKlxuICogQGF1dGhvciBFcXVpcGUgUEdCZW5cbiAqL1xuZGVzY3JpYmUoJ1BhZ2FtZW50b0FjY2Vzc0d1YXJkJywgKCkgPT4ge1xuICBsZXQgZ3VhcmQ6IFBhZ2FtZW50b0FjY2Vzc0d1YXJkO1xuICBsZXQgcGFnYW1lbnRvU2VydmljZTogUGFnYW1lbnRvU2VydmljZTtcbiAgbGV0IHNvbGljaXRhY2FvU2VydmljZTogSW50ZWdyYWNhb1NvbGljaXRhY2FvU2VydmljZTtcbiAgbGV0IGNpZGFkYW9TZXJ2aWNlOiBJbnRlZ3JhY2FvQ2lkYWRhb1NlcnZpY2U7XG4gIGxldCByZWZsZWN0b3I6IFJlZmxlY3RvcjtcblxuICAvLyBNb2NrcyBwYXJhIG9zIHRlc3Rlc1xuICBjb25zdCBtb2NrUGFnYW1lbnRvID0ge1xuICAgIGlkOiAncGFnYW1lbnRvLWlkLTEnLFxuICAgIHNvbGljaXRhY2FvSWQ6ICdzb2xpY2l0YWNhby1pZC0xJyxcbiAgICB2YWxvcjogNTAwLFxuICAgIHN0YXR1czogJ0xJQkVSQURPJyxcbiAgfTtcblxuICBjb25zdCBtb2NrU29saWNpdGFjYW9TdGF0dXMgPSB7XG4gICAgaWQ6ICdzb2xpY2l0YWNhby1pZC0xJyxcbiAgICB1bmlkYWRlSWQ6ICd1bmlkYWRlLWlkLTEnLFxuICAgIHN0YXR1czogJ0FQUk9WQURBJyxcbiAgfTtcblxuICBjb25zdCBtb2NrQ2lkYWRhbyA9IHtcbiAgICBpZDogJ2NpZGFkYW8taWQtMScsXG4gICAgbm9tZTogJ01hcmlhIFNpbHZhJyxcbiAgICBjcGY6ICcxMjMuNDU2Ljc4OS0wOScsXG4gICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0xJyxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFBhZ2FtZW50b0FjY2Vzc0d1YXJkLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUmVmbGVjdG9yLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBnZXRBbGxBbmRPdmVycmlkZTogamVzdC5mbigpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQYWdhbWVudG9TZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBmaW5kT25lV2l0aFJlbGF0aW9uczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tQYWdhbWVudG8pLFxuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tQYWdhbWVudG8pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBJbnRlZ3JhY2FvU29saWNpdGFjYW9TZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICB2ZXJpZmljYXJTb2xpY2l0YWNhb0Fwcm92YWRhOiBqZXN0XG4gICAgICAgICAgICAgIC5mbigpXG4gICAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrU29saWNpdGFjYW9TdGF0dXMpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBJbnRlZ3JhY2FvQ2lkYWRhb1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIG9idGVyRGFkb3NQZXNzb2FpczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDaWRhZGFvKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBndWFyZCA9IG1vZHVsZS5nZXQ8UGFnYW1lbnRvQWNjZXNzR3VhcmQ+KFBhZ2FtZW50b0FjY2Vzc0d1YXJkKTtcbiAgICByZWZsZWN0b3IgPSBtb2R1bGUuZ2V0PFJlZmxlY3Rvcj4oUmVmbGVjdG9yKTtcbiAgICBwYWdhbWVudG9TZXJ2aWNlID0gbW9kdWxlLmdldDxQYWdhbWVudG9TZXJ2aWNlPihQYWdhbWVudG9TZXJ2aWNlKTtcbiAgICBzb2xpY2l0YWNhb1NlcnZpY2UgPSBtb2R1bGUuZ2V0PEludGVncmFjYW9Tb2xpY2l0YWNhb1NlcnZpY2U+KFxuICAgICAgSW50ZWdyYWNhb1NvbGljaXRhY2FvU2VydmljZSxcbiAgICApO1xuICAgIGNpZGFkYW9TZXJ2aWNlID0gbW9kdWxlLmdldDxJbnRlZ3JhY2FvQ2lkYWRhb1NlcnZpY2U+KFxuICAgICAgSW50ZWdyYWNhb0NpZGFkYW9TZXJ2aWNlLFxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIGVzdGFyIGRlZmluaWRvJywgKCkgPT4ge1xuICAgIGV4cGVjdChndWFyZCkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NhbkFjdGl2YXRlJywgKCkgPT4ge1xuICAgIC8vIE1vY2sgZG8gY29udGV4dG8gZGUgZXhlY3XDp8Ojb1xuICAgIGNvbnN0IG1vY2tFeGVjdXRpb25Db250ZXh0ID0ge1xuICAgICAgc3dpdGNoVG9IdHRwOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZ2V0UmVxdWVzdDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgaWQ6ICd1c3VhcmlvLWlkLTEnLFxuICAgICAgICAgICAgcGVyZmlsOiAnb3BlcmFkb3InLFxuICAgICAgICAgICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0xJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBhcmFtczoge1xuICAgICAgICAgICAgcGFnYW1lbnRvSWQ6ICdwYWdhbWVudG8taWQtMScsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgIHJvdXRlOiB7XG4gICAgICAgICAgICBwYXRoOiAnL3BhZ2FtZW50b3MvOnBhZ2FtZW50b0lkJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgIH0pLFxuICAgICAgZ2V0SGFuZGxlcjogamVzdC5mbigpLFxuICAgICAgZ2V0Q2xhc3M6IGplc3QuZm4oKSxcbiAgICB9IGFzIHVua25vd24gYXMgRXhlY3V0aW9uQ29udGV4dDtcblxuICAgIGl0KCdkZXZlIHBlcm1pdGlyIGFjZXNzbyBxdWFuZG8gdXN1w6FyaW8gdGVtIHBlcmZpbCBwZXJtaXRpZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKFsnYWRtaW4nLCAnb3BlcmFkb3InXSkgLy8gUEVSRklTX1BFUk1JVElET1NfS0VZXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHRydWUpOyAvLyBWRVJJRklDQVJfVU5JREFERV9LRVlcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBndWFyZC5jYW5BY3RpdmF0ZShtb2NrRXhlY3V0aW9uQ29udGV4dCk7XG5cbiAgICAgIC8vIEFzc2VydFxuICAgICAgZXhwZWN0KHJlc3VsdGFkbykudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIFBFUkZJU19QRVJNSVRJRE9TX0tFWSxcbiAgICAgICAgW21vY2tFeGVjdXRpb25Db250ZXh0LmdldEhhbmRsZXIoKSwgbW9ja0V4ZWN1dGlvbkNvbnRleHQuZ2V0Q2xhc3MoKV0sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbmVnYXIgYWNlc3NvIHF1YW5kbyB1c3XDoXJpbyBuw6NvIHRlbSBwZXJmaWwgcGVybWl0aWRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocmVmbGVjdG9yLCAnZ2V0QWxsQW5kT3ZlcnJpZGUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZShbJ2FkbWluJ10pIC8vIFBFUkZJU19QRVJNSVRJRE9TX0tFWSAtIGFwZW5hcyBhZG1pbiBwb2RlIGFjZXNzYXJcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UodHJ1ZSk7IC8vIFZFUklGSUNBUl9VTklEQURFX0tFWVxuXG4gICAgICAvLyBNdWRhciBvIHBlcmZpbCBkbyB1c3XDoXJpbyBwYXJhIHVtIG7Do28gcGVybWl0aWRvXG4gICAgICBjb25zdCBtb2NrQ29udGV4dCA9IHtcbiAgICAgICAgLi4ubW9ja0V4ZWN1dGlvbkNvbnRleHQsXG4gICAgICAgIHN3aXRjaFRvSHR0cDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgZ2V0UmVxdWVzdDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIGlkOiAndXN1YXJpby1pZC0xJyxcbiAgICAgICAgICAgICAgcGVyZmlsOiAnYXRlbmRlbnRlJywgLy8gUGVyZmlsIG7Do28gcHJlc2VudGUgbmEgbGlzdGEgZGUgcGVybWl0aWRvc1xuICAgICAgICAgICAgICB1bmlkYWRlSWQ6ICd1bmlkYWRlLWlkLTEnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBhcmFtczoge1xuICAgICAgICAgICAgICBwYWdhbWVudG9JZDogJ3BhZ2FtZW50by1pZC0xJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSBhcyB1bmtub3duIGFzIEV4ZWN1dGlvbkNvbnRleHQ7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcGVybWl0aXIgYWNlc3NvIHBhcmEgYWRtaW4gaW5kZXBlbmRlbnRlIGRhIHVuaWRhZGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKFsnYWRtaW4nLCAnb3BlcmFkb3InXSkgLy8gUEVSRklTX1BFUk1JVElET1NfS0VZXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHRydWUpOyAvLyBWRVJJRklDQVJfVU5JREFERV9LRVlcblxuICAgICAgLy8gQWRtaW4gZGUgb3V0cmEgdW5pZGFkZVxuICAgICAgY29uc3QgbW9ja0NvbnRleHQgPSB7XG4gICAgICAgIC4uLm1vY2tFeGVjdXRpb25Db250ZXh0LFxuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICAgICAgICAgIHBlcmZpbDogJ2FkbWluJywgLy8gQWRtaW4gcG9kZSBhY2Vzc2FyIHF1YWxxdWVyIHVuaWRhZGVcbiAgICAgICAgICAgICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0yJywgLy8gVW5pZGFkZSBkaWZlcmVudGVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgcGFnYW1lbnRvSWQ6ICdwYWdhbWVudG8taWQtMScsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBFeGVjdXRpb25Db250ZXh0O1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0YWRvKS50b0JlVHJ1dGh5KCk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBuZWdhciBhY2Vzc28gcXVhbmRvIHVzdcOhcmlvIG7Do28gw6kgZGEgbWVzbWEgdW5pZGFkZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKHJlZmxlY3RvciwgJ2dldEFsbEFuZE92ZXJyaWRlJylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UoWydhZG1pbicsICdvcGVyYWRvciddKSAvLyBQRVJGSVNfUEVSTUlUSURPU19LRVlcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZU9uY2UodHJ1ZSk7IC8vIFZFUklGSUNBUl9VTklEQURFX0tFWVxuXG4gICAgICAvLyBPcGVyYWRvciBkZSBvdXRyYSB1bmlkYWRlXG4gICAgICBjb25zdCBtb2NrQ29udGV4dCA9IHtcbiAgICAgICAgLi4ubW9ja0V4ZWN1dGlvbkNvbnRleHQsXG4gICAgICAgIHN3aXRjaFRvSHR0cDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgZ2V0UmVxdWVzdDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIGlkOiAndXN1YXJpby1pZC0xJyxcbiAgICAgICAgICAgICAgcGVyZmlsOiAnb3BlcmFkb3InLFxuICAgICAgICAgICAgICB1bmlkYWRlSWQ6ICd1bmlkYWRlLWlkLTInLCAvLyBVbmlkYWRlIGRpZmVyZW50ZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBhcmFtczoge1xuICAgICAgICAgICAgICBwYWdhbWVudG9JZDogJ3BhZ2FtZW50by1pZC0xJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSBhcyB1bmtub3duIGFzIEV4ZWN1dGlvbkNvbnRleHQ7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBwYWdhbWVudG8gbsOjbyBleGlzdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKFsnYWRtaW4nLCAnb3BlcmFkb3InXSkgLy8gUEVSRklTX1BFUk1JVElET1NfS0VZXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHRydWUpOyAvLyBWRVJJRklDQVJfVU5JREFERV9LRVlcblxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocGFnYW1lbnRvU2VydmljZSwgJ2ZpbmRPbmVXaXRoUmVsYXRpb25zJylcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChndWFyZC5jYW5BY3RpdmF0ZShtb2NrRXhlY3V0aW9uQ29udGV4dCkpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgTm90Rm91bmRFeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBzb2xpY2l0YcOnw6NvIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocmVmbGVjdG9yLCAnZ2V0QWxsQW5kT3ZlcnJpZGUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZShbJ2FkbWluJywgJ29wZXJhZG9yJ10pIC8vIFBFUkZJU19QRVJNSVRJRE9TX0tFWVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh0cnVlKTsgLy8gVkVSSUZJQ0FSX1VOSURBREVfS0VZXG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKHNvbGljaXRhY2FvU2VydmljZSwgJ3ZlcmlmaWNhclNvbGljaXRhY2FvQXByb3ZhZGEnKVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tFeGVjdXRpb25Db250ZXh0KSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2YWxpZGFyIGFjZXNzbyBiYXNlYWRvIGVtIGJlbmVmaWNpw6FyaW8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihyZWZsZWN0b3IsICdnZXRBbGxBbmRPdmVycmlkZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKFsnYWRtaW4nLCAnb3BlcmFkb3InXSkgLy8gUEVSRklTX1BFUk1JVElET1NfS0VZXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKHRydWUpOyAvLyBWRVJJRklDQVJfVU5JREFERV9LRVlcblxuICAgICAgLy8gUmVxdWVzdCBjb20gYmVuZWZpY2nDoXJpb1xuICAgICAgY29uc3QgbW9ja0NvbnRleHQgPSB7XG4gICAgICAgIC4uLm1vY2tFeGVjdXRpb25Db250ZXh0LFxuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICAgICAgICAgIHBlcmZpbDogJ29wZXJhZG9yJyxcbiAgICAgICAgICAgICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0xJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgYmVuZWZpY2lhcmlvSWQ6ICdjaWRhZGFvLWlkLTEnLCAvLyBBZ29yYSB1c2Ftb3MgdW0gYmVuZWZpY2nDoXJpbyBlbSB2ZXogZGUgcGFnYW1lbnRvXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBFeGVjdXRpb25Db250ZXh0O1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0YWRvKS50b0JlVHJ1dGh5KCk7XG4gICAgICBleHBlY3QoY2lkYWRhb1NlcnZpY2Uub2J0ZXJEYWRvc1Blc3NvYWlzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2NpZGFkYW8taWQtMScsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBiZW5lZmljacOhcmlvIG7Do28gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocmVmbGVjdG9yLCAnZ2V0QWxsQW5kT3ZlcnJpZGUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZShbJ2FkbWluJywgJ29wZXJhZG9yJ10pIC8vIFBFUkZJU19QRVJNSVRJRE9TX0tFWVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZSh0cnVlKTsgLy8gVkVSSUZJQ0FSX1VOSURBREVfS0VZXG5cbiAgICAgIGplc3Quc3B5T24oY2lkYWRhb1NlcnZpY2UsICdvYnRlckRhZG9zUGVzc29haXMnKS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgLy8gUmVxdWVzdCBjb20gYmVuZWZpY2nDoXJpb1xuICAgICAgY29uc3QgbW9ja0NvbnRleHQgPSB7XG4gICAgICAgIC4uLm1vY2tFeGVjdXRpb25Db250ZXh0LFxuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICAgICAgICAgIHBlcmZpbDogJ29wZXJhZG9yJyxcbiAgICAgICAgICAgICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0xJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgYmVuZWZpY2lhcmlvSWQ6ICdjaWRhZGFvLWluZXhpc3RlbnRlJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSBhcyB1bmtub3duIGFzIEV4ZWN1dGlvbkNvbnRleHQ7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBwZXJtaXRpciBhY2Vzc28gcXVhbmRvIHZlcmlmaWNhw6fDo28gZGUgdW5pZGFkZSBlc3TDoSBkZXNhdGl2YWRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24ocmVmbGVjdG9yLCAnZ2V0QWxsQW5kT3ZlcnJpZGUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZShbJ2FkbWluJywgJ29wZXJhZG9yJ10pIC8vIFBFUkZJU19QRVJNSVRJRE9TX0tFWVxuICAgICAgICAubW9ja1JldHVyblZhbHVlT25jZShmYWxzZSk7IC8vIFZFUklGSUNBUl9VTklEQURFX0tFWSAtIGRlc2F0aXZhZG9cblxuICAgICAgLy8gT3BlcmFkb3IgZGUgb3V0cmEgdW5pZGFkZSAobm9ybWFsbWVudGUgc2VyaWEgbmVnYWRvKVxuICAgICAgY29uc3QgbW9ja0NvbnRleHQgPSB7XG4gICAgICAgIC4uLm1vY2tFeGVjdXRpb25Db250ZXh0LFxuICAgICAgICBzd2l0Y2hUb0h0dHA6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGdldFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBpZDogJ3VzdWFyaW8taWQtMScsXG4gICAgICAgICAgICAgIHBlcmZpbDogJ29wZXJhZG9yJyxcbiAgICAgICAgICAgICAgdW5pZGFkZUlkOiAndW5pZGFkZS1pZC0yJywgLy8gVW5pZGFkZSBkaWZlcmVudGVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgcGFnYW1lbnRvSWQ6ICdwYWdhbWVudG8taWQtMScsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBFeGVjdXRpb25Db250ZXh0O1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9IGF3YWl0IGd1YXJkLmNhbkFjdGl2YXRlKG1vY2tDb250ZXh0KTtcblxuICAgICAgLy8gQXNzZXJ0XG4gICAgICBleHBlY3QocmVzdWx0YWRvKS50b0JlVHJ1dGh5KCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=