12142fb2b6fbc9667d417d943a226c81
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var ValidacaoDinamicaService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ValidacaoDinamicaService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const campo_dinamico_beneficio_entity_1 = require("../../../entities/campo-dinamico-beneficio.entity");
const common_2 = require("@nestjs/common");
/**
 * Serviço de Validação Dinâmica
 *
 * Responsável por validar dados dinâmicos conforme esquema definido
 * para cada tipo de benefício.
 */
let ValidacaoDinamicaService = ValidacaoDinamicaService_1 = class ValidacaoDinamicaService {
    campoDinamicoRepository;
    logger = new common_2.Logger(ValidacaoDinamicaService_1.name);
    constructor(campoDinamicoRepository) {
        this.campoDinamicoRepository = campoDinamicoRepository;
    }
    /**
     * Valida dados dinâmicos conforme esquema definido para o tipo de benefício
     *
     * @param tipoBeneficioId ID do tipo de benefício
     * @param dados Dados a serem validados
     * @returns Resultado da validação
     */
    async validarCamposDinamicos(tipoBeneficioId, dados) {
        if (!dados) {
            return {
                valido: false,
                erros: [{ campo: 'dados', mensagem: 'Dados não informados' }],
            };
        }
        try {
            // Buscar esquema de campos para o tipo de benefício
            const campos = await this.campoDinamicoRepository.find({
                where: { tipo_beneficio_id: tipoBeneficioId, ativo: true },
                order: { ordem: 'ASC' },
            });
            if (!campos || campos.length === 0) {
                this.logger.warn(`Nenhum campo dinâmico encontrado para o tipo de benefício ${tipoBeneficioId}`);
                return { valido: true, erros: [] }; // Se não há campos definidos, considera válido
            }
            const erros = [];
            // Validar campos obrigatórios e tipos
            for (const campo of campos) {
                // Verificar se campo obrigatório foi informado
                if (campo.obrigatorio &&
                    (dados[campo.nome] === undefined || dados[campo.nome] === null)) {
                    erros.push({
                        campo: campo.nome,
                        mensagem: `O campo ${campo.label} é obrigatório`,
                    });
                    continue;
                }
                // Se o campo não foi informado e não é obrigatório, continua
                if (dados[campo.nome] === undefined || dados[campo.nome] === null) {
                    continue;
                }
                // Validar tipo do campo
                const valorCampo = dados[campo.nome];
                switch (campo.tipo) {
                    case campo_dinamico_beneficio_entity_1.TipoDado.STRING:
                        this.validarString(campo, valorCampo, erros);
                        break;
                    case campo_dinamico_beneficio_entity_1.TipoDado.NUMBER:
                        this.validarNumber(campo, valorCampo, erros);
                        break;
                    case campo_dinamico_beneficio_entity_1.TipoDado.BOOLEAN:
                        this.validarBoolean(campo, valorCampo, erros);
                        break;
                    case campo_dinamico_beneficio_entity_1.TipoDado.DATE:
                        this.validarDate(campo, valorCampo, erros);
                        break;
                    case campo_dinamico_beneficio_entity_1.TipoDado.ARRAY:
                        this.validarArray(campo, valorCampo, erros);
                        break;
                    case campo_dinamico_beneficio_entity_1.TipoDado.OBJECT:
                        this.validarObject(campo, valorCampo, erros);
                        break;
                }
            }
            return {
                valido: erros.length === 0,
                erros,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao validar campos dinâmicos: ${error.message}`, error.stack);
            throw new common_1.BadRequestException('Erro ao validar campos dinâmicos');
        }
    }
    /**
     * Valida campo do tipo string
     */
    validarString(campo, valor, erros) {
        if (typeof valor !== 'string') {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser um texto`,
            });
            return;
        }
        const validacoes = campo.validacoes || {};
        // Validar tamanho mínimo
        if (validacoes.minLength !== undefined &&
            valor.length < validacoes.minLength) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ter no mínimo ${validacoes.minLength} caracteres`,
            });
        }
        // Validar tamanho máximo
        if (validacoes.maxLength !== undefined &&
            valor.length > validacoes.maxLength) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} não pode ter mais de ${validacoes.maxLength} caracteres`,
            });
        }
        // Validar padrão (regex)
        if (validacoes.pattern && !new RegExp(validacoes.pattern).test(valor)) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} não está no formato esperado`,
            });
        }
        // Validar enum (valores permitidos)
        if (validacoes.enum &&
            Array.isArray(validacoes.enum) &&
            !validacoes.enum.includes(valor)) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser um dos seguintes valores: ${validacoes.enum.join(', ')}`,
            });
        }
    }
    /**
     * Valida campo do tipo number
     */
    validarNumber(campo, valor, erros) {
        // Converter para número se for string numérica
        if (typeof valor === 'string' && !isNaN(Number(valor))) {
            valor = Number(valor);
        }
        if (typeof valor !== 'number' || isNaN(valor)) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser um número`,
            });
            return;
        }
        const validacoes = campo.validacoes || {};
        // Validar valor mínimo
        if (validacoes.min !== undefined && valor < validacoes.min) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser maior ou igual a ${validacoes.min}`,
            });
        }
        // Validar valor máximo
        if (validacoes.max !== undefined && valor > validacoes.max) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser menor ou igual a ${validacoes.max}`,
            });
        }
    }
    /**
     * Valida campo do tipo boolean
     */
    validarBoolean(campo, valor, erros) {
        // Converter strings 'true' e 'false' para boolean
        if (valor === 'true') {
            valor = true;
        }
        if (valor === 'false') {
            valor = false;
        }
        if (typeof valor !== 'boolean') {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser um valor booleano (verdadeiro/falso)`,
            });
        }
    }
    /**
     * Valida campo do tipo date
     */
    validarDate(campo, valor, erros) {
        // Tentar converter para data
        const data = new Date(valor);
        if (isNaN(data.getTime())) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser uma data válida`,
            });
            return;
        }
        const validacoes = campo.validacoes || {};
        // Validar data mínima
        if (validacoes.min && new Date(validacoes.min) > data) {
            const dataMinima = new Date(validacoes.min).toLocaleDateString('pt-BR');
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser uma data posterior a ${dataMinima}`,
            });
        }
        // Validar data máxima
        if (validacoes.max && new Date(validacoes.max) < data) {
            const dataMaxima = new Date(validacoes.max).toLocaleDateString('pt-BR');
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser uma data anterior a ${dataMaxima}`,
            });
        }
    }
    /**
     * Valida campo do tipo array
     */
    validarArray(campo, valor, erros) {
        if (!Array.isArray(valor)) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser uma lista`,
            });
            return;
        }
        const validacoes = campo.validacoes || {};
        // Validar tamanho mínimo
        if (validacoes.minLength !== undefined &&
            valor.length < validacoes.minLength) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ter no mínimo ${validacoes.minLength} item(ns)`,
            });
        }
        // Validar tamanho máximo
        if (validacoes.maxLength !== undefined &&
            valor.length > validacoes.maxLength) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} não pode ter mais de ${validacoes.maxLength} item(ns)`,
            });
        }
    }
    /**
     * Valida campo do tipo object
     */
    validarObject(campo, valor, erros) {
        if (typeof valor !== 'object' || valor === null || Array.isArray(valor)) {
            erros.push({
                campo: campo.nome,
                mensagem: `O campo ${campo.label} deve ser um objeto`,
            });
        }
    }
};
exports.ValidacaoDinamicaService = ValidacaoDinamicaService;
exports.ValidacaoDinamicaService = ValidacaoDinamicaService = ValidacaoDinamicaService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(campo_dinamico_beneficio_entity_1.CampoDinamicoBeneficio)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object])
], ValidacaoDinamicaService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGJlbmVmaWNpb1xcc2VydmljZXNcXHZhbGlkYWNhby1kaW5hbWljYS5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWlFO0FBQ2pFLDZDQUFtRDtBQUNuRCxxQ0FBcUM7QUFDckMsdUdBRzJEO0FBQzNELDJDQUF3QztBQWF4Qzs7Ozs7R0FLRztBQUVJLElBQU0sd0JBQXdCLGdDQUE5QixNQUFNLHdCQUF3QjtJQUt6QjtJQUpPLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQywwQkFBd0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVwRSxZQUVVLHVCQUEyRDtRQUEzRCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQW9DO0lBQ2xFLENBQUM7SUFFSjs7Ozs7O09BTUc7SUFDSCxLQUFLLENBQUMsc0JBQXNCLENBQzFCLGVBQXVCLEVBQ3ZCLEtBQVU7UUFFVixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxPQUFPO2dCQUNMLE1BQU0sRUFBRSxLQUFLO2dCQUNiLEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQzthQUM5RCxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQztZQUNILG9EQUFvRDtZQUNwRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUM7Z0JBQ3JELEtBQUssRUFBRSxFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO2dCQUMxRCxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFO2FBQ3hCLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDbkMs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LEVBQUUsQ0FBQztZQUN4RSxLQUFLLENBQUMsSUFBSSxDQUFDO2dCQUNULEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSTtnQkFDakIsUUFBUSxFQUFFLFdBQVcsS0FBSyxDQUFDLEtBQUsscUJBQXFCO2FBQ3RELENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQWxVWSw0REFBd0I7bUNBQXhCLHdCQUF3QjtJQURwQyxJQUFBLG1CQUFVLEdBQUU7SUFLUixXQUFBLElBQUEsMEJBQWdCLEVBQUMsd0RBQXNCLENBQUMsQ0FBQTt5REFDUixvQkFBVSxvQkFBVixvQkFBVTtHQUxsQyx3QkFBd0IsQ0FrVXBDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxiZW5lZmljaW9cXHNlcnZpY2VzXFx2YWxpZGFjYW8tZGluYW1pY2Euc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQge1xuICBDYW1wb0RpbmFtaWNvQmVuZWZpY2lvLFxuICBUaXBvRGFkbyxcbn0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY2FtcG8tZGluYW1pY28tYmVuZWZpY2lvLmVudGl0eSc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5cbi8qKlxuICogSW50ZXJmYWNlIHBhcmEgcmVzdWx0YWRvIGRlIHZhbGlkYcOnw6NvXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVmFsaWRhdGlvblJlc3VsdCB7XG4gIHZhbGlkbzogYm9vbGVhbjtcbiAgZXJyb3M6IEFycmF5PHtcbiAgICBjYW1wbzogc3RyaW5nO1xuICAgIG1lbnNhZ2VtOiBzdHJpbmc7XG4gIH0+O1xufVxuXG4vKipcbiAqIFNlcnZpw6dvIGRlIFZhbGlkYcOnw6NvIERpbsOibWljYVxuICpcbiAqIFJlc3BvbnPDoXZlbCBwb3IgdmFsaWRhciBkYWRvcyBkaW7Dom1pY29zIGNvbmZvcm1lIGVzcXVlbWEgZGVmaW5pZG9cbiAqIHBhcmEgY2FkYSB0aXBvIGRlIGJlbmVmw61jaW8uXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBWYWxpZGFjYW9EaW5hbWljYVNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoVmFsaWRhY2FvRGluYW1pY2FTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KENhbXBvRGluYW1pY29CZW5lZmljaW8pXG4gICAgcHJpdmF0ZSBjYW1wb0RpbmFtaWNvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDYW1wb0RpbmFtaWNvQmVuZWZpY2lvPixcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgZGFkb3MgZGluw6JtaWNvcyBjb25mb3JtZSBlc3F1ZW1hIGRlZmluaWRvIHBhcmEgbyB0aXBvIGRlIGJlbmVmw61jaW9cbiAgICpcbiAgICogQHBhcmFtIHRpcG9CZW5lZmljaW9JZCBJRCBkbyB0aXBvIGRlIGJlbmVmw61jaW9cbiAgICogQHBhcmFtIGRhZG9zIERhZG9zIGEgc2VyZW0gdmFsaWRhZG9zXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB2YWxpZGHDp8Ojb1xuICAgKi9cbiAgYXN5bmMgdmFsaWRhckNhbXBvc0RpbmFtaWNvcyhcbiAgICB0aXBvQmVuZWZpY2lvSWQ6IHN0cmluZyxcbiAgICBkYWRvczogYW55LFxuICApOiBQcm9taXNlPFZhbGlkYXRpb25SZXN1bHQ+IHtcbiAgICBpZiAoIWRhZG9zKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZG86IGZhbHNlLFxuICAgICAgICBlcnJvczogW3sgY2FtcG86ICdkYWRvcycsIG1lbnNhZ2VtOiAnRGFkb3MgbsOjbyBpbmZvcm1hZG9zJyB9XSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEJ1c2NhciBlc3F1ZW1hIGRlIGNhbXBvcyBwYXJhIG8gdGlwbyBkZSBiZW5lZsOtY2lvXG4gICAgICBjb25zdCBjYW1wb3MgPSBhd2FpdCB0aGlzLmNhbXBvRGluYW1pY29SZXBvc2l0b3J5LmZpbmQoe1xuICAgICAgICB3aGVyZTogeyB0aXBvX2JlbmVmaWNpb19pZDogdGlwb0JlbmVmaWNpb0lkLCBhdGl2bzogdHJ1ZSB9LFxuICAgICAgICBvcmRlcjogeyBvcmRlbTogJ0FTQycgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWNhbXBvcyB8fCBjYW1wb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYE5lbmh1bSBjYW1wbyBkaW7Dom1pY28gZW5jb250cmFkbyBwYXJhIG8gdGlwbyBkZSBiZW5lZsOtY2lvICR7dGlwb0JlbmVmaWNpb0lkfWAsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiB7IHZhbGlkbzogdHJ1ZSwgZXJyb3M6IFtdIH07IC8vIFNlIG7Do28gaMOhIGNhbXBvcyBkZWZpbmlkb3MsIGNvbnNpZGVyYSB2w6FsaWRvXG4gICAgICB9XG5cbiAgICAgIC8vIERlZmluaXIgbyB0aXBvIGFwcm9wcmlhZG8gcGFyYSBvIGFycmF5IGRlIGVycm9zXG4gICAgICB0eXBlIEVycm9WYWxpZGFjYW8gPSB7IGNhbXBvOiBzdHJpbmc7IG1lbnNhZ2VtOiBzdHJpbmcgfTtcbiAgICAgIGNvbnN0IGVycm9zOiBFcnJvVmFsaWRhY2FvW10gPSBbXTtcblxuICAgICAgLy8gVmFsaWRhciBjYW1wb3Mgb2JyaWdhdMOzcmlvcyBlIHRpcG9zXG4gICAgICBmb3IgKGNvbnN0IGNhbXBvIG9mIGNhbXBvcykge1xuICAgICAgICAvLyBWZXJpZmljYXIgc2UgY2FtcG8gb2JyaWdhdMOzcmlvIGZvaSBpbmZvcm1hZG9cbiAgICAgICAgaWYgKFxuICAgICAgICAgIGNhbXBvLm9icmlnYXRvcmlvICYmXG4gICAgICAgICAgKGRhZG9zW2NhbXBvLm5vbWVdID09PSB1bmRlZmluZWQgfHwgZGFkb3NbY2FtcG8ubm9tZV0gPT09IG51bGwpXG4gICAgICAgICkge1xuICAgICAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgICAgICBtZW5zYWdlbTogYE8gY2FtcG8gJHtjYW1wby5sYWJlbH0gw6kgb2JyaWdhdMOzcmlvYCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNlIG8gY2FtcG8gbsOjbyBmb2kgaW5mb3JtYWRvIGUgbsOjbyDDqSBvYnJpZ2F0w7NyaW8sIGNvbnRpbnVhXG4gICAgICAgIGlmIChkYWRvc1tjYW1wby5ub21lXSA9PT0gdW5kZWZpbmVkIHx8IGRhZG9zW2NhbXBvLm5vbWVdID09PSBudWxsKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWxpZGFyIHRpcG8gZG8gY2FtcG9cbiAgICAgICAgY29uc3QgdmFsb3JDYW1wbyA9IGRhZG9zW2NhbXBvLm5vbWVdO1xuXG4gICAgICAgIHN3aXRjaCAoY2FtcG8udGlwbykge1xuICAgICAgICAgIGNhc2UgVGlwb0RhZG8uU1RSSU5HOlxuICAgICAgICAgICAgdGhpcy52YWxpZGFyU3RyaW5nKGNhbXBvLCB2YWxvckNhbXBvLCBlcnJvcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFRpcG9EYWRvLk5VTUJFUjpcbiAgICAgICAgICAgIHRoaXMudmFsaWRhck51bWJlcihjYW1wbywgdmFsb3JDYW1wbywgZXJyb3MpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBUaXBvRGFkby5CT09MRUFOOlxuICAgICAgICAgICAgdGhpcy52YWxpZGFyQm9vbGVhbihjYW1wbywgdmFsb3JDYW1wbywgZXJyb3MpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBUaXBvRGFkby5EQVRFOlxuICAgICAgICAgICAgdGhpcy52YWxpZGFyRGF0ZShjYW1wbywgdmFsb3JDYW1wbywgZXJyb3MpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBUaXBvRGFkby5BUlJBWTpcbiAgICAgICAgICAgIHRoaXMudmFsaWRhckFycmF5KGNhbXBvLCB2YWxvckNhbXBvLCBlcnJvcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFRpcG9EYWRvLk9CSkVDVDpcbiAgICAgICAgICAgIHRoaXMudmFsaWRhck9iamVjdChjYW1wbywgdmFsb3JDYW1wbywgZXJyb3MpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWRvOiBlcnJvcy5sZW5ndGggPT09IDAsXG4gICAgICAgIGVycm9zLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIHZhbGlkYXIgY2FtcG9zIGRpbsOibWljb3M6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRXJybyBhbyB2YWxpZGFyIGNhbXBvcyBkaW7Dom1pY29zJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBjYW1wbyBkbyB0aXBvIHN0cmluZ1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGFyU3RyaW5nKFxuICAgIGNhbXBvOiBDYW1wb0RpbmFtaWNvQmVuZWZpY2lvLFxuICAgIHZhbG9yOiBhbnksXG4gICAgZXJyb3M6IEFycmF5PHsgY2FtcG86IHN0cmluZzsgbWVuc2FnZW06IHN0cmluZyB9PixcbiAgKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiB2YWxvciAhPT0gJ3N0cmluZycpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtIHRleHRvYCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkYWNvZXMgPSBjYW1wby52YWxpZGFjb2VzIHx8IHt9O1xuXG4gICAgLy8gVmFsaWRhciB0YW1hbmhvIG3DrW5pbW9cbiAgICBpZiAoXG4gICAgICB2YWxpZGFjb2VzLm1pbkxlbmd0aCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICB2YWxvci5sZW5ndGggPCB2YWxpZGFjb2VzLm1pbkxlbmd0aFxuICAgICkge1xuICAgICAgZXJyb3MucHVzaCh7XG4gICAgICAgIGNhbXBvOiBjYW1wby5ub21lLFxuICAgICAgICBtZW5zYWdlbTogYE8gY2FtcG8gJHtjYW1wby5sYWJlbH0gZGV2ZSB0ZXIgbm8gbcOtbmltbyAke3ZhbGlkYWNvZXMubWluTGVuZ3RofSBjYXJhY3RlcmVzYCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXIgdGFtYW5obyBtw6F4aW1vXG4gICAgaWYgKFxuICAgICAgdmFsaWRhY29lcy5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCAmJlxuICAgICAgdmFsb3IubGVuZ3RoID4gdmFsaWRhY29lcy5tYXhMZW5ndGhcbiAgICApIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IG7Do28gcG9kZSB0ZXIgbWFpcyBkZSAke3ZhbGlkYWNvZXMubWF4TGVuZ3RofSBjYXJhY3RlcmVzYCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXIgcGFkcsOjbyAocmVnZXgpXG4gICAgaWYgKHZhbGlkYWNvZXMucGF0dGVybiAmJiAhbmV3IFJlZ0V4cCh2YWxpZGFjb2VzLnBhdHRlcm4pLnRlc3QodmFsb3IpKSB7XG4gICAgICBlcnJvcy5wdXNoKHtcbiAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgTyBjYW1wbyAke2NhbXBvLmxhYmVsfSBuw6NvIGVzdMOhIG5vIGZvcm1hdG8gZXNwZXJhZG9gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhciBlbnVtICh2YWxvcmVzIHBlcm1pdGlkb3MpXG4gICAgaWYgKFxuICAgICAgdmFsaWRhY29lcy5lbnVtICYmXG4gICAgICBBcnJheS5pc0FycmF5KHZhbGlkYWNvZXMuZW51bSkgJiZcbiAgICAgICF2YWxpZGFjb2VzLmVudW0uaW5jbHVkZXModmFsb3IpXG4gICAgKSB7XG4gICAgICBlcnJvcy5wdXNoKHtcbiAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgTyBjYW1wbyAke2NhbXBvLmxhYmVsfSBkZXZlIHNlciB1bSBkb3Mgc2VndWludGVzIHZhbG9yZXM6ICR7dmFsaWRhY29lcy5lbnVtLmpvaW4oJywgJyl9YCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgY2FtcG8gZG8gdGlwbyBudW1iZXJcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhck51bWJlcihcbiAgICBjYW1wbzogQ2FtcG9EaW5hbWljb0JlbmVmaWNpbyxcbiAgICB2YWxvcjogYW55LFxuICAgIGVycm9zOiBBcnJheTx7IGNhbXBvOiBzdHJpbmc7IG1lbnNhZ2VtOiBzdHJpbmcgfT4sXG4gICk6IHZvaWQge1xuICAgIC8vIENvbnZlcnRlciBwYXJhIG7Dum1lcm8gc2UgZm9yIHN0cmluZyBudW3DqXJpY2FcbiAgICBpZiAodHlwZW9mIHZhbG9yID09PSAnc3RyaW5nJyAmJiAhaXNOYU4oTnVtYmVyKHZhbG9yKSkpIHtcbiAgICAgIHZhbG9yID0gTnVtYmVyKHZhbG9yKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZhbG9yICE9PSAnbnVtYmVyJyB8fCBpc05hTih2YWxvcikpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtIG7Dum1lcm9gLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhY29lcyA9IGNhbXBvLnZhbGlkYWNvZXMgfHwge307XG5cbiAgICAvLyBWYWxpZGFyIHZhbG9yIG3DrW5pbW9cbiAgICBpZiAodmFsaWRhY29lcy5taW4gIT09IHVuZGVmaW5lZCAmJiB2YWxvciA8IHZhbGlkYWNvZXMubWluKSB7XG4gICAgICBlcnJvcy5wdXNoKHtcbiAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgTyBjYW1wbyAke2NhbXBvLmxhYmVsfSBkZXZlIHNlciBtYWlvciBvdSBpZ3VhbCBhICR7dmFsaWRhY29lcy5taW59YCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXIgdmFsb3IgbcOheGltb1xuICAgIGlmICh2YWxpZGFjb2VzLm1heCAhPT0gdW5kZWZpbmVkICYmIHZhbG9yID4gdmFsaWRhY29lcy5tYXgpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIG1lbm9yIG91IGlndWFsIGEgJHt2YWxpZGFjb2VzLm1heH1gLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBjYW1wbyBkbyB0aXBvIGJvb2xlYW5cbiAgICovXG4gIHByaXZhdGUgdmFsaWRhckJvb2xlYW4oXG4gICAgY2FtcG86IENhbXBvRGluYW1pY29CZW5lZmljaW8sXG4gICAgdmFsb3I6IGFueSxcbiAgICBlcnJvczogQXJyYXk8eyBjYW1wbzogc3RyaW5nOyBtZW5zYWdlbTogc3RyaW5nIH0+LFxuICApOiB2b2lkIHtcbiAgICAvLyBDb252ZXJ0ZXIgc3RyaW5ncyAndHJ1ZScgZSAnZmFsc2UnIHBhcmEgYm9vbGVhblxuICAgIGlmICh2YWxvciA9PT0gJ3RydWUnKSB7XG4gICAgICB2YWxvciA9IHRydWU7XG4gICAgfVxuICAgIGlmICh2YWxvciA9PT0gJ2ZhbHNlJykge1xuICAgICAgdmFsb3IgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZhbG9yICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtIHZhbG9yIGJvb2xlYW5vICh2ZXJkYWRlaXJvL2ZhbHNvKWAsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIGNhbXBvIGRvIHRpcG8gZGF0ZVxuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGFyRGF0ZShcbiAgICBjYW1wbzogQ2FtcG9EaW5hbWljb0JlbmVmaWNpbyxcbiAgICB2YWxvcjogYW55LFxuICAgIGVycm9zOiBBcnJheTx7IGNhbXBvOiBzdHJpbmc7IG1lbnNhZ2VtOiBzdHJpbmcgfT4sXG4gICk6IHZvaWQge1xuICAgIC8vIFRlbnRhciBjb252ZXJ0ZXIgcGFyYSBkYXRhXG4gICAgY29uc3QgZGF0YSA9IG5ldyBEYXRlKHZhbG9yKTtcblxuICAgIGlmIChpc05hTihkYXRhLmdldFRpbWUoKSkpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtYSBkYXRhIHbDoWxpZGFgLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhY29lcyA9IGNhbXBvLnZhbGlkYWNvZXMgfHwge307XG5cbiAgICAvLyBWYWxpZGFyIGRhdGEgbcOtbmltYVxuICAgIGlmICh2YWxpZGFjb2VzLm1pbiAmJiBuZXcgRGF0ZSh2YWxpZGFjb2VzLm1pbikgPiBkYXRhKSB7XG4gICAgICBjb25zdCBkYXRhTWluaW1hID0gbmV3IERhdGUodmFsaWRhY29lcy5taW4pLnRvTG9jYWxlRGF0ZVN0cmluZygncHQtQlInKTtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtYSBkYXRhIHBvc3RlcmlvciBhICR7ZGF0YU1pbmltYX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhciBkYXRhIG3DoXhpbWFcbiAgICBpZiAodmFsaWRhY29lcy5tYXggJiYgbmV3IERhdGUodmFsaWRhY29lcy5tYXgpIDwgZGF0YSkge1xuICAgICAgY29uc3QgZGF0YU1heGltYSA9IG5ldyBEYXRlKHZhbGlkYWNvZXMubWF4KS50b0xvY2FsZURhdGVTdHJpbmcoJ3B0LUJSJyk7XG4gICAgICBlcnJvcy5wdXNoKHtcbiAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgTyBjYW1wbyAke2NhbXBvLmxhYmVsfSBkZXZlIHNlciB1bWEgZGF0YSBhbnRlcmlvciBhICR7ZGF0YU1heGltYX1gLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBjYW1wbyBkbyB0aXBvIGFycmF5XG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXJBcnJheShcbiAgICBjYW1wbzogQ2FtcG9EaW5hbWljb0JlbmVmaWNpbyxcbiAgICB2YWxvcjogYW55LFxuICAgIGVycm9zOiBBcnJheTx7IGNhbXBvOiBzdHJpbmc7IG1lbnNhZ2VtOiBzdHJpbmcgfT4sXG4gICk6IHZvaWQge1xuICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWxvcikpIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgc2VyIHVtYSBsaXN0YWAsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGFjb2VzID0gY2FtcG8udmFsaWRhY29lcyB8fCB7fTtcblxuICAgIC8vIFZhbGlkYXIgdGFtYW5obyBtw61uaW1vXG4gICAgaWYgKFxuICAgICAgdmFsaWRhY29lcy5taW5MZW5ndGggIT09IHVuZGVmaW5lZCAmJlxuICAgICAgdmFsb3IubGVuZ3RoIDwgdmFsaWRhY29lcy5taW5MZW5ndGhcbiAgICApIHtcbiAgICAgIGVycm9zLnB1c2goe1xuICAgICAgICBjYW1wbzogY2FtcG8ubm9tZSxcbiAgICAgICAgbWVuc2FnZW06IGBPIGNhbXBvICR7Y2FtcG8ubGFiZWx9IGRldmUgdGVyIG5vIG3DrW5pbW8gJHt2YWxpZGFjb2VzLm1pbkxlbmd0aH0gaXRlbShucylgLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhciB0YW1hbmhvIG3DoXhpbW9cbiAgICBpZiAoXG4gICAgICB2YWxpZGFjb2VzLm1heExlbmd0aCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICB2YWxvci5sZW5ndGggPiB2YWxpZGFjb2VzLm1heExlbmd0aFxuICAgICkge1xuICAgICAgZXJyb3MucHVzaCh7XG4gICAgICAgIGNhbXBvOiBjYW1wby5ub21lLFxuICAgICAgICBtZW5zYWdlbTogYE8gY2FtcG8gJHtjYW1wby5sYWJlbH0gbsOjbyBwb2RlIHRlciBtYWlzIGRlICR7dmFsaWRhY29lcy5tYXhMZW5ndGh9IGl0ZW0obnMpYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgY2FtcG8gZG8gdGlwbyBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhck9iamVjdChcbiAgICBjYW1wbzogQ2FtcG9EaW5hbWljb0JlbmVmaWNpbyxcbiAgICB2YWxvcjogYW55LFxuICAgIGVycm9zOiBBcnJheTx7IGNhbXBvOiBzdHJpbmc7IG1lbnNhZ2VtOiBzdHJpbmcgfT4sXG4gICk6IHZvaWQge1xuICAgIGlmICh0eXBlb2YgdmFsb3IgIT09ICdvYmplY3QnIHx8IHZhbG9yID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkodmFsb3IpKSB7XG4gICAgICBlcnJvcy5wdXNoKHtcbiAgICAgICAgY2FtcG86IGNhbXBvLm5vbWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgTyBjYW1wbyAke2NhbXBvLmxhYmVsfSBkZXZlIHNlciB1bSBvYmpldG9gLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=