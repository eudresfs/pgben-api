f25abdc750eb1ae6e389323e4e216096
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuthService_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const jwt_1 = require("@nestjs/jwt");
const class_transformer_1 = require("class-transformer");
const logger_service_1 = require("../../shared/logger/logger.service");
const usuario_service_1 = require("../../modules/usuario/services/usuario.service");
const auth_token_output_dto_1 = require("../dtos/auth-token-output.dto");
const usuario_adapter_1 = require("../adapters/usuario-adapter");
const refresh_token_service_1 = require("./refresh-token.service");
const permission_service_1 = require("./permission.service");
let AuthService = AuthService_1 = class AuthService {
    usuarioService;
    refreshTokenService;
    jwtService;
    configService;
    logger;
    permissionService;
    // Valores padrão no formato semântico
    DEFAULT_ACCESS_TOKEN_EXPIRES_IN = '1h';
    DEFAULT_REFRESH_TOKEN_EXPIRES_IN = '7d';
    /**
     * Gera um JTI (JWT ID) único
     * @returns string - JTI único
     */
    generateJti() {
        // Combinar timestamp, número aleatório e hash para garantir unicidade
        const timestamp = Date.now().toString(36);
        const randomPart = Math.random().toString(36).substring(2, 15);
        return `${timestamp}-${randomPart}`;
    }
    constructor(usuarioService, refreshTokenService, jwtService, configService, logger, permissionService) {
        this.usuarioService = usuarioService;
        this.refreshTokenService = refreshTokenService;
        this.jwtService = jwtService;
        this.configService = configService;
        this.logger = logger;
        this.permissionService = permissionService;
        this.logger.setContext(AuthService_1.name);
        // Log das configurações de token
        const accessTokenExpiresIn = this.getAccessTokenExpiresIn();
        const refreshTokenExpiresIn = this.getRefreshTokenExpiresIn();
        this.logger.log({}, `Configuração de tokens - Access Token: ${accessTokenExpiresIn}, ` +
            `Refresh Token: ${refreshTokenExpiresIn} ` +
            `(em segundos: ${this.timeToSeconds(refreshTokenExpiresIn)})`);
        // Debug das variáveis de ambiente
        console.log('JWT_REFRESH_TOKEN_EXPIRES_IN:', this.configService.get('JWT_REFRESH_TOKEN_EXPIRES_IN', 'não definido'));
        console.log('JWT_ACCESS_TOKEN_EXPIRES_IN:', this.configService.get('JWT_ACCESS_TOKEN_EXPIRES_IN', 'não definido'));
    }
    /**
     * Obtém o tempo de expiração do access token no formato semântico (1h, 7d, etc)
     */
    getAccessTokenExpiresIn() {
        return this.configService.get('JWT_ACCESS_TOKEN_EXPIRES_IN', this.DEFAULT_ACCESS_TOKEN_EXPIRES_IN);
    }
    /**
     * Obtém o tempo de expiração do refresh token no formato semântico (1h, 7d, etc)
     */
    getRefreshTokenExpiresIn() {
        return this.configService.get('JWT_REFRESH_TOKEN_EXPIRES_IN', this.DEFAULT_REFRESH_TOKEN_EXPIRES_IN);
    }
    /**
     * Converte uma string de tempo no formato semântico (1h, 7d, etc) para segundos
     */
    timeToSeconds(timeString) {
        // Se for apenas um número, considera como segundos
        if (/^\d+$/.test(timeString)) {
            return parseInt(timeString, 10);
        }
        // Se for no formato número+unidade (ex: 7d, 24h, etc)
        const match = timeString.match(/^(\d+)([smhdw])$/);
        if (match) {
            const value = parseInt(match[1], 10);
            const unit = match[2];
            switch (unit) {
                case 's':
                    return value; // segundos
                case 'm':
                    return value * 60; // minutos
                case 'h':
                    return value * 60 * 60; // horas
                case 'd':
                    return value * 24 * 60 * 60; // dias
                case 'w':
                    return value * 7 * 24 * 60 * 60; // semanas
                default:
                    return 86400; // padrão: 1 dia
            }
        }
        // Fallback para valores que não conseguimos interpretar
        this.logger.warn({}, `Não foi possível interpretar o formato de tempo: ${timeString}, usando 1 dia como padrão`);
        return 86400; // 1 dia em segundos
    }
    async validateUser(ctx, username, pass) {
        this.logger.log(ctx, `${this.validateUser.name} foi chamado`);
        // Buscar usuário pelo email (username)
        const usuario = await this.usuarioService.findByEmail(username);
        if (!usuario) {
            throw new common_1.UnauthorizedException('Nome de usuário ou senha inválidos');
        }
        // Verificar se a senha está correta
        const senhaCorreta = await require('bcrypt').compare(pass, usuario.senhaHash);
        if (!senhaCorreta) {
            throw new common_1.UnauthorizedException('Nome de usuário ou senha inválidos');
        }
        // Verificar se o usuário está ativo
        if (usuario.status === 'inativo') {
            throw new common_1.UnauthorizedException('Esta conta de usuário foi desativada');
        }
        // Obter as permissões do usuário
        const permissions = await this.permissionService.getUserPermissions(usuario.id);
        // Obter os escopos das permissões
        const permissionScopes = {};
        // Converter para o formato esperado incluindo permissões
        return usuario_adapter_1.UsuarioAdapter.toUserAccessTokenClaims(usuario, permissions, permissionScopes);
    }
    async login(ctx) {
        this.logger.log(ctx, `${this.login.name} foi chamado`);
        // Obter o token de autenticação
        const tokens = this.getAuthToken(ctx, ctx.user);
        // Criar e salvar o refresh token
        const usuario = await this.usuarioService.findById(ctx.user.id);
        if (!usuario) {
            throw new common_1.UnauthorizedException('Usuário não encontrado');
        }
        // Obter o tempo de expiração
        const refreshTokenExpiresIn = this.getRefreshTokenExpiresIn();
        const refreshTokenSeconds = this.timeToSeconds(refreshTokenExpiresIn);
        this.logger.log(ctx, `Criando refresh token com duração de ${refreshTokenExpiresIn} (${refreshTokenSeconds} segundos)`);
        const refreshToken = await this.refreshTokenService.createToken(usuario, refreshTokenSeconds);
        return {
            ...tokens,
            refreshToken: refreshToken.token,
        };
    }
    async refreshToken(ctx, refreshTokenInput) {
        this.logger.log(ctx, `${this.refreshToken.name} foi chamado`);
        // Encontrar o token de refresh
        const refreshToken = await this.refreshTokenService.findToken(refreshTokenInput.refreshToken);
        // Verificar se o token existe e não foi revogado
        if (!refreshToken || refreshToken.revoked) {
            throw new common_1.UnauthorizedException('Token de refresh inválido');
        }
        // Verificar se o token expirou
        if (new Date() > refreshToken.expires_at) {
            throw new common_1.UnauthorizedException('Token de refresh expirado');
        }
        // Revogar apenas o token de refresh atual
        // Não adicionamos o access token à blacklist, pois isso causaria problemas
        // com requisições subsequentes
        const ipAddress = ctx.req?.ip || '0.0.0.0';
        await this.refreshTokenService.revokeToken(refreshToken.token, ipAddress);
        // Não revogar tokens descendentes para evitar problemas com a blacklist
        // await this.refreshTokenService.revokeDescendantTokens(
        //   refreshToken,
        //   ipAddress,
        // );
        // Obter o usuário
        const usuario = await this.usuarioService.findById(refreshToken.usuario.id);
        if (!usuario) {
            throw new common_1.UnauthorizedException('Usuário não encontrado');
        }
        // Gerar novos tokens
        const userOutput = usuario_adapter_1.UsuarioAdapter.toUserOutput(usuario);
        const tokens = this.getAuthToken(ctx, userOutput);
        // Obter o tempo de expiração
        const refreshTokenExpiresIn = this.getRefreshTokenExpiresIn();
        const refreshTokenSeconds = this.timeToSeconds(refreshTokenExpiresIn);
        this.logger.log(ctx, `Criando novo refresh token com duração de ${refreshTokenExpiresIn} (${refreshTokenSeconds} segundos)`);
        const newRefreshToken = await this.refreshTokenService.createToken(usuario, refreshTokenSeconds);
        return {
            ...tokens,
            refreshToken: newRefreshToken.token,
        };
    }
    getAuthToken(ctx, user) {
        this.logger.log(ctx, `${this.getAuthToken.name} was called`);
        // Gerar um JTI (JWT ID) único para cada token
        const jti = this.generateJti();
        const subject = { sub: user.id };
        const payload = {
            username: user.username,
            sub: user.id,
            roles: user.roles,
        };
        // Adicionar permissões ao payload se disponíveis
        if ('permissions' in user && user.permissions) {
            payload['permissions'] = user.permissions;
        }
        // Adicionar escopos de permissões ao payload se disponíveis
        if ('permissionScopes' in user && user.permissionScopes) {
            payload['permissionScopes'] = user.permissionScopes;
        }
        // Garantir que estamos usando o algoritmo RS256 e a chave privada para assinar o token
        const privateKey = Buffer.from(this.configService.get('JWT_PRIVATE_KEY_BASE64', ''), 'base64').toString('utf8');
        // Obter valores de expiração no formato semântico
        const accessTokenExpiresIn = this.getAccessTokenExpiresIn();
        const refreshTokenExpiresIn = this.getRefreshTokenExpiresIn();
        this.logger.log(ctx, `Gerando tokens - Access token expira em: ${accessTokenExpiresIn}, Refresh token expira em: ${refreshTokenExpiresIn}`);
        const accessToken = this.jwtService.sign({
            ...payload,
            ...subject,
        }, {
            secret: privateKey,
            algorithm: 'RS256',
            expiresIn: accessTokenExpiresIn,
            jwtid: jti,
        });
        // Para o refreshToken, usamos o mesmo JwtService, mas com opções diferentes de expiração
        // Gerar um JTI diferente para o refresh token
        const refreshJti = this.generateJti();
        const refreshTokenJwt = this.jwtService.sign({
            ...subject,
        }, {
            secret: privateKey,
            algorithm: 'RS256',
            expiresIn: refreshTokenExpiresIn,
            jwtid: refreshJti,
        });
        const authToken = {
            accessToken,
            refreshToken: refreshTokenJwt,
        };
        return (0, class_transformer_1.plainToClass)(auth_token_output_dto_1.AuthTokenOutput, authToken, {
            excludeExtraneousValues: true,
        });
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = AuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof usuario_service_1.UsuarioService !== "undefined" && usuario_service_1.UsuarioService) === "function" ? _a : Object, typeof (_b = typeof refresh_token_service_1.RefreshTokenService !== "undefined" && refresh_token_service_1.RefreshTokenService) === "function" ? _b : Object, typeof (_c = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _c : Object, typeof (_d = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _d : Object, typeof (_e = typeof logger_service_1.AppLogger !== "undefined" && logger_service_1.AppLogger) === "function" ? _e : Object, typeof (_f = typeof permission_service_1.PermissionService !== "undefined" && permission_service_1.PermissionService) === "function" ? _f : Object])
], AuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxhdXRoLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBbUU7QUFDbkUsMkNBQStDO0FBQy9DLHFDQUF5QztBQUN6Qyx5REFBaUQ7QUFJakQsdUVBQStEO0FBRS9ELG9GQUFnRjtBQUdoRix5RUFHdUM7QUFDdkMsaUVBQXlFO0FBQ3pFLG1FQUE4RDtBQUc5RCw2REFBeUQ7QUFHbEQsSUFBTSxXQUFXLG1CQUFqQixNQUFNLFdBQVc7SUFpQlo7SUFDQTtJQUNBO0lBQ0E7SUFDUztJQUNBO0lBckJuQixzQ0FBc0M7SUFDckIsK0JBQStCLEdBQUcsSUFBSSxDQUFDO0lBQ3ZDLGdDQUFnQyxHQUFHLElBQUksQ0FBQztJQUV6RDs7O09BR0c7SUFDSyxXQUFXO1FBQ2pCLHNFQUFzRTtRQUN0RSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMvRCxPQUFPLEdBQUcsU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQ3RDLENBQUM7SUFFRCxZQUNVLGNBQThCLEVBQzlCLG1CQUF3QyxFQUN4QyxVQUFzQixFQUN0QixhQUE0QixFQUNuQixNQUFpQixFQUNqQixpQkFBb0M7UUFMN0MsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUNuQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLHNCQUFpQixH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QUFlLEVBQUUsU0FBUyxFQUFFO1lBQzlDLHVCQUF1QixFQUFFLElBQUk7U0FDOUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUE7QUE5VFksa0NBQVc7c0JBQVgsV0FBVztJQUR2QixJQUFBLG1CQUFVLEdBQUU7eURBa0JlLGdDQUFjLG9CQUFkLGdDQUFjLG9EQUNULDJDQUFtQixvQkFBbkIsMkNBQW1CLG9EQUM1QixnQkFBVSxvQkFBVixnQkFBVSxvREFDUCxzQkFBYSxvQkFBYixzQkFBYSxvREFDWCwwQkFBUyxvQkFBVCwwQkFBUyxvREFDRSxzQ0FBaUIsb0JBQWpCLHNDQUFpQjtHQXRCNUMsV0FBVyxDQThUdkIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxhdXRoLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgVW5hdXRob3JpemVkRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IEp3dFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2p3dCc7XG5pbXBvcnQgeyBwbGFpblRvQ2xhc3MgfSBmcm9tICdjbGFzcy10cmFuc2Zvcm1lcic7XG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBSb2xlVHlwZSB9IGZyb20gJy4uLy4uL3NoYXJlZC9jb25zdGFudHMvcm9sZXMuY29uc3RhbnRzJztcblxuaW1wb3J0IHsgQXBwTG9nZ2VyIH0gZnJvbSAnLi4vLi4vc2hhcmVkL2xvZ2dlci9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBSZXF1ZXN0Q29udGV4dCB9IGZyb20gJy4uLy4uL3NoYXJlZC9yZXF1ZXN0LWNvbnRleHQvcmVxdWVzdC1jb250ZXh0LmR0byc7XG5pbXBvcnQgeyBVc3VhcmlvU2VydmljZSB9IGZyb20gJy4uLy4uL21vZHVsZXMvdXN1YXJpby9zZXJ2aWNlcy91c3VhcmlvLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVnaXN0ZXJJbnB1dCB9IGZyb20gJy4uL2R0b3MvYXV0aC1yZWdpc3Rlci1pbnB1dC5kdG8nO1xuaW1wb3J0IHsgUmVnaXN0ZXJPdXRwdXQgfSBmcm9tICcuLi9kdG9zL2F1dGgtcmVnaXN0ZXItb3V0cHV0LmR0byc7XG5pbXBvcnQge1xuICBBdXRoVG9rZW5PdXRwdXQsXG4gIFVzZXJBY2Nlc3NUb2tlbkNsYWltcyxcbn0gZnJvbSAnLi4vZHRvcy9hdXRoLXRva2VuLW91dHB1dC5kdG8nO1xuaW1wb3J0IHsgVXNlck91dHB1dCwgVXN1YXJpb0FkYXB0ZXIgfSBmcm9tICcuLi9hZGFwdGVycy91c3VhcmlvLWFkYXB0ZXInO1xuaW1wb3J0IHsgUmVmcmVzaFRva2VuU2VydmljZSB9IGZyb20gJy4vcmVmcmVzaC10b2tlbi5zZXJ2aWNlJztcbmltcG9ydCB7IFJlZnJlc2hUb2tlbklucHV0IH0gZnJvbSAnLi4vZHRvcy9hdXRoLXJlZnJlc2gtdG9rZW4taW5wdXQuZHRvJztcbmltcG9ydCB7IFVzdWFyaW8gfSBmcm9tICcuLi8uLi9lbnRpdGllcy91c3VhcmlvLmVudGl0eSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uU2VydmljZSB9IGZyb20gJy4vcGVybWlzc2lvbi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcbiAgLy8gVmFsb3JlcyBwYWRyw6NvIG5vIGZvcm1hdG8gc2Vtw6JudGljb1xuICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfQUNDRVNTX1RPS0VOX0VYUElSRVNfSU4gPSAnMWgnO1xuICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfUkVGUkVTSF9UT0tFTl9FWFBJUkVTX0lOID0gJzdkJztcbiAgXG4gIC8qKlxuICAgKiBHZXJhIHVtIEpUSSAoSldUIElEKSDDum5pY29cbiAgICogQHJldHVybnMgc3RyaW5nIC0gSlRJIMO6bmljb1xuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUp0aSgpOiBzdHJpbmcge1xuICAgIC8vIENvbWJpbmFyIHRpbWVzdGFtcCwgbsO6bWVybyBhbGVhdMOzcmlvIGUgaGFzaCBwYXJhIGdhcmFudGlyIHVuaWNpZGFkZVxuICAgIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCkudG9TdHJpbmcoMzYpO1xuICAgIGNvbnN0IHJhbmRvbVBhcnQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgMTUpO1xuICAgIHJldHVybiBgJHt0aW1lc3RhbXB9LSR7cmFuZG9tUGFydH1gO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB1c3VhcmlvU2VydmljZTogVXN1YXJpb1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWZyZXNoVG9rZW5TZXJ2aWNlOiBSZWZyZXNoVG9rZW5TZXJ2aWNlLFxuICAgIHByaXZhdGUgand0U2VydmljZTogSnd0U2VydmljZSxcbiAgICBwcml2YXRlIGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IEFwcExvZ2dlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25TZXJ2aWNlOiBQZXJtaXNzaW9uU2VydmljZSxcbiAgKSB7XG4gICAgdGhpcy5sb2dnZXIuc2V0Q29udGV4dChBdXRoU2VydmljZS5uYW1lKTtcblxuICAgIC8vIExvZyBkYXMgY29uZmlndXJhw6fDtWVzIGRlIHRva2VuXG4gICAgY29uc3QgYWNjZXNzVG9rZW5FeHBpcmVzSW4gPSB0aGlzLmdldEFjY2Vzc1Rva2VuRXhwaXJlc0luKCk7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuRXhwaXJlc0luID0gdGhpcy5nZXRSZWZyZXNoVG9rZW5FeHBpcmVzSW4oKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIHt9IGFzIFJlcXVlc3RDb250ZXh0LFxuICAgICAgYENvbmZpZ3VyYcOnw6NvIGRlIHRva2VucyAtIEFjY2VzcyBUb2tlbjogJHthY2Nlc3NUb2tlbkV4cGlyZXNJbn0sIGAgK1xuICAgICAgICBgUmVmcmVzaCBUb2tlbjogJHtyZWZyZXNoVG9rZW5FeHBpcmVzSW59IGAgK1xuICAgICAgICBgKGVtIHNlZ3VuZG9zOiAke3RoaXMudGltZVRvU2Vjb25kcyhyZWZyZXNoVG9rZW5FeHBpcmVzSW4pfSlgLFxuICAgICk7XG5cbiAgICAvLyBEZWJ1ZyBkYXMgdmFyacOhdmVpcyBkZSBhbWJpZW50ZVxuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJ0pXVF9SRUZSRVNIX1RPS0VOX0VYUElSRVNfSU46JyxcbiAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXQoJ0pXVF9SRUZSRVNIX1RPS0VOX0VYUElSRVNfSU4nLCAnbsOjbyBkZWZpbmlkbycpLFxuICAgICk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICAnSldUX0FDQ0VTU19UT0tFTl9FWFBJUkVTX0lOOicsXG4gICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0KCdKV1RfQUNDRVNTX1RPS0VOX0VYUElSRVNfSU4nLCAnbsOjbyBkZWZpbmlkbycpLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogT2J0w6ltIG8gdGVtcG8gZGUgZXhwaXJhw6fDo28gZG8gYWNjZXNzIHRva2VuIG5vIGZvcm1hdG8gc2Vtw6JudGljbyAoMWgsIDdkLCBldGMpXG4gICAqL1xuICBwcml2YXRlIGdldEFjY2Vzc1Rva2VuRXhwaXJlc0luKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPihcbiAgICAgICdKV1RfQUNDRVNTX1RPS0VOX0VYUElSRVNfSU4nLFxuICAgICAgdGhpcy5ERUZBVUxUX0FDQ0VTU19UT0tFTl9FWFBJUkVTX0lOLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogT2J0w6ltIG8gdGVtcG8gZGUgZXhwaXJhw6fDo28gZG8gcmVmcmVzaCB0b2tlbiBubyBmb3JtYXRvIHNlbcOibnRpY28gKDFoLCA3ZCwgZXRjKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRSZWZyZXNoVG9rZW5FeHBpcmVzSW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KFxuICAgICAgJ0pXVF9SRUZSRVNIX1RPS0VOX0VYUElSRVNfSU4nLFxuICAgICAgdGhpcy5ERUZBVUxUX1JFRlJFU0hfVE9LRU5fRVhQSVJFU19JTixcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRlIHVtYSBzdHJpbmcgZGUgdGVtcG8gbm8gZm9ybWF0byBzZW3Dom50aWNvICgxaCwgN2QsIGV0YykgcGFyYSBzZWd1bmRvc1xuICAgKi9cbiAgcHJpdmF0ZSB0aW1lVG9TZWNvbmRzKHRpbWVTdHJpbmc6IHN0cmluZyk6IG51bWJlciB7XG4gICAgLy8gU2UgZm9yIGFwZW5hcyB1bSBuw7ptZXJvLCBjb25zaWRlcmEgY29tbyBzZWd1bmRvc1xuICAgIGlmICgvXlxcZCskLy50ZXN0KHRpbWVTdHJpbmcpKSB7XG4gICAgICByZXR1cm4gcGFyc2VJbnQodGltZVN0cmluZywgMTApO1xuICAgIH1cblxuICAgIC8vIFNlIGZvciBubyBmb3JtYXRvIG7Dum1lcm8rdW5pZGFkZSAoZXg6IDdkLCAyNGgsIGV0YylcbiAgICBjb25zdCBtYXRjaCA9IHRpbWVTdHJpbmcubWF0Y2goL14oXFxkKykoW3NtaGR3XSkkLyk7XG4gICAgaWYgKG1hdGNoKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHBhcnNlSW50KG1hdGNoWzFdLCAxMCk7XG4gICAgICBjb25zdCB1bml0ID0gbWF0Y2hbMl07XG5cbiAgICAgIHN3aXRjaCAodW5pdCkge1xuICAgICAgICBjYXNlICdzJzpcbiAgICAgICAgICByZXR1cm4gdmFsdWU7IC8vIHNlZ3VuZG9zXG4gICAgICAgIGNhc2UgJ20nOlxuICAgICAgICAgIHJldHVybiB2YWx1ZSAqIDYwOyAvLyBtaW51dG9zXG4gICAgICAgIGNhc2UgJ2gnOlxuICAgICAgICAgIHJldHVybiB2YWx1ZSAqIDYwICogNjA7IC8vIGhvcmFzXG4gICAgICAgIGNhc2UgJ2QnOlxuICAgICAgICAgIHJldHVybiB2YWx1ZSAqIDI0ICogNjAgKiA2MDsgLy8gZGlhc1xuICAgICAgICBjYXNlICd3JzpcbiAgICAgICAgICByZXR1cm4gdmFsdWUgKiA3ICogMjQgKiA2MCAqIDYwOyAvLyBzZW1hbmFzXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIDg2NDAwOyAvLyBwYWRyw6NvOiAxIGRpYVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEZhbGxiYWNrIHBhcmEgdmFsb3JlcyBxdWUgbsOjbyBjb25zZWd1aW1vcyBpbnRlcnByZXRhclxuICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICB7fSBhcyBSZXF1ZXN0Q29udGV4dCxcbiAgICAgIGBOw6NvIGZvaSBwb3Nzw612ZWwgaW50ZXJwcmV0YXIgbyBmb3JtYXRvIGRlIHRlbXBvOiAke3RpbWVTdHJpbmd9LCB1c2FuZG8gMSBkaWEgY29tbyBwYWRyw6NvYCxcbiAgICApO1xuICAgIHJldHVybiA4NjQwMDsgLy8gMSBkaWEgZW0gc2VndW5kb3NcbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlVXNlcihcbiAgICBjdHg6IFJlcXVlc3RDb250ZXh0LFxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXG4gICAgcGFzczogc3RyaW5nLFxuICApOiBQcm9taXNlPFVzZXJBY2Nlc3NUb2tlbkNsYWltcz4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhjdHgsIGAke3RoaXMudmFsaWRhdGVVc2VyLm5hbWV9IGZvaSBjaGFtYWRvYCk7XG5cbiAgICAvLyBCdXNjYXIgdXN1w6FyaW8gcGVsbyBlbWFpbCAodXNlcm5hbWUpXG4gICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHRoaXMudXN1YXJpb1NlcnZpY2UuZmluZEJ5RW1haWwodXNlcm5hbWUpO1xuICAgIGlmICghdXN1YXJpbykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignTm9tZSBkZSB1c3XDoXJpbyBvdSBzZW5oYSBpbnbDoWxpZG9zJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIGEgc2VuaGEgZXN0w6EgY29ycmV0YVxuICAgIGNvbnN0IHNlbmhhQ29ycmV0YSA9IGF3YWl0IHJlcXVpcmUoJ2JjcnlwdCcpLmNvbXBhcmUoXG4gICAgICBwYXNzLFxuICAgICAgdXN1YXJpby5zZW5oYUhhc2gsXG4gICAgKTtcbiAgICBpZiAoIXNlbmhhQ29ycmV0YSkge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignTm9tZSBkZSB1c3XDoXJpbyBvdSBzZW5oYSBpbnbDoWxpZG9zJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gdXN1w6FyaW8gZXN0w6EgYXRpdm9cbiAgICBpZiAodXN1YXJpby5zdGF0dXMgPT09ICdpbmF0aXZvJykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignRXN0YSBjb250YSBkZSB1c3XDoXJpbyBmb2kgZGVzYXRpdmFkYScpO1xuICAgIH1cblxuICAgIC8vIE9idGVyIGFzIHBlcm1pc3PDtWVzIGRvIHVzdcOhcmlvXG4gICAgY29uc3QgcGVybWlzc2lvbnMgPSBhd2FpdCB0aGlzLnBlcm1pc3Npb25TZXJ2aWNlLmdldFVzZXJQZXJtaXNzaW9ucyh1c3VhcmlvLmlkKTtcbiAgICBcbiAgICAvLyBPYnRlciBvcyBlc2NvcG9zIGRhcyBwZXJtaXNzw7Vlc1xuICAgIGNvbnN0IHBlcm1pc3Npb25TY29wZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBcbiAgICAvLyBDb252ZXJ0ZXIgcGFyYSBvIGZvcm1hdG8gZXNwZXJhZG8gaW5jbHVpbmRvIHBlcm1pc3PDtWVzXG4gICAgcmV0dXJuIFVzdWFyaW9BZGFwdGVyLnRvVXNlckFjY2Vzc1Rva2VuQ2xhaW1zKHVzdWFyaW8sIHBlcm1pc3Npb25zLCBwZXJtaXNzaW9uU2NvcGVzKTtcbiAgfVxuXG4gIGFzeW5jIGxvZ2luKGN0eDogUmVxdWVzdENvbnRleHQpOiBQcm9taXNlPEF1dGhUb2tlbk91dHB1dD4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhjdHgsIGAke3RoaXMubG9naW4ubmFtZX0gZm9pIGNoYW1hZG9gKTtcblxuICAgIC8vIE9idGVyIG8gdG9rZW4gZGUgYXV0ZW50aWNhw6fDo29cbiAgICBjb25zdCB0b2tlbnMgPSB0aGlzLmdldEF1dGhUb2tlbihjdHgsIGN0eC51c2VyISk7XG5cbiAgICAvLyBDcmlhciBlIHNhbHZhciBvIHJlZnJlc2ggdG9rZW5cbiAgICBjb25zdCB1c3VhcmlvID0gYXdhaXQgdGhpcy51c3VhcmlvU2VydmljZS5maW5kQnlJZChjdHgudXNlciEuaWQgYXMgc3RyaW5nKTtcbiAgICBpZiAoIXVzdWFyaW8pIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1VzdcOhcmlvIG7Do28gZW5jb250cmFkbycpO1xuICAgIH1cblxuICAgIC8vIE9idGVyIG8gdGVtcG8gZGUgZXhwaXJhw6fDo29cbiAgICBjb25zdCByZWZyZXNoVG9rZW5FeHBpcmVzSW4gPSB0aGlzLmdldFJlZnJlc2hUb2tlbkV4cGlyZXNJbigpO1xuICAgIGNvbnN0IHJlZnJlc2hUb2tlblNlY29uZHMgPSB0aGlzLnRpbWVUb1NlY29uZHMocmVmcmVzaFRva2VuRXhwaXJlc0luKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGN0eCxcbiAgICAgIGBDcmlhbmRvIHJlZnJlc2ggdG9rZW4gY29tIGR1cmHDp8OjbyBkZSAke3JlZnJlc2hUb2tlbkV4cGlyZXNJbn0gKCR7cmVmcmVzaFRva2VuU2Vjb25kc30gc2VndW5kb3MpYCxcbiAgICApO1xuXG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gYXdhaXQgdGhpcy5yZWZyZXNoVG9rZW5TZXJ2aWNlLmNyZWF0ZVRva2VuKFxuICAgICAgdXN1YXJpbyBhcyBVc3VhcmlvLFxuICAgICAgcmVmcmVzaFRva2VuU2Vjb25kcywgLy8gQ29udmVydGUgcGFyYSBzZWd1bmRvcyBwYXJhIG8gUmVmcmVzaFRva2VuU2VydmljZVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4udG9rZW5zLFxuICAgICAgcmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4udG9rZW4sXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHJlZnJlc2hUb2tlbihcbiAgICBjdHg6IFJlcXVlc3RDb250ZXh0LFxuICAgIHJlZnJlc2hUb2tlbklucHV0OiBSZWZyZXNoVG9rZW5JbnB1dCxcbiAgKTogUHJvbWlzZTxBdXRoVG9rZW5PdXRwdXQ+IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coY3R4LCBgJHt0aGlzLnJlZnJlc2hUb2tlbi5uYW1lfSBmb2kgY2hhbWFkb2ApO1xuXG4gICAgLy8gRW5jb250cmFyIG8gdG9rZW4gZGUgcmVmcmVzaFxuICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IGF3YWl0IHRoaXMucmVmcmVzaFRva2VuU2VydmljZS5maW5kVG9rZW4oXG4gICAgICByZWZyZXNoVG9rZW5JbnB1dC5yZWZyZXNoVG9rZW4sXG4gICAgKTtcblxuICAgIC8vIFZlcmlmaWNhciBzZSBvIHRva2VuIGV4aXN0ZSBlIG7Do28gZm9pIHJldm9nYWRvXG4gICAgaWYgKCFyZWZyZXNoVG9rZW4gfHwgcmVmcmVzaFRva2VuLnJldm9rZWQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1Rva2VuIGRlIHJlZnJlc2ggaW52w6FsaWRvJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gdG9rZW4gZXhwaXJvdVxuICAgIGlmIChuZXcgRGF0ZSgpID4gcmVmcmVzaFRva2VuLmV4cGlyZXNfYXQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1Rva2VuIGRlIHJlZnJlc2ggZXhwaXJhZG8nKTtcbiAgICB9XG5cbiAgICAvLyBSZXZvZ2FyIGFwZW5hcyBvIHRva2VuIGRlIHJlZnJlc2ggYXR1YWxcbiAgICAvLyBOw6NvIGFkaWNpb25hbW9zIG8gYWNjZXNzIHRva2VuIMOgIGJsYWNrbGlzdCwgcG9pcyBpc3NvIGNhdXNhcmlhIHByb2JsZW1hc1xuICAgIC8vIGNvbSByZXF1aXNpw6fDtWVzIHN1YnNlcXVlbnRlc1xuICAgIGNvbnN0IGlwQWRkcmVzcyA9IChjdHggYXMgYW55KS5yZXE/LmlwIHx8ICcwLjAuMC4wJztcbiAgICBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlblNlcnZpY2UucmV2b2tlVG9rZW4ocmVmcmVzaFRva2VuLnRva2VuLCBpcEFkZHJlc3MpO1xuXG4gICAgLy8gTsOjbyByZXZvZ2FyIHRva2VucyBkZXNjZW5kZW50ZXMgcGFyYSBldml0YXIgcHJvYmxlbWFzIGNvbSBhIGJsYWNrbGlzdFxuICAgIC8vIGF3YWl0IHRoaXMucmVmcmVzaFRva2VuU2VydmljZS5yZXZva2VEZXNjZW5kYW50VG9rZW5zKFxuICAgIC8vICAgcmVmcmVzaFRva2VuLFxuICAgIC8vICAgaXBBZGRyZXNzLFxuICAgIC8vICk7XG5cbiAgICAvLyBPYnRlciBvIHVzdcOhcmlvXG4gICAgY29uc3QgdXN1YXJpbyA9IGF3YWl0IHRoaXMudXN1YXJpb1NlcnZpY2UuZmluZEJ5SWQocmVmcmVzaFRva2VuLnVzdWFyaW8uaWQpO1xuICAgIGlmICghdXN1YXJpbykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignVXN1w6FyaW8gbsOjbyBlbmNvbnRyYWRvJyk7XG4gICAgfVxuXG4gICAgLy8gR2VyYXIgbm92b3MgdG9rZW5zXG4gICAgY29uc3QgdXNlck91dHB1dCA9IFVzdWFyaW9BZGFwdGVyLnRvVXNlck91dHB1dCh1c3VhcmlvIGFzIGFueSk7XG4gICAgY29uc3QgdG9rZW5zID0gdGhpcy5nZXRBdXRoVG9rZW4oY3R4LCB1c2VyT3V0cHV0KTtcblxuICAgIC8vIE9idGVyIG8gdGVtcG8gZGUgZXhwaXJhw6fDo29cbiAgICBjb25zdCByZWZyZXNoVG9rZW5FeHBpcmVzSW4gPSB0aGlzLmdldFJlZnJlc2hUb2tlbkV4cGlyZXNJbigpO1xuICAgIGNvbnN0IHJlZnJlc2hUb2tlblNlY29uZHMgPSB0aGlzLnRpbWVUb1NlY29uZHMocmVmcmVzaFRva2VuRXhwaXJlc0luKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGN0eCxcbiAgICAgIGBDcmlhbmRvIG5vdm8gcmVmcmVzaCB0b2tlbiBjb20gZHVyYcOnw6NvIGRlICR7cmVmcmVzaFRva2VuRXhwaXJlc0lufSAoJHtyZWZyZXNoVG9rZW5TZWNvbmRzfSBzZWd1bmRvcylgLFxuICAgICk7XG5cbiAgICBjb25zdCBuZXdSZWZyZXNoVG9rZW4gPSBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlblNlcnZpY2UuY3JlYXRlVG9rZW4oXG4gICAgICB1c3VhcmlvIGFzIFVzdWFyaW8sXG4gICAgICByZWZyZXNoVG9rZW5TZWNvbmRzLCAvLyBDb252ZXJ0ZSBwYXJhIHNlZ3VuZG9zIHBhcmEgbyBSZWZyZXNoVG9rZW5TZXJ2aWNlXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi50b2tlbnMsXG4gICAgICByZWZyZXNoVG9rZW46IG5ld1JlZnJlc2hUb2tlbi50b2tlbixcbiAgICB9O1xuICB9XG5cbiAgZ2V0QXV0aFRva2VuKFxuICAgIGN0eDogUmVxdWVzdENvbnRleHQsXG4gICAgdXNlcjogVXNlckFjY2Vzc1Rva2VuQ2xhaW1zIHwgVXNlck91dHB1dCxcbiAgKTogQXV0aFRva2VuT3V0cHV0IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coY3R4LCBgJHt0aGlzLmdldEF1dGhUb2tlbi5uYW1lfSB3YXMgY2FsbGVkYCk7XG5cbiAgICAvLyBHZXJhciB1bSBKVEkgKEpXVCBJRCkgw7puaWNvIHBhcmEgY2FkYSB0b2tlblxuICAgIGNvbnN0IGp0aSA9IHRoaXMuZ2VuZXJhdGVKdGkoKTtcbiAgICBcbiAgICBjb25zdCBzdWJqZWN0ID0geyBzdWI6IHVzZXIuaWQgfTtcbiAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUsXG4gICAgICBzdWI6IHVzZXIuaWQsXG4gICAgICByb2xlczogdXNlci5yb2xlcyxcbiAgICB9O1xuICAgIFxuICAgIC8vIEFkaWNpb25hciBwZXJtaXNzw7VlcyBhbyBwYXlsb2FkIHNlIGRpc3BvbsOtdmVpc1xuICAgIGlmICgncGVybWlzc2lvbnMnIGluIHVzZXIgJiYgdXNlci5wZXJtaXNzaW9ucykge1xuICAgICAgcGF5bG9hZFsncGVybWlzc2lvbnMnXSA9IHVzZXIucGVybWlzc2lvbnM7XG4gICAgfVxuICAgIFxuICAgIC8vIEFkaWNpb25hciBlc2NvcG9zIGRlIHBlcm1pc3PDtWVzIGFvIHBheWxvYWQgc2UgZGlzcG9uw612ZWlzXG4gICAgaWYgKCdwZXJtaXNzaW9uU2NvcGVzJyBpbiB1c2VyICYmIHVzZXIucGVybWlzc2lvblNjb3Blcykge1xuICAgICAgcGF5bG9hZFsncGVybWlzc2lvblNjb3BlcyddID0gdXNlci5wZXJtaXNzaW9uU2NvcGVzO1xuICAgIH1cblxuICAgIC8vIEdhcmFudGlyIHF1ZSBlc3RhbW9zIHVzYW5kbyBvIGFsZ29yaXRtbyBSUzI1NiBlIGEgY2hhdmUgcHJpdmFkYSBwYXJhIGFzc2luYXIgbyB0b2tlblxuICAgIGNvbnN0IHByaXZhdGVLZXkgPSBCdWZmZXIuZnJvbShcbiAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignSldUX1BSSVZBVEVfS0VZX0JBU0U2NCcsICcnKSxcbiAgICAgICdiYXNlNjQnLFxuICAgICkudG9TdHJpbmcoJ3V0ZjgnKTtcblxuICAgIC8vIE9idGVyIHZhbG9yZXMgZGUgZXhwaXJhw6fDo28gbm8gZm9ybWF0byBzZW3Dom50aWNvXG4gICAgY29uc3QgYWNjZXNzVG9rZW5FeHBpcmVzSW4gPSB0aGlzLmdldEFjY2Vzc1Rva2VuRXhwaXJlc0luKCk7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuRXhwaXJlc0luID0gdGhpcy5nZXRSZWZyZXNoVG9rZW5FeHBpcmVzSW4oKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGN0eCxcbiAgICAgIGBHZXJhbmRvIHRva2VucyAtIEFjY2VzcyB0b2tlbiBleHBpcmEgZW06ICR7YWNjZXNzVG9rZW5FeHBpcmVzSW59LCBSZWZyZXNoIHRva2VuIGV4cGlyYSBlbTogJHtyZWZyZXNoVG9rZW5FeHBpcmVzSW59YCxcbiAgICApO1xuXG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLmp3dFNlcnZpY2Uuc2lnbihcbiAgICAgIHtcbiAgICAgICAgLi4ucGF5bG9hZCxcbiAgICAgICAgLi4uc3ViamVjdCxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHNlY3JldDogcHJpdmF0ZUtleSxcbiAgICAgICAgYWxnb3JpdGhtOiAnUlMyNTYnLFxuICAgICAgICBleHBpcmVzSW46IGFjY2Vzc1Rva2VuRXhwaXJlc0luLFxuICAgICAgICBqd3RpZDoganRpLCBcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIFBhcmEgbyByZWZyZXNoVG9rZW4sIHVzYW1vcyBvIG1lc21vIEp3dFNlcnZpY2UsIG1hcyBjb20gb3DDp8O1ZXMgZGlmZXJlbnRlcyBkZSBleHBpcmHDp8Ojb1xuICAgIC8vIEdlcmFyIHVtIEpUSSBkaWZlcmVudGUgcGFyYSBvIHJlZnJlc2ggdG9rZW5cbiAgICBjb25zdCByZWZyZXNoSnRpID0gdGhpcy5nZW5lcmF0ZUp0aSgpO1xuICAgIFxuICAgIGNvbnN0IHJlZnJlc2hUb2tlbkp3dCA9IHRoaXMuand0U2VydmljZS5zaWduKFxuICAgICAge1xuICAgICAgICAuLi5zdWJqZWN0LFxuICAgICAgfSwgXG4gICAgICB7XG4gICAgICAgIHNlY3JldDogcHJpdmF0ZUtleSxcbiAgICAgICAgYWxnb3JpdGhtOiAnUlMyNTYnLFxuICAgICAgICBleHBpcmVzSW46IHJlZnJlc2hUb2tlbkV4cGlyZXNJbixcbiAgICAgICAgand0aWQ6IHJlZnJlc2hKdGksIFxuICAgICAgfSxcbiAgICApO1xuICAgIFxuICAgIGNvbnN0IGF1dGhUb2tlbiA9IHtcbiAgICAgIGFjY2Vzc1Rva2VuLFxuICAgICAgcmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW5Kd3QsXG4gICAgfTtcblxuICAgIHJldHVybiBwbGFpblRvQ2xhc3MoQXV0aFRva2VuT3V0cHV0LCBhdXRoVG9rZW4sIHtcbiAgICAgIGV4Y2x1ZGVFeHRyYW5lb3VzVmFsdWVzOiB0cnVlLFxuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=