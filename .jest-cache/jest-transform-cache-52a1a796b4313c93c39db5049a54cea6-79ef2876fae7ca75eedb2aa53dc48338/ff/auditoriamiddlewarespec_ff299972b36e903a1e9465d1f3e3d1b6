c8877ea8c0638156b3ba7f65f5ef5b22
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const auditoria_middleware_1 = require("../../../../src/modules/auditoria/middlewares/auditoria.middleware");
const auditoria_service_1 = require("../../../../src/modules/auditoria/services/auditoria.service");
const auditoria_queue_service_1 = require("../../../../src/modules/auditoria/services/auditoria-queue.service");
const tipo_operacao_enum_1 = require("../../../../src/modules/auditoria/enums/tipo-operacao.enum");
describe('AuditoriaMiddleware', () => {
    let middleware;
    let auditoriaService;
    let auditoriaQueueService;
    const mockRequest = () => {
        const req = {
            method: 'GET',
            originalUrl: '/api/v1/usuarios',
            body: {},
            user: { id: 'mock-user-id', nome: 'Usuário Teste' },
            ip: '192.168.1.1',
            headers: {
                'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            },
        };
        return req;
    };
    const mockResponse = () => {
        const res = {
            statusCode: 200,
            locals: {},
            on: jest.fn().mockImplementation((event, callback) => {
                if (event === 'finish') {
                    callback();
                }
                return res;
            }),
            send: jest.fn().mockImplementation(function (body) {
                this.locals.responseBody = body;
                return this;
            }),
        };
        return res;
    };
    const mockNext = jest.fn();
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                auditoria_middleware_1.AuditoriaMiddleware,
                {
                    provide: auditoria_service_1.AuditoriaService,
                    useValue: {
                        create: jest.fn().mockResolvedValue({ id: 'mock-log-id' }),
                        findAll: jest.fn().mockResolvedValue([]),
                        findOne: jest.fn().mockResolvedValue({}),
                        update: jest.fn().mockResolvedValue({}),
                        remove: jest.fn().mockResolvedValue({}),
                    },
                },
                {
                    provide: auditoria_queue_service_1.AuditoriaQueueService,
                    useValue: {
                        enfileirarLogAuditoria: jest
                            .fn()
                            .mockResolvedValue({ id: 'mock-job-id' }),
                        enfileirarAcessoDadosSensiveis: jest
                            .fn()
                            .mockResolvedValue({ id: 'mock-sensitive-job-id' }),
                    },
                },
            ],
        }).compile();
        middleware = module.get(auditoria_middleware_1.AuditoriaMiddleware);
        auditoriaService = module.get(auditoria_service_1.AuditoriaService);
        auditoriaQueueService = module.get(auditoria_queue_service_1.AuditoriaQueueService);
    });
    it('deve ser definido', () => {
        expect(middleware).toBeDefined();
    });
    it('deve chamar next() quando executado', async () => {
        await middleware.use(mockRequest(), mockResponse(), mockNext);
        expect(mockNext).toHaveBeenCalled();
    });
    it('deve enfileirar log de auditoria quando a requisição é bem-sucedida', async () => {
        const req = mockRequest();
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        expect(auditoriaQueueService.enfileirarLogAuditoria).toHaveBeenCalled();
        // Verifica se o tipo de operação foi mapeado corretamente
        const callArgs = auditoriaQueueService.enfileirarLogAuditoria
            .mock.calls[0][0];
        expect(callArgs.tipo_operacao).toBe(tipo_operacao_enum_1.TipoOperacao.READ);
        expect(callArgs.entidade_afetada).toBe('Usuario');
    });
    it('deve detectar dados sensíveis no corpo da requisição', async () => {
        const req = mockRequest();
        req.body = {
            nome: 'João Silva',
            cpf: '123.456.789-00',
            email: 'joao@exemplo.com',
            endereco: {
                rua: 'Rua das Flores',
                numero: 123,
            },
        };
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        const callArgs = auditoriaQueueService.enfileirarLogAuditoria
            .mock.calls[0][0];
        expect(callArgs.dados_sensiveis_acessados).toContain('cpf');
        expect(callArgs.dados_sensiveis_acessados).toContain('endereco');
        expect(auditoriaQueueService.enfileirarAcessoDadosSensiveis).toHaveBeenCalled();
    });
    it('não deve auditar endpoints excluídos', async () => {
        const req = mockRequest();
        req.originalUrl = '/api/v1/health';
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        expect(auditoriaQueueService.enfileirarLogAuditoria).not.toHaveBeenCalled();
    });
    it('deve mapear corretamente o método HTTP para o tipo de operação', async () => {
        const httpMethods = [
            { method: 'GET', expectedType: tipo_operacao_enum_1.TipoOperacao.READ },
            { method: 'POST', expectedType: tipo_operacao_enum_1.TipoOperacao.CREATE },
            { method: 'PUT', expectedType: tipo_operacao_enum_1.TipoOperacao.UPDATE },
            { method: 'PATCH', expectedType: tipo_operacao_enum_1.TipoOperacao.UPDATE },
            { method: 'DELETE', expectedType: tipo_operacao_enum_1.TipoOperacao.DELETE },
        ];
        for (const { method, expectedType } of httpMethods) {
            const req = mockRequest();
            req.method = method;
            const res = mockResponse();
            await middleware.use(req, res, mockNext);
            // Simula a resposta sendo finalizada
            res.on('finish', () => { });
            if (method !== 'OPTIONS') {
                const callArgs = auditoriaQueueService.enfileirarLogAuditoria.mock.calls.pop()[0];
                expect(callArgs.tipo_operacao).toBe(expectedType);
            }
        }
    });
    it('deve extrair corretamente o ID da entidade da URL', async () => {
        const req = mockRequest();
        req.originalUrl = '/api/v1/usuarios/123e4567-e89b-12d3-a456-426614174000';
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        const callArgs = auditoriaQueueService.enfileirarLogAuditoria
            .mock.calls[0][0];
        expect(callArgs.entidade_afetada).toBe('Usuario');
        expect(callArgs.entidade_id).toBe('123e4567-e89b-12d3-a456-426614174000');
    });
    it('deve capturar dados da resposta para operações de criação e atualização', async () => {
        const responseBody = { id: 'new-user-id', nome: 'Novo Usuário' };
        const req = mockRequest();
        req.method = 'POST';
        req.body = { nome: 'Novo Usuário', email: 'novo@exemplo.com' };
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula o envio da resposta
        res.send(JSON.stringify(responseBody));
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        const callArgs = auditoriaQueueService.enfileirarLogAuditoria
            .mock.calls[0][0];
        expect(callArgs.dados_novos).toEqual(responseBody);
        expect(callArgs.dados_anteriores).toBeUndefined();
    });
    it('deve capturar dados anteriores para operações de atualização', async () => {
        const responseBody = { id: 'user-id', nome: 'Usuário Atualizado' };
        const req = mockRequest();
        req.method = 'PUT';
        req.originalUrl = '/api/v1/usuarios/user-id';
        req.body = { nome: 'Usuário Atualizado' };
        const res = mockResponse();
        await middleware.use(req, res, mockNext);
        // Simula o envio da resposta
        res.send(JSON.stringify(responseBody));
        // Simula a resposta sendo finalizada
        res.on('finish', () => { });
        const callArgs = auditoriaQueueService.enfileirarLogAuditoria
            .mock.calls[0][0];
        expect(callArgs.dados_novos).toEqual(responseBody);
        expect(callArgs.dados_anteriores).toEqual(req.body);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxtb2R1bGVzXFxhdWRpdG9yaWFcXG1pZGRsZXdhcmVzXFxhdWRpdG9yaWEubWlkZGxld2FyZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELDZHQUF5RztBQUN6RyxvR0FBZ0c7QUFDaEcsZ0hBQTJHO0FBQzNHLG1HQUEwRjtBQUkxRixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lBQ25DLElBQUksVUFBK0IsQ0FBQztJQUNwQyxJQUFJLGdCQUFrQyxDQUFDO0lBQ3ZDLElBQUkscUJBQTRDLENBQUM7SUFFakQsTUFBTSxXQUFXLEdBQUcsR0FBRyxFQUFFO1FBQ3ZCLE1BQU0sR0FBRyxHQUFxQjtZQUM1QixNQUFNLEVBQUUsS0FBSztZQUNiLFdBQVcsRUFBRSxrQkFBa0I7WUFDL0IsSUFBSSxFQUFFLEVBQUU7WUFDUixJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUU7WUFDbkQsRUFBRSxFQUFFLGFBQWE7WUFDakIsT0FBTyxFQUFFO2dCQUNQLFlBQVksRUFDViw4REFBOEQ7YUFDakU7U0FDRixDQUFDO1FBQ0YsT0FBTyxHQUFjLENBQUM7SUFDeEIsQ0FBQyxDQUFDO0lBRUYsTUFBTSxZQUFZLEdBQUcsR0FBRyxFQUFFO1FBQ3hCLE1BQU0sR0FBRyxHQUFzQjtZQUM3QixVQUFVLEVBQUUsR0FBRztZQUNmLE1BQU0sRUFBRSxFQUFFO1lBQ1YsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRTtnQkFDbkQsSUFBSSxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7b0JBQ3ZCLFFBQVEsRUFBRSxDQUFDO2dCQUNiLENBQUM7Z0JBQ0QsT0FBTyxHQUFHLENBQUM7WUFDYixDQUFDLENBQUM7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Im5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHRlc3RcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcbWlkZGxld2FyZXNcXGF1ZGl0b3JpYS5taWRkbGV3YXJlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBBdWRpdG9yaWFNaWRkbGV3YXJlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL21pZGRsZXdhcmVzL2F1ZGl0b3JpYS5taWRkbGV3YXJlJztcbmltcG9ydCB7IEF1ZGl0b3JpYVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zcmMvbW9kdWxlcy9hdWRpdG9yaWEvc2VydmljZXMvYXVkaXRvcmlhLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXVkaXRvcmlhUXVldWVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL3NlcnZpY2VzL2F1ZGl0b3JpYS1xdWV1ZS5zZXJ2aWNlJztcbmltcG9ydCB7IFRpcG9PcGVyYWNhbyB9IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2F1ZGl0b3JpYS9lbnVtcy90aXBvLW9wZXJhY2FvLmVudW0nO1xuaW1wb3J0IHsgQ3JlYXRlTG9nQXVkaXRvcmlhRHRvIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvYXVkaXRvcmlhL2R0by9jcmVhdGUtbG9nLWF1ZGl0b3JpYS5kdG8nO1xuaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG5kZXNjcmliZSgnQXVkaXRvcmlhTWlkZGxld2FyZScsICgpID0+IHtcbiAgbGV0IG1pZGRsZXdhcmU6IEF1ZGl0b3JpYU1pZGRsZXdhcmU7XG4gIGxldCBhdWRpdG9yaWFTZXJ2aWNlOiBBdWRpdG9yaWFTZXJ2aWNlO1xuICBsZXQgYXVkaXRvcmlhUXVldWVTZXJ2aWNlOiBBdWRpdG9yaWFRdWV1ZVNlcnZpY2U7XG5cbiAgY29uc3QgbW9ja1JlcXVlc3QgPSAoKSA9PiB7XG4gICAgY29uc3QgcmVxOiBQYXJ0aWFsPFJlcXVlc3Q+ID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIG9yaWdpbmFsVXJsOiAnL2FwaS92MS91c3VhcmlvcycsXG4gICAgICBib2R5OiB7fSxcbiAgICAgIHVzZXI6IHsgaWQ6ICdtb2NrLXVzZXItaWQnLCBub21lOiAnVXN1w6FyaW8gVGVzdGUnIH0sXG4gICAgICBpcDogJzE5Mi4xNjguMS4xJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ3VzZXItYWdlbnQnOlxuICAgICAgICAgICdNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYnLFxuICAgICAgfSxcbiAgICB9O1xuICAgIHJldHVybiByZXEgYXMgUmVxdWVzdDtcbiAgfTtcblxuICBjb25zdCBtb2NrUmVzcG9uc2UgPSAoKSA9PiB7XG4gICAgY29uc3QgcmVzOiBQYXJ0aWFsPFJlc3BvbnNlPiA9IHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGxvY2Fsczoge30sXG4gICAgICBvbjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoZXZlbnQsIGNhbGxiYWNrKSA9PiB7XG4gICAgICAgIGlmIChldmVudCA9PT0gJ2ZpbmlzaCcpIHtcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9KSxcbiAgICAgIHNlbmQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oZnVuY3Rpb24gKGJvZHkpIHtcbiAgICAgICAgdGhpcy5sb2NhbHMucmVzcG9uc2VCb2R5ID0gYm9keTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXMgYXMgUmVzcG9uc2U7XG4gIH07XG5cbiAgY29uc3QgbW9ja05leHQ6IE5leHRGdW5jdGlvbiA9IGplc3QuZm4oKTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIEF1ZGl0b3JpYU1pZGRsZXdhcmUsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBBdWRpdG9yaWFTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAnbW9jay1sb2ctaWQnIH0pLFxuICAgICAgICAgICAgZmluZEFsbDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICAgICAgICB1cGRhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICAgICAgICByZW1vdmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEF1ZGl0b3JpYVF1ZXVlU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZW5maWxlaXJhckxvZ0F1ZGl0b3JpYTogamVzdFxuICAgICAgICAgICAgICAuZm4oKVxuICAgICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ21vY2stam9iLWlkJyB9KSxcbiAgICAgICAgICAgIGVuZmlsZWlyYXJBY2Vzc29EYWRvc1NlbnNpdmVpczogamVzdFxuICAgICAgICAgICAgICAuZm4oKVxuICAgICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ21vY2stc2Vuc2l0aXZlLWpvYi1pZCcgfSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgbWlkZGxld2FyZSA9IG1vZHVsZS5nZXQ8QXVkaXRvcmlhTWlkZGxld2FyZT4oQXVkaXRvcmlhTWlkZGxld2FyZSk7XG4gICAgYXVkaXRvcmlhU2VydmljZSA9IG1vZHVsZS5nZXQ8QXVkaXRvcmlhU2VydmljZT4oQXVkaXRvcmlhU2VydmljZSk7XG4gICAgYXVkaXRvcmlhUXVldWVTZXJ2aWNlID0gbW9kdWxlLmdldDxBdWRpdG9yaWFRdWV1ZVNlcnZpY2U+KFxuICAgICAgQXVkaXRvcmlhUXVldWVTZXJ2aWNlLFxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIHNlciBkZWZpbmlkbycsICgpID0+IHtcbiAgICBleHBlY3QobWlkZGxld2FyZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgY2hhbWFyIG5leHQoKSBxdWFuZG8gZXhlY3V0YWRvJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IG1pZGRsZXdhcmUudXNlKG1vY2tSZXF1ZXN0KCksIG1vY2tSZXNwb25zZSgpLCBtb2NrTmV4dCk7XG4gICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIGVuZmlsZWlyYXIgbG9nIGRlIGF1ZGl0b3JpYSBxdWFuZG8gYSByZXF1aXNpw6fDo28gw6kgYmVtLXN1Y2VkaWRhJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcSA9IG1vY2tSZXF1ZXN0KCk7XG4gICAgY29uc3QgcmVzID0gbW9ja1Jlc3BvbnNlKCk7XG5cbiAgICBhd2FpdCBtaWRkbGV3YXJlLnVzZShyZXEsIHJlcywgbW9ja05leHQpO1xuXG4gICAgLy8gU2ltdWxhIGEgcmVzcG9zdGEgc2VuZG8gZmluYWxpemFkYVxuICAgIHJlcy5vbignZmluaXNoJywgKCkgPT4ge30pO1xuXG4gICAgZXhwZWN0KGF1ZGl0b3JpYVF1ZXVlU2VydmljZS5lbmZpbGVpcmFyTG9nQXVkaXRvcmlhKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG5cbiAgICAvLyBWZXJpZmljYSBzZSBvIHRpcG8gZGUgb3BlcmHDp8OjbyBmb2kgbWFwZWFkbyBjb3JyZXRhbWVudGVcbiAgICBjb25zdCBjYWxsQXJncyA9IChhdWRpdG9yaWFRdWV1ZVNlcnZpY2UuZW5maWxlaXJhckxvZ0F1ZGl0b3JpYSBhcyBqZXN0Lk1vY2spXG4gICAgICAubW9jay5jYWxsc1swXVswXTtcbiAgICBleHBlY3QoY2FsbEFyZ3MudGlwb19vcGVyYWNhbykudG9CZShUaXBvT3BlcmFjYW8uUkVBRCk7XG4gICAgZXhwZWN0KGNhbGxBcmdzLmVudGlkYWRlX2FmZXRhZGEpLnRvQmUoJ1VzdWFyaW8nKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgZGV0ZWN0YXIgZGFkb3Mgc2Vuc8OtdmVpcyBubyBjb3JwbyBkYSByZXF1aXNpw6fDo28nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVxID0gbW9ja1JlcXVlc3QoKTtcbiAgICByZXEuYm9keSA9IHtcbiAgICAgIG5vbWU6ICdKb8OjbyBTaWx2YScsXG4gICAgICBjcGY6ICcxMjMuNDU2Ljc4OS0wMCcsXG4gICAgICBlbWFpbDogJ2pvYW9AZXhlbXBsby5jb20nLFxuICAgICAgZW5kZXJlY286IHtcbiAgICAgICAgcnVhOiAnUnVhIGRhcyBGbG9yZXMnLFxuICAgICAgICBudW1lcm86IDEyMyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHJlcyA9IG1vY2tSZXNwb25zZSgpO1xuXG4gICAgYXdhaXQgbWlkZGxld2FyZS51c2UocmVxLCByZXMsIG1vY2tOZXh0KTtcblxuICAgIC8vIFNpbXVsYSBhIHJlc3Bvc3RhIHNlbmRvIGZpbmFsaXphZGFcbiAgICByZXMub24oJ2ZpbmlzaCcsICgpID0+IHt9KTtcblxuICAgIGNvbnN0IGNhbGxBcmdzID0gKGF1ZGl0b3JpYVF1ZXVlU2VydmljZS5lbmZpbGVpcmFyTG9nQXVkaXRvcmlhIGFzIGplc3QuTW9jaylcbiAgICAgIC5tb2NrLmNhbGxzWzBdWzBdO1xuICAgIGV4cGVjdChjYWxsQXJncy5kYWRvc19zZW5zaXZlaXNfYWNlc3NhZG9zKS50b0NvbnRhaW4oJ2NwZicpO1xuICAgIGV4cGVjdChjYWxsQXJncy5kYWRvc19zZW5zaXZlaXNfYWNlc3NhZG9zKS50b0NvbnRhaW4oJ2VuZGVyZWNvJyk7XG4gICAgZXhwZWN0KFxuICAgICAgYXVkaXRvcmlhUXVldWVTZXJ2aWNlLmVuZmlsZWlyYXJBY2Vzc29EYWRvc1NlbnNpdmVpcyxcbiAgICApLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ27Do28gZGV2ZSBhdWRpdGFyIGVuZHBvaW50cyBleGNsdcOtZG9zJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcSA9IG1vY2tSZXF1ZXN0KCk7XG4gICAgcmVxLm9yaWdpbmFsVXJsID0gJy9hcGkvdjEvaGVhbHRoJztcblxuICAgIGNvbnN0IHJlcyA9IG1vY2tSZXNwb25zZSgpO1xuXG4gICAgYXdhaXQgbWlkZGxld2FyZS51c2UocmVxLCByZXMsIG1vY2tOZXh0KTtcblxuICAgIC8vIFNpbXVsYSBhIHJlc3Bvc3RhIHNlbmRvIGZpbmFsaXphZGFcbiAgICByZXMub24oJ2ZpbmlzaCcsICgpID0+IHt9KTtcblxuICAgIGV4cGVjdChhdWRpdG9yaWFRdWV1ZVNlcnZpY2UuZW5maWxlaXJhckxvZ0F1ZGl0b3JpYSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgbWFwZWFyIGNvcnJldGFtZW50ZSBvIG3DqXRvZG8gSFRUUCBwYXJhIG8gdGlwbyBkZSBvcGVyYcOnw6NvJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGh0dHBNZXRob2RzID0gW1xuICAgICAgeyBtZXRob2Q6ICdHRVQnLCBleHBlY3RlZFR5cGU6IFRpcG9PcGVyYWNhby5SRUFEIH0sXG4gICAgICB7IG1ldGhvZDogJ1BPU1QnLCBleHBlY3RlZFR5cGU6IFRpcG9PcGVyYWNhby5DUkVBVEUgfSxcbiAgICAgIHsgbWV0aG9kOiAnUFVUJywgZXhwZWN0ZWRUeXBlOiBUaXBvT3BlcmFjYW8uVVBEQVRFIH0sXG4gICAgICB7IG1ldGhvZDogJ1BBVENIJywgZXhwZWN0ZWRUeXBlOiBUaXBvT3BlcmFjYW8uVVBEQVRFIH0sXG4gICAgICB7IG1ldGhvZDogJ0RFTEVURScsIGV4cGVjdGVkVHlwZTogVGlwb09wZXJhY2FvLkRFTEVURSB9LFxuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IHsgbWV0aG9kLCBleHBlY3RlZFR5cGUgfSBvZiBodHRwTWV0aG9kcykge1xuICAgICAgY29uc3QgcmVxID0gbW9ja1JlcXVlc3QoKTtcbiAgICAgIHJlcS5tZXRob2QgPSBtZXRob2Q7XG5cbiAgICAgIGNvbnN0IHJlcyA9IG1vY2tSZXNwb25zZSgpO1xuXG4gICAgICBhd2FpdCBtaWRkbGV3YXJlLnVzZShyZXEsIHJlcywgbW9ja05leHQpO1xuXG4gICAgICAvLyBTaW11bGEgYSByZXNwb3N0YSBzZW5kbyBmaW5hbGl6YWRhXG4gICAgICByZXMub24oJ2ZpbmlzaCcsICgpID0+IHt9KTtcblxuICAgICAgaWYgKG1ldGhvZCAhPT0gJ09QVElPTlMnKSB7XG4gICAgICAgIGNvbnN0IGNhbGxBcmdzID0gKFxuICAgICAgICAgIGF1ZGl0b3JpYVF1ZXVlU2VydmljZS5lbmZpbGVpcmFyTG9nQXVkaXRvcmlhIGFzIGplc3QuTW9ja1xuICAgICAgICApLm1vY2suY2FsbHMucG9wKClbMF07XG4gICAgICAgIGV4cGVjdChjYWxsQXJncy50aXBvX29wZXJhY2FvKS50b0JlKGV4cGVjdGVkVHlwZSk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICBpdCgnZGV2ZSBleHRyYWlyIGNvcnJldGFtZW50ZSBvIElEIGRhIGVudGlkYWRlIGRhIFVSTCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXEgPSBtb2NrUmVxdWVzdCgpO1xuICAgIHJlcS5vcmlnaW5hbFVybCA9ICcvYXBpL3YxL3VzdWFyaW9zLzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCc7XG5cbiAgICBjb25zdCByZXMgPSBtb2NrUmVzcG9uc2UoKTtcblxuICAgIGF3YWl0IG1pZGRsZXdhcmUudXNlKHJlcSwgcmVzLCBtb2NrTmV4dCk7XG5cbiAgICAvLyBTaW11bGEgYSByZXNwb3N0YSBzZW5kbyBmaW5hbGl6YWRhXG4gICAgcmVzLm9uKCdmaW5pc2gnLCAoKSA9PiB7fSk7XG5cbiAgICBjb25zdCBjYWxsQXJncyA9IChhdWRpdG9yaWFRdWV1ZVNlcnZpY2UuZW5maWxlaXJhckxvZ0F1ZGl0b3JpYSBhcyBqZXN0Lk1vY2spXG4gICAgICAubW9jay5jYWxsc1swXVswXTtcbiAgICBleHBlY3QoY2FsbEFyZ3MuZW50aWRhZGVfYWZldGFkYSkudG9CZSgnVXN1YXJpbycpO1xuICAgIGV4cGVjdChjYWxsQXJncy5lbnRpZGFkZV9pZCkudG9CZSgnMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwJyk7XG4gIH0pO1xuXG4gIGl0KCdkZXZlIGNhcHR1cmFyIGRhZG9zIGRhIHJlc3Bvc3RhIHBhcmEgb3BlcmHDp8O1ZXMgZGUgY3JpYcOnw6NvIGUgYXR1YWxpemHDp8OjbycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXNwb25zZUJvZHkgPSB7IGlkOiAnbmV3LXVzZXItaWQnLCBub21lOiAnTm92byBVc3XDoXJpbycgfTtcblxuICAgIGNvbnN0IHJlcSA9IG1vY2tSZXF1ZXN0KCk7XG4gICAgcmVxLm1ldGhvZCA9ICdQT1NUJztcbiAgICByZXEuYm9keSA9IHsgbm9tZTogJ05vdm8gVXN1w6FyaW8nLCBlbWFpbDogJ25vdm9AZXhlbXBsby5jb20nIH07XG5cbiAgICBjb25zdCByZXMgPSBtb2NrUmVzcG9uc2UoKTtcblxuICAgIGF3YWl0IG1pZGRsZXdhcmUudXNlKHJlcSwgcmVzLCBtb2NrTmV4dCk7XG5cbiAgICAvLyBTaW11bGEgbyBlbnZpbyBkYSByZXNwb3N0YVxuICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlQm9keSkpO1xuXG4gICAgLy8gU2ltdWxhIGEgcmVzcG9zdGEgc2VuZG8gZmluYWxpemFkYVxuICAgIHJlcy5vbignZmluaXNoJywgKCkgPT4ge30pO1xuXG4gICAgY29uc3QgY2FsbEFyZ3MgPSAoYXVkaXRvcmlhUXVldWVTZXJ2aWNlLmVuZmlsZWlyYXJMb2dBdWRpdG9yaWEgYXMgamVzdC5Nb2NrKVxuICAgICAgLm1vY2suY2FsbHNbMF1bMF07XG4gICAgZXhwZWN0KGNhbGxBcmdzLmRhZG9zX25vdm9zKS50b0VxdWFsKHJlc3BvbnNlQm9keSk7XG4gICAgZXhwZWN0KGNhbGxBcmdzLmRhZG9zX2FudGVyaW9yZXMpLnRvQmVVbmRlZmluZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgY2FwdHVyYXIgZGFkb3MgYW50ZXJpb3JlcyBwYXJhIG9wZXJhw6fDtWVzIGRlIGF0dWFsaXphw6fDo28nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2VCb2R5ID0geyBpZDogJ3VzZXItaWQnLCBub21lOiAnVXN1w6FyaW8gQXR1YWxpemFkbycgfTtcblxuICAgIGNvbnN0IHJlcSA9IG1vY2tSZXF1ZXN0KCk7XG4gICAgcmVxLm1ldGhvZCA9ICdQVVQnO1xuICAgIHJlcS5vcmlnaW5hbFVybCA9ICcvYXBpL3YxL3VzdWFyaW9zL3VzZXItaWQnO1xuICAgIHJlcS5ib2R5ID0geyBub21lOiAnVXN1w6FyaW8gQXR1YWxpemFkbycgfTtcblxuICAgIGNvbnN0IHJlcyA9IG1vY2tSZXNwb25zZSgpO1xuXG4gICAgYXdhaXQgbWlkZGxld2FyZS51c2UocmVxLCByZXMsIG1vY2tOZXh0KTtcblxuICAgIC8vIFNpbXVsYSBvIGVudmlvIGRhIHJlc3Bvc3RhXG4gICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2VCb2R5KSk7XG5cbiAgICAvLyBTaW11bGEgYSByZXNwb3N0YSBzZW5kbyBmaW5hbGl6YWRhXG4gICAgcmVzLm9uKCdmaW5pc2gnLCAoKSA9PiB7fSk7XG5cbiAgICBjb25zdCBjYWxsQXJncyA9IChhdWRpdG9yaWFRdWV1ZVNlcnZpY2UuZW5maWxlaXJhckxvZ0F1ZGl0b3JpYSBhcyBqZXN0Lk1vY2spXG4gICAgICAubW9jay5jYWxsc1swXVswXTtcbiAgICBleHBlY3QoY2FsbEFyZ3MuZGFkb3Nfbm92b3MpLnRvRXF1YWwocmVzcG9uc2VCb2R5KTtcbiAgICBleHBlY3QoY2FsbEFyZ3MuZGFkb3NfYW50ZXJpb3JlcykudG9FcXVhbChyZXEuYm9keSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=