cf9e2ea303ecaa827d1cb7617cabe834
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var CacheMetricsInterceptor_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheMetricsInterceptor = void 0;
const common_1 = require("@nestjs/common");
const operators_1 = require("rxjs/operators");
const enhanced_metrics_service_1 = require("./enhanced-metrics.service");
const config_1 = require("@nestjs/config");
/**
 * Interceptor para coletar métricas de operações de cache
 *
 * Este interceptor monitora operações de cache e registra métricas
 * como taxa de acertos, tempo de resposta e operações totais.
 */
let CacheMetricsInterceptor = CacheMetricsInterceptor_1 = class CacheMetricsInterceptor {
    metricsService;
    configService;
    logger = new common_1.Logger(CacheMetricsInterceptor_1.name);
    cacheEnabled;
    cacheType;
    // Contadores para cálculo de taxa de acertos
    cacheHits = 0;
    cacheMisses = 0;
    lastReportTime = Date.now();
    reportInterval = 60000; // 1 minuto
    constructor(metricsService, configService) {
        this.metricsService = metricsService;
        this.configService = configService;
        // Verificar se o Redis está habilitado
        this.cacheEnabled = this.configService.get('DISABLE_REDIS') !== 'true';
        this.cacheType = this.cacheEnabled ? 'redis' : 'memory';
        // Iniciar relatório periódico de taxa de acertos
        this.scheduleHitRatioReport();
    }
    /**
     * Intercepta operações de cache e coleta métricas
     */
    intercept(context, next) {
        // Se o cache estiver desabilitado, apenas continua a execução
        if (!this.cacheEnabled) {
            return next.handle();
        }
        const request = context.switchToHttp().getRequest();
        const { method, url } = request;
        // Identificar operação de cache com base no método e URL
        const cacheOperation = this.getCacheOperation(method, url);
        if (!cacheOperation) {
            return next.handle();
        }
        const startTime = process.hrtime();
        return next.handle().pipe((0, operators_1.tap)({
            next: (data) => {
                // Calcular duração da operação
                const [seconds, nanoseconds] = process.hrtime(startTime);
                const durationSeconds = seconds + nanoseconds / 1e9;
                // Determinar se foi um hit ou miss no cache
                const isCacheHit = this.isCacheHit(data, cacheOperation);
                // Registrar operação de cache
                this.metricsService.recordCacheOperation(cacheOperation, true, // operação bem-sucedida
                this.cacheType);
                // Registrar duração da operação
                this.metricsService.recordCacheOperationDuration(cacheOperation, durationSeconds, this.cacheType);
                // Atualizar contadores para taxa de acertos
                if (isCacheHit) {
                    this.cacheHits++;
                }
                else {
                    this.cacheMisses++;
                }
                // Atualizar taxa de acertos periodicamente
                this.updateHitRatioIfNeeded();
            },
            error: (error) => {
                // Registrar operação de cache com falha
                this.metricsService.recordCacheOperation(cacheOperation, false, // operação falhou
                this.cacheType);
                this.logger.error(`Erro em operação de cache ${cacheOperation}: ${error.message}`);
            },
        }));
    }
    /**
     * Identifica a operação de cache com base no método e URL
     */
    getCacheOperation(method, url) {
        // Mapear métodos HTTP para operações de cache
        if (method === 'GET' && url.includes('/api/')) {
            return 'get';
        }
        if ((method === 'POST' || method === 'PUT' || method === 'DELETE') && url.includes('/api/')) {
            return 'invalidate';
        }
        return null;
    }
    /**
     * Determina se uma operação resultou em um hit no cache
     */
    isCacheHit(data, operation) {
        // Lógica para determinar se foi um hit no cache
        // Esta é uma implementação simplificada e pode precisar ser ajustada
        // com base na estrutura de resposta real da aplicação
        if (operation === 'get') {
            // Verificar se os dados têm uma propriedade que indica origem do cache
            // ou usar heurística baseada no tempo de resposta
            return data && data._fromCache === true;
        }
        return false;
    }
    /**
     * Atualiza a taxa de acertos se o intervalo de relatório foi atingido
     */
    updateHitRatioIfNeeded() {
        const now = Date.now();
        if (now - this.lastReportTime >= this.reportInterval) {
            this.updateHitRatio();
            this.lastReportTime = now;
        }
    }
    /**
     * Calcula e atualiza a taxa de acertos do cache
     */
    updateHitRatio() {
        const total = this.cacheHits + this.cacheMisses;
        if (total > 0) {
            const ratio = this.cacheHits / total;
            this.metricsService.updateCacheHitRatio(ratio, this.cacheType);
            // Resetar contadores após o relatório
            this.cacheHits = 0;
            this.cacheMisses = 0;
            this.logger.debug(`Taxa de acertos do cache (${this.cacheType}): ${(ratio * 100).toFixed(2)}%`);
        }
    }
    /**
     * Agenda relatórios periódicos de taxa de acertos
     */
    scheduleHitRatioReport() {
        setInterval(() => {
            this.updateHitRatio();
        }, this.reportInterval);
    }
};
exports.CacheMetricsInterceptor = CacheMetricsInterceptor;
exports.CacheMetricsInterceptor = CacheMetricsInterceptor = CacheMetricsInterceptor_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof enhanced_metrics_service_1.EnhancedMetricsService !== "undefined" && enhanced_metrics_service_1.EnhancedMetricsService) === "function" ? _a : Object, typeof (_b = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _b : Object])
], CacheMetricsInterceptor);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcY2FjaGUtbWV0cmljcy5pbnRlcmNlcHRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUV4Qiw4Q0FBcUM7QUFDckMseUVBQW9FO0FBQ3BFLDJDQUErQztBQUUvQzs7Ozs7R0FLRztBQUVJLElBQU0sdUJBQXVCLCtCQUE3QixNQUFNLHVCQUF1QjtJQVlmO0lBQ0E7SUFaRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMseUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEQsWUFBWSxDQUFVO0lBQ3RCLFNBQVMsQ0FBUztJQUVuQyw2Q0FBNkM7SUFDckMsU0FBUyxHQUFHLENBQUMsQ0FBQztJQUNkLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDaEIsY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNuQixjQUFjLEdBQUcsS0FBSyxDQUFDLENBQUMsV0FBVztJQUVwRCxZQUNtQixjQUFzQyxFQUN0QyxhQUE0QjtRQUQ1QixtQkFBYyxHQUFkLGNBQWMsQ0FBd0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFN0MsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLEtBQUssTUFBTSxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFFeEQsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxPQUF5QixFQUFFLElBQWlCO1FBQ3BELDhEQUE4RDtRQUM5RCxJQUFJLENBQUMsSUFBSSxD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WUFDZixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDeEIsQ0FBQyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUMxQixDQUFDO0NBQ0YsQ0FBQTtBQWhLWSwwREFBdUI7a0NBQXZCLHVCQUF1QjtJQURuQyxJQUFBLG1CQUFVLEdBQUU7eURBYXdCLGlEQUFzQixvQkFBdEIsaURBQXNCLG9EQUN2QixzQkFBYSxvQkFBYixzQkFBYTtHQWJwQyx1QkFBdUIsQ0FnS25DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXG1vbml0b3JpbmdcXGNhY2hlLW1ldHJpY3MuaW50ZXJjZXB0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTmVzdEludGVyY2VwdG9yLFxuICBFeGVjdXRpb25Db250ZXh0LFxuICBDYWxsSGFuZGxlcixcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFbmhhbmNlZE1ldHJpY3NTZXJ2aWNlIH0gZnJvbSAnLi9lbmhhbmNlZC1tZXRyaWNzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcblxuLyoqXG4gKiBJbnRlcmNlcHRvciBwYXJhIGNvbGV0YXIgbcOpdHJpY2FzIGRlIG9wZXJhw6fDtWVzIGRlIGNhY2hlXG4gKiBcbiAqIEVzdGUgaW50ZXJjZXB0b3IgbW9uaXRvcmEgb3BlcmHDp8O1ZXMgZGUgY2FjaGUgZSByZWdpc3RyYSBtw6l0cmljYXNcbiAqIGNvbW8gdGF4YSBkZSBhY2VydG9zLCB0ZW1wbyBkZSByZXNwb3N0YSBlIG9wZXJhw6fDtWVzIHRvdGFpcy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhY2hlTWV0cmljc0ludGVyY2VwdG9yIGltcGxlbWVudHMgTmVzdEludGVyY2VwdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKENhY2hlTWV0cmljc0ludGVyY2VwdG9yLm5hbWUpO1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlRW5hYmxlZDogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBjYWNoZVR5cGU6IHN0cmluZztcblxuICAvLyBDb250YWRvcmVzIHBhcmEgY8OhbGN1bG8gZGUgdGF4YSBkZSBhY2VydG9zXG4gIHByaXZhdGUgY2FjaGVIaXRzID0gMDtcbiAgcHJpdmF0ZSBjYWNoZU1pc3NlcyA9IDA7XG4gIHByaXZhdGUgbGFzdFJlcG9ydFRpbWUgPSBEYXRlLm5vdygpO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcG9ydEludGVydmFsID0gNjAwMDA7IC8vIDEgbWludXRvXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBtZXRyaWNzU2VydmljZTogRW5oYW5jZWRNZXRyaWNzU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4gICkge1xuICAgIC8vIFZlcmlmaWNhciBzZSBvIFJlZGlzIGVzdMOhIGhhYmlsaXRhZG9cbiAgICB0aGlzLmNhY2hlRW5hYmxlZCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQoJ0RJU0FCTEVfUkVESVMnKSAhPT0gJ3RydWUnO1xuICAgIHRoaXMuY2FjaGVUeXBlID0gdGhpcy5jYWNoZUVuYWJsZWQgPyAncmVkaXMnIDogJ21lbW9yeSc7XG4gICAgXG4gICAgLy8gSW5pY2lhciByZWxhdMOzcmlvIHBlcmnDs2RpY28gZGUgdGF4YSBkZSBhY2VydG9zXG4gICAgdGhpcy5zY2hlZHVsZUhpdFJhdGlvUmVwb3J0KCk7XG4gIH1cblxuICAvKipcbiAgICogSW50ZXJjZXB0YSBvcGVyYcOnw7VlcyBkZSBjYWNoZSBlIGNvbGV0YSBtw6l0cmljYXNcbiAgICovXG4gIGludGVyY2VwdChjb250ZXh0OiBFeGVjdXRpb25Db250ZXh0LCBuZXh0OiBDYWxsSGFuZGxlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgLy8gU2UgbyBjYWNoZSBlc3RpdmVyIGRlc2FiaWxpdGFkbywgYXBlbmFzIGNvbnRpbnVhIGEgZXhlY3XDp8Ojb1xuICAgIGlmICghdGhpcy5jYWNoZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBuZXh0LmhhbmRsZSgpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSBjb250ZXh0LnN3aXRjaFRvSHR0cCgpLmdldFJlcXVlc3QoKTtcbiAgICBjb25zdCB7IG1ldGhvZCwgdXJsIH0gPSByZXF1ZXN0O1xuICAgIFxuICAgIC8vIElkZW50aWZpY2FyIG9wZXJhw6fDo28gZGUgY2FjaGUgY29tIGJhc2Ugbm8gbcOpdG9kbyBlIFVSTFxuICAgIGNvbnN0IGNhY2hlT3BlcmF0aW9uID0gdGhpcy5nZXRDYWNoZU9wZXJhdGlvbihtZXRob2QsIHVybCk7XG4gICAgaWYgKCFjYWNoZU9wZXJhdGlvbikge1xuICAgICAgcmV0dXJuIG5leHQuaGFuZGxlKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcHJvY2Vzcy5ocnRpbWUoKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZSgpLnBpcGUoXG4gICAgICB0YXAoe1xuICAgICAgICBuZXh0OiAoZGF0YSkgPT4ge1xuICAgICAgICAgIC8vIENhbGN1bGFyIGR1cmHDp8OjbyBkYSBvcGVyYcOnw6NvXG4gICAgICAgICAgY29uc3QgW3NlY29uZHMsIG5hbm9zZWNvbmRzXSA9IHByb2Nlc3MuaHJ0aW1lKHN0YXJ0VGltZSk7XG4gICAgICAgICAgY29uc3QgZHVyYXRpb25TZWNvbmRzID0gc2Vjb25kcyArIG5hbm9zZWNvbmRzIC8gMWU5O1xuXG4gICAgICAgICAgLy8gRGV0ZXJtaW5hciBzZSBmb2kgdW0gaGl0IG91IG1pc3Mgbm8gY2FjaGVcbiAgICAgICAgICBjb25zdCBpc0NhY2hlSGl0ID0gdGhpcy5pc0NhY2hlSGl0KGRhdGEsIGNhY2hlT3BlcmF0aW9uKTtcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBSZWdpc3RyYXIgb3BlcmHDp8OjbyBkZSBjYWNoZVxuICAgICAgICAgIHRoaXMubWV0cmljc1NlcnZpY2UucmVjb3JkQ2FjaGVPcGVyYXRpb24oXG4gICAgICAgICAgICBjYWNoZU9wZXJhdGlvbixcbiAgICAgICAgICAgIHRydWUsIC8vIG9wZXJhw6fDo28gYmVtLXN1Y2VkaWRhXG4gICAgICAgICAgICB0aGlzLmNhY2hlVHlwZSxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gUmVnaXN0cmFyIGR1cmHDp8OjbyBkYSBvcGVyYcOnw6NvXG4gICAgICAgICAgdGhpcy5tZXRyaWNzU2VydmljZS5yZWNvcmRDYWNoZU9wZXJhdGlvbkR1cmF0aW9uKFxuICAgICAgICAgICAgY2FjaGVPcGVyYXRpb24sXG4gICAgICAgICAgICBkdXJhdGlvblNlY29uZHMsXG4gICAgICAgICAgICB0aGlzLmNhY2hlVHlwZSxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gQXR1YWxpemFyIGNvbnRhZG9yZXMgcGFyYSB0YXhhIGRlIGFjZXJ0b3NcbiAgICAgICAgICBpZiAoaXNDYWNoZUhpdCkge1xuICAgICAgICAgICAgdGhpcy5jYWNoZUhpdHMrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jYWNoZU1pc3NlcysrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIEF0dWFsaXphciB0YXhhIGRlIGFjZXJ0b3MgcGVyaW9kaWNhbWVudGVcbiAgICAgICAgICB0aGlzLnVwZGF0ZUhpdFJhdGlvSWZOZWVkZWQoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChlcnJvcikgPT4ge1xuICAgICAgICAgIC8vIFJlZ2lzdHJhciBvcGVyYcOnw6NvIGRlIGNhY2hlIGNvbSBmYWxoYVxuICAgICAgICAgIHRoaXMubWV0cmljc1NlcnZpY2UucmVjb3JkQ2FjaGVPcGVyYXRpb24oXG4gICAgICAgICAgICBjYWNoZU9wZXJhdGlvbixcbiAgICAgICAgICAgIGZhbHNlLCAvLyBvcGVyYcOnw6NvIGZhbGhvdVxuICAgICAgICAgICAgdGhpcy5jYWNoZVR5cGUsXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgYEVycm8gZW0gb3BlcmHDp8OjbyBkZSBjYWNoZSAke2NhY2hlT3BlcmF0aW9ufTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogSWRlbnRpZmljYSBhIG9wZXJhw6fDo28gZGUgY2FjaGUgY29tIGJhc2Ugbm8gbcOpdG9kbyBlIFVSTFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDYWNoZU9wZXJhdGlvbihtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICAvLyBNYXBlYXIgbcOpdG9kb3MgSFRUUCBwYXJhIG9wZXJhw6fDtWVzIGRlIGNhY2hlXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcgJiYgdXJsLmluY2x1ZGVzKCcvYXBpLycpKSB7XG4gICAgICByZXR1cm4gJ2dldCc7XG4gICAgfVxuICAgIGlmICgobWV0aG9kID09PSAnUE9TVCcgfHwgbWV0aG9kID09PSAnUFVUJyB8fCBtZXRob2QgPT09ICdERUxFVEUnKSAmJiB1cmwuaW5jbHVkZXMoJy9hcGkvJykpIHtcbiAgICAgIHJldHVybiAnaW52YWxpZGF0ZSc7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluYSBzZSB1bWEgb3BlcmHDp8OjbyByZXN1bHRvdSBlbSB1bSBoaXQgbm8gY2FjaGVcbiAgICovXG4gIHByaXZhdGUgaXNDYWNoZUhpdChkYXRhOiBhbnksIG9wZXJhdGlvbjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgLy8gTMOzZ2ljYSBwYXJhIGRldGVybWluYXIgc2UgZm9pIHVtIGhpdCBubyBjYWNoZVxuICAgIC8vIEVzdGEgw6kgdW1hIGltcGxlbWVudGHDp8OjbyBzaW1wbGlmaWNhZGEgZSBwb2RlIHByZWNpc2FyIHNlciBhanVzdGFkYVxuICAgIC8vIGNvbSBiYXNlIG5hIGVzdHJ1dHVyYSBkZSByZXNwb3N0YSByZWFsIGRhIGFwbGljYcOnw6NvXG4gICAgaWYgKG9wZXJhdGlvbiA9PT0gJ2dldCcpIHtcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvcyBkYWRvcyB0w6ptIHVtYSBwcm9wcmllZGFkZSBxdWUgaW5kaWNhIG9yaWdlbSBkbyBjYWNoZVxuICAgICAgLy8gb3UgdXNhciBoZXVyw61zdGljYSBiYXNlYWRhIG5vIHRlbXBvIGRlIHJlc3Bvc3RhXG4gICAgICByZXR1cm4gZGF0YSAmJiBkYXRhLl9mcm9tQ2FjaGUgPT09IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHVhbGl6YSBhIHRheGEgZGUgYWNlcnRvcyBzZSBvIGludGVydmFsbyBkZSByZWxhdMOzcmlvIGZvaSBhdGluZ2lkb1xuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVIaXRSYXRpb0lmTmVlZGVkKCk6IHZvaWQge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgaWYgKG5vdyAtIHRoaXMubGFzdFJlcG9ydFRpbWUgPj0gdGhpcy5yZXBvcnRJbnRlcnZhbCkge1xuICAgICAgdGhpcy51cGRhdGVIaXRSYXRpbygpO1xuICAgICAgdGhpcy5sYXN0UmVwb3J0VGltZSA9IG5vdztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBlIGF0dWFsaXphIGEgdGF4YSBkZSBhY2VydG9zIGRvIGNhY2hlXG4gICAqL1xuICBwcml2YXRlIHVwZGF0ZUhpdFJhdGlvKCk6IHZvaWQge1xuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5jYWNoZUhpdHMgKyB0aGlzLmNhY2hlTWlzc2VzO1xuICAgIGlmICh0b3RhbCA+IDApIHtcbiAgICAgIGNvbnN0IHJhdGlvID0gdGhpcy5jYWNoZUhpdHMgLyB0b3RhbDtcbiAgICAgIHRoaXMubWV0cmljc1NlcnZpY2UudXBkYXRlQ2FjaGVIaXRSYXRpbyhyYXRpbywgdGhpcy5jYWNoZVR5cGUpO1xuICAgICAgXG4gICAgICAvLyBSZXNldGFyIGNvbnRhZG9yZXMgYXDDs3MgbyByZWxhdMOzcmlvXG4gICAgICB0aGlzLmNhY2hlSGl0cyA9IDA7XG4gICAgICB0aGlzLmNhY2hlTWlzc2VzID0gMDtcbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgIGBUYXhhIGRlIGFjZXJ0b3MgZG8gY2FjaGUgKCR7dGhpcy5jYWNoZVR5cGV9KTogJHsocmF0aW8gKiAxMDApLnRvRml4ZWQoMil9JWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZ2VuZGEgcmVsYXTDs3Jpb3MgcGVyacOzZGljb3MgZGUgdGF4YSBkZSBhY2VydG9zXG4gICAqL1xuICBwcml2YXRlIHNjaGVkdWxlSGl0UmF0aW9SZXBvcnQoKTogdm9pZCB7XG4gICAgc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVIaXRSYXRpbygpO1xuICAgIH0sIHRoaXMucmVwb3J0SW50ZXJ2YWwpO1xuICB9XG59Il0sInZlcnNpb24iOjN9