91d9e9c0932897e4f2e4a5783c22a961
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var PasswordResetService_1;
var _a, _b, _c, _d, _e, _f, _g, _h, _j;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PasswordResetService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const config_1 = require("@nestjs/config");
const schedule_1 = require("@nestjs/schedule");
const jwt_1 = require("@nestjs/jwt");
const crypto = __importStar(require("crypto"));
const bcrypt = __importStar(require("bcrypt"));
const password_reset_token_entity_1 = require("../../entities/password-reset-token.entity");
const usuario_repository_1 = require("../../modules/usuario/repositories/usuario.repository");
const email_service_1 = require("../../common/services/email.service");
const audit_service_1 = require("../../audit/services/audit.service");
const audit_log_entity_1 = require("../../entities/audit-log.entity");
let PasswordResetService = PasswordResetService_1 = class PasswordResetService {
    passwordResetTokenRepository;
    usuarioRepository;
    emailService;
    auditService;
    configService;
    jwtService;
    dataSource;
    logger = new common_1.Logger(PasswordResetService_1.name);
    tokenExpirationMinutes;
    maxAttemptsPerToken;
    maxRequestsPerHour;
    constructor(passwordResetTokenRepository, usuarioRepository, emailService, auditService, configService, jwtService, dataSource) {
        this.passwordResetTokenRepository = passwordResetTokenRepository;
        this.usuarioRepository = usuarioRepository;
        this.emailService = emailService;
        this.auditService = auditService;
        this.configService = configService;
        this.jwtService = jwtService;
        this.dataSource = dataSource;
        this.tokenExpirationMinutes = this.configService.get('PASSWORD_RESET_EXPIRATION_MINUTES', 15);
        this.maxAttemptsPerToken = this.configService.get('PASSWORD_RESET_MAX_ATTEMPTS', 3);
        this.maxRequestsPerHour = this.configService.get('PASSWORD_RESET_MAX_REQUESTS_PER_HOUR', 5);
        // Iniciar limpeza automática de tokens expirados
        this.startTokenCleanup();
    }
    /**
     * Solicita recuperação de senha
     */
    async requestPasswordReset(requestDto, clientInfo) {
        const { email } = requestDto;
        try {
            // Buscar usuário pelo email
            const usuario = await this.usuarioRepository.findByEmail(email.toLowerCase());
            // Por segurança, sempre retornamos sucesso mesmo se o email não existir
            if (!usuario) {
                this.logger.warn(`Tentativa de reset para email inexistente: ${email}`, {
                    ip: clientInfo.ip,
                    userAgent: clientInfo.userAgent,
                });
                await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Tentativa de reset para email inexistente: ${email}`, undefined, audit_log_entity_1.AuditSeverity.MEDIUM, { email }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
                return {
                    message: 'Se o email existir, você receberá instruções para redefinir sua senha.',
                    expiresInMinutes: this.tokenExpirationMinutes,
                };
            }
            // Verificar rate limiting
            await this.checkRateLimit(usuario.id, clientInfo.ip);
            // Invalidar tokens anteriores do usuário
            await this.invalidateUserTokens(usuario.id, 'new_request');
            // Gerar novo token
            const token = this.generateSecureToken();
            const tokenHash = await this.hashToken(token);
            const expiresAt = new Date(Date.now() + this.tokenExpirationMinutes * 60 * 1000);
            // Salvar token no banco
            const passwordResetToken = this.passwordResetTokenRepository.create({
                token: token.substring(0, 8) + '...', // Armazenar apenas parte do token para auditoria
                token_hash: tokenHash,
                usuario_id: usuario.id,
                expires_at: expiresAt,
                client_ip: clientInfo.ip,
                user_agent: clientInfo.userAgent,
                metadata: {
                    origin: clientInfo.origin,
                    referer: clientInfo.referer,
                },
            });
            await this.passwordResetTokenRepository.save(passwordResetToken);
            // Enviar email
            await this.sendPasswordResetEmail(usuario, token, expiresAt);
            // Log de auditoria
            await this.auditService.logUserAction(usuario.id, audit_log_entity_1.AuditAction.PASSWORD_RESET, 'password_reset_token', passwordResetToken.id, 'Solicitação de recuperação de senha', { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            this.logger.log(`Token de recuperação gerado para usuário ${usuario.id}`);
            return {
                message: 'Se o email existir, você receberá instruções para redefinir sua senha.',
                expiresInMinutes: this.tokenExpirationMinutes,
            };
        }
        catch (error) {
            this.logger.error('Erro ao solicitar recuperação de senha', error.stack);
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Erro ao processar solicitação de reset: ${error.message}`, undefined, audit_log_entity_1.AuditSeverity.HIGH, { email, error: error.message }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            throw new common_1.InternalServerErrorException('Erro interno. Tente novamente mais tarde.');
        }
    }
    /**
     * Redefine a senha usando o token
     */
    async resetPassword(resetDto, clientInfo) {
        const { token, newPassword, confirmPassword } = resetDto;
        // Validar senhas
        if (newPassword !== confirmPassword) {
            throw new common_1.BadRequestException('As senhas não coincidem');
        }
        if (newPassword.length < 8) {
            throw new common_1.BadRequestException('A senha deve ter pelo menos 8 caracteres');
        }
        try {
            // Buscar token válido
            const resetToken = await this.findValidToken(token);
            if (!resetToken) {
                await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, 'Tentativa de uso de token inválido para reset de senha', undefined, audit_log_entity_1.AuditSeverity.HIGH, { tokenPrefix: token.substring(0, 8) }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
                throw new common_1.UnauthorizedException('Token inválido ou expirado');
            }
            // Carregar usuário pelo ID
            const usuario = await this.usuarioRepository.findById(resetToken.usuario_id);
            if (!usuario) {
                throw new common_1.NotFoundException('Usuário não encontrado');
            }
            // Verificar se a nova senha é diferente da atual
            const isSamePassword = await bcrypt.compare(newPassword, usuario.senhaHash);
            if (isSamePassword) {
                throw new common_1.BadRequestException('A nova senha deve ser diferente da senha atual');
            }
            // Hash da nova senha
            const hashedPassword = await bcrypt.hash(newPassword, 12);
            // Atualizar senha do usuário usando query builder
            await this.passwordResetTokenRepository
                .manager
                .createQueryBuilder()
                .update('usuario')
                .set({
                senha: hashedPassword,
                updated_at: new Date()
            })
                .where("id = :id", { id: usuario.id })
                .execute();
            // Marcar token como usado
            resetToken.markAsUsed('password_changed');
            await this.passwordResetTokenRepository.save(resetToken);
            // Invalidar outros tokens do usuário
            await this.invalidateUserTokens(usuario.id, 'password_changed', resetToken.id);
            // Enviar email de confirmação
            await this.sendPasswordResetConfirmationEmail(usuario, clientInfo);
            // Log de auditoria
            await this.auditService.logUserAction(usuario.id, audit_log_entity_1.AuditAction.PASSWORD_RESET, 'usuario', usuario.id, 'Senha redefinida com sucesso', { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Senha redefinida com sucesso para o usuário ${usuario.email}`, usuario.id, audit_log_entity_1.AuditSeverity.MEDIUM, { email: usuario.email }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            this.logger.log(`Senha redefinida com sucesso para usuário ${usuario.id}`);
            return {
                message: 'Senha redefinida com sucesso. Você pode fazer login com sua nova senha.',
            };
        }
        catch (error) {
            // Registrar erro e redirecionar
            const foundToken = await this.findValidToken(token);
            if (foundToken) {
                foundToken.markAsUsed('password_reset_error');
                await this.passwordResetTokenRepository.save(foundToken);
            }
            this.logger.error('Erro ao redefinir senha', error.stack);
            await this.auditService.logSecurityEvent(audit_log_entity_1.AuditAction.PASSWORD_RESET, `Erro ao redefinir senha: ${error.message}`, foundToken?.usuario?.id, audit_log_entity_1.AuditSeverity.HIGH, { tokenPrefix: token.substring(0, 8), error: error.message }, { ip: clientInfo.ip, userAgent: clientInfo.userAgent });
            if (error instanceof common_1.BadRequestException ||
                error instanceof common_1.UnauthorizedException ||
                error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno. Tente novamente mais tarde.');
        }
    }
    /**
     * Valida se um token é válido
     */
    async validateToken(token) {
        try {
            const resetToken = await this.findValidToken(token);
            if (!resetToken) {
                return { valid: false };
            }
            return {
                valid: true,
                expiresInMinutes: resetToken.getMinutesUntilExpiration(),
            };
        }
        catch (error) {
            this.logger.error('Erro ao validar token', error.stack);
            return { valid: false };
        }
    }
    /**
     * Obtém estatísticas de recuperação de senha
     */
    async getPasswordResetStats() {
        const now = new Date();
        const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const [totalRequests, activeTokens, expiredTokens, usedTokens, requestsLast24h] = await Promise.all([
            this.passwordResetTokenRepository.count(),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: { is_used: true },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    created_at: (0, typeorm_2.LessThan)(last24h),
                },
            }),
        ]);
        // Calcular tempo médio de uso
        const usedTokensWithTime = await this.passwordResetTokenRepository
            .createQueryBuilder('token')
            .select('AVG(EXTRACT(EPOCH FROM (token.used_at - token.created_at)) / 60)', 'avgMinutes')
            .where('token.is_used = true AND token.used_at IS NOT NULL')
            .getRawOne();
        const averageTimeToUse = parseFloat(usedTokensWithTime?.avgMinutes || '0');
        return {
            totalRequests,
            activeTokens,
            expiredTokens,
            usedTokens,
            requestsLast24h,
            averageTimeToUse,
        };
    }
    /**
     * Limpeza automática de tokens expirados (executa a cada hora)
     */
    async cleanupExpiredTokens() {
        try {
            const now = new Date();
            const result = await this.passwordResetTokenRepository.delete({
                expires_at: (0, typeorm_2.LessThan)(now),
                is_used: false,
            });
            if (result.affected && result.affected > 0) {
                this.logger.log(`Removidos ${result.affected} tokens de recuperação expirados`);
            }
            return result.affected || 0;
        }
        catch (error) {
            this.logger.error('Erro na limpeza de tokens expirados', error.stack);
            return 0;
        }
    }
    /**
     * Limpeza de tokens antigos usados (executa diariamente)
     */
    async cleanupOldUsedTokens() {
        try {
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const result = await this.passwordResetTokenRepository.delete({
                is_used: true,
                used_at: (0, typeorm_2.LessThan)(thirtyDaysAgo),
            });
            if (result.affected && result.affected > 0) {
                this.logger.log(`Removidos ${result.affected} tokens de recuperação antigos`);
            }
            return result.affected || 0;
        }
        catch (error) {
            this.logger.error('Erro na limpeza de tokens antigos', error.stack);
            return 0;
        }
    }
    // Métodos privados
    generateSecureToken() {
        return crypto.randomBytes(32).toString('hex');
    }
    async hashToken(token) {
        return bcrypt.hash(token, 10);
    }
    async findValidToken(token) {
        const tokens = await this.passwordResetTokenRepository.find({
            where: {
                is_used: false,
                expires_at: (0, typeorm_2.LessThan)(new Date()),
            },
            relations: ['usuario'],
        });
        for (const resetToken of tokens) {
            const isValid = await bcrypt.compare(token, resetToken.token_hash);
            if (isValid && resetToken.isValid()) {
                // Incrementar tentativas
                resetToken.incrementAttempts();
                await this.passwordResetTokenRepository.save(resetToken);
                // Verificar limite de tentativas
                if (resetToken.attempts > this.maxAttemptsPerToken) {
                    resetToken.markAsUsed('max_attempts_exceeded');
                    await this.passwordResetTokenRepository.save(resetToken);
                    return null;
                }
                return resetToken;
            }
        }
        return null;
    }
    async checkRateLimit(usuarioId, ip) {
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const recentRequests = await this.passwordResetTokenRepository.count({
            where: [
                {
                    usuario_id: usuarioId,
                    created_at: (0, typeorm_2.LessThan)(oneHourAgo),
                },
                {
                    client_ip: ip,
                    created_at: (0, typeorm_2.LessThan)(oneHourAgo),
                },
            ],
        });
        if (recentRequests >= this.maxRequestsPerHour) {
            throw new common_1.BadRequestException('Muitas solicitações de recuperação. Tente novamente mais tarde.');
        }
    }
    async invalidateUserTokens(usuarioId, reason, excludeTokenId) {
        const query = this.passwordResetTokenRepository
            .createQueryBuilder()
            .update(password_reset_token_entity_1.PasswordResetToken)
            .set({
            is_used: true,
            invalidation_reason: reason,
            updated_at: new Date(),
        })
            .where('usuario_id = :usuarioId', { usuarioId })
            .andWhere('is_used = false');
        if (excludeTokenId) {
            query.andWhere('id != :excludeTokenId', { excludeTokenId });
        }
        await query.execute();
    }
    async sendPasswordResetEmail(usuario, token, expiresAt) {
        const expiresInMinutes = Math.ceil((expiresAt.getTime() - Date.now()) / (1000 * 60));
        await this.emailService.sendPasswordResetEmail(usuario.email, usuario.nome, token, expiresInMinutes);
    }
    async sendPasswordResetConfirmationEmail(usuario, clientInfo) {
        await this.emailService.sendPasswordResetConfirmationEmail(usuario.email, usuario.nome);
    }
    /**
     * Inicia a limpeza automática de tokens expirados
     * Migrado do PasswordRecoveryService
     */
    startTokenCleanup() {
        const CLEANUP_INTERVAL = 24 * 60 * 60 * 1000; // 24 horas
        // Executar limpeza a cada 24 horas
        setInterval(async () => {
            try {
                await this.cleanupExpiredTokens();
            }
            catch (error) {
                this.logger.error(`Erro na limpeza automática de tokens: ${error.message}`);
            }
        }, CLEANUP_INTERVAL);
        // Executar limpeza de tokens usados a cada 24 horas
        setInterval(async () => {
            try {
                await this.cleanupOldUsedTokens();
            }
            catch (error) {
                this.logger.error(`Erro na limpeza de tokens usados: ${error.message}`);
            }
        }, CLEANUP_INTERVAL);
    }
    /**
     * Obtém estatísticas de tokens de recuperação
     * Migrado do PasswordRecoveryService
     * @returns Estatísticas dos tokens
     */
    async getTokenStats() {
        const now = new Date();
        const [total, active, expired, used] = await Promise.all([
            this.passwordResetTokenRepository.count(),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: false,
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    expires_at: (0, typeorm_2.LessThan)(now),
                },
            }),
            this.passwordResetTokenRepository.count({
                where: {
                    is_used: true,
                },
            }),
        ]);
        return { total, active, expired, used };
    }
};
exports.PasswordResetService = PasswordResetService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_HOUR),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_h = typeof Promise !== "undefined" && Promise) === "function" ? _h : Object)
], PasswordResetService.prototype, "cleanupExpiredTokens", null);
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_DAY_AT_2AM),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_j = typeof Promise !== "undefined" && Promise) === "function" ? _j : Object)
], PasswordResetService.prototype, "cleanupOldUsedTokens", null);
exports.PasswordResetService = PasswordResetService = PasswordResetService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(password_reset_token_entity_1.PasswordResetToken)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof usuario_repository_1.UsuarioRepository !== "undefined" && usuario_repository_1.UsuarioRepository) === "function" ? _b : Object, typeof (_c = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _c : Object, typeof (_d = typeof audit_service_1.AuditService !== "undefined" && audit_service_1.AuditService) === "function" ? _d : Object, typeof (_e = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _e : Object, typeof (_f = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _f : Object, typeof (_g = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _g : Object])
], PasswordResetService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHNlcnZpY2VzXFxwYXNzd29yZC1yZXNldC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBT3dCO0FBQ3hCLDZDQUFtRDtBQUNuRCxxQ0FBMkQ7QUFDM0QsMkNBQStDO0FBQy9DLCtDQUF3RDtBQUN4RCxxQ0FBeUM7QUFDekMsK0NBQWlDO0FBQ2pDLCtDQUFpQztBQUNqQyw0RkFBZ0Y7QUFFaEYsOEZBQTBGO0FBQzFGLHVFQUFtRTtBQUNuRSxzRUFBa0U7QUFFbEUsc0VBQTZFO0FBc0J0RSxJQUFNLG9CQUFvQiw0QkFBMUIsTUFBTSxvQkFBb0I7SUFRWjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxzQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxzQkFBc0IsQ0FBUztJQUMvQixtQkFBbUIsQ0FBUztJQUM1QixrQkFBa0IsQ0FBUztJQUU1QyxZQUVtQiw0QkFBNEQsRUFDNUQsaUJBQW9DLEVBQ3BDLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLGFBQTRCLEVBQzVCLFVBQXNCLEVBQ3RCLFVBQXNCO1FBTnRCLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBZ0M7UUFDNUQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFFdkMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUNsRCxtQ0FBbUMsRUFDbkMsRUFBRSxDQUNILENBQUM7UUFDRixJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQy9DLDZCQUE2QixFQUM3QixDQUFDLENBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FDOUMsc0NBQXNDLEVBQ3RDLENBQUMsQ0FDRixDQUFDO1FBRUYsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxvQkFBb0IsQ0FDeEIsVUFBbUMsRUFDbkMsVUFBc0I7UUFFdEIsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUU3QixJQUFJLENBQUM7WUFDSCw0QkFBNEI7WUFDNUIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBRTlFLHdFQUF3RTtZQUN4RSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsOENBQThDLEtBQUssRUFBRSxFQUFFO29CQUN0RSxFQUFFLEVBQUUsVUFBVSxDQUFDLEVBQUU7b0JBQ2pCLFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUztpQkFDaEMsQ0FBQyxDQUFDO2dCQUVILE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FDdEMsOEJBQVcsQ0FBQyxjQUFjLEVBQzFCLDhDQUE4QyxLQUFLLEVBQUUsRUFDckQsU0FBUyxFQUNULGdDQUFhLENBQUMsTUFBTSxFQUNwQixFQUFFLEtBQUssRUFBRSxFQUNULEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FDdkQsQ0FBQztnQkFFRixPQUFPO29CQUNMLE9BQU8sRUFBRSx3RUFBd0U7b0JBQ2pGLGdCQUFnQixFQUFFLElBQUksQ0FBQyxzQkFBc0I7aUJBQzlDLENBQUM7WUFDSixDQUFDO1lBRUQsMEJBQTBCO1lBQzFCLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUVyRCx5Q0FBeUM7WUFDekMsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUUzRCxtQkFBbUI7WUFDbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDekMsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBRWpGLHdCQUF3QjtZQUN4QixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUM7Z0JBQ2xFLEtBQUssRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLEVBQUUsaURBQWlEO2dCQUN2RixVQUFVLEVBQUUsU0FBUztnQkFDckIsVUFBVSxFQUFFLE9BQU8sQ0FBQyxFQUFFO2dCQUN0QixVQUFVLEVBQUUsU0FBUztnQkFDckIsU0FBUyxFQUFFLFVBQVUsQ0FBQyxFQUFFO2dCQUN4QixVQUFVLEVBQUUsVUFBVSxDQUFDLFNBQVM7Z0JBQ2hDLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07b0JBQ3pCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztpQkFDNUI7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUVqRSxlQUFlO1lBQ2YsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQztZQUU3RCxtQkFBbUI7WUFDbkIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FDbkMsT0FBTyxDQUFDLEVBQUUsRUFDViw4QkFBVyxDQUFDLGNBQWMsRUFDMUIsc0JBQXNCLEVBQ3RCLGtCQUFrQixDQUFDLEVBQUUsRUFDckIscUNBQXFDLEVBQ3JDLEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FDdkQsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUUxRSxPQUFPO2dCQUNMLE9BQU8sRUFBRSx3RUFBd0U7Z0JBQ2pGLGdCQUFnQixFQUFFLElBQUksQ0FBQyxzQkFBc0I7YUFDOUMsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0NBQXdDLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXpFLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FDdEMsOEJBQVcsQ0FBQyxjQUFjLEVBQzFCLDJDQUEyQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQzFELFNBQVMsRUFDVCxnQ0FBYSxDQUFDLElBQUksRUFDbEIsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFDL0IsRUFBRSxFQUFFLEVBQUUsVUFBVSxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLFNBQVMsRUFBRSxDQUN2RCxDQUFDO1lBRUYsTUFBTSxJQUFJLHFDQUE0QixDQUNwQywyQ0FBMkMsQ0FDNUMsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUNqQixRQUEwQixFQUMxQixVQUFzQjtRQUV0QixNQUFNLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsR0FBRyxRQUFRLENBQUM7UUFFekQsaUJBQWlCO1FBQ2pCLElBQUksV0FBVyxLQUFLLGVBQWUsRUFBRSxDQUFDO1lBQ3BDLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFRCxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDM0IsTUFBTSxJQUFJLDRCQUFtQixDQUFDLDBDQUEwQyxDQUFDLENBQUM7UUFDNUUsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILHNCQUFzQjtZQUN0QixNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNoQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQ3RDLDhCQUFXLENBQUMsY0FBYyxFQUMxQix3REFBd0QsRUFDeEQsU0FBUyxFQUNULGdDQUFhLENBQUMsSUFBSSxFQUNsQixFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUN0QyxFQUFFLEVBQUUsRUFBRSxVQUFVLENBQUMsRUFBRSxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUyxFQUFFLENBQ3ZELENBQUM7Z0JBQ0YsTUFBTSxJQUFJLDhCQUFxQixDQUFDLDRCQUE0QixDQUFDLENBQUM7WUFDaEUsQ0FBQztZQUVELDJCQUEyQjtZQUMzQixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTdFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDYixNQUFNLElBQUksMEJBQWlCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN4RCxDQUFDO1lBRUQsaURBQWlEO1lBQ2pELE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzVFLElBQUksY0FBYyxFQUFFLENBQUM7Z0JBQ25CLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsZ0RBQWdELENBQ2pELENBQUM7WUFDSixDQUFDO1lBRUQscUJBQXFCO1lBQ3JCLE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFMUQsa0RBQWtEO1lBQ2xELE1BQU0sSUFBSSxDQUFDLDRCQUE0QjtpQkFDcEMsT0FBTztpQkFDUCxrQkFBa0IsRUFBRTtpQkFDcEIsTUFBTSxDQUFDLFNBQVMsQ0FBQztpQkFDakIsR0FBRyxDQUFDO2dCQUNILEtBQUssRUFBRSxjQUFjO2dCQUNyQixVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUU7YUFDdkIsQ0FBQztpQkFDRCxLQUFLLENBQUMsVUFBVSxFQUFFLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQztpQkFDckMsT0FBTyxFQUFFLENBQUM7WUFFYiwwQkFBMEI7WUFDMUIsVUFBVSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUV6RCxxQ0FBcUM7WUFDckMsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxrQkFBa0IsRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFL0UsOEJBQThCO1lBQzlCLE1BQU0sSUFBSSxDQUFDLGtDQUFrQyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUVuRSxtQkFBbUI7WUFDbkIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FDbkMsT0FBTyxDQUFDLEVBQUUsRUFDViw4QkFBVyxDQUFDLGNBQWMsRUFDMUIsU0FBUyxFQUNULE9BQU8sQ0FBQyxFQUFFLEVBQ1YsOEJBQThCLEVBQzlCLEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FDdkQsQ0FBQztZQUVGLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FDdEMsOEJBQVcsQ0FBQyxjQUFjLEVBQzFCLCtDQUErQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQzlELE9BQU8sQ0FBQyxFQUFFLEVBQ1YsZ0NBQWEsQ0FBQyxNQUFNLEVBQ3BCLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFDeEIsRUFBRSxFQUFFLEVBQUUsVUFBVSxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLFNBQVMsRUFBRSxDQUN2RCxDQUFDO1lBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRTNFLE9BQU87Z0JBQ0wsT0FBTyxFQUFFLHlFQUF5RTthQUNuRixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQ0FBZ0M7WUFDaEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BELElBQUksVUFBVSxFQUFFLENBQUM7Z0JBQ2YsVUFBVSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO2dCQUM5QyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDM0QsQ0FBQztZQUVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUxRCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQ3RDLDhCQUFXLENBQUMsY0FBYyxFQUMxQiw0QkFBNEIsS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUMzQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFDdkIsZ0NBQWEsQ0FBQyxJQUFJLEVBQ2xCLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQzVELEVBQUUsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FDdkQsQ0FBQztZQUVGLElBQUksS0FBSyxZQUFZLDRCQUFtQjtnQkFDcEMsS0FBSyxZQUFZLDhCQUFxQjtnQkFDdEMsS0FBSyxZQUFZLDBCQUFpQixFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUVELE1BQU0sSUFBSSxxQ0FBNEIsQ0FDcEMsMkNBQTJDLENBQzVDLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFhO1FBQy9CLElBQUksQ0FBQztZQUNILE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVwRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ2hCLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDMUIsQ0FBQztZQUVELE9BQU87Z0JBQ0wsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLHlCQUF5QixFQUFFO2FBQ3pELENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN4RCxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQzFCLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCO1FBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRTlELE1BQU0sQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsZUFBZSxDQUFDLEdBQzdFLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUNoQixJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxFQUFFO1lBQ3pDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxLQUFLLENBQUM7Z0JBQ3RDLEtBQUssRUFBRTtvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxVQUFVLEVBQUUsSUFBQSxrQkFBUSxFQUFDLEdBQUcsQ0FBQztpQkFDMUI7YUFDRixDQUFDO1lBQ0YsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQztnQkFDdEMsS0FBSyxFQUFFO29CQUNMLE9BQU8sRUFBRSxLQUFLO29CQUNkLFVBQVUsRUFBRSxJQUFBLGtCQUFRLEVBQUMsR0FBRyxDQUFDO2lCQUMxQjthQUNGLENBQUM7WUFDRixJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDO2dCQUN0QyxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2FBQ3pCLENBQUM7WUFDRixJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDO2dCQUN0QyxLQUFLLEVBQUU7b0JBQ0wsVUFBVSxFQUFFLElBQUEsa0JBQVEsRUFBQyxPQUFPLENBQUM7aUJBQzlCO2FBQ0YsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVMLDhCQUE4QjtRQUM5QixNQUFNLGtCQUFrQixHQUFHLE1BQU0sSUFBSSxDQUFDLDRCQUE0QjthQUMvRCxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7YUFDM0IsTUFBTSxDQUFDLGtFQUFrRSxFQUFFLFlBQVksQ0FBQzthQUN4RixLQUFLLENBQUMsb0RBQW9ELENBQUM7YUFDM0QsU0FBUyxFQUFFLENBQUM7UUFFZixNQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxrQkFBa0IsRUFBRSxVQUFVLElBQUksR0FBRyxDQUFDLENBQUM7UUFFM0UsT0FBTztZQUNMLGFBQWE7WUFDYixZQUFZO1lBQ1osYUFBYTtZQUNiLFVBQVU7WUFDVixlQUFlO1lBQ2YsZ0JBQWdCO1NBQ2pCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFFRyxBQUFOLEtBQUssQ0FBQyxvQkFBb0I7UUFDeEIsSUFBSSxDQUFDO1lBQ0gsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN2QixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUM7Z0JBQzVELFVBQVUsRUFBRSxJQUFBLGtCQUFRLEVBQUMsR0FBRyxDQUFDO2dCQUN6QixPQUFPLEVBQUUsS0FBSzthQUNmLENBQUMsQ0FBQztZQUVILElBQUksTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsUUFBUSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLE1BQU0sQ0FBQyxRQUFRLGtDQUFrQyxDQUFDLENBQUM7WUFDbEYsQ0FBQztZQUVELE9BQU8sTUFBTSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUM7UUFDOUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEUsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBRUcsQUFBTixLQUFLLENBQUMsb0JBQW9CO1FBQ3hCLElBQUksQ0FBQztZQUNILE1BQU0sYUFBYSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDdEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsTUFBTSxDQUFDO2dCQUM1RCxPQUFPLEVBQUUsSUFBSTtnQkFDYixPQUFPLEVBQUUsSUFBQSxrQkFBUSxFQUFDLGFBQWEsQ0FBQzthQUNqQyxDQUFDLENBQUM7WUFFSCxJQUFJLE1BQU0sQ0FBQyxRQUFRLElBQUksTUFBTSxDQUFDLFFBQVEsR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxNQUFNLENBQUMsUUFBUSxnQ0FBZ0MsQ0FBQyxDQUFDO1lBQ2hGLENBQUM7WUFFRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BFLE9BQU8sQ0FBQyxDQUFDO1FBQ1gsQ0FBQztJQUNILENBQUM7SUFFRCxtQkFBbUI7SUFFWCxtQkFBbUI7UUFDekIsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFhO1FBQ25DLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVPLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBYTtRQUN4QyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUM7WUFDMUQsS0FBSyxFQUFFO2dCQUNMLE9BQU8sRUFBRSxLQUFLO2dCQUNkLFVBQVUsRUFBRSxJQUFBLGtCQUFRLEVBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQzthQUNqQztZQUNELFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQztTQUN2QixDQUFDLENBQUM7UUFFSCxLQUFLLE1BQU0sVUFBVSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ2hDLE1BQU0sT0FBTyxHQUFHLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ25FLElBQUksT0FBTyxJQUFJLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO2dCQUNwQyx5QkFBeUI7Z0JBQ3pCLFVBQVUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUMvQixNQUFNLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBRXpELGlDQUFpQztnQkFDakMsSUFBSSxVQUFVLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO29CQUNuRCxVQUFVLENBQUMsVUFBVSxDQUFDLHVCQUF1QixDQUFDLENBQUM7b0JBQy9DLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDekQsT0FBTyxJQUFJLENBQUM7Z0JBQ2QsQ0FBQztnQkFFRCxPQUFPLFVBQVUsQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLEtBQUssQ0FBQyxjQUFjLENBQUMsU0FBaUIsRUFBRSxFQUFVO1FBQ3hELE1BQU0sVUFBVSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRXpELE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQztZQUNuRSxLQUFLLEVBQUU7Z0JBQ0w7b0JBQ0UsVUFBVSxFQUFFLFNBQVM7b0JBQ3JCLFVBQVUsRUFBRSxJQUFBLGtCQUFRLEVBQUMsVUFBVSxDQUFDO2lCQUNqQztnQkFDRDtvQkFDRSxTQUFTLEVBQUUsRUFBRTtvQkFDYixVQUFVLEVBQUUsSUFBQSxrQkFBUSxFQUFDLFVBQVUsQ0FBQztpQkFDakM7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILElBQUksY0FBYyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzlDLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsaUVBQWlFLENBQ2xFLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxvQkFBb0IsQ0FDaEMsU0FBaUIsRUFDakIsTUFBYyxFQUNkLGNBQXVCO1FBRXZCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyw0QkFBNEI7YUFDNUMsa0JBQWtCLEVBQUU7YUFDcEIsTUFBTSxDQUFDLGdEQUFrQixDQUFDO2FBQzFCLEdBQUcsQ0FBQztZQUNILE9BQU8sRUFBRSxJQUFJO1lBQ2IsbUJBQW1CLEVBQUUsTUFBTTtZQUMzQixVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdkIsQ0FBQzthQUNELEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDO2FBQy9DLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRS9CLElBQUksY0FBYyxFQUFFLENBQUM7WUFDbkIsS0FBSyxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELE1BQU0sS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFTyxLQUFLLENBQUMsc0JBQXNCLENBQ2xDLE9BQWdCLEVBQ2hCLEtBQWEsRUFDYixTQUFlO1FBRWYsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFckYsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLHNCQUFzQixDQUM1QyxPQUFPLENBQUMsS0FBSyxFQUNiLE9BQU8sQ0FBQyxJQUFJLEVBQ1osS0FBSyxFQUNMLGdCQUFnQixDQUNqQixDQUFDO0lBQ0osQ0FBQztJQUVPLEtBQUssQ0FBQyxrQ0FBa0MsQ0FDOUMsT0FBZ0IsRUFDaEIsVUFBc0I7UUFFdEIsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGtDQUFrQyxDQUN4RCxPQUFPLENBQUMsS0FBSyxFQUNiLE9BQU8sQ0FBQyxJQUFJLENBQ2IsQ0FBQztJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSyxpQkFBaUI7UUFDdkIsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxXQUFXO1FBRXpELG1DQUFtQztRQUNuQyxXQUFXLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDckIsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDcEMsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUNBQXlDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzlFLENBQUM7UUFDSCxDQUFDLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUVyQixvREFBb0Q7UUFDcEQsV0FBVyxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ3JCLElBQUksQ0FBQztnQkFDSCxNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQ3BDLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUMxRSxDQUFDO1FBQ0gsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUlEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsYUFBYTtRQU1qQixNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRXZCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDdkQsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssRUFBRTtZQUN6QyxJQUFJLENBQUMsNEJBQTRCLENBQUMsS0FBSyxDQUFDO2dCQUN0QyxLQUFLLEVBQUU7b0JBQ0wsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsVUFBVSxFQUFFLElBQUEsa0JBQVEsRUFBQyxHQUFHLENBQUM7aUJBQzFCO2FBQ0YsQ0FBQztZQUNGLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxLQUFLLENBQUM7Z0JBQ3RDLEtBQUssRUFBRTtvQkFDTCxVQUFVLEVBQUUsSUFBQSxrQkFBUSxFQUFDLEdBQUcsQ0FBQztpQkFDMUI7YUFDRixDQUFDO1lBQ0YsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQztnQkFDdEMsS0FBSyxFQUFFO29CQUNMLE9BQU8sRUFBRSxJQUFJO2lCQUNkO2FBQ0YsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0NBQ0YsQ0FBQTtBQXhpQlksb0RBQW9CO0FBZ1Z6QjtJQURMLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMsVUFBVSxDQUFDOzs7d0RBQ0YsT0FBTyxvQkFBUCxPQUFPO2dFQWlCcEM7QUFNSztJQURMLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMsZ0JBQWdCLENBQUM7Ozt3REFDUixPQUFPLG9CQUFQLE9BQU87Z0VBaUJwQzsrQkF4WFUsb0JBQW9CO0lBRGhDLElBQUEsbUJBQVUsR0FBRTtJQVFSLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyxnREFBa0IsQ0FBQyxDQUFBO3lEQUNVLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUNyQixzQ0FBaUIsb0JBQWpCLHNDQUFpQixvREFDdEIsNEJBQVksb0JBQVosNEJBQVksb0RBQ1osNEJBQVksb0JBQVosNEJBQVksb0RBQ1gsc0JBQWEsb0JBQWIsc0JBQWEsb0RBQ2hCLGdCQUFVLG9CQUFWLGdCQUFVLG9EQUNWLG9CQUFVLG9CQUFWLG9CQUFVO0dBZDlCLG9CQUFvQixDQXdpQmhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxhdXRoXFxzZXJ2aWNlc1xccGFzc3dvcmQtcmVzZXQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgVW5hdXRob3JpemVkRXhjZXB0aW9uLFxuICBMb2dnZXIsXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSwgTGVzc1RoYW4sIERhdGFTb3VyY2UgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBDcm9uLCBDcm9uRXhwcmVzc2lvbiB9IGZyb20gJ0BuZXN0anMvc2NoZWR1bGUnO1xuaW1wb3J0IHsgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0ICogYXMgYmNyeXB0IGZyb20gJ2JjcnlwdCc7XG5pbXBvcnQgeyBQYXNzd29yZFJlc2V0VG9rZW4gfSBmcm9tICcuLi8uLi9lbnRpdGllcy9wYXNzd29yZC1yZXNldC10b2tlbi5lbnRpdHknO1xuaW1wb3J0IHsgVXN1YXJpbyB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3VzdWFyaW8uZW50aXR5JztcbmltcG9ydCB7IFVzdWFyaW9SZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vbW9kdWxlcy91c3VhcmlvL3JlcG9zaXRvcmllcy91c3VhcmlvLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vY29tbW9uL3NlcnZpY2VzL2VtYWlsLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXVkaXRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vYXVkaXQvc2VydmljZXMvYXVkaXQuc2VydmljZSc7XG5pbXBvcnQgeyBDbGllbnRJbmZvIH0gZnJvbSAnLi4vLi4vY29tbW9uL2ludGVyZmFjZXMvY2xpZW50LWluZm8uaW50ZXJmYWNlJztcbmltcG9ydCB7IEF1ZGl0QWN0aW9uLCBBdWRpdFNldmVyaXR5IH0gZnJvbSAnLi4vLi4vZW50aXRpZXMvYXVkaXQtbG9nLmVudGl0eSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdFBhc3N3b3JkUmVzZXREdG8ge1xuICBlbWFpbDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc2V0UGFzc3dvcmREdG8ge1xuICB0b2tlbjogc3RyaW5nO1xuICBuZXdQYXNzd29yZDogc3RyaW5nO1xuICBjb25maXJtUGFzc3dvcmQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYXNzd29yZFJlc2V0U3RhdHMge1xuICB0b3RhbFJlcXVlc3RzOiBudW1iZXI7XG4gIGFjdGl2ZVRva2VuczogbnVtYmVyO1xuICBleHBpcmVkVG9rZW5zOiBudW1iZXI7XG4gIHVzZWRUb2tlbnM6IG51bWJlcjtcbiAgcmVxdWVzdHNMYXN0MjRoOiBudW1iZXI7XG4gIGF2ZXJhZ2VUaW1lVG9Vc2U6IG51bWJlcjsgLy8gZW0gbWludXRvc1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGFzc3dvcmRSZXNldFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoUGFzc3dvcmRSZXNldFNlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgdG9rZW5FeHBpcmF0aW9uTWludXRlczogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IG1heEF0dGVtcHRzUGVyVG9rZW46IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhSZXF1ZXN0c1BlckhvdXI6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShQYXNzd29yZFJlc2V0VG9rZW4pXG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFBhc3N3b3JkUmVzZXRUb2tlbj4sXG4gICAgcHJpdmF0ZSByZWFkb25seSB1c3VhcmlvUmVwb3NpdG9yeTogVXN1YXJpb1JlcG9zaXRvcnksXG4gICAgcHJpdmF0ZSByZWFkb25seSBlbWFpbFNlcnZpY2U6IEVtYWlsU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1ZGl0U2VydmljZTogQXVkaXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGp3dFNlcnZpY2U6IEp3dFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBkYXRhU291cmNlOiBEYXRhU291cmNlLFxuICApIHtcbiAgICB0aGlzLnRva2VuRXhwaXJhdGlvbk1pbnV0ZXMgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXG4gICAgICAnUEFTU1dPUkRfUkVTRVRfRVhQSVJBVElPTl9NSU5VVEVTJyxcbiAgICAgIDE1LFxuICAgICk7XG4gICAgdGhpcy5tYXhBdHRlbXB0c1BlclRva2VuID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KFxuICAgICAgJ1BBU1NXT1JEX1JFU0VUX01BWF9BVFRFTVBUUycsXG4gICAgICAzLFxuICAgICk7XG4gICAgdGhpcy5tYXhSZXF1ZXN0c1BlckhvdXIgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oXG4gICAgICAnUEFTU1dPUkRfUkVTRVRfTUFYX1JFUVVFU1RTX1BFUl9IT1VSJyxcbiAgICAgIDUsXG4gICAgKTtcbiAgICBcbiAgICAvLyBJbmljaWFyIGxpbXBlemEgYXV0b23DoXRpY2EgZGUgdG9rZW5zIGV4cGlyYWRvc1xuICAgIHRoaXMuc3RhcnRUb2tlbkNsZWFudXAoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTb2xpY2l0YSByZWN1cGVyYcOnw6NvIGRlIHNlbmhhXG4gICAqL1xuICBhc3luYyByZXF1ZXN0UGFzc3dvcmRSZXNldChcbiAgICByZXF1ZXN0RHRvOiBSZXF1ZXN0UGFzc3dvcmRSZXNldER0byxcbiAgICBjbGllbnRJbmZvOiBDbGllbnRJbmZvLFxuICApOiBQcm9taXNlPHsgbWVzc2FnZTogc3RyaW5nOyBleHBpcmVzSW5NaW51dGVzOiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IHsgZW1haWwgfSA9IHJlcXVlc3REdG87XG5cbiAgICB0cnkge1xuICAgICAgLy8gQnVzY2FyIHVzdcOhcmlvIHBlbG8gZW1haWxcbiAgICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLnVzdWFyaW9SZXBvc2l0b3J5LmZpbmRCeUVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgICAvLyBQb3Igc2VndXJhbsOnYSwgc2VtcHJlIHJldG9ybmFtb3Mgc3VjZXNzbyBtZXNtbyBzZSBvIGVtYWlsIG7Do28gZXhpc3RpclxuICAgICAgaWYgKCF1c3VhcmlvKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFRlbnRhdGl2YSBkZSByZXNldCBwYXJhIGVtYWlsIGluZXhpc3RlbnRlOiAke2VtYWlsfWAsIHtcbiAgICAgICAgICBpcDogY2xpZW50SW5mby5pcCxcbiAgICAgICAgICB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50LFxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KFxuICAgICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICAgIGBUZW50YXRpdmEgZGUgcmVzZXQgcGFyYSBlbWFpbCBpbmV4aXN0ZW50ZTogJHtlbWFpbH1gLFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICBBdWRpdFNldmVyaXR5Lk1FRElVTSxcbiAgICAgICAgICB7IGVtYWlsIH0sXG4gICAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9XG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtZXNzYWdlOiAnU2UgbyBlbWFpbCBleGlzdGlyLCB2b2PDqiByZWNlYmVyw6EgaW5zdHJ1w6fDtWVzIHBhcmEgcmVkZWZpbmlyIHN1YSBzZW5oYS4nLFxuICAgICAgICAgIGV4cGlyZXNJbk1pbnV0ZXM6IHRoaXMudG9rZW5FeHBpcmF0aW9uTWludXRlcyxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZpY2FyIHJhdGUgbGltaXRpbmdcbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tSYXRlTGltaXQodXN1YXJpby5pZCwgY2xpZW50SW5mby5pcCk7XG5cbiAgICAgIC8vIEludmFsaWRhciB0b2tlbnMgYW50ZXJpb3JlcyBkbyB1c3XDoXJpb1xuICAgICAgYXdhaXQgdGhpcy5pbnZhbGlkYXRlVXNlclRva2Vucyh1c3VhcmlvLmlkLCAnbmV3X3JlcXVlc3QnKTtcblxuICAgICAgLy8gR2VyYXIgbm92byB0b2tlblxuICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmdlbmVyYXRlU2VjdXJlVG9rZW4oKTtcbiAgICAgIGNvbnN0IHRva2VuSGFzaCA9IGF3YWl0IHRoaXMuaGFzaFRva2VuKHRva2VuKTtcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLnRva2VuRXhwaXJhdGlvbk1pbnV0ZXMgKiA2MCAqIDEwMDApO1xuXG4gICAgICAvLyBTYWx2YXIgdG9rZW4gbm8gYmFuY29cbiAgICAgIGNvbnN0IHBhc3N3b3JkUmVzZXRUb2tlbiA9IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICB0b2tlbjogdG9rZW4uc3Vic3RyaW5nKDAsIDgpICsgJy4uLicsIC8vIEFybWF6ZW5hciBhcGVuYXMgcGFydGUgZG8gdG9rZW4gcGFyYSBhdWRpdG9yaWFcbiAgICAgICAgdG9rZW5faGFzaDogdG9rZW5IYXNoLFxuICAgICAgICB1c3VhcmlvX2lkOiB1c3VhcmlvLmlkLFxuICAgICAgICBleHBpcmVzX2F0OiBleHBpcmVzQXQsXG4gICAgICAgIGNsaWVudF9pcDogY2xpZW50SW5mby5pcCxcbiAgICAgICAgdXNlcl9hZ2VudDogY2xpZW50SW5mby51c2VyQWdlbnQsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgb3JpZ2luOiBjbGllbnRJbmZvLm9yaWdpbixcbiAgICAgICAgICByZWZlcmVyOiBjbGllbnRJbmZvLnJlZmVyZXIsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LnNhdmUocGFzc3dvcmRSZXNldFRva2VuKTtcblxuICAgICAgLy8gRW52aWFyIGVtYWlsXG4gICAgICBhd2FpdCB0aGlzLnNlbmRQYXNzd29yZFJlc2V0RW1haWwodXN1YXJpbywgdG9rZW4sIGV4cGlyZXNBdCk7XG5cbiAgICAgIC8vIExvZyBkZSBhdWRpdG9yaWFcbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1VzZXJBY3Rpb24oXG4gICAgICAgIHVzdWFyaW8uaWQsXG4gICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICAncGFzc3dvcmRfcmVzZXRfdG9rZW4nLFxuICAgICAgICBwYXNzd29yZFJlc2V0VG9rZW4uaWQsXG4gICAgICAgICdTb2xpY2l0YcOnw6NvIGRlIHJlY3VwZXJhw6fDo28gZGUgc2VuaGEnLFxuICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH1cbiAgICAgICk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVG9rZW4gZGUgcmVjdXBlcmHDp8OjbyBnZXJhZG8gcGFyYSB1c3XDoXJpbyAke3VzdWFyaW8uaWR9YCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICdTZSBvIGVtYWlsIGV4aXN0aXIsIHZvY8OqIHJlY2ViZXLDoSBpbnN0cnXDp8O1ZXMgcGFyYSByZWRlZmluaXIgc3VhIHNlbmhhLicsXG4gICAgICAgIGV4cGlyZXNJbk1pbnV0ZXM6IHRoaXMudG9rZW5FeHBpcmF0aW9uTWludXRlcyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvIGFvIHNvbGljaXRhciByZWN1cGVyYcOnw6NvIGRlIHNlbmhhJywgZXJyb3Iuc3RhY2spO1xuICAgICAgXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KFxuICAgICAgICBBdWRpdEFjdGlvbi5QQVNTV09SRF9SRVNFVCxcbiAgICAgICAgYEVycm8gYW8gcHJvY2Vzc2FyIHNvbGljaXRhw6fDo28gZGUgcmVzZXQ6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIEF1ZGl0U2V2ZXJpdHkuSElHSCxcbiAgICAgICAgeyBlbWFpbCwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSxcbiAgICAgICAgeyBpcDogY2xpZW50SW5mby5pcCwgdXNlckFnZW50OiBjbGllbnRJbmZvLnVzZXJBZ2VudCB9XG4gICAgICApO1xuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJuby4gVGVudGUgbm92YW1lbnRlIG1haXMgdGFyZGUuJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlZGVmaW5lIGEgc2VuaGEgdXNhbmRvIG8gdG9rZW5cbiAgICovXG4gIGFzeW5jIHJlc2V0UGFzc3dvcmQoXG4gICAgcmVzZXREdG86IFJlc2V0UGFzc3dvcmREdG8sXG4gICAgY2xpZW50SW5mbzogQ2xpZW50SW5mbyxcbiAgKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgeyB0b2tlbiwgbmV3UGFzc3dvcmQsIGNvbmZpcm1QYXNzd29yZCB9ID0gcmVzZXREdG87XG5cbiAgICAvLyBWYWxpZGFyIHNlbmhhc1xuICAgIGlmIChuZXdQYXNzd29yZCAhPT0gY29uZmlybVBhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQXMgc2VuaGFzIG7Do28gY29pbmNpZGVtJyk7XG4gICAgfVxuXG4gICAgaWYgKG5ld1Bhc3N3b3JkLmxlbmd0aCA8IDgpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBIHNlbmhhIGRldmUgdGVyIHBlbG8gbWVub3MgOCBjYXJhY3RlcmVzJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEJ1c2NhciB0b2tlbiB2w6FsaWRvXG4gICAgICBjb25zdCByZXNldFRva2VuID0gYXdhaXQgdGhpcy5maW5kVmFsaWRUb2tlbih0b2tlbik7XG4gICAgICBpZiAoIXJlc2V0VG9rZW4pIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudChcbiAgICAgICAgICBBdWRpdEFjdGlvbi5QQVNTV09SRF9SRVNFVCxcbiAgICAgICAgICAnVGVudGF0aXZhIGRlIHVzbyBkZSB0b2tlbiBpbnbDoWxpZG8gcGFyYSByZXNldCBkZSBzZW5oYScsXG4gICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgIEF1ZGl0U2V2ZXJpdHkuSElHSCxcbiAgICAgICAgICB7IHRva2VuUHJlZml4OiB0b2tlbi5zdWJzdHJpbmcoMCwgOCkgfSxcbiAgICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH1cbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignVG9rZW4gaW52w6FsaWRvIG91IGV4cGlyYWRvJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIENhcnJlZ2FyIHVzdcOhcmlvIHBlbG8gSURcbiAgICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLnVzdWFyaW9SZXBvc2l0b3J5LmZpbmRCeUlkKHJlc2V0VG9rZW4udXN1YXJpb19pZCk7XG5cbiAgICAgIGlmICghdXN1YXJpbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzdcOhcmlvIG7Do28gZW5jb250cmFkbycpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZmljYXIgc2UgYSBub3ZhIHNlbmhhIMOpIGRpZmVyZW50ZSBkYSBhdHVhbFxuICAgICAgY29uc3QgaXNTYW1lUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShuZXdQYXNzd29yZCwgdXN1YXJpby5zZW5oYUhhc2gpO1xuICAgICAgaWYgKGlzU2FtZVBhc3N3b3JkKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICdBIG5vdmEgc2VuaGEgZGV2ZSBzZXIgZGlmZXJlbnRlIGRhIHNlbmhhIGF0dWFsJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gSGFzaCBkYSBub3ZhIHNlbmhhXG4gICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKG5ld1Bhc3N3b3JkLCAxMik7XG5cbiAgICAgIC8vIEF0dWFsaXphciBzZW5oYSBkbyB1c3XDoXJpbyB1c2FuZG8gcXVlcnkgYnVpbGRlclxuICAgICAgYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5XG4gICAgICAgIC5tYW5hZ2VyXG4gICAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoKVxuICAgICAgICAudXBkYXRlKCd1c3VhcmlvJylcbiAgICAgICAgLnNldCh7XG4gICAgICAgICAgc2VuaGE6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKClcbiAgICAgICAgfSlcbiAgICAgICAgLndoZXJlKFwiaWQgPSA6aWRcIiwgeyBpZDogdXN1YXJpby5pZCB9KVxuICAgICAgICAuZXhlY3V0ZSgpO1xuXG4gICAgICAvLyBNYXJjYXIgdG9rZW4gY29tbyB1c2Fkb1xuICAgICAgcmVzZXRUb2tlbi5tYXJrQXNVc2VkKCdwYXNzd29yZF9jaGFuZ2VkJyk7XG4gICAgICBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuc2F2ZShyZXNldFRva2VuKTtcblxuICAgICAgLy8gSW52YWxpZGFyIG91dHJvcyB0b2tlbnMgZG8gdXN1w6FyaW9cbiAgICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZVVzZXJUb2tlbnModXN1YXJpby5pZCwgJ3Bhc3N3b3JkX2NoYW5nZWQnLCByZXNldFRva2VuLmlkKTtcblxuICAgICAgLy8gRW52aWFyIGVtYWlsIGRlIGNvbmZpcm1hw6fDo29cbiAgICAgIGF3YWl0IHRoaXMuc2VuZFBhc3N3b3JkUmVzZXRDb25maXJtYXRpb25FbWFpbCh1c3VhcmlvLCBjbGllbnRJbmZvKTtcblxuICAgICAgLy8gTG9nIGRlIGF1ZGl0b3JpYVxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nVXNlckFjdGlvbihcbiAgICAgICAgdXN1YXJpby5pZCxcbiAgICAgICAgQXVkaXRBY3Rpb24uUEFTU1dPUkRfUkVTRVQsXG4gICAgICAgICd1c3VhcmlvJyxcbiAgICAgICAgdXN1YXJpby5pZCxcbiAgICAgICAgJ1NlbmhhIHJlZGVmaW5pZGEgY29tIHN1Y2Vzc28nLFxuICAgICAgICB7IGlwOiBjbGllbnRJbmZvLmlwLCB1c2VyQWdlbnQ6IGNsaWVudEluZm8udXNlckFnZW50IH1cbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoXG4gICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICBgU2VuaGEgcmVkZWZpbmlkYSBjb20gc3VjZXNzbyBwYXJhIG8gdXN1w6FyaW8gJHt1c3VhcmlvLmVtYWlsfWAsXG4gICAgICAgIHVzdWFyaW8uaWQsXG4gICAgICAgIEF1ZGl0U2V2ZXJpdHkuTUVESVVNLFxuICAgICAgICB7IGVtYWlsOiB1c3VhcmlvLmVtYWlsIH0sXG4gICAgICAgIHsgaXA6IGNsaWVudEluZm8uaXAsIHVzZXJBZ2VudDogY2xpZW50SW5mby51c2VyQWdlbnQgfVxuICAgICAgKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBTZW5oYSByZWRlZmluaWRhIGNvbSBzdWNlc3NvIHBhcmEgdXN1w6FyaW8gJHt1c3VhcmlvLmlkfWApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiAnU2VuaGEgcmVkZWZpbmlkYSBjb20gc3VjZXNzby4gVm9jw6ogcG9kZSBmYXplciBsb2dpbiBjb20gc3VhIG5vdmEgc2VuaGEuJyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIFJlZ2lzdHJhciBlcnJvIGUgcmVkaXJlY2lvbmFyXG4gICAgICBjb25zdCBmb3VuZFRva2VuID0gYXdhaXQgdGhpcy5maW5kVmFsaWRUb2tlbih0b2tlbik7XG4gICAgICBpZiAoZm91bmRUb2tlbikge1xuICAgICAgICBmb3VuZFRva2VuLm1hcmtBc1VzZWQoJ3Bhc3N3b3JkX3Jlc2V0X2Vycm9yJyk7XG4gICAgICAgIGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5zYXZlKGZvdW5kVG9rZW4pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJybyBhbyByZWRlZmluaXIgc2VuaGEnLCBlcnJvci5zdGFjayk7XG4gICAgICBcbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoXG4gICAgICAgIEF1ZGl0QWN0aW9uLlBBU1NXT1JEX1JFU0VULFxuICAgICAgICBgRXJybyBhbyByZWRlZmluaXIgc2VuaGE6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBmb3VuZFRva2VuPy51c3VhcmlvPy5pZCxcbiAgICAgICAgQXVkaXRTZXZlcml0eS5ISUdILFxuICAgICAgICB7IHRva2VuUHJlZml4OiB0b2tlbi5zdWJzdHJpbmcoMCwgOCksIGVycm9yOiBlcnJvci5tZXNzYWdlIH0sXG4gICAgICAgIHsgaXA6IGNsaWVudEluZm8uaXAsIHVzZXJBZ2VudDogY2xpZW50SW5mby51c2VyQWdlbnQgfVxuICAgICAgKTtcblxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgQmFkUmVxdWVzdEV4Y2VwdGlvbiB8fCBcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB8fCBcbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJuby4gVGVudGUgbm92YW1lbnRlIG1haXMgdGFyZGUuJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBzZSB1bSB0b2tlbiDDqSB2w6FsaWRvXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPHsgdmFsaWQ6IGJvb2xlYW47IGV4cGlyZXNJbk1pbnV0ZXM/OiBudW1iZXIgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNldFRva2VuID0gYXdhaXQgdGhpcy5maW5kVmFsaWRUb2tlbih0b2tlbik7XG4gICAgICBcbiAgICAgIGlmICghcmVzZXRUb2tlbikge1xuICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICAgIGV4cGlyZXNJbk1pbnV0ZXM6IHJlc2V0VG9rZW4uZ2V0TWludXRlc1VudGlsRXhwaXJhdGlvbigpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm8gYW8gdmFsaWRhciB0b2tlbicsIGVycm9yLnN0YWNrKTtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gZXN0YXTDrXN0aWNhcyBkZSByZWN1cGVyYcOnw6NvIGRlIHNlbmhhXG4gICAqL1xuICBhc3luYyBnZXRQYXNzd29yZFJlc2V0U3RhdHMoKTogUHJvbWlzZTxQYXNzd29yZFJlc2V0U3RhdHM+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGxhc3QyNGggPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgICBjb25zdCBbdG90YWxSZXF1ZXN0cywgYWN0aXZlVG9rZW5zLCBleHBpcmVkVG9rZW5zLCB1c2VkVG9rZW5zLCByZXF1ZXN0c0xhc3QyNGhdID0gXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCgpLFxuICAgICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBpc191c2VkOiBmYWxzZSxcbiAgICAgICAgICAgIGV4cGlyZXNfYXQ6IExlc3NUaGFuKG5vdyksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGlzX3VzZWQ6IGZhbHNlLFxuICAgICAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyBpc191c2VkOiB0cnVlIH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjcmVhdGVkX2F0OiBMZXNzVGhhbihsYXN0MjRoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgIF0pO1xuXG4gICAgLy8gQ2FsY3VsYXIgdGVtcG8gbcOpZGlvIGRlIHVzb1xuICAgIGNvbnN0IHVzZWRUb2tlbnNXaXRoVGltZSA9IGF3YWl0IHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeVxuICAgICAgLmNyZWF0ZVF1ZXJ5QnVpbGRlcigndG9rZW4nKVxuICAgICAgLnNlbGVjdCgnQVZHKEVYVFJBQ1QoRVBPQ0ggRlJPTSAodG9rZW4udXNlZF9hdCAtIHRva2VuLmNyZWF0ZWRfYXQpKSAvIDYwKScsICdhdmdNaW51dGVzJylcbiAgICAgIC53aGVyZSgndG9rZW4uaXNfdXNlZCA9IHRydWUgQU5EIHRva2VuLnVzZWRfYXQgSVMgTk9UIE5VTEwnKVxuICAgICAgLmdldFJhd09uZSgpO1xuXG4gICAgY29uc3QgYXZlcmFnZVRpbWVUb1VzZSA9IHBhcnNlRmxvYXQodXNlZFRva2Vuc1dpdGhUaW1lPy5hdmdNaW51dGVzIHx8ICcwJyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxSZXF1ZXN0cyxcbiAgICAgIGFjdGl2ZVRva2VucyxcbiAgICAgIGV4cGlyZWRUb2tlbnMsXG4gICAgICB1c2VkVG9rZW5zLFxuICAgICAgcmVxdWVzdHNMYXN0MjRoLFxuICAgICAgYXZlcmFnZVRpbWVUb1VzZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIExpbXBlemEgYXV0b23DoXRpY2EgZGUgdG9rZW5zIGV4cGlyYWRvcyAoZXhlY3V0YSBhIGNhZGEgaG9yYSlcbiAgICovXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZX0hPVVIpXG4gIGFzeW5jIGNsZWFudXBFeHBpcmVkVG9rZW5zKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuZGVsZXRlKHtcbiAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgaXNfdXNlZDogZmFsc2UsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3VsdC5hZmZlY3RlZCAmJiByZXN1bHQuYWZmZWN0ZWQgPiAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgUmVtb3ZpZG9zICR7cmVzdWx0LmFmZmVjdGVkfSB0b2tlbnMgZGUgcmVjdXBlcmHDp8OjbyBleHBpcmFkb3NgKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIHJlc3VsdC5hZmZlY3RlZCB8fCAwO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJybyBuYSBsaW1wZXphIGRlIHRva2VucyBleHBpcmFkb3MnLCBlcnJvci5zdGFjayk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGltcGV6YSBkZSB0b2tlbnMgYW50aWdvcyB1c2Fkb3MgKGV4ZWN1dGEgZGlhcmlhbWVudGUpXG4gICAqL1xuICBAQ3JvbihDcm9uRXhwcmVzc2lvbi5FVkVSWV9EQVlfQVRfMkFNKVxuICBhc3luYyBjbGVhbnVwT2xkVXNlZFRva2VucygpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0aGlydHlEYXlzQWdvID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIDMwICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuZGVsZXRlKHtcbiAgICAgICAgaXNfdXNlZDogdHJ1ZSxcbiAgICAgICAgdXNlZF9hdDogTGVzc1RoYW4odGhpcnR5RGF5c0FnbyksXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3VsdC5hZmZlY3RlZCAmJiByZXN1bHQuYWZmZWN0ZWQgPiAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgUmVtb3ZpZG9zICR7cmVzdWx0LmFmZmVjdGVkfSB0b2tlbnMgZGUgcmVjdXBlcmHDp8OjbyBhbnRpZ29zYCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQuYWZmZWN0ZWQgfHwgMDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm8gbmEgbGltcGV6YSBkZSB0b2tlbnMgYW50aWdvcycsIGVycm9yLnN0YWNrKTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8vIE3DqXRvZG9zIHByaXZhZG9zXG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZVNlY3VyZVRva2VuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNyeXB0by5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYXNoVG9rZW4odG9rZW46IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGJjcnlwdC5oYXNoKHRva2VuLCAxMCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRWYWxpZFRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPFBhc3N3b3JkUmVzZXRUb2tlbiB8IG51bGw+IHtcbiAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuZmluZCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpc191c2VkOiBmYWxzZSxcbiAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obmV3IERhdGUoKSksXG4gICAgICB9LFxuICAgICAgcmVsYXRpb25zOiBbJ3VzdWFyaW8nXSxcbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgcmVzZXRUb2tlbiBvZiB0b2tlbnMpIHtcbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZSh0b2tlbiwgcmVzZXRUb2tlbi50b2tlbl9oYXNoKTtcbiAgICAgIGlmIChpc1ZhbGlkICYmIHJlc2V0VG9rZW4uaXNWYWxpZCgpKSB7XG4gICAgICAgIC8vIEluY3JlbWVudGFyIHRlbnRhdGl2YXNcbiAgICAgICAgcmVzZXRUb2tlbi5pbmNyZW1lbnRBdHRlbXB0cygpO1xuICAgICAgICBhd2FpdCB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuc2F2ZShyZXNldFRva2VuKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFZlcmlmaWNhciBsaW1pdGUgZGUgdGVudGF0aXZhc1xuICAgICAgICBpZiAocmVzZXRUb2tlbi5hdHRlbXB0cyA+IHRoaXMubWF4QXR0ZW1wdHNQZXJUb2tlbikge1xuICAgICAgICAgIHJlc2V0VG9rZW4ubWFya0FzVXNlZCgnbWF4X2F0dGVtcHRzX2V4Y2VlZGVkJyk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LnNhdmUocmVzZXRUb2tlbik7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiByZXNldFRva2VuO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja1JhdGVMaW1pdCh1c3VhcmlvSWQ6IHN0cmluZywgaXA6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG9uZUhvdXJBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNjAgKiA2MCAqIDEwMDApO1xuICAgIFxuICAgIGNvbnN0IHJlY2VudFJlcXVlc3RzID0gYXdhaXQgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgIHdoZXJlOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB1c3VhcmlvX2lkOiB1c3VhcmlvSWQsXG4gICAgICAgICAgY3JlYXRlZF9hdDogTGVzc1RoYW4ob25lSG91ckFnbyksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBjbGllbnRfaXA6IGlwLFxuICAgICAgICAgIGNyZWF0ZWRfYXQ6IExlc3NUaGFuKG9uZUhvdXJBZ28pLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIGlmIChyZWNlbnRSZXF1ZXN0cyA+PSB0aGlzLm1heFJlcXVlc3RzUGVySG91cikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdNdWl0YXMgc29saWNpdGHDp8O1ZXMgZGUgcmVjdXBlcmHDp8Ojby4gVGVudGUgbm92YW1lbnRlIG1haXMgdGFyZGUuJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbnZhbGlkYXRlVXNlclRva2VucyhcbiAgICB1c3VhcmlvSWQ6IHN0cmluZyxcbiAgICByZWFzb246IHN0cmluZyxcbiAgICBleGNsdWRlVG9rZW5JZD86IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoKVxuICAgICAgLnVwZGF0ZShQYXNzd29yZFJlc2V0VG9rZW4pXG4gICAgICAuc2V0KHtcbiAgICAgICAgaXNfdXNlZDogdHJ1ZSxcbiAgICAgICAgaW52YWxpZGF0aW9uX3JlYXNvbjogcmVhc29uLFxuICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSlcbiAgICAgIC53aGVyZSgndXN1YXJpb19pZCA9IDp1c3VhcmlvSWQnLCB7IHVzdWFyaW9JZCB9KVxuICAgICAgLmFuZFdoZXJlKCdpc191c2VkID0gZmFsc2UnKTtcblxuICAgIGlmIChleGNsdWRlVG9rZW5JZCkge1xuICAgICAgcXVlcnkuYW5kV2hlcmUoJ2lkICE9IDpleGNsdWRlVG9rZW5JZCcsIHsgZXhjbHVkZVRva2VuSWQgfSk7XG4gICAgfVxuXG4gICAgYXdhaXQgcXVlcnkuZXhlY3V0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kUGFzc3dvcmRSZXNldEVtYWlsKFxuICAgIHVzdWFyaW86IFVzdWFyaW8sXG4gICAgdG9rZW46IHN0cmluZyxcbiAgICBleHBpcmVzQXQ6IERhdGUsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGV4cGlyZXNJbk1pbnV0ZXMgPSBNYXRoLmNlaWwoKGV4cGlyZXNBdC5nZXRUaW1lKCkgLSBEYXRlLm5vdygpKSAvICgxMDAwICogNjApKTtcblxuICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRQYXNzd29yZFJlc2V0RW1haWwoXG4gICAgICB1c3VhcmlvLmVtYWlsLFxuICAgICAgdXN1YXJpby5ub21lLFxuICAgICAgdG9rZW4sXG4gICAgICBleHBpcmVzSW5NaW51dGVzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFBhc3N3b3JkUmVzZXRDb25maXJtYXRpb25FbWFpbChcbiAgICB1c3VhcmlvOiBVc3VhcmlvLFxuICAgIGNsaWVudEluZm86IENsaWVudEluZm8sXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRQYXNzd29yZFJlc2V0Q29uZmlybWF0aW9uRW1haWwoXG4gICAgICB1c3VhcmlvLmVtYWlsLFxuICAgICAgdXN1YXJpby5ub21lXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmljaWEgYSBsaW1wZXphIGF1dG9tw6F0aWNhIGRlIHRva2VucyBleHBpcmFkb3NcbiAgICogTWlncmFkbyBkbyBQYXNzd29yZFJlY292ZXJ5U2VydmljZVxuICAgKi9cbiAgcHJpdmF0ZSBzdGFydFRva2VuQ2xlYW51cCgpOiB2b2lkIHtcbiAgICBjb25zdCBDTEVBTlVQX0lOVEVSVkFMID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gMjQgaG9yYXNcbiAgICBcbiAgICAvLyBFeGVjdXRhciBsaW1wZXphIGEgY2FkYSAyNCBob3Jhc1xuICAgIHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xlYW51cEV4cGlyZWRUb2tlbnMoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIG5hIGxpbXBlemEgYXV0b23DoXRpY2EgZGUgdG9rZW5zOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSwgQ0xFQU5VUF9JTlRFUlZBTCk7XG4gICAgXG4gICAgLy8gRXhlY3V0YXIgbGltcGV6YSBkZSB0b2tlbnMgdXNhZG9zIGEgY2FkYSAyNCBob3Jhc1xuICAgIHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xlYW51cE9sZFVzZWRUb2tlbnMoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvIG5hIGxpbXBlemEgZGUgdG9rZW5zIHVzYWRvczogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0sIENMRUFOVVBfSU5URVJWQUwpO1xuICB9XG4gIFxuXG5cbiAgLyoqXG4gICAqIE9idMOpbSBlc3RhdMOtc3RpY2FzIGRlIHRva2VucyBkZSByZWN1cGVyYcOnw6NvXG4gICAqIE1pZ3JhZG8gZG8gUGFzc3dvcmRSZWNvdmVyeVNlcnZpY2VcbiAgICogQHJldHVybnMgRXN0YXTDrXN0aWNhcyBkb3MgdG9rZW5zXG4gICAqL1xuICBhc3luYyBnZXRUb2tlblN0YXRzKCk6IFByb21pc2U8e1xuICAgIHRvdGFsOiBudW1iZXI7XG4gICAgYWN0aXZlOiBudW1iZXI7XG4gICAgZXhwaXJlZDogbnVtYmVyO1xuICAgIHVzZWQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgXG4gICAgY29uc3QgW3RvdGFsLCBhY3RpdmUsIGV4cGlyZWQsIHVzZWRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KCksXG4gICAgICB0aGlzLnBhc3N3b3JkUmVzZXRUb2tlblJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGlzX3VzZWQ6IGZhbHNlLFxuICAgICAgICAgIGV4cGlyZXNfYXQ6IExlc3NUaGFuKG5vdyksXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICAgIHRoaXMucGFzc3dvcmRSZXNldFRva2VuUmVwb3NpdG9yeS5jb3VudCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgZXhwaXJlc19hdDogTGVzc1RoYW4obm93KSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wYXNzd29yZFJlc2V0VG9rZW5SZXBvc2l0b3J5LmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpc191c2VkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgXSk7XG5cbiAgICByZXR1cm4geyB0b3RhbCwgYWN0aXZlLCBleHBpcmVkLCB1c2VkIH07XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=