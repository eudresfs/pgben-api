7745ab4d5d04f25d51b338f37f928ba2
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ComprovanteService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const comprovante_pagamento_entity_1 = require("../../../entities/comprovante-pagamento.entity");
/**
 * Serviço para gerenciamento de comprovantes de pagamento
 *
 * Implementa a lógica para upload, consulta e gerenciamento
 * dos documentos comprobatórios anexados aos pagamentos.
 *
 * @author Equipe PGBen
 */
let ComprovanteService = class ComprovanteService {
    comprovanteRepository;
    // Lista de tipos MIME permitidos para upload
    allowedMimeTypes = [
        'application/pdf',
        'image/jpeg',
        'image/jpg',
        'image/png'
    ];
    // Tamanho máximo permitido (5MB)
    maxFileSize = 5 * 1024 * 1024;
    constructor(comprovanteRepository) {
        this.comprovanteRepository = comprovanteRepository;
    }
    /**
     * Processa o upload de um novo comprovante de pagamento
     *
     * @param pagamentoId ID do pagamento relacionado
     * @param file Arquivo enviado
     * @param createDto Dados adicionais do comprovante
     * @param usuarioId ID do usuário que está realizando o upload
     * @returns Comprovante criado
     */
    async uploadComprovante(pagamentoId, file, createDto, usuarioId) {
        // Verificar se o pagamento existe
        // const pagamento = await this.pagamentoService.findOne(pagamentoId);
        // if (!pagamento) {
        //   throw new NotFoundException('Pagamento não encontrado');
        // }
        // Verificar se o pagamento tem status que permite anexar comprovantes
        // if (pagamento.status === StatusPagamentoEnum.CANCELADO) {
        //   throw new ConflictException(
        //     'Não é possível anexar comprovantes a um pagamento cancelado'
        //   );
        // }
        // Validar o arquivo
        this.validateFile(file);
        // Sanitizar o nome do arquivo
        const sanitizedFileName = this.sanitizeFileName(file.originalname);
        // Processar o upload do arquivo (usando o serviço de documentos)
        // const uploadResult = await this.documentoService.uploadDocumento({
        //   file: file.buffer,
        //   fileName: sanitizedFileName,
        //   mimeType: file.mimetype,
        //   categoria: 'comprovante_pagamento',
        //   metadados: {
        //     pagamentoId,
        //     tipoDocumento: createDto.tipoDocumento
        //   }
        // });
        // Criar registro do comprovante
        const comprovante = this.comprovanteRepository.create({
            pagamento_id: pagamentoId,
            tipo_documento: createDto.tipoDocumento,
            nome_arquivo: sanitizedFileName,
            caminho_arquivo: 'placeholder', // uploadResult.path,
            tamanho: file.size,
            mime_type: file.mimetype,
            data_upload: new Date(),
            uploaded_por: usuarioId
        });
        // Salvar o registro
        const result = await this.comprovanteRepository.save(comprovante);
        // Registrar operação no log de auditoria
        // await this.auditoriaService.registrarOperacao({
        //   tipoOperacao: 'UPLOAD_COMPROVANTE',
        //   usuarioId,
        //   entidadeId: result.id,
        //   tipoEntidade: 'COMPROVANTE_PAGAMENTO',
        //   dadosAnteriores: null,
        //   dadosNovos: {
        //     id: result.id,
        //     pagamentoId,
        //     tipoDocumento: createDto.tipoDocumento,
        //     nomeArquivo: sanitizedFileName,
        //     tamanho: file.size,
        //     mimeType: file.mimetype
        //   }
        // });
        return result;
    }
    /**
     * Busca um comprovante pelo ID
     *
     * @param id ID do comprovante
     * @returns Comprovante encontrado ou null
     */
    async findOne(id) {
        return this.comprovanteRepository.findOneBy({ id });
    }
    /**
     * Lista todos os comprovantes de um pagamento
     *
     * @param pagamentoId ID do pagamento
     * @returns Lista de comprovantes
     */
    async findAllByPagamento(pagamentoId) {
        return this.comprovanteRepository.find({
            where: { pagamento_id: pagamentoId },
            order: { data_upload: 'DESC' }
        });
    }
    /**
     * Obtém o conteúdo de um comprovante (baixa o arquivo)
     *
     * @param id ID do comprovante
     * @returns Buffer com o conteúdo do arquivo e metadados
     */
    async getComprovanteContent(id) {
        const comprovante = await this.findOne(id);
        if (!comprovante) {
            throw new common_1.NotFoundException('Comprovante não encontrado');
        }
        // Obter o arquivo do serviço de documentos
        // const file = await this.documentoService.getDocumento(comprovante.caminhoArquivo);
        return {
            buffer: Buffer.from(''), // file.content,
            fileName: comprovante.nome_arquivo,
            mimeType: comprovante.mime_type
        };
    }
    /**
     * Remove um comprovante
     *
     * @param id ID do comprovante
     * @param usuarioId ID do usuário que está removendo
     * @returns true se removido com sucesso
     */
    async removeComprovante(id, usuarioId) {
        const comprovante = await this.findOne(id);
        if (!comprovante) {
            throw new common_1.NotFoundException('Comprovante não encontrado');
        }
        // Verificar se o pagamento permite remoção de comprovantes
        // const pagamento = await this.pagamentoService.findOne(comprovante.pagamentoId);
        // if (pagamento.status === StatusPagamentoEnum.CONFIRMADO) {
        //   throw new ConflictException(
        //     'Não é possível remover comprovantes de um pagamento já confirmado'
        //   );
        // }
        // Salvar dados para auditoria
        const dadosAnteriores = { ...comprovante };
        // Remover o arquivo do sistema de armazenamento
        // await this.documentoService.removeDocumento(comprovante.caminhoArquivo);
        // Remover o registro do banco de dados
        await this.comprovanteRepository.remove(comprovante);
        // Registrar operação no log de auditoria
        // await this.auditoriaService.registrarOperacao({
        //   tipoOperacao: 'REMOCAO_COMPROVANTE',
        //   usuarioId,
        //   entidadeId: id,
        //   tipoEntidade: 'COMPROVANTE_PAGAMENTO',
        //   dadosAnteriores,
        //   dadosNovos: null
        // });
        return true;
    }
    /**
     * Verifica se um pagamento tem pelo menos um comprovante
     *
     * @param pagamentoId ID do pagamento
     * @returns true se o pagamento tem pelo menos um comprovante
     */
    async hasComprovantes(pagamentoId) {
        const count = await this.comprovanteRepository.count({
            where: { pagamento_id: pagamentoId }
        });
        return count > 0;
    }
    /**
     * Valida um arquivo enviado
     *
     * @param file Arquivo a ser validado
     * @throws BadRequestException se o arquivo não atender aos requisitos
     */
    validateFile(file) {
        // Verificar se o arquivo existe
        if (!file) {
            throw new common_1.BadRequestException('Nenhum arquivo foi enviado');
        }
        // Verificar o tamanho do arquivo
        if (file.size > this.maxFileSize) {
            throw new common_1.BadRequestException(`Tamanho máximo permitido: ${this.maxFileSize / (1024 * 1024)}MB`);
        }
        // Verificar o tipo MIME
        if (!this.allowedMimeTypes.includes(file.mimetype)) {
            throw new common_1.BadRequestException(`Tipo de arquivo não permitido. Tipos permitidos: ${this.allowedMimeTypes.join(', ')}`);
        }
    }
    /**
     * Sanitiza o nome de um arquivo para evitar riscos de segurança
     *
     * @param fileName Nome original do arquivo
     * @returns Nome sanitizado
     */
    sanitizeFileName(fileName) {
        // Remover caracteres potencialmente perigosos
        let sanitized = fileName
            .replace(/[/\\?%*:|"<>]/g, '_') // Remover caracteres inválidos em nomes de arquivo
            .replace(/\.\./g, '_'); // Evitar directory traversal
        // Limitar o tamanho do nome
        if (sanitized.length > 100) {
            const extension = sanitized.slice(sanitized.lastIndexOf('.'));
            sanitized = sanitized.slice(0, 100 - extension.length) + extension;
        }
        return sanitized;
    }
};
exports.ComprovanteService = ComprovanteService;
exports.ComprovanteService = ComprovanteService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(comprovante_pagamento_entity_1.ComprovantePagamento)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object])
], ComprovanteService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcc2VydmljZXNcXGNvbXByb3ZhbnRlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1RztBQUN2Ryw2Q0FBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLGlHQUFzRjtBQUl0Rjs7Ozs7OztHQU9HO0FBRUksSUFBTSxrQkFBa0IsR0FBeEIsTUFBTSxrQkFBa0I7SUFjVjtJQWJuQiw2Q0FBNkM7SUFDNUIsZ0JBQWdCLEdBQUc7UUFDbEMsaUJBQWlCO1FBQ2pCLFlBQVk7UUFDWixXQUFXO1FBQ1gsV0FBVztLQUNaLENBQUM7SUFFRixpQ0FBaUM7SUFDaEIsV0FBVyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRS9DLFlBRW1CLHFCQUF1RDtRQUF2RCwwQkFBcUIsR0FBckIscUJBQXFCLENBQWtDO0lBS3ZFLENBQUM7SUFFSjs7Ozs7Ozs7T0FRRztJQUNILEtBQUssQ0FBQyxpQkFBaUIsQ0FDckIsV0FBbUIsRUFDbkIsSUFBUyxFQUNULFNBQStCLEVBQy9CLFNBQWlCO1FBRWpCLGtDQUFrQztRQUNsQyxzRUFBc0U7UUFFdEUsb0JBQW9CO1FBQ3BCLDZEQUE2RDtRQUM3RCxJQUFJO1FBRUosc0VBQXNFO1FBQ3RFLDREQUE0RDtRQUM1RCxpQ0FBaUM7UUFDakMsb0VBQW9FO1FBQ3BFLE9BQU87UUFDUCxJQUFJO1FBRUosb0JBQW9CO1FBQ3BCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEIsOEJBQThCO1FBQzlCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUVuRSxpRUFBaUU7UUFDakUscUVBQXFFO1FBQ3JFLHVCQUF1QjtRQUN2QixpQ0FBaUM7UUFDakMsNkJBQTZCO1FB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LGdCQUFnQixDQUFDLFFBQWdCO1FBQ3ZDLDhDQUE4QztRQUM5QyxJQUFJLFNBQVMsR0FBRyxRQUFRO2FBQ3JCLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsQ0FBQyxtREFBbUQ7YUFDbEYsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLDZCQUE2QjtRQUV2RCw0QkFBNEI7UUFDNUIsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1lBQzNCLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzlELFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQztRQUNyRSxDQUFDO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGLENBQUE7QUFuUVksZ0RBQWtCOzZCQUFsQixrQkFBa0I7SUFEOUIsSUFBQSxtQkFBVSxHQUFFO0lBY1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLG1EQUFvQixDQUFDLENBQUE7eURBQ0Msb0JBQVUsb0JBQVYsb0JBQVU7R0FkekMsa0JBQWtCLENBbVE5QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xccGFnYW1lbnRvXFxzZXJ2aWNlc1xcY29tcHJvdmFudGUuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYWRSZXF1ZXN0RXhjZXB0aW9uLCBDb25mbGljdEV4Y2VwdGlvbiwgSW5qZWN0YWJsZSwgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3RSZXBvc2l0b3J5IH0gZnJvbSAnQG5lc3Rqcy90eXBlb3JtJztcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IENvbXByb3ZhbnRlUGFnYW1lbnRvIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvY29tcHJvdmFudGUtcGFnYW1lbnRvLmVudGl0eSc7XG5pbXBvcnQgeyBDb21wcm92YW50ZVVwbG9hZER0byB9IGZyb20gJy4uL2R0b3MvY29tcHJvdmFudGUtdXBsb2FkLmR0byc7XG5pbXBvcnQgeyBTdGF0dXNQYWdhbWVudG9FbnVtIH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvc3RhdHVzLXBhZ2FtZW50by5lbnVtJztcblxuLyoqXG4gKiBTZXJ2acOnbyBwYXJhIGdlcmVuY2lhbWVudG8gZGUgY29tcHJvdmFudGVzIGRlIHBhZ2FtZW50b1xuICogXG4gKiBJbXBsZW1lbnRhIGEgbMOzZ2ljYSBwYXJhIHVwbG9hZCwgY29uc3VsdGEgZSBnZXJlbmNpYW1lbnRvXG4gKiBkb3MgZG9jdW1lbnRvcyBjb21wcm9iYXTDs3Jpb3MgYW5leGFkb3MgYW9zIHBhZ2FtZW50b3MuXG4gKiBcbiAqIEBhdXRob3IgRXF1aXBlIFBHQmVuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDb21wcm92YW50ZVNlcnZpY2Uge1xuICAvLyBMaXN0YSBkZSB0aXBvcyBNSU1FIHBlcm1pdGlkb3MgcGFyYSB1cGxvYWRcbiAgcHJpdmF0ZSByZWFkb25seSBhbGxvd2VkTWltZVR5cGVzID0gW1xuICAgICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICdpbWFnZS9qcGVnJyxcbiAgICAnaW1hZ2UvanBnJyxcbiAgICAnaW1hZ2UvcG5nJ1xuICBdO1xuXG4gIC8vIFRhbWFuaG8gbcOheGltbyBwZXJtaXRpZG8gKDVNQilcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhGaWxlU2l6ZSA9IDUgKiAxMDI0ICogMTAyNDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShDb21wcm92YW50ZVBhZ2FtZW50bylcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbXByb3ZhbnRlUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDb21wcm92YW50ZVBhZ2FtZW50bz4sXG4gICAgLy8gT3V0cm9zIHNlcnZpw6dvcyBuZWNlc3PDoXJpb3Mgc2Vyw6NvIGluamV0YWRvcyBhcXVpXG4gICAgLy8gcHJpdmF0ZSByZWFkb25seSBwYWdhbWVudG9TZXJ2aWNlOiBQYWdhbWVudG9TZXJ2aWNlLFxuICAgIC8vIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnRvU2VydmljZTogRG9jdW1lbnRvU2VydmljZSxcbiAgICAvLyBwcml2YXRlIHJlYWRvbmx5IGF1ZGl0b3JpYVNlcnZpY2U6IEF1ZGl0b3JpYVNlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogUHJvY2Vzc2EgbyB1cGxvYWQgZGUgdW0gbm92byBjb21wcm92YW50ZSBkZSBwYWdhbWVudG9cbiAgICogXG4gICAqIEBwYXJhbSBwYWdhbWVudG9JZCBJRCBkbyBwYWdhbWVudG8gcmVsYWNpb25hZG9cbiAgICogQHBhcmFtIGZpbGUgQXJxdWl2byBlbnZpYWRvXG4gICAqIEBwYXJhbSBjcmVhdGVEdG8gRGFkb3MgYWRpY2lvbmFpcyBkbyBjb21wcm92YW50ZVxuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIG8gdXBsb2FkXG4gICAqIEByZXR1cm5zIENvbXByb3ZhbnRlIGNyaWFkb1xuICAgKi9cbiAgYXN5bmMgdXBsb2FkQ29tcHJvdmFudGUoXG4gICAgcGFnYW1lbnRvSWQ6IHN0cmluZyxcbiAgICBmaWxlOiBhbnksXG4gICAgY3JlYXRlRHRvOiBDb21wcm92YW50ZVVwbG9hZER0byxcbiAgICB1c3VhcmlvSWQ6IHN0cmluZ1xuICApOiBQcm9taXNlPENvbXByb3ZhbnRlUGFnYW1lbnRvPiB7XG4gICAgLy8gVmVyaWZpY2FyIHNlIG8gcGFnYW1lbnRvIGV4aXN0ZVxuICAgIC8vIGNvbnN0IHBhZ2FtZW50byA9IGF3YWl0IHRoaXMucGFnYW1lbnRvU2VydmljZS5maW5kT25lKHBhZ2FtZW50b0lkKTtcbiAgICBcbiAgICAvLyBpZiAoIXBhZ2FtZW50bykge1xuICAgIC8vICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdQYWdhbWVudG8gbsOjbyBlbmNvbnRyYWRvJyk7XG4gICAgLy8gfVxuICAgIFxuICAgIC8vIFZlcmlmaWNhciBzZSBvIHBhZ2FtZW50byB0ZW0gc3RhdHVzIHF1ZSBwZXJtaXRlIGFuZXhhciBjb21wcm92YW50ZXNcbiAgICAvLyBpZiAocGFnYW1lbnRvLnN0YXR1cyA9PT0gU3RhdHVzUGFnYW1lbnRvRW51bS5DQU5DRUxBRE8pIHtcbiAgICAvLyAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbihcbiAgICAvLyAgICAgJ07Do28gw6kgcG9zc8OtdmVsIGFuZXhhciBjb21wcm92YW50ZXMgYSB1bSBwYWdhbWVudG8gY2FuY2VsYWRvJ1xuICAgIC8vICAgKTtcbiAgICAvLyB9XG5cbiAgICAvLyBWYWxpZGFyIG8gYXJxdWl2b1xuICAgIHRoaXMudmFsaWRhdGVGaWxlKGZpbGUpO1xuXG4gICAgLy8gU2FuaXRpemFyIG8gbm9tZSBkbyBhcnF1aXZvXG4gICAgY29uc3Qgc2FuaXRpemVkRmlsZU5hbWUgPSB0aGlzLnNhbml0aXplRmlsZU5hbWUoZmlsZS5vcmlnaW5hbG5hbWUpO1xuXG4gICAgLy8gUHJvY2Vzc2FyIG8gdXBsb2FkIGRvIGFycXVpdm8gKHVzYW5kbyBvIHNlcnZpw6dvIGRlIGRvY3VtZW50b3MpXG4gICAgLy8gY29uc3QgdXBsb2FkUmVzdWx0ID0gYXdhaXQgdGhpcy5kb2N1bWVudG9TZXJ2aWNlLnVwbG9hZERvY3VtZW50byh7XG4gICAgLy8gICBmaWxlOiBmaWxlLmJ1ZmZlcixcbiAgICAvLyAgIGZpbGVOYW1lOiBzYW5pdGl6ZWRGaWxlTmFtZSxcbiAgICAvLyAgIG1pbWVUeXBlOiBmaWxlLm1pbWV0eXBlLFxuICAgIC8vICAgY2F0ZWdvcmlhOiAnY29tcHJvdmFudGVfcGFnYW1lbnRvJyxcbiAgICAvLyAgIG1ldGFkYWRvczoge1xuICAgIC8vICAgICBwYWdhbWVudG9JZCxcbiAgICAvLyAgICAgdGlwb0RvY3VtZW50bzogY3JlYXRlRHRvLnRpcG9Eb2N1bWVudG9cbiAgICAvLyAgIH1cbiAgICAvLyB9KTtcblxuICAgIC8vIENyaWFyIHJlZ2lzdHJvIGRvIGNvbXByb3ZhbnRlXG4gICAgY29uc3QgY29tcHJvdmFudGUgPSB0aGlzLmNvbXByb3ZhbnRlUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgcGFnYW1lbnRvX2lkOiBwYWdhbWVudG9JZCxcbiAgICAgIHRpcG9fZG9jdW1lbnRvOiBjcmVhdGVEdG8udGlwb0RvY3VtZW50byxcbiAgICAgIG5vbWVfYXJxdWl2bzogc2FuaXRpemVkRmlsZU5hbWUsXG4gICAgICBjYW1pbmhvX2FycXVpdm86ICdwbGFjZWhvbGRlcicsIC8vIHVwbG9hZFJlc3VsdC5wYXRoLFxuICAgICAgdGFtYW5obzogZmlsZS5zaXplLFxuICAgICAgbWltZV90eXBlOiBmaWxlLm1pbWV0eXBlLFxuICAgICAgZGF0YV91cGxvYWQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGxvYWRlZF9wb3I6IHVzdWFyaW9JZFxuICAgIH0pO1xuXG4gICAgLy8gU2FsdmFyIG8gcmVnaXN0cm9cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbXByb3ZhbnRlUmVwb3NpdG9yeS5zYXZlKGNvbXByb3ZhbnRlKTtcblxuICAgIC8vIFJlZ2lzdHJhciBvcGVyYcOnw6NvIG5vIGxvZyBkZSBhdWRpdG9yaWFcbiAgICAvLyBhd2FpdCB0aGlzLmF1ZGl0b3JpYVNlcnZpY2UucmVnaXN0cmFyT3BlcmFjYW8oe1xuICAgIC8vICAgdGlwb09wZXJhY2FvOiAnVVBMT0FEX0NPTVBST1ZBTlRFJyxcbiAgICAvLyAgIHVzdWFyaW9JZCxcbiAgICAvLyAgIGVudGlkYWRlSWQ6IHJlc3VsdC5pZCxcbiAgICAvLyAgIHRpcG9FbnRpZGFkZTogJ0NPTVBST1ZBTlRFX1BBR0FNRU5UTycsXG4gICAgLy8gICBkYWRvc0FudGVyaW9yZXM6IG51bGwsXG4gICAgLy8gICBkYWRvc05vdm9zOiB7XG4gICAgLy8gICAgIGlkOiByZXN1bHQuaWQsXG4gICAgLy8gICAgIHBhZ2FtZW50b0lkLFxuICAgIC8vICAgICB0aXBvRG9jdW1lbnRvOiBjcmVhdGVEdG8udGlwb0RvY3VtZW50byxcbiAgICAvLyAgICAgbm9tZUFycXVpdm86IHNhbml0aXplZEZpbGVOYW1lLFxuICAgIC8vICAgICB0YW1hbmhvOiBmaWxlLnNpemUsXG4gICAgLy8gICAgIG1pbWVUeXBlOiBmaWxlLm1pbWV0eXBlXG4gICAgLy8gICB9XG4gICAgLy8gfSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHVtIGNvbXByb3ZhbnRlIHBlbG8gSURcbiAgICogXG4gICAqIEBwYXJhbSBpZCBJRCBkbyBjb21wcm92YW50ZVxuICAgKiBAcmV0dXJucyBDb21wcm92YW50ZSBlbmNvbnRyYWRvIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGZpbmRPbmUoaWQ6IHN0cmluZyk6IFByb21pc2U8Q29tcHJvdmFudGVQYWdhbWVudG8gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuY29tcHJvdmFudGVSZXBvc2l0b3J5LmZpbmRPbmVCeSh7IGlkIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RhIHRvZG9zIG9zIGNvbXByb3ZhbnRlcyBkZSB1bSBwYWdhbWVudG9cbiAgICogXG4gICAqIEBwYXJhbSBwYWdhbWVudG9JZCBJRCBkbyBwYWdhbWVudG9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgY29tcHJvdmFudGVzXG4gICAqL1xuICBhc3luYyBmaW5kQWxsQnlQYWdhbWVudG8ocGFnYW1lbnRvSWQ6IHN0cmluZyk6IFByb21pc2U8Q29tcHJvdmFudGVQYWdhbWVudG9bXT4ge1xuICAgIHJldHVybiB0aGlzLmNvbXByb3ZhbnRlUmVwb3NpdG9yeS5maW5kKHtcbiAgICAgIHdoZXJlOiB7IHBhZ2FtZW50b19pZDogcGFnYW1lbnRvSWQgfSxcbiAgICAgIG9yZGVyOiB7IGRhdGFfdXBsb2FkOiAnREVTQycgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBvIGNvbnRlw7pkbyBkZSB1bSBjb21wcm92YW50ZSAoYmFpeGEgbyBhcnF1aXZvKVxuICAgKiBcbiAgICogQHBhcmFtIGlkIElEIGRvIGNvbXByb3ZhbnRlXG4gICAqIEByZXR1cm5zIEJ1ZmZlciBjb20gbyBjb250ZcO6ZG8gZG8gYXJxdWl2byBlIG1ldGFkYWRvc1xuICAgKi9cbiAgYXN5bmMgZ2V0Q29tcHJvdmFudGVDb250ZW50KGlkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICBidWZmZXI6IEJ1ZmZlcjtcbiAgICBmaWxlTmFtZTogc3RyaW5nO1xuICAgIG1pbWVUeXBlOiBzdHJpbmc7XG4gIH0+IHtcbiAgICBjb25zdCBjb21wcm92YW50ZSA9IGF3YWl0IHRoaXMuZmluZE9uZShpZCk7XG4gICAgXG4gICAgaWYgKCFjb21wcm92YW50ZSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDb21wcm92YW50ZSBuw6NvIGVuY29udHJhZG8nKTtcbiAgICB9XG5cbiAgICAvLyBPYnRlciBvIGFycXVpdm8gZG8gc2VydmnDp28gZGUgZG9jdW1lbnRvc1xuICAgIC8vIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmRvY3VtZW50b1NlcnZpY2UuZ2V0RG9jdW1lbnRvKGNvbXByb3ZhbnRlLmNhbWluaG9BcnF1aXZvKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgYnVmZmVyOiBCdWZmZXIuZnJvbSgnJyksIC8vIGZpbGUuY29udGVudCxcbiAgICAgIGZpbGVOYW1lOiBjb21wcm92YW50ZS5ub21lX2FycXVpdm8sXG4gICAgICBtaW1lVHlwZTogY29tcHJvdmFudGUubWltZV90eXBlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdW0gY29tcHJvdmFudGVcbiAgICogXG4gICAqIEBwYXJhbSBpZCBJRCBkbyBjb21wcm92YW50ZVxuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSByZW1vdmVuZG9cbiAgICogQHJldHVybnMgdHJ1ZSBzZSByZW1vdmlkbyBjb20gc3VjZXNzb1xuICAgKi9cbiAgYXN5bmMgcmVtb3ZlQ29tcHJvdmFudGUoaWQ6IHN0cmluZywgdXN1YXJpb0lkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBjb21wcm92YW50ZSA9IGF3YWl0IHRoaXMuZmluZE9uZShpZCk7XG4gICAgXG4gICAgaWYgKCFjb21wcm92YW50ZSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDb21wcm92YW50ZSBuw6NvIGVuY29udHJhZG8nKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyBwYWdhbWVudG8gcGVybWl0ZSByZW1vw6fDo28gZGUgY29tcHJvdmFudGVzXG4gICAgLy8gY29uc3QgcGFnYW1lbnRvID0gYXdhaXQgdGhpcy5wYWdhbWVudG9TZXJ2aWNlLmZpbmRPbmUoY29tcHJvdmFudGUucGFnYW1lbnRvSWQpO1xuICAgIFxuICAgIC8vIGlmIChwYWdhbWVudG8uc3RhdHVzID09PSBTdGF0dXNQYWdhbWVudG9FbnVtLkNPTkZJUk1BRE8pIHtcbiAgICAvLyAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbihcbiAgICAvLyAgICAgJ07Do28gw6kgcG9zc8OtdmVsIHJlbW92ZXIgY29tcHJvdmFudGVzIGRlIHVtIHBhZ2FtZW50byBqw6EgY29uZmlybWFkbydcbiAgICAvLyAgICk7XG4gICAgLy8gfVxuXG4gICAgLy8gU2FsdmFyIGRhZG9zIHBhcmEgYXVkaXRvcmlhXG4gICAgY29uc3QgZGFkb3NBbnRlcmlvcmVzID0geyAuLi5jb21wcm92YW50ZSB9O1xuXG4gICAgLy8gUmVtb3ZlciBvIGFycXVpdm8gZG8gc2lzdGVtYSBkZSBhcm1hemVuYW1lbnRvXG4gICAgLy8gYXdhaXQgdGhpcy5kb2N1bWVudG9TZXJ2aWNlLnJlbW92ZURvY3VtZW50byhjb21wcm92YW50ZS5jYW1pbmhvQXJxdWl2byk7XG5cbiAgICAvLyBSZW1vdmVyIG8gcmVnaXN0cm8gZG8gYmFuY28gZGUgZGFkb3NcbiAgICBhd2FpdCB0aGlzLmNvbXByb3ZhbnRlUmVwb3NpdG9yeS5yZW1vdmUoY29tcHJvdmFudGUpO1xuXG4gICAgLy8gUmVnaXN0cmFyIG9wZXJhw6fDo28gbm8gbG9nIGRlIGF1ZGl0b3JpYVxuICAgIC8vIGF3YWl0IHRoaXMuYXVkaXRvcmlhU2VydmljZS5yZWdpc3RyYXJPcGVyYWNhbyh7XG4gICAgLy8gICB0aXBvT3BlcmFjYW86ICdSRU1PQ0FPX0NPTVBST1ZBTlRFJyxcbiAgICAvLyAgIHVzdWFyaW9JZCxcbiAgICAvLyAgIGVudGlkYWRlSWQ6IGlkLFxuICAgIC8vICAgdGlwb0VudGlkYWRlOiAnQ09NUFJPVkFOVEVfUEFHQU1FTlRPJyxcbiAgICAvLyAgIGRhZG9zQW50ZXJpb3JlcyxcbiAgICAvLyAgIGRhZG9zTm92b3M6IG51bGxcbiAgICAvLyB9KTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIHVtIHBhZ2FtZW50byB0ZW0gcGVsbyBtZW5vcyB1bSBjb21wcm92YW50ZVxuICAgKiBcbiAgICogQHBhcmFtIHBhZ2FtZW50b0lkIElEIGRvIHBhZ2FtZW50b1xuICAgKiBAcmV0dXJucyB0cnVlIHNlIG8gcGFnYW1lbnRvIHRlbSBwZWxvIG1lbm9zIHVtIGNvbXByb3ZhbnRlXG4gICAqL1xuICBhc3luYyBoYXNDb21wcm92YW50ZXMocGFnYW1lbnRvSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGNvdW50ID0gYXdhaXQgdGhpcy5jb21wcm92YW50ZVJlcG9zaXRvcnkuY291bnQoe1xuICAgICAgd2hlcmU6IHsgcGFnYW1lbnRvX2lkOiBwYWdhbWVudG9JZCB9XG4gICAgfSk7XG4gICAgXG4gICAgcmV0dXJuIGNvdW50ID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgdW0gYXJxdWl2byBlbnZpYWRvXG4gICAqIFxuICAgKiBAcGFyYW0gZmlsZSBBcnF1aXZvIGEgc2VyIHZhbGlkYWRvXG4gICAqIEB0aHJvd3MgQmFkUmVxdWVzdEV4Y2VwdGlvbiBzZSBvIGFycXVpdm8gbsOjbyBhdGVuZGVyIGFvcyByZXF1aXNpdG9zXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRmlsZShmaWxlOiBhbnkpOiB2b2lkIHtcbiAgICAvLyBWZXJpZmljYXIgc2UgbyBhcnF1aXZvIGV4aXN0ZVxuICAgIGlmICghZmlsZSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ05lbmh1bSBhcnF1aXZvIGZvaSBlbnZpYWRvJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIG8gdGFtYW5obyBkbyBhcnF1aXZvXG4gICAgaWYgKGZpbGUuc2l6ZSA+IHRoaXMubWF4RmlsZVNpemUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgVGFtYW5obyBtw6F4aW1vIHBlcm1pdGlkbzogJHt0aGlzLm1heEZpbGVTaXplIC8gKDEwMjQgKiAxMDI0KX1NQmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIG8gdGlwbyBNSU1FXG4gICAgaWYgKCF0aGlzLmFsbG93ZWRNaW1lVHlwZXMuaW5jbHVkZXMoZmlsZS5taW1ldHlwZSkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgVGlwbyBkZSBhcnF1aXZvIG7Do28gcGVybWl0aWRvLiBUaXBvcyBwZXJtaXRpZG9zOiAke3RoaXMuYWxsb3dlZE1pbWVUeXBlcy5qb2luKCcsICcpfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNhbml0aXphIG8gbm9tZSBkZSB1bSBhcnF1aXZvIHBhcmEgZXZpdGFyIHJpc2NvcyBkZSBzZWd1cmFuw6dhXG4gICAqIFxuICAgKiBAcGFyYW0gZmlsZU5hbWUgTm9tZSBvcmlnaW5hbCBkbyBhcnF1aXZvXG4gICAqIEByZXR1cm5zIE5vbWUgc2FuaXRpemFkb1xuICAgKi9cbiAgcHJpdmF0ZSBzYW5pdGl6ZUZpbGVOYW1lKGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIFJlbW92ZXIgY2FyYWN0ZXJlcyBwb3RlbmNpYWxtZW50ZSBwZXJpZ29zb3NcbiAgICBsZXQgc2FuaXRpemVkID0gZmlsZU5hbWVcbiAgICAgIC5yZXBsYWNlKC9bL1xcXFw/JSo6fFwiPD5dL2csICdfJykgLy8gUmVtb3ZlciBjYXJhY3RlcmVzIGludsOhbGlkb3MgZW0gbm9tZXMgZGUgYXJxdWl2b1xuICAgICAgLnJlcGxhY2UoL1xcLlxcLi9nLCAnXycpOyAvLyBFdml0YXIgZGlyZWN0b3J5IHRyYXZlcnNhbFxuICAgIFxuICAgIC8vIExpbWl0YXIgbyB0YW1hbmhvIGRvIG5vbWVcbiAgICBpZiAoc2FuaXRpemVkLmxlbmd0aCA+IDEwMCkge1xuICAgICAgY29uc3QgZXh0ZW5zaW9uID0gc2FuaXRpemVkLnNsaWNlKHNhbml0aXplZC5sYXN0SW5kZXhPZignLicpKTtcbiAgICAgIHNhbml0aXplZCA9IHNhbml0aXplZC5zbGljZSgwLCAxMDAgLSBleHRlbnNpb24ubGVuZ3RoKSArIGV4dGVuc2lvbjtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHNhbml0aXplZDtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9