78315ef6686d461abb491958bd95d61d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const logger_service_1 = require("../../shared/logger/logger.service");
const request_context_dto_1 = require("../../shared/request-context/request-context.dto");
const auth_login_input_dto_1 = require("../dtos/auth-login-input.dto");
const auth_register_input_dto_1 = require("../dtos/auth-register-input.dto");
const auth_service_1 = require("../services/auth.service");
const auth_controller_1 = require("./auth.controller");
describe('AuthController', () => {
    let moduleRef;
    let authController;
    const mockedAuthService = {
        register: jest.fn(),
        login: jest.fn(),
        refreshToken: jest.fn(),
    };
    const mockedLogger = { setContext: jest.fn(), log: jest.fn() };
    beforeEach(async () => {
        moduleRef = await testing_1.Test.createTestingModule({
            controllers: [auth_controller_1.AuthController],
            providers: [
                { provide: auth_service_1.AuthService, useValue: mockedAuthService },
                { provide: logger_service_1.AppLogger, useValue: mockedLogger },
            ],
        }).compile();
        authController = moduleRef.get(auth_controller_1.AuthController);
    });
    it('should be defined', () => {
        expect(authController).toBeDefined();
    });
    const ctx = new request_context_dto_1.RequestContext();
    describe('registerLocal', () => {
        it('should register new user', async () => {
            const registerInputDto = new auth_register_input_dto_1.RegisterInput();
            registerInputDto.name = 'John Doe';
            registerInputDto.username = 'john@example.com';
            registerInputDto.password = '123123';
            jest
                .spyOn(mockedAuthService, 'register')
                .mockImplementation(async () => null);
            expect(await authController.registerLocal(ctx, registerInputDto)).toEqual({
                data: null,
                meta: {},
            });
        });
    });
    describe('login', () => {
        it('should login user', async () => {
            const loginInputDto = new auth_login_input_dto_1.LoginInput();
            loginInputDto.username = 'john@example.com';
            loginInputDto.password = '123123';
            jest.spyOn(mockedAuthService, 'login').mockImplementation(() => null);
            expect(await authController.login(ctx, loginInputDto)).toEqual({
                data: null,
                meta: {},
            });
        });
    });
    describe('refreshToken', () => {
        let refreshTokenInputDto;
        let authToken;
        beforeEach(() => {
            refreshTokenInputDto = {
                refreshToken: 'refresh_token',
            };
            authToken = {
                accessToken: 'new_access_token',
                refreshToken: 'new_refresh_token',
            };
            jest
                .spyOn(mockedAuthService, 'refreshToken')
                .mockImplementation(async () => authToken);
        });
        it('should generate refresh token', async () => {
            const response = await authController.refreshToken(ctx, refreshTokenInputDto);
            expect(mockedAuthService.refreshToken).toBeCalledWith(ctx);
            expect(response.data).toEqual(authToken);
        });
        afterEach(() => {
            jest.resetAllMocks();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXGNvbnRyb2xsZXJzXFxhdXRoLmNvbnRyb2xsZXIuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUV0RCx1RUFBK0Q7QUFDL0QsMEZBQWtGO0FBQ2xGLHVFQUEwRDtBQUUxRCw2RUFBZ0U7QUFFaEUsMkRBQXVEO0FBQ3ZELHVEQUFtRDtBQUVuRCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksU0FBd0IsQ0FBQztJQUM3QixJQUFJLGNBQThCLENBQUM7SUFFbkMsTUFBTSxpQkFBaUIsR0FBRztRQUN4QixRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNuQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUN4QixDQUFDO0lBRUYsTUFBTSxZQUFZLEdBQUcsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztJQUUvRCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsU0FBUyxHQUFHLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQ3pDLFdBQVcsRUFBRSxDQUFDLGdDQUFjLENBQUM7WUFDN0IsU0FBUyxFQUFFO2dCQUNULEVBQUUsT0FBTyxFQUFFLDBCQUFXLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFO2dCQUNyRCxFQUFFLE9BQU8sRUFBRSwwQkFBUyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUU7YUFDL0M7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixjQUFjLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBaUIsZ0NBQWMsQ0FBQyxDQUFDO0lBQ2pFLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFB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LENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxhdXRoXFxjb250cm9sbGVyc1xcYXV0aC5jb250cm9sbGVyLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5cbmltcG9ydCB7IEFwcExvZ2dlciB9IGZyb20gJy4uLy4uL3NoYXJlZC9sb2dnZXIvbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVxdWVzdENvbnRleHQgfSBmcm9tICcuLi8uLi9zaGFyZWQvcmVxdWVzdC1jb250ZXh0L3JlcXVlc3QtY29udGV4dC5kdG8nO1xuaW1wb3J0IHsgTG9naW5JbnB1dCB9IGZyb20gJy4uL2R0b3MvYXV0aC1sb2dpbi1pbnB1dC5kdG8nO1xuaW1wb3J0IHsgUmVmcmVzaFRva2VuSW5wdXQgfSBmcm9tICcuLi9kdG9zL2F1dGgtcmVmcmVzaC10b2tlbi1pbnB1dC5kdG8nO1xuaW1wb3J0IHsgUmVnaXN0ZXJJbnB1dCB9IGZyb20gJy4uL2R0b3MvYXV0aC1yZWdpc3Rlci1pbnB1dC5kdG8nO1xuaW1wb3J0IHsgQXV0aFRva2VuT3V0cHV0IH0gZnJvbSAnLi4vZHRvcy9hdXRoLXRva2VuLW91dHB1dC5kdG8nO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXV0aENvbnRyb2xsZXIgfSBmcm9tICcuL2F1dGguY29udHJvbGxlcic7XG5cbmRlc2NyaWJlKCdBdXRoQ29udHJvbGxlcicsICgpID0+IHtcbiAgbGV0IG1vZHVsZVJlZjogVGVzdGluZ01vZHVsZTtcbiAgbGV0IGF1dGhDb250cm9sbGVyOiBBdXRoQ29udHJvbGxlcjtcblxuICBjb25zdCBtb2NrZWRBdXRoU2VydmljZSA9IHtcbiAgICByZWdpc3RlcjogamVzdC5mbigpLFxuICAgIGxvZ2luOiBqZXN0LmZuKCksXG4gICAgcmVmcmVzaFRva2VuOiBqZXN0LmZuKCksXG4gIH07XG5cbiAgY29uc3QgbW9ja2VkTG9nZ2VyID0geyBzZXRDb250ZXh0OiBqZXN0LmZuKCksIGxvZzogamVzdC5mbigpIH07XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgbW9kdWxlUmVmID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGNvbnRyb2xsZXJzOiBbQXV0aENvbnRyb2xsZXJdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHsgcHJvdmlkZTogQXV0aFNlcnZpY2UsIHVzZVZhbHVlOiBtb2NrZWRBdXRoU2VydmljZSB9LFxuICAgICAgICB7IHByb3ZpZGU6IEFwcExvZ2dlciwgdXNlVmFsdWU6IG1vY2tlZExvZ2dlciB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBhdXRoQ29udHJvbGxlciA9IG1vZHVsZVJlZi5nZXQ8QXV0aENvbnRyb2xsZXI+KEF1dGhDb250cm9sbGVyKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChhdXRoQ29udHJvbGxlcikudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgY29uc3QgY3R4ID0gbmV3IFJlcXVlc3RDb250ZXh0KCk7XG5cbiAgZGVzY3JpYmUoJ3JlZ2lzdGVyTG9jYWwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZWdpc3RlciBuZXcgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlZ2lzdGVySW5wdXREdG8gPSBuZXcgUmVnaXN0ZXJJbnB1dCgpO1xuICAgICAgcmVnaXN0ZXJJbnB1dER0by5uYW1lID0gJ0pvaG4gRG9lJztcbiAgICAgIHJlZ2lzdGVySW5wdXREdG8udXNlcm5hbWUgPSAnam9obkBleGFtcGxlLmNvbSc7XG4gICAgICByZWdpc3RlcklucHV0RHRvLnBhc3N3b3JkID0gJzEyMzEyMyc7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKG1vY2tlZEF1dGhTZXJ2aWNlLCAncmVnaXN0ZXInKVxuICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IG51bGwpO1xuXG4gICAgICBleHBlY3QoYXdhaXQgYXV0aENvbnRyb2xsZXIucmVnaXN0ZXJMb2NhbChjdHgsIHJlZ2lzdGVySW5wdXREdG8pKS50b0VxdWFsKFxuICAgICAgICB7XG4gICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICBtZXRhOiB7fSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsb2dpbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGxvZ2luIHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dpbklucHV0RHRvID0gbmV3IExvZ2luSW5wdXQoKTtcbiAgICAgIGxvZ2luSW5wdXREdG8udXNlcm5hbWUgPSAnam9obkBleGFtcGxlLmNvbSc7XG4gICAgICBsb2dpbklucHV0RHRvLnBhc3N3b3JkID0gJzEyMzEyMyc7XG5cbiAgICAgIGplc3Quc3B5T24obW9ja2VkQXV0aFNlcnZpY2UsICdsb2dpbicpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBudWxsKTtcblxuICAgICAgZXhwZWN0KGF3YWl0IGF1dGhDb250cm9sbGVyLmxvZ2luKGN0eCwgbG9naW5JbnB1dER0bykpLnRvRXF1YWwoe1xuICAgICAgICBkYXRhOiBudWxsLFxuICAgICAgICBtZXRhOiB7fSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVmcmVzaFRva2VuJywgKCkgPT4ge1xuICAgIGxldCByZWZyZXNoVG9rZW5JbnB1dER0bzogUmVmcmVzaFRva2VuSW5wdXQ7XG4gICAgbGV0IGF1dGhUb2tlbjogQXV0aFRva2VuT3V0cHV0O1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICByZWZyZXNoVG9rZW5JbnB1dER0byA9IHtcbiAgICAgICAgcmVmcmVzaFRva2VuOiAncmVmcmVzaF90b2tlbicsXG4gICAgICB9O1xuICAgICAgYXV0aFRva2VuID0ge1xuICAgICAgICBhY2Nlc3NUb2tlbjogJ25ld19hY2Nlc3NfdG9rZW4nLFxuICAgICAgICByZWZyZXNoVG9rZW46ICduZXdfcmVmcmVzaF90b2tlbicsXG4gICAgICB9O1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihtb2NrZWRBdXRoU2VydmljZSwgJ3JlZnJlc2hUb2tlbicpXG4gICAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gYXV0aFRva2VuKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgcmVmcmVzaCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXV0aENvbnRyb2xsZXIucmVmcmVzaFRva2VuKFxuICAgICAgICBjdHgsXG4gICAgICAgIHJlZnJlc2hUb2tlbklucHV0RHRvLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KG1vY2tlZEF1dGhTZXJ2aWNlLnJlZnJlc2hUb2tlbikudG9CZUNhbGxlZFdpdGgoY3R4KTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5kYXRhKS50b0VxdWFsKGF1dGhUb2tlbik7XG4gICAgfSk7XG5cbiAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgamVzdC5yZXNldEFsbE1vY2tzKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=