542b524c1bf6da672c673cd5f7344226
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.TemplateEngine = void 0;
const Handlebars = __importStar(require("handlebars"));
const exceptions_1 = require("../exceptions");
/**
 * Motor de renderização de templates baseado em Handlebars.
 * Fornece funcionalidades para renderizar templates com variáveis,
 * condicionais e loops, além de helpers para formatação.
 */
class TemplateEngine {
    // Armazena templates compilados em cache para melhor performance
    static templatesCompilados = new Map();
    constructor() {
        // Garantir que os helpers estejam registrados
        TemplateEngine.inicializar();
    }
    /**
     * Registra os helpers personalizados do Handlebars.
     * Executado uma vez na inicialização.
     */
    /**
     * Compila um template para uso posterior
     *
     * @param templateString - String contendo o template com placeholders
     * @returns Template compilado pronto para renderização
     * @throws Error se a compilação falhar
     */
    compile(templateString) {
        try {
            return Handlebars.compile(templateString, { strict: false });
        }
        catch (error) {
            throw new Error(`Erro na compilação do template: ${error.message}`);
        }
    }
    /**
     * Renderiza um template com os dados fornecidos
     *
     * @param templateString - String contendo o template com placeholders
     * @param dados - Objeto com dados para substituir os placeholders
     * @param opcoes - Opções adicionais como sanitização
     * @returns String com o template renderizado
     */
    async render(templateString, dados, opcoes = {}) {
        try {
            // Se solicitado, sanitiza os dados para prevenir XSS
            const dadosFinal = opcoes.sanitize
                ? TemplateEngine.sanitizarDados(dados)
                : dados;
            // Compila o template
            const template = this.compile(templateString);
            // Renderiza com os dados
            return template(dadosFinal);
        }
        catch (error) {
            throw new Error(`Erro na renderização do template: ${error.message}`);
        }
    }
    static inicializar() {
        // Helper para formatação de data
        Handlebars.registerHelper('formatarData', function (data, formato) {
            if (!data) {
                return '';
            }
            const dataObj = data instanceof Date ? data : new Date(data);
            if (isNaN(dataObj.getTime())) {
                return data;
            }
            // Formato padrão DD/MM/YYYY
            if (!formato || formato === 'data') {
                return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
            }
            // Formato data e hora DD/MM/YYYY HH:MM
            if (formato === 'dataHora') {
                return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()} ${dataObj.getHours().toString().padStart(2, '0')}:${dataObj.getMinutes().toString().padStart(2, '0')}`;
            }
            return data;
        });
        // Helper para formatação de moeda
        Handlebars.registerHelper('formatarMoeda', function (valor) {
            if (valor === undefined || valor === null) {
                return '';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(valor);
        });
        // Helper para formatação de CPF: XXX.XXX.XXX-XX
        Handlebars.registerHelper('formatarCpf', function (cpf) {
            if (!cpf || typeof cpf !== 'string') {
                return cpf;
            }
            // Remove caracteres não numéricos
            const cpfNumerico = cpf.replace(/\D/g, '');
            // Verifica se tem 11 dígitos
            if (cpfNumerico.length !== 11) {
                return cpf;
            }
            // Formato: XXX.XXX.XXX-XX
            return `${cpfNumerico.substring(0, 3)}.${cpfNumerico.substring(3, 6)}.${cpfNumerico.substring(6, 9)}-${cpfNumerico.substring(9, 11)}`;
        });
        // Helper para formatação de texto maiúsculo
        Handlebars.registerHelper('maiusculo', function (texto) {
            if (!texto) {
                return '';
            }
            return texto.toUpperCase();
        });
        // Helper para formatação de texto minúsculo
        Handlebars.registerHelper('minusculo', function (texto) {
            if (!texto) {
                return '';
            }
            return texto.toLowerCase();
        });
        // Helper para formatação de primeira letra maiúscula
        Handlebars.registerHelper('capitalizar', function (texto) {
            if (!texto) {
                return '';
            }
            return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
        });
    }
    /**
     * Renderiza um template com os dados fornecidos.
     *
     * @param templateString - String contendo o template com placeholders
     * @param dados - Objeto com dados para substituir os placeholders
     * @param templateId - Identificador do template (para cache e mensagens de erro)
     * @returns String com o template renderizado
     * @throws TemplateInvalidoException se a renderização falhar
     */
    static renderizar(templateString, dados, templateId) {
        try {
            // Tenta obter o template compilado do cache
            let templateCompilado = this.templatesCompilados.get(templateId);
            // Se não existir no cache, compila e armazena
            if (!templateCompilado) {
                templateCompilado = Handlebars.compile(templateString, {
                    strict: false,
                });
                this.templatesCompilados.set(templateId, templateCompilado);
            }
            // Renderiza o template com os dados
            return templateCompilado(dados);
        }
        catch (error) {
            // Em caso de erro, lança exceção específica
            throw new exceptions_1.TemplateInvalidoException(templateId, `Erro na renderização: ${error.message}`);
        }
    }
    /**
     * Sanitiza dados antes da renderização para prevenir ataques XSS.
     *
     * @param dados - Objeto com dados a serem sanitizados
     * @returns Objeto com dados sanitizados
     */
    static sanitizarDados(dados) {
        const resultado = {};
        // Função recursiva para sanitizar strings em objetos aninhados
        const sanitizarValor = (valor) => {
            if (typeof valor === 'string') {
                // Escapa códigos HTML para prevenir XSS
                return Handlebars.escapeExpression(valor);
            }
            else if (Array.isArray(valor)) {
                return valor.map(sanitizarValor);
            }
            else if (valor !== null && typeof valor === 'object') {
                const obj = {};
                for (const key in valor) {
                    if (Object.prototype.hasOwnProperty.call(valor, key)) {
                        obj[key] = sanitizarValor(valor[key]);
                    }
                }
                return obj;
            }
            return valor;
        };
        // Aplica sanitização a todas as propriedades do objeto
        for (const key in dados) {
            if (Object.prototype.hasOwnProperty.call(dados, key)) {
                resultado[key] = sanitizarValor(dados[key]);
            }
        }
        return resultado;
    }
    /**
     * Valida a existência de variáveis usadas no template.
     *
     * @param templateString - String contendo o template com placeholders
     * @param variaveis - Array de nomes de variáveis disponíveis
     * @returns Array de variáveis não definidas (vazio se todas existirem)
     */
    static validarVariaveis(templateString, variaveis) {
        // Expressão regular para encontrar variáveis no formato {{variavel}}
        // Ignora helpers, condicionais e loops ({{#if}}, {{#each}}, {{formatarData}})
        const regex = /{{([^#/][^{}]+)}}/g;
        const matches = templateString.matchAll(regex);
        const variaveisEncontradas = new Set();
        // Coleta todas as variáveis encontradas no template
        for (const match of matches) {
            const variavel = match[1].trim().split(' ')[0];
            // Ignora helpers e operadores
            if (!variavel.startsWith('formatarData') &&
                !variavel.startsWith('formatarMoeda') &&
                !variavel.startsWith('formatarCpf') &&
                !variavel.startsWith('maiusculo') &&
                !variavel.startsWith('minusculo') &&
                !variavel.startsWith('capitalizar') &&
                !variavel.includes('.')) {
                variaveisEncontradas.add(variavel);
            }
        }
        // Verifica quais variáveis encontradas não estão disponíveis
        const variaveisNaoDefinidas = [];
        for (const variavel of variaveisEncontradas) {
            if (!variaveis.includes(variavel)) {
                variaveisNaoDefinidas.push(variavel);
            }
        }
        return variaveisNaoDefinidas;
    }
}
exports.TemplateEngine = TemplateEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNvbmZpZ3VyYWNhb1xcdXRpbFxcdGVtcGxhdGUtZW5naW5lLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHVEQUF5QztBQUN6Qyw4Q0FBMEQ7QUFFMUQ7Ozs7R0FJRztBQUNILE1BQWEsY0FBYztJQUN6QixpRUFBaUU7SUFDekQsTUFBTSxDQUFDLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUd6QyxDQUFDO0lBRUo7UUFDRSw4Q0FBOEM7UUFDOUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRDs7O09BR0c7SUFDSDs7Ozs7O09BTUc7SUFDSCxPQUFPLENBQUMsY0FBc0I7UUFDNUIsSUFBSSxDQUFDO1lBQ0gsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQ0FBbUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDdEUsQ0FBQztJQUNILENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FDVixjQUFzQixFQUN0QixLQUEwQixFQUMxQixTQUFpQyxFQUFFO1FBRW5DLElBQUksQ0FBQztZQUNILHFEQUFxRDtZQUNyRCxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsUUFBUTtnQkFDaEMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDO2dCQUN0QyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRVYscUJBQXFCO1lBQ3JCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFOUMs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QUFDO1FBRS9DLG9EQUFvRDtRQUNwRCxLQUFLLE1BQU0sS0FBSyxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQzVCLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsOEJBQThCO1lBQzlCLElBQ0UsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztnQkFDcEMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQztnQkFDckMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztnQkFDbkMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztnQkFDakMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztnQkFDakMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztnQkFDbkMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUN2QixDQUFDO2dCQUNELG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyQyxDQUFDO1FBQ0gsQ0FBQztRQUVELDZEQUE2RDtRQUM3RCxNQUFNLHFCQUFxQixHQUFhLEVBQUUsQ0FBQztRQUMzQyxLQUFLLE1BQU0sUUFBUSxJQUFJLG9CQUFvQixFQUFFLENBQUM7WUFDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDbEMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxxQkFBcUIsQ0FBQztJQUMvQixDQUFDOztBQXJRSCx3Q0FzUUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNvbmZpZ3VyYWNhb1xcdXRpbFxcdGVtcGxhdGUtZW5naW5lLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEhhbmRsZWJhcnMgZnJvbSAnaGFuZGxlYmFycyc7XG5pbXBvcnQgeyBUZW1wbGF0ZUludmFsaWRvRXhjZXB0aW9uIH0gZnJvbSAnLi4vZXhjZXB0aW9ucyc7XG5cbi8qKlxuICogTW90b3IgZGUgcmVuZGVyaXphw6fDo28gZGUgdGVtcGxhdGVzIGJhc2VhZG8gZW0gSGFuZGxlYmFycy5cbiAqIEZvcm5lY2UgZnVuY2lvbmFsaWRhZGVzIHBhcmEgcmVuZGVyaXphciB0ZW1wbGF0ZXMgY29tIHZhcmnDoXZlaXMsXG4gKiBjb25kaWNpb25haXMgZSBsb29wcywgYWzDqW0gZGUgaGVscGVycyBwYXJhIGZvcm1hdGHDp8Ojby5cbiAqL1xuZXhwb3J0IGNsYXNzIFRlbXBsYXRlRW5naW5lIHtcbiAgLy8gQXJtYXplbmEgdGVtcGxhdGVzIGNvbXBpbGFkb3MgZW0gY2FjaGUgcGFyYSBtZWxob3IgcGVyZm9ybWFuY2VcbiAgcHJpdmF0ZSBzdGF0aWMgdGVtcGxhdGVzQ29tcGlsYWRvcyA9IG5ldyBNYXA8XG4gICAgc3RyaW5nLFxuICAgIEhhbmRsZWJhcnNUZW1wbGF0ZURlbGVnYXRlXG4gID4oKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBHYXJhbnRpciBxdWUgb3MgaGVscGVycyBlc3RlamFtIHJlZ2lzdHJhZG9zXG4gICAgVGVtcGxhdGVFbmdpbmUuaW5pY2lhbGl6YXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RyYSBvcyBoZWxwZXJzIHBlcnNvbmFsaXphZG9zIGRvIEhhbmRsZWJhcnMuXG4gICAqIEV4ZWN1dGFkbyB1bWEgdmV6IG5hIGluaWNpYWxpemHDp8Ojby5cbiAgICovXG4gIC8qKlxuICAgKiBDb21waWxhIHVtIHRlbXBsYXRlIHBhcmEgdXNvIHBvc3RlcmlvclxuICAgKlxuICAgKiBAcGFyYW0gdGVtcGxhdGVTdHJpbmcgLSBTdHJpbmcgY29udGVuZG8gbyB0ZW1wbGF0ZSBjb20gcGxhY2Vob2xkZXJzXG4gICAqIEByZXR1cm5zIFRlbXBsYXRlIGNvbXBpbGFkbyBwcm9udG8gcGFyYSByZW5kZXJpemHDp8Ojb1xuICAgKiBAdGhyb3dzIEVycm9yIHNlIGEgY29tcGlsYcOnw6NvIGZhbGhhclxuICAgKi9cbiAgY29tcGlsZSh0ZW1wbGF0ZVN0cmluZzogc3RyaW5nKTogYW55IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZSh0ZW1wbGF0ZVN0cmluZywgeyBzdHJpY3Q6IGZhbHNlIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm8gbmEgY29tcGlsYcOnw6NvIGRvIHRlbXBsYXRlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlcml6YSB1bSB0ZW1wbGF0ZSBjb20gb3MgZGFkb3MgZm9ybmVjaWRvc1xuICAgKlxuICAgKiBAcGFyYW0gdGVtcGxhdGVTdHJpbmcgLSBTdHJpbmcgY29udGVuZG8gbyB0ZW1wbGF0ZSBjb20gcGxhY2Vob2xkZXJzXG4gICAqIEBwYXJhbSBkYWRvcyAtIE9iamV0byBjb20gZGFkb3MgcGFyYSBzdWJzdGl0dWlyIG9zIHBsYWNlaG9sZGVyc1xuICAgKiBAcGFyYW0gb3Bjb2VzIC0gT3DDp8O1ZXMgYWRpY2lvbmFpcyBjb21vIHNhbml0aXphw6fDo29cbiAgICogQHJldHVybnMgU3RyaW5nIGNvbSBvIHRlbXBsYXRlIHJlbmRlcml6YWRvXG4gICAqL1xuICBhc3luYyByZW5kZXIoXG4gICAgdGVtcGxhdGVTdHJpbmc6IHN0cmluZyxcbiAgICBkYWRvczogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBvcGNvZXM6IHsgc2FuaXRpemU/OiBib29sZWFuIH0gPSB7fSxcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0cnkge1xuICAgICAgLy8gU2Ugc29saWNpdGFkbywgc2FuaXRpemEgb3MgZGFkb3MgcGFyYSBwcmV2ZW5pciBYU1NcbiAgICAgIGNvbnN0IGRhZG9zRmluYWwgPSBvcGNvZXMuc2FuaXRpemVcbiAgICAgICAgPyBUZW1wbGF0ZUVuZ2luZS5zYW5pdGl6YXJEYWRvcyhkYWRvcylcbiAgICAgICAgOiBkYWRvcztcblxuICAgICAgLy8gQ29tcGlsYSBvIHRlbXBsYXRlXG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHRoaXMuY29tcGlsZSh0ZW1wbGF0ZVN0cmluZyk7XG5cbiAgICAgIC8vIFJlbmRlcml6YSBjb20gb3MgZGFkb3NcbiAgICAgIHJldHVybiB0ZW1wbGF0ZShkYWRvc0ZpbmFsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvIG5hIHJlbmRlcml6YcOnw6NvIGRvIHRlbXBsYXRlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGluaWNpYWxpemFyKCk6IHZvaWQge1xuICAgIC8vIEhlbHBlciBwYXJhIGZvcm1hdGHDp8OjbyBkZSBkYXRhXG4gICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcihcbiAgICAgICdmb3JtYXRhckRhdGEnLFxuICAgICAgZnVuY3Rpb24gKGRhdGE6IERhdGUgfCBzdHJpbmcsIGZvcm1hdG86IHN0cmluZykge1xuICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYXRhT2JqID0gZGF0YSBpbnN0YW5jZW9mIERhdGUgPyBkYXRhIDogbmV3IERhdGUoZGF0YSk7XG4gICAgICAgIGlmIChpc05hTihkYXRhT2JqLmdldFRpbWUoKSkpIHtcbiAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZvcm1hdG8gcGFkcsOjbyBERC9NTS9ZWVlZXG4gICAgICAgIGlmICghZm9ybWF0byB8fCBmb3JtYXRvID09PSAnZGF0YScpIHtcbiAgICAgICAgICByZXR1cm4gYCR7ZGF0YU9iai5nZXREYXRlKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfS8keyhkYXRhT2JqLmdldE1vbnRoKCkgKyAxKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9LyR7ZGF0YU9iai5nZXRGdWxsWWVhcigpfWA7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBGb3JtYXRvIGRhdGEgZSBob3JhIEREL01NL1lZWVkgSEg6TU1cbiAgICAgICAgaWYgKGZvcm1hdG8gPT09ICdkYXRhSG9yYScpIHtcbiAgICAgICAgICByZXR1cm4gYCR7ZGF0YU9iai5nZXREYXRlKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfS8keyhkYXRhT2JqLmdldE1vbnRoKCkgKyAxKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9LyR7ZGF0YU9iai5nZXRGdWxsWWVhcigpfSAke2RhdGFPYmouZ2V0SG91cnMoKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7ZGF0YU9iai5nZXRNaW51dGVzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIEhlbHBlciBwYXJhIGZvcm1hdGHDp8OjbyBkZSBtb2VkYVxuICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2Zvcm1hdGFyTW9lZGEnLCBmdW5jdGlvbiAodmFsb3I6IG51bWJlcikge1xuICAgICAgaWYgKHZhbG9yID09PSB1bmRlZmluZWQgfHwgdmFsb3IgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuICcnO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3IEludGwuTnVtYmVyRm9ybWF0KCdwdC1CUicsIHtcbiAgICAgICAgc3R5bGU6ICdjdXJyZW5jeScsXG4gICAgICAgIGN1cnJlbmN5OiAnQlJMJyxcbiAgICAgIH0pLmZvcm1hdCh2YWxvcik7XG4gICAgfSk7XG5cbiAgICAvLyBIZWxwZXIgcGFyYSBmb3JtYXRhw6fDo28gZGUgQ1BGOiBYWFguWFhYLlhYWC1YWFxuICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2Zvcm1hdGFyQ3BmJywgZnVuY3Rpb24gKGNwZjogc3RyaW5nKSB7XG4gICAgICBpZiAoIWNwZiB8fCB0eXBlb2YgY3BmICE9PSAnc3RyaW5nJykge1xuICAgICAgICByZXR1cm4gY3BmO1xuICAgICAgfVxuXG4gICAgICAvLyBSZW1vdmUgY2FyYWN0ZXJlcyBuw6NvIG51bcOpcmljb3NcbiAgICAgIGNvbnN0IGNwZk51bWVyaWNvID0gY3BmLnJlcGxhY2UoL1xcRC9nLCAnJyk7XG5cbiAgICAgIC8vIFZlcmlmaWNhIHNlIHRlbSAxMSBkw61naXRvc1xuICAgICAgaWYgKGNwZk51bWVyaWNvLmxlbmd0aCAhPT0gMTEpIHtcbiAgICAgICAgcmV0dXJuIGNwZjtcbiAgICAgIH1cblxuICAgICAgLy8gRm9ybWF0bzogWFhYLlhYWC5YWFgtWFhcbiAgICAgIHJldHVybiBgJHtjcGZOdW1lcmljby5zdWJzdHJpbmcoMCwgMyl9LiR7Y3BmTnVtZXJpY28uc3Vic3RyaW5nKDMsIDYpfS4ke2NwZk51bWVyaWNvLnN1YnN0cmluZyg2LCA5KX0tJHtjcGZOdW1lcmljby5zdWJzdHJpbmcoOSwgMTEpfWA7XG4gICAgfSk7XG5cbiAgICAvLyBIZWxwZXIgcGFyYSBmb3JtYXRhw6fDo28gZGUgdGV4dG8gbWFpw7pzY3Vsb1xuICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ21haXVzY3VsbycsIGZ1bmN0aW9uICh0ZXh0bzogc3RyaW5nKSB7XG4gICAgICBpZiAoIXRleHRvKSB7XG4gICAgICAgIHJldHVybiAnJztcbiAgICAgIH1cbiAgICAgIHJldHVybiB0ZXh0by50b1VwcGVyQ2FzZSgpO1xuICAgIH0pO1xuXG4gICAgLy8gSGVscGVyIHBhcmEgZm9ybWF0YcOnw6NvIGRlIHRleHRvIG1pbsO6c2N1bG9cbiAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdtaW51c2N1bG8nLCBmdW5jdGlvbiAodGV4dG86IHN0cmluZykge1xuICAgICAgaWYgKCF0ZXh0bykge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGV4dG8udG9Mb3dlckNhc2UoKTtcbiAgICB9KTtcblxuICAgIC8vIEhlbHBlciBwYXJhIGZvcm1hdGHDp8OjbyBkZSBwcmltZWlyYSBsZXRyYSBtYWnDunNjdWxhXG4gICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY2FwaXRhbGl6YXInLCBmdW5jdGlvbiAodGV4dG86IHN0cmluZykge1xuICAgICAgaWYgKCF0ZXh0bykge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGV4dG8uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0ZXh0by5zbGljZSgxKS50b0xvd2VyQ2FzZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlcml6YSB1bSB0ZW1wbGF0ZSBjb20gb3MgZGFkb3MgZm9ybmVjaWRvcy5cbiAgICpcbiAgICogQHBhcmFtIHRlbXBsYXRlU3RyaW5nIC0gU3RyaW5nIGNvbnRlbmRvIG8gdGVtcGxhdGUgY29tIHBsYWNlaG9sZGVyc1xuICAgKiBAcGFyYW0gZGFkb3MgLSBPYmpldG8gY29tIGRhZG9zIHBhcmEgc3Vic3RpdHVpciBvcyBwbGFjZWhvbGRlcnNcbiAgICogQHBhcmFtIHRlbXBsYXRlSWQgLSBJZGVudGlmaWNhZG9yIGRvIHRlbXBsYXRlIChwYXJhIGNhY2hlIGUgbWVuc2FnZW5zIGRlIGVycm8pXG4gICAqIEByZXR1cm5zIFN0cmluZyBjb20gbyB0ZW1wbGF0ZSByZW5kZXJpemFkb1xuICAgKiBAdGhyb3dzIFRlbXBsYXRlSW52YWxpZG9FeGNlcHRpb24gc2UgYSByZW5kZXJpemHDp8OjbyBmYWxoYXJcbiAgICovXG4gIHN0YXRpYyByZW5kZXJpemFyKFxuICAgIHRlbXBsYXRlU3RyaW5nOiBzdHJpbmcsXG4gICAgZGFkb3M6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICAgdGVtcGxhdGVJZDogc3RyaW5nLFxuICApOiBzdHJpbmcge1xuICAgIHRyeSB7XG4gICAgICAvLyBUZW50YSBvYnRlciBvIHRlbXBsYXRlIGNvbXBpbGFkbyBkbyBjYWNoZVxuICAgICAgbGV0IHRlbXBsYXRlQ29tcGlsYWRvID0gdGhpcy50ZW1wbGF0ZXNDb21waWxhZG9zLmdldCh0ZW1wbGF0ZUlkKTtcblxuICAgICAgLy8gU2UgbsOjbyBleGlzdGlyIG5vIGNhY2hlLCBjb21waWxhIGUgYXJtYXplbmFcbiAgICAgIGlmICghdGVtcGxhdGVDb21waWxhZG8pIHtcbiAgICAgICAgdGVtcGxhdGVDb21waWxhZG8gPSBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGVTdHJpbmcsIHtcbiAgICAgICAgICBzdHJpY3Q6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZXNDb21waWxhZG9zLnNldCh0ZW1wbGF0ZUlkLCB0ZW1wbGF0ZUNvbXBpbGFkbyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbmRlcml6YSBvIHRlbXBsYXRlIGNvbSBvcyBkYWRvc1xuICAgICAgcmV0dXJuIHRlbXBsYXRlQ29tcGlsYWRvKGRhZG9zKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gRW0gY2FzbyBkZSBlcnJvLCBsYW7Dp2EgZXhjZcOnw6NvIGVzcGVjw61maWNhXG4gICAgICB0aHJvdyBuZXcgVGVtcGxhdGVJbnZhbGlkb0V4Y2VwdGlvbihcbiAgICAgICAgdGVtcGxhdGVJZCxcbiAgICAgICAgYEVycm8gbmEgcmVuZGVyaXphw6fDo286ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2FuaXRpemEgZGFkb3MgYW50ZXMgZGEgcmVuZGVyaXphw6fDo28gcGFyYSBwcmV2ZW5pciBhdGFxdWVzIFhTUy5cbiAgICpcbiAgICogQHBhcmFtIGRhZG9zIC0gT2JqZXRvIGNvbSBkYWRvcyBhIHNlcmVtIHNhbml0aXphZG9zXG4gICAqIEByZXR1cm5zIE9iamV0byBjb20gZGFkb3Mgc2FuaXRpemFkb3NcbiAgICovXG4gIHN0YXRpYyBzYW5pdGl6YXJEYWRvcyhkYWRvczogUmVjb3JkPHN0cmluZywgYW55Pik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IHJlc3VsdGFkbzogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuXG4gICAgLy8gRnVuw6fDo28gcmVjdXJzaXZhIHBhcmEgc2FuaXRpemFyIHN0cmluZ3MgZW0gb2JqZXRvcyBhbmluaGFkb3NcbiAgICBjb25zdCBzYW5pdGl6YXJWYWxvciA9ICh2YWxvcjogYW55KTogYW55ID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdmFsb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIC8vIEVzY2FwYSBjw7NkaWdvcyBIVE1MIHBhcmEgcHJldmVuaXIgWFNTXG4gICAgICAgIHJldHVybiBIYW5kbGViYXJzLmVzY2FwZUV4cHJlc3Npb24odmFsb3IpO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbG9yKSkge1xuICAgICAgICByZXR1cm4gdmFsb3IubWFwKHNhbml0aXphclZhbG9yKTtcbiAgICAgIH0gZWxzZSBpZiAodmFsb3IgIT09IG51bGwgJiYgdHlwZW9mIHZhbG9yID09PSAnb2JqZWN0Jykge1xuICAgICAgICBjb25zdCBvYmo6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsb3IpIHtcbiAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbG9yLCBrZXkpKSB7XG4gICAgICAgICAgICBvYmpba2V5XSA9IHNhbml0aXphclZhbG9yKHZhbG9yW2tleV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbG9yO1xuICAgIH07XG5cbiAgICAvLyBBcGxpY2Egc2FuaXRpemHDp8OjbyBhIHRvZGFzIGFzIHByb3ByaWVkYWRlcyBkbyBvYmpldG9cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkYWRvcykge1xuICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChkYWRvcywga2V5KSkge1xuICAgICAgICByZXN1bHRhZG9ba2V5XSA9IHNhbml0aXphclZhbG9yKGRhZG9zW2tleV0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHRhZG87XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhIGEgZXhpc3TDqm5jaWEgZGUgdmFyacOhdmVpcyB1c2FkYXMgbm8gdGVtcGxhdGUuXG4gICAqXG4gICAqIEBwYXJhbSB0ZW1wbGF0ZVN0cmluZyAtIFN0cmluZyBjb250ZW5kbyBvIHRlbXBsYXRlIGNvbSBwbGFjZWhvbGRlcnNcbiAgICogQHBhcmFtIHZhcmlhdmVpcyAtIEFycmF5IGRlIG5vbWVzIGRlIHZhcmnDoXZlaXMgZGlzcG9uw612ZWlzXG4gICAqIEByZXR1cm5zIEFycmF5IGRlIHZhcmnDoXZlaXMgbsOjbyBkZWZpbmlkYXMgKHZhemlvIHNlIHRvZGFzIGV4aXN0aXJlbSlcbiAgICovXG4gIHN0YXRpYyB2YWxpZGFyVmFyaWF2ZWlzKFxuICAgIHRlbXBsYXRlU3RyaW5nOiBzdHJpbmcsXG4gICAgdmFyaWF2ZWlzOiBzdHJpbmdbXSxcbiAgKTogc3RyaW5nW10ge1xuICAgIC8vIEV4cHJlc3PDo28gcmVndWxhciBwYXJhIGVuY29udHJhciB2YXJpw6F2ZWlzIG5vIGZvcm1hdG8ge3t2YXJpYXZlbH19XG4gICAgLy8gSWdub3JhIGhlbHBlcnMsIGNvbmRpY2lvbmFpcyBlIGxvb3BzICh7eyNpZn19LCB7eyNlYWNofX0sIHt7Zm9ybWF0YXJEYXRhfX0pXG4gICAgY29uc3QgcmVnZXggPSAve3soW14jL11bXnt9XSspfX0vZztcbiAgICBjb25zdCBtYXRjaGVzID0gdGVtcGxhdGVTdHJpbmcubWF0Y2hBbGwocmVnZXgpO1xuICAgIGNvbnN0IHZhcmlhdmVpc0VuY29udHJhZGFzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgICAvLyBDb2xldGEgdG9kYXMgYXMgdmFyacOhdmVpcyBlbmNvbnRyYWRhcyBubyB0ZW1wbGF0ZVxuICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgbWF0Y2hlcykge1xuICAgICAgY29uc3QgdmFyaWF2ZWwgPSBtYXRjaFsxXS50cmltKCkuc3BsaXQoJyAnKVswXTtcbiAgICAgIC8vIElnbm9yYSBoZWxwZXJzIGUgb3BlcmFkb3Jlc1xuICAgICAgaWYgKFxuICAgICAgICAhdmFyaWF2ZWwuc3RhcnRzV2l0aCgnZm9ybWF0YXJEYXRhJykgJiZcbiAgICAgICAgIXZhcmlhdmVsLnN0YXJ0c1dpdGgoJ2Zvcm1hdGFyTW9lZGEnKSAmJlxuICAgICAgICAhdmFyaWF2ZWwuc3RhcnRzV2l0aCgnZm9ybWF0YXJDcGYnKSAmJlxuICAgICAgICAhdmFyaWF2ZWwuc3RhcnRzV2l0aCgnbWFpdXNjdWxvJykgJiZcbiAgICAgICAgIXZhcmlhdmVsLnN0YXJ0c1dpdGgoJ21pbnVzY3VsbycpICYmXG4gICAgICAgICF2YXJpYXZlbC5zdGFydHNXaXRoKCdjYXBpdGFsaXphcicpICYmXG4gICAgICAgICF2YXJpYXZlbC5pbmNsdWRlcygnLicpXG4gICAgICApIHtcbiAgICAgICAgdmFyaWF2ZWlzRW5jb250cmFkYXMuYWRkKHZhcmlhdmVsKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYSBxdWFpcyB2YXJpw6F2ZWlzIGVuY29udHJhZGFzIG7Do28gZXN0w6NvIGRpc3BvbsOtdmVpc1xuICAgIGNvbnN0IHZhcmlhdmVpc05hb0RlZmluaWRhczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHZhcmlhdmVsIG9mIHZhcmlhdmVpc0VuY29udHJhZGFzKSB7XG4gICAgICBpZiAoIXZhcmlhdmVpcy5pbmNsdWRlcyh2YXJpYXZlbCkpIHtcbiAgICAgICAgdmFyaWF2ZWlzTmFvRGVmaW5pZGFzLnB1c2godmFyaWF2ZWwpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB2YXJpYXZlaXNOYW9EZWZpbmlkYXM7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==