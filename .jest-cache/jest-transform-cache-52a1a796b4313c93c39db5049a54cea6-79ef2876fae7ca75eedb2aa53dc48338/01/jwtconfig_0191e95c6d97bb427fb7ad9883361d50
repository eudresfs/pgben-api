495d7de71caa8cdece4e88d894e8f6d7
"use strict";
/* eslint-disable @typescript-eslint/no-unused-vars */
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateJwtConfig = exports.createJwtRefreshConfig = exports.createJwtConfig = void 0;
/* eslint-disable prettier/prettier */
const fs_1 = require("fs");
const path_1 = require("path");
/**
 * Configuração segura para JWT usando chaves RSA
 * Prioriza carregamento de arquivos sobre chaves em Base64
 */
const createJwtConfig = (configService) => {
    // Função para carregar chave privada de forma segura
    const getPrivateKey = () => {
        const keyPath = configService.get('JWT_PRIVATE_KEY_PATH');
        const keyBase64 = configService.get('JWT_PRIVATE_KEY_BASE64');
        if (keyPath) {
            try {
                const fullPath = (0, path_1.join)(process.cwd(), keyPath);
                const privateKey = (0, fs_1.readFileSync)(fullPath, 'utf8');
                if (!privateKey.includes('BEGIN PRIVATE KEY') &&
                    !privateKey.includes('BEGIN RSA PRIVATE KEY')) {
                    throw new Error('Arquivo de chave privada inválido');
                }
                return privateKey;
            }
            catch (error) {
                throw new Error(`Erro ao carregar chave privada do arquivo ${keyPath}: ${error.message}`);
            }
        }
        if (keyBase64) {
            try {
                const privateKey = Buffer.from(keyBase64, 'base64').toString('utf8');
                if (!privateKey.includes('BEGIN PRIVATE KEY') &&
                    !privateKey.includes('BEGIN RSA PRIVATE KEY')) {
                    throw new Error('Chave privada Base64 inválida');
                }
                return privateKey;
            }
            catch (error) {
                throw new Error(`Erro ao decodificar chave privada Base64: ${error.message}`);
            }
        }
        throw new Error('Chave privada JWT não configurada. Configure JWT_PRIVATE_KEY_PATH ou JWT_PRIVATE_KEY_BASE64');
    };
    // Função para carregar chave pública de forma segura
    const getPublicKey = () => {
        const keyPath = configService.get('JWT_PUBLIC_KEY_PATH');
        const keyBase64 = configService.get('JWT_PUBLIC_KEY_BASE64');
        if (keyPath) {
            try {
                const fullPath = (0, path_1.join)(process.cwd(), keyPath);
                const publicKey = (0, fs_1.readFileSync)(fullPath, 'utf8');
                if (!publicKey.includes('BEGIN PUBLIC KEY')) {
                    throw new Error('Arquivo de chave pública inválido');
                }
                return publicKey;
            }
            catch (error) {
                throw new Error(`Erro ao carregar chave pública do arquivo ${keyPath}: ${error.message}`);
            }
        }
        if (keyBase64) {
            try {
                const publicKey = Buffer.from(keyBase64, 'base64').toString('utf8');
                if (!publicKey.includes('BEGIN PUBLIC KEY')) {
                    throw new Error('Chave pública Base64 inválida');
                }
                return publicKey;
            }
            catch (error) {
                throw new Error(`Erro ao decodificar chave pública Base64: ${error.message}`);
            }
        }
        throw new Error('Chave pública JWT não configurada. Configure JWT_PUBLIC_KEY_PATH ou JWT_PUBLIC_KEY_BASE64');
    };
    // Validar algoritmo de assinatura
    const algorithm = configService.get('JWT_ALGORITHM', 'RS256');
    if (!['RS256', 'RS384', 'RS512'].includes(algorithm)) {
        throw new Error(`Algoritmo JWT inválido: ${algorithm}. Use RS256, RS384 ou RS512`);
    }
    // Validar tempo de expiração
    const expiresIn = configService.get('JWT_ACCESS_TOKEN_EXPIRES_IN', '15m');
    const refreshExpiresIn = configService.get('JWT_REFRESH_TOKEN_EXPIRES_IN', '7d');
    // Configuração final do JWT
    return {
        privateKey: getPrivateKey(),
        publicKey: getPublicKey(),
        signOptions: {
            algorithm: algorithm,
            expiresIn: expiresIn,
            issuer: configService.get('APP_NAME', 'PGBEN'),
            audience: configService.get('FRONTEND_URL', 'http://localhost:3001'),
        },
        verifyOptions: {
            algorithms: [algorithm],
            issuer: configService.get('APP_NAME', 'PGBEN'),
            audience: configService.get('FRONTEND_URL', 'http://localhost:3001'),
        },
    };
};
exports.createJwtConfig = createJwtConfig;
/**
 * Configuração específica para tokens de refresh
 */
const createJwtRefreshConfig = (configService) => {
    const baseConfig = (0, exports.createJwtConfig)(configService);
    return {
        ...baseConfig,
        signOptions: {
            ...baseConfig.signOptions,
            expiresIn: configService.get('JWT_REFRESH_TOKEN_EXPIRES_IN', '7d'),
        },
    };
};
exports.createJwtRefreshConfig = createJwtRefreshConfig;
/**
 * Utilitário para validar configuração JWT na inicialização
 */
const validateJwtConfig = (configService) => {
    try {
        (0, exports.createJwtConfig)(configService);
        console.log('✅ Configuração JWT validada com sucesso');
    }
    catch (error) {
        console.error('❌ Erro na configuração JWT:', error.message);
        throw error;
    }
};
exports.validateJwtConfig = validateJwtConfig;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGNvbmZpZ1xcand0LmNvbmZpZy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsc0RBQXNEOzs7QUFFdEQsc0NBQXNDO0FBQ3RDLDJCQUFrQztBQUNsQywrQkFBNEI7QUFJNUI7OztHQUdHO0FBQ0ksTUFBTSxlQUFlLEdBQUcsQ0FDN0IsYUFBNEIsRUFDVixFQUFFO0lBQ3BCLHFEQUFxRDtJQUNyRCxNQUFNLGFBQWEsR0FBRyxHQUFXLEVBQUU7UUFDakMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBUyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQVMsd0JBQXdCLENBQUMsQ0FBQztRQUV0RSxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ1osSUFBSSxDQUFDO2dCQUNILE1BQU0sUUFBUSxHQUFHLElBQUEsV0FBSSxFQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBQSxpQkFBWSxFQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFFbEQsSUFDRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUM7b0JBQ3pDLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxFQUM3QyxDQUFDO29CQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztnQkFDdkQsQ0FBQztnQkFFRCxPQUFPLFVBQVUsQ0FBQztZQUNwQixDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixNQUFNLElBQUksS0FBSyxDQUNiLDZDQUE2QyxPQUFPLEtBQUssS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUN6RSxDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLFNBQVMsRUFBRSxDQUFD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QVEsRUFBRTtJQUN0RSxJQUFJLENBQUM7UUFDSCxJQUFBLHVCQUFlLEVBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUQsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBUlcsUUFBQSxpQkFBaUIscUJBUTVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxjb25maWdcXGp3dC5jb25maWcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzICovXG5cbi8qIGVzbGludC1kaXNhYmxlIHByZXR0aWVyL3ByZXR0aWVyICovXG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgSnd0TW9kdWxlT3B0aW9ucyB9IGZyb20gJ0BuZXN0anMvand0JztcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBzZWd1cmEgcGFyYSBKV1QgdXNhbmRvIGNoYXZlcyBSU0FcbiAqIFByaW9yaXphIGNhcnJlZ2FtZW50byBkZSBhcnF1aXZvcyBzb2JyZSBjaGF2ZXMgZW0gQmFzZTY0XG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVKd3RDb25maWcgPSAoXG4gIGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4pOiBKd3RNb2R1bGVPcHRpb25zID0+IHtcbiAgLy8gRnVuw6fDo28gcGFyYSBjYXJyZWdhciBjaGF2ZSBwcml2YWRhIGRlIGZvcm1hIHNlZ3VyYVxuICBjb25zdCBnZXRQcml2YXRlS2V5ID0gKCk6IHN0cmluZyA9PiB7XG4gICAgY29uc3Qga2V5UGF0aCA9IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0pXVF9QUklWQVRFX0tFWV9QQVRIJyk7XG4gICAgY29uc3Qga2V5QmFzZTY0ID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignSldUX1BSSVZBVEVfS0VZX0JBU0U2NCcpO1xuXG4gICAgaWYgKGtleVBhdGgpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gam9pbihwcm9jZXNzLmN3ZCgpLCBrZXlQYXRoKTtcbiAgICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IHJlYWRGaWxlU3luYyhmdWxsUGF0aCwgJ3V0ZjgnKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgIXByaXZhdGVLZXkuaW5jbHVkZXMoJ0JFR0lOIFBSSVZBVEUgS0VZJykgJiZcbiAgICAgICAgICAhcHJpdmF0ZUtleS5pbmNsdWRlcygnQkVHSU4gUlNBIFBSSVZBVEUgS0VZJylcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcnF1aXZvIGRlIGNoYXZlIHByaXZhZGEgaW52w6FsaWRvJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJpdmF0ZUtleTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRXJybyBhbyBjYXJyZWdhciBjaGF2ZSBwcml2YWRhIGRvIGFycXVpdm8gJHtrZXlQYXRofTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGtleUJhc2U2NCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IEJ1ZmZlci5mcm9tKGtleUJhc2U2NCwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGY4Jyk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICFwcml2YXRlS2V5LmluY2x1ZGVzKCdCRUdJTiBQUklWQVRFIEtFWScpICYmXG4gICAgICAgICAgIXByaXZhdGVLZXkuaW5jbHVkZXMoJ0JFR0lOIFJTQSBQUklWQVRFIEtFWScpXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hhdmUgcHJpdmFkYSBCYXNlNjQgaW52w6FsaWRhJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJpdmF0ZUtleTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRXJybyBhbyBkZWNvZGlmaWNhciBjaGF2ZSBwcml2YWRhIEJhc2U2NDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ0NoYXZlIHByaXZhZGEgSldUIG7Do28gY29uZmlndXJhZGEuIENvbmZpZ3VyZSBKV1RfUFJJVkFURV9LRVlfUEFUSCBvdSBKV1RfUFJJVkFURV9LRVlfQkFTRTY0JyxcbiAgICApO1xuICB9O1xuXG4gIC8vIEZ1bsOnw6NvIHBhcmEgY2FycmVnYXIgY2hhdmUgcMO6YmxpY2EgZGUgZm9ybWEgc2VndXJhXG4gIGNvbnN0IGdldFB1YmxpY0tleSA9ICgpOiBzdHJpbmcgPT4ge1xuICAgIGNvbnN0IGtleVBhdGggPSBjb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdKV1RfUFVCTElDX0tFWV9QQVRIJyk7XG4gICAgY29uc3Qga2V5QmFzZTY0ID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignSldUX1BVQkxJQ19LRVlfQkFTRTY0Jyk7XG5cbiAgICBpZiAoa2V5UGF0aCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZnVsbFBhdGggPSBqb2luKHByb2Nlc3MuY3dkKCksIGtleVBhdGgpO1xuICAgICAgICBjb25zdCBwdWJsaWNLZXkgPSByZWFkRmlsZVN5bmMoZnVsbFBhdGgsICd1dGY4Jyk7XG5cbiAgICAgICAgaWYgKCFwdWJsaWNLZXkuaW5jbHVkZXMoJ0JFR0lOIFBVQkxJQyBLRVknKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXJxdWl2byBkZSBjaGF2ZSBww7pibGljYSBpbnbDoWxpZG8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwdWJsaWNLZXk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEVycm8gYW8gY2FycmVnYXIgY2hhdmUgcMO6YmxpY2EgZG8gYXJxdWl2byAke2tleVBhdGh9OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoa2V5QmFzZTY0KSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwdWJsaWNLZXkgPSBCdWZmZXIuZnJvbShrZXlCYXNlNjQsICdiYXNlNjQnKS50b1N0cmluZygndXRmOCcpO1xuXG4gICAgICAgIGlmICghcHVibGljS2V5LmluY2x1ZGVzKCdCRUdJTiBQVUJMSUMgS0VZJykpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoYXZlIHDDumJsaWNhIEJhc2U2NCBpbnbDoWxpZGEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwdWJsaWNLZXk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEVycm8gYW8gZGVjb2RpZmljYXIgY2hhdmUgcMO6YmxpY2EgQmFzZTY0OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnQ2hhdmUgcMO6YmxpY2EgSldUIG7Do28gY29uZmlndXJhZGEuIENvbmZpZ3VyZSBKV1RfUFVCTElDX0tFWV9QQVRIIG91IEpXVF9QVUJMSUNfS0VZX0JBU0U2NCcsXG4gICAgKTtcbiAgfTtcblxuICAvLyBWYWxpZGFyIGFsZ29yaXRtbyBkZSBhc3NpbmF0dXJhXG4gIGNvbnN0IGFsZ29yaXRobSA9IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0pXVF9BTEdPUklUSE0nLCAnUlMyNTYnKTtcbiAgaWYgKCFbJ1JTMjU2JywgJ1JTMzg0JywgJ1JTNTEyJ10uaW5jbHVkZXMoYWxnb3JpdGhtKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBBbGdvcml0bW8gSldUIGludsOhbGlkbzogJHthbGdvcml0aG19LiBVc2UgUlMyNTYsIFJTMzg0IG91IFJTNTEyYCxcbiAgICApO1xuICB9XG5cbiAgLy8gVmFsaWRhciB0ZW1wbyBkZSBleHBpcmHDp8Ojb1xuICBjb25zdCBleHBpcmVzSW4gPSBjb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KFxuICAgICdKV1RfQUNDRVNTX1RPS0VOX0VYUElSRVNfSU4nLFxuICAgICcxNW0nLFxuICApO1xuICBjb25zdCByZWZyZXNoRXhwaXJlc0luID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPihcbiAgICAnSldUX1JFRlJFU0hfVE9LRU5fRVhQSVJFU19JTicsXG4gICAgJzdkJyxcbiAgKTtcblxuICAvLyBDb25maWd1cmHDp8OjbyBmaW5hbCBkbyBKV1RcbiAgcmV0dXJuIHtcbiAgICBwcml2YXRlS2V5OiBnZXRQcml2YXRlS2V5KCksXG4gICAgcHVibGljS2V5OiBnZXRQdWJsaWNLZXkoKSxcbiAgICBzaWduT3B0aW9uczoge1xuICAgICAgYWxnb3JpdGhtOiBhbGdvcml0aG0gYXMgJ1JTMjU2JyB8ICdSUzM4NCcgfCAnUlM1MTInLFxuICAgICAgZXhwaXJlc0luOiBleHBpcmVzSW4sXG4gICAgICBpc3N1ZXI6IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0FQUF9OQU1FJywgJ1BHQkVOJyksXG4gICAgICBhdWRpZW5jZTogY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPihcbiAgICAgICAgJ0ZST05URU5EX1VSTCcsXG4gICAgICAgICdodHRwOi8vbG9jYWxob3N0OjMwMDEnLFxuICAgICAgKSxcbiAgICB9LFxuICAgIHZlcmlmeU9wdGlvbnM6IHtcbiAgICAgIGFsZ29yaXRobXM6IFthbGdvcml0aG0gYXMgJ1JTMjU2JyB8ICdSUzM4NCcgfCAnUlM1MTInXSxcbiAgICAgIGlzc3VlcjogY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQVBQX05BTUUnLCAnUEdCRU4nKSxcbiAgICAgIGF1ZGllbmNlOiBjb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KFxuICAgICAgICAnRlJPTlRFTkRfVVJMJyxcbiAgICAgICAgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMScsXG4gICAgICApLFxuICAgIH0sXG4gIH07XG59O1xuXG4vKipcbiAqIENvbmZpZ3VyYcOnw6NvIGVzcGVjw61maWNhIHBhcmEgdG9rZW5zIGRlIHJlZnJlc2hcbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZUp3dFJlZnJlc2hDb25maWcgPSAoXG4gIGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4pOiBKd3RNb2R1bGVPcHRpb25zID0+IHtcbiAgY29uc3QgYmFzZUNvbmZpZyA9IGNyZWF0ZUp3dENvbmZpZyhjb25maWdTZXJ2aWNlKTtcblxuICByZXR1cm4ge1xuICAgIC4uLmJhc2VDb25maWcsXG4gICAgc2lnbk9wdGlvbnM6IHtcbiAgICAgIC4uLmJhc2VDb25maWcuc2lnbk9wdGlvbnMsXG4gICAgICBleHBpcmVzSW46IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXG4gICAgICAgICdKV1RfUkVGUkVTSF9UT0tFTl9FWFBJUkVTX0lOJyxcbiAgICAgICAgJzdkJyxcbiAgICAgICksXG4gICAgfSxcbiAgfTtcbn07XG5cbi8qKlxuICogVXRpbGl0w6FyaW8gcGFyYSB2YWxpZGFyIGNvbmZpZ3VyYcOnw6NvIEpXVCBuYSBpbmljaWFsaXphw6fDo29cbiAqL1xuZXhwb3J0IGNvbnN0IHZhbGlkYXRlSnd0Q29uZmlnID0gKGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UpOiB2b2lkID0+IHtcbiAgdHJ5IHtcbiAgICBjcmVhdGVKd3RDb25maWcoY29uZmlnU2VydmljZSk7XG4gICAgY29uc29sZS5sb2coJ+KchSBDb25maWd1cmHDp8OjbyBKV1QgdmFsaWRhZGEgY29tIHN1Y2Vzc28nKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgRXJybyBuYSBjb25maWd1cmHDp8OjbyBKV1Q6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn07XG4iXSwidmVyc2lvbiI6M30=