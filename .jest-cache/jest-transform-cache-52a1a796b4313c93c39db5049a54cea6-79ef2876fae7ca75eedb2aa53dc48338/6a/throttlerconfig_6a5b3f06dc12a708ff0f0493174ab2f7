347af2576cb05d6ba29a663021aed1e1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RATE_LIMIT_HEADERS = exports.getClientIp = exports.API_THROTTLE_CONFIG = exports.UPLOAD_THROTTLE_CONFIG = exports.AUTH_THROTTLE_CONFIG = exports.createThrottlerConfig = void 0;
/**
 * Configuração do Rate Limiting para o Sistema SEMTAS
 *
 * Implementa diferentes limites para diferentes tipos de endpoints:
 * - Autenticação: Mais restritivo para prevenir ataques de força bruta
 * - API Geral: Limite padrão para operações normais
 * - Upload: Limite específico para uploads de documentos
 *
 * Utiliza Redis como storage para permitir rate limiting distribuído
 */
const createThrottlerConfig = (configService) => {
    const nodeEnv = configService.get('NODE_ENV', 'development');
    // Configuração do throttler com armazenamento em memória
    const config = {
        throttlers: [
            {
                name: 'default',
                ttl: configService.get('THROTTLE_TTL', 60) * 1000, // Converter para ms
                limit: configService.get('THROTTLE_LIMIT', 100),
            },
            {
                name: 'auth',
                ttl: configService.get('THROTTLE_AUTH_TTL', 300) * 1000, // 5 minutos
                limit: configService.get('THROTTLE_AUTH_LIMIT', 5), // 5 tentativas por 5 min
            },
            {
                name: 'upload',
                ttl: configService.get('THROTTLE_UPLOAD_TTL', 60) * 1000, // 1 minuto
                limit: configService.get('THROTTLE_UPLOAD_LIMIT', 10), // 10 uploads por minuto
            },
            {
                name: 'api',
                ttl: configService.get('THROTTLE_API_TTL', 60) * 1000, // 1 minuto
                limit: configService.get('THROTTLE_API_LIMIT', 200), // 200 requests por minuto
            },
        ],
        skipIf: (context) => {
            // Pular rate limiting em desenvolvimento se configurado
            if (nodeEnv === 'development') {
                const skipInDev = configService.get('THROTTLE_SKIP_DEV', false);
                if (skipInDev) {
                    return true;
                }
            }
            // Pular para health checks
            const request = context.switchToHttp().getRequest();
            const isHealthCheck = request.url?.includes('/health') ||
                request.url?.includes('/metrics') ||
                request.url?.includes('/status');
            return isHealthCheck;
        },
        errorMessage: 'Muitas tentativas. Tente novamente em alguns minutos.',
    };
    console.log('ℹ️ Rate limiting configurado com armazenamento em memória');
    return config;
};
exports.createThrottlerConfig = createThrottlerConfig;
/**
 * Configuração de rate limiting específica para endpoints de autenticação
 */
exports.AUTH_THROTTLE_CONFIG = {
    default: {
        limit: 5,
        ttl: 300000, // 5 minutos em ms
    },
};
/**
 * Configuração de rate limiting específica para uploads
 */
exports.UPLOAD_THROTTLE_CONFIG = {
    default: {
        limit: 10,
        ttl: 60000, // 1 minuto em ms
    },
};
/**
 * Configuração de rate limiting específica para API geral
 */
exports.API_THROTTLE_CONFIG = {
    default: {
        limit: 200,
        ttl: 60000, // 1 minuto em ms
    },
};
/**
 * Utilitário para obter IP real do cliente considerando proxies
 */
const getClientIp = (request) => {
    return (request.headers['x-forwarded-for']?.split(',')[0] ||
        request.headers['x-real-ip'] ||
        request.connection?.remoteAddress ||
        request.socket?.remoteAddress ||
        request.ip ||
        'unknown');
};
exports.getClientIp = getClientIp;
/**
 * Configuração de headers de resposta para rate limiting
 */
exports.RATE_LIMIT_HEADERS = {
    LIMIT: 'X-RateLimit-Limit',
    REMAINING: 'X-RateLimit-Remaining',
    RESET: 'X-RateLimit-Reset',
    RETRY_AFTER: 'Retry-After',
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGNvbmZpZ1xcdGhyb3R0bGVyLmNvbmZpZy50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQTs7Ozs7Ozs7O0dBU0c7QUFDSSxNQUFNLHFCQUFxQixHQUFHLENBQ25DLGFBQTRCLEVBQ0osRUFBRTtJQUMxQixNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFTLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVyRSx5REFBeUQ7SUFDekQsTUFBTSxNQUFNLEdBQTJCO1FBQ3JDLFVBQVUsRUFBRTtZQUNWO2dCQUNFLElBQUksRUFBRSxTQUFTO2dCQUNmLEdBQUcsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLGNBQWMsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsb0JBQW9CO2dCQUMvRSxLQUFLLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxnQkFBZ0IsRUFBRSxHQUFHLENBQUM7YUFDeEQ7WUFDRDtnQkFDRSxJQUFJLEVBQUUsTUFBTTtnQkFDWixHQUFHLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxtQkFBbUIsRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLEVBQUUsWUFBWTtnQkFDN0UsS0FBSyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDLEVBQUUseUJBQXlCO2FBQ3RGO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsR0FBRyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMscUJBQXFCLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLFdBQVc7Z0JBQzdFLEtBQUssRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLHVCQUF1QixFQUFFLEVBQUUsQ0FBQyxFQUFFLHdCQUF3QjthQUN4RjtZQUNEO2dCQUNFLElBQUksRUFBRSxLQUFLO2dCQUNYLEdBQUcsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFTLGtCQUFrQixFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxXQUFXO2dCQUMxRSxLQUFLLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBUyxvQkFBb0IsRUFBRSxHQUFHLENBQUMsRUFBRSwwQkFBMEI7YUFDeEY7U0FDRjtRQUNELE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ2xCLHdEQUF3RDtZQUN4RCxJQUFJLE9BQU8sS0FBSyxhQUFhLEVBQUUsQ0FBQztnQkFDOUIsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FDakMsbUJBQW1CLEVBQ25CLEtBQUssQ0FDTixDQUFDO2dCQUNGLElBQUksU0FBUyxFQUFFLENBQUM7b0JBQ2QsT0FBTyxJQUFJLENBQUM7Z0JBQ2QsQ0FBQztZQUNILENBQUM7WUFFRCwyQkFBMkI7WUFDM0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3BELE1BQU0sYUFBYSxHQUNqQixPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxTQUFTLENBQUM7Z0JBQ2hDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQztnQkFDakMsT0FBTyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFbkMsT0FBTyxhQUFhLENBQUM7UUFDdkIsQ0FBQztRQUNELFlBQVksRUFBRSx1REFBdUQ7S0FDdEUsQ0FBQztJQUVGLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQTJELENBQUMsQ0FBQztJQUN6RSxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7QUF2RFcsUUFBQSxxQkFBcUIseUJBdURoQztBQUVGOztHQUVHO0FBQ1UsUUFBQSxvQkFBb0IsR0FBRztJQUNsQyxPQUFPLEVBQUU7UUFDUCxLQUFLLEVBQUUsQ0FBQztRQUNSLEdBQUcsRUFBRSxNQUFNLEVBQUUsa0JBQWtCO0tBQ2hDO0NBQ0YsQ0FBQztBQUVGOztHQUVHO0FBQ1UsUUFBQSxzQkFBc0IsR0FBRztJQUNwQyxPQUFPLEVBQUU7UUFDUCxLQUFLLEVBQUUsRUFBRTtRQUNULEdBQUcsRUFBRSxLQUFLLEVBQUUsaUJBQWlCO0tBQzlCO0NBQ0YsQ0FBQztBQUVGOztHQUVHO0FBQ1UsUUFBQSxtQkFBbUIsR0FBRztJQUNqQyxPQUFPLEVBQUU7UUFDUCxLQUFLLEVBQUUsR0FBRztRQUNWLEdBQUcsRUFBRSxLQUFLLEVBQUUsaUJBQWlCO0tBQzlCO0NBQ0YsQ0FBQztBQUVGOztHQUVHO0FBQ0ksTUFBTSxXQUFXLEdBQUcsQ0FBQyxPQUFZLEVBQVUsRUFBRTtJQUNsRCxPQUFPLENBQ0wsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDNUIsT0FBTyxDQUFDLFVBQVUsRUFBRSxhQUFhO1FBQ2pDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsYUFBYTtRQUM3QixPQUFPLENBQUMsRUFBRTtRQUNWLFNBQVMsQ0FDVixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBVFcsUUFBQSxXQUFXLGVBU3RCO0FBRUY7O0dBRUc7QUFDVSxRQUFBLGtCQUFrQixHQUFHO0lBQ2hDLEtBQUssRUFBRSxtQkFBbUI7SUFDMUIsU0FBUyxFQUFFLHVCQUF1QjtJQUNsQyxLQUFLLEVBQUUsbUJBQW1CO0lBQzFCLFdBQVcsRUFBRSxhQUFhO0NBQzNCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGNvbmZpZ1xcdGhyb3R0bGVyLmNvbmZpZy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgVGhyb3R0bGVyTW9kdWxlT3B0aW9ucyB9IGZyb20gJ0BuZXN0anMvdGhyb3R0bGVyJztcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBkbyBSYXRlIExpbWl0aW5nIHBhcmEgbyBTaXN0ZW1hIFNFTVRBU1xuICpcbiAqIEltcGxlbWVudGEgZGlmZXJlbnRlcyBsaW1pdGVzIHBhcmEgZGlmZXJlbnRlcyB0aXBvcyBkZSBlbmRwb2ludHM6XG4gKiAtIEF1dGVudGljYcOnw6NvOiBNYWlzIHJlc3RyaXRpdm8gcGFyYSBwcmV2ZW5pciBhdGFxdWVzIGRlIGZvcsOnYSBicnV0YVxuICogLSBBUEkgR2VyYWw6IExpbWl0ZSBwYWRyw6NvIHBhcmEgb3BlcmHDp8O1ZXMgbm9ybWFpc1xuICogLSBVcGxvYWQ6IExpbWl0ZSBlc3BlY8OtZmljbyBwYXJhIHVwbG9hZHMgZGUgZG9jdW1lbnRvc1xuICpcbiAqIFV0aWxpemEgUmVkaXMgY29tbyBzdG9yYWdlIHBhcmEgcGVybWl0aXIgcmF0ZSBsaW1pdGluZyBkaXN0cmlidcOtZG9cbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVRocm90dGxlckNvbmZpZyA9IChcbiAgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSxcbik6IFRocm90dGxlck1vZHVsZU9wdGlvbnMgPT4ge1xuICBjb25zdCBub2RlRW52ID0gY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignTk9ERV9FTlYnLCAnZGV2ZWxvcG1lbnQnKTtcblxuICAvLyBDb25maWd1cmHDp8OjbyBkbyB0aHJvdHRsZXIgY29tIGFybWF6ZW5hbWVudG8gZW0gbWVtw7NyaWFcbiAgY29uc3QgY29uZmlnOiBUaHJvdHRsZXJNb2R1bGVPcHRpb25zID0ge1xuICAgIHRocm90dGxlcnM6IFtcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ2RlZmF1bHQnLFxuICAgICAgICB0dGw6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ1RIUk9UVExFX1RUTCcsIDYwKSAqIDEwMDAsIC8vIENvbnZlcnRlciBwYXJhIG1zXG4gICAgICAgIGxpbWl0OiBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdUSFJPVFRMRV9MSU1JVCcsIDEwMCksXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBuYW1lOiAnYXV0aCcsXG4gICAgICAgIHR0bDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfQVVUSF9UVEwnLCAzMDApICogMTAwMCwgLy8gNSBtaW51dG9zXG4gICAgICAgIGxpbWl0OiBjb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdUSFJPVFRMRV9BVVRIX0xJTUlUJywgNSksIC8vIDUgdGVudGF0aXZhcyBwb3IgNSBtaW5cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICd1cGxvYWQnLFxuICAgICAgICB0dGw6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ1RIUk9UVExFX1VQTE9BRF9UVEwnLCA2MCkgKiAxMDAwLCAvLyAxIG1pbnV0b1xuICAgICAgICBsaW1pdDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfVVBMT0FEX0xJTUlUJywgMTApLCAvLyAxMCB1cGxvYWRzIHBvciBtaW51dG9cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdhcGknLFxuICAgICAgICB0dGw6IGNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ1RIUk9UVExFX0FQSV9UVEwnLCA2MCkgKiAxMDAwLCAvLyAxIG1pbnV0b1xuICAgICAgICBsaW1pdDogY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignVEhST1RUTEVfQVBJX0xJTUlUJywgMjAwKSwgLy8gMjAwIHJlcXVlc3RzIHBvciBtaW51dG9cbiAgICAgIH0sXG4gICAgXSxcbiAgICBza2lwSWY6IChjb250ZXh0KSA9PiB7XG4gICAgICAvLyBQdWxhciByYXRlIGxpbWl0aW5nIGVtIGRlc2Vudm9sdmltZW50byBzZSBjb25maWd1cmFkb1xuICAgICAgaWYgKG5vZGVFbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgY29uc3Qgc2tpcEluRGV2ID0gY29uZmlnU2VydmljZS5nZXQ8Ym9vbGVhbj4oXG4gICAgICAgICAgJ1RIUk9UVExFX1NLSVBfREVWJyxcbiAgICAgICAgICBmYWxzZSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHNraXBJbkRldikge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFB1bGFyIHBhcmEgaGVhbHRoIGNoZWNrc1xuICAgICAgY29uc3QgcmVxdWVzdCA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdCgpO1xuICAgICAgY29uc3QgaXNIZWFsdGhDaGVjayA9XG4gICAgICAgIHJlcXVlc3QudXJsPy5pbmNsdWRlcygnL2hlYWx0aCcpIHx8XG4gICAgICAgIHJlcXVlc3QudXJsPy5pbmNsdWRlcygnL21ldHJpY3MnKSB8fFxuICAgICAgICByZXF1ZXN0LnVybD8uaW5jbHVkZXMoJy9zdGF0dXMnKTtcblxuICAgICAgcmV0dXJuIGlzSGVhbHRoQ2hlY2s7XG4gICAgfSxcbiAgICBlcnJvck1lc3NhZ2U6ICdNdWl0YXMgdGVudGF0aXZhcy4gVGVudGUgbm92YW1lbnRlIGVtIGFsZ3VucyBtaW51dG9zLicsXG4gIH07XG5cbiAgY29uc29sZS5sb2coJ+KEue+4jyBSYXRlIGxpbWl0aW5nIGNvbmZpZ3VyYWRvIGNvbSBhcm1hemVuYW1lbnRvIGVtIG1lbcOzcmlhJyk7XG4gIHJldHVybiBjb25maWc7XG59O1xuXG4vKipcbiAqIENvbmZpZ3VyYcOnw6NvIGRlIHJhdGUgbGltaXRpbmcgZXNwZWPDrWZpY2EgcGFyYSBlbmRwb2ludHMgZGUgYXV0ZW50aWNhw6fDo29cbiAqL1xuZXhwb3J0IGNvbnN0IEFVVEhfVEhST1RUTEVfQ09ORklHID0ge1xuICBkZWZhdWx0OiB7XG4gICAgbGltaXQ6IDUsXG4gICAgdHRsOiAzMDAwMDAsIC8vIDUgbWludXRvcyBlbSBtc1xuICB9LFxufTtcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBkZSByYXRlIGxpbWl0aW5nIGVzcGVjw61maWNhIHBhcmEgdXBsb2Fkc1xuICovXG5leHBvcnQgY29uc3QgVVBMT0FEX1RIUk9UVExFX0NPTkZJRyA9IHtcbiAgZGVmYXVsdDoge1xuICAgIGxpbWl0OiAxMCxcbiAgICB0dGw6IDYwMDAwLCAvLyAxIG1pbnV0byBlbSBtc1xuICB9LFxufTtcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBkZSByYXRlIGxpbWl0aW5nIGVzcGVjw61maWNhIHBhcmEgQVBJIGdlcmFsXG4gKi9cbmV4cG9ydCBjb25zdCBBUElfVEhST1RUTEVfQ09ORklHID0ge1xuICBkZWZhdWx0OiB7XG4gICAgbGltaXQ6IDIwMCxcbiAgICB0dGw6IDYwMDAwLCAvLyAxIG1pbnV0byBlbSBtc1xuICB9LFxufTtcblxuLyoqXG4gKiBVdGlsaXTDoXJpbyBwYXJhIG9idGVyIElQIHJlYWwgZG8gY2xpZW50ZSBjb25zaWRlcmFuZG8gcHJveGllc1xuICovXG5leHBvcnQgY29uc3QgZ2V0Q2xpZW50SXAgPSAocmVxdWVzdDogYW55KTogc3RyaW5nID0+IHtcbiAgcmV0dXJuIChcbiAgICByZXF1ZXN0LmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddPy5zcGxpdCgnLCcpWzBdIHx8XG4gICAgcmVxdWVzdC5oZWFkZXJzWyd4LXJlYWwtaXAnXSB8fFxuICAgIHJlcXVlc3QuY29ubmVjdGlvbj8ucmVtb3RlQWRkcmVzcyB8fFxuICAgIHJlcXVlc3Quc29ja2V0Py5yZW1vdGVBZGRyZXNzIHx8XG4gICAgcmVxdWVzdC5pcCB8fFxuICAgICd1bmtub3duJ1xuICApO1xufTtcblxuLyoqXG4gKiBDb25maWd1cmHDp8OjbyBkZSBoZWFkZXJzIGRlIHJlc3Bvc3RhIHBhcmEgcmF0ZSBsaW1pdGluZ1xuICovXG5leHBvcnQgY29uc3QgUkFURV9MSU1JVF9IRUFERVJTID0ge1xuICBMSU1JVDogJ1gtUmF0ZUxpbWl0LUxpbWl0JyxcbiAgUkVNQUlOSU5HOiAnWC1SYXRlTGltaXQtUmVtYWluaW5nJyxcbiAgUkVTRVQ6ICdYLVJhdGVMaW1pdC1SZXNldCcsXG4gIFJFVFJZX0FGVEVSOiAnUmV0cnktQWZ0ZXInLFxufTtcbiJdLCJ2ZXJzaW9uIjozfQ==