2caf45866f5f25e4562ba55208deac56
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MimeTypeValidator = void 0;
const common_1 = require("@nestjs/common");
const file_type_1 = __importDefault(require("file-type"));
const documento_config_1 = require("../config/documento.config");
const crypto = __importStar(require("crypto"));
let MimeTypeValidator = class MimeTypeValidator {
    /**
     * Valida o tipo MIME de um arquivo com verificações de segurança avançadas
     */
    async validateMimeType(buffer, declaredMimeType, originalFilename, fileSize) {
        try {
            const fileExtension = this.extractFileExtension(originalFilename);
            const securityFlags = {
                isSuspicious: false,
                hasEmbeddedContent: false,
                exceedsMaxSize: false,
                hasDangerousExtension: false,
                isBlockedMimeType: false,
                magicNumberMismatch: false,
            };
            // 1. Verificar extensão perigosa
            if (documento_config_1.BLOCKED_EXTENSIONS.includes(fileExtension)) {
                securityFlags.hasDangerousExtension = true;
                return {
                    isValid: false,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Extensão de arquivo não permitida: .${fileExtension}`,
                };
            }
            // 2. Verificar tipo MIME bloqueado
            if (documento_config_1.BLOCKED_MIME_TYPES.includes(declaredMimeType)) {
                securityFlags.isBlockedMimeType = true;
                return {
                    isValid: false,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Tipo MIME bloqueado por motivos de segurança: ${declaredMimeType}`,
                };
            }
            // 3. Detectar o tipo real do arquivo usando magic numbers
            const fileTypeResult = await file_type_1.default.fromBuffer(buffer);
            if (!fileTypeResult && documento_config_1.SECURITY_CONFIG.VERIFY_MAGIC_NUMBERS) {
                // Para alguns tipos como text/plain, file-type pode não detectar
                if (declaredMimeType !== 'text/plain') {
                    return {
                        isValid: false,
                        declaredMimeType,
                        fileExtension,
                        fileSize,
                        securityFlags,
                        message: 'Não foi possível verificar a assinatura do arquivo',
                    };
                }
            }
            const detectedMimeType = fileTypeResult?.mime || declaredMimeType;
            // 4. Verificar se o tipo detectado está na lista de permitidos
            if (!(0, documento_config_1.isMimeTypePermitido)(detectedMimeType)) {
                return {
                    isValid: false,
                    detectedMimeType,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Tipo de arquivo não permitido: ${detectedMimeType}`,
                };
            }
            // 5. Verificar correspondência entre tipo declarado e detectado
            if (fileTypeResult && declaredMimeType !== detectedMimeType) {
                securityFlags.magicNumberMismatch = true;
                return {
                    isValid: false,
                    detectedMimeType,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Tipo declarado (${declaredMimeType}) não corresponde ao tipo real (${detectedMimeType})`,
                };
            }
            // 6. Verificar tamanho do arquivo
            const maxSize = (0, documento_config_1.getMaxFileSize)(detectedMimeType);
            if (fileSize > maxSize) {
                securityFlags.exceedsMaxSize = true;
                return {
                    isValid: false,
                    detectedMimeType,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Arquivo excede o tamanho máximo permitido: ${fileSize} bytes > ${maxSize} bytes`,
                };
            }
            // 7. Verificar tamanho global
            if (fileSize > documento_config_1.SECURITY_CONFIG.MAX_FILE_SIZE) {
                securityFlags.exceedsMaxSize = true;
                return {
                    isValid: false,
                    detectedMimeType,
                    declaredMimeType,
                    fileExtension,
                    fileSize,
                    securityFlags,
                    message: `Arquivo excede o tamanho máximo global: ${fileSize} bytes > ${documento_config_1.SECURITY_CONFIG.MAX_FILE_SIZE} bytes`,
                };
            }
            // 8. Verificações de conteúdo suspeito
            if (documento_config_1.SECURITY_CONFIG.SCAN_CONTENT) {
                const contentAnalysis = this.analyzeFileContent(buffer, detectedMimeType);
                if (contentAnalysis.isSuspicious) {
                    securityFlags.isSuspicious = true;
                    securityFlags.hasEmbeddedContent = contentAnalysis.hasEmbeddedContent;
                    if (documento_config_1.SECURITY_CONFIG.QUARANTINE_SUSPICIOUS) {
                        return {
                            isValid: false,
                            detectedMimeType,
                            declaredMimeType,
                            fileExtension,
                            fileSize,
                            securityFlags,
                            message: `Arquivo contém conteúdo suspeito: ${contentAnalysis.reason}`,
                        };
                    }
                }
            }
            return {
                isValid: true,
                detectedMimeType,
                declaredMimeType,
                fileExtension,
                fileSize,
                securityFlags,
            };
        }
        catch (error) {
            return {
                isValid: false,
                declaredMimeType,
                fileExtension: this.extractFileExtension(originalFilename),
                fileSize,
                message: `Erro na validação do tipo MIME: ${error.message}`,
            };
        }
    }
    /**
     * Extrai a extensão do arquivo
     */
    extractFileExtension(filename) {
        const parts = filename.toLowerCase().split('.');
        return parts.length > 1 ? parts[parts.length - 1] : '';
    }
    /**
     * Analisa o conteúdo do arquivo em busca de padrões suspeitos
     */
    analyzeFileContent(buffer, mimeType) {
        const content = buffer.toString('utf8', 0, Math.min(buffer.length, 1024)); // Primeiros 1KB
        // Padrões suspeitos comuns
        const suspiciousPatterns = [
            /<script[^>]*>/i, // Tags de script
            /javascript:/i, // URLs javascript
            /vbscript:/i, // URLs vbscript
            /on\w+\s*=/i, // Event handlers (onclick, onload, etc.)
            /%3Cscript/i, // Script tags codificados
            /\x00/, // Null bytes
            /\\x[0-9a-f]{2}/i, // Sequências de escape hexadecimal
        ];
        // Verificar padrões suspeitos
        for (const pattern of suspiciousPatterns) {
            if (pattern.test(content)) {
                return {
                    isSuspicious: true,
                    hasEmbeddedContent: true,
                    reason: `Padrão suspeito detectado: ${pattern.source}`,
                };
            }
        }
        // Verificações específicas por tipo MIME
        if (mimeType === 'application/pdf') {
            // PDFs podem conter JavaScript
            if (content.includes('/JavaScript') || content.includes('/JS')) {
                return {
                    isSuspicious: true,
                    hasEmbeddedContent: true,
                    reason: 'PDF contém JavaScript incorporado',
                };
            }
        }
        // Verificar densidade de caracteres não-ASCII (possível ofuscação)
        const nonAsciiCount = (content.match(/[\x80-\xFF]/g) || []).length;
        const nonAsciiRatio = nonAsciiCount / content.length;
        if (nonAsciiRatio > 0.3 && mimeType.startsWith('text/')) {
            return {
                isSuspicious: true,
                hasEmbeddedContent: false,
                reason: 'Alta densidade de caracteres não-ASCII em arquivo de texto',
            };
        }
        return {
            isSuspicious: false,
            hasEmbeddedContent: false,
        };
    }
    /**
     * Gera hash do arquivo para detecção de duplicatas e verificação de integridade
     */
    generateFileHash(buffer) {
        return crypto.createHash('sha256').update(buffer).digest('hex');
    }
    /**
     * Verifica se o arquivo requer criptografia
     */
    requiresEncryption(mimeType) {
        return (0, documento_config_1.requiresEncryption)(mimeType);
    }
    /**
     * Verifica se é possível gerar thumbnail
     */
    allowsThumbnail(mimeType) {
        return (0, documento_config_1.allowsThumbnail)(mimeType);
    }
};
exports.MimeTypeValidator = MimeTypeValidator;
exports.MimeTypeValidator = MimeTypeValidator = __decorate([
    (0, common_1.Injectable)()
], MimeTypeValidator);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGRvY3VtZW50b1xcdmFsaWRhdG9yc1xcbWltZS10eXBlLnZhbGlkYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMsMERBQWlDO0FBQ2pDLGlFQVNvQztBQUNwQywrQ0FBaUM7QUFzQjFCLElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQzVCOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGdCQUFnQixDQUNwQixNQUFjLEVBQ2QsZ0JBQXdCLEVBQ3hCLGdCQUF3QixFQUN4QixRQUFnQjtRQUVoQixJQUFJLENBQUM7WUFDSCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNsRSxNQUFNLGFBQWEsR0FBa0I7Z0JBQ25DLFlBQVksRUFBRSxLQUFLO2dCQUNuQixrQkFBa0IsRUFBRSxLQUFLO2dCQUN6QixjQUFjLEVBQUUsS0FBSztnQkFDckIscUJBQXFCLEVBQUUsS0FBSztnQkFDNUIsaUJBQWlCLEVBQUUsS0FBSztnQkFDeEIsbUJBQW1CLEVBQUUsS0FBSzthQUMzQixDQUFDO1lBRUYsaUNBQWlDO1lBQ2pDLElBQUkscUNBQWtCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7Z0JBQy9DLGFBQWEsQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUM7Z0JBQzNDLE9BQU87b0JBQ0wsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsZ0JBQWdCO29CQUNoQixhQUFhO29CQUNiLFFBQVE7b0JBQ1IsYUFBYTtvQkFDYixPQUFPLEVBQUUsdUNBQXVDLGFBQWEsRUFBRTtpQkFDaEUsQ0FBQztZQUNKLENBQUM7WUFFRCxtQ0FBbUM7WUFDbkMsSUFBSSxxQ0FBa0IsQ0FBQyxRQUFRLENBQUMsZ0JB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QUFDLENBQUMsTUFBTSxDQUFDO1FBQ25FLE1BQU0sYUFBYSxHQUFHLGFBQWEsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRXJELElBQUksYUFBYSxHQUFHLEdBQUcsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDeEQsT0FBTztnQkFDTCxZQUFZLEVBQUUsSUFBSTtnQkFDbEIsa0JBQWtCLEVBQUUsS0FBSztnQkFDekIsTUFBTSxFQUFFLDREQUE0RDthQUNyRSxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU87WUFDTCxZQUFZLEVBQUUsS0FBSztZQUNuQixrQkFBa0IsRUFBRSxLQUFLO1NBQzFCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FBQyxNQUFjO1FBQzdCLE9BQU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQixDQUFDLFFBQWdCO1FBQ2pDLE9BQU8sSUFBQSxxQ0FBa0IsRUFBQyxRQUFRLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlLENBQUMsUUFBZ0I7UUFDOUIsT0FBTyxJQUFBLGtDQUFlLEVBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztDQUNGLENBQUE7QUFsUVksOENBQWlCOzRCQUFqQixpQkFBaUI7SUFEN0IsSUFBQSxtQkFBVSxHQUFFO0dBQ0EsaUJBQWlCLENBa1E3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcZG9jdW1lbnRvXFx2YWxpZGF0b3JzXFxtaW1lLXR5cGUudmFsaWRhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgZmlsZVR5cGUgZnJvbSAnZmlsZS10eXBlJztcbmltcG9ydCB7XG4gIE1JTUVfVFlQRV9DT05GSUdTLFxuICBCTE9DS0VEX01JTUVfVFlQRVMsXG4gIEJMT0NLRURfRVhURU5TSU9OUyxcbiAgU0VDVVJJVFlfQ09ORklHLFxuICBpc01pbWVUeXBlUGVybWl0aWRvLFxuICBnZXRNYXhGaWxlU2l6ZSxcbiAgcmVxdWlyZXNFbmNyeXB0aW9uLFxuICBhbGxvd3NUaHVtYm5haWwsXG59IGZyb20gJy4uL2NvbmZpZy9kb2N1bWVudG8uY29uZmlnJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1pbWVUeXBlVmFsaWRhdGlvblJlc3VsdCB7XG4gIGlzVmFsaWQ6IGJvb2xlYW47XG4gIGRldGVjdGVkTWltZVR5cGU/OiBzdHJpbmc7XG4gIGRlY2xhcmVkTWltZVR5cGU/OiBzdHJpbmc7XG4gIGZpbGVFeHRlbnNpb24/OiBzdHJpbmc7XG4gIGZpbGVTaXplPzogbnVtYmVyO1xuICBzZWN1cml0eUZsYWdzPzogU2VjdXJpdHlGbGFncztcbiAgbWVzc2FnZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZWN1cml0eUZsYWdzIHtcbiAgaXNTdXNwaWNpb3VzOiBib29sZWFuO1xuICBoYXNFbWJlZGRlZENvbnRlbnQ6IGJvb2xlYW47XG4gIGV4Y2VlZHNNYXhTaXplOiBib29sZWFuO1xuICBoYXNEYW5nZXJvdXNFeHRlbnNpb246IGJvb2xlYW47XG4gIGlzQmxvY2tlZE1pbWVUeXBlOiBib29sZWFuO1xuICBtYWdpY051bWJlck1pc21hdGNoOiBib29sZWFuO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTWltZVR5cGVWYWxpZGF0b3Ige1xuICAvKipcbiAgICogVmFsaWRhIG8gdGlwbyBNSU1FIGRlIHVtIGFycXVpdm8gY29tIHZlcmlmaWNhw6fDtWVzIGRlIHNlZ3VyYW7Dp2EgYXZhbsOnYWRhc1xuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVNaW1lVHlwZShcbiAgICBidWZmZXI6IEJ1ZmZlcixcbiAgICBkZWNsYXJlZE1pbWVUeXBlOiBzdHJpbmcsXG4gICAgb3JpZ2luYWxGaWxlbmFtZTogc3RyaW5nLFxuICAgIGZpbGVTaXplOiBudW1iZXIsXG4gICk6IFByb21pc2U8TWltZVR5cGVWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVFeHRlbnNpb24gPSB0aGlzLmV4dHJhY3RGaWxlRXh0ZW5zaW9uKG9yaWdpbmFsRmlsZW5hbWUpO1xuICAgICAgY29uc3Qgc2VjdXJpdHlGbGFnczogU2VjdXJpdHlGbGFncyA9IHtcbiAgICAgICAgaXNTdXNwaWNpb3VzOiBmYWxzZSxcbiAgICAgICAgaGFzRW1iZWRkZWRDb250ZW50OiBmYWxzZSxcbiAgICAgICAgZXhjZWVkc01heFNpemU6IGZhbHNlLFxuICAgICAgICBoYXNEYW5nZXJvdXNFeHRlbnNpb246IGZhbHNlLFxuICAgICAgICBpc0Jsb2NrZWRNaW1lVHlwZTogZmFsc2UsXG4gICAgICAgIG1hZ2ljTnVtYmVyTWlzbWF0Y2g6IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgLy8gMS4gVmVyaWZpY2FyIGV4dGVuc8OjbyBwZXJpZ29zYVxuICAgICAgaWYgKEJMT0NLRURfRVhURU5TSU9OUy5pbmNsdWRlcyhmaWxlRXh0ZW5zaW9uKSkge1xuICAgICAgICBzZWN1cml0eUZsYWdzLmhhc0Rhbmdlcm91c0V4dGVuc2lvbiA9IHRydWU7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgZGVjbGFyZWRNaW1lVHlwZSxcbiAgICAgICAgICBmaWxlRXh0ZW5zaW9uLFxuICAgICAgICAgIGZpbGVTaXplLFxuICAgICAgICAgIHNlY3VyaXR5RmxhZ3MsXG4gICAgICAgICAgbWVzc2FnZTogYEV4dGVuc8OjbyBkZSBhcnF1aXZvIG7Do28gcGVybWl0aWRhOiAuJHtmaWxlRXh0ZW5zaW9ufWAsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIDIuIFZlcmlmaWNhciB0aXBvIE1JTUUgYmxvcXVlYWRvXG4gICAgICBpZiAoQkxPQ0tFRF9NSU1FX1RZUEVTLmluY2x1ZGVzKGRlY2xhcmVkTWltZVR5cGUpKSB7XG4gICAgICAgIHNlY3VyaXR5RmxhZ3MuaXNCbG9ja2VkTWltZVR5cGUgPSB0cnVlO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGRlY2xhcmVkTWltZVR5cGUsXG4gICAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICBmaWxlU2l6ZSxcbiAgICAgICAgICBzZWN1cml0eUZsYWdzLFxuICAgICAgICAgIG1lc3NhZ2U6IGBUaXBvIE1JTUUgYmxvcXVlYWRvIHBvciBtb3Rpdm9zIGRlIHNlZ3VyYW7Dp2E6ICR7ZGVjbGFyZWRNaW1lVHlwZX1gLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyAzLiBEZXRlY3RhciBvIHRpcG8gcmVhbCBkbyBhcnF1aXZvIHVzYW5kbyBtYWdpYyBudW1iZXJzXG4gICAgICBjb25zdCBmaWxlVHlwZVJlc3VsdCA9IGF3YWl0IGZpbGVUeXBlLmZyb21CdWZmZXIoYnVmZmVyKTtcblxuICAgICAgaWYgKCFmaWxlVHlwZVJlc3VsdCAmJiBTRUNVUklUWV9DT05GSUcuVkVSSUZZX01BR0lDX05VTUJFUlMpIHtcbiAgICAgICAgLy8gUGFyYSBhbGd1bnMgdGlwb3MgY29tbyB0ZXh0L3BsYWluLCBmaWxlLXR5cGUgcG9kZSBuw6NvIGRldGVjdGFyXG4gICAgICAgIGlmIChkZWNsYXJlZE1pbWVUeXBlICE9PSAndGV4dC9wbGFpbicpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgICBkZWNsYXJlZE1pbWVUeXBlLFxuICAgICAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICAgIGZpbGVTaXplLFxuICAgICAgICAgICAgc2VjdXJpdHlGbGFncyxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdOw6NvIGZvaSBwb3Nzw612ZWwgdmVyaWZpY2FyIGEgYXNzaW5hdHVyYSBkbyBhcnF1aXZvJyxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRldGVjdGVkTWltZVR5cGUgPSBmaWxlVHlwZVJlc3VsdD8ubWltZSB8fCBkZWNsYXJlZE1pbWVUeXBlO1xuXG4gICAgICAvLyA0LiBWZXJpZmljYXIgc2UgbyB0aXBvIGRldGVjdGFkbyBlc3TDoSBuYSBsaXN0YSBkZSBwZXJtaXRpZG9zXG4gICAgICBpZiAoIWlzTWltZVR5cGVQZXJtaXRpZG8oZGV0ZWN0ZWRNaW1lVHlwZSkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBkZXRlY3RlZE1pbWVUeXBlLFxuICAgICAgICAgIGRlY2xhcmVkTWltZVR5cGUsXG4gICAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICBmaWxlU2l6ZSxcbiAgICAgICAgICBzZWN1cml0eUZsYWdzLFxuICAgICAgICAgIG1lc3NhZ2U6IGBUaXBvIGRlIGFycXVpdm8gbsOjbyBwZXJtaXRpZG86ICR7ZGV0ZWN0ZWRNaW1lVHlwZX1gLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyA1LiBWZXJpZmljYXIgY29ycmVzcG9uZMOqbmNpYSBlbnRyZSB0aXBvIGRlY2xhcmFkbyBlIGRldGVjdGFkb1xuICAgICAgaWYgKGZpbGVUeXBlUmVzdWx0ICYmIGRlY2xhcmVkTWltZVR5cGUgIT09IGRldGVjdGVkTWltZVR5cGUpIHtcbiAgICAgICAgc2VjdXJpdHlGbGFncy5tYWdpY051bWJlck1pc21hdGNoID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBkZXRlY3RlZE1pbWVUeXBlLFxuICAgICAgICAgIGRlY2xhcmVkTWltZVR5cGUsXG4gICAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICBmaWxlU2l6ZSxcbiAgICAgICAgICBzZWN1cml0eUZsYWdzLFxuICAgICAgICAgIG1lc3NhZ2U6IGBUaXBvIGRlY2xhcmFkbyAoJHtkZWNsYXJlZE1pbWVUeXBlfSkgbsOjbyBjb3JyZXNwb25kZSBhbyB0aXBvIHJlYWwgKCR7ZGV0ZWN0ZWRNaW1lVHlwZX0pYCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gNi4gVmVyaWZpY2FyIHRhbWFuaG8gZG8gYXJxdWl2b1xuICAgICAgY29uc3QgbWF4U2l6ZSA9IGdldE1heEZpbGVTaXplKGRldGVjdGVkTWltZVR5cGUpO1xuICAgICAgaWYgKGZpbGVTaXplID4gbWF4U2l6ZSkge1xuICAgICAgICBzZWN1cml0eUZsYWdzLmV4Y2VlZHNNYXhTaXplID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBkZXRlY3RlZE1pbWVUeXBlLFxuICAgICAgICAgIGRlY2xhcmVkTWltZVR5cGUsXG4gICAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICBmaWxlU2l6ZSxcbiAgICAgICAgICBzZWN1cml0eUZsYWdzLFxuICAgICAgICAgIG1lc3NhZ2U6IGBBcnF1aXZvIGV4Y2VkZSBvIHRhbWFuaG8gbcOheGltbyBwZXJtaXRpZG86ICR7ZmlsZVNpemV9IGJ5dGVzID4gJHttYXhTaXplfSBieXRlc2AsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIDcuIFZlcmlmaWNhciB0YW1hbmhvIGdsb2JhbFxuICAgICAgaWYgKGZpbGVTaXplID4gU0VDVVJJVFlfQ09ORklHLk1BWF9GSUxFX1NJWkUpIHtcbiAgICAgICAgc2VjdXJpdHlGbGFncy5leGNlZWRzTWF4U2l6ZSA9IHRydWU7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgZGV0ZWN0ZWRNaW1lVHlwZSxcbiAgICAgICAgICBkZWNsYXJlZE1pbWVUeXBlLFxuICAgICAgICAgIGZpbGVFeHRlbnNpb24sXG4gICAgICAgICAgZmlsZVNpemUsXG4gICAgICAgICAgc2VjdXJpdHlGbGFncyxcbiAgICAgICAgICBtZXNzYWdlOiBgQXJxdWl2byBleGNlZGUgbyB0YW1hbmhvIG3DoXhpbW8gZ2xvYmFsOiAke2ZpbGVTaXplfSBieXRlcyA+ICR7U0VDVVJJVFlfQ09ORklHLk1BWF9GSUxFX1NJWkV9IGJ5dGVzYCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gOC4gVmVyaWZpY2HDp8O1ZXMgZGUgY29udGXDumRvIHN1c3BlaXRvXG4gICAgICBpZiAoU0VDVVJJVFlfQ09ORklHLlNDQU5fQ09OVEVOVCkge1xuICAgICAgICBjb25zdCBjb250ZW50QW5hbHlzaXMgPSB0aGlzLmFuYWx5emVGaWxlQ29udGVudChcbiAgICAgICAgICBidWZmZXIsXG4gICAgICAgICAgZGV0ZWN0ZWRNaW1lVHlwZSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGNvbnRlbnRBbmFseXNpcy5pc1N1c3BpY2lvdXMpIHtcbiAgICAgICAgICBzZWN1cml0eUZsYWdzLmlzU3VzcGljaW91cyA9IHRydWU7XG4gICAgICAgICAgc2VjdXJpdHlGbGFncy5oYXNFbWJlZGRlZENvbnRlbnQgPSBjb250ZW50QW5hbHlzaXMuaGFzRW1iZWRkZWRDb250ZW50O1xuXG4gICAgICAgICAgaWYgKFNFQ1VSSVRZX0NPTkZJRy5RVUFSQU5USU5FX1NVU1BJQ0lPVVMpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgICAgICBkZXRlY3RlZE1pbWVUeXBlLFxuICAgICAgICAgICAgICBkZWNsYXJlZE1pbWVUeXBlLFxuICAgICAgICAgICAgICBmaWxlRXh0ZW5zaW9uLFxuICAgICAgICAgICAgICBmaWxlU2l6ZSxcbiAgICAgICAgICAgICAgc2VjdXJpdHlGbGFncyxcbiAgICAgICAgICAgICAgbWVzc2FnZTogYEFycXVpdm8gY29udMOpbSBjb250ZcO6ZG8gc3VzcGVpdG86ICR7Y29udGVudEFuYWx5c2lzLnJlYXNvbn1gLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNWYWxpZDogdHJ1ZSxcbiAgICAgICAgZGV0ZWN0ZWRNaW1lVHlwZSxcbiAgICAgICAgZGVjbGFyZWRNaW1lVHlwZSxcbiAgICAgICAgZmlsZUV4dGVuc2lvbixcbiAgICAgICAgZmlsZVNpemUsXG4gICAgICAgIHNlY3VyaXR5RmxhZ3MsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgZGVjbGFyZWRNaW1lVHlwZSxcbiAgICAgICAgZmlsZUV4dGVuc2lvbjogdGhpcy5leHRyYWN0RmlsZUV4dGVuc2lvbihvcmlnaW5hbEZpbGVuYW1lKSxcbiAgICAgICAgZmlsZVNpemUsXG4gICAgICAgIG1lc3NhZ2U6IGBFcnJvIG5hIHZhbGlkYcOnw6NvIGRvIHRpcG8gTUlNRTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWkgYSBleHRlbnPDo28gZG8gYXJxdWl2b1xuICAgKi9cbiAgcHJpdmF0ZSBleHRyYWN0RmlsZUV4dGVuc2lvbihmaWxlbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXJ0cyA9IGZpbGVuYW1lLnRvTG93ZXJDYXNlKCkuc3BsaXQoJy4nKTtcbiAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMSA/IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdIDogJyc7XG4gIH1cblxuICAvKipcbiAgICogQW5hbGlzYSBvIGNvbnRlw7pkbyBkbyBhcnF1aXZvIGVtIGJ1c2NhIGRlIHBhZHLDtWVzIHN1c3BlaXRvc1xuICAgKi9cbiAgcHJpdmF0ZSBhbmFseXplRmlsZUNvbnRlbnQoXG4gICAgYnVmZmVyOiBCdWZmZXIsXG4gICAgbWltZVR5cGU6IHN0cmluZyxcbiAgKToge1xuICAgIGlzU3VzcGljaW91czogYm9vbGVhbjtcbiAgICBoYXNFbWJlZGRlZENvbnRlbnQ6IGJvb2xlYW47XG4gICAgcmVhc29uPzogc3RyaW5nO1xuICB9IHtcbiAgICBjb25zdCBjb250ZW50ID0gYnVmZmVyLnRvU3RyaW5nKCd1dGY4JywgMCwgTWF0aC5taW4oYnVmZmVyLmxlbmd0aCwgMTAyNCkpOyAvLyBQcmltZWlyb3MgMUtCXG5cbiAgICAvLyBQYWRyw7VlcyBzdXNwZWl0b3MgY29tdW5zXG4gICAgY29uc3Qgc3VzcGljaW91c1BhdHRlcm5zID0gW1xuICAgICAgLzxzY3JpcHRbXj5dKj4vaSwgLy8gVGFncyBkZSBzY3JpcHRcbiAgICAgIC9qYXZhc2NyaXB0Oi9pLCAvLyBVUkxzIGphdmFzY3JpcHRcbiAgICAgIC92YnNjcmlwdDovaSwgLy8gVVJMcyB2YnNjcmlwdFxuICAgICAgL29uXFx3K1xccyo9L2ksIC8vIEV2ZW50IGhhbmRsZXJzIChvbmNsaWNrLCBvbmxvYWQsIGV0Yy4pXG4gICAgICAvJTNDc2NyaXB0L2ksIC8vIFNjcmlwdCB0YWdzIGNvZGlmaWNhZG9zXG4gICAgICAvXFx4MDAvLCAvLyBOdWxsIGJ5dGVzXG4gICAgICAvXFxcXHhbMC05YS1mXXsyfS9pLCAvLyBTZXF1w6puY2lhcyBkZSBlc2NhcGUgaGV4YWRlY2ltYWxcbiAgICBdO1xuXG4gICAgLy8gVmVyaWZpY2FyIHBhZHLDtWVzIHN1c3BlaXRvc1xuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBzdXNwaWNpb3VzUGF0dGVybnMpIHtcbiAgICAgIGlmIChwYXR0ZXJuLnRlc3QoY29udGVudCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1N1c3BpY2lvdXM6IHRydWUsXG4gICAgICAgICAgaGFzRW1iZWRkZWRDb250ZW50OiB0cnVlLFxuICAgICAgICAgIHJlYXNvbjogYFBhZHLDo28gc3VzcGVpdG8gZGV0ZWN0YWRvOiAke3BhdHRlcm4uc291cmNlfWAsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2HDp8O1ZXMgZXNwZWPDrWZpY2FzIHBvciB0aXBvIE1JTUVcbiAgICBpZiAobWltZVR5cGUgPT09ICdhcHBsaWNhdGlvbi9wZGYnKSB7XG4gICAgICAvLyBQREZzIHBvZGVtIGNvbnRlciBKYXZhU2NyaXB0XG4gICAgICBpZiAoY29udGVudC5pbmNsdWRlcygnL0phdmFTY3JpcHQnKSB8fCBjb250ZW50LmluY2x1ZGVzKCcvSlMnKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzU3VzcGljaW91czogdHJ1ZSxcbiAgICAgICAgICBoYXNFbWJlZGRlZENvbnRlbnQ6IHRydWUsXG4gICAgICAgICAgcmVhc29uOiAnUERGIGNvbnTDqW0gSmF2YVNjcmlwdCBpbmNvcnBvcmFkbycsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIGRlbnNpZGFkZSBkZSBjYXJhY3RlcmVzIG7Do28tQVNDSUkgKHBvc3PDrXZlbCBvZnVzY2HDp8OjbylcbiAgICBjb25zdCBub25Bc2NpaUNvdW50ID0gKGNvbnRlbnQubWF0Y2goL1tcXHg4MC1cXHhGRl0vZykgfHwgW10pLmxlbmd0aDtcbiAgICBjb25zdCBub25Bc2NpaVJhdGlvID0gbm9uQXNjaWlDb3VudCAvIGNvbnRlbnQubGVuZ3RoO1xuXG4gICAgaWYgKG5vbkFzY2lpUmF0aW8gPiAwLjMgJiYgbWltZVR5cGUuc3RhcnRzV2l0aCgndGV4dC8nKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNTdXNwaWNpb3VzOiB0cnVlLFxuICAgICAgICBoYXNFbWJlZGRlZENvbnRlbnQ6IGZhbHNlLFxuICAgICAgICByZWFzb246ICdBbHRhIGRlbnNpZGFkZSBkZSBjYXJhY3RlcmVzIG7Do28tQVNDSUkgZW0gYXJxdWl2byBkZSB0ZXh0bycsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc1N1c3BpY2lvdXM6IGZhbHNlLFxuICAgICAgaGFzRW1iZWRkZWRDb250ZW50OiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdlcmEgaGFzaCBkbyBhcnF1aXZvIHBhcmEgZGV0ZWPDp8OjbyBkZSBkdXBsaWNhdGFzIGUgdmVyaWZpY2HDp8OjbyBkZSBpbnRlZ3JpZGFkZVxuICAgKi9cbiAgZ2VuZXJhdGVGaWxlSGFzaChidWZmZXI6IEJ1ZmZlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoYnVmZmVyKS5kaWdlc3QoJ2hleCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gYXJxdWl2byByZXF1ZXIgY3JpcHRvZ3JhZmlhXG4gICAqL1xuICByZXF1aXJlc0VuY3J5cHRpb24obWltZVR5cGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiByZXF1aXJlc0VuY3J5cHRpb24obWltZVR5cGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIMOpIHBvc3PDrXZlbCBnZXJhciB0aHVtYm5haWxcbiAgICovXG4gIGFsbG93c1RodW1ibmFpbChtaW1lVHlwZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGFsbG93c1RodW1ibmFpbChtaW1lVHlwZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==