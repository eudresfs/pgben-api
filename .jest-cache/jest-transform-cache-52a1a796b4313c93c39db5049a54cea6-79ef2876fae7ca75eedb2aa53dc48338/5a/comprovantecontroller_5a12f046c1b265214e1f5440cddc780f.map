{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\pagamento\\controllers\\comprovante.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\pagamento\\controllers\\comprovante.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Delete,\n  Param,\n  ParseUUIDPipe,\n  UseInterceptors,\n  UploadedFile,\n  BadRequestException,\n  Body,\n  Res,\n  UseGuards,\n  NotFoundException,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport {\n  ApiConsumes,\n  ApiOperation,\n  ApiParam,\n  ApiResponse,\n  ApiTags,\n} from '@nestjs/swagger';\nimport { ComprovanteService } from '../services/comprovante.service';\nimport { ComprovanteUploadDto } from '../dtos/comprovante-upload.dto';\nimport { ComprovanteResponseDto } from '../dtos/comprovante-response.dto';\nimport { Response } from 'express';\n\n/**\n * Controller para gerenciamento de comprovantes de pagamento\n *\n * Implementa endpoints para upload, visualização e remoção de\n * documentos comprobatórios anexados aos pagamentos.\n *\n * @author Equipe PGBen\n */\n@ApiTags('Pagamentos')\n@Controller('pagamentos/:pagamentoId/comprovantes')\nexport class ComprovanteController {\n  constructor(private readonly comprovanteService: ComprovanteService) {}\n\n  /**\n   * Lista todos os comprovantes associados a um pagamento\n   */\n  @Get()\n  @ApiOperation({ summary: 'Lista comprovantes para um determinado pagamento' })\n  @ApiParam({\n    name: 'pagamentoId',\n    type: 'string',\n    description: 'ID do pagamento',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Lista de comprovantes',\n    type: [ComprovanteResponseDto],\n  })\n  @ApiResponse({ status: 404, description: 'Pagamento não encontrado' })\n  @ApiResponse({ status: 403, description: 'Acesso negado' })\n  // @UseGuards(RolesGuard)\n  // @Roles('admin', 'gestor_semtas', 'tecnico')\n  async findAll(@Param('pagamentoId', ParseUUIDPipe) pagamentoId: string) {\n    const comprovantes =\n      await this.comprovanteService.findAllByPagamento(pagamentoId);\n\n    // Mapear para DTO de resposta\n    return comprovantes.map((comprovante) => ({\n      id: comprovante.id,\n      pagamentoId: comprovante.pagamento_id,\n      tipoDocumento: comprovante.tipo_documento,\n      nomeArquivo: comprovante.nome_arquivo,\n      tamanho: comprovante.tamanho,\n      mimeType: comprovante.mime_type,\n      dataUpload: comprovante.data_upload,\n      uploadedPor: {\n        id: comprovante.uploaded_por,\n        nome: 'Usuário Responsável', // seria obtido da entidade Usuario\n      },\n    }));\n  }\n\n  /**\n   * Realiza o upload de um comprovante para um pagamento\n   */\n  @Post()\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiConsumes('multipart/form-data')\n  @ApiOperation({\n    summary: 'Realiza upload de um comprovante para um pagamento',\n  })\n  @ApiParam({\n    name: 'pagamentoId',\n    type: 'string',\n    description: 'ID do pagamento',\n  })\n  @ApiResponse({\n    status: 201,\n    description: 'Comprovante enviado com sucesso',\n    type: ComprovanteResponseDto,\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Arquivo inválido ou dados incorretos',\n  })\n  @ApiResponse({ status: 404, description: 'Pagamento não encontrado' })\n  @ApiResponse({ status: 403, description: 'Acesso negado' })\n  // @UseGuards(RolesGuard)\n  // @Roles('admin', 'gestor_semtas', 'tecnico')\n  async uploadComprovante(\n    @Param('pagamentoId', ParseUUIDPipe) pagamentoId: string,\n    @UploadedFile() file: any,\n    @Body() uploadDto: ComprovanteUploadDto,\n    // @CurrentUser() usuario: Usuario\n  ) {\n    if (!file) {\n      throw new BadRequestException('Nenhum arquivo enviado');\n    }\n\n    // Usar o ID do usuário atual\n    const usuarioId = 'placeholder'; // usuario.id;\n\n    const comprovante = await this.comprovanteService.uploadComprovante(\n      pagamentoId,\n      file,\n      uploadDto,\n      usuarioId,\n    );\n\n    // Mapear para DTO de resposta\n    return {\n      id: comprovante.id,\n      pagamentoId: comprovante.pagamento_id,\n      tipoDocumento: comprovante.tipo_documento,\n      nomeArquivo: comprovante.nome_arquivo,\n      tamanho: comprovante.tamanho,\n      mimeType: comprovante.mime_type,\n      dataUpload: comprovante.data_upload,\n      uploadedPor: {\n        id: usuarioId,\n        nome: 'Usuário Responsável', // seria obtido da entidade Usuario\n      },\n    };\n  }\n\n  /**\n   * Obtém um comprovante específico para download\n   */\n  @Get(':id/download')\n  @ApiOperation({ summary: 'Faz download de um comprovante' })\n  @ApiParam({\n    name: 'pagamentoId',\n    type: 'string',\n    description: 'ID do pagamento',\n  })\n  @ApiParam({ name: 'id', type: 'string', description: 'ID do comprovante' })\n  @ApiResponse({ status: 200, description: 'Arquivo enviado com sucesso' })\n  @ApiResponse({ status: 404, description: 'Comprovante não encontrado' })\n  @ApiResponse({ status: 403, description: 'Acesso negado' })\n  // @UseGuards(RolesGuard)\n  // @Roles('admin', 'gestor_semtas', 'tecnico')\n  async downloadComprovante(\n    @Param('id', ParseUUIDPipe) id: string,\n    @Res() res: Response,\n  ) {\n    const { buffer, fileName, mimeType } =\n      await this.comprovanteService.getComprovanteContent(id);\n\n    res.set({\n      'Content-Type': mimeType,\n      'Content-Disposition': `attachment; filename=\"${encodeURIComponent(fileName)}\"`,\n      'Content-Length': buffer.length.toString(),\n    });\n\n    res.end(buffer);\n  }\n\n  /**\n   * Busca um comprovante pelo ID\n   */\n  @Get(':id')\n  @ApiOperation({ summary: 'Busca um comprovante pelo ID' })\n  @ApiParam({\n    name: 'pagamentoId',\n    type: 'string',\n    description: 'ID do pagamento',\n  })\n  @ApiParam({ name: 'id', type: 'string', description: 'ID do comprovante' })\n  @ApiResponse({\n    status: 200,\n    description: 'Comprovante encontrado',\n    type: ComprovanteResponseDto,\n  })\n  @ApiResponse({ status: 404, description: 'Comprovante não encontrado' })\n  @ApiResponse({ status: 403, description: 'Acesso negado' })\n  // @UseGuards(RolesGuard)\n  // @Roles('admin', 'gestor_semtas', 'tecnico')\n  async findOne(@Param('id', ParseUUIDPipe) id: string) {\n    const comprovante = await this.comprovanteService.findOne(id);\n\n    if (!comprovante) {\n      throw new NotFoundException('Comprovante não encontrado');\n    }\n\n    // Mapear para DTO de resposta\n    return {\n      id: comprovante.id,\n      pagamentoId: comprovante.pagamento_id,\n      tipoDocumento: comprovante.tipo_documento,\n      nomeArquivo: comprovante.nome_arquivo,\n      tamanho: comprovante.tamanho,\n      mimeType: comprovante.mime_type,\n      dataUpload: comprovante.data_upload,\n      uploadedPor: {\n        id: comprovante.uploaded_por,\n        nome: 'Usuário Responsável', // seria obtido da entidade Usuario\n      },\n    };\n  }\n\n  /**\n   * Remove um comprovante\n   */\n  @Delete(':id')\n  @ApiOperation({ summary: 'Remove um comprovante' })\n  @ApiParam({\n    name: 'pagamentoId',\n    type: 'string',\n    description: 'ID do pagamento',\n  })\n  @ApiParam({ name: 'id', type: 'string', description: 'ID do comprovante' })\n  @ApiResponse({ status: 200, description: 'Comprovante removido com sucesso' })\n  @ApiResponse({ status: 404, description: 'Comprovante não encontrado' })\n  @ApiResponse({\n    status: 409,\n    description: 'Comprovante não pode ser removido',\n  })\n  @ApiResponse({ status: 403, description: 'Acesso negado' })\n  // @UseGuards(RolesGuard)\n  // @Roles('admin', 'gestor_semtas', 'tecnico')\n  async remove(\n    @Param('id', ParseUUIDPipe) id: string,\n    // @CurrentUser() usuario: Usuario\n  ) {\n    // Usar o ID do usuário atual\n    const usuarioId = 'placeholder'; // usuario.id;\n\n    await this.comprovanteService.removeComprovante(id, usuarioId);\n\n    return { message: 'Comprovante removido com sucesso' };\n  }\n}\n"],"version":3}