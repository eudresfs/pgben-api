{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\entities\\recurso.entity.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\entities\\recurso.entity.ts"],"sourcesContent":["import {\n  Entity,\n  PrimaryGeneratedColumn,\n  Column,\n  CreateDateColumn,\n  UpdateDateColumn,\n  DeleteDateColumn,\n  ManyToOne,\n  JoinColumn,\n  OneToMany,\n  Index,\n  BeforeInsert,\n  AfterUpdate,\n} from 'typeorm';\nimport { IsNotEmpty, IsOptional } from 'class-validator';\nimport { Solicitacao } from './solicitacao.entity';\nimport { Usuario } from './usuario.entity';\nimport { Setor } from './setor.entity';\nimport { RecursoHistorico } from './recurso-historico.entity';\n\nexport enum StatusRecurso {\n  PENDENTE = 'pendente',\n  EM_ANALISE = 'em_analise',\n  DEFERIDO = 'deferido',\n  INDEFERIDO = 'indeferido',\n  CANCELADO = 'cancelado',\n}\n\n@Entity('recurso')\n@Index(['solicitacao_id'])\n@Index(['status'])\n@Index(['status', 'setor_responsavel_id'])\n@Index(['created_at'])\nexport class Recurso {\n  @PrimaryGeneratedColumn('uuid')\n  id: string;\n\n  @Column()\n  @IsNotEmpty({ message: 'Solicitação é obrigatória' })\n  solicitacao_id: string;\n\n  @ManyToOne(() => Solicitacao, { eager: false })\n  @JoinColumn({ name: 'solicitacao_id' })\n  solicitacao: Solicitacao;\n\n  @Column('text')\n  @IsNotEmpty({ message: 'Justificativa é obrigatória' })\n  justificativa: string;\n\n  @Column({\n    type: 'enum',\n    enum: StatusRecurso,\n    enumName: 'status_recurso',\n    default: StatusRecurso.PENDENTE,\n  })\n  status: StatusRecurso;\n\n  @Column({ type: 'timestamp' })\n  @IsNotEmpty({ message: 'Data de criação é obrigatória' })\n  created_at: Date;\n\n  @Column({ type: 'timestamp', nullable: true })\n  data_analise: Date;\n\n  @Column({ nullable: true })\n  analista_id: string;\n\n  @ManyToOne(() => Usuario)\n  @JoinColumn({ name: 'analista_id' })\n  analista: Usuario;\n\n  @Column('text', { nullable: true })\n  @IsOptional()\n  parecer: string;\n\n  @Column('jsonb', { nullable: true })\n  documentos_adicionais: Record<string, any>;\n\n  @Column({ nullable: true, length: 100 })\n  motivo_indeferimento: string;\n\n  @Column({ default: 5 })\n  prazo_analise: number;\n\n  @Column({ nullable: true })\n  setor_responsavel_id: string;\n\n  @ManyToOne(() => Setor)\n  @JoinColumn({ name: 'setor_responsavel_id' })\n  setor_responsavel: Setor;\n\n  @OneToMany(() => RecursoHistorico, (historico) => historico.recurso, {\n    cascade: ['insert', 'update'],\n  })\n  historicos: RecursoHistorico[];\n\n  // Campos para controle de alteração de status\n  @Column({ select: false, insert: false, update: false })\n  private statusAnterior: StatusRecurso;\n\n  @Column({ select: false, insert: false, update: false })\n  private usuarioAlteracao: string;\n\n  @Column({ select: false, insert: false, update: false })\n  private observacaoAlteracao: string;\n\n  @Column({ select: false, insert: false, update: false })\n  private ipUsuario: string;\n\n  /**\n   * Prepara a alteração de status para posterior registro no histórico\n   * @param novoStatus Novo status do recurso\n   * @param usuario ID do usuário que realizou a alteração\n   * @param observacao Observação sobre a alteração\n   * @param ip IP do usuário que realizou a alteração\n   */\n  prepararAlteracaoStatus(\n    novoStatus: StatusRecurso,\n    usuario: string,\n    observacao: string,\n    ip: string,\n  ) {\n    this.statusAnterior = this.status;\n    this.status = novoStatus;\n    this.usuarioAlteracao = usuario;\n    this.observacaoAlteracao = observacao;\n    this.ipUsuario = ip;\n  }\n\n  // REMOVIDO: @AfterUpdate logStatusChange()\n  // O logging de histórico agora é feito diretamente nos serviços\n  // que têm acesso ao DataSource e repositórios adequados.\n  // Isso evita o erro ConnectionNotFoundError que ocorria quando\n  // o método tentava usar getRepository() sem contexto de conexão.\n\n  @UpdateDateColumn()\n  updated_at: Date;\n\n  @DeleteDateColumn()\n  removed_at: Date;\n}\n"],"version":3}