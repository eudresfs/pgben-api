d4e306cf33442e58cce1908541f856cc
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var WorkflowSolicitacaoService_1;
var _a, _b, _c, _d, _e, _f, _g;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorkflowSolicitacaoService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const entities_1 = require("../../../entities");
const transicao_estado_service_1 = require("./transicao-estado.service");
const validacao_solicitacao_service_1 = require("./validacao-solicitacao.service");
const prazo_solicitacao_service_1 = require("./prazo-solicitacao.service");
/**
 * Serviço de Workflow de Solicitação
 *
 * Responsável por gerenciar as transições de estado das solicitações,
 * garantindo que as regras de negócio sejam respeitadas.
 */
let WorkflowSolicitacaoService = WorkflowSolicitacaoService_1 = class WorkflowSolicitacaoService {
    solicitacaoRepository;
    historicoRepository;
    pendenciaRepository;
    dataSource;
    transicaoEstadoService;
    validacaoService;
    prazoService;
    logger = new common_1.Logger(WorkflowSolicitacaoService_1.name);
    // As transições permitidas agora são gerenciadas pelo TransicaoEstadoService
    constructor(solicitacaoRepository, historicoRepository, pendenciaRepository, dataSource, transicaoEstadoService, validacaoService, prazoService) {
        this.solicitacaoRepository = solicitacaoRepository;
        this.historicoRepository = historicoRepository;
        this.pendenciaRepository = pendenciaRepository;
        this.dataSource = dataSource;
        this.transicaoEstadoService = transicaoEstadoService;
        this.validacaoService = validacaoService;
        this.prazoService = prazoService;
    }
    /**
     * Verifica se uma transição de estado é permitida
     * @param estadoAtual Estado atual da solicitação
     * @param novoEstado Novo estado desejado
     * @returns Boolean indicando se a transição é permitida
     */
    isTransicaoPermitida(estadoAtual, novoEstado) {
        return this.transicaoEstadoService.isTransicaoValida(estadoAtual, novoEstado);
    }
    /**
     * Realiza a transição de estado de uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param novoEstado Novo estado da solicitação
     * @param usuarioId ID do usuário que está realizando a transição
     * @param observacao Observação sobre a transição (opcional)
     * @returns Resultado da transição, incluindo a solicitação atualizada
     * @throws BadRequestException se a transição não for permitida
     * @throws NotFoundException se a solicitação não for encontrada
     */
    async realizarTransicao(solicitacaoId, novoEstado, usuarioId, observacao) {
        this.logger.log(`Iniciando transição da solicitação ${solicitacaoId} para o estado ${novoEstado}`);
        // Buscar a solicitação para validar a transição
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new common_1.NotFoundException(`Solicitação com ID ${solicitacaoId} não encontrada`);
        }
        const estadoAtual = solicitacao.status;
        this.logger.log(`Estado atual: ${estadoAtual}, Novo estado: ${novoEstado}`);
        // Verificar se a transição é permitida
        try {
            await this.transicaoEstadoService.verificarTransicaoPermitida(estadoAtual, novoEstado, usuarioId);
        }
        catch (error) {
            if (error instanceof common_1.ForbiddenException) {
                throw new common_1.ForbiddenException(`Usuário não tem permissão para realizar esta transição: ${error.message}`);
            }
            throw new common_1.BadRequestException(`Transição inválida de ${estadoAtual} para ${novoEstado}: ${error.message}`);
        }
        // Preparar o registro de histórico
        const historicoRegistro = {
            solicitacao_id: solicitacaoId,
            status_anterior: estadoAtual,
            status_atual: novoEstado,
            usuario_id: usuarioId,
            observacao: observacao || `Transição de ${estadoAtual} para ${novoEstado}`,
            dados_alterados: {
                status: {
                    de: estadoAtual,
                    para: novoEstado,
                },
            },
        };
        // Iniciar transação para garantir consistência
        let resultado = {
            sucesso: false,
            mensagem: '',
        };
        try {
            // Executar a transação
            await this.dataSource.transaction(async (transactionalEntityManager) => {
                // 1. Atualizar o status da solicitação
                // Controle de versão otimista - verifica a versão atual antes de atualizar
                const solicitacaoAtualizada = await transactionalEntityManager
                    .createQueryBuilder()
                    .update(entities_1.Solicitacao)
                    .set({
                    status: novoEstado,
                    // Incrementar a versão
                    version: () => '"version" + 1',
                })
                    .where('id = :id AND version = :version', {
                    id: solicitacaoId,
                    version: solicitacao.version,
                })
                    .returning('*')
                    .execute();
                if (solicitacaoAtualizada.affected === 0) {
                    throw new common_1.BadRequestException('A solicitação foi modificada por outro usuário. Por favor, recarregue e tente novamente.');
                }
                // 2. Registrar a mudança no histórico
                await transactionalEntityManager
                    .getRepository(entities_1.HistoricoSolicitacao)
                    .save(historicoRegistro);
                // Buscar a solicitação atualizada para retornar
                const solicitacaoFinal = await transactionalEntityManager
                    .getRepository(entities_1.Solicitacao)
                    .findOne({ where: { id: solicitacaoId } });
                if (!solicitacaoFinal) {
                    throw new common_1.InternalServerErrorException('Erro ao buscar solicitação após atualização');
                }
                resultado = {
                    sucesso: true,
                    solicitacao: solicitacaoFinal,
                    mensagem: `Solicitação alterada com sucesso para ${novoEstado}`,
                };
            });
            this.logger.log(`Transição da solicitação ${solicitacaoId} para ${novoEstado} concluída com sucesso`);
            // Atualizar os prazos com base no novo estado da solicitação
            try {
                await this.prazoService.atualizarPrazosTransicao(solicitacaoId, novoEstado);
                this.logger.log(`Prazos atualizados para a solicitação ${solicitacaoId}`);
            }
            catch (prazoError) {
                // Apenas logar o erro sem interromper o fluxo principal
                this.logger.error(`Erro ao atualizar prazos para a solicitação ${solicitacaoId}: ${prazoError.message}`, prazoError.stack);
            }
            return resultado;
        }
        catch (error) {
            this.logger.error(`Erro na transição da solicitação ${solicitacaoId}: ${error.message}`, error.stack);
            if (error instanceof common_1.BadRequestException ||
                error instanceof common_1.ForbiddenException ||
                error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException(`Erro ao realizar transição: ${error.message}`);
        }
    }
    /**
     * Obtém os estados possíveis para uma solicitação
     * @param solicitacaoId ID da solicitação
     * @returns Lista de estados possíveis
     */
    async getEstadosPossiveis(solicitacaoId) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new common_1.NotFoundException('Solicitação não encontrada');
        }
        return this.transicaoEstadoService.getEstadosPossiveis(solicitacao.status);
    }
    /**
     * Cria uma nova solicitação no estado RASCUNHO
     * @param solicitacaoData Dados da solicitação
     * @returns Solicitação criada
     */
    async criarRascunho(solicitacaoData) {
        const solicitacao = this.solicitacaoRepository.create({
            ...solicitacaoData,
            status: entities_1.StatusSolicitacao.RASCUNHO,
            created_at: new Date(),
            updated_at: new Date(),
        });
        return this.solicitacaoRepository.save(solicitacao);
    }
    /**
     * Submete um rascunho de solicitação, alterando seu estado para PENDENTE
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está submetendo o rascunho
     * @returns Resultado da transição
     */
    async submeterRascunho(solicitacaoId, usuarioId) {
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.ABERTA, usuarioId, 'Solicitação submetida');
    }
    /**
     * Envia uma solicitação para análise, alterando seu estado para EM_ANALISE
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está enviando a solicitação
     * @returns Resultado da transição
     */
    async enviarParaAnalise(solicitacaoId, usuarioId) {
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.EM_ANALISE, usuarioId, 'Solicitação enviada para análise');
    }
    /**
     * Inicia a análise de uma solicitação, alterando seu estado para EM_ANALISE
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está iniciando a análise
     * @returns Resultado da transição
     */
    async iniciarAnalise(solicitacaoId, usuarioId) {
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.EM_ANALISE, usuarioId, 'Análise iniciada');
    }
    /**
     * Aprova uma solicitação, alterando seu estado para APROVADA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está aprovando a solicitação
     * @param observacao Observação sobre a aprovação
     * @returns Resultado da transição
     */
    async aprovarSolicitacao(solicitacaoId, usuarioId, observacao, parecerSemtas) {
        // Primeiro, atualizar o parecer SEMTAS na solicitação
        await this.solicitacaoRepository.update(solicitacaoId, {
            parecer_semtas: parecerSemtas,
            aprovador_id: usuarioId,
            data_aprovacao: new Date(),
        });
        // Validar se a solicitação pode ser aprovada (regras de negócio)
        await this.validacaoService.validarAprovacao(solicitacaoId);
        // Se passar na validação, realizar a transição
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.APROVADA, usuarioId, observacao);
    }
    /**
     * Libera uma solicitação aprovada, alterando seu estado para LIBERADA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está liberando a solicitação
     * @returns Resultado da transição
     */
    async liberarSolicitacao(solicitacaoId, usuarioId) {
        // Validar se a solicitação pode ser liberada (regras de negócio)
        await this.validacaoService.validarLiberacao(solicitacaoId);
        // Registrar o liberador da solicitação e a data de liberação
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (solicitacao) {
            solicitacao.liberador_id = usuarioId;
            solicitacao.data_liberacao = new Date();
            await this.solicitacaoRepository.save(solicitacao);
        }
        else {
            throw new common_1.NotFoundException('Solicitação não encontrada');
        }
        // Se passar na validação, realizar a transição
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.LIBERADA, usuarioId, 'Solicitação liberada');
    }
    /**
     * Rejeita uma solicitação, alterando seu estado para INDEFERIDA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está rejeitando a solicitação
     * @param motivo Motivo da rejeição
     * @returns Resultado da transição
     */
    async rejeitarSolicitacao(solicitacaoId, usuarioId, motivo) {
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.INDEFERIDA, usuarioId, motivo || 'Solicitação reprovada');
    }
    /**
     * Cancela uma solicitação, alterando seu estado para CANCELADA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está cancelando a solicitação
     * @param motivo Motivo do cancelamento
     * @returns Resultado da transição
     */
    async cancelarSolicitacao(solicitacaoId, usuarioId, motivo) {
        // Validar se a solicitação pode ser cancelada (regras de negócio)
        await this.validacaoService.validarCancelamento(solicitacaoId);
        // Se passar na validação, realizar a transição
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.CANCELADA, usuarioId, motivo || 'Solicitação cancelada');
    }
    /**
     * Inicia o processamento de uma solicitação, alterando seu estado para EM_PROCESSAMENTO
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está iniciando o processamento
     * @returns Resultado da transição
     */
    async iniciarProcessamento(solicitacaoId, usuarioId) {
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.EM_PROCESSAMENTO, usuarioId, 'Processamento iniciado');
    }
    /**
     * Conclui uma solicitação, alterando seu estado para CONCLUIDA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está concluindo a solicitação
     * @returns Resultado da transição
     */
    async concluirSolicitacao(solicitacaoId, usuarioId) {
        // Validar se a solicitação pode ser concluída (regras de negócio)
        await this.validacaoService.validarConclusao(solicitacaoId);
        // Se passar na validação, realizar a transição
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.CONCLUIDA, usuarioId, 'Solicitação concluída');
    }
    /**
     * Arquiva uma solicitação, alterando seu estado para ARQUIVADA
     * @param solicitacaoId ID da solicitação
     * @param usuarioId ID do usuário que está arquivando a solicitação
     * @returns Resultado da transição
     */
    async arquivarSolicitacao(solicitacaoId, usuarioId) {
        // Validar se a solicitação pode ser arquivada (regras de negócio)
        await this.validacaoService.validarArquivamento(solicitacaoId);
        // Se passar na validação, realizar a transição
        return this.realizarTransicao(solicitacaoId, entities_1.StatusSolicitacao.ARQUIVADA, usuarioId, 'Solicitação arquivada');
    }
    /**
     * Atualiza o status de uma solicitação com informações adicionais para conformidade
     * @param solicitacaoId ID da solicitação
     * @param novoStatus Novo status desejado
     * @param usuarioId ID do usuário que está atualizando o status
     * @param dadosAdicionais Dados adicionais para a atualização
     * @returns Resultado da transição
     */
    async atualizarStatus(solicitacaoId, novoStatus, usuarioId, dadosAdicionais) {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();
        try {
            // Buscar a solicitação
            const solicitacao = await this.solicitacaoRepository.findOne({
                where: { id: solicitacaoId },
            });
            if (!solicitacao) {
                throw new common_1.NotFoundException('Solicitação não encontrada');
            }
            // Verificar se a transição é permitida
            if (!this.isTransicaoPermitida(solicitacao.status, novoStatus)) {
                throw new common_1.ForbiddenException(`Transição de estado de ${solicitacao.status} para ${novoStatus} não é permitida`);
            }
            // Construir a observação com os dados adicionais
            let observacaoCompleta = dadosAdicionais.observacao || '';
            if (dadosAdicionais.justificativa) {
                observacaoCompleta += `\nJustificativa: ${dadosAdicionais.justificativa}`;
            }
            if (dadosAdicionais.processo_judicial_id) {
                observacaoCompleta += `\nProcesso Judicial ID: ${dadosAdicionais.processo_judicial_id}`;
            }
            if (dadosAdicionais.determinacao_judicial_id) {
                observacaoCompleta += `\nDeterminação Judicial ID: ${dadosAdicionais.determinacao_judicial_id}`;
            }
            // Salvar o estado anterior para o retorno
            const statusAnterior = solicitacao.status;
            // Preparar dados adicionais para atualização
            const updateData = {
                status: novoStatus,
                updated_at: new Date(),
            };
            // Adicionar dados adicionais, se existirem
            if (dadosAdicionais.processo_judicial_id) {
                updateData.processo_judicial_id = dadosAdicionais.processo_judicial_id;
                updateData.determinacao_judicial_flag = true;
            }
            if (dadosAdicionais.determinacao_judicial_id) {
                updateData.determinacao_judicial_id =
                    dadosAdicionais.determinacao_judicial_id;
                updateData.determinacao_judicial_flag = true;
            }
            // Atualizar a solicitação usando o queryRunner
            await queryRunner.manager.update(entities_1.Solicitacao, { id: solicitacaoId }, updateData);
            // Registrar a transição no histórico
            const historico = new entities_1.HistoricoSolicitacao();
            historico.solicitacao_id = solicitacaoId;
            historico.status_anterior = statusAnterior;
            historico.status_atual = novoStatus;
            historico.usuario_id = usuarioId;
            historico.observacao =
                observacaoCompleta ||
                    `Status atualizado de ${statusAnterior} para ${novoStatus}`;
            historico.created_at = new Date();
            await queryRunner.manager.save(entities_1.HistoricoSolicitacao, historico);
            await queryRunner.commitTransaction();
            return {
                sucesso: true,
                mensagem: `Status atualizado com sucesso de ${statusAnterior} para ${novoStatus}`,
                status_anterior: statusAnterior,
                status_atual: novoStatus,
            };
        }
        catch (error) {
            await queryRunner.rollbackTransaction();
            // Verificar se é um erro de versão (conflito de concorrência)
            if (error.name === 'QueryFailedError' &&
                (error.message.includes('version') ||
                    error.message.includes('version mismatch'))) {
                throw new common_1.BadRequestException('A solicitação foi modificada por outro usuário enquanto você a editava. ' +
                    'Por favor, atualize a página e tente novamente.');
            }
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.ForbiddenException ||
                error instanceof common_1.BadRequestException) {
                throw error;
            }
            this.logger.error(`Erro ao atualizar status da solicitação: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro ao atualizar status da solicitação');
        }
        finally {
            await queryRunner.release();
        }
    }
};
exports.WorkflowSolicitacaoService = WorkflowSolicitacaoService;
exports.WorkflowSolicitacaoService = WorkflowSolicitacaoService = WorkflowSolicitacaoService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(entities_1.Solicitacao)),
    __param(1, (0, typeorm_1.InjectRepository)(entities_1.HistoricoSolicitacao)),
    __param(2, (0, typeorm_1.InjectRepository)(entities_1.Pendencia)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.DataSource !== "undefined" && typeorm_2.DataSource) === "function" ? _d : Object, typeof (_e = typeof transicao_estado_service_1.TransicaoEstadoService !== "undefined" && transicao_estado_service_1.TransicaoEstadoService) === "function" ? _e : Object, typeof (_f = typeof validacao_solicitacao_service_1.ValidacaoSolicitacaoService !== "undefined" && validacao_solicitacao_service_1.ValidacaoSolicitacaoService) === "function" ? _f : Object, typeof (_g = typeof prazo_solicitacao_service_1.PrazoSolicitacaoService !== "undefined" && prazo_solicitacao_service_1.PrazoSolicitacaoService) === "function" ? _g : Object])
], WorkflowSolicitacaoService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcd29ya2Zsb3ctc29saWNpdGFjYW8uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU93QjtBQUN4Qiw2Q0FBbUQ7QUFDbkQscUNBQWlEO0FBQ2pELGdEQU0yQjtBQUMzQix5RUFBb0U7QUFDcEUsbUZBQThFO0FBQzlFLDJFQUFzRTtBQWF0RTs7Ozs7R0FLRztBQUVJLElBQU0sMEJBQTBCLGtDQUFoQyxNQUFNLDBCQUEwQjtJQU9sQjtJQUVBO0lBRUE7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWRGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyw0QkFBMEIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV0RSw2RUFBNkU7SUFFN0UsWUFFbUIscUJBQThDLEVBRTlDLG1CQUFxRCxFQUVyRCxtQkFBMEMsRUFDMUMsVUFBc0IsRUFDdEIsc0JBQThDLEVBQzlDLGdCQUE2QyxFQUM3QyxZQUFxQztRQVJyQywwQkFBcUIsR0FBckIscUJBQXFCLENBQXlCO1FBRTlDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBa0M7UUFFckQsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUF1QjtRQUMxQyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE2QjtRQUM3QyxpQkFBWSxHQUFaLFlBQVksQ0FBeUI7SUFDckQsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsb0JBQW9CLENBQ2xCLFdBQThCLEVBQzlCLFVBQTZCO1FBRTdCLE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLGlCQUFpQixDQUNsRCxXQUFXLEVBQ1gsVUFBVSxDQUNYLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUNyQixhQUFxQixFQUNyQixVQUE2QixFQUM3QixTQUFpQixFQUNqQixVQUFtQjtRQUVuQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYixzQ0FBc0MsYUFBYSxrQkFBa0IsVUFBVSxFQUFFLENBQ2xGLENBQUM7UUFFRixnREFBZ0Q7UUFDaEQsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDO1lBQzNELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUU7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLE1BQU0sSUFBSSwwQkFBaUIsQ0FDekIsc0JBQXNCLGFBQWEsaUJBQWlCLENBQ3JELENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQztRQUN2QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsV0FBVyxrQkFBa0IsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUU1RSx1Q0FBdUM7UUFDdkMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsMkJBQTJCLENBQzNELFdBQVcsRUFDWCxVQUFVLEVBQ1YsU0FBUyxDQUNWLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksS0FBSyxZQUFZLDJCQUFrQixFQUFFLENBQUM7Z0JBQ3hDLE1BQU0sSUFBSSwyQkFBa0IsQ0FDMUIsMkRBQTJELEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FDM0UsQ0FBQztZQUNKLENBQUM7WUFDRCxNQUFNLElBQUksNEJBQW1CLENBQzNCLHlCQUF5QixXQUFXLFNBQVMsVUFBVSxLQUFLLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FDNUUsQ0FBQztRQUNKLENBQUM7UUFFRCxtQ0FBbUM7UUFDbkMsTUFBTSxpQkFBaUIsR0FBRztZQUN4QixjQUFjLEVBQUUsYUFBYTtZQUM3QixlQUFlLEVBQUUsV0FBVztZQUM1QixZQUFZLEVBQUUsVUFBVTtZQUN4QixVQUFVLEVBQUUsU0FBUztZQUNyQixVQUFVLEVBQ1IsVUFBVSxJQUFJLGdCQUFnQixXQUFXLFNBQVMsVUFBVSxFQUFFO1lBQ2hFLGVBQWUsRUFBRTtnQkFDZixNQUFNLEVBQUU7b0JBQ04sRUFBRSxFQUFFLFdBQVc7b0JBQ2YsSUFBSSxFQUFFLFVBQVU7aUJBQ2pCO2FBQ0Y7U0FDRixDQUFDO1FBRUYsK0NBQStDO1FBQy9DLElBQUksU0FBUyxHQUE2QjtZQUN4QyxPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRSxFQUFFO1NBQ2IsQ0FBQztRQUVGLElBQUksQ0FBQztZQUNILHVCQUF1QjtZQUN2QixNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSwwQkFBMEIsRUFBRSxFQUFFO2dCQUNyRSx1Q0FBdUM7Z0JBQ3ZDLDJFQUEyRTtnQkFDM0UsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLDBCQUEwQjtxQkFDM0Qsa0JBQWtCLEVBQUU7cUJBQ3BCLE1BQU0sQ0FBQyxzQkFBVyxDQUFDO3FCQUNuQixHQUFHLENBQUM7b0JBQ0gsTUFBTSxFQUFFLFVBQVU7b0JBQ2xCLHVCQUF1QjtvQkFDdkIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLGVBQWU7aUJBQy9CLENBQUM7cUJBQ0QsS0FBSyxDQUFDLGlDQUFpQyxFQUFFO29CQUN4QyxFQUFFLEVBQUUsYUFBYTtvQkFDakIsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPO2lCQUM3QixDQUFDO3FCQUNELFNBQVMsQ0FBQyxHQUFHLENBQUM7cUJBQ2QsT0FBTyxFQUFFLENBQUM7Z0JBRWIsSUFBSSxxQkFBcUIsQ0FBQyxRQUFRLEtBQUssQ0FBQyxFQUFFLENBQUM7b0JBQ3pDLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsMEZBQTBGLENBQzNGLENBQUM7Z0JBQ0osQ0FBQztnQkFFRCxzQ0FBc0M7Z0JBQ3RDLE1BQU0sMEJBQTBCO3FCQUM3QixhQUFhLENBQUMsK0JBQW9CLENBQUM7cUJBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUUzQixnREFBZ0Q7Z0JBQ2hELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSwwQkFBMEI7cUJBQ3RELGFBQWEsQ0FBQyxzQkFBVyxDQUFDO3FCQUMxQixPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUU3QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztvQkFDdEIsTUFBTSxJQUFJLHFDQUE0QixDQUNwQyw2Q0FBNkMsQ0FDOUMsQ0FBQztnQkFDSixDQUFDO2dCQUVELFNBQVMsR0FBRztvQkFDVixPQUFPLEVBQUUsSUFBSTtvQkFDYixXQUFXLEVBQUUsZ0JBQWdCO29CQUM3QixRQUFRLEVBQUUseUNBQXlDLFVBQVUsRUFBRTtpQkFDaEUsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsNEJBQTRCLGFBQWEsU0FBUyxVQUFVLHdCQUF3QixDQUNyRixDQUFDO1lBRUYsNkRBQTZEO1lBQzdELElBQUksQ0FBQztnQkFDSCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsd0JBQXdCLENBQzlDLGFBQWEsRUFDYixVQUFVLENBQ1gsQ0FBQztnQkFDRixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYix5Q0FBeUMsYUFBYSxFQUFFLENBQ3pELENBQUM7WUFDSixDQUFDO1lBQUMsT0FBTyxVQUFVLEVBQUUsQ0FBQztnQkFDcEIsd0RBQXdEO2dCQUN4RCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiwrQ0FBK0MsYUFBYSxLQUFLLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFDckYsVUFBVSxDQUFDLEtBQUssQ0FDakIsQ0FBQztZQUNKLENBQUM7WUFFRCxPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLG9DQUFvQyxhQUFhLEtBQUssS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUNyRSxLQUFLLENBQUMsS0FBSyxDQUNaLENBQUM7WUFFRixJQUNFLEtBQUssWUFBWSw0QkFBbUI7Z0JBQ3BDLEtBQUssWUFBWSwyQkFBa0I7Z0JBQ25DLEtBQUssWUFBWSwwQkFBaUIsRUFDbEMsQ0FBQztnQkFDRCxNQUFNLEtBQUssQ0FBQztZQUNkLENBQUM7WUFFRCxNQUFNLElBQUkscUNBQTRCLENBQ3BDLCtCQUErQixLQUFLLENBQUMsT0FBTyxFQUFFLENBQy9DLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQ3ZCLGFBQXFCO1FBRXJCLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQztZQUMzRCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFO1NBQzdCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNqQixNQUFNLElBQUksMEJBQWlCLENBQUMsNEJBQTRCLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsbUJBQW1CLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FDakIsZUFBcUM7UUFFckMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQztZQUNwRCxHQUFHLGVBQWU7WUFDbEIsTUFBTSxFQUFFLDRCQUFpQixDQUFDLFFBQVE7WUFDbEMsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3RCLFVBQVUsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN2QixDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLGdCQUFnQixDQUNwQixhQUFxQixFQUNyQixTQUFpQjtRQUVqQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FDM0IsYUFBYSxFQUNiLDRCQUFpQixDQUFDLE1BQU0sRUFDeEIsU0FBUyxFQUNULHVCQUF1QixDQUN4QixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUNyQixhQUFxQixFQUNyQixTQUFpQjtRQUVqQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FDM0IsYUFBYSxFQUNiLDRCQUFpQixDQUFDLFVBQVUsRUFDNUIsU0FBUyxFQUNULGtDQUFrQyxDQUNuQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FDbEIsYUFBcUIsRUFDckIsU0FBaUI7UUFFakIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQzNCLGFBQWEsRUFDYiw0QkFBaUIsQ0FBQyxVQUFVLEVBQzVCLFNBQVMsRUFDVCxrQkFBa0IsQ0FDbkIsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCxLQUFLLENBQUMsa0JBQWtCLENBQ3RCLGFBQXFCLEVBQ3JCLFNBQWlCLEVBQ2pCLFVBQWtCLEVBQ2xCLGFBQXFCO1FBRXJCLHNEQUFzRDtRQUN0RCxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFO1lBQ3JELGNBQWMsRUFBRSxhQUFhO1lBQzdCLFlBQVksRUFBRSxTQUFTO1lBQ3ZCLGNBQWMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUMzQixDQUFDLENBQUM7UUFFSCxpRUFBaUU7UUFDakUsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFNUQsK0NBQStDO1FBQy9DLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUMzQixhQUFhLEVBQ2IsNEJBQWlCLENBQUMsUUFBUSxFQUMxQixTQUFTLEVBQ1QsVUFBVSxDQUNYLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsa0JBQWtCLENBQ3RCLGFBQXFCLEVBQ3JCLFNBQWlCO1FBRWpCLGlFQUFpRTtRQUNqRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUU1RCw2REFBNkQ7UUFDN0QsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDO1lBQzNELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUU7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixXQUFXLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQztZQUNyQyxXQUFXLENBQUMsY0FBYyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7WUFDeEMsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JELENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxJQUFJLDBCQUFpQixDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDNUQsQ0FBQztRQUVELCtDQUErQztRQUMvQyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FDM0IsYUFBYSxFQUNiLDRCQUFpQixDQUFDLFFBQVEsRUFDMUIsU0FBUyxFQUNULHNCQUFzQixDQUN2QixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FDdkIsYUFBcUIsRUFDckIsU0FBaUIsRUFDakIsTUFBYztRQUVkLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUMzQixhQUFhLEVBQ2IsNEJBQWlCLENBQUMsVUFBVSxFQUM1QixTQUFTLEVBQ1QsTUFBTSxJQUFJLHVCQUF1QixDQUNsQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FDdkIsYUFBcUIsRUFDckIsU0FBaUIsRUFDakIsTUFBYztRQUVkLGtFQUFrRTtRQUNsRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUUvRCwrQ0FBK0M7UUFDL0MsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQzNCLGFBQWEsRUFDYiw0QkFBaUIsQ0FBQyxTQUFTLEVBQzNCLFNBQVMsRUFDVCxNQUFNLElBQUksdUJBQXVCLENBQ2xDLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsb0JBQW9CLENBQ3hCLGFBQXFCLEVBQ3JCLFNBQWlCO1FBRWpCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUMzQixhQUFhLEVBQ2IsNEJBQWlCLENBQUMsZ0JBQWdCLEVBQ2xDLFNBQVMsRUFDVCx3QkFBd0IsQ0FDekIsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FDdkIsYUFBcUIsRUFDckIsU0FBaUI7UUFFakIsa0VBQWtFO1FBQ2xFLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTVELCtDQUErQztRQUMvQyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FDM0IsYUFBYSxFQUNiLDRCQUFpQixDQUFDLFNBQVMsRUFDM0IsU0FBUyxFQUNULHVCQUF1QixDQUN4QixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLG1CQUFtQixDQUN2QixhQUFxQixFQUNyQixTQUFpQjtRQUVqQixrRUFBa0U7UUFDbEUsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFL0QsK0NBQStDO1FBQy9DLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUMzQixhQUFhLEVBQ2IsNEJBQWlCLENBQUMsU0FBUyxFQUMzQixTQUFTLEVBQ1QsdUJBQXVCLENBQ3hCLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILEtBQUssQ0FBQyxlQUFlLENBQ25CLGFBQXFCLEVBQ3JCLFVBQTZCLEVBQzdCLFNBQWlCLEVBQ2pCLGVBS0M7UUFFRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDeEQsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUIsTUFBTSxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUVyQyxJQUFJLENBQUM7WUFDSCx1QkFBdUI7WUFDdkIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDO2dCQUMzRCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFO2FBQzdCLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDakIsTUFBTSxJQUFJLDBCQUFpQixDQUFDLDRCQUE0QixDQUFDLENBQUM7WUFDNUQsQ0FBQztZQUVELHVDQUF1QztZQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDL0QsTUFBTSxJQUFJLDJCQUFrQixDQUMxQiwwQkFBMEIsV0FBVyxDQUFDLE1BQU0sU0FBUyxVQUFVLGtCQUFrQixDQUNsRixDQUFDO1lBQ0osQ0FBQztZQUVELGlEQUFpRDtZQUNqRCxJQUFJLGtCQUFrQixHQUFHLGVBQWUsQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1lBRTFELElBQUksZUFBZSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNsQyxrQkFBa0IsSUFBSSxvQkFBb0IsZUFBZSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzVFLENBQUM7WUFFRCxJQUFJLGVBQWUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO2dCQUN6QyxrQkFBa0IsSUFBSSwyQkFBMkIsZUFBZSxDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDMUYsQ0FBQztZQUVELElBQUksZUFBZSxDQUFDLHdCQUF3QixFQUFFLENBQUM7Z0JBQzdDLGtCQUFrQixJQUFJLCtCQUErQixlQUFlLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztZQUNsRyxDQUFDO1lBRUQsMENBQTBDO1lBQzFDLE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUM7WUFFMUMsNkNBQTZDO1lBQzdDLE1BQU0sVUFBVSxHQUFRO2dCQUN0QixNQUFNLEVBQUUsVUFBVTtnQkFDbEIsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3ZCLENBQUM7WUFFRiwyQ0FBMkM7WUFDM0MsSUFBSSxlQUFlLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztnQkFDekMsVUFBVSxDQUFDLG9CQUFvQixHQUFHLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDdkUsVUFBVSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQztZQUMvQyxDQUFDO1lBRUQsSUFBSSxlQUFlLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztnQkFDN0MsVUFBVSxDQUFDLHdCQUF3QjtvQkFDakMsZUFBZSxDQUFDLHdCQUF3QixDQUFDO2dCQUMzQyxVQUFVLENBQUMsMEJBQTBCLEdBQUcsSUFBSSxDQUFDO1lBQy9DLENBQUM7WUFFRCwrQ0FBK0M7WUFDL0MsTUFBTSxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FDOUIsc0JBQVcsRUFDWCxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFDckIsVUFBVSxDQUNYLENBQUM7WUFFRixxQ0FBcUM7WUFDckMsTUFBTSxTQUFTLEdBQUcsSUFBSSwrQkFBb0IsRUFBRSxDQUFDO1lBQzdDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDO1lBQ3pDLFNBQVMsQ0FBQyxlQUFlLEdBQUcsY0FBYyxDQUFDO1lBQzNDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsVUFBVSxDQUFDO1lBQ3BDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1lBQ2pDLFNBQVMsQ0FBQyxVQUFVO2dCQUNsQixrQkFBa0I7b0JBQ2xCLHdCQUF3QixjQUFjLFNBQVMsVUFBVSxFQUFFLENBQUM7WUFDOUQsU0FBUyxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBRWxDLE1BQU0sV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsK0JBQW9CLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFaEUsTUFBTSxXQUFXLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUV0QyxPQUFPO2dCQUNMLE9BQU8sRUFBRSxJQUFJO2dCQUNiLFFBQVEsRUFBRSxvQ0FBb0MsY0FBYyxTQUFTLFVBQVUsRUFBRTtnQkFDakYsZUFBZSxFQUFFLGNBQWM7Z0JBQy9CLFlBQVksRUFBRSxVQUFVO2FBQ3pCLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sV0FBVyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFFeEMsOERBQThEO1lBQzlELElBQ0UsS0FBSyxDQUFDLElBQUksS0FBSyxrQkFBa0I7Z0JBQ2pDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDO29CQUNoQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEVBQzdDLENBQUM7Z0JBQ0QsTUFBTSxJQUFJLDRCQUFtQixDQUMzQiwwRUFBMEU7b0JBQ3hFLGlEQUFpRCxDQUNwRCxDQUFDO1lBQ0osQ0FBQztZQUVELElBQ0UsS0FBSyxZQUFZLDBCQUFpQjtnQkFDbEMsS0FBSyxZQUFZLDJCQUFrQjtnQkFDbkMsS0FBSyxZQUFZLDRCQUFtQixFQUNwQyxDQUFDO2dCQUNELE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDRDQUE0QyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQzNELEtBQUssQ0FBQyxLQUFLLENBQ1osQ0FBQztZQUNGLE1BQU0sSUFBSSxxQ0FBNEIsQ0FDcEMseUNBQXlDLENBQzFDLENBQUM7UUFDSixDQUFDO2dCQUFTLENBQUM7WUFDVCxNQUFNLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUF6bEJZLGdFQUEwQjtxQ0FBMUIsMEJBQTBCO0lBRHRDLElBQUEsbUJBQVUsR0FBRTtJQU9SLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyxzQkFBVyxDQUFDLENBQUE7SUFFN0IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLCtCQUFvQixDQUFDLENBQUE7SUFFdEMsV0FBQSxJQUFBLDBCQUFnQixFQUFDLG9CQUFTLENBQUMsQ0FBQTt5REFIWSxvQkFBVSxvQkFBVixvQkFBVSxvREFFWixvQkFBVSxvQkFBVixvQkFBVSxvREFFVixvQkFBVSxvQkFBVixvQkFBVSxvREFDbkIsb0JBQVUsb0JBQVYsb0JBQVUsb0RBQ0UsaURBQXNCLG9CQUF0QixpREFBc0Isb0RBQzVCLDJEQUEyQixvQkFBM0IsMkRBQTJCLG9EQUMvQixtREFBdUIsb0JBQXZCLG1EQUF1QjtHQWY3QywwQkFBMEIsQ0F5bEJ0QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcc29saWNpdGFjYW9cXHNlcnZpY2VzXFx3b3JrZmxvdy1zb2xpY2l0YWNhby5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIExvZ2dlcixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBEYXRhU291cmNlIH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQge1xuICBTb2xpY2l0YWNhbyxcbiAgU3RhdHVzU29saWNpdGFjYW8sXG4gIEhpc3Rvcmljb1NvbGljaXRhY2FvLFxuICBQZW5kZW5jaWEsXG4gIFN0YXR1c1BlbmRlbmNpYSxcbn0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMnO1xuaW1wb3J0IHsgVHJhbnNpY2FvRXN0YWRvU2VydmljZSB9IGZyb20gJy4vdHJhbnNpY2FvLWVzdGFkby5zZXJ2aWNlJztcbmltcG9ydCB7IFZhbGlkYWNhb1NvbGljaXRhY2FvU2VydmljZSB9IGZyb20gJy4vdmFsaWRhY2FvLXNvbGljaXRhY2FvLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJhem9Tb2xpY2l0YWNhb1NlcnZpY2UgfSBmcm9tICcuL3ByYXpvLXNvbGljaXRhY2FvLnNlcnZpY2UnO1xuXG4vKipcbiAqIEludGVyZmFjZSBwYXJhIG8gcmVzdWx0YWRvIGRhIHRyYW5zacOnw6NvIGRlIGVzdGFkb1xuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlc3VsdGFkb1RyYW5zaWNhb0VzdGFkbyB7XG4gIHN1Y2Vzc286IGJvb2xlYW47XG4gIG1lbnNhZ2VtOiBzdHJpbmc7XG4gIHN0YXR1c19hbnRlcmlvcj86IFN0YXR1c1NvbGljaXRhY2FvO1xuICBzdGF0dXNfYXR1YWw/OiBTdGF0dXNTb2xpY2l0YWNhbztcbiAgc29saWNpdGFjYW8/OiBTb2xpY2l0YWNhbztcbn1cblxuLyoqXG4gKiBTZXJ2acOnbyBkZSBXb3JrZmxvdyBkZSBTb2xpY2l0YcOnw6NvXG4gKlxuICogUmVzcG9uc8OhdmVsIHBvciBnZXJlbmNpYXIgYXMgdHJhbnNpw6fDtWVzIGRlIGVzdGFkbyBkYXMgc29saWNpdGHDp8O1ZXMsXG4gKiBnYXJhbnRpbmRvIHF1ZSBhcyByZWdyYXMgZGUgbmVnw7NjaW8gc2VqYW0gcmVzcGVpdGFkYXMuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXb3JrZmxvd1NvbGljaXRhY2FvU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihXb3JrZmxvd1NvbGljaXRhY2FvU2VydmljZS5uYW1lKTtcblxuICAvLyBBcyB0cmFuc2nDp8O1ZXMgcGVybWl0aWRhcyBhZ29yYSBzw6NvIGdlcmVuY2lhZGFzIHBlbG8gVHJhbnNpY2FvRXN0YWRvU2VydmljZVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFNvbGljaXRhY2FvKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgc29saWNpdGFjYW9SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFNvbGljaXRhY2FvPixcbiAgICBASW5qZWN0UmVwb3NpdG9yeShIaXN0b3JpY29Tb2xpY2l0YWNhbylcbiAgICBwcml2YXRlIHJlYWRvbmx5IGhpc3Rvcmljb1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8SGlzdG9yaWNvU29saWNpdGFjYW8+LFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFBlbmRlbmNpYSlcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBlbmRlbmNpYVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8UGVuZGVuY2lhPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGFTb3VyY2U6IERhdGFTb3VyY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2ljYW9Fc3RhZG9TZXJ2aWNlOiBUcmFuc2ljYW9Fc3RhZG9TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmFsaWRhY2FvU2VydmljZTogVmFsaWRhY2FvU29saWNpdGFjYW9TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJhem9TZXJ2aWNlOiBQcmF6b1NvbGljaXRhY2FvU2VydmljZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSB1bWEgdHJhbnNpw6fDo28gZGUgZXN0YWRvIMOpIHBlcm1pdGlkYVxuICAgKiBAcGFyYW0gZXN0YWRvQXR1YWwgRXN0YWRvIGF0dWFsIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIG5vdm9Fc3RhZG8gTm92byBlc3RhZG8gZGVzZWphZG9cbiAgICogQHJldHVybnMgQm9vbGVhbiBpbmRpY2FuZG8gc2UgYSB0cmFuc2nDp8OjbyDDqSBwZXJtaXRpZGFcbiAgICovXG4gIGlzVHJhbnNpY2FvUGVybWl0aWRhKFxuICAgIGVzdGFkb0F0dWFsOiBTdGF0dXNTb2xpY2l0YWNhbyxcbiAgICBub3ZvRXN0YWRvOiBTdGF0dXNTb2xpY2l0YWNhbyxcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudHJhbnNpY2FvRXN0YWRvU2VydmljZS5pc1RyYW5zaWNhb1ZhbGlkYShcbiAgICAgIGVzdGFkb0F0dWFsLFxuICAgICAgbm92b0VzdGFkbyxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWxpemEgYSB0cmFuc2nDp8OjbyBkZSBlc3RhZG8gZGUgdW1hIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gbm92b0VzdGFkbyBOb3ZvIGVzdGFkbyBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIHJlYWxpemFuZG8gYSB0cmFuc2nDp8Ojb1xuICAgKiBAcGFyYW0gb2JzZXJ2YWNhbyBPYnNlcnZhw6fDo28gc29icmUgYSB0cmFuc2nDp8OjbyAob3BjaW9uYWwpXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8OjbywgaW5jbHVpbmRvIGEgc29saWNpdGHDp8OjbyBhdHVhbGl6YWRhXG4gICAqIEB0aHJvd3MgQmFkUmVxdWVzdEV4Y2VwdGlvbiBzZSBhIHRyYW5zacOnw6NvIG7Do28gZm9yIHBlcm1pdGlkYVxuICAgKiBAdGhyb3dzIE5vdEZvdW5kRXhjZXB0aW9uIHNlIGEgc29saWNpdGHDp8OjbyBuw6NvIGZvciBlbmNvbnRyYWRhXG4gICAqL1xuICBhc3luYyByZWFsaXphclRyYW5zaWNhbyhcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgbm92b0VzdGFkbzogU3RhdHVzU29saWNpdGFjYW8sXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICAgb2JzZXJ2YWNhbz86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSZXN1bHRhZG9UcmFuc2ljYW9Fc3RhZG8+IHtcbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgSW5pY2lhbmRvIHRyYW5zacOnw6NvIGRhIHNvbGljaXRhw6fDo28gJHtzb2xpY2l0YWNhb0lkfSBwYXJhIG8gZXN0YWRvICR7bm92b0VzdGFkb31gLFxuICAgICk7XG5cbiAgICAvLyBCdXNjYXIgYSBzb2xpY2l0YcOnw6NvIHBhcmEgdmFsaWRhciBhIHRyYW5zacOnw6NvXG4gICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXNvbGljaXRhY2FvKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgIGBTb2xpY2l0YcOnw6NvIGNvbSBJRCAke3NvbGljaXRhY2FvSWR9IG7Do28gZW5jb250cmFkYWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGVzdGFkb0F0dWFsID0gc29saWNpdGFjYW8uc3RhdHVzO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgRXN0YWRvIGF0dWFsOiAke2VzdGFkb0F0dWFsfSwgTm92byBlc3RhZG86ICR7bm92b0VzdGFkb31gKTtcblxuICAgIC8vIFZlcmlmaWNhciBzZSBhIHRyYW5zacOnw6NvIMOpIHBlcm1pdGlkYVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnRyYW5zaWNhb0VzdGFkb1NlcnZpY2UudmVyaWZpY2FyVHJhbnNpY2FvUGVybWl0aWRhKFxuICAgICAgICBlc3RhZG9BdHVhbCxcbiAgICAgICAgbm92b0VzdGFkbyxcbiAgICAgICAgdXN1YXJpb0lkLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRm9yYmlkZGVuRXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICAgYFVzdcOhcmlvIG7Do28gdGVtIHBlcm1pc3PDo28gcGFyYSByZWFsaXphciBlc3RhIHRyYW5zacOnw6NvOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgVHJhbnNpw6fDo28gaW52w6FsaWRhIGRlICR7ZXN0YWRvQXR1YWx9IHBhcmEgJHtub3ZvRXN0YWRvfTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFByZXBhcmFyIG8gcmVnaXN0cm8gZGUgaGlzdMOzcmljb1xuICAgIGNvbnN0IGhpc3Rvcmljb1JlZ2lzdHJvID0ge1xuICAgICAgc29saWNpdGFjYW9faWQ6IHNvbGljaXRhY2FvSWQsXG4gICAgICBzdGF0dXNfYW50ZXJpb3I6IGVzdGFkb0F0dWFsLFxuICAgICAgc3RhdHVzX2F0dWFsOiBub3ZvRXN0YWRvLFxuICAgICAgdXN1YXJpb19pZDogdXN1YXJpb0lkLFxuICAgICAgb2JzZXJ2YWNhbzpcbiAgICAgICAgb2JzZXJ2YWNhbyB8fCBgVHJhbnNpw6fDo28gZGUgJHtlc3RhZG9BdHVhbH0gcGFyYSAke25vdm9Fc3RhZG99YCxcbiAgICAgIGRhZG9zX2FsdGVyYWRvczoge1xuICAgICAgICBzdGF0dXM6IHtcbiAgICAgICAgICBkZTogZXN0YWRvQXR1YWwsXG4gICAgICAgICAgcGFyYTogbm92b0VzdGFkbyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIC8vIEluaWNpYXIgdHJhbnNhw6fDo28gcGFyYSBnYXJhbnRpciBjb25zaXN0w6puY2lhXG4gICAgbGV0IHJlc3VsdGFkbzogUmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvID0ge1xuICAgICAgc3VjZXNzbzogZmFsc2UsXG4gICAgICBtZW5zYWdlbTogJycsXG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBFeGVjdXRhciBhIHRyYW5zYcOnw6NvXG4gICAgICBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudHJhbnNhY3Rpb24oYXN5bmMgKHRyYW5zYWN0aW9uYWxFbnRpdHlNYW5hZ2VyKSA9PiB7XG4gICAgICAgIC8vIDEuIEF0dWFsaXphciBvIHN0YXR1cyBkYSBzb2xpY2l0YcOnw6NvXG4gICAgICAgIC8vIENvbnRyb2xlIGRlIHZlcnPDo28gb3RpbWlzdGEgLSB2ZXJpZmljYSBhIHZlcnPDo28gYXR1YWwgYW50ZXMgZGUgYXR1YWxpemFyXG4gICAgICAgIGNvbnN0IHNvbGljaXRhY2FvQXR1YWxpemFkYSA9IGF3YWl0IHRyYW5zYWN0aW9uYWxFbnRpdHlNYW5hZ2VyXG4gICAgICAgICAgLmNyZWF0ZVF1ZXJ5QnVpbGRlcigpXG4gICAgICAgICAgLnVwZGF0ZShTb2xpY2l0YWNhbylcbiAgICAgICAgICAuc2V0KHtcbiAgICAgICAgICAgIHN0YXR1czogbm92b0VzdGFkbyxcbiAgICAgICAgICAgIC8vIEluY3JlbWVudGFyIGEgdmVyc8Ojb1xuICAgICAgICAgICAgdmVyc2lvbjogKCkgPT4gJ1widmVyc2lvblwiICsgMScsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2hlcmUoJ2lkID0gOmlkIEFORCB2ZXJzaW9uID0gOnZlcnNpb24nLCB7XG4gICAgICAgICAgICBpZDogc29saWNpdGFjYW9JZCxcbiAgICAgICAgICAgIHZlcnNpb246IHNvbGljaXRhY2FvLnZlcnNpb24sXG4gICAgICAgICAgfSlcbiAgICAgICAgICAucmV0dXJuaW5nKCcqJylcbiAgICAgICAgICAuZXhlY3V0ZSgpO1xuXG4gICAgICAgIGlmIChzb2xpY2l0YWNhb0F0dWFsaXphZGEuYWZmZWN0ZWQgPT09IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdBIHNvbGljaXRhw6fDo28gZm9pIG1vZGlmaWNhZGEgcG9yIG91dHJvIHVzdcOhcmlvLiBQb3IgZmF2b3IsIHJlY2FycmVndWUgZSB0ZW50ZSBub3ZhbWVudGUuJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gMi4gUmVnaXN0cmFyIGEgbXVkYW7Dp2Egbm8gaGlzdMOzcmljb1xuICAgICAgICBhd2FpdCB0cmFuc2FjdGlvbmFsRW50aXR5TWFuYWdlclxuICAgICAgICAgIC5nZXRSZXBvc2l0b3J5KEhpc3Rvcmljb1NvbGljaXRhY2FvKVxuICAgICAgICAgIC5zYXZlKGhpc3Rvcmljb1JlZ2lzdHJvKTtcblxuICAgICAgICAvLyBCdXNjYXIgYSBzb2xpY2l0YcOnw6NvIGF0dWFsaXphZGEgcGFyYSByZXRvcm5hclxuICAgICAgICBjb25zdCBzb2xpY2l0YWNhb0ZpbmFsID0gYXdhaXQgdHJhbnNhY3Rpb25hbEVudGl0eU1hbmFnZXJcbiAgICAgICAgICAuZ2V0UmVwb3NpdG9yeShTb2xpY2l0YWNhbylcbiAgICAgICAgICAuZmluZE9uZSh7IHdoZXJlOiB7IGlkOiBzb2xpY2l0YWNhb0lkIH0gfSk7XG5cbiAgICAgICAgaWYgKCFzb2xpY2l0YWNhb0ZpbmFsKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICAgICAnRXJybyBhbyBidXNjYXIgc29saWNpdGHDp8OjbyBhcMOzcyBhdHVhbGl6YcOnw6NvJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0YWRvID0ge1xuICAgICAgICAgIHN1Y2Vzc286IHRydWUsXG4gICAgICAgICAgc29saWNpdGFjYW86IHNvbGljaXRhY2FvRmluYWwsXG4gICAgICAgICAgbWVuc2FnZW06IGBTb2xpY2l0YcOnw6NvIGFsdGVyYWRhIGNvbSBzdWNlc3NvIHBhcmEgJHtub3ZvRXN0YWRvfWAsXG4gICAgICAgIH07XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgVHJhbnNpw6fDo28gZGEgc29saWNpdGHDp8OjbyAke3NvbGljaXRhY2FvSWR9IHBhcmEgJHtub3ZvRXN0YWRvfSBjb25jbHXDrWRhIGNvbSBzdWNlc3NvYCxcbiAgICAgICk7XG5cbiAgICAgIC8vIEF0dWFsaXphciBvcyBwcmF6b3MgY29tIGJhc2Ugbm8gbm92byBlc3RhZG8gZGEgc29saWNpdGHDp8Ojb1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcmF6b1NlcnZpY2UuYXR1YWxpemFyUHJhem9zVHJhbnNpY2FvKFxuICAgICAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICAgICAgbm92b0VzdGFkbyxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgIGBQcmF6b3MgYXR1YWxpemFkb3MgcGFyYSBhIHNvbGljaXRhw6fDo28gJHtzb2xpY2l0YWNhb0lkfWAsXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChwcmF6b0Vycm9yKSB7XG4gICAgICAgIC8vIEFwZW5hcyBsb2dhciBvIGVycm8gc2VtIGludGVycm9tcGVyIG8gZmx1eG8gcHJpbmNpcGFsXG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBFcnJvIGFvIGF0dWFsaXphciBwcmF6b3MgcGFyYSBhIHNvbGljaXRhw6fDo28gJHtzb2xpY2l0YWNhb0lkfTogJHtwcmF6b0Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgICBwcmF6b0Vycm9yLnN0YWNrLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0YWRvO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gbmEgdHJhbnNpw6fDo28gZGEgc29saWNpdGHDp8OjbyAke3NvbGljaXRhY2FvSWR9OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQmFkUmVxdWVzdEV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEZvcmJpZGRlbkV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRXJybyBhbyByZWFsaXphciB0cmFuc2nDp8OjbzogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gb3MgZXN0YWRvcyBwb3Nzw612ZWlzIHBhcmEgdW1hIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBlc3RhZG9zIHBvc3PDrXZlaXNcbiAgICovXG4gIGFzeW5jIGdldEVzdGFkb3NQb3NzaXZlaXMoXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPFN0YXR1c1NvbGljaXRhY2FvW10+IHtcbiAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghc29saWNpdGFjYW8pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGEnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy50cmFuc2ljYW9Fc3RhZG9TZXJ2aWNlLmdldEVzdGFkb3NQb3NzaXZlaXMoc29saWNpdGFjYW8uc3RhdHVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtYSBub3ZhIHNvbGljaXRhw6fDo28gbm8gZXN0YWRvIFJBU0NVTkhPXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0RhdGEgRGFkb3MgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcmV0dXJucyBTb2xpY2l0YcOnw6NvIGNyaWFkYVxuICAgKi9cbiAgYXN5bmMgY3JpYXJSYXNjdW5obyhcbiAgICBzb2xpY2l0YWNhb0RhdGE6IFBhcnRpYWw8U29saWNpdGFjYW8+LFxuICApOiBQcm9taXNlPFNvbGljaXRhY2FvPiB7XG4gICAgY29uc3Qgc29saWNpdGFjYW8gPSB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgLi4uc29saWNpdGFjYW9EYXRhLFxuICAgICAgc3RhdHVzOiBTdGF0dXNTb2xpY2l0YWNhby5SQVNDVU5ITyxcbiAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LnNhdmUoc29saWNpdGFjYW8pO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1Ym1ldGUgdW0gcmFzY3VuaG8gZGUgc29saWNpdGHDp8OjbywgYWx0ZXJhbmRvIHNldSBlc3RhZG8gcGFyYSBQRU5ERU5URVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIHN1Ym1ldGVuZG8gbyByYXNjdW5ob1xuICAgKiBAcmV0dXJucyBSZXN1bHRhZG8gZGEgdHJhbnNpw6fDo29cbiAgICovXG4gIGFzeW5jIHN1Ym1ldGVyUmFzY3VuaG8oXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICAgIHVzdWFyaW9JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPFJlc3VsdGFkb1RyYW5zaWNhb0VzdGFkbz4ge1xuICAgIHJldHVybiB0aGlzLnJlYWxpemFyVHJhbnNpY2FvKFxuICAgICAgc29saWNpdGFjYW9JZCxcbiAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkFCRVJUQSxcbiAgICAgIHVzdWFyaW9JZCxcbiAgICAgICdTb2xpY2l0YcOnw6NvIHN1Ym1ldGlkYScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnZpYSB1bWEgc29saWNpdGHDp8OjbyBwYXJhIGFuw6FsaXNlLCBhbHRlcmFuZG8gc2V1IGVzdGFkbyBwYXJhIEVNX0FOQUxJU0VcbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBlbnZpYW5kbyBhIHNvbGljaXRhw6fDo29cbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIHRyYW5zacOnw6NvXG4gICAqL1xuICBhc3luYyBlbnZpYXJQYXJhQW5hbGlzZShcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvPiB7XG4gICAgcmV0dXJuIHRoaXMucmVhbGl6YXJUcmFuc2ljYW8oXG4gICAgICBzb2xpY2l0YWNhb0lkLFxuICAgICAgU3RhdHVzU29saWNpdGFjYW8uRU1fQU5BTElTRSxcbiAgICAgIHVzdWFyaW9JZCxcbiAgICAgICdTb2xpY2l0YcOnw6NvIGVudmlhZGEgcGFyYSBhbsOhbGlzZScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmljaWEgYSBhbsOhbGlzZSBkZSB1bWEgc29saWNpdGHDp8OjbywgYWx0ZXJhbmRvIHNldSBlc3RhZG8gcGFyYSBFTV9BTkFMSVNFXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHVzdWFyaW9JZCBJRCBkbyB1c3XDoXJpbyBxdWUgZXN0w6EgaW5pY2lhbmRvIGEgYW7DoWxpc2VcbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIHRyYW5zacOnw6NvXG4gICAqL1xuICBhc3luYyBpbmljaWFyQW5hbGlzZShcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvPiB7XG4gICAgcmV0dXJuIHRoaXMucmVhbGl6YXJUcmFuc2ljYW8oXG4gICAgICBzb2xpY2l0YWNhb0lkLFxuICAgICAgU3RhdHVzU29saWNpdGFjYW8uRU1fQU5BTElTRSxcbiAgICAgIHVzdWFyaW9JZCxcbiAgICAgICdBbsOhbGlzZSBpbmljaWFkYScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHJvdmEgdW1hIHNvbGljaXRhw6fDo28sIGFsdGVyYW5kbyBzZXUgZXN0YWRvIHBhcmEgQVBST1ZBREFcbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBhcHJvdmFuZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBvYnNlcnZhY2FvIE9ic2VydmHDp8OjbyBzb2JyZSBhIGFwcm92YcOnw6NvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8Ojb1xuICAgKi9cbiAgYXN5bmMgYXByb3ZhclNvbGljaXRhY2FvKFxuICAgIHNvbGljaXRhY2FvSWQ6IHN0cmluZyxcbiAgICB1c3VhcmlvSWQ6IHN0cmluZyxcbiAgICBvYnNlcnZhY2FvOiBzdHJpbmcsXG4gICAgcGFyZWNlclNlbXRhczogc3RyaW5nLFxuICApOiBQcm9taXNlPFJlc3VsdGFkb1RyYW5zaWNhb0VzdGFkbz4ge1xuICAgIC8vIFByaW1laXJvLCBhdHVhbGl6YXIgbyBwYXJlY2VyIFNFTVRBUyBuYSBzb2xpY2l0YcOnw6NvXG4gICAgYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkudXBkYXRlKHNvbGljaXRhY2FvSWQsIHtcbiAgICAgIHBhcmVjZXJfc2VtdGFzOiBwYXJlY2VyU2VtdGFzLFxuICAgICAgYXByb3ZhZG9yX2lkOiB1c3VhcmlvSWQsXG4gICAgICBkYXRhX2Fwcm92YWNhbzogbmV3IERhdGUoKSxcbiAgICB9KTtcblxuICAgIC8vIFZhbGlkYXIgc2UgYSBzb2xpY2l0YcOnw6NvIHBvZGUgc2VyIGFwcm92YWRhIChyZWdyYXMgZGUgbmVnw7NjaW8pXG4gICAgYXdhaXQgdGhpcy52YWxpZGFjYW9TZXJ2aWNlLnZhbGlkYXJBcHJvdmFjYW8oc29saWNpdGFjYW9JZCk7XG5cbiAgICAvLyBTZSBwYXNzYXIgbmEgdmFsaWRhw6fDo28sIHJlYWxpemFyIGEgdHJhbnNpw6fDo29cbiAgICByZXR1cm4gdGhpcy5yZWFsaXphclRyYW5zaWNhbyhcbiAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5BUFJPVkFEQSxcbiAgICAgIHVzdWFyaW9JZCxcbiAgICAgIG9ic2VydmFjYW8sXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaWJlcmEgdW1hIHNvbGljaXRhw6fDo28gYXByb3ZhZGEsIGFsdGVyYW5kbyBzZXUgZXN0YWRvIHBhcmEgTElCRVJBREFcbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBsaWJlcmFuZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8Ojb1xuICAgKi9cbiAgYXN5bmMgbGliZXJhclNvbGljaXRhY2FvKFxuICAgIHNvbGljaXRhY2FvSWQ6IHN0cmluZyxcbiAgICB1c3VhcmlvSWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSZXN1bHRhZG9UcmFuc2ljYW9Fc3RhZG8+IHtcbiAgICAvLyBWYWxpZGFyIHNlIGEgc29saWNpdGHDp8OjbyBwb2RlIHNlciBsaWJlcmFkYSAocmVncmFzIGRlIG5lZ8OzY2lvKVxuICAgIGF3YWl0IHRoaXMudmFsaWRhY2FvU2VydmljZS52YWxpZGFyTGliZXJhY2FvKHNvbGljaXRhY2FvSWQpO1xuXG4gICAgLy8gUmVnaXN0cmFyIG8gbGliZXJhZG9yIGRhIHNvbGljaXRhw6fDo28gZSBhIGRhdGEgZGUgbGliZXJhw6fDo29cbiAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmIChzb2xpY2l0YWNhbykge1xuICAgICAgc29saWNpdGFjYW8ubGliZXJhZG9yX2lkID0gdXN1YXJpb0lkO1xuICAgICAgc29saWNpdGFjYW8uZGF0YV9saWJlcmFjYW8gPSBuZXcgRGF0ZSgpO1xuICAgICAgYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuc2F2ZShzb2xpY2l0YWNhbyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGEnKTtcbiAgICB9XG5cbiAgICAvLyBTZSBwYXNzYXIgbmEgdmFsaWRhw6fDo28sIHJlYWxpemFyIGEgdHJhbnNpw6fDo29cbiAgICByZXR1cm4gdGhpcy5yZWFsaXphclRyYW5zaWNhbyhcbiAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5MSUJFUkFEQSxcbiAgICAgIHVzdWFyaW9JZCxcbiAgICAgICdTb2xpY2l0YcOnw6NvIGxpYmVyYWRhJyxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlamVpdGEgdW1hIHNvbGljaXRhw6fDo28sIGFsdGVyYW5kbyBzZXUgZXN0YWRvIHBhcmEgSU5ERUZFUklEQVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIHJlamVpdGFuZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBtb3Rpdm8gTW90aXZvIGRhIHJlamVpw6fDo29cbiAgICogQHJldHVybnMgUmVzdWx0YWRvIGRhIHRyYW5zacOnw6NvXG4gICAqL1xuICBhc3luYyByZWplaXRhclNvbGljaXRhY2FvKFxuICAgIHNvbGljaXRhY2FvSWQ6IHN0cmluZyxcbiAgICB1c3VhcmlvSWQ6IHN0cmluZyxcbiAgICBtb3Rpdm86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSZXN1bHRhZG9UcmFuc2ljYW9Fc3RhZG8+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFsaXphclRyYW5zaWNhbyhcbiAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5JTkRFRkVSSURBLFxuICAgICAgdXN1YXJpb0lkLFxuICAgICAgbW90aXZvIHx8ICdTb2xpY2l0YcOnw6NvIHJlcHJvdmFkYScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxhIHVtYSBzb2xpY2l0YcOnw6NvLCBhbHRlcmFuZG8gc2V1IGVzdGFkbyBwYXJhIENBTkNFTEFEQVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGNhbmNlbGFuZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBtb3Rpdm8gTW90aXZvIGRvIGNhbmNlbGFtZW50b1xuICAgKiBAcmV0dXJucyBSZXN1bHRhZG8gZGEgdHJhbnNpw6fDo29cbiAgICovXG4gIGFzeW5jIGNhbmNlbGFyU29saWNpdGFjYW8oXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICAgIHVzdWFyaW9JZDogc3RyaW5nLFxuICAgIG1vdGl2bzogc3RyaW5nLFxuICApOiBQcm9taXNlPFJlc3VsdGFkb1RyYW5zaWNhb0VzdGFkbz4ge1xuICAgIC8vIFZhbGlkYXIgc2UgYSBzb2xpY2l0YcOnw6NvIHBvZGUgc2VyIGNhbmNlbGFkYSAocmVncmFzIGRlIG5lZ8OzY2lvKVxuICAgIGF3YWl0IHRoaXMudmFsaWRhY2FvU2VydmljZS52YWxpZGFyQ2FuY2VsYW1lbnRvKHNvbGljaXRhY2FvSWQpO1xuXG4gICAgLy8gU2UgcGFzc2FyIG5hIHZhbGlkYcOnw6NvLCByZWFsaXphciBhIHRyYW5zacOnw6NvXG4gICAgcmV0dXJuIHRoaXMucmVhbGl6YXJUcmFuc2ljYW8oXG4gICAgICBzb2xpY2l0YWNhb0lkLFxuICAgICAgU3RhdHVzU29saWNpdGFjYW8uQ0FOQ0VMQURBLFxuICAgICAgdXN1YXJpb0lkLFxuICAgICAgbW90aXZvIHx8ICdTb2xpY2l0YcOnw6NvIGNhbmNlbGFkYScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmljaWEgbyBwcm9jZXNzYW1lbnRvIGRlIHVtYSBzb2xpY2l0YcOnw6NvLCBhbHRlcmFuZG8gc2V1IGVzdGFkbyBwYXJhIEVNX1BST0NFU1NBTUVOVE9cbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gdXN1YXJpb0lkIElEIGRvIHVzdcOhcmlvIHF1ZSBlc3TDoSBpbmljaWFuZG8gbyBwcm9jZXNzYW1lbnRvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8Ojb1xuICAgKi9cbiAgYXN5bmMgaW5pY2lhclByb2Nlc3NhbWVudG8oXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICAgIHVzdWFyaW9JZDogc3RyaW5nLFxuICApOiBQcm9taXNlPFJlc3VsdGFkb1RyYW5zaWNhb0VzdGFkbz4ge1xuICAgIHJldHVybiB0aGlzLnJlYWxpemFyVHJhbnNpY2FvKFxuICAgICAgc29saWNpdGFjYW9JZCxcbiAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkVNX1BST0NFU1NBTUVOVE8sXG4gICAgICB1c3VhcmlvSWQsXG4gICAgICAnUHJvY2Vzc2FtZW50byBpbmljaWFkbycsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25jbHVpIHVtYSBzb2xpY2l0YcOnw6NvLCBhbHRlcmFuZG8gc2V1IGVzdGFkbyBwYXJhIENPTkNMVUlEQVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGNvbmNsdWluZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8Ojb1xuICAgKi9cbiAgYXN5bmMgY29uY2x1aXJTb2xpY2l0YWNhbyhcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvPiB7XG4gICAgLy8gVmFsaWRhciBzZSBhIHNvbGljaXRhw6fDo28gcG9kZSBzZXIgY29uY2x1w61kYSAocmVncmFzIGRlIG5lZ8OzY2lvKVxuICAgIGF3YWl0IHRoaXMudmFsaWRhY2FvU2VydmljZS52YWxpZGFyQ29uY2x1c2FvKHNvbGljaXRhY2FvSWQpO1xuXG4gICAgLy8gU2UgcGFzc2FyIG5hIHZhbGlkYcOnw6NvLCByZWFsaXphciBhIHRyYW5zacOnw6NvXG4gICAgcmV0dXJuIHRoaXMucmVhbGl6YXJUcmFuc2ljYW8oXG4gICAgICBzb2xpY2l0YWNhb0lkLFxuICAgICAgU3RhdHVzU29saWNpdGFjYW8uQ09OQ0xVSURBLFxuICAgICAgdXN1YXJpb0lkLFxuICAgICAgJ1NvbGljaXRhw6fDo28gY29uY2x1w61kYScsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcnF1aXZhIHVtYSBzb2xpY2l0YcOnw6NvLCBhbHRlcmFuZG8gc2V1IGVzdGFkbyBwYXJhIEFSUVVJVkFEQVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGFycXVpdmFuZG8gYSBzb2xpY2l0YcOnw6NvXG4gICAqIEByZXR1cm5zIFJlc3VsdGFkbyBkYSB0cmFuc2nDp8Ojb1xuICAgKi9cbiAgYXN5bmMgYXJxdWl2YXJTb2xpY2l0YWNhbyhcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvPiB7XG4gICAgLy8gVmFsaWRhciBzZSBhIHNvbGljaXRhw6fDo28gcG9kZSBzZXIgYXJxdWl2YWRhIChyZWdyYXMgZGUgbmVnw7NjaW8pXG4gICAgYXdhaXQgdGhpcy52YWxpZGFjYW9TZXJ2aWNlLnZhbGlkYXJBcnF1aXZhbWVudG8oc29saWNpdGFjYW9JZCk7XG5cbiAgICAvLyBTZSBwYXNzYXIgbmEgdmFsaWRhw6fDo28sIHJlYWxpemFyIGEgdHJhbnNpw6fDo29cbiAgICByZXR1cm4gdGhpcy5yZWFsaXphclRyYW5zaWNhbyhcbiAgICAgIHNvbGljaXRhY2FvSWQsXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5BUlFVSVZBREEsXG4gICAgICB1c3VhcmlvSWQsXG4gICAgICAnU29saWNpdGHDp8OjbyBhcnF1aXZhZGEnLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgbyBzdGF0dXMgZGUgdW1hIHNvbGljaXRhw6fDo28gY29tIGluZm9ybWHDp8O1ZXMgYWRpY2lvbmFpcyBwYXJhIGNvbmZvcm1pZGFkZVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBub3ZvU3RhdHVzIE5vdm8gc3RhdHVzIGRlc2VqYWRvXG4gICAqIEBwYXJhbSB1c3VhcmlvSWQgSUQgZG8gdXN1w6FyaW8gcXVlIGVzdMOhIGF0dWFsaXphbmRvIG8gc3RhdHVzXG4gICAqIEBwYXJhbSBkYWRvc0FkaWNpb25haXMgRGFkb3MgYWRpY2lvbmFpcyBwYXJhIGEgYXR1YWxpemHDp8Ojb1xuICAgKiBAcmV0dXJucyBSZXN1bHRhZG8gZGEgdHJhbnNpw6fDo29cbiAgICovXG4gIGFzeW5jIGF0dWFsaXphclN0YXR1cyhcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgbm92b1N0YXR1czogU3RhdHVzU29saWNpdGFjYW8sXG4gICAgdXN1YXJpb0lkOiBzdHJpbmcsXG4gICAgZGFkb3NBZGljaW9uYWlzOiB7XG4gICAgICBvYnNlcnZhY2FvPzogc3RyaW5nO1xuICAgICAgcHJvY2Vzc29fanVkaWNpYWxfaWQ/OiBzdHJpbmc7XG4gICAgICBkZXRlcm1pbmFjYW9fanVkaWNpYWxfaWQ/OiBzdHJpbmc7XG4gICAgICBqdXN0aWZpY2F0aXZhPzogc3RyaW5nO1xuICAgIH0sXG4gICk6IFByb21pc2U8UmVzdWx0YWRvVHJhbnNpY2FvRXN0YWRvPiB7XG4gICAgY29uc3QgcXVlcnlSdW5uZXIgPSB0aGlzLmRhdGFTb3VyY2UuY3JlYXRlUXVlcnlSdW5uZXIoKTtcbiAgICBhd2FpdCBxdWVyeVJ1bm5lci5jb25uZWN0KCk7XG4gICAgYXdhaXQgcXVlcnlSdW5uZXIuc3RhcnRUcmFuc2FjdGlvbigpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEJ1c2NhciBhIHNvbGljaXRhw6fDo29cbiAgICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFzb2xpY2l0YWNhbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1NvbGljaXRhw6fDo28gbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmaWNhciBzZSBhIHRyYW5zacOnw6NvIMOpIHBlcm1pdGlkYVxuICAgICAgaWYgKCF0aGlzLmlzVHJhbnNpY2FvUGVybWl0aWRhKHNvbGljaXRhY2FvLnN0YXR1cywgbm92b1N0YXR1cykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbihcbiAgICAgICAgICBgVHJhbnNpw6fDo28gZGUgZXN0YWRvIGRlICR7c29saWNpdGFjYW8uc3RhdHVzfSBwYXJhICR7bm92b1N0YXR1c30gbsOjbyDDqSBwZXJtaXRpZGFgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25zdHJ1aXIgYSBvYnNlcnZhw6fDo28gY29tIG9zIGRhZG9zIGFkaWNpb25haXNcbiAgICAgIGxldCBvYnNlcnZhY2FvQ29tcGxldGEgPSBkYWRvc0FkaWNpb25haXMub2JzZXJ2YWNhbyB8fCAnJztcblxuICAgICAgaWYgKGRhZG9zQWRpY2lvbmFpcy5qdXN0aWZpY2F0aXZhKSB7XG4gICAgICAgIG9ic2VydmFjYW9Db21wbGV0YSArPSBgXFxuSnVzdGlmaWNhdGl2YTogJHtkYWRvc0FkaWNpb25haXMuanVzdGlmaWNhdGl2YX1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGFkb3NBZGljaW9uYWlzLnByb2Nlc3NvX2p1ZGljaWFsX2lkKSB7XG4gICAgICAgIG9ic2VydmFjYW9Db21wbGV0YSArPSBgXFxuUHJvY2Vzc28gSnVkaWNpYWwgSUQ6ICR7ZGFkb3NBZGljaW9uYWlzLnByb2Nlc3NvX2p1ZGljaWFsX2lkfWA7XG4gICAgICB9XG5cbiAgICAgIGlmIChkYWRvc0FkaWNpb25haXMuZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2lkKSB7XG4gICAgICAgIG9ic2VydmFjYW9Db21wbGV0YSArPSBgXFxuRGV0ZXJtaW5hw6fDo28gSnVkaWNpYWwgSUQ6ICR7ZGFkb3NBZGljaW9uYWlzLmRldGVybWluYWNhb19qdWRpY2lhbF9pZH1gO1xuICAgICAgfVxuXG4gICAgICAvLyBTYWx2YXIgbyBlc3RhZG8gYW50ZXJpb3IgcGFyYSBvIHJldG9ybm9cbiAgICAgIGNvbnN0IHN0YXR1c0FudGVyaW9yID0gc29saWNpdGFjYW8uc3RhdHVzO1xuXG4gICAgICAvLyBQcmVwYXJhciBkYWRvcyBhZGljaW9uYWlzIHBhcmEgYXR1YWxpemHDp8Ojb1xuICAgICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0ge1xuICAgICAgICBzdGF0dXM6IG5vdm9TdGF0dXMsXG4gICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCksXG4gICAgICB9O1xuXG4gICAgICAvLyBBZGljaW9uYXIgZGFkb3MgYWRpY2lvbmFpcywgc2UgZXhpc3RpcmVtXG4gICAgICBpZiAoZGFkb3NBZGljaW9uYWlzLnByb2Nlc3NvX2p1ZGljaWFsX2lkKSB7XG4gICAgICAgIHVwZGF0ZURhdGEucHJvY2Vzc29fanVkaWNpYWxfaWQgPSBkYWRvc0FkaWNpb25haXMucHJvY2Vzc29fanVkaWNpYWxfaWQ7XG4gICAgICAgIHVwZGF0ZURhdGEuZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2ZsYWcgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGFkb3NBZGljaW9uYWlzLmRldGVybWluYWNhb19qdWRpY2lhbF9pZCkge1xuICAgICAgICB1cGRhdGVEYXRhLmRldGVybWluYWNhb19qdWRpY2lhbF9pZCA9XG4gICAgICAgICAgZGFkb3NBZGljaW9uYWlzLmRldGVybWluYWNhb19qdWRpY2lhbF9pZDtcbiAgICAgICAgdXBkYXRlRGF0YS5kZXRlcm1pbmFjYW9fanVkaWNpYWxfZmxhZyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIC8vIEF0dWFsaXphciBhIHNvbGljaXRhw6fDo28gdXNhbmRvIG8gcXVlcnlSdW5uZXJcbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLm1hbmFnZXIudXBkYXRlKFxuICAgICAgICBTb2xpY2l0YWNhbyxcbiAgICAgICAgeyBpZDogc29saWNpdGFjYW9JZCB9LFxuICAgICAgICB1cGRhdGVEYXRhLFxuICAgICAgKTtcblxuICAgICAgLy8gUmVnaXN0cmFyIGEgdHJhbnNpw6fDo28gbm8gaGlzdMOzcmljb1xuICAgICAgY29uc3QgaGlzdG9yaWNvID0gbmV3IEhpc3Rvcmljb1NvbGljaXRhY2FvKCk7XG4gICAgICBoaXN0b3JpY28uc29saWNpdGFjYW9faWQgPSBzb2xpY2l0YWNhb0lkO1xuICAgICAgaGlzdG9yaWNvLnN0YXR1c19hbnRlcmlvciA9IHN0YXR1c0FudGVyaW9yO1xuICAgICAgaGlzdG9yaWNvLnN0YXR1c19hdHVhbCA9IG5vdm9TdGF0dXM7XG4gICAgICBoaXN0b3JpY28udXN1YXJpb19pZCA9IHVzdWFyaW9JZDtcbiAgICAgIGhpc3Rvcmljby5vYnNlcnZhY2FvID1cbiAgICAgICAgb2JzZXJ2YWNhb0NvbXBsZXRhIHx8XG4gICAgICAgIGBTdGF0dXMgYXR1YWxpemFkbyBkZSAke3N0YXR1c0FudGVyaW9yfSBwYXJhICR7bm92b1N0YXR1c31gO1xuICAgICAgaGlzdG9yaWNvLmNyZWF0ZWRfYXQgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICBhd2FpdCBxdWVyeVJ1bm5lci5tYW5hZ2VyLnNhdmUoSGlzdG9yaWNvU29saWNpdGFjYW8sIGhpc3Rvcmljbyk7XG5cbiAgICAgIGF3YWl0IHF1ZXJ5UnVubmVyLmNvbW1pdFRyYW5zYWN0aW9uKCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Vzc286IHRydWUsXG4gICAgICAgIG1lbnNhZ2VtOiBgU3RhdHVzIGF0dWFsaXphZG8gY29tIHN1Y2Vzc28gZGUgJHtzdGF0dXNBbnRlcmlvcn0gcGFyYSAke25vdm9TdGF0dXN9YCxcbiAgICAgICAgc3RhdHVzX2FudGVyaW9yOiBzdGF0dXNBbnRlcmlvcixcbiAgICAgICAgc3RhdHVzX2F0dWFsOiBub3ZvU3RhdHVzLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIucm9sbGJhY2tUcmFuc2FjdGlvbigpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgc2Ugw6kgdW0gZXJybyBkZSB2ZXJzw6NvIChjb25mbGl0byBkZSBjb25jb3Jyw6puY2lhKVxuICAgICAgaWYgKFxuICAgICAgICBlcnJvci5uYW1lID09PSAnUXVlcnlGYWlsZWRFcnJvcicgJiZcbiAgICAgICAgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ3ZlcnNpb24nKSB8fFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ3ZlcnNpb24gbWlzbWF0Y2gnKSlcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnQSBzb2xpY2l0YcOnw6NvIGZvaSBtb2RpZmljYWRhIHBvciBvdXRybyB1c3XDoXJpbyBlbnF1YW50byB2b2PDqiBhIGVkaXRhdmEuICcgK1xuICAgICAgICAgICAgJ1BvciBmYXZvciwgYXR1YWxpemUgYSBww6FnaW5hIGUgdGVudGUgbm92YW1lbnRlLicsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEZvcmJpZGRlbkV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb25cbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIGF0dWFsaXphciBzdGF0dXMgZGEgc29saWNpdGHDp8OjbzogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBhbyBhdHVhbGl6YXIgc3RhdHVzIGRhIHNvbGljaXRhw6fDo28nLFxuICAgICAgKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgcXVlcnlSdW5uZXIucmVsZWFzZSgpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9