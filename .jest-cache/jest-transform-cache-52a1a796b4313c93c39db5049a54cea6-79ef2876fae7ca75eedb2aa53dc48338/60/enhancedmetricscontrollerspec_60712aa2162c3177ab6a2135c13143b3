984b6752e9e2c30b2c67d4c6724da147
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const enhanced_metrics_controller_1 = require("../enhanced-metrics.controller");
const enhanced_metrics_service_1 = require("../enhanced-metrics.service");
/**
 * Testes unitários para o controlador de métricas aprimoradas
 *
 * Verifica o funcionamento do endpoint que expõe as métricas
 * avançadas da aplicação para o Prometheus, com foco em segurança e compliance LGPD
 */
describe('EnhancedMetricsController', () => {
    let controller;
    let metricsService;
    // Mock do serviço de métricas aprimoradas
    const mockMetricsService = {
        getMetrics: jest
            .fn()
            .mockResolvedValue('enhanced_metrics_data\nsecurity_metric 1\ndocument_metric 1\nsystem_metric 1\ncache_operations_total 10\ncache_hit_ratio 0.75'),
        updateMemoryUsage: jest.fn(),
    };
    beforeEach(async () => {
        jest.clearAllMocks();
        const module = await testing_1.Test.createTestingModule({
            controllers: [enhanced_metrics_controller_1.EnhancedMetricsController],
            providers: [
                {
                    provide: enhanced_metrics_service_1.EnhancedMetricsService,
                    useValue: mockMetricsService,
                },
            ],
        }).compile();
        controller = module.get(enhanced_metrics_controller_1.EnhancedMetricsController);
        metricsService = module.get(enhanced_metrics_service_1.EnhancedMetricsService);
    });
    it('deve ser definido', () => {
        expect(controller).toBeDefined();
    });
    describe('getMetrics', () => {
        it('deve retornar todas as métricas no formato correto', async () => {
            // Mock da resposta
            const mockResponse = {
                setHeader: jest.fn(),
                send: jest.fn().mockReturnThis(),
            };
            await controller.getMetrics(mockResponse);
            expect(metricsService.getMetrics).toHaveBeenCalled();
            expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/plain');
            // Verificar se a resposta contém as métricas esperadas
            expect(mockResponse.send).toHaveBeenCalled();
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('enhanced_metrics_data'));
        });
    });
    describe('getSecurityMetrics', () => {
        it('deve retornar as métricas de segurança no formato correto', async () => {
            // Mock da resposta
            const mockResponse = {
                setHeader: jest.fn(),
                send: jest.fn().mockReturnThis(),
            };
            // Configurar o mock para retornar métricas de segurança
            mockMetricsService.getMetrics.mockResolvedValueOnce('security_metric 1\nsecurity_metric 2\ndocument_metric 1');
            await controller.getSecurityMetrics(mockResponse);
            expect(mockMetricsService.getMetrics).toHaveBeenCalled();
            expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/plain');
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('security_metric 1'));
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('security_metric 2'));
        });
    });
    describe('getDocumentMetrics', () => {
        it('deve retornar as métricas de documentos no formato correto', async () => {
            // Mock da resposta
            const mockResponse = {
                setHeader: jest.fn(),
                send: jest.fn().mockReturnThis(),
            };
            // Configurar o mock para retornar métricas de documentos
            mockMetricsService.getMetrics.mockResolvedValueOnce('document_metric 1\ndocument_metric 2\nsecurity_metric 1');
            await controller.getDocumentMetrics(mockResponse);
            expect(mockMetricsService.getMetrics).toHaveBeenCalled();
            expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/plain');
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('document_metric 1'));
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('document_metric 2'));
        });
    });
    describe('getSystemMetrics', () => {
        it('deve retornar as métricas de sistema no formato correto', async () => {
            // Mock da resposta
            const mockResponse = {
                setHeader: jest.fn(),
                send: jest.fn().mockReturnThis(),
            };
            // Configurar o mock para retornar métricas de sistema
            mockMetricsService.getMetrics.mockResolvedValueOnce('system_metric 1\nsystem_metric 2\nsecurity_metric 1');
            await controller.getSystemMetrics(mockResponse);
            expect(mockMetricsService.updateMemoryUsage).toHaveBeenCalled();
            expect(mockMetricsService.getMetrics).toHaveBeenCalled();
            expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/plain');
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('system_metric 1'));
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('system_metric 2'));
        });
    });
    describe('getCacheMetrics', () => {
        it('deve retornar as métricas de cache no formato correto', async () => {
            // Mock da resposta
            const mockResponse = {
                setHeader: jest.fn(),
                send: jest.fn().mockReturnThis(),
            };
            // Configurar o mock para retornar métricas de cache
            mockMetricsService.getMetrics.mockResolvedValueOnce('cache_operations_total 10\ncache_hit_ratio 0.75\nsystem_metric 1');
            await controller.getCacheMetrics(mockResponse);
            expect(metricsService.getMetrics).toHaveBeenCalled();
            expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/plain');
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('cache_operations_total 10'));
            expect(mockResponse.send).toHaveBeenCalledWith(expect.stringContaining('cache_hit_ratio 0.75'));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcdGVzdHNcXGVuaGFuY2VkLW1ldHJpY3MuY29udHJvbGxlci5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELGdGQUEyRTtBQUMzRSwwRUFBcUU7QUFJckU7Ozs7O0dBS0c7QUFDSCxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksVUFBcUMsQ0FBQztJQUMxQyxJQUFJLGNBQXNDLENBQUM7SUFFM0MsMENBQTBDO0lBQzFDLE1BQU0sa0JBQWtCLEdBQUc7UUFDekIsVUFBVSxFQUFFLElBQUk7YUFDYixFQUFFLEVBQUU7YUFDSixpQkFBaUIsQ0FDaEIsK0hBQStILENBQ2hJO1FBQ0gsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUM3QixDQUFDO0lBRUYsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUVyQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsV0FBVyxFQUFFLENBQUMsdURBQXlCLENBQUM7WUFDeEMsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE9BQU8sRUFBRSxpREFBc0I7b0JBQy9CLFFBQVEsRUFBRSxrQkFBa0I7aUJBQzdCO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDckIsdURBQXlCLENBQzFCLENBQUM7UUFDRixjQUFjLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBeUIsaURBQXNCLENBQUMsQ0FBQztJQUM5RSxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDM0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFdBQVcs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XFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcbW9uaXRvcmluZ1xcdGVzdHNcXGVuaGFuY2VkLW1ldHJpY3MuY29udHJvbGxlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgRW5oYW5jZWRNZXRyaWNzQ29udHJvbGxlciB9IGZyb20gJy4uL2VuaGFuY2VkLW1ldHJpY3MuY29udHJvbGxlcic7XG5pbXBvcnQgeyBFbmhhbmNlZE1ldHJpY3NTZXJ2aWNlIH0gZnJvbSAnLi4vZW5oYW5jZWQtbWV0cmljcy5zZXJ2aWNlJztcbmltcG9ydCB7IFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBQdWJsaWMgfSBmcm9tICcuLi8uLi8uLi9hdXRoL2RlY29yYXRvcnMvcHVibGljLmRlY29yYXRvcic7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIGNvbnRyb2xhZG9yIGRlIG3DqXRyaWNhcyBhcHJpbW9yYWRhc1xuICpcbiAqIFZlcmlmaWNhIG8gZnVuY2lvbmFtZW50byBkbyBlbmRwb2ludCBxdWUgZXhww7VlIGFzIG3DqXRyaWNhc1xuICogYXZhbsOnYWRhcyBkYSBhcGxpY2HDp8OjbyBwYXJhIG8gUHJvbWV0aGV1cywgY29tIGZvY28gZW0gc2VndXJhbsOnYSBlIGNvbXBsaWFuY2UgTEdQRFxuICovXG5kZXNjcmliZSgnRW5oYW5jZWRNZXRyaWNzQ29udHJvbGxlcicsICgpID0+IHtcbiAgbGV0IGNvbnRyb2xsZXI6IEVuaGFuY2VkTWV0cmljc0NvbnRyb2xsZXI7XG4gIGxldCBtZXRyaWNzU2VydmljZTogRW5oYW5jZWRNZXRyaWNzU2VydmljZTtcblxuICAvLyBNb2NrIGRvIHNlcnZpw6dvIGRlIG3DqXRyaWNhcyBhcHJpbW9yYWRhc1xuICBjb25zdCBtb2NrTWV0cmljc1NlcnZpY2UgPSB7XG4gICAgZ2V0TWV0cmljczogamVzdFxuICAgICAgLmZuKClcbiAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShcbiAgICAgICAgJ2VuaGFuY2VkX21ldHJpY3NfZGF0YVxcbnNlY3VyaXR5X21ldHJpYyAxXFxuZG9jdW1lbnRfbWV0cmljIDFcXG5zeXN0ZW1fbWV0cmljIDFcXG5jYWNoZV9vcGVyYXRpb25zX3RvdGFsIDEwXFxuY2FjaGVfaGl0X3JhdGlvIDAuNzUnLFxuICAgICAgKSxcbiAgICB1cGRhdGVNZW1vcnlVc2FnZTogamVzdC5mbigpLFxuICB9O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGNvbnRyb2xsZXJzOiBbRW5oYW5jZWRNZXRyaWNzQ29udHJvbGxlcl0sXG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEVuaGFuY2VkTWV0cmljc1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tNZXRyaWNzU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgY29udHJvbGxlciA9IG1vZHVsZS5nZXQ8RW5oYW5jZWRNZXRyaWNzQ29udHJvbGxlcj4oXG4gICAgICBFbmhhbmNlZE1ldHJpY3NDb250cm9sbGVyLFxuICAgICk7XG4gICAgbWV0cmljc1NlcnZpY2UgPSBtb2R1bGUuZ2V0PEVuaGFuY2VkTWV0cmljc1NlcnZpY2U+KEVuaGFuY2VkTWV0cmljc1NlcnZpY2UpO1xuICB9KTtcblxuICBpdCgnZGV2ZSBzZXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KGNvbnRyb2xsZXIpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRNZXRyaWNzJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIHRvZGFzIGFzIG3DqXRyaWNhcyBubyBmb3JtYXRvIGNvcnJldG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGRhIHJlc3Bvc3RhXG4gICAgICBjb25zdCBtb2NrUmVzcG9uc2UgPSB7XG4gICAgICAgIHNldEhlYWRlcjogamVzdC5mbigpLFxuICAgICAgICBzZW5kOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIH0gYXMgdW5rbm93biBhcyBSZXNwb25zZTtcblxuICAgICAgYXdhaXQgY29udHJvbGxlci5nZXRNZXRyaWNzKG1vY2tSZXNwb25zZSk7XG5cbiAgICAgIGV4cGVjdChtZXRyaWNzU2VydmljZS5nZXRNZXRyaWNzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNldEhlYWRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdDb250ZW50LVR5cGUnLFxuICAgICAgICAndGV4dC9wbGFpbicsXG4gICAgICApO1xuICAgICAgLy8gVmVyaWZpY2FyIHNlIGEgcmVzcG9zdGEgY29udMOpbSBhcyBtw6l0cmljYXMgZXNwZXJhZGFzXG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdlbmhhbmNlZF9tZXRyaWNzX2RhdGEnKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRTZWN1cml0eU1ldHJpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgYXMgbcOpdHJpY2FzIGRlIHNlZ3VyYW7Dp2Egbm8gZm9ybWF0byBjb3JyZXRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTW9jayBkYSByZXNwb3N0YVxuICAgICAgY29uc3QgbW9ja1Jlc3BvbnNlID0ge1xuICAgICAgICBzZXRIZWFkZXI6IGplc3QuZm4oKSxcbiAgICAgICAgc2VuZDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVzcG9uc2U7XG5cbiAgICAgIC8vIENvbmZpZ3VyYXIgbyBtb2NrIHBhcmEgcmV0b3JuYXIgbcOpdHJpY2FzIGRlIHNlZ3VyYW7Dp2FcbiAgICAgIG1vY2tNZXRyaWNzU2VydmljZS5nZXRNZXRyaWNzLm1vY2tSZXNvbHZlZFZhbHVlT25jZShcbiAgICAgICAgJ3NlY3VyaXR5X21ldHJpYyAxXFxuc2VjdXJpdHlfbWV0cmljIDJcXG5kb2N1bWVudF9tZXRyaWMgMScsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmdldFNlY3VyaXR5TWV0cmljcyhtb2NrUmVzcG9uc2UpO1xuXG4gICAgICBleHBlY3QobW9ja01ldHJpY3NTZXJ2aWNlLmdldE1ldHJpY3MpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc2V0SGVhZGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ0NvbnRlbnQtVHlwZScsXG4gICAgICAgICd0ZXh0L3BsYWluJyxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnc2VjdXJpdHlfbWV0cmljIDEnKSxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnc2VjdXJpdHlfbWV0cmljIDInKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXREb2N1bWVudE1ldHJpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgYXMgbcOpdHJpY2FzIGRlIGRvY3VtZW50b3Mgbm8gZm9ybWF0byBjb3JyZXRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTW9jayBkYSByZXNwb3N0YVxuICAgICAgY29uc3QgbW9ja1Jlc3BvbnNlID0ge1xuICAgICAgICBzZXRIZWFkZXI6IGplc3QuZm4oKSxcbiAgICAgICAgc2VuZDogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICB9IGFzIHVua25vd24gYXMgUmVzcG9uc2U7XG5cbiAgICAgIC8vIENvbmZpZ3VyYXIgbyBtb2NrIHBhcmEgcmV0b3JuYXIgbcOpdHJpY2FzIGRlIGRvY3VtZW50b3NcbiAgICAgIG1vY2tNZXRyaWNzU2VydmljZS5nZXRNZXRyaWNzLm1vY2tSZXNvbHZlZFZhbHVlT25jZShcbiAgICAgICAgJ2RvY3VtZW50X21ldHJpYyAxXFxuZG9jdW1lbnRfbWV0cmljIDJcXG5zZWN1cml0eV9tZXRyaWMgMScsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmdldERvY3VtZW50TWV0cmljcyhtb2NrUmVzcG9uc2UpO1xuXG4gICAgICBleHBlY3QobW9ja01ldHJpY3NTZXJ2aWNlLmdldE1ldHJpY3MpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc2V0SGVhZGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ0NvbnRlbnQtVHlwZScsXG4gICAgICAgICd0ZXh0L3BsYWluJyxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnZG9jdW1lbnRfbWV0cmljIDEnKSxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnZG9jdW1lbnRfbWV0cmljIDInKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRTeXN0ZW1NZXRyaWNzJywgKCkgPT4ge1xuICAgIGl0KCdkZXZlIHJldG9ybmFyIGFzIG3DqXRyaWNhcyBkZSBzaXN0ZW1hIG5vIGZvcm1hdG8gY29ycmV0bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgZGEgcmVzcG9zdGFcbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgc2V0SGVhZGVyOiBqZXN0LmZuKCksXG4gICAgICAgIHNlbmQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlc3BvbnNlO1xuXG4gICAgICAvLyBDb25maWd1cmFyIG8gbW9jayBwYXJhIHJldG9ybmFyIG3DqXRyaWNhcyBkZSBzaXN0ZW1hXG4gICAgICBtb2NrTWV0cmljc1NlcnZpY2UuZ2V0TWV0cmljcy5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoXG4gICAgICAgICdzeXN0ZW1fbWV0cmljIDFcXG5zeXN0ZW1fbWV0cmljIDJcXG5zZWN1cml0eV9tZXRyaWMgMScsXG4gICAgICApO1xuXG4gICAgICBhd2FpdCBjb250cm9sbGVyLmdldFN5c3RlbU1ldHJpY3MobW9ja1Jlc3BvbnNlKTtcblxuICAgICAgZXhwZWN0KG1vY2tNZXRyaWNzU2VydmljZS51cGRhdGVNZW1vcnlVc2FnZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KG1vY2tNZXRyaWNzU2VydmljZS5nZXRNZXRyaWNzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNldEhlYWRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdDb250ZW50LVR5cGUnLFxuICAgICAgICAndGV4dC9wbGFpbicsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3N5c3RlbV9tZXRyaWMgMScpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdzeXN0ZW1fbWV0cmljIDInKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRDYWNoZU1ldHJpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgYXMgbcOpdHJpY2FzIGRlIGNhY2hlIG5vIGZvcm1hdG8gY29ycmV0bycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgZGEgcmVzcG9zdGFcbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgc2V0SGVhZGVyOiBqZXN0LmZuKCksXG4gICAgICAgIHNlbmQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgfSBhcyB1bmtub3duIGFzIFJlc3BvbnNlO1xuXG4gICAgICAvLyBDb25maWd1cmFyIG8gbW9jayBwYXJhIHJldG9ybmFyIG3DqXRyaWNhcyBkZSBjYWNoZVxuICAgICAgbW9ja01ldHJpY3NTZXJ2aWNlLmdldE1ldHJpY3MubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFxuICAgICAgICAnY2FjaGVfb3BlcmF0aW9uc190b3RhbCAxMFxcbmNhY2hlX2hpdF9yYXRpbyAwLjc1XFxuc3lzdGVtX21ldHJpYyAxJyxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IGNvbnRyb2xsZXIuZ2V0Q2FjaGVNZXRyaWNzKG1vY2tSZXNwb25zZSk7XG5cbiAgICAgIGV4cGVjdChtZXRyaWNzU2VydmljZS5nZXRNZXRyaWNzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNldEhlYWRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdDb250ZW50LVR5cGUnLFxuICAgICAgICAndGV4dC9wbGFpbicsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ2NhY2hlX29wZXJhdGlvbnNfdG90YWwgMTAnKSxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnY2FjaGVfaGl0X3JhdGlvIDAuNzUnKSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=