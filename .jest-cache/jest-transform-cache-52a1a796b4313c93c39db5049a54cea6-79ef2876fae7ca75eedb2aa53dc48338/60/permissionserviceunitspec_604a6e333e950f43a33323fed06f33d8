8fceaa1d0f07fd0e281daf1331e636b4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const permission_service_1 = require("@/auth/services/permission.service");
const permission_repository_1 = require("@/auth/repositories/permission.repository");
const role_permission_repository_1 = require("@/auth/repositories/role-permission.repository");
const user_permission_repository_1 = require("@/auth/repositories/user-permission.repository");
const permission_scope_repository_1 = require("@/auth/repositories/permission-scope.repository");
const cache_manager_1 = require("@nestjs/cache-manager");
const auditoria_service_1 = require("@modules/auditoria/services/auditoria.service");
const user_permission_entity_1 = require("@/auth/entities/user-permission.entity");
/**
 * Testes unitários para o PermissionService
 *
 * Estes testes verificam o funcionamento do serviço de permissões,
 * responsável por verificar se um usuário tem permissão para acessar
 * determinados recursos e funcionalidades.
 */
describe('PermissionService', () => {
    let service;
    let permissionRepository;
    let rolePermissionRepository;
    let userPermissionRepository;
    let permissionScopeRepository;
    let cacheManager;
    let auditoriaService;
    beforeEach(async () => {
        // Mocks dos repositórios e dependências
        const mockPermissionRepository = {
            findByName: jest.fn(),
            findById: jest.fn(),
            findByComposite: jest.fn(),
            findComposedPermissions: jest.fn(),
        };
        const mockRolePermissionRepository = {
            findPermissionsByUserRoles: jest.fn(),
        };
        const mockUserPermissionRepository = {
            findByUserAndPermission: jest.fn(),
            findValidPermissions: jest.fn(),
            createUserPermission: jest.fn(),
            updateUserPermission: jest.fn(),
        };
        const mockPermissionScopeRepository = {
            findByPermission: jest.fn(),
        };
        const mockCacheManager = {
            get: jest.fn(),
            set: jest.fn(),
            del: jest.fn(),
        };
        const mockAuditoriaService = {
            create: jest.fn().mockImplementation(() => Promise.resolve({})),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                permission_service_1.PermissionService,
                {
                    provide: permission_repository_1.PermissionRepository,
                    useValue: mockPermissionRepository,
                },
                {
                    provide: role_permission_repository_1.RolePermissionRepository,
                    useValue: mockRolePermissionRepository,
                },
                {
                    provide: user_permission_repository_1.UserPermissionRepository,
                    useValue: mockUserPermissionRepository,
                },
                {
                    provide: permission_scope_repository_1.PermissionScopeRepository,
                    useValue: mockPermissionScopeRepository,
                },
                {
                    provide: cache_manager_1.CACHE_MANAGER,
                    useValue: mockCacheManager,
                },
                {
                    provide: auditoria_service_1.AuditoriaService,
                    useValue: mockAuditoriaService,
                },
            ],
        }).compile();
        service = module.get(permission_service_1.PermissionService);
        permissionRepository = module.get(permission_repository_1.PermissionRepository);
        rolePermissionRepository = module.get(role_permission_repository_1.RolePermissionRepository);
        userPermissionRepository = module.get(user_permission_repository_1.UserPermissionRepository);
        permissionScopeRepository = module.get(permission_scope_repository_1.PermissionScopeRepository);
        cacheManager = module.get(cache_manager_1.CACHE_MANAGER);
        auditoriaService = module.get(auditoria_service_1.AuditoriaService);
    });
    it('deve ser definido', () => {
        expect(service).toBeDefined();
    });
    describe('hasPermission', () => {
        const userId = 'user-123';
        const permissionName = 'solicitacao.listar';
        const options = {
            userId,
            permissionName,
            scopeType: user_permission_entity_1.ScopeType.UNIT,
            scopeId: 'unidade-123',
        };
        it('deve retornar true quando encontrar permissão em cache', async () => {
            // Mock do cache retornando true
            cacheManager.get.mockResolvedValueOnce(true);
            const result = await service.hasPermission(options);
            expect(cacheManager.get).toHaveBeenCalledWith(expect.stringContaining(userId));
            expect(result).toBe(true);
        });
        it('deve verificar permissão direta quando não estiver em cache', async () => {
            // Cache não encontrou a permissão
            cacheManager.get.mockResolvedValueOnce(undefined);
            // O usuário tem a permissão direta
            const mockPermission = { id: 'perm-123', name: permissionName };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findValidPermissions.mockResolvedValueOnce([{
                    id: 'user-perm-123',
                    permissionId: mockPermission.id,
                    scopeType: user_permission_entity_1.ScopeType.UNIT,
                    scopeId: 'unidade-123',
                    granted: true,
                    validUntil: new Date(Date.now() + 86400000), // Válido por mais 1 dia
                }]);
            const result = await service.hasPermission(options);
            expect(permissionRepository.findByName).toHaveBeenCalledWith(permissionName);
            expect(userPermissionRepository.findValidPermissions).toHaveBeenCalledWith(userId, mockPermission.id);
            expect(cacheManager.set).toHaveBeenCalledWith(expect.stringContaining(userId), true, expect.any(Number));
            expect(result).toBe(true);
        });
        it('deve verificar permissão de role quando não tiver permissão direta', async () => {
            // Cache não encontrou a permissão
            cacheManager.get.mockResolvedValueOnce(undefined);
            // O usuário não tem permissão direta
            const mockPermission = { id: 'perm-123', name: permissionName };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findValidPermissions.mockResolvedValueOnce([]);
            // Mas tem permissão via role
            rolePermissionRepository.findPermissionsByUserRoles.mockResolvedValueOnce([{
                    permissionId: mockPermission.id,
                    roleName: 'ADMIN'
                }]);
            const result = await service.hasPermission(options);
            expect(rolePermissionRepository.findPermissionsByUserRoles).toHaveBeenCalledWith(userId, mockPermission.id);
            expect(cacheManager.set).toHaveBeenCalledWith(expect.stringContaining(userId), true, expect.any(Number));
            expect(result).toBe(true);
        });
        it('deve verificar permissão composta quando não tiver permissão direta nem via role', async () => {
            // Cache não encontrou a permissão
            cacheManager.get.mockResolvedValueOnce(undefined);
            // O usuário não tem permissão direta nem via role
            const mockPermission = { id: 'perm-123', name: permissionName, isComposite: true };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findValidPermissions.mockResolvedValueOnce([]);
            rolePermissionRepository.findPermissionsByUserRoles.mockResolvedValueOnce([]);
            // É uma permissão composta
            const childPermission = { id: 'child-perm-123', name: 'solicitacao.visualizar' };
            permissionRepository.findComposedPermissions.mockResolvedValueOnce([childPermission]);
            // E o usuário tem a permissão filha
            userPermissionRepository.findValidPermissions.mockResolvedValueOnce([{
                    id: 'user-perm-456',
                    permissionId: childPermission.id,
                    scopeType: user_permission_entity_1.ScopeType.UNIT,
                    scopeId: 'unidade-123',
                    granted: true,
                    validUntil: null,
                }]);
            const result = await service.hasPermission(options);
            expect(permissionRepository.findComposedPermissions).toHaveBeenCalledWith(mockPermission.id);
            expect(userPermissionRepository.findValidPermissions).toHaveBeenCalledWith(userId, childPermission.id);
            expect(cacheManager.set).toHaveBeenCalledWith(expect.stringContaining(userId), true, expect.any(Number));
            expect(result).toBe(true);
        });
        it('deve retornar false quando o usuário não tem nenhuma permissão', async () => {
            // Cache não encontrou a permissão
            cacheManager.get.mockResolvedValueOnce(undefined);
            // O usuário não tem permissão direta, via role ou composta
            const mockPermission = { id: 'perm-123', name: permissionName, isComposite: false };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findValidPermissions.mockResolvedValueOnce([]);
            rolePermissionRepository.findPermissionsByUserRoles.mockResolvedValueOnce([]);
            const result = await service.hasPermission(options);
            expect(cacheManager.set).toHaveBeenCalledWith(expect.stringContaining(userId), false, expect.any(Number));
            expect(result).toBe(false);
        });
    });
    describe('grantPermission', () => {
        it('deve atribuir uma nova permissão a um usuário', async () => {
            const userId = 'user-123';
            const permissionName = 'solicitacao.listar';
            const scopeType = user_permission_entity_1.ScopeType.UNIT;
            const scopeId = 'unidade-123';
            const createdBy = 'admin-user';
            const mockPermission = { id: 'perm-123', name: permissionName };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findByUserAndPermission.mockResolvedValueOnce(null);
            userPermissionRepository.createUserPermission.mockResolvedValueOnce({
                id: 'user-perm-123',
                userId,
                permissionId: mockPermission.id,
                scopeType,
                scopeId,
                granted: true,
                createdBy,
            });
            const result = await service.grantPermission(userId, permissionName, scopeType, scopeId, null, createdBy);
            expect(permissionRepository.findByName).toHaveBeenCalledWith(permissionName);
            expect(userPermissionRepository.findByUserAndPermission).toHaveBeenCalledWith(userId, mockPermission.id, scopeType, scopeId);
            expect(userPermissionRepository.createUserPermission).toHaveBeenCalledWith({
                userId,
                permissionId: mockPermission.id,
                granted: true,
                scopeType,
                scopeId,
                validUntil: null,
                createdBy,
            });
            expect(auditoriaService.create).toHaveBeenCalled();
            expect(result).toBe(true);
        });
        it('deve atualizar uma permissão existente', async () => {
            const userId = 'user-123';
            const permissionName = 'solicitacao.listar';
            const scopeType = user_permission_entity_1.ScopeType.UNIT;
            const scopeId = 'unidade-123';
            const createdBy = 'admin-user';
            const mockPermission = { id: 'perm-123', name: permissionName };
            const existingPermission = {
                id: 'user-perm-123',
                userId,
                permissionId: mockPermission.id,
                scopeType,
                scopeId,
                granted: false,
            };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findByUserAndPermission.mockResolvedValueOnce(existingPermission);
            userPermissionRepository.updateUserPermission.mockResolvedValueOnce({
                ...existingPermission,
                granted: true,
                updatedBy: createdBy,
            });
            const result = await service.grantPermission(userId, permissionName, scopeType, scopeId, null, createdBy);
            expect(userPermissionRepository.updateUserPermission).toHaveBeenCalledWith(existingPermission.id, {
                granted: true,
                validUntil: null,
                updatedBy: createdBy,
            });
            expect(auditoriaService.create).toHaveBeenCalled();
            expect(result).toBe(true);
        });
    });
    describe('revokePermission', () => {
        it('deve revogar uma permissão existente', async () => {
            const userId = 'user-123';
            const permissionName = 'solicitacao.listar';
            const scopeType = user_permission_entity_1.ScopeType.UNIT;
            const scopeId = 'unidade-123';
            const createdBy = 'admin-user';
            const mockPermission = { id: 'perm-123', name: permissionName };
            const existingPermission = {
                id: 'user-perm-123',
                userId,
                permissionId: mockPermission.id,
                scopeType,
                scopeId,
                granted: true,
            };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findByUserAndPermission.mockResolvedValueOnce(existingPermission);
            userPermissionRepository.updateUserPermission.mockResolvedValueOnce({
                ...existingPermission,
                granted: false,
                updatedBy: createdBy,
            });
            const result = await service.revokePermission(userId, permissionName, scopeType, scopeId, createdBy);
            expect(userPermissionRepository.updateUserPermission).toHaveBeenCalledWith(existingPermission.id, {
                granted: false,
                updatedBy: createdBy,
            });
            expect(auditoriaService.create).toHaveBeenCalled();
            expect(result).toBe(true);
        });
        it('deve retornar false quando a permissão não existe', async () => {
            const userId = 'user-123';
            const permissionName = 'solicitacao.listar';
            const scopeType = user_permission_entity_1.ScopeType.UNIT;
            const scopeId = 'unidade-123';
            const createdBy = 'admin-user';
            const mockPermission = { id: 'perm-123', name: permissionName };
            permissionRepository.findByName.mockResolvedValueOnce(mockPermission);
            userPermissionRepository.findByUserAndPermission.mockResolvedValueOnce(null);
            const result = await service.revokePermission(userId, permissionName, scopeType, scopeId, createdBy);
            expect(userPermissionRepository.updateUserPermission).not.toHaveBeenCalled();
            expect(auditoriaService.criarLog).not.toHaveBeenCalled();
            expect(result).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxtb2R1bGVzXFxhdXRoXFxzZXJ2aWNlc1xccGVybWlzc2lvbi5zZXJ2aWNlLnVuaXQuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCwyRUFBK0Y7QUFDL0YscUZBQWlGO0FBQ2pGLCtGQUEwRjtBQUMxRiwrRkFBMEY7QUFDMUYsaUdBQTRGO0FBQzVGLHlEQUFzRDtBQUN0RCxxRkFBaUY7QUFDakYsbUZBQW1FO0FBSW5FOzs7Ozs7R0FNRztBQUNILFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDakMsSUFBSSxPQUEwQixDQUFDO0lBQy9CLElBQUksb0JBQTBDLENBQUM7SUFDL0MsSUFBSSx3QkFBa0QsQ0FBQztJQUN2RCxJQUFJLHdCQUFrRCxDQUFDO0lBQ3ZELElBQUkseUJBQW9ELENBQUM7SUFDekQsSUFBSSxZQUE4QixDQUFDO0lBQ25DLElBQUksZ0JBQStDLENBQUM7SUFFcEQsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLHdDQUF3QztRQUN4QyxNQUFNLHdCQUF3QixHQUFHO1lBQy9CLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ25CLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQzFCLHVCQUF1QixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDbkMsQ0FBQztRQUVGLE1BQU0sNEJBQTRCLEdBQUc7WUFDbkMsMEJBQTBCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUN0QyxDQUFDO1FBRUYsTUFBTSw0QkFBNEIsR0FBRztZQUNuQyx1QkFBdUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2xDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDL0Isb0JBQW9CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUMvQixvQkFBb0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ2hDLENBQUM7UUFFRixNQUFNLDZCQUE2QixHQUFHO1lBQ3BDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDNUIsQ0FBQztRQUVGLE1BQU0sZ0JBQWdCLEdBQUc7WUFDdkIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDZCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNkLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ2YsQ0FBQztRQUVGLE1BQU0sb0JBQW9CLEdBQUc7WUFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ2hFLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULHNDQUFpQjtnQkFDakI7b0JBQ0UsT0FBTyxFQUFFLDRDQUFvQjtvQkFDN0IsUUFBUSxFQUFFLHdCQUF3QjtpQkFDbkM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHFEQUF3QjtvQkFDakMsUUFBUSxFQUFFLDRCQUE0QjtpQkFDdkM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHFEQUF3QjtvQkFDakMsUUFBUSxFQUFFLDRCQUE0QjtpQkFDdkM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHVEQUF5QjtvQkFDbEMsUUFBUSxFQUFFLDZCQUE2QjtpQkFDeEM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLDZCQUFhO29CQUN0QixRQUFRLEVBQUUsZ0JBQWdCO2lCQUMzQjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsb0NBQWdCO29CQUN6QixRQUFRLEVBQUUsb0JBQW9CO2lCQUMvQjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQW9CLHNDQUFpQixDQUFDLENBQUM7UUFDM0Qsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBdUIsNENBQW9CLENBQUMsQ0FBQztRQUM5RSx3QkFBd0IsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUEyQixxREFBd0IsQ0FBQyxDQUFDO1FBQzFGLHdCQUF3QixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQTJCLHFEQUF3QixDQUFDLENBQUM7UUFDMUYseUJBQXlCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBNEIsdURBQXlCLENBQUMsQ0FBQztRQUM3RixZQUFZLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyw2QkFBYSxDQUFDLENBQUM7UUFDekMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBbUIsb0NBQWdCLENBQUMsQ0FBQztJQUNwRSxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7UUFDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDN0IsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDO1FBQzFCLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO1FBQzVDLE1BQU0sT0FBTyxHQUEyQjtZQUN0QyxNQUFNO1lBQ04sY0FBYztZQUNkLFNBQVMsRUFBRSxrQ0FBUyxDQUFDLElBQUk7WUFDekIsT0FBTyxFQUFFLGFBQWE7U0FDdkIsQ0FBQztRQUVGLEVBQUUsQ0FBQyx3REFBd0QsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN0RSxnQ0FBZ0M7WUFDaEMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUU3QyxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FDM0MsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUNoQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2REFBNkQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMzRSxrQ0FBa0M7WUFDbEMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVsRCxtQ0FBbUM7WUFDbkMsTUFBTSxjQUFjLEdBQUcsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQWdCLENBQUM7WUFDOUUsb0JBQW9CLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3RFLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDLENBQUM7b0JBQ25FLEVBQUUsRUFBRSxlQUFlO29CQUNuQixZQUFZLEVBQUUsY0FBYyxDQUFDLEVBQUU7b0JBQy9CLFNBQVMsRUFBRSxrQ0FBUyxDQUFDLElBQUk7b0JBQ3pCLE9BQU8sRUFBRSxhQUFhO29CQUN0QixPQUFPLEVBQUUsSUFBSTtvQkFDYixVQUFVLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFFBQVEsQ0FBQyxFQUFFLHdCQUF3QjtpQkFDdEUsQ0FBQyxDQUFDLENBQUM7WUFFSixNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzdFLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLG9CQUFvQixDQUN4RSxNQUFNLEVBQ04sY0FBYyxDQUFDLEVBQUUsQ0FDbEIsQ0FBQztZQUNGLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFDL0IsSUFBSSxFQUNKLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQ25CLENBQUM7WUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9FQUFvRSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2xGLGtDQUFrQztZQUNsQyxZQUFZLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRWxELHFDQUFxQztZQUNyQyxNQUFNLGNBQWMsR0FBRyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBZ0IsQ0FBQztZQUM5RSxvQkFBb0IsQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDdEUsd0JBQXdCLENBQUMsb0JBQW9CLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFeEUsNkJBQTZCO1lBQzdCLHdCQUF3QixDQUFDLDBCQUEwQixDQUFDLHFCQUFxQixDQUFDLENBQUM7b0JBQ3pFLFlBQVksRUFBRSxjQUFjLENBQUMsRUFBRTtvQkFDL0IsUUFBUSxFQUFFLE9BQU87aUJBQ2xCLENBQUMsQ0FBQyxDQUFDO1lBRUosTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXBELE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLG9CQUFvQixDQUM5RSxNQUFNLEVBQ04sY0FBYyxDQUFDLEVBQUUsQ0FDbEIsQ0FBQztZQUNGLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFDL0IsSUFBSSxFQUNKLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQ25CLENBQUM7WUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGtGQUFrRixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2hHLGtDQUFrQztZQUNsQyxZQUFZLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRWxELGtEQUFrRDtZQUNsRCxNQUFNLGNBQWMsR0FBRyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFnQixDQUFDO1lBQ2pHLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RSx3QkFBd0IsQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN4RSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUU5RSwyQkFBMkI7WUFDM0IsTUFBTSxlQUFlLEdBQUcsRUFBRSxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLHdCQUF3QixFQUFnQixDQUFDO1lBQy9GLG9CQUFvQixDQUFDLHVCQUF1QixDQUFDLHFCQUFxQixDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUV0RixvQ0FBb0M7WUFDcEMsd0JBQXdCLENBQUMsb0JBQW9CLENBQUMscUJBQXFCLENBQUMsQ0FBQztvQkFDbkUsRUFBRSxFQUFFLGVBQWU7b0JBQ25CLFlBQVksRUFBRSxlQUFlLENBQUMsRUFBRTtvQkFDaEMsU0FBUyxFQUFFLGtDQUFTLENBQUMsSUFBSTtvQkFDekIsT0FBTyxFQUFFLGFBQWE7b0JBQ3RCLE9BQU8sRUFBRSxJQUFJO29CQUNiLFVBQVUsRUFBRSxJQUFJO2lCQUNqQixDQUFDLENBQUMsQ0FBQztZQUVKLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVwRCxNQUFNLENBQUMsb0JBQW9CLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0YsTUFBTSxDQUFDLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLENBQUMsb0JBQW9CLENBQ3hFLE1BQU0sRUFDTixlQUFlLENBQUMsRUFBRSxDQUNuQixDQUFDO1lBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FDM0MsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUMvQixJQUFJLEVBQ0osTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FDbkIsQ0FBQztZQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0VBQWdFLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDOUUsa0NBQWtDO1lBQ2xDLFlBQVksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFbEQsMkRBQTJEO1lBQzNELE1BQU0sY0FBYyxHQUFHLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQWdCLENBQUM7WUFDbEcsb0JBQW9CLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3RFLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3hFLHdCQUF3QixDQUFDLDBCQUEwQixDQUFDLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRTlFLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVwRCxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUMzQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEVBQy9CLEtBQUssRUFDTCxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUNuQixDQUFDO1lBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtRQUMvQixFQUFFLENBQUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDN0QsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDO1lBQzFCLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO1lBQzVDLE1BQU0sU0FBUyxHQUFHLGtDQUFTLENBQUMsSUFBSSxDQUFDO1lBQ2pDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQztZQUM5QixNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFFL0IsTUFBTSxjQUFjLEdBQUcsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQWdCLENBQUM7WUFDOUUsb0JBQW9CLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3RFLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdFLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDO2dCQUNsRSxFQUFFLEVBQUUsZUFBZTtnQkFDbkIsTUFBTTtnQkFDTixZQUFZLEVBQUUsY0FBYyxDQUFDLEVBQUU7Z0JBQy9CLFNBQVM7Z0JBQ1QsT0FBTztnQkFDUCxPQUFPLEVBQUUsSUFBSTtnQkFDYixTQUFTO2FBQ1YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsZUFBZSxDQUMxQyxNQUFNLEVBQ04sY0FBYyxFQUNkLFNBQVMsRUFDVCxPQUFPLEVBQ1AsSUFBSSxFQUNKLFNBQVMsQ0FDVixDQUFDO1lBRUYsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzdFLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLG9CQUFvQixDQUMzRSxNQUFNLEVBQ04sY0FBYyxDQUFDLEVBQUUsRUFDakIsU0FBUyxFQUNULE9BQU8sQ0FDUixDQUFDO1lBQ0YsTUFBTSxDQUFDLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLENBQUMsb0JBQW9CLENBQUM7Z0JBQ3pFLE1BQU07Z0JBQ04sWUFBWSxFQUFFLGNBQWMsQ0FBQyxFQUFFO2dCQUMvQixPQUFPLEVBQUUsSUFBSTtnQkFDYixTQUFTO2dCQUNULE9BQU87Z0JBQ1AsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFNBQVM7YUFDVixDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNuRCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHdDQUF3QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQztZQUMxQixNQUFNLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQztZQUM1QyxNQUFNLFNBQVMsR0FBRyxrQ0FBUyxDQUFDLElBQUksQ0FBQztZQUNqQyxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUM7WUFDOUIsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO1lBRS9CLE1BQU0sY0FBYyxHQUFHLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFnQixDQUFDO1lBQzlFLE1BQU0sa0JBQWtCLEdBQUc7Z0JBQ3pCLEVBQUUsRUFBRSxlQUFlO2dCQUNuQixNQUFNO2dCQUNOLFlBQVksRUFBRSxjQUFjLENBQUMsRUFBRTtnQkFDL0IsU0FBUztnQkFDVCxPQUFPO2dCQUNQLE9BQU8sRUFBRSxLQUFLO2FBQ2YsQ0FBQztZQUVGLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RSx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzNGLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDO2dCQUNsRSxHQUFHLGtCQUFrQjtnQkFDckIsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsU0FBUyxFQUFFLFNBQVM7YUFDckIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsZUFBZSxDQUMxQyxNQUFNLEVBQ04sY0FBYyxFQUNkLFNBQVMsRUFDVCxPQUFPLEVBQ1AsSUFBSSxFQUNKLFNBQVMsQ0FDVixDQUFDO1lBRUYsTUFBTSxDQUFDLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLENBQUMsb0JBQW9CLENBQ3hFLGtCQUFrQixDQUFDLEVBQUUsRUFDckI7Z0JBQ0UsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFNBQVMsRUFBRSxTQUFTO2FBQ3JCLENBQ0YsQ0FBQztZQUNGLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDaEMsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3BELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQztZQUMxQixNQUFNLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQztZQUM1QyxNQUFNLFNBQVMsR0FBRyxrQ0FBUyxDQUFDLElBQUksQ0FBQztZQUNqQyxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUM7WUFDOUIsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO1lBRS9CLE1BQU0sY0FBYyxHQUFHLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFnQixDQUFDO1lBQzlFLE1BQU0sa0JBQWtCLEdBQUc7Z0JBQ3pCLEVBQUUsRUFBRSxlQUFlO2dCQUNuQixNQUFNO2dCQUNOLFlBQVksRUFBRSxjQUFjLENBQUMsRUFBRTtnQkFDL0IsU0FBUztnQkFDVCxPQUFPO2dCQUNQLE9BQU8sRUFBRSxJQUFJO2FBQ2QsQ0FBQztZQUVGLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RSx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzNGLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixDQUFDO2dCQUNsRSxHQUFHLGtCQUFrQjtnQkFDckIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsU0FBUyxFQUFFLFNBQVM7YUFDckIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsZ0JBQWdCLENBQzNDLE1BQU0sRUFDTixjQUFjLEVBQ2QsU0FBUyxFQUNULE9BQU8sRUFDUCxTQUFTLENBQ1YsQ0FBQztZQUVGLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLG9CQUFvQixDQUN4RSxrQkFBa0IsQ0FBQyxFQUFFLEVBQ3JCO2dCQUNFLE9BQU8sRUFBRSxLQUFLO2dCQUNkLFNBQVMsRUFBRSxTQUFTO2FBQ3JCLENBQ0YsQ0FBQztZQUNGLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsbURBQW1ELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDakUsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDO1lBQzFCLE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDO1lBQzVDLE1BQU0sU0FBUyxHQUFHLGtDQUFTLENBQUMsSUFBSSxDQUFDO1lBQ2pDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQztZQUM5QixNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFFL0IsTUFBTSxjQUFjLEdBQUcsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQWdCLENBQUM7WUFFOUUsb0JBQW9CLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3RFLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTdFLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLGdCQUFnQixDQUMzQyxNQUFNLEVBQ04sY0FBYyxFQUNkLFNBQVMsRUFDVCxPQUFPLEVBQ1AsU0FBUyxDQUNWLENBQUM7WUFFRixNQUFNLENBQUMsd0JBQXdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUM3RSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDekQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFx0ZXN0XFxtb2R1bGVzXFxhdXRoXFxzZXJ2aWNlc1xccGVybWlzc2lvbi5zZXJ2aWNlLnVuaXQuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IFBlcm1pc3Npb25TZXJ2aWNlLCBQZXJtaXNzaW9uQ2hlY2tPcHRpb25zIH0gZnJvbSAnQC9hdXRoL3NlcnZpY2VzL3Blcm1pc3Npb24uc2VydmljZSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uUmVwb3NpdG9yeSB9IGZyb20gJ0AvYXV0aC9yZXBvc2l0b3JpZXMvcGVybWlzc2lvbi5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFJvbGVQZXJtaXNzaW9uUmVwb3NpdG9yeSB9IGZyb20gJ0AvYXV0aC9yZXBvc2l0b3JpZXMvcm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgVXNlclBlcm1pc3Npb25SZXBvc2l0b3J5IH0gZnJvbSAnQC9hdXRoL3JlcG9zaXRvcmllcy91c2VyLXBlcm1pc3Npb24ucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5IH0gZnJvbSAnQC9hdXRoL3JlcG9zaXRvcmllcy9wZXJtaXNzaW9uLXNjb3BlLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgQ0FDSEVfTUFOQUdFUiB9IGZyb20gJ0BuZXN0anMvY2FjaGUtbWFuYWdlcic7XG5pbXBvcnQgeyBBdWRpdG9yaWFTZXJ2aWNlIH0gZnJvbSAnQG1vZHVsZXMvYXVkaXRvcmlhL3NlcnZpY2VzL2F1ZGl0b3JpYS5zZXJ2aWNlJztcbmltcG9ydCB7IFNjb3BlVHlwZSB9IGZyb20gJ0AvYXV0aC9lbnRpdGllcy91c2VyLXBlcm1pc3Npb24uZW50aXR5JztcbmltcG9ydCB7IFBlcm1pc3Npb24gfSBmcm9tICdAL2F1dGgvZW50aXRpZXMvcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgVGlwb09wZXJhY2FvIH0gZnJvbSAnQG1vZHVsZXMvYXVkaXRvcmlhL2VudW1zL3RpcG8tb3BlcmFjYW8uZW51bSc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBvIFBlcm1pc3Npb25TZXJ2aWNlXG4gKiBcbiAqIEVzdGVzIHRlc3RlcyB2ZXJpZmljYW0gbyBmdW5jaW9uYW1lbnRvIGRvIHNlcnZpw6dvIGRlIHBlcm1pc3PDtWVzLFxuICogcmVzcG9uc8OhdmVsIHBvciB2ZXJpZmljYXIgc2UgdW0gdXN1w6FyaW8gdGVtIHBlcm1pc3PDo28gcGFyYSBhY2Vzc2FyXG4gKiBkZXRlcm1pbmFkb3MgcmVjdXJzb3MgZSBmdW5jaW9uYWxpZGFkZXMuXG4gKi9cbmRlc2NyaWJlKCdQZXJtaXNzaW9uU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFBlcm1pc3Npb25TZXJ2aWNlO1xuICBsZXQgcGVybWlzc2lvblJlcG9zaXRvcnk6IFBlcm1pc3Npb25SZXBvc2l0b3J5O1xuICBsZXQgcm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5OiBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnk7XG4gIGxldCB1c2VyUGVybWlzc2lvblJlcG9zaXRvcnk6IFVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeTtcbiAgbGV0IHBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnk6IFBlcm1pc3Npb25TY29wZVJlcG9zaXRvcnk7XG4gIGxldCBjYWNoZU1hbmFnZXI6IGplc3QuTW9ja2VkPGFueT47XG4gIGxldCBhdWRpdG9yaWFTZXJ2aWNlOiBqZXN0Lk1vY2tlZDxBdWRpdG9yaWFTZXJ2aWNlPjtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBNb2NrcyBkb3MgcmVwb3NpdMOzcmlvcyBlIGRlcGVuZMOqbmNpYXNcbiAgICBjb25zdCBtb2NrUGVybWlzc2lvblJlcG9zaXRvcnkgPSB7XG4gICAgICBmaW5kQnlOYW1lOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQnlJZDogamVzdC5mbigpLFxuICAgICAgZmluZEJ5Q29tcG9zaXRlOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQ29tcG9zZWRQZXJtaXNzaW9uczogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2NrUm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5ID0ge1xuICAgICAgZmluZFBlcm1pc3Npb25zQnlVc2VyUm9sZXM6IGplc3QuZm4oKSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9ja1VzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeSA9IHtcbiAgICAgIGZpbmRCeVVzZXJBbmRQZXJtaXNzaW9uOiBqZXN0LmZuKCksXG4gICAgICBmaW5kVmFsaWRQZXJtaXNzaW9uczogamVzdC5mbigpLFxuICAgICAgY3JlYXRlVXNlclBlcm1pc3Npb246IGplc3QuZm4oKSxcbiAgICAgIHVwZGF0ZVVzZXJQZXJtaXNzaW9uOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5ID0ge1xuICAgICAgZmluZEJ5UGVybWlzc2lvbjogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2NrQ2FjaGVNYW5hZ2VyID0ge1xuICAgICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgICBzZXQ6IGplc3QuZm4oKSxcbiAgICAgIGRlbDogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2NrQXVkaXRvcmlhU2VydmljZSA9IHtcbiAgICAgIGNyZWF0ZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBQcm9taXNlLnJlc29sdmUoe30pKSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBQZXJtaXNzaW9uU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFBlcm1pc3Npb25SZXBvc2l0b3J5LFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBSb2xlUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tSb2xlUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBVc2VyUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tVc2VyUGVybWlzc2lvblJlcG9zaXRvcnksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5LFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrUGVybWlzc2lvblNjb3BlUmVwb3NpdG9yeSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IENBQ0hFX01BTkFHRVIsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tDYWNoZU1hbmFnZXIsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBBdWRpdG9yaWFTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQXVkaXRvcmlhU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8UGVybWlzc2lvblNlcnZpY2U+KFBlcm1pc3Npb25TZXJ2aWNlKTtcbiAgICBwZXJtaXNzaW9uUmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8UGVybWlzc2lvblJlcG9zaXRvcnk+KFBlcm1pc3Npb25SZXBvc2l0b3J5KTtcbiAgICByb2xlUGVybWlzc2lvblJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJvbGVQZXJtaXNzaW9uUmVwb3NpdG9yeT4oUm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5KTtcbiAgICB1c2VyUGVybWlzc2lvblJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeT4oVXNlclBlcm1pc3Npb25SZXBvc2l0b3J5KTtcbiAgICBwZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5ID0gbW9kdWxlLmdldDxQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5PihQZXJtaXNzaW9uU2NvcGVSZXBvc2l0b3J5KTtcbiAgICBjYWNoZU1hbmFnZXIgPSBtb2R1bGUuZ2V0KENBQ0hFX01BTkFHRVIpO1xuICAgIGF1ZGl0b3JpYVNlcnZpY2UgPSBtb2R1bGUuZ2V0PEF1ZGl0b3JpYVNlcnZpY2U+KEF1ZGl0b3JpYVNlcnZpY2UpO1xuICB9KTtcblxuICBpdCgnZGV2ZSBzZXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdoYXNQZXJtaXNzaW9uJywgKCkgPT4ge1xuICAgIGNvbnN0IHVzZXJJZCA9ICd1c2VyLTEyMyc7XG4gICAgY29uc3QgcGVybWlzc2lvbk5hbWUgPSAnc29saWNpdGFjYW8ubGlzdGFyJztcbiAgICBjb25zdCBvcHRpb25zOiBQZXJtaXNzaW9uQ2hlY2tPcHRpb25zID0ge1xuICAgICAgdXNlcklkLFxuICAgICAgcGVybWlzc2lvbk5hbWUsXG4gICAgICBzY29wZVR5cGU6IFNjb3BlVHlwZS5VTklULFxuICAgICAgc2NvcGVJZDogJ3VuaWRhZGUtMTIzJyxcbiAgICB9O1xuXG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgdHJ1ZSBxdWFuZG8gZW5jb250cmFyIHBlcm1pc3PDo28gZW0gY2FjaGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGRvIGNhY2hlIHJldG9ybmFuZG8gdHJ1ZVxuICAgICAgY2FjaGVNYW5hZ2VyLmdldC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UodHJ1ZSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuaGFzUGVybWlzc2lvbihvcHRpb25zKTtcblxuICAgICAgZXhwZWN0KGNhY2hlTWFuYWdlci5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyh1c2VySWQpLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgcGVybWlzc8OjbyBkaXJldGEgcXVhbmRvIG7Do28gZXN0aXZlciBlbSBjYWNoZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENhY2hlIG7Do28gZW5jb250cm91IGEgcGVybWlzc8Ojb1xuICAgICAgY2FjaGVNYW5hZ2VyLmdldC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UodW5kZWZpbmVkKTtcbiAgICAgIFxuICAgICAgLy8gTyB1c3XDoXJpbyB0ZW0gYSBwZXJtaXNzw6NvIGRpcmV0YVxuICAgICAgY29uc3QgbW9ja1Blcm1pc3Npb24gPSB7IGlkOiAncGVybS0xMjMnLCBuYW1lOiBwZXJtaXNzaW9uTmFtZSB9IGFzIFBlcm1pc3Npb247XG4gICAgICBwZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kQnlOYW1lLm1vY2tSZXNvbHZlZFZhbHVlT25jZShtb2NrUGVybWlzc2lvbik7XG4gICAgICB1c2VyUGVybWlzc2lvblJlcG9zaXRvcnkuZmluZFZhbGlkUGVybWlzc2lvbnMubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFt7XG4gICAgICAgIGlkOiAndXNlci1wZXJtLTEyMycsXG4gICAgICAgIHBlcm1pc3Npb25JZDogbW9ja1Blcm1pc3Npb24uaWQsXG4gICAgICAgIHNjb3BlVHlwZTogU2NvcGVUeXBlLlVOSVQsXG4gICAgICAgIHNjb3BlSWQ6ICd1bmlkYWRlLTEyMycsXG4gICAgICAgIGdyYW50ZWQ6IHRydWUsXG4gICAgICAgIHZhbGlkVW50aWw6IG5ldyBEYXRlKERhdGUubm93KCkgKyA4NjQwMDAwMCksIC8vIFbDoWxpZG8gcG9yIG1haXMgMSBkaWFcbiAgICAgIH1dKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5oYXNQZXJtaXNzaW9uKG9wdGlvbnMpO1xuXG4gICAgICBleHBlY3QocGVybWlzc2lvblJlcG9zaXRvcnkuZmluZEJ5TmFtZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgocGVybWlzc2lvbk5hbWUpO1xuICAgICAgZXhwZWN0KHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kVmFsaWRQZXJtaXNzaW9ucykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgbW9ja1Blcm1pc3Npb24uaWRcbiAgICAgICk7XG4gICAgICBleHBlY3QoY2FjaGVNYW5hZ2VyLnNldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKHVzZXJJZCksXG4gICAgICAgIHRydWUsXG4gICAgICAgIGV4cGVjdC5hbnkoTnVtYmVyKVxuICAgICAgKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgcGVybWlzc8OjbyBkZSByb2xlIHF1YW5kbyBuw6NvIHRpdmVyIHBlcm1pc3PDo28gZGlyZXRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ2FjaGUgbsOjbyBlbmNvbnRyb3UgYSBwZXJtaXNzw6NvXG4gICAgICBjYWNoZU1hbmFnZXIuZ2V0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSh1bmRlZmluZWQpO1xuICAgICAgXG4gICAgICAvLyBPIHVzdcOhcmlvIG7Do28gdGVtIHBlcm1pc3PDo28gZGlyZXRhXG4gICAgICBjb25zdCBtb2NrUGVybWlzc2lvbiA9IHsgaWQ6ICdwZXJtLTEyMycsIG5hbWU6IHBlcm1pc3Npb25OYW1lIH0gYXMgUGVybWlzc2lvbjtcbiAgICAgIHBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeU5hbWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tQZXJtaXNzaW9uKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kVmFsaWRQZXJtaXNzaW9ucy5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW10pO1xuICAgICAgXG4gICAgICAvLyBNYXMgdGVtIHBlcm1pc3PDo28gdmlhIHJvbGVcbiAgICAgIHJvbGVQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kUGVybWlzc2lvbnNCeVVzZXJSb2xlcy5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW3tcbiAgICAgICAgcGVybWlzc2lvbklkOiBtb2NrUGVybWlzc2lvbi5pZCxcbiAgICAgICAgcm9sZU5hbWU6ICdBRE1JTidcbiAgICAgIH1dKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5oYXNQZXJtaXNzaW9uKG9wdGlvbnMpO1xuXG4gICAgICBleHBlY3Qocm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRQZXJtaXNzaW9uc0J5VXNlclJvbGVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBtb2NrUGVybWlzc2lvbi5pZFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChjYWNoZU1hbmFnZXIuc2V0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcodXNlcklkKSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgZXhwZWN0LmFueShOdW1iZXIpXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHZlcmlmaWNhciBwZXJtaXNzw6NvIGNvbXBvc3RhIHF1YW5kbyBuw6NvIHRpdmVyIHBlcm1pc3PDo28gZGlyZXRhIG5lbSB2aWEgcm9sZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENhY2hlIG7Do28gZW5jb250cm91IGEgcGVybWlzc8Ojb1xuICAgICAgY2FjaGVNYW5hZ2VyLmdldC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UodW5kZWZpbmVkKTtcbiAgICAgIFxuICAgICAgLy8gTyB1c3XDoXJpbyBuw6NvIHRlbSBwZXJtaXNzw6NvIGRpcmV0YSBuZW0gdmlhIHJvbGVcbiAgICAgIGNvbnN0IG1vY2tQZXJtaXNzaW9uID0geyBpZDogJ3Blcm0tMTIzJywgbmFtZTogcGVybWlzc2lvbk5hbWUsIGlzQ29tcG9zaXRlOiB0cnVlIH0gYXMgUGVybWlzc2lvbjtcbiAgICAgIHBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeU5hbWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tQZXJtaXNzaW9uKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kVmFsaWRQZXJtaXNzaW9ucy5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW10pO1xuICAgICAgcm9sZVBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRQZXJtaXNzaW9uc0J5VXNlclJvbGVzLm1vY2tSZXNvbHZlZFZhbHVlT25jZShbXSk7XG4gICAgICBcbiAgICAgIC8vIMOJIHVtYSBwZXJtaXNzw6NvIGNvbXBvc3RhXG4gICAgICBjb25zdCBjaGlsZFBlcm1pc3Npb24gPSB7IGlkOiAnY2hpbGQtcGVybS0xMjMnLCBuYW1lOiAnc29saWNpdGFjYW8udmlzdWFsaXphcicgfSBhcyBQZXJtaXNzaW9uO1xuICAgICAgcGVybWlzc2lvblJlcG9zaXRvcnkuZmluZENvbXBvc2VkUGVybWlzc2lvbnMubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFtjaGlsZFBlcm1pc3Npb25dKTtcbiAgICAgIFxuICAgICAgLy8gRSBvIHVzdcOhcmlvIHRlbSBhIHBlcm1pc3PDo28gZmlsaGFcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kVmFsaWRQZXJtaXNzaW9ucy5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoW3tcbiAgICAgICAgaWQ6ICd1c2VyLXBlcm0tNDU2JyxcbiAgICAgICAgcGVybWlzc2lvbklkOiBjaGlsZFBlcm1pc3Npb24uaWQsXG4gICAgICAgIHNjb3BlVHlwZTogU2NvcGVUeXBlLlVOSVQsXG4gICAgICAgIHNjb3BlSWQ6ICd1bmlkYWRlLTEyMycsXG4gICAgICAgIGdyYW50ZWQ6IHRydWUsXG4gICAgICAgIHZhbGlkVW50aWw6IG51bGwsXG4gICAgICB9XSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuaGFzUGVybWlzc2lvbihvcHRpb25zKTtcblxuICAgICAgZXhwZWN0KHBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRDb21wb3NlZFBlcm1pc3Npb25zKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChtb2NrUGVybWlzc2lvbi5pZCk7XG4gICAgICBleHBlY3QodXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRWYWxpZFBlcm1pc3Npb25zKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBjaGlsZFBlcm1pc3Npb24uaWRcbiAgICAgICk7XG4gICAgICBleHBlY3QoY2FjaGVNYW5hZ2VyLnNldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKHVzZXJJZCksXG4gICAgICAgIHRydWUsXG4gICAgICAgIGV4cGVjdC5hbnkoTnVtYmVyKVxuICAgICAgKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSByZXRvcm5hciBmYWxzZSBxdWFuZG8gbyB1c3XDoXJpbyBuw6NvIHRlbSBuZW5odW1hIHBlcm1pc3PDo28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDYWNoZSBuw6NvIGVuY29udHJvdSBhIHBlcm1pc3PDo29cbiAgICAgIGNhY2hlTWFuYWdlci5nZXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHVuZGVmaW5lZCk7XG4gICAgICBcbiAgICAgIC8vIE8gdXN1w6FyaW8gbsOjbyB0ZW0gcGVybWlzc8OjbyBkaXJldGEsIHZpYSByb2xlIG91IGNvbXBvc3RhXG4gICAgICBjb25zdCBtb2NrUGVybWlzc2lvbiA9IHsgaWQ6ICdwZXJtLTEyMycsIG5hbWU6IHBlcm1pc3Npb25OYW1lLCBpc0NvbXBvc2l0ZTogZmFsc2UgfSBhcyBQZXJtaXNzaW9uO1xuICAgICAgcGVybWlzc2lvblJlcG9zaXRvcnkuZmluZEJ5TmFtZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Blcm1pc3Npb24pO1xuICAgICAgdXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRWYWxpZFBlcm1pc3Npb25zLm1vY2tSZXNvbHZlZFZhbHVlT25jZShbXSk7XG4gICAgICByb2xlUGVybWlzc2lvblJlcG9zaXRvcnkuZmluZFBlcm1pc3Npb25zQnlVc2VyUm9sZXMubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFtdKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5oYXNQZXJtaXNzaW9uKG9wdGlvbnMpO1xuXG4gICAgICBleHBlY3QoY2FjaGVNYW5hZ2VyLnNldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKHVzZXJJZCksXG4gICAgICAgIGZhbHNlLFxuICAgICAgICBleHBlY3QuYW55KE51bWJlcilcbiAgICAgICk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dyYW50UGVybWlzc2lvbicsICgpID0+IHtcbiAgICBpdCgnZGV2ZSBhdHJpYnVpciB1bWEgbm92YSBwZXJtaXNzw6NvIGEgdW0gdXN1w6FyaW8nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VySWQgPSAndXNlci0xMjMnO1xuICAgICAgY29uc3QgcGVybWlzc2lvbk5hbWUgPSAnc29saWNpdGFjYW8ubGlzdGFyJztcbiAgICAgIGNvbnN0IHNjb3BlVHlwZSA9IFNjb3BlVHlwZS5VTklUO1xuICAgICAgY29uc3Qgc2NvcGVJZCA9ICd1bmlkYWRlLTEyMyc7XG4gICAgICBjb25zdCBjcmVhdGVkQnkgPSAnYWRtaW4tdXNlcic7XG5cbiAgICAgIGNvbnN0IG1vY2tQZXJtaXNzaW9uID0geyBpZDogJ3Blcm0tMTIzJywgbmFtZTogcGVybWlzc2lvbk5hbWUgfSBhcyBQZXJtaXNzaW9uO1xuICAgICAgcGVybWlzc2lvblJlcG9zaXRvcnkuZmluZEJ5TmFtZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Blcm1pc3Npb24pO1xuICAgICAgdXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeVVzZXJBbmRQZXJtaXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlT25jZShudWxsKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5jcmVhdGVVc2VyUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICBpZDogJ3VzZXItcGVybS0xMjMnLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBlcm1pc3Npb25JZDogbW9ja1Blcm1pc3Npb24uaWQsXG4gICAgICAgIHNjb3BlVHlwZSxcbiAgICAgICAgc2NvcGVJZCxcbiAgICAgICAgZ3JhbnRlZDogdHJ1ZSxcbiAgICAgICAgY3JlYXRlZEJ5LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ3JhbnRQZXJtaXNzaW9uKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBlcm1pc3Npb25OYW1lLFxuICAgICAgICBzY29wZVR5cGUsXG4gICAgICAgIHNjb3BlSWQsXG4gICAgICAgIG51bGwsXG4gICAgICAgIGNyZWF0ZWRCeSxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChwZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kQnlOYW1lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwZXJtaXNzaW9uTmFtZSk7XG4gICAgICBleHBlY3QodXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeVVzZXJBbmRQZXJtaXNzaW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBtb2NrUGVybWlzc2lvbi5pZCxcbiAgICAgICAgc2NvcGVUeXBlLFxuICAgICAgICBzY29wZUlkLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdCh1c2VyUGVybWlzc2lvblJlcG9zaXRvcnkuY3JlYXRlVXNlclBlcm1pc3Npb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBwZXJtaXNzaW9uSWQ6IG1vY2tQZXJtaXNzaW9uLmlkLFxuICAgICAgICBncmFudGVkOiB0cnVlLFxuICAgICAgICBzY29wZVR5cGUsXG4gICAgICAgIHNjb3BlSWQsXG4gICAgICAgIHZhbGlkVW50aWw6IG51bGwsXG4gICAgICAgIGNyZWF0ZWRCeSxcbiAgICAgIH0pO1xuICAgICAgZXhwZWN0KGF1ZGl0b3JpYVNlcnZpY2UuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgYXR1YWxpemFyIHVtYSBwZXJtaXNzw6NvIGV4aXN0ZW50ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICd1c2VyLTEyMyc7XG4gICAgICBjb25zdCBwZXJtaXNzaW9uTmFtZSA9ICdzb2xpY2l0YWNhby5saXN0YXInO1xuICAgICAgY29uc3Qgc2NvcGVUeXBlID0gU2NvcGVUeXBlLlVOSVQ7XG4gICAgICBjb25zdCBzY29wZUlkID0gJ3VuaWRhZGUtMTIzJztcbiAgICAgIGNvbnN0IGNyZWF0ZWRCeSA9ICdhZG1pbi11c2VyJztcblxuICAgICAgY29uc3QgbW9ja1Blcm1pc3Npb24gPSB7IGlkOiAncGVybS0xMjMnLCBuYW1lOiBwZXJtaXNzaW9uTmFtZSB9IGFzIFBlcm1pc3Npb247XG4gICAgICBjb25zdCBleGlzdGluZ1Blcm1pc3Npb24gPSB7XG4gICAgICAgIGlkOiAndXNlci1wZXJtLTEyMycsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgcGVybWlzc2lvbklkOiBtb2NrUGVybWlzc2lvbi5pZCxcbiAgICAgICAgc2NvcGVUeXBlLFxuICAgICAgICBzY29wZUlkLFxuICAgICAgICBncmFudGVkOiBmYWxzZSxcbiAgICAgIH07XG5cbiAgICAgIHBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeU5hbWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tQZXJtaXNzaW9uKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kQnlVc2VyQW5kUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoZXhpc3RpbmdQZXJtaXNzaW9uKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS51cGRhdGVVc2VyUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICAuLi5leGlzdGluZ1Blcm1pc3Npb24sXG4gICAgICAgIGdyYW50ZWQ6IHRydWUsXG4gICAgICAgIHVwZGF0ZWRCeTogY3JlYXRlZEJ5LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ3JhbnRQZXJtaXNzaW9uKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBlcm1pc3Npb25OYW1lLFxuICAgICAgICBzY29wZVR5cGUsXG4gICAgICAgIHNjb3BlSWQsXG4gICAgICAgIG51bGwsXG4gICAgICAgIGNyZWF0ZWRCeSxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdCh1c2VyUGVybWlzc2lvblJlcG9zaXRvcnkudXBkYXRlVXNlclBlcm1pc3Npb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleGlzdGluZ1Blcm1pc3Npb24uaWQsXG4gICAgICAgIHtcbiAgICAgICAgICBncmFudGVkOiB0cnVlLFxuICAgICAgICAgIHZhbGlkVW50aWw6IG51bGwsXG4gICAgICAgICAgdXBkYXRlZEJ5OiBjcmVhdGVkQnksXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgZXhwZWN0KGF1ZGl0b3JpYVNlcnZpY2UuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmV2b2tlUGVybWlzc2lvbicsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZXZvZ2FyIHVtYSBwZXJtaXNzw6NvIGV4aXN0ZW50ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICd1c2VyLTEyMyc7XG4gICAgICBjb25zdCBwZXJtaXNzaW9uTmFtZSA9ICdzb2xpY2l0YWNhby5saXN0YXInO1xuICAgICAgY29uc3Qgc2NvcGVUeXBlID0gU2NvcGVUeXBlLlVOSVQ7XG4gICAgICBjb25zdCBzY29wZUlkID0gJ3VuaWRhZGUtMTIzJztcbiAgICAgIGNvbnN0IGNyZWF0ZWRCeSA9ICdhZG1pbi11c2VyJztcblxuICAgICAgY29uc3QgbW9ja1Blcm1pc3Npb24gPSB7IGlkOiAncGVybS0xMjMnLCBuYW1lOiBwZXJtaXNzaW9uTmFtZSB9IGFzIFBlcm1pc3Npb247XG4gICAgICBjb25zdCBleGlzdGluZ1Blcm1pc3Npb24gPSB7XG4gICAgICAgIGlkOiAndXNlci1wZXJtLTEyMycsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgcGVybWlzc2lvbklkOiBtb2NrUGVybWlzc2lvbi5pZCxcbiAgICAgICAgc2NvcGVUeXBlLFxuICAgICAgICBzY29wZUlkLFxuICAgICAgICBncmFudGVkOiB0cnVlLFxuICAgICAgfTtcblxuICAgICAgcGVybWlzc2lvblJlcG9zaXRvcnkuZmluZEJ5TmFtZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobW9ja1Blcm1pc3Npb24pO1xuICAgICAgdXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeVVzZXJBbmRQZXJtaXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlT25jZShleGlzdGluZ1Blcm1pc3Npb24pO1xuICAgICAgdXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LnVwZGF0ZVVzZXJQZXJtaXNzaW9uLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICAgIC4uLmV4aXN0aW5nUGVybWlzc2lvbixcbiAgICAgICAgZ3JhbnRlZDogZmFsc2UsXG4gICAgICAgIHVwZGF0ZWRCeTogY3JlYXRlZEJ5LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UucmV2b2tlUGVybWlzc2lvbihcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBwZXJtaXNzaW9uTmFtZSxcbiAgICAgICAgc2NvcGVUeXBlLFxuICAgICAgICBzY29wZUlkLFxuICAgICAgICBjcmVhdGVkQnksXG4gICAgICApO1xuXG4gICAgICBleHBlY3QodXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LnVwZGF0ZVVzZXJQZXJtaXNzaW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhpc3RpbmdQZXJtaXNzaW9uLmlkLFxuICAgICAgICB7XG4gICAgICAgICAgZ3JhbnRlZDogZmFsc2UsXG4gICAgICAgICAgdXBkYXRlZEJ5OiBjcmVhdGVkQnksXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgICAgZXhwZWN0KGF1ZGl0b3JpYVNlcnZpY2UuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgZmFsc2UgcXVhbmRvIGEgcGVybWlzc8OjbyBuw6NvIGV4aXN0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9ICd1c2VyLTEyMyc7XG4gICAgICBjb25zdCBwZXJtaXNzaW9uTmFtZSA9ICdzb2xpY2l0YWNhby5saXN0YXInO1xuICAgICAgY29uc3Qgc2NvcGVUeXBlID0gU2NvcGVUeXBlLlVOSVQ7XG4gICAgICBjb25zdCBzY29wZUlkID0gJ3VuaWRhZGUtMTIzJztcbiAgICAgIGNvbnN0IGNyZWF0ZWRCeSA9ICdhZG1pbi11c2VyJztcblxuICAgICAgY29uc3QgbW9ja1Blcm1pc3Npb24gPSB7IGlkOiAncGVybS0xMjMnLCBuYW1lOiBwZXJtaXNzaW9uTmFtZSB9IGFzIFBlcm1pc3Npb247XG5cbiAgICAgIHBlcm1pc3Npb25SZXBvc2l0b3J5LmZpbmRCeU5hbWUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tQZXJtaXNzaW9uKTtcbiAgICAgIHVzZXJQZXJtaXNzaW9uUmVwb3NpdG9yeS5maW5kQnlVc2VyQW5kUGVybWlzc2lvbi5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UobnVsbCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UucmV2b2tlUGVybWlzc2lvbihcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBwZXJtaXNzaW9uTmFtZSxcbiAgICAgICAgc2NvcGVUeXBlLFxuICAgICAgICBzY29wZUlkLFxuICAgICAgICBjcmVhdGVkQnksXG4gICAgICApO1xuXG4gICAgICBleHBlY3QodXNlclBlcm1pc3Npb25SZXBvc2l0b3J5LnVwZGF0ZVVzZXJQZXJtaXNzaW9uKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGF1ZGl0b3JpYVNlcnZpY2UuY3JpYXJMb2cpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==