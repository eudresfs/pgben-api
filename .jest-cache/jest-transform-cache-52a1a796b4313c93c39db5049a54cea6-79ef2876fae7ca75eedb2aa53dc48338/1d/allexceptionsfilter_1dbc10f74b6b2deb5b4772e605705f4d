a7ec28f5db459089ab68540e8067c423
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AllExceptionsFilter_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AllExceptionsFilter = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const constants_1 = require("../constants");
const util_1 = require("../request-context/util");
const base_api_exception_1 = require("../exceptions/base-api.exception");
const unified_logger_service_1 = require("../logging/unified-logger.service");
/**
 * Filtro global para tratamento de exceções
 *
 * Padroniza todas as respostas de erro da aplicação,
 * garantindo consistência e logging adequado.
 *
 * Características:
 * - Tratamento específico para diferentes tipos de exceção
 * - Logging estruturado com contexto de requisição
 * - Respostas padronizadas conforme ApiErrorResponse
 * - Suporte a validação e localização de mensagens
 * - Proteção de dados sensíveis em produção
 */
let AllExceptionsFilter = AllExceptionsFilter_1 = class AllExceptionsFilter {
    config;
    logger;
    constructor(config, logger) {
        this.config = config;
        this.logger = logger;
        this.logger.setContext(AllExceptionsFilter_1.name);
    }
    catch(exception, host) {
        const ctx = host.switchToHttp();
        const req = ctx.getRequest();
        const res = ctx.getResponse();
        const path = req.url;
        const timestamp = new Date().toISOString();
        const requestId = req.headers[constants_1.REQUEST_ID_TOKEN_HEADER];
        const requestContext = (0, util_1.createRequestContext)(req);
        // Extrair idioma do header para localização (padrão: pt-BR)
        const acceptedLanguage = req.headers['accept-language']?.split(',')[0] || 'pt-BR';
        let stack;
        let statusCode;
        let errorName;
        let message;
        let details;
        let localizedMessage;
        let validationErrors;
        // Tratamento estruturado por tipo de exceção
        switch (true) {
            case exception instanceof base_api_exception_1.BaseApiException:
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                message = exception.message;
                localizedMessage = exception.localizedMessage?.[acceptedLanguage];
                details = exception.details || exception.getResponse();
                break;
            case exception instanceof common_1.BadRequestException:
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                const response = exception.getResponse();
                // Tratar erros de validação do class-validator
                if (response?.message && Array.isArray(response.message)) {
                    validationErrors = this.processValidationErrors(response.message);
                    message = 'Erro de validação';
                    details = { validationErrors };
                }
                else {
                    message = response?.message || exception.message;
                    details = response;
                }
                break;
            case exception instanceof common_1.HttpException:
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                message = exception.message;
                details = exception.getResponse();
                break;
            case exception instanceof Error:
                statusCode = common_1.HttpStatus.INTERNAL_SERVER_ERROR;
                errorName = exception.constructor.name;
                message = exception.message;
                stack = exception.stack;
                break;
            default:
                statusCode = common_1.HttpStatus.INTERNAL_SERVER_ERROR;
                errorName = 'UnknownException';
                message = 'Erro interno do servidor';
                break;
        }
        // Criar resposta de erro padronizada
        const errorResponse = {
            statusCode,
            message,
            code: errorName,
            details,
            errors: validationErrors,
            timestamp,
            path,
        };
        // Log estruturado do erro
        const logLevel = statusCode >= 500 ? 'error' : 'warn';
        const logMessage = `${errorName}: ${message}`;
        const logMeta = {
            statusCode,
            errorName,
            path,
            requestId,
            userAgent: req.headers['user-agent'],
            ip: req.ip,
            method: req.method,
            stack: stack && this.config.get('NODE_ENV') === 'development' ? stack : undefined,
        };
        if (logLevel === 'error') {
            this.logger.error(requestContext, logMessage, logMeta);
        }
        else {
            this.logger.warn(requestContext, logMessage, logMeta);
        }
        // Proteger dados sensíveis em produção
        const isProduction = this.config.get('NODE_ENV') === 'production';
        if (isProduction && statusCode === common_1.HttpStatus.INTERNAL_SERVER_ERROR) {
            errorResponse.message = 'Erro interno do servidor';
            errorResponse.details = undefined;
        }
        res.status(statusCode).json(errorResponse);
    }
    /**
     * Processa erros de validação do class-validator em formato estruturado
     */
    processValidationErrors(validationErrors) {
        const result = [];
        for (const error of validationErrors) {
            if (typeof error === 'string') {
                // Erro simples como string
                result.push({
                    field: 'unknown',
                    messages: [error],
                });
            }
            else if (error && typeof error === 'object' && 'property' in error) {
                // ValidationError do class-validator
                const validationError = error;
                const messages = validationError.constraints
                    ? Object.values(validationError.constraints)
                    : ['Erro de validação'];
                result.push({
                    field: validationError.property,
                    messages,
                });
                // Processar erros aninhados
                if (validationError.children && validationError.children.length > 0) {
                    const childErrors = this.processValidationErrors(validationError.children);
                    result.push(...childErrors.map(childError => ({
                        field: `${validationError.property}.${childError.field}`,
                        messages: childError.messages,
                    })));
                }
            }
        }
        return result;
    }
};
exports.AllExceptionsFilter = AllExceptionsFilter;
exports.AllExceptionsFilter = AllExceptionsFilter = AllExceptionsFilter_1 = __decorate([
    (0, common_1.Injectable)(),
    (0, common_1.Catch)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof unified_logger_service_1.UnifiedLoggerService !== "undefined" && unified_logger_service_1.UnifiedLoggerService) === "function" ? _b : Object])
], AllExceptionsFilter);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZmlsdGVyc1xcYWxsLWV4Y2VwdGlvbnMuZmlsdGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW1JO0FBQ25JLDJDQUErQztBQUcvQyw0Q0FBdUQ7QUFDdkQsa0RBQStEO0FBQy9ELHlFQUFvRTtBQUNwRSw4RUFBeUU7QUFHekU7Ozs7Ozs7Ozs7OztHQVlHO0FBR0ksSUFBTSxtQkFBbUIsMkJBQXpCLE1BQU0sbUJBQW1CO0lBRVg7SUFDQTtJQUZuQixZQUNtQixNQUFxQixFQUNyQixNQUE0QjtRQUQ1QixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLFdBQU0sR0FBTixNQUFNLENBQXNCO1FBRTdDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLHFCQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCxLQUFLLENBQUMsU0FBWSxFQUFFLElBQW1CO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNoQyxNQUFNLEdBQUcsR0FBWSxHQUFHLENBQUMsVUFBVSxFQUFXLENBQUM7UUFDL0MsTUFBTSxHQUFHLEdBQWEsR0FBRyxDQUFDLFdBQVcsRUFBWSxDQUFDO1FBRWxELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUM7UUFDckIsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUMzQyxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLG1DQUF1QixDQUFXLENBQUM7UUFDakUsTUFBTSxjQUFjLEdBQUcsSUFBQSwyQkFBb0IsRUFBQyxHQUFHLENBQUMsQ0FBQztRQUVqRCw0REFBNEQ7UUFDNUQsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQztRQUVsRixJQUFJLEtBQXlCLENBQUM7UUFDOUIsSUFBSSxVQUFzQixDQUFDO1FBQzNCLElBQUksU0FBaUIsQ0FBQztRQUN0QixJQUFJLE9BQWUsQ0FBQztRQUNwQixJQUFJLE9BQVksQ0FBQztRQUNqQixJQUFJLGdCQUFvQyxDQUFDO1FBQ3pDLElBQUksZ0JBQTBFLENBQUM7UUFFL0UsNkNBQTZDO1FBQzdDLFFBQVEsSUFBSSxFQUFFLENBQUM7WUFDYixLQUFLLFNBQVMsWUFBWSxxQ0FBZ0I7Z0JBQ3hDLFVBQVUsR0FBRyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ25DLFNBQVMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztnQkFDdkMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7Z0JBQzVCLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLGdCQUFnQixDQUFDLENBQUM7Z0JBQ2xFLE9BQU8sR0FBRyxTQUFTLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDdkQsTUFBTTtZQUVSLEtBQUssU0FBUyxZQUFZLDRCQUFtQjtnQkFDM0MsVUFBVSxHQUFHLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDbkMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO2dCQUN2QyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFTLENBQUM7Z0JBRWhELCtDQUErQztnQkFDL0MsSUFBSSxRQUFRLEVBQUUsT0FBTyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7b0JBQ3pELGdCQUFnQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ2xFLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQztvQkFDOUIsT0FBTyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztnQkFDakMsQ0FBQztxQkFBTSxDQUFDO29CQUNOLE9BQU8sR0FBRyxRQUFRLEVBQUUsT0FBTyxJQUFJLFNBQVMsQ0FBQyxPQUFPLENBQUM7b0JBQ2pELE9BQU8sR0FBRyxRQUFRLENBQUM7Z0JBQ3JCLENBQUM7Z0JBQ0QsTUFBTTtZQUVSLEtBQUssU0FBUyxZQUFZLHNCQUFhO2dCQUNyQyxVQUFVLEdBQUcsU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNuQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7Z0JBQ3ZDLE9BQU8sR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDO2dCQUM1QixPQUFPLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNsQyxNQUFNO1lBRVIsS0FBSyxTQUFTLFlBQVksS0FBSztnQkFDN0IsVUFBVSxHQUFHLG1CQUFVLENBQUMscUJBQXFCLENBQUM7Z0JBQzlDLFNBQVMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztnQkFDdkMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7Z0JBQzVCLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO2dCQUN4QixNQUFNO1lBRVI7Z0JBQ0UsVUFBVSxHQUFHLG1CQUFVLENBQUMscUJBQXFCLENBQUM7Z0JBQzlDLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQztnQkFDL0IsT0FBTyxHQUFHLDBCQUEwQixDQUFDO2dCQUNyQyxNQUFNO1FBQ1YsQ0FBQztRQUVELHFDQUFxQztRQUNyQyxNQUFNLGFBQWEsR0FBcUI7WUFDdEMsVUFBVTtZQUNWLE9BQU87WUFDUCxJQUFJLEVBQUUsU0FBUztZQUNmLE9BQU87WUFDUCxNQUFNLEVBQUUsZ0JBQWdCO1lBQ3hCLFNBQVM7WUFDVCxJQUFJO1NBQ0wsQ0FBQztRQUVGLDBCQUEwQjtRQUMxQixNQUFNLFFBQVEsR0FBRyxVQUFVLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN0RCxNQUFNLFVBQVUsR0FBRyxHQUFHLFNBQVMsS0FBSyxPQUFPLEVBQUUsQ0FBQztRQUM5QyxNQUFNLE9BQU8sR0FBRztZQUNkLFVBQVU7WUFDVixTQUFTO1lBQ1QsSUFBSTtZQUNKLFNBQVM7WUFDVCxTQUFTLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7WUFDcEMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ1YsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLEtBQUssRUFBRSxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQVMsVUFBVSxDQUFDLEtBQUssYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7U0FDMUYsQ0FBQztRQUVGLElBQUksUUFBUSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekQsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hELENBQUM7UUFFRCx1Q0FBdUM7UUFDdkMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQVMsVUFBVSxDQUFDLEtBQUssWUFBWSxDQUFDO1FBQzFFLElBQUksWUFBWSxJQUFJLFVBQVUsS0FBSyxtQkFBVSxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDcEUsYUFBYSxDQUFDLE9BQU8sR0FBRywwQkFBMEIsQ0FBQztZQUNuRCxhQUFhLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQztRQUNwQyxDQUFDO1FBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0ssdUJBQXVCLENBQzdCLGdCQUE4QztRQUU5QyxNQUFNLE1BQU0sR0FBaUQsRUFBRSxDQUFDO1FBRWhFLEtBQUssTUFBTSxLQUFLLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztZQUNyQyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUM5QiwyQkFBMkI7Z0JBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUM7b0JBQ1YsS0FBSyxFQUFFLFNBQVM7b0JBQ2hCLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQztpQkFDbEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztpQkFBTSxJQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksVUFBVSxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNyRSxxQ0FBcUM7Z0JBQ3JDLE1BQU0sZUFBZSxHQUFHLEtBQXdCLENBQUM7Z0JBQ2pELE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxXQUFXO29CQUMxQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDO29CQUM1QyxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO2dCQUUxQixNQUFNLENBQUMsSUFBSSxDQUFDO29CQUNWLEtBQUssRUFBRSxlQUFlLENBQUMsUUFBUTtvQkFDL0IsUUFBUTtpQkFDVCxDQUFDLENBQUM7Z0JBRUgsNEJBQTRCO2dCQUM1QixJQUFJLGVBQWUsQ0FBQyxRQUFRLElBQUksZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQ3BFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQzNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDNUMsS0FBSyxFQUFFLEdBQUcsZUFBZSxDQUFDLFFBQVEsSUFBSSxVQUFVLENBQUMsS0FBSyxFQUFFO3dCQUN4RCxRQUFRLEVBQUUsVUFBVSxDQUFDLFFBQVE7cUJBQzlCLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGLENBQUE7QUE3Slksa0RBQW1COzhCQUFuQixtQkFBbUI7SUFGL0IsSUFBQSxtQkFBVSxHQUFFO0lBQ1osSUFBQSxjQUFLLEdBQUU7eURBR3FCLHNCQUFhLG9CQUFiLHNCQUFhLG9EQUNiLDZDQUFvQixvQkFBcEIsNkNBQW9CO0dBSHBDLG1CQUFtQixDQTZKL0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZmlsdGVyc1xcYWxsLWV4Y2VwdGlvbnMuZmlsdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFyZ3VtZW50c0hvc3QsIENhdGNoLCBFeGNlcHRpb25GaWx0ZXIsIEh0dHBFeGNlcHRpb24sIEh0dHBTdGF0dXMsIEluamVjdGFibGUsIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvciB9IGZyb20gJ2NsYXNzLXZhbGlkYXRvcic7XG5pbXBvcnQgeyBSRVFVRVNUX0lEX1RPS0VOX0hFQURFUiB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBjcmVhdGVSZXF1ZXN0Q29udGV4dCB9IGZyb20gJy4uL3JlcXVlc3QtY29udGV4dC91dGlsJztcbmltcG9ydCB7IEJhc2VBcGlFeGNlcHRpb24gfSBmcm9tICcuLi9leGNlcHRpb25zL2Jhc2UtYXBpLmV4Y2VwdGlvbic7XG5pbXBvcnQgeyBVbmlmaWVkTG9nZ2VyU2VydmljZSB9IGZyb20gJy4uL2xvZ2dpbmcvdW5pZmllZC1sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBBcGlFcnJvclJlc3BvbnNlIH0gZnJvbSAnLi4vZHRvcy9hcGktZXJyb3ItcmVzcG9uc2UuZHRvJztcblxuLyoqXG4gKiBGaWx0cm8gZ2xvYmFsIHBhcmEgdHJhdGFtZW50byBkZSBleGNlw6fDtWVzXG4gKiBcbiAqIFBhZHJvbml6YSB0b2RhcyBhcyByZXNwb3N0YXMgZGUgZXJybyBkYSBhcGxpY2HDp8OjbyxcbiAqIGdhcmFudGluZG8gY29uc2lzdMOqbmNpYSBlIGxvZ2dpbmcgYWRlcXVhZG8uXG4gKiBcbiAqIENhcmFjdGVyw61zdGljYXM6XG4gKiAtIFRyYXRhbWVudG8gZXNwZWPDrWZpY28gcGFyYSBkaWZlcmVudGVzIHRpcG9zIGRlIGV4Y2XDp8Ojb1xuICogLSBMb2dnaW5nIGVzdHJ1dHVyYWRvIGNvbSBjb250ZXh0byBkZSByZXF1aXNpw6fDo29cbiAqIC0gUmVzcG9zdGFzIHBhZHJvbml6YWRhcyBjb25mb3JtZSBBcGlFcnJvclJlc3BvbnNlXG4gKiAtIFN1cG9ydGUgYSB2YWxpZGHDp8OjbyBlIGxvY2FsaXphw6fDo28gZGUgbWVuc2FnZW5zXG4gKiAtIFByb3Rlw6fDo28gZGUgZGFkb3Mgc2Vuc8OtdmVpcyBlbSBwcm9kdcOnw6NvXG4gKi9cbkBJbmplY3RhYmxlKClcbkBDYXRjaCgpXG5leHBvcnQgY2xhc3MgQWxsRXhjZXB0aW9uc0ZpbHRlcjxUPiBpbXBsZW1lbnRzIEV4Y2VwdGlvbkZpbHRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBVbmlmaWVkTG9nZ2VyU2VydmljZSxcbiAgKSB7XG4gICAgdGhpcy5sb2dnZXIuc2V0Q29udGV4dChBbGxFeGNlcHRpb25zRmlsdGVyLm5hbWUpO1xuICB9XG5cbiAgY2F0Y2goZXhjZXB0aW9uOiBULCBob3N0OiBBcmd1bWVudHNIb3N0KTogYW55IHtcbiAgICBjb25zdCBjdHggPSBob3N0LnN3aXRjaFRvSHR0cCgpO1xuICAgIGNvbnN0IHJlcTogUmVxdWVzdCA9IGN0eC5nZXRSZXF1ZXN0PFJlcXVlc3Q+KCk7XG4gICAgY29uc3QgcmVzOiBSZXNwb25zZSA9IGN0eC5nZXRSZXNwb25zZTxSZXNwb25zZT4oKTtcblxuICAgIGNvbnN0IHBhdGggPSByZXEudXJsO1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSByZXEuaGVhZGVyc1tSRVFVRVNUX0lEX1RPS0VOX0hFQURFUl0gYXMgc3RyaW5nO1xuICAgIGNvbnN0IHJlcXVlc3RDb250ZXh0ID0gY3JlYXRlUmVxdWVzdENvbnRleHQocmVxKTtcblxuICAgIC8vIEV4dHJhaXIgaWRpb21hIGRvIGhlYWRlciBwYXJhIGxvY2FsaXphw6fDo28gKHBhZHLDo286IHB0LUJSKVxuICAgIGNvbnN0IGFjY2VwdGVkTGFuZ3VhZ2UgPSByZXEuaGVhZGVyc1snYWNjZXB0LWxhbmd1YWdlJ10/LnNwbGl0KCcsJylbMF0gfHwgJ3B0LUJSJztcblxuICAgIGxldCBzdGFjazogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzO1xuICAgIGxldCBlcnJvck5hbWU6IHN0cmluZztcbiAgICBsZXQgbWVzc2FnZTogc3RyaW5nO1xuICAgIGxldCBkZXRhaWxzOiBhbnk7XG4gICAgbGV0IGxvY2FsaXplZE1lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgdmFsaWRhdGlvbkVycm9yczogQXJyYXk8eyBmaWVsZDogc3RyaW5nOyBtZXNzYWdlczogc3RyaW5nW10gfT4gfCB1bmRlZmluZWQ7XG5cbiAgICAvLyBUcmF0YW1lbnRvIGVzdHJ1dHVyYWRvIHBvciB0aXBvIGRlIGV4Y2XDp8Ojb1xuICAgIHN3aXRjaCAodHJ1ZSkge1xuICAgICAgY2FzZSBleGNlcHRpb24gaW5zdGFuY2VvZiBCYXNlQXBpRXhjZXB0aW9uOlxuICAgICAgICBzdGF0dXNDb2RlID0gZXhjZXB0aW9uLmdldFN0YXR1cygpO1xuICAgICAgICBlcnJvck5hbWUgPSBleGNlcHRpb24uY29uc3RydWN0b3IubmFtZTtcbiAgICAgICAgbWVzc2FnZSA9IGV4Y2VwdGlvbi5tZXNzYWdlO1xuICAgICAgICBsb2NhbGl6ZWRNZXNzYWdlID0gZXhjZXB0aW9uLmxvY2FsaXplZE1lc3NhZ2U/LlthY2NlcHRlZExhbmd1YWdlXTtcbiAgICAgICAgZGV0YWlscyA9IGV4Y2VwdGlvbi5kZXRhaWxzIHx8IGV4Y2VwdGlvbi5nZXRSZXNwb25zZSgpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBleGNlcHRpb24gaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uOlxuICAgICAgICBzdGF0dXNDb2RlID0gZXhjZXB0aW9uLmdldFN0YXR1cygpO1xuICAgICAgICBlcnJvck5hbWUgPSBleGNlcHRpb24uY29uc3RydWN0b3IubmFtZTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBleGNlcHRpb24uZ2V0UmVzcG9uc2UoKSBhcyBhbnk7XG4gICAgICAgIFxuICAgICAgICAvLyBUcmF0YXIgZXJyb3MgZGUgdmFsaWRhw6fDo28gZG8gY2xhc3MtdmFsaWRhdG9yXG4gICAgICAgIGlmIChyZXNwb25zZT8ubWVzc2FnZSAmJiBBcnJheS5pc0FycmF5KHJlc3BvbnNlLm1lc3NhZ2UpKSB7XG4gICAgICAgICAgdmFsaWRhdGlvbkVycm9ycyA9IHRoaXMucHJvY2Vzc1ZhbGlkYXRpb25FcnJvcnMocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgbWVzc2FnZSA9ICdFcnJvIGRlIHZhbGlkYcOnw6NvJztcbiAgICAgICAgICBkZXRhaWxzID0geyB2YWxpZGF0aW9uRXJyb3JzIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbWVzc2FnZSA9IHJlc3BvbnNlPy5tZXNzYWdlIHx8IGV4Y2VwdGlvbi5tZXNzYWdlO1xuICAgICAgICAgIGRldGFpbHMgPSByZXNwb25zZTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBleGNlcHRpb24gaW5zdGFuY2VvZiBIdHRwRXhjZXB0aW9uOlxuICAgICAgICBzdGF0dXNDb2RlID0gZXhjZXB0aW9uLmdldFN0YXR1cygpO1xuICAgICAgICBlcnJvck5hbWUgPSBleGNlcHRpb24uY29uc3RydWN0b3IubmFtZTtcbiAgICAgICAgbWVzc2FnZSA9IGV4Y2VwdGlvbi5tZXNzYWdlO1xuICAgICAgICBkZXRhaWxzID0gZXhjZXB0aW9uLmdldFJlc3BvbnNlKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEVycm9yOlxuICAgICAgICBzdGF0dXNDb2RlID0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1I7XG4gICAgICAgIGVycm9yTmFtZSA9IGV4Y2VwdGlvbi5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICBtZXNzYWdlID0gZXhjZXB0aW9uLm1lc3NhZ2U7XG4gICAgICAgIHN0YWNrID0gZXhjZXB0aW9uLnN0YWNrO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgc3RhdHVzQ29kZSA9IEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SO1xuICAgICAgICBlcnJvck5hbWUgPSAnVW5rbm93bkV4Y2VwdGlvbic7XG4gICAgICAgIG1lc3NhZ2UgPSAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yJztcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gQ3JpYXIgcmVzcG9zdGEgZGUgZXJybyBwYWRyb25pemFkYVxuICAgIGNvbnN0IGVycm9yUmVzcG9uc2U6IEFwaUVycm9yUmVzcG9uc2UgPSB7XG4gICAgICBzdGF0dXNDb2RlLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIGNvZGU6IGVycm9yTmFtZSxcbiAgICAgIGRldGFpbHMsXG4gICAgICBlcnJvcnM6IHZhbGlkYXRpb25FcnJvcnMsXG4gICAgICB0aW1lc3RhbXAsXG4gICAgICBwYXRoLFxuICAgIH07XG5cbiAgICAvLyBMb2cgZXN0cnV0dXJhZG8gZG8gZXJyb1xuICAgIGNvbnN0IGxvZ0xldmVsID0gc3RhdHVzQ29kZSA+PSA1MDAgPyAnZXJyb3InIDogJ3dhcm4nO1xuICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBgJHtlcnJvck5hbWV9OiAke21lc3NhZ2V9YDtcbiAgICBjb25zdCBsb2dNZXRhID0ge1xuICAgICAgc3RhdHVzQ29kZSxcbiAgICAgIGVycm9yTmFtZSxcbiAgICAgIHBhdGgsXG4gICAgICByZXF1ZXN0SWQsXG4gICAgICB1c2VyQWdlbnQ6IHJlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10sXG4gICAgICBpcDogcmVxLmlwLFxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgc3RhY2s6IHN0YWNrICYmIHRoaXMuY29uZmlnLmdldDxzdHJpbmc+KCdOT0RFX0VOVicpID09PSAnZGV2ZWxvcG1lbnQnID8gc3RhY2sgOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIGlmIChsb2dMZXZlbCA9PT0gJ2Vycm9yJykge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocmVxdWVzdENvbnRleHQsIGxvZ01lc3NhZ2UsIGxvZ01ldGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKHJlcXVlc3RDb250ZXh0LCBsb2dNZXNzYWdlLCBsb2dNZXRhKTtcbiAgICB9XG5cbiAgICAvLyBQcm90ZWdlciBkYWRvcyBzZW5zw612ZWlzIGVtIHByb2R1w6fDo29cbiAgICBjb25zdCBpc1Byb2R1Y3Rpb24gPSB0aGlzLmNvbmZpZy5nZXQ8c3RyaW5nPignTk9ERV9FTlYnKSA9PT0gJ3Byb2R1Y3Rpb24nO1xuICAgIGlmIChpc1Byb2R1Y3Rpb24gJiYgc3RhdHVzQ29kZSA9PT0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpIHtcbiAgICAgIGVycm9yUmVzcG9uc2UubWVzc2FnZSA9ICdFcnJvIGludGVybm8gZG8gc2Vydmlkb3InO1xuICAgICAgZXJyb3JSZXNwb25zZS5kZXRhaWxzID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbihlcnJvclJlc3BvbnNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzYSBlcnJvcyBkZSB2YWxpZGHDp8OjbyBkbyBjbGFzcy12YWxpZGF0b3IgZW0gZm9ybWF0byBlc3RydXR1cmFkb1xuICAgKi9cbiAgcHJpdmF0ZSBwcm9jZXNzVmFsaWRhdGlvbkVycm9ycyhcbiAgICB2YWxpZGF0aW9uRXJyb3JzOiBzdHJpbmdbXSB8IFZhbGlkYXRpb25FcnJvcltdXG4gICk6IEFycmF5PHsgZmllbGQ6IHN0cmluZzsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+IHtcbiAgICBjb25zdCByZXN1bHQ6IEFycmF5PHsgZmllbGQ6IHN0cmluZzsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+ID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGVycm9yIG9mIHZhbGlkYXRpb25FcnJvcnMpIHtcbiAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIC8vIEVycm8gc2ltcGxlcyBjb21vIHN0cmluZ1xuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgZmllbGQ6ICd1bmtub3duJyxcbiAgICAgICAgICBtZXNzYWdlczogW2Vycm9yXSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGVycm9yICYmIHR5cGVvZiBlcnJvciA9PT0gJ29iamVjdCcgJiYgJ3Byb3BlcnR5JyBpbiBlcnJvcikge1xuICAgICAgICAvLyBWYWxpZGF0aW9uRXJyb3IgZG8gY2xhc3MtdmFsaWRhdG9yXG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IGVycm9yIGFzIFZhbGlkYXRpb25FcnJvcjtcbiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNcbiAgICAgICAgICA/IE9iamVjdC52YWx1ZXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKVxuICAgICAgICAgIDogWydFcnJvIGRlIHZhbGlkYcOnw6NvJ107XG4gICAgICAgIFxuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgZmllbGQ6IHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eSxcbiAgICAgICAgICBtZXNzYWdlcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUHJvY2Vzc2FyIGVycm9zIGFuaW5oYWRvc1xuICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgY2hpbGRFcnJvcnMgPSB0aGlzLnByb2Nlc3NWYWxpZGF0aW9uRXJyb3JzKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbik7XG4gICAgICAgICAgcmVzdWx0LnB1c2goLi4uY2hpbGRFcnJvcnMubWFwKGNoaWxkRXJyb3IgPT4gKHtcbiAgICAgICAgICAgIGZpZWxkOiBgJHt2YWxpZGF0aW9uRXJyb3IucHJvcGVydHl9LiR7Y2hpbGRFcnJvci5maWVsZH1gLFxuICAgICAgICAgICAgbWVzc2FnZXM6IGNoaWxkRXJyb3IubWVzc2FnZXMsXG4gICAgICAgICAgfSkpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==