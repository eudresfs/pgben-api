2a3743877bce6a8db7d9ef376dbf239c
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RolePermissionRepository = void 0;
const typeorm_1 = require("typeorm");
const common_1 = require("@nestjs/common");
const role_permission_entity_1 = require("../../entities/role-permission.entity");
const permission_entity_1 = require("../../entities/permission.entity");
const usuario_entity_1 = require("../../entities/usuario.entity");
/**
 * Repositório para a entidade RolePermission.
 *
 * Fornece métodos para manipulação de mapeamentos entre roles e permissões no banco de dados,
 * incluindo busca por role, permissão e operações de CRUD.
 */
let RolePermissionRepository = class RolePermissionRepository extends typeorm_1.Repository {
    dataSource;
    constructor(dataSource) {
        super(role_permission_entity_1.RolePermission, dataSource.createEntityManager());
        this.dataSource = dataSource;
    }
    /**
     * Busca mapeamentos por ID de role com cache.
     *
     * @param roleId ID da role
     * @returns Lista de mapeamentos encontrados
     */
    async findByRoleId(roleId) {
        return this.find({
            where: { role_id: roleId },
            cache: {
                id: `role_mappings_${roleId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por múltiplos IDs de role.
     *
     * @param roleIds IDs das roles
     * @returns Lista de mapeamentos encontrados
     */
    async findByRoleIds(roleIds) {
        if (roleIds.length === 0)
            return [];
        return this.find({
            where: { role_id: (0, typeorm_1.In)(roleIds) },
            cache: {
                id: `role_mappings_multiple_${roleIds.sort().join('_')}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por ID de permissão com cache.
     *
     * @param permissionId ID da permissão
     * @returns Lista de mapeamentos encontrados
     */
    async findByPermissionId(permissionId) {
        return this.find({
            where: { permissao_id: permissionId },
            cache: {
                id: `permission_mappings_${permissionId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamento por ID de role e ID de permissão.
     *
     * @param roleId ID da role
     * @param permissionId ID da permissão
     * @returns O mapeamento encontrado ou null
     */
    async findByRoleAndPermission(roleId, permissionId) {
        return this.findOne({
            where: { role_id: roleId, permissao_id: permissionId },
            cache: {
                id: `role_permission_${roleId}_${permissionId}`,
                milliseconds: 300000, // 5 minutos
            },
        });
    }
    /**
     * Busca mapeamentos por ID de role com permissões relacionadas.
     *
     * @param roleId ID da role
     * @returns Lista de mapeamentos encontrados com permissões relacionadas
     */
    async findByRoleIdWithPermissions(roleId) {
        return this.createQueryBuilder('role_permissao')
            .leftJoinAndSelect('role_permissao.permissao', 'permissao')
            .where('role_permissao.role_id = :roleId', { roleId })
            .cache(`role_permissions_detailed_${roleId}`, 300000)
            .getMany();
    }
    /**
     * Cria um novo mapeamento entre role e permissão.
     *
     * @param data Dados do mapeamento a ser criado
     * @returns O mapeamento criado
     */
    async createMapping(data) {
        // Verifica se já existe o mapeamento
        if (data.role_id && data.permissao_id) {
            const existing = await this.findByRoleAndPermission(data.role_id, data.permissao_id);
            if (existing) {
                return existing;
            }
        }
        const mapping = this.create(data);
        const saved = await this.save(mapping);
        // Limpa cache relacionado
        if (data.role_id) {
            await this.clearCacheForRole(data.role_id);
        }
        if (data.permissao_id) {
            await this.clearCacheForPermission(data.permissao_id);
        }
        return saved;
    }
    /**
     * Cria múltiplos mapeamentos em batch
     *
     * @param mappings Lista de mapeamentos a serem criados
     * @returns Lista de mapeamentos criados
     */
    async createMultipleMappings(mappings) {
        if (mappings.length === 0)
            return [];
        const entities = mappings.map((mapping) => this.create(mapping));
        const saved = await this.save(entities);
        // Limpa cache para todas as roles e permissões afetadas
        const uniqueRoleIds = [
            ...new Set(mappings.map((m) => m.role_id).filter(Boolean)),
        ];
        const uniquePermissionIds = [
            ...new Set(mappings.map((m) => m.permissao_id).filter(Boolean)),
        ];
        await Promise.all([
            ...uniqueRoleIds.map((roleId) => this.clearCacheForRole(roleId)),
            ...uniquePermissionIds.map((permissionId) => this.clearCacheForPermission(permissionId)),
        ]);
        return saved;
    }
    /**
     * Remove um mapeamento entre role e permissão.
     *
     * @param id ID do mapeamento a ser removido
     * @returns true se o mapeamento foi removido, false caso contrário
     */
    async removeMapping(id) {
        // Busca o mapeamento antes de remover para limpar cache
        const mapping = await this.findOne({ where: { id } });
        const result = await this.delete(id);
        const removed = result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed && mapping) {
            await this.clearCacheForRole(mapping.role_id);
            await this.clearCacheForPermission(mapping.permissao_id);
        }
        return removed;
    }
    /**
     * Remove todos os mapeamentos de uma role.
     *
     * @param roleId ID da role
     * @returns true se os mapeamentos foram removidos, false caso contrário
     */
    async removeMappingsByRoleId(roleId) {
        // Busca os mapeamentos antes de remover para limpar cache das permissões
        const mappings = await this.findByRoleId(roleId);
        const result = await this.delete({ role_id: roleId });
        const removed = result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed) {
            await this.clearCacheForRole(roleId);
            // Limpa cache das permissões afetadas
            const uniquePermissionIds = [
                ...new Set(mappings.map((m) => m.permissao_id)),
            ];
            await Promise.all(uniquePermissionIds.map((permissionId) => this.clearCacheForPermission(permissionId)));
        }
        return removed;
    }
    /**
     * Remove todos os mapeamentos de uma permissão.
     *
     * @param permissionId ID da permissão
     * @returns true se os mapeamentos foram removidos, false caso contrário
     */
    async removeMappingsByPermissionId(permissionId) {
        // Busca os mapeamentos antes de remover para limpar cache das roles
        const mappings = await this.findByPermissionId(permissionId);
        const result = await this.delete({ permissao_id: permissionId });
        const removed = result.affected !== null &&
            result.affected !== undefined &&
            result.affected > 0;
        // Limpa cache se removido com sucesso
        if (removed) {
            await this.clearCacheForPermission(permissionId);
            // Limpa cache das roles afetadas
            const uniqueRoleIds = [...new Set(mappings.map((m) => m.role_id))];
            await Promise.all(uniqueRoleIds.map((roleId) => this.clearCacheForRole(roleId)));
        }
        return removed;
    }
    /**
     * Busca permissões associadas às roles de um usuário.
     *
     * @param userId ID do usuário
     * @returns Lista de permissões associadas às roles do usuário
     */
    async findPermissionsByUserRoles(userId) {
        try {
            // Buscar o usuário com sua role
            const usuario = await this.dataSource.manager.findOne(usuario_entity_1.Usuario, {
                where: { id: userId },
                relations: ['role'],
                cache: {
                    id: `usuario_role_${userId}`,
                    milliseconds: 300000, // 5 minutos
                },
            });
            if (!usuario || !usuario.role) {
                return [];
            }
            // Buscar permissões da role do usuário
            const queryResult = await this.dataSource.manager.query(`
        SELECT DISTINCT p.*
        FROM permissao p
        INNER JOIN role_permissao rp ON p.id = rp.permissao_id
        WHERE rp.role_id = $1
        ORDER BY p.nome
      `, [usuario.role.id]);
            // Converter os resultados brutos para entidades Permission
            return queryResult.map((row) => {
                const permission = new permission_entity_1.Permission();
                permission.id = row.id;
                permission.nome = row.nome;
                permission.descricao = row.descricao;
                permission.created_at = row.created_at;
                permission.updated_at = row.updated_at;
                return permission;
            });
        }
        catch (error) {
            console.error('Erro ao buscar permissões do usuário:', error);
            return [];
        }
    }
    /**
     * Busca permissões por múltiplas roles
     *
     * @param roleIds IDs das roles
     * @returns Lista de permissões únicas
     */
    async findPermissionsByRoleIds(roleIds) {
        if (roleIds.length === 0)
            return [];
        return this.createQueryBuilder('role_permissao')
            .leftJoinAndSelect('role_permissao.permissao', 'permissao')
            .where('role_permissao.role_id IN (:...roleIds)', { roleIds })
            .cache(`permissions_roles_${roleIds.sort().join('_')}`, 300000)
            .getMany()
            .then((mappings) => {
            const uniquePermissions = new Map();
            mappings.forEach((mapping) => {
                if (mapping.permissao &&
                    !uniquePermissions.has(mapping.permissao.id)) {
                    uniquePermissions.set(mapping.permissao.id, mapping.permissao);
                }
            });
            return Array.from(uniquePermissions.values());
        });
    }
    /**
     * Limpa cache relacionado a uma role
     */
    async clearCacheForRole(roleId) {
        try {
            // Limpa cache usando o query cache do TypeORM
            await this.dataSource.queryResultCache?.remove([
                `role_permissions_${roleId}`,
                `permissions_roles_${roleId}`,
            ]);
        }
        catch (error) {
            // Cache clearing é opcional, não deve quebrar a operação
            console.warn('Erro ao limpar cache da role:', error);
        }
    }
    /**
     * Limpa cache relacionado a uma permissão
     */
    async clearCacheForPermission(permissionId) {
        try {
            // Limpa cache usando o query cache do TypeORM
            await this.dataSource.queryResultCache?.remove([
                `permission_roles_${permissionId}`,
            ]);
        }
        catch (error) {
            // Cache clearing é opcional, não deve quebrar a operação
            console.warn('Erro ao limpar cache da permissão:', error);
        }
    }
};
exports.RolePermissionRepository = RolePermissionRepository;
exports.RolePermissionRepository = RolePermissionRepository = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_1.DataSource !== "undefined" && typeorm_1.DataSource) === "function" ? _a : Object])
], RolePermissionRepository);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xccm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLHFDQUFxRDtBQUNyRCwyQ0FBNEM7QUFDNUMsa0ZBQXVFO0FBQ3ZFLHdFQUE4RDtBQUM5RCxrRUFBd0Q7QUFFeEQ7Ozs7O0dBS0c7QUFFSSxJQUFNLHdCQUF3QixHQUE5QixNQUFNLHdCQUF5QixTQUFRLG9CQUEwQjtJQUNsRDtJQUFwQixZQUFvQixVQUFzQjtRQUN4QyxLQUFLLENBQUMsdUNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBRHRDLGVBQVUsR0FBVixVQUFVLENBQVk7SUFFMUMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFjO1FBQy9CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztZQUNmLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7WUFDMUIsS0FBSyxFQUFFO2dCQUNMLEVBQUUsRUFBRSxpQkFBaUIsTUFBTSxFQUFFO2dCQUM3QixZQUFZLEVBQUUsTUFBTSxFQUFFLFlBQVk7YUFDbkM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQWlCO1FBQ25DLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFcEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2YsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUEsWUFBRSxFQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQy9CLEtBQUssRUFBRTtnQkFDTCxFQUFFLEVBQUUsMEJBQTBCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FB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QzlCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YseURBQXlEO1lBQ3pELE9BQU8sQ0FBQyxJQUFJLENBQUMsK0JBQStCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxZQUFvQjtRQUN4RCxJQUFJLENBQUM7WUFDSCw4Q0FBOEM7WUFDOUMsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQztnQkFDN0Msb0JBQW9CLFlBQVksRUFBRTthQUNuQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLHlEQUF5RDtZQUN6RCxPQUFPLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzVELENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQTVWWSw0REFBd0I7bUNBQXhCLHdCQUF3QjtJQURwQyxJQUFBLG1CQUFVLEdBQUU7eURBRXFCLG9CQUFVLG9CQUFWLG9CQUFVO0dBRC9CLHdCQUF3QixDQTRWcEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXGF1dGhcXHJlcG9zaXRvcmllc1xccm9sZS1wZXJtaXNzaW9uLnJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVwb3NpdG9yeSwgRGF0YVNvdXJjZSwgSW4gfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSb2xlUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3JvbGUtcGVybWlzc2lvbi5lbnRpdHknO1xuaW1wb3J0IHsgUGVybWlzc2lvbiB9IGZyb20gJy4uLy4uL2VudGl0aWVzL3Blcm1pc3Npb24uZW50aXR5JztcbmltcG9ydCB7IFVzdWFyaW8gfSBmcm9tICcuLi8uLi9lbnRpdGllcy91c3VhcmlvLmVudGl0eSc7XG5cbi8qKlxuICogUmVwb3NpdMOzcmlvIHBhcmEgYSBlbnRpZGFkZSBSb2xlUGVybWlzc2lvbi5cbiAqXG4gKiBGb3JuZWNlIG3DqXRvZG9zIHBhcmEgbWFuaXB1bGHDp8OjbyBkZSBtYXBlYW1lbnRvcyBlbnRyZSByb2xlcyBlIHBlcm1pc3PDtWVzIG5vIGJhbmNvIGRlIGRhZG9zLFxuICogaW5jbHVpbmRvIGJ1c2NhIHBvciByb2xlLCBwZXJtaXNzw6NvIGUgb3BlcmHDp8O1ZXMgZGUgQ1JVRC5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJvbGVQZXJtaXNzaW9uUmVwb3NpdG9yeSBleHRlbmRzIFJlcG9zaXRvcnk8Um9sZVBlcm1pc3Npb24+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhU291cmNlOiBEYXRhU291cmNlKSB7XG4gICAgc3VwZXIoUm9sZVBlcm1pc3Npb24sIGRhdGFTb3VyY2UuY3JlYXRlRW50aXR5TWFuYWdlcigpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvcyBwb3IgSUQgZGUgcm9sZSBjb20gY2FjaGUuXG4gICAqXG4gICAqIEBwYXJhbSByb2xlSWQgSUQgZGEgcm9sZVxuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBtYXBlYW1lbnRvcyBlbmNvbnRyYWRvc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5Um9sZUlkKHJvbGVJZDogc3RyaW5nKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZCh7XG4gICAgICB3aGVyZTogeyByb2xlX2lkOiByb2xlSWQgfSxcbiAgICAgIGNhY2hlOiB7XG4gICAgICAgIGlkOiBgcm9sZV9tYXBwaW5nc18ke3JvbGVJZH1gLFxuICAgICAgICBtaWxsaXNlY29uZHM6IDMwMDAwMCwgLy8gNSBtaW51dG9zXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIG1hcGVhbWVudG9zIHBvciBtw7psdGlwbG9zIElEcyBkZSByb2xlLlxuICAgKlxuICAgKiBAcGFyYW0gcm9sZUlkcyBJRHMgZGFzIHJvbGVzXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIG1hcGVhbWVudG9zIGVuY29udHJhZG9zXG4gICAqL1xuICBhc3luYyBmaW5kQnlSb2xlSWRzKHJvbGVJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbltdPiB7XG4gICAgaWYgKHJvbGVJZHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cbiAgICByZXR1cm4gdGhpcy5maW5kKHtcbiAgICAgIHdoZXJlOiB7IHJvbGVfaWQ6IEluKHJvbGVJZHMpIH0sXG4gICAgICBjYWNoZToge1xuICAgICAgICBpZDogYHJvbGVfbWFwcGluZ3NfbXVsdGlwbGVfJHtyb2xlSWRzLnNvcnQoKS5qb2luKCdfJyl9YCxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvcyBwb3IgSUQgZGUgcGVybWlzc8OjbyBjb20gY2FjaGUuXG4gICAqXG4gICAqIEBwYXJhbSBwZXJtaXNzaW9uSWQgSUQgZGEgcGVybWlzc8Ojb1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBtYXBlYW1lbnRvcyBlbmNvbnRyYWRvc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5UGVybWlzc2lvbklkKHBlcm1pc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZCh7XG4gICAgICB3aGVyZTogeyBwZXJtaXNzYW9faWQ6IHBlcm1pc3Npb25JZCB9LFxuICAgICAgY2FjaGU6IHtcbiAgICAgICAgaWQ6IGBwZXJtaXNzaW9uX21hcHBpbmdzXyR7cGVybWlzc2lvbklkfWAsXG4gICAgICAgIG1pbGxpc2Vjb25kczogMzAwMDAwLCAvLyA1IG1pbnV0b3NcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgbWFwZWFtZW50byBwb3IgSUQgZGUgcm9sZSBlIElEIGRlIHBlcm1pc3PDo28uXG4gICAqXG4gICAqIEBwYXJhbSByb2xlSWQgSUQgZGEgcm9sZVxuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgTyBtYXBlYW1lbnRvIGVuY29udHJhZG8gb3UgbnVsbFxuICAgKi9cbiAgYXN5bmMgZmluZEJ5Um9sZUFuZFBlcm1pc3Npb24oXG4gICAgcm9sZUlkOiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Um9sZVBlcm1pc3Npb24gfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyByb2xlX2lkOiByb2xlSWQsIHBlcm1pc3Nhb19pZDogcGVybWlzc2lvbklkIH0sXG4gICAgICBjYWNoZToge1xuICAgICAgICBpZDogYHJvbGVfcGVybWlzc2lvbl8ke3JvbGVJZH1fJHtwZXJtaXNzaW9uSWR9YCxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBtYXBlYW1lbnRvcyBwb3IgSUQgZGUgcm9sZSBjb20gcGVybWlzc8O1ZXMgcmVsYWNpb25hZGFzLlxuICAgKlxuICAgKiBAcGFyYW0gcm9sZUlkIElEIGRhIHJvbGVcbiAgICogQHJldHVybnMgTGlzdGEgZGUgbWFwZWFtZW50b3MgZW5jb250cmFkb3MgY29tIHBlcm1pc3PDtWVzIHJlbGFjaW9uYWRhc1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5Um9sZUlkV2l0aFBlcm1pc3Npb25zKHJvbGVJZDogc3RyaW5nKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUXVlcnlCdWlsZGVyKCdyb2xlX3Blcm1pc3NhbycpXG4gICAgICAubGVmdEpvaW5BbmRTZWxlY3QoJ3JvbGVfcGVybWlzc2FvLnBlcm1pc3NhbycsICdwZXJtaXNzYW8nKVxuICAgICAgLndoZXJlKCdyb2xlX3Blcm1pc3Nhby5yb2xlX2lkID0gOnJvbGVJZCcsIHsgcm9sZUlkIH0pXG4gICAgICAuY2FjaGUoYHJvbGVfcGVybWlzc2lvbnNfZGV0YWlsZWRfJHtyb2xlSWR9YCwgMzAwMDAwKVxuICAgICAgLmdldE1hbnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIHVtIG5vdm8gbWFwZWFtZW50byBlbnRyZSByb2xlIGUgcGVybWlzc8Ojby5cbiAgICpcbiAgICogQHBhcmFtIGRhdGEgRGFkb3MgZG8gbWFwZWFtZW50byBhIHNlciBjcmlhZG9cbiAgICogQHJldHVybnMgTyBtYXBlYW1lbnRvIGNyaWFkb1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlTWFwcGluZyhkYXRhOiBQYXJ0aWFsPFJvbGVQZXJtaXNzaW9uPik6IFByb21pc2U8Um9sZVBlcm1pc3Npb24+IHtcbiAgICAvLyBWZXJpZmljYSBzZSBqw6EgZXhpc3RlIG8gbWFwZWFtZW50b1xuICAgIGlmIChkYXRhLnJvbGVfaWQgJiYgZGF0YS5wZXJtaXNzYW9faWQpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5maW5kQnlSb2xlQW5kUGVybWlzc2lvbihcbiAgICAgICAgZGF0YS5yb2xlX2lkLFxuICAgICAgICBkYXRhLnBlcm1pc3Nhb19pZCxcbiAgICAgICk7XG4gICAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG1hcHBpbmcgPSB0aGlzLmNyZWF0ZShkYXRhKTtcbiAgICBjb25zdCBzYXZlZCA9IGF3YWl0IHRoaXMuc2F2ZShtYXBwaW5nKTtcblxuICAgIC8vIExpbXBhIGNhY2hlIHJlbGFjaW9uYWRvXG4gICAgaWYgKGRhdGEucm9sZV9pZCkge1xuICAgICAgYXdhaXQgdGhpcy5jbGVhckNhY2hlRm9yUm9sZShkYXRhLnJvbGVfaWQpO1xuICAgIH1cbiAgICBpZiAoZGF0YS5wZXJtaXNzYW9faWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xlYXJDYWNoZUZvclBlcm1pc3Npb24oZGF0YS5wZXJtaXNzYW9faWQpO1xuICAgIH1cblxuICAgIHJldHVybiBzYXZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmlhIG3Dumx0aXBsb3MgbWFwZWFtZW50b3MgZW0gYmF0Y2hcbiAgICpcbiAgICogQHBhcmFtIG1hcHBpbmdzIExpc3RhIGRlIG1hcGVhbWVudG9zIGEgc2VyZW0gY3JpYWRvc1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBtYXBlYW1lbnRvcyBjcmlhZG9zXG4gICAqL1xuICBhc3luYyBjcmVhdGVNdWx0aXBsZU1hcHBpbmdzKFxuICAgIG1hcHBpbmdzOiBQYXJ0aWFsPFJvbGVQZXJtaXNzaW9uPltdLFxuICApOiBQcm9taXNlPFJvbGVQZXJtaXNzaW9uW10+IHtcbiAgICBpZiAobWFwcGluZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cbiAgICBjb25zdCBlbnRpdGllcyA9IG1hcHBpbmdzLm1hcCgobWFwcGluZykgPT4gdGhpcy5jcmVhdGUobWFwcGluZykpO1xuICAgIGNvbnN0IHNhdmVkID0gYXdhaXQgdGhpcy5zYXZlKGVudGl0aWVzKTtcblxuICAgIC8vIExpbXBhIGNhY2hlIHBhcmEgdG9kYXMgYXMgcm9sZXMgZSBwZXJtaXNzw7VlcyBhZmV0YWRhc1xuICAgIGNvbnN0IHVuaXF1ZVJvbGVJZHMgPSBbXG4gICAgICAuLi5uZXcgU2V0KG1hcHBpbmdzLm1hcCgobSkgPT4gbS5yb2xlX2lkKS5maWx0ZXIoQm9vbGVhbikpLFxuICAgIF07XG4gICAgY29uc3QgdW5pcXVlUGVybWlzc2lvbklkcyA9IFtcbiAgICAgIC4uLm5ldyBTZXQobWFwcGluZ3MubWFwKChtKSA9PiBtLnBlcm1pc3Nhb19pZCkuZmlsdGVyKEJvb2xlYW4pKSxcbiAgICBdO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgLi4udW5pcXVlUm9sZUlkcy5tYXAoKHJvbGVJZCkgPT4gdGhpcy5jbGVhckNhY2hlRm9yUm9sZShyb2xlSWQhKSksXG4gICAgICAuLi51bmlxdWVQZXJtaXNzaW9uSWRzLm1hcCgocGVybWlzc2lvbklkKSA9PlxuICAgICAgICB0aGlzLmNsZWFyQ2FjaGVGb3JQZXJtaXNzaW9uKHBlcm1pc3Npb25JZCEpLFxuICAgICAgKSxcbiAgICBdKTtcblxuICAgIHJldHVybiBzYXZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdW0gbWFwZWFtZW50byBlbnRyZSByb2xlIGUgcGVybWlzc8Ojby5cbiAgICpcbiAgICogQHBhcmFtIGlkIElEIGRvIG1hcGVhbWVudG8gYSBzZXIgcmVtb3ZpZG9cbiAgICogQHJldHVybnMgdHJ1ZSBzZSBvIG1hcGVhbWVudG8gZm9pIHJlbW92aWRvLCBmYWxzZSBjYXNvIGNvbnRyw6FyaW9cbiAgICovXG4gIGFzeW5jIHJlbW92ZU1hcHBpbmcoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIEJ1c2NhIG8gbWFwZWFtZW50byBhbnRlcyBkZSByZW1vdmVyIHBhcmEgbGltcGFyIGNhY2hlXG4gICAgY29uc3QgbWFwcGluZyA9IGF3YWl0IHRoaXMuZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRlbGV0ZShpZCk7XG4gICAgY29uc3QgcmVtb3ZlZCA9XG4gICAgICByZXN1bHQuYWZmZWN0ZWQgIT09IG51bGwgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gdW5kZWZpbmVkICYmXG4gICAgICByZXN1bHQuYWZmZWN0ZWQgPiAwO1xuXG4gICAgLy8gTGltcGEgY2FjaGUgc2UgcmVtb3ZpZG8gY29tIHN1Y2Vzc29cbiAgICBpZiAocmVtb3ZlZCAmJiBtYXBwaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKG1hcHBpbmcucm9sZV9pZCk7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JQZXJtaXNzaW9uKG1hcHBpbmcucGVybWlzc2FvX2lkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVtb3ZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdG9kb3Mgb3MgbWFwZWFtZW50b3MgZGUgdW1hIHJvbGUuXG4gICAqXG4gICAqIEBwYXJhbSByb2xlSWQgSUQgZGEgcm9sZVxuICAgKiBAcmV0dXJucyB0cnVlIHNlIG9zIG1hcGVhbWVudG9zIGZvcmFtIHJlbW92aWRvcywgZmFsc2UgY2FzbyBjb250csOhcmlvXG4gICAqL1xuICBhc3luYyByZW1vdmVNYXBwaW5nc0J5Um9sZUlkKHJvbGVJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQnVzY2Egb3MgbWFwZWFtZW50b3MgYW50ZXMgZGUgcmVtb3ZlciBwYXJhIGxpbXBhciBjYWNoZSBkYXMgcGVybWlzc8O1ZXNcbiAgICBjb25zdCBtYXBwaW5ncyA9IGF3YWl0IHRoaXMuZmluZEJ5Um9sZUlkKHJvbGVJZCk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRlbGV0ZSh7IHJvbGVfaWQ6IHJvbGVJZCB9KTtcbiAgICBjb25zdCByZW1vdmVkID1cbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gbnVsbCAmJlxuICAgICAgcmVzdWx0LmFmZmVjdGVkICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCA+IDA7XG5cbiAgICAvLyBMaW1wYSBjYWNoZSBzZSByZW1vdmlkbyBjb20gc3VjZXNzb1xuICAgIGlmIChyZW1vdmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKHJvbGVJZCk7XG4gICAgICAvLyBMaW1wYSBjYWNoZSBkYXMgcGVybWlzc8O1ZXMgYWZldGFkYXNcbiAgICAgIGNvbnN0IHVuaXF1ZVBlcm1pc3Npb25JZHMgPSBbXG4gICAgICAgIC4uLm5ldyBTZXQobWFwcGluZ3MubWFwKChtKSA9PiBtLnBlcm1pc3Nhb19pZCkpLFxuICAgICAgXTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICB1bmlxdWVQZXJtaXNzaW9uSWRzLm1hcCgocGVybWlzc2lvbklkKSA9PlxuICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZUZvclBlcm1pc3Npb24ocGVybWlzc2lvbklkKSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlbW92ZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHRvZG9zIG9zIG1hcGVhbWVudG9zIGRlIHVtYSBwZXJtaXNzw6NvLlxuICAgKlxuICAgKiBAcGFyYW0gcGVybWlzc2lvbklkIElEIGRhIHBlcm1pc3PDo29cbiAgICogQHJldHVybnMgdHJ1ZSBzZSBvcyBtYXBlYW1lbnRvcyBmb3JhbSByZW1vdmlkb3MsIGZhbHNlIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgYXN5bmMgcmVtb3ZlTWFwcGluZ3NCeVBlcm1pc3Npb25JZChwZXJtaXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIEJ1c2NhIG9zIG1hcGVhbWVudG9zIGFudGVzIGRlIHJlbW92ZXIgcGFyYSBsaW1wYXIgY2FjaGUgZGFzIHJvbGVzXG4gICAgY29uc3QgbWFwcGluZ3MgPSBhd2FpdCB0aGlzLmZpbmRCeVBlcm1pc3Npb25JZChwZXJtaXNzaW9uSWQpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kZWxldGUoeyBwZXJtaXNzYW9faWQ6IHBlcm1pc3Npb25JZCB9KTtcbiAgICBjb25zdCByZW1vdmVkID1cbiAgICAgIHJlc3VsdC5hZmZlY3RlZCAhPT0gbnVsbCAmJlxuICAgICAgcmVzdWx0LmFmZmVjdGVkICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIHJlc3VsdC5hZmZlY3RlZCA+IDA7XG5cbiAgICAvLyBMaW1wYSBjYWNoZSBzZSByZW1vdmlkbyBjb20gc3VjZXNzb1xuICAgIGlmIChyZW1vdmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmNsZWFyQ2FjaGVGb3JQZXJtaXNzaW9uKHBlcm1pc3Npb25JZCk7XG4gICAgICAvLyBMaW1wYSBjYWNoZSBkYXMgcm9sZXMgYWZldGFkYXNcbiAgICAgIGNvbnN0IHVuaXF1ZVJvbGVJZHMgPSBbLi4ubmV3IFNldChtYXBwaW5ncy5tYXAoKG0pID0+IG0ucm9sZV9pZCkpXTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICB1bmlxdWVSb2xlSWRzLm1hcCgocm9sZUlkKSA9PiB0aGlzLmNsZWFyQ2FjaGVGb3JSb2xlKHJvbGVJZCkpLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVtb3ZlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBwZXJtaXNzw7VlcyBhc3NvY2lhZGFzIMOgcyByb2xlcyBkZSB1bSB1c3XDoXJpby5cbiAgICpcbiAgICogQHBhcmFtIHVzZXJJZCBJRCBkbyB1c3XDoXJpb1xuICAgKiBAcmV0dXJucyBMaXN0YSBkZSBwZXJtaXNzw7VlcyBhc3NvY2lhZGFzIMOgcyByb2xlcyBkbyB1c3XDoXJpb1xuICAgKi9cbiAgYXN5bmMgZmluZFBlcm1pc3Npb25zQnlVc2VyUm9sZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFBlcm1pc3Npb25bXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBCdXNjYXIgbyB1c3XDoXJpbyBjb20gc3VhIHJvbGVcbiAgICAgIGNvbnN0IHVzdWFyaW8gPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UubWFuYWdlci5maW5kT25lKFVzdWFyaW8sIHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgICByZWxhdGlvbnM6IFsncm9sZSddLFxuICAgICAgICBjYWNoZToge1xuICAgICAgICAgIGlkOiBgdXN1YXJpb19yb2xlXyR7dXNlcklkfWAsXG4gICAgICAgICAgbWlsbGlzZWNvbmRzOiAzMDAwMDAsIC8vIDUgbWludXRvc1xuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdXN1YXJpbyB8fCAhdXN1YXJpby5yb2xlKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgLy8gQnVzY2FyIHBlcm1pc3PDtWVzIGRhIHJvbGUgZG8gdXN1w6FyaW9cbiAgICAgIGNvbnN0IHF1ZXJ5UmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLm1hbmFnZXIucXVlcnkoXG4gICAgICAgIGBcbiAgICAgICAgU0VMRUNUIERJU1RJTkNUIHAuKlxuICAgICAgICBGUk9NIHBlcm1pc3NhbyBwXG4gICAgICAgIElOTkVSIEpPSU4gcm9sZV9wZXJtaXNzYW8gcnAgT04gcC5pZCA9IHJwLnBlcm1pc3Nhb19pZFxuICAgICAgICBXSEVSRSBycC5yb2xlX2lkID0gJDFcbiAgICAgICAgT1JERVIgQlkgcC5ub21lXG4gICAgICBgLFxuICAgICAgICBbdXN1YXJpby5yb2xlLmlkXSxcbiAgICAgICk7XG5cbiAgICAgIC8vIENvbnZlcnRlciBvcyByZXN1bHRhZG9zIGJydXRvcyBwYXJhIGVudGlkYWRlcyBQZXJtaXNzaW9uXG4gICAgICByZXR1cm4gcXVlcnlSZXN1bHQubWFwKChyb3cpID0+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbiA9IG5ldyBQZXJtaXNzaW9uKCk7XG4gICAgICAgIHBlcm1pc3Npb24uaWQgPSByb3cuaWQ7XG4gICAgICAgIHBlcm1pc3Npb24ubm9tZSA9IHJvdy5ub21lO1xuICAgICAgICBwZXJtaXNzaW9uLmRlc2NyaWNhbyA9IHJvdy5kZXNjcmljYW87XG4gICAgICAgIHBlcm1pc3Npb24uY3JlYXRlZF9hdCA9IHJvdy5jcmVhdGVkX2F0O1xuICAgICAgICBwZXJtaXNzaW9uLnVwZGF0ZWRfYXQgPSByb3cudXBkYXRlZF9hdDtcbiAgICAgICAgcmV0dXJuIHBlcm1pc3Npb247XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJybyBhbyBidXNjYXIgcGVybWlzc8O1ZXMgZG8gdXN1w6FyaW86JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBwZXJtaXNzw7VlcyBwb3IgbcO6bHRpcGxhcyByb2xlc1xuICAgKlxuICAgKiBAcGFyYW0gcm9sZUlkcyBJRHMgZGFzIHJvbGVzXG4gICAqIEByZXR1cm5zIExpc3RhIGRlIHBlcm1pc3PDtWVzIMO6bmljYXNcbiAgICovXG4gIGFzeW5jIGZpbmRQZXJtaXNzaW9uc0J5Um9sZUlkcyhyb2xlSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8UGVybWlzc2lvbltdPiB7XG4gICAgaWYgKHJvbGVJZHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG5cbiAgICByZXR1cm4gdGhpcy5jcmVhdGVRdWVyeUJ1aWxkZXIoJ3JvbGVfcGVybWlzc2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgncm9sZV9wZXJtaXNzYW8ucGVybWlzc2FvJywgJ3Blcm1pc3NhbycpXG4gICAgICAud2hlcmUoJ3JvbGVfcGVybWlzc2FvLnJvbGVfaWQgSU4gKDouLi5yb2xlSWRzKScsIHsgcm9sZUlkcyB9KVxuICAgICAgLmNhY2hlKGBwZXJtaXNzaW9uc19yb2xlc18ke3JvbGVJZHMuc29ydCgpLmpvaW4oJ18nKX1gLCAzMDAwMDApXG4gICAgICAuZ2V0TWFueSgpXG4gICAgICAudGhlbigobWFwcGluZ3MpID0+IHtcbiAgICAgICAgY29uc3QgdW5pcXVlUGVybWlzc2lvbnMgPSBuZXcgTWFwPHN0cmluZywgUGVybWlzc2lvbj4oKTtcbiAgICAgICAgbWFwcGluZ3MuZm9yRWFjaCgobWFwcGluZykgPT4ge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIG1hcHBpbmcucGVybWlzc2FvICYmXG4gICAgICAgICAgICAhdW5pcXVlUGVybWlzc2lvbnMuaGFzKG1hcHBpbmcucGVybWlzc2FvLmlkKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgdW5pcXVlUGVybWlzc2lvbnMuc2V0KG1hcHBpbmcucGVybWlzc2FvLmlkLCBtYXBwaW5nLnBlcm1pc3Nhbyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20odW5pcXVlUGVybWlzc2lvbnMudmFsdWVzKCkpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTGltcGEgY2FjaGUgcmVsYWNpb25hZG8gYSB1bWEgcm9sZVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjbGVhckNhY2hlRm9yUm9sZShyb2xlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBMaW1wYSBjYWNoZSB1c2FuZG8gbyBxdWVyeSBjYWNoZSBkbyBUeXBlT1JNXG4gICAgICBhd2FpdCB0aGlzLmRhdGFTb3VyY2UucXVlcnlSZXN1bHRDYWNoZT8ucmVtb3ZlKFtcbiAgICAgICAgYHJvbGVfcGVybWlzc2lvbnNfJHtyb2xlSWR9YCxcbiAgICAgICAgYHBlcm1pc3Npb25zX3JvbGVzXyR7cm9sZUlkfWAsXG4gICAgICBdKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gQ2FjaGUgY2xlYXJpbmcgw6kgb3BjaW9uYWwsIG7Do28gZGV2ZSBxdWVicmFyIGEgb3BlcmHDp8Ojb1xuICAgICAgY29uc29sZS53YXJuKCdFcnJvIGFvIGxpbXBhciBjYWNoZSBkYSByb2xlOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGltcGEgY2FjaGUgcmVsYWNpb25hZG8gYSB1bWEgcGVybWlzc8Ojb1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjbGVhckNhY2hlRm9yUGVybWlzc2lvbihwZXJtaXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBMaW1wYSBjYWNoZSB1c2FuZG8gbyBxdWVyeSBjYWNoZSBkbyBUeXBlT1JNXG4gICAgICBhd2FpdCB0aGlzLmRhdGFTb3VyY2UucXVlcnlSZXN1bHRDYWNoZT8ucmVtb3ZlKFtcbiAgICAgICAgYHBlcm1pc3Npb25fcm9sZXNfJHtwZXJtaXNzaW9uSWR9YCxcbiAgICAgIF0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBDYWNoZSBjbGVhcmluZyDDqSBvcGNpb25hbCwgbsOjbyBkZXZlIHF1ZWJyYXIgYSBvcGVyYcOnw6NvXG4gICAgICBjb25zb2xlLndhcm4oJ0Vycm8gYW8gbGltcGFyIGNhY2hlIGRhIHBlcm1pc3PDo286JywgZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9