c59eaf38529bb780c328a028185d0e20
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const axios_1 = require("@nestjs/axios");
const config_1 = require("@nestjs/config");
const rxjs_1 = require("rxjs");
const integracao_documento_service_1 = require("../../services/integracao-documento.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para o serviço de integração com o módulo de documentos
 *
 * Verifica o funcionamento correto das operações de armazenamento e
 * recuperação de comprovantes de pagamento.
 *
 * @author Equipe PGBen
 */
describe('IntegracaoDocumentoService', () => {
    let service;
    let httpService;
    let configService;
    // Mock do HttpService
    const mockHttpService = {
        get: jest.fn(),
        post: jest.fn(),
        put: jest.fn(),
        delete: jest.fn(),
    };
    // Mock do ConfigService
    const mockConfigService = {
        get: jest.fn().mockImplementation((key) => {
            if (key === 'documento.apiUrl') {
                return 'http://api-documento.pgben.local';
            }
            if (key === 'documento.apiKey') {
                return 'api-key-mock';
            }
            if (key === 'documento.categoriaComprovante') {
                return 'COMPROVANTE_PAGAMENTO';
            }
            return null;
        }),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                integracao_documento_service_1.IntegracaoDocumentoService,
                {
                    provide: axios_1.HttpService,
                    useValue: mockHttpService,
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        service = module.get(integracao_documento_service_1.IntegracaoDocumentoService);
        httpService = module.get(axios_1.HttpService);
        configService = module.get(config_1.ConfigService);
        // Limpar mocks antes de cada teste
        jest.clearAllMocks();
    });
    describe('uploadComprovante', () => {
        const pagamentoId = 'pagamento-id';
        const usuarioId = 'usuario-id';
        const arquivo = {
            originalname: 'comprovante.pdf',
            mimetype: 'application/pdf',
            buffer: Buffer.from('conteúdo do arquivo'),
            size: 1024,
        };
        const mockResposta = {
            id: 'documento-id',
            nome: 'comprovante.pdf',
            tamanho: 1024,
            tipo: 'application/pdf',
            categoria: 'COMPROVANTE_PAGAMENTO',
            referencia: pagamentoId,
            url: 'http://api-documento.pgben.local/documentos/documento-id',
            createdAt: '2023-01-01T00:00:00Z',
        };
        it('deve fazer upload de comprovante com sucesso', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockResposta,
                status: 201,
                statusText: 'Created',
                headers: {},
                config: { headers: {} },
            };
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.uploadComprovante(pagamentoId, arquivo, usuarioId);
            // Verificar resultado
            expect(result).toEqual(mockResposta);
            expect(mockHttpService.post).toHaveBeenCalledWith('http://api-documento.pgben.local/documentos', expect.any(FormData), expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                    'Content-Type': expect.stringContaining('multipart/form-data'),
                }),
            }));
        });
        it('deve propagar erros HTTP durante o upload', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.post.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 500,
                    data: { message: 'Erro interno do servidor' },
                },
            })));
            // Executar e verificar exceção
            await expect(service.uploadComprovante(pagamentoId, arquivo, usuarioId)).rejects.toThrow();
        });
    });
    describe('obterComprovante', () => {
        const documentoId = 'documento-id';
        const mockDocumento = {
            id: documentoId,
            nome: 'comprovante.pdf',
            tamanho: 1024,
            tipo: 'application/pdf',
            categoria: 'COMPROVANTE_PAGAMENTO',
            referencia: 'pagamento-id',
            url: 'http://api-documento.pgben.local/documentos/documento-id',
            createdAt: '2023-01-01T00:00:00Z',
        };
        it('deve obter documento quando encontrado', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockDocumento,
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.obterComprovante(documentoId);
            // Verificar resultado
            expect(result).toEqual(mockDocumento);
            expect(mockHttpService.get).toHaveBeenCalledWith(`http://api-documento.pgben.local/documentos/${documentoId}`, expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                }),
            }));
        });
        it('deve lançar NotFoundException quando documento não encontrado', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.get.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 404,
                    data: { message: 'Documento não encontrado' },
                },
            })));
            // Executar e verificar exceção
            await expect(service.obterComprovante(documentoId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('listarComprovantes', () => {
        const pagamentoId = 'pagamento-id';
        const mockComprovantes = [
            {
                id: 'documento-1',
                nome: 'comprovante1.pdf',
                tamanho: 1024,
                tipo: 'application/pdf',
                categoria: 'COMPROVANTE_PAGAMENTO',
                referencia: pagamentoId,
                url: 'http://api-documento.pgben.local/documentos/documento-1',
                createdAt: '2023-01-01T00:00:00Z',
            },
            {
                id: 'documento-2',
                nome: 'comprovante2.pdf',
                tamanho: 2048,
                tipo: 'application/pdf',
                categoria: 'COMPROVANTE_PAGAMENTO',
                referencia: pagamentoId,
                url: 'http://api-documento.pgben.local/documentos/documento-2',
                createdAt: '2023-01-02T00:00:00Z',
            },
        ];
        it('deve listar comprovantes quando encontrados', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: mockComprovantes,
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.listarComprovantes(pagamentoId);
            // Verificar resultado
            expect(result).toEqual(mockComprovantes);
            expect(mockHttpService.get).toHaveBeenCalledWith(expect.stringContaining(`referencia=${pagamentoId}`), expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                }),
            }));
        });
        it('deve retornar array vazio quando não há comprovantes', async () => {
            // Configurar mock da resposta HTTP com array vazio
            const axiosResponse = {
                data: [],
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            mockHttpService.get.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            const result = await service.listarComprovantes(pagamentoId);
            // Verificar resultado
            expect(result).toEqual([]);
        });
    });
    describe('removerComprovante', () => {
        const documentoId = 'documento-id';
        const usuarioId = 'usuario-id';
        it('deve remover comprovante com sucesso', async () => {
            // Configurar mock da resposta HTTP
            const axiosResponse = {
                data: { success: true },
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            mockHttpService.delete.mockReturnValue((0, rxjs_1.of)(axiosResponse));
            // Executar método
            await service.removerComprovante(documentoId, usuarioId);
            // Verificar resultado
            expect(mockHttpService.delete).toHaveBeenCalledWith(`http://api-documento.pgben.local/documentos/${documentoId}`, expect.objectContaining({
                headers: expect.objectContaining({
                    'x-api-key': 'api-key-mock',
                    'x-user-id': usuarioId,
                }),
            }));
        });
        it('deve lançar NotFoundException quando documento não encontrado', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.delete.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 404,
                    data: { message: 'Documento não encontrado' },
                },
            })));
            // Executar e verificar exceção
            await expect(service.removerComprovante(documentoId, usuarioId)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve propagar outros erros HTTP', async () => {
            // Configurar mock do erro HTTP
            mockHttpService.delete.mockReturnValue((0, rxjs_1.throwError)(() => ({
                response: {
                    status: 500,
                    data: { message: 'Erro interno do servidor' },
                },
            })));
            // Executar e verificar exceção
            await expect(service.removerComprovante(documentoId, usuarioId)).rejects.toThrow();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHNlcnZpY2VzXFxpbnRlZ3JhY2FvLWRvY3VtZW50by5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQseUNBQTRDO0FBQzVDLDJDQUErQztBQUMvQywrQkFBc0M7QUFFdEMsOEZBQXlGO0FBQ3pGLDJDQUFtRDtBQUVuRDs7Ozs7OztHQU9HO0FBQ0gsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLE9BQW1DLENBQUM7SUFDeEMsSUFBSSxXQUF3QixDQUFDO0lBQzdCLElBQUksYUFBNEIsQ0FBQztJQUVqQyxzQkFBc0I7SUFDdEIsTUFBTSxlQUFlLEdBQUc7UUFDdEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZCxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDbEIsQ0FBQztJQUVGLHdCQUF3QjtJQUN4QixNQUFNLGlCQUFpQixHQUFHO1FBQ3hCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN4QyxJQUFJLEdBQUcsS0FBSyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMvQixPQUFPLGtDQUFrQyxDQUFDO1lBQzVDLENBQUM7WUFDRCxJQUFJLEdBQUcsS0FBSyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMvQixPQUFPLGNBQWMsQ0FBQztZQUN4QixDQUFDO1lBQ0QsSUFBSSxHQUFHLEtBQUssZ0NBQWdDLEVBQUUsQ0FBQztnQkFDN0MsT0FBTyx1QkFBdUIsQ0FBQztZQUNqQyxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFD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QUU7b0JBQ1IsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFO2lCQUM5QzthQUNGLENBQUMsQ0FBQyxDQUNKLENBQUM7WUFFRiwrQkFBK0I7WUFDL0IsTUFBTSxNQUFNLENBQ1YsT0FBTyxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FDbkQsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxwYWdhbWVudG9cXHRlc3RzXFxzZXJ2aWNlc1xcaW50ZWdyYWNhby1kb2N1bWVudG8uc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2F4aW9zJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXhpb3NSZXNwb25zZSB9IGZyb20gJ2F4aW9zJztcbmltcG9ydCB7IEludGVncmFjYW9Eb2N1bWVudG9TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvaW50ZWdyYWNhby1kb2N1bWVudG8uc2VydmljZSc7XG5pbXBvcnQgeyBOb3RGb3VuZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcblxuLyoqXG4gKiBUZXN0ZXMgdW5pdMOhcmlvcyBwYXJhIG8gc2VydmnDp28gZGUgaW50ZWdyYcOnw6NvIGNvbSBvIG3Ds2R1bG8gZGUgZG9jdW1lbnRvc1xuICpcbiAqIFZlcmlmaWNhIG8gZnVuY2lvbmFtZW50byBjb3JyZXRvIGRhcyBvcGVyYcOnw7VlcyBkZSBhcm1hemVuYW1lbnRvIGVcbiAqIHJlY3VwZXJhw6fDo28gZGUgY29tcHJvdmFudGVzIGRlIHBhZ2FtZW50by5cbiAqXG4gKiBAYXV0aG9yIEVxdWlwZSBQR0JlblxuICovXG5kZXNjcmliZSgnSW50ZWdyYWNhb0RvY3VtZW50b1NlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBJbnRlZ3JhY2FvRG9jdW1lbnRvU2VydmljZTtcbiAgbGV0IGh0dHBTZXJ2aWNlOiBIdHRwU2VydmljZTtcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2U7XG5cbiAgLy8gTW9jayBkbyBIdHRwU2VydmljZVxuICBjb25zdCBtb2NrSHR0cFNlcnZpY2UgPSB7XG4gICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgcG9zdDogamVzdC5mbigpLFxuICAgIHB1dDogamVzdC5mbigpLFxuICAgIGRlbGV0ZTogamVzdC5mbigpLFxuICB9O1xuXG4gIC8vIE1vY2sgZG8gQ29uZmlnU2VydmljZVxuICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICBnZXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ2RvY3VtZW50by5hcGlVcmwnKSB7XG4gICAgICAgIHJldHVybiAnaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwnO1xuICAgICAgfVxuICAgICAgaWYgKGtleSA9PT0gJ2RvY3VtZW50by5hcGlLZXknKSB7XG4gICAgICAgIHJldHVybiAnYXBpLWtleS1tb2NrJztcbiAgICAgIH1cbiAgICAgIGlmIChrZXkgPT09ICdkb2N1bWVudG8uY2F0ZWdvcmlhQ29tcHJvdmFudGUnKSB7XG4gICAgICAgIHJldHVybiAnQ09NUFJPVkFOVEVfUEFHQU1FTlRPJztcbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0pLFxuICB9O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgSW50ZWdyYWNhb0RvY3VtZW50b1NlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBIdHRwU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0h0dHBTZXJ2aWNlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0NvbmZpZ1NlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PEludGVncmFjYW9Eb2N1bWVudG9TZXJ2aWNlPihcbiAgICAgIEludGVncmFjYW9Eb2N1bWVudG9TZXJ2aWNlLFxuICAgICk7XG4gICAgaHR0cFNlcnZpY2UgPSBtb2R1bGUuZ2V0PEh0dHBTZXJ2aWNlPihIdHRwU2VydmljZSk7XG4gICAgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8Q29uZmlnU2VydmljZT4oQ29uZmlnU2VydmljZSk7XG5cbiAgICAvLyBMaW1wYXIgbW9ja3MgYW50ZXMgZGUgY2FkYSB0ZXN0ZVxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgndXBsb2FkQ29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkJztcbiAgICBjb25zdCB1c3VhcmlvSWQgPSAndXN1YXJpby1pZCc7XG4gICAgY29uc3QgYXJxdWl2byA9IHtcbiAgICAgIG9yaWdpbmFsbmFtZTogJ2NvbXByb3ZhbnRlLnBkZicsXG4gICAgICBtaW1ldHlwZTogJ2FwcGxpY2F0aW9uL3BkZicsXG4gICAgICBidWZmZXI6IEJ1ZmZlci5mcm9tKCdjb250ZcO6ZG8gZG8gYXJxdWl2bycpLFxuICAgICAgc2l6ZTogMTAyNCxcbiAgICB9IGFzIGFueTtcblxuICAgIGNvbnN0IG1vY2tSZXNwb3N0YSA9IHtcbiAgICAgIGlkOiAnZG9jdW1lbnRvLWlkJyxcbiAgICAgIG5vbWU6ICdjb21wcm92YW50ZS5wZGYnLFxuICAgICAgdGFtYW5obzogMTAyNCxcbiAgICAgIHRpcG86ICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICAgY2F0ZWdvcmlhOiAnQ09NUFJPVkFOVEVfUEFHQU1FTlRPJyxcbiAgICAgIHJlZmVyZW5jaWE6IHBhZ2FtZW50b0lkLFxuICAgICAgdXJsOiAnaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcy9kb2N1bWVudG8taWQnLFxuICAgICAgY3JlYXRlZEF0OiAnMjAyMy0wMS0wMVQwMDowMDowMFonLFxuICAgIH07XG5cbiAgICBpdCgnZGV2ZSBmYXplciB1cGxvYWQgZGUgY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUFxuICAgICAgY29uc3QgYXhpb3NSZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogbW9ja1Jlc3Bvc3RhLFxuICAgICAgICBzdGF0dXM6IDIwMSxcbiAgICAgICAgc3RhdHVzVGV4dDogJ0NyZWF0ZWQnLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55LFxuICAgICAgfTtcblxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLnBvc3QubW9ja1JldHVyblZhbHVlKG9mKGF4aW9zUmVzcG9uc2UpKTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS51cGxvYWRDb21wcm92YW50ZShcbiAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICAgIGFycXVpdm8sXG4gICAgICAgIHVzdWFyaW9JZCxcbiAgICAgICk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1Jlc3Bvc3RhKTtcbiAgICAgIGV4cGVjdChtb2NrSHR0cFNlcnZpY2UucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdodHRwOi8vYXBpLWRvY3VtZW50by5wZ2Jlbi5sb2NhbC9kb2N1bWVudG9zJyxcbiAgICAgICAgZXhwZWN0LmFueShGb3JtRGF0YSksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAneC1hcGkta2V5JzogJ2FwaS1rZXktbW9jaycsXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ211bHRpcGFydC9mb3JtLWRhdGEnKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgcHJvcGFnYXIgZXJyb3MgSFRUUCBkdXJhbnRlIG8gdXBsb2FkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRvIGVycm8gSFRUUFxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLnBvc3QubW9ja1JldHVyblZhbHVlKFxuICAgICAgICB0aHJvd0Vycm9yKCgpID0+ICh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHN0YXR1czogNTAwLFxuICAgICAgICAgICAgZGF0YTogeyBtZXNzYWdlOiAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIGUgdmVyaWZpY2FyIGV4Y2XDp8Ojb1xuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBzZXJ2aWNlLnVwbG9hZENvbXByb3ZhbnRlKHBhZ2FtZW50b0lkLCBhcnF1aXZvLCB1c3VhcmlvSWQpLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ29idGVyQ29tcHJvdmFudGUnLCAoKSA9PiB7XG4gICAgY29uc3QgZG9jdW1lbnRvSWQgPSAnZG9jdW1lbnRvLWlkJztcblxuICAgIGNvbnN0IG1vY2tEb2N1bWVudG8gPSB7XG4gICAgICBpZDogZG9jdW1lbnRvSWQsXG4gICAgICBub21lOiAnY29tcHJvdmFudGUucGRmJyxcbiAgICAgIHRhbWFuaG86IDEwMjQsXG4gICAgICB0aXBvOiAnYXBwbGljYXRpb24vcGRmJyxcbiAgICAgIGNhdGVnb3JpYTogJ0NPTVBST1ZBTlRFX1BBR0FNRU5UTycsXG4gICAgICByZWZlcmVuY2lhOiAncGFnYW1lbnRvLWlkJyxcbiAgICAgIHVybDogJ2h0dHA6Ly9hcGktZG9jdW1lbnRvLnBnYmVuLmxvY2FsL2RvY3VtZW50b3MvZG9jdW1lbnRvLWlkJyxcbiAgICAgIGNyZWF0ZWRBdDogJzIwMjMtMDEtMDFUMDA6MDA6MDBaJyxcbiAgICB9O1xuXG4gICAgaXQoJ2RldmUgb2J0ZXIgZG9jdW1lbnRvIHF1YW5kbyBlbmNvbnRyYWRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRhIHJlc3Bvc3RhIEhUVFBcbiAgICAgIGNvbnN0IGF4aW9zUmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSB7XG4gICAgICAgIGRhdGE6IG1vY2tEb2N1bWVudG8sXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55LFxuICAgICAgfTtcblxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLmdldC5tb2NrUmV0dXJuVmFsdWUob2YoYXhpb3NSZXNwb25zZSkpO1xuXG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLm9idGVyQ29tcHJvdmFudGUoZG9jdW1lbnRvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tEb2N1bWVudG8pO1xuICAgICAgZXhwZWN0KG1vY2tIdHRwU2VydmljZS5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBgaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcy8ke2RvY3VtZW50b0lkfWAsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAneC1hcGkta2V5JzogJ2FwaS1rZXktbW9jaycsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgTm90Rm91bmRFeGNlcHRpb24gcXVhbmRvIGRvY3VtZW50byBuw6NvIGVuY29udHJhZG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZG8gZXJybyBIVFRQXG4gICAgICBtb2NrSHR0cFNlcnZpY2UuZ2V0Lm1vY2tSZXR1cm5WYWx1ZShcbiAgICAgICAgdGhyb3dFcnJvcigoKSA9PiAoe1xuICAgICAgICAgIHJlc3BvbnNlOiB7XG4gICAgICAgICAgICBzdGF0dXM6IDQwNCxcbiAgICAgICAgICAgIGRhdGE6IHsgbWVzc2FnZTogJ0RvY3VtZW50byBuw6NvIGVuY29udHJhZG8nIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcblxuICAgICAgLy8gRXhlY3V0YXIgZSB2ZXJpZmljYXIgZXhjZcOnw6NvXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5vYnRlckNvbXByb3ZhbnRlKGRvY3VtZW50b0lkKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdsaXN0YXJDb21wcm92YW50ZXMnLCAoKSA9PiB7XG4gICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWlkJztcblxuICAgIGNvbnN0IG1vY2tDb21wcm92YW50ZXMgPSBbXG4gICAgICB7XG4gICAgICAgIGlkOiAnZG9jdW1lbnRvLTEnLFxuICAgICAgICBub21lOiAnY29tcHJvdmFudGUxLnBkZicsXG4gICAgICAgIHRhbWFuaG86IDEwMjQsXG4gICAgICAgIHRpcG86ICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICAgICBjYXRlZ29yaWE6ICdDT01QUk9WQU5URV9QQUdBTUVOVE8nLFxuICAgICAgICByZWZlcmVuY2lhOiBwYWdhbWVudG9JZCxcbiAgICAgICAgdXJsOiAnaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcy9kb2N1bWVudG8tMScsXG4gICAgICAgIGNyZWF0ZWRBdDogJzIwMjMtMDEtMDFUMDA6MDA6MDBaJyxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGlkOiAnZG9jdW1lbnRvLTInLFxuICAgICAgICBub21lOiAnY29tcHJvdmFudGUyLnBkZicsXG4gICAgICAgIHRhbWFuaG86IDIwNDgsXG4gICAgICAgIHRpcG86ICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICAgICBjYXRlZ29yaWE6ICdDT01QUk9WQU5URV9QQUdBTUVOVE8nLFxuICAgICAgICByZWZlcmVuY2lhOiBwYWdhbWVudG9JZCxcbiAgICAgICAgdXJsOiAnaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcy9kb2N1bWVudG8tMicsXG4gICAgICAgIGNyZWF0ZWRBdDogJzIwMjMtMDEtMDJUMDA6MDA6MDBaJyxcbiAgICAgIH0sXG4gICAgXTtcblxuICAgIGl0KCdkZXZlIGxpc3RhciBjb21wcm92YW50ZXMgcXVhbmRvIGVuY29udHJhZG9zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRhIHJlc3Bvc3RhIEhUVFBcbiAgICAgIGNvbnN0IGF4aW9zUmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSB7XG4gICAgICAgIGRhdGE6IG1vY2tDb21wcm92YW50ZXMsXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55LFxuICAgICAgfTtcblxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLmdldC5tb2NrUmV0dXJuVmFsdWUob2YoYXhpb3NSZXNwb25zZSkpO1xuXG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmxpc3RhckNvbXByb3ZhbnRlcyhwYWdhbWVudG9JZCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciByZXN1bHRhZG9cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja0NvbXByb3ZhbnRlcyk7XG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5zdHJpbmdDb250YWluaW5nKGByZWZlcmVuY2lhPSR7cGFnYW1lbnRvSWR9YCksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAneC1hcGkta2V5JzogJ2FwaS1rZXktbW9jaycsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHJldG9ybmFyIGFycmF5IHZhemlvIHF1YW5kbyBuw6NvIGjDoSBjb21wcm92YW50ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUCBjb20gYXJyYXkgdmF6aW9cbiAgICAgIGNvbnN0IGF4aW9zUmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSB7XG4gICAgICAgIGRhdGE6IFtdLFxuICAgICAgICBzdGF0dXM6IDIwMCxcbiAgICAgICAgc3RhdHVzVGV4dDogJ09LJyxcbiAgICAgICAgaGVhZGVyczoge30sXG4gICAgICAgIGNvbmZpZzogeyBoZWFkZXJzOiB7fSB9IGFzIGFueSxcbiAgICAgIH07XG5cbiAgICAgIG1vY2tIdHRwU2VydmljZS5nZXQubW9ja1JldHVyblZhbHVlKG9mKGF4aW9zUmVzcG9uc2UpKTtcblxuICAgICAgLy8gRXhlY3V0YXIgbcOpdG9kb1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5saXN0YXJDb21wcm92YW50ZXMocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBWZXJpZmljYXIgcmVzdWx0YWRvXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFtdKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JlbW92ZXJDb21wcm92YW50ZScsICgpID0+IHtcbiAgICBjb25zdCBkb2N1bWVudG9JZCA9ICdkb2N1bWVudG8taWQnO1xuICAgIGNvbnN0IHVzdWFyaW9JZCA9ICd1c3VhcmlvLWlkJztcblxuICAgIGl0KCdkZXZlIHJlbW92ZXIgY29tcHJvdmFudGUgY29tIHN1Y2Vzc28nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDb25maWd1cmFyIG1vY2sgZGEgcmVzcG9zdGEgSFRUUFxuICAgICAgY29uc3QgYXhpb3NSZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IHtcbiAgICAgICAgZGF0YTogeyBzdWNjZXNzOiB0cnVlIH0sXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgY29uZmlnOiB7IGhlYWRlcnM6IHt9IH0gYXMgYW55LFxuICAgICAgfTtcblxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLmRlbGV0ZS5tb2NrUmV0dXJuVmFsdWUob2YoYXhpb3NSZXNwb25zZSkpO1xuXG4gICAgICAvLyBFeGVjdXRhciBtw6l0b2RvXG4gICAgICBhd2FpdCBzZXJ2aWNlLnJlbW92ZXJDb21wcm92YW50ZShkb2N1bWVudG9JZCwgdXN1YXJpb0lkKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHJlc3VsdGFkb1xuICAgICAgZXhwZWN0KG1vY2tIdHRwU2VydmljZS5kZWxldGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBgaHR0cDovL2FwaS1kb2N1bWVudG8ucGdiZW4ubG9jYWwvZG9jdW1lbnRvcy8ke2RvY3VtZW50b0lkfWAsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAneC1hcGkta2V5JzogJ2FwaS1rZXktbW9jaycsXG4gICAgICAgICAgICAneC11c2VyLWlkJzogdXN1YXJpb0lkLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSBsYW7Dp2FyIE5vdEZvdW5kRXhjZXB0aW9uIHF1YW5kbyBkb2N1bWVudG8gbsOjbyBlbmNvbnRyYWRvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRvIGVycm8gSFRUUFxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLmRlbGV0ZS5tb2NrUmV0dXJuVmFsdWUoXG4gICAgICAgIHRocm93RXJyb3IoKCkgPT4gKHtcbiAgICAgICAgICByZXNwb25zZToge1xuICAgICAgICAgICAgc3RhdHVzOiA0MDQsXG4gICAgICAgICAgICBkYXRhOiB7IG1lc3NhZ2U6ICdEb2N1bWVudG8gbsOjbyBlbmNvbnRyYWRvJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIEV4ZWN1dGFyIGUgdmVyaWZpY2FyIGV4Y2XDp8Ojb1xuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBzZXJ2aWNlLnJlbW92ZXJDb21wcm92YW50ZShkb2N1bWVudG9JZCwgdXN1YXJpb0lkKSxcbiAgICAgICkucmVqZWN0cy50b1Rocm93KE5vdEZvdW5kRXhjZXB0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIHByb3BhZ2FyIG91dHJvcyBlcnJvcyBIVFRQJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ29uZmlndXJhciBtb2NrIGRvIGVycm8gSFRUUFxuICAgICAgbW9ja0h0dHBTZXJ2aWNlLmRlbGV0ZS5tb2NrUmV0dXJuVmFsdWUoXG4gICAgICAgIHRocm93RXJyb3IoKCkgPT4gKHtcbiAgICAgICAgICByZXNwb25zZToge1xuICAgICAgICAgICAgc3RhdHVzOiA1MDAsXG4gICAgICAgICAgICBkYXRhOiB7IG1lc3NhZ2U6ICdFcnJvIGludGVybm8gZG8gc2Vydmlkb3InIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcblxuICAgICAgLy8gRXhlY3V0YXIgZSB2ZXJpZmljYXIgZXhjZcOnw6NvXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHNlcnZpY2UucmVtb3ZlckNvbXByb3ZhbnRlKGRvY3VtZW50b0lkLCB1c3VhcmlvSWQpLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==