5b5b994c0d0b5ca36fd2b64d27f0076c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const confirmacao_controller_1 = require("../../../controllers/confirmacao.controller");
const confirmacao_service_1 = require("../../../services/confirmacao.service");
const pagamento_service_1 = require("../../../services/pagamento.service");
const common_1 = require("@nestjs/common");
/**
 * Testes unitários para ConfirmacaoController
 *
 * Valida o comportamento dos endpoints de confirmação de recebimento,
 * garantindo que o processo de confirmação pelo beneficiário funcione corretamente.
 *
 * @author Equipe PGBen
 */
describe('ConfirmacaoController', () => {
    let controller;
    let confirmacaoService;
    let pagamentoService;
    // Mock de uma confirmação de recebimento para os testes
    const confirmacaoMock = {
        id: 'confirmacao-id-1',
        pagamentoId: 'pagamento-id-1',
        dataConfirmacao: new Date(),
        metodoCaptacao: 'assinatura_digital',
        recebedorNome: 'Maria Silva',
        recebedorDocumento: '123.456.789-09',
        recebedorVinculo: 'beneficiario',
        observacoes: 'Confirmação realizada pelo próprio beneficiário',
        confirmadoPor: 'usuario-id-1',
    };
    // Mock de um pagamento para os testes
    const pagamentoMock = {
        id: 'pagamento-id-1',
        solicitacaoId: 'solicitacao-id-1',
        status: 'LIBERADO',
        valor: 500,
        beneficiarioId: 'beneficiario-id-1',
    };
    // Mock do request com usuário autenticado
    const mockRequest = {
        user: {
            id: 'usuario-id-1',
            nome: 'Usuário Teste',
            perfil: 'operador',
        },
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            controllers: [confirmacao_controller_1.ConfirmacaoController],
            providers: [
                {
                    provide: confirmacao_service_1.ConfirmacaoService,
                    useValue: {
                        registrarConfirmacao: jest.fn().mockResolvedValue(confirmacaoMock),
                        getConfirmacao: jest.fn().mockResolvedValue(confirmacaoMock),
                    },
                },
                {
                    provide: pagamento_service_1.PagamentoService,
                    useValue: {
                        findOne: jest.fn().mockResolvedValue(pagamentoMock),
                        findOneWithRelations: jest.fn().mockResolvedValue({
                            ...pagamentoMock,
                            confirmacao: null, // Inicialmente sem confirmação
                        }),
                    },
                },
            ],
        }).compile();
        controller = module.get(confirmacao_controller_1.ConfirmacaoController);
        confirmacaoService = module.get(confirmacao_service_1.ConfirmacaoService);
        pagamentoService = module.get(pagamento_service_1.PagamentoService);
    });
    it('deve estar definido', () => {
        expect(controller).toBeDefined();
    });
    describe('registrarConfirmacao', () => {
        it('deve registrar confirmação de recebimento com sucesso', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const confirmacaoDto = {
                metodoCaptacao: 'assinatura_digital',
                recebedorNome: 'Maria Silva',
                recebedorDocumento: '123.456.789-09',
                recebedorVinculo: 'beneficiario',
                observacoes: 'Confirmação realizada pelo próprio beneficiário',
            };
            // Act
            const resultado = await controller.registrarConfirmacao(pagamentoId, confirmacaoDto, mockRequest);
            // Assert
            expect(resultado).toEqual(confirmacaoMock);
            expect(pagamentoService.findOneWithRelations).toHaveBeenCalledWith(pagamentoId);
            expect(confirmacaoService.registrarConfirmacao).toHaveBeenCalledWith(pagamentoId, confirmacaoDto, mockRequest.user.id);
        });
        it('deve verificar se o pagamento existe', async () => {
            // Arrange
            const pagamentoId = 'pagamento-inexistente';
            const confirmacaoDto = {
                metodoCaptacao: 'assinatura_digital',
                recebedorNome: 'Maria Silva',
                recebedorDocumento: '123.456.789-09',
                recebedorVinculo: 'beneficiario',
                observacoes: 'Confirmação realizada pelo próprio beneficiário',
            };
            jest
                .spyOn(pagamentoService, 'findOneWithRelations')
                .mockResolvedValue(null);
            // Act & Assert
            await expect(controller.registrarConfirmacao(pagamentoId, confirmacaoDto, mockRequest)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve verificar se o pagamento já possui confirmação', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            const confirmacaoDto = {
                metodoCaptacao: 'assinatura_digital',
                recebedorNome: 'Maria Silva',
                recebedorDocumento: '123.456.789-09',
                recebedorVinculo: 'beneficiario',
                observacoes: 'Confirmação realizada pelo próprio beneficiário',
            };
            // Simular pagamento que já possui confirmação
            jest.spyOn(pagamentoService, 'findOneWithRelations').mockResolvedValue({
                ...pagamentoMock,
                confirmacao: {
                    id: 'confirmacao-existente',
                },
            });
            // Act & Assert
            await expect(controller.registrarConfirmacao(pagamentoId, confirmacaoDto, mockRequest)).rejects.toThrow();
        });
    });
    describe('getConfirmacao', () => {
        it('deve retornar confirmação pelo ID', async () => {
            // Arrange
            const confirmacaoId = 'confirmacao-id-1';
            // Act
            const resultado = await controller.getConfirmacao(confirmacaoId);
            // Assert
            expect(resultado).toEqual(confirmacaoMock);
            expect(confirmacaoService.getConfirmacao).toHaveBeenCalledWith(confirmacaoId);
        });
        it('deve lançar erro quando confirmação não existe', async () => {
            // Arrange
            const confirmacaoId = 'confirmacao-inexistente';
            jest.spyOn(confirmacaoService, 'getConfirmacao').mockResolvedValue(null);
            // Act & Assert
            await expect(controller.getConfirmacao(confirmacaoId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('getConfirmacaoPorPagamento', () => {
        it('deve retornar confirmação de um pagamento', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            // Simular pagamento com confirmação
            jest.spyOn(pagamentoService, 'findOneWithRelations').mockResolvedValue({
                ...pagamentoMock,
                confirmacao: confirmacaoMock,
            });
            // Act
            const resultado = await controller.getConfirmacaoPorPagamento(pagamentoId);
            // Assert
            expect(resultado).toEqual(confirmacaoMock);
            expect(pagamentoService.findOneWithRelations).toHaveBeenCalledWith(pagamentoId);
        });
        it('deve verificar se o pagamento existe', async () => {
            // Arrange
            const pagamentoId = 'pagamento-inexistente';
            jest
                .spyOn(pagamentoService, 'findOneWithRelations')
                .mockResolvedValue(null);
            // Act & Assert
            await expect(controller.getConfirmacaoPorPagamento(pagamentoId)).rejects.toThrow(common_1.NotFoundException);
        });
        it('deve lançar erro quando pagamento não possui confirmação', async () => {
            // Arrange
            const pagamentoId = 'pagamento-id-1';
            // Simular pagamento sem confirmação
            jest.spyOn(pagamentoService, 'findOneWithRelations').mockResolvedValue({
                ...pagamentoMock,
                confirmacao: null,
            });
            // Act & Assert
            await expect(controller.getConfirmacaoPorPagamento(pagamentoId)).rejects.toThrow(common_1.NotFoundException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHBhZ2FtZW50b1xcdGVzdHNcXHVuaXRcXGNvbnRyb2xsZXJzXFxjb25maXJtYWNhby5jb250cm9sbGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsd0ZBQW9GO0FBQ3BGLCtFQUEyRTtBQUMzRSwyRUFBdUU7QUFDdkUsMkNBQW1EO0FBR25EOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLElBQUksVUFBaUMsQ0FBQztJQUN0QyxJQUFJLGtCQUFzQyxDQUFDO0lBQzNDLElBQUksZ0JBQWtDLENBQUM7SUFFdkMsd0RBQXdEO0lBQ3hELE1BQU0sZUFBZSxHQUFHO1FBQ3RCLEVBQUUsRUFBRSxrQkFBa0I7UUFDdEIsV0FBVyxFQUFFLGdCQUFnQjtRQUM3QixlQUFlLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDM0IsY0FBYyxFQUFFLG9CQUFvQjtRQUNwQyxhQUFhLEVBQUUsYUFBYTtRQUM1QixrQkFBa0IsRUFBRSxnQkFBZ0I7UUFDcEMsZ0JBQWdCLEVBQUUsY0FBYztRQUNoQyxXQUFXLEVBQUUsaURBQWlEO1FBQzlELGFBQWEsRUFBRSxjQUFjO0tBQzlCLENBQUM7SUFFRixzQ0FBc0M7SUFDdEMsTUFBTSxhQUFhLEdBQUc7UUFDcEIsRUFBRSxFQUFFLGdCQUFnQjtRQUNwQixhQUFhLEVBQUUsa0JBQWtCO1FBQ2pDLE1BQU0sRUFBRSxVQUFVO1FBQ2xCLEtBQUssRUFBRSxHQUFHO1FBQ1YsY0FBYyxFQUFFLG1CQUFtQjtLQUNwQyxDQUFDO0lBRUYsMENBQTBDO0lBQzFDLE1BQU0sV0FBVyxHQUFHO1FBQ2xCLElBQUksRUFBRTtZQUNKLEVBQUUsRUFBRSxjQUFjO1lBQ2xCLElBQUksRUFBRSxlQUFlO1lBQ3JCLE1BQU0sRUFBRSxVQUFVO1NBQ25CO0tBQ0YsQ0FBQztJ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QUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLG9CQUFvQixDQUNoRSxXQUFXLENBQ1osQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3BELFVBQVU7WUFDVixNQUFNLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQztZQUU1QyxJQUFJO2lCQUNELEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxzQkFBc0IsQ0FBQztpQkFDL0MsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFM0IsZUFBZTtZQUNmLE1BQU0sTUFBTSxDQUNWLFVBQVUsQ0FBQywwQkFBMEIsQ0FBQyxXQUFXLENBQUMsQ0FDbkQsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLDBCQUFpQixDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMERBQTBELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEUsVUFBVTtZQUNWLE1BQU0sV0FBVyxHQUFHLGdCQUFnQixDQUFDO1lBRXJDLG9DQUFvQztZQUNwQyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLHNCQUFzQixDQUFDLENBQUMsaUJBQWlCLENBQUM7Z0JBQ3JFLEdBQUcsYUFBYTtnQkFDaEIsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxDQUFDO1lBRUgsZUFBZTtZQUNmLE1BQU0sTUFBTSxDQUNWLFVBQVUsQ0FBQywwQkFBMEIsQ0FBQyxXQUFXLENBQUMsQ0FDbkQsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLDBCQUFpQixDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxwYWdhbWVudG9cXHRlc3RzXFx1bml0XFxjb250cm9sbGVyc1xcY29uZmlybWFjYW8uY29udHJvbGxlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQ29uZmlybWFjYW9Db250cm9sbGVyIH0gZnJvbSAnLi4vLi4vLi4vY29udHJvbGxlcnMvY29uZmlybWFjYW8uY29udHJvbGxlcic7XG5pbXBvcnQgeyBDb25maXJtYWNhb1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9jb25maXJtYWNhby5zZXJ2aWNlJztcbmltcG9ydCB7IFBhZ2FtZW50b1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9wYWdhbWVudG8uc2VydmljZSc7XG5pbXBvcnQgeyBOb3RGb3VuZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IENvbmZpcm1hY2FvUmVjZWJpbWVudG9EdG8gfSBmcm9tICcuLi8uLi8uLi9kdG9zL2NvbmZpcm1hY2FvLXJlY2ViaW1lbnRvLmR0byc7XG5cbi8qKlxuICogVGVzdGVzIHVuaXTDoXJpb3MgcGFyYSBDb25maXJtYWNhb0NvbnRyb2xsZXJcbiAqXG4gKiBWYWxpZGEgbyBjb21wb3J0YW1lbnRvIGRvcyBlbmRwb2ludHMgZGUgY29uZmlybWHDp8OjbyBkZSByZWNlYmltZW50byxcbiAqIGdhcmFudGluZG8gcXVlIG8gcHJvY2Vzc28gZGUgY29uZmlybWHDp8OjbyBwZWxvIGJlbmVmaWNpw6FyaW8gZnVuY2lvbmUgY29ycmV0YW1lbnRlLlxuICpcbiAqIEBhdXRob3IgRXF1aXBlIFBHQmVuXG4gKi9cbmRlc2NyaWJlKCdDb25maXJtYWNhb0NvbnRyb2xsZXInLCAoKSA9PiB7XG4gIGxldCBjb250cm9sbGVyOiBDb25maXJtYWNhb0NvbnRyb2xsZXI7XG4gIGxldCBjb25maXJtYWNhb1NlcnZpY2U6IENvbmZpcm1hY2FvU2VydmljZTtcbiAgbGV0IHBhZ2FtZW50b1NlcnZpY2U6IFBhZ2FtZW50b1NlcnZpY2U7XG5cbiAgLy8gTW9jayBkZSB1bWEgY29uZmlybWHDp8OjbyBkZSByZWNlYmltZW50byBwYXJhIG9zIHRlc3Rlc1xuICBjb25zdCBjb25maXJtYWNhb01vY2sgPSB7XG4gICAgaWQ6ICdjb25maXJtYWNhby1pZC0xJyxcbiAgICBwYWdhbWVudG9JZDogJ3BhZ2FtZW50by1pZC0xJyxcbiAgICBkYXRhQ29uZmlybWFjYW86IG5ldyBEYXRlKCksXG4gICAgbWV0b2RvQ2FwdGFjYW86ICdhc3NpbmF0dXJhX2RpZ2l0YWwnLFxuICAgIHJlY2ViZWRvck5vbWU6ICdNYXJpYSBTaWx2YScsXG4gICAgcmVjZWJlZG9yRG9jdW1lbnRvOiAnMTIzLjQ1Ni43ODktMDknLFxuICAgIHJlY2ViZWRvclZpbmN1bG86ICdiZW5lZmljaWFyaW8nLFxuICAgIG9ic2VydmFjb2VzOiAnQ29uZmlybWHDp8OjbyByZWFsaXphZGEgcGVsbyBwcsOzcHJpbyBiZW5lZmljacOhcmlvJyxcbiAgICBjb25maXJtYWRvUG9yOiAndXN1YXJpby1pZC0xJyxcbiAgfTtcblxuICAvLyBNb2NrIGRlIHVtIHBhZ2FtZW50byBwYXJhIG9zIHRlc3Rlc1xuICBjb25zdCBwYWdhbWVudG9Nb2NrID0ge1xuICAgIGlkOiAncGFnYW1lbnRvLWlkLTEnLFxuICAgIHNvbGljaXRhY2FvSWQ6ICdzb2xpY2l0YWNhby1pZC0xJyxcbiAgICBzdGF0dXM6ICdMSUJFUkFETycsXG4gICAgdmFsb3I6IDUwMCxcbiAgICBiZW5lZmljaWFyaW9JZDogJ2JlbmVmaWNpYXJpby1pZC0xJyxcbiAgfTtcblxuICAvLyBNb2NrIGRvIHJlcXVlc3QgY29tIHVzdcOhcmlvIGF1dGVudGljYWRvXG4gIGNvbnN0IG1vY2tSZXF1ZXN0ID0ge1xuICAgIHVzZXI6IHtcbiAgICAgIGlkOiAndXN1YXJpby1pZC0xJyxcbiAgICAgIG5vbWU6ICdVc3XDoXJpbyBUZXN0ZScsXG4gICAgICBwZXJmaWw6ICdvcGVyYWRvcicsXG4gICAgfSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgY29udHJvbGxlcnM6IFtDb25maXJtYWNhb0NvbnRyb2xsZXJdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb25maXJtYWNhb1NlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIHJlZ2lzdHJhckNvbmZpcm1hY2FvOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29uZmlybWFjYW9Nb2NrKSxcbiAgICAgICAgICAgIGdldENvbmZpcm1hY2FvOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoY29uZmlybWFjYW9Nb2NrKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGFnYW1lbnRvU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHBhZ2FtZW50b01vY2spLFxuICAgICAgICAgICAgZmluZE9uZVdpdGhSZWxhdGlvbnM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgICAgICAgIC4uLnBhZ2FtZW50b01vY2ssXG4gICAgICAgICAgICAgIGNvbmZpcm1hY2FvOiBudWxsLCAvLyBJbmljaWFsbWVudGUgc2VtIGNvbmZpcm1hw6fDo29cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGNvbnRyb2xsZXIgPSBtb2R1bGUuZ2V0PENvbmZpcm1hY2FvQ29udHJvbGxlcj4oQ29uZmlybWFjYW9Db250cm9sbGVyKTtcbiAgICBjb25maXJtYWNhb1NlcnZpY2UgPSBtb2R1bGUuZ2V0PENvbmZpcm1hY2FvU2VydmljZT4oQ29uZmlybWFjYW9TZXJ2aWNlKTtcbiAgICBwYWdhbWVudG9TZXJ2aWNlID0gbW9kdWxlLmdldDxQYWdhbWVudG9TZXJ2aWNlPihQYWdhbWVudG9TZXJ2aWNlKTtcbiAgfSk7XG5cbiAgaXQoJ2RldmUgZXN0YXIgZGVmaW5pZG8nLCAoKSA9PiB7XG4gICAgZXhwZWN0KGNvbnRyb2xsZXIpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZWdpc3RyYXJDb25maXJtYWNhbycsICgpID0+IHtcbiAgICBpdCgnZGV2ZSByZWdpc3RyYXIgY29uZmlybWHDp8OjbyBkZSByZWNlYmltZW50byBjb20gc3VjZXNzbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZC0xJztcbiAgICAgIGNvbnN0IGNvbmZpcm1hY2FvRHRvOiBDb25maXJtYWNhb1JlY2ViaW1lbnRvRHRvID0ge1xuICAgICAgICBtZXRvZG9DYXB0YWNhbzogJ2Fzc2luYXR1cmFfZGlnaXRhbCcsXG4gICAgICAgIHJlY2ViZWRvck5vbWU6ICdNYXJpYSBTaWx2YScsXG4gICAgICAgIHJlY2ViZWRvckRvY3VtZW50bzogJzEyMy40NTYuNzg5LTA5JyxcbiAgICAgICAgcmVjZWJlZG9yVmluY3VsbzogJ2JlbmVmaWNpYXJpbycsXG4gICAgICAgIG9ic2VydmFjb2VzOiAnQ29uZmlybWHDp8OjbyByZWFsaXphZGEgcGVsbyBwcsOzcHJpbyBiZW5lZmljacOhcmlvJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIEFjdFxuICAgICAgY29uc3QgcmVzdWx0YWRvID0gYXdhaXQgY29udHJvbGxlci5yZWdpc3RyYXJDb25maXJtYWNhbyhcbiAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICAgIGNvbmZpcm1hY2FvRHRvLFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBhbnksXG4gICAgICApO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoY29uZmlybWFjYW9Nb2NrKTtcbiAgICAgIGV4cGVjdChwYWdhbWVudG9TZXJ2aWNlLmZpbmRPbmVXaXRoUmVsYXRpb25zKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGNvbmZpcm1hY2FvU2VydmljZS5yZWdpc3RyYXJDb25maXJtYWNhbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIHBhZ2FtZW50b0lkLFxuICAgICAgICBjb25maXJtYWNhb0R0byxcbiAgICAgICAgbW9ja1JlcXVlc3QudXNlci5pZCxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGV2ZSB2ZXJpZmljYXIgc2UgbyBwYWdhbWVudG8gZXhpc3RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgcGFnYW1lbnRvSWQgPSAncGFnYW1lbnRvLWluZXhpc3RlbnRlJztcbiAgICAgIGNvbnN0IGNvbmZpcm1hY2FvRHRvOiBDb25maXJtYWNhb1JlY2ViaW1lbnRvRHRvID0ge1xuICAgICAgICBtZXRvZG9DYXB0YWNhbzogJ2Fzc2luYXR1cmFfZGlnaXRhbCcsXG4gICAgICAgIHJlY2ViZWRvck5vbWU6ICdNYXJpYSBTaWx2YScsXG4gICAgICAgIHJlY2ViZWRvckRvY3VtZW50bzogJzEyMy40NTYuNzg5LTA5JyxcbiAgICAgICAgcmVjZWJlZG9yVmluY3VsbzogJ2JlbmVmaWNpYXJpbycsXG4gICAgICAgIG9ic2VydmFjb2VzOiAnQ29uZmlybWHDp8OjbyByZWFsaXphZGEgcGVsbyBwcsOzcHJpbyBiZW5lZmljacOhcmlvJyxcbiAgICAgIH07XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKHBhZ2FtZW50b1NlcnZpY2UsICdmaW5kT25lV2l0aFJlbGF0aW9ucycpXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIucmVnaXN0cmFyQ29uZmlybWFjYW8oXG4gICAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICAgICAgY29uZmlybWFjYW9EdG8sXG4gICAgICAgICAgbW9ja1JlcXVlc3QgYXMgYW55LFxuICAgICAgICApLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgdmVyaWZpY2FyIHNlIG8gcGFnYW1lbnRvIGrDoSBwb3NzdWkgY29uZmlybWHDp8OjbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZC0xJztcbiAgICAgIGNvbnN0IGNvbmZpcm1hY2FvRHRvOiBDb25maXJtYWNhb1JlY2ViaW1lbnRvRHRvID0ge1xuICAgICAgICBtZXRvZG9DYXB0YWNhbzogJ2Fzc2luYXR1cmFfZGlnaXRhbCcsXG4gICAgICAgIHJlY2ViZWRvck5vbWU6ICdNYXJpYSBTaWx2YScsXG4gICAgICAgIHJlY2ViZWRvckRvY3VtZW50bzogJzEyMy40NTYuNzg5LTA5JyxcbiAgICAgICAgcmVjZWJlZG9yVmluY3VsbzogJ2JlbmVmaWNpYXJpbycsXG4gICAgICAgIG9ic2VydmFjb2VzOiAnQ29uZmlybWHDp8OjbyByZWFsaXphZGEgcGVsbyBwcsOzcHJpbyBiZW5lZmljacOhcmlvJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIFNpbXVsYXIgcGFnYW1lbnRvIHF1ZSBqw6EgcG9zc3VpIGNvbmZpcm1hw6fDo29cbiAgICAgIGplc3Quc3B5T24ocGFnYW1lbnRvU2VydmljZSwgJ2ZpbmRPbmVXaXRoUmVsYXRpb25zJykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAuLi5wYWdhbWVudG9Nb2NrLFxuICAgICAgICBjb25maXJtYWNhbzoge1xuICAgICAgICAgIGlkOiAnY29uZmlybWFjYW8tZXhpc3RlbnRlJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci5yZWdpc3RyYXJDb25maXJtYWNhbyhcbiAgICAgICAgICBwYWdhbWVudG9JZCxcbiAgICAgICAgICBjb25maXJtYWNhb0R0byxcbiAgICAgICAgICBtb2NrUmVxdWVzdCBhcyBhbnksXG4gICAgICAgICksXG4gICAgICApLnJlamVjdHMudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0Q29uZmlybWFjYW8nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgY29uZmlybWHDp8OjbyBwZWxvIElEJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQXJyYW5nZVxuICAgICAgY29uc3QgY29uZmlybWFjYW9JZCA9ICdjb25maXJtYWNhby1pZC0xJztcblxuICAgICAgLy8gQWN0XG4gICAgICBjb25zdCByZXN1bHRhZG8gPSBhd2FpdCBjb250cm9sbGVyLmdldENvbmZpcm1hY2FvKGNvbmZpcm1hY2FvSWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoY29uZmlybWFjYW9Nb2NrKTtcbiAgICAgIGV4cGVjdChjb25maXJtYWNhb1NlcnZpY2UuZ2V0Q29uZmlybWFjYW8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBjb25maXJtYWNhb0lkLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZXZlIGxhbsOnYXIgZXJybyBxdWFuZG8gY29uZmlybWHDp8OjbyBuw6NvIGV4aXN0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IGNvbmZpcm1hY2FvSWQgPSAnY29uZmlybWFjYW8taW5leGlzdGVudGUnO1xuXG4gICAgICBqZXN0LnNweU9uKGNvbmZpcm1hY2FvU2VydmljZSwgJ2dldENvbmZpcm1hY2FvJykubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgYXdhaXQgZXhwZWN0KGNvbnRyb2xsZXIuZ2V0Q29uZmlybWFjYW8oY29uZmlybWFjYW9JZCkpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgTm90Rm91bmRFeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0Q29uZmlybWFjYW9Qb3JQYWdhbWVudG8nLCAoKSA9PiB7XG4gICAgaXQoJ2RldmUgcmV0b3JuYXIgY29uZmlybWHDp8OjbyBkZSB1bSBwYWdhbWVudG8nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBBcnJhbmdlXG4gICAgICBjb25zdCBwYWdhbWVudG9JZCA9ICdwYWdhbWVudG8taWQtMSc7XG5cbiAgICAgIC8vIFNpbXVsYXIgcGFnYW1lbnRvIGNvbSBjb25maXJtYcOnw6NvXG4gICAgICBqZXN0LnNweU9uKHBhZ2FtZW50b1NlcnZpY2UsICdmaW5kT25lV2l0aFJlbGF0aW9ucycpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgLi4ucGFnYW1lbnRvTW9jayxcbiAgICAgICAgY29uZmlybWFjYW86IGNvbmZpcm1hY2FvTW9jayxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBY3RcbiAgICAgIGNvbnN0IHJlc3VsdGFkbyA9XG4gICAgICAgIGF3YWl0IGNvbnRyb2xsZXIuZ2V0Q29uZmlybWFjYW9Qb3JQYWdhbWVudG8ocGFnYW1lbnRvSWQpO1xuXG4gICAgICAvLyBBc3NlcnRcbiAgICAgIGV4cGVjdChyZXN1bHRhZG8pLnRvRXF1YWwoY29uZmlybWFjYW9Nb2NrKTtcbiAgICAgIGV4cGVjdChwYWdhbWVudG9TZXJ2aWNlLmZpbmRPbmVXaXRoUmVsYXRpb25zKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgcGFnYW1lbnRvSWQsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgdmVyaWZpY2FyIHNlIG8gcGFnYW1lbnRvIGV4aXN0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pbmV4aXN0ZW50ZSc7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKHBhZ2FtZW50b1NlcnZpY2UsICdmaW5kT25lV2l0aFJlbGF0aW9ucycpXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcblxuICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGNvbnRyb2xsZXIuZ2V0Q29uZmlybWFjYW9Qb3JQYWdhbWVudG8ocGFnYW1lbnRvSWQpLFxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RldmUgbGFuw6dhciBlcnJvIHF1YW5kbyBwYWdhbWVudG8gbsOjbyBwb3NzdWkgY29uZmlybWHDp8OjbycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEFycmFuZ2VcbiAgICAgIGNvbnN0IHBhZ2FtZW50b0lkID0gJ3BhZ2FtZW50by1pZC0xJztcblxuICAgICAgLy8gU2ltdWxhciBwYWdhbWVudG8gc2VtIGNvbmZpcm1hw6fDo29cbiAgICAgIGplc3Quc3B5T24ocGFnYW1lbnRvU2VydmljZSwgJ2ZpbmRPbmVXaXRoUmVsYXRpb25zJykubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAuLi5wYWdhbWVudG9Nb2NrLFxuICAgICAgICBjb25maXJtYWNhbzogbnVsbCxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgY29udHJvbGxlci5nZXRDb25maXJtYWNhb1BvclBhZ2FtZW50byhwYWdhbWVudG9JZCksXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=