acc3d77eccf19e1e5b4a8b422e1d2dcf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var PrazoSolicitacaoService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PrazoSolicitacaoService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const solicitacao_entity_1 = require("../../../entities/solicitacao.entity");
const exceptions_1 = require("../../../shared/exceptions");
const config_1 = require("@nestjs/config");
/**
 * Serviço responsável pelo gerenciamento de prazos das solicitações
 *
 * Este serviço implementa funcionalidades para:
 * - Calcular e definir prazos com base no tipo de solicitação e status
 * - Atualizar prazos quando ocorrerem mudanças de status
 * - Identificar solicitações com prazos vencidos ou próximos do vencimento
 * - Aplicar regras especiais para solicitações com determinação judicial
 */
let PrazoSolicitacaoService = PrazoSolicitacaoService_1 = class PrazoSolicitacaoService {
    solicitacaoRepository;
    configService;
    logger = new common_1.Logger(PrazoSolicitacaoService_1.name);
    configuracaoPrazos;
    constructor(solicitacaoRepository, configService) {
        this.solicitacaoRepository = solicitacaoRepository;
        this.configService = configService;
        // Carregar configuração de prazos padrão
        this.configuracaoPrazos = {
            analise: this.configService.get('PRAZO_ANALISE_DIAS', 7),
            documentos: this.configService.get('PRAZO_DOCUMENTOS_DIAS', 15),
            processamento: this.configService.get('PRAZO_PROCESSAMENTO_DIAS', 5),
            prioridadeJudicial: this.configService.get('FATOR_PRIORIDADE_JUDICIAL', 0.5),
        };
    }
    /**
     * Calcula e define o prazo de análise para uma solicitação
     * @param solicitacaoId ID da solicitação
     * @returns Data do prazo de análise
     */
    async definirPrazoAnalise(solicitacaoId) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new exceptions_1.EntityNotFoundException('Solicitação', solicitacaoId);
        }
        // Calcular prazo com base na configuração
        let prazoEmDias = this.configuracaoPrazos.analise;
        // Aplicar prioridade se for determinação judicial
        if (solicitacao.determinacao_judicial_flag) {
            prazoEmDias = Math.ceil(prazoEmDias * this.configuracaoPrazos.prioridadeJudicial);
            this.logger.log(`Prazo reduzido para determinação judicial: ${prazoEmDias} dias`);
        }
        // Calcular data do prazo
        const dataPrazo = new Date();
        dataPrazo.setDate(dataPrazo.getDate() + prazoEmDias);
        // Atualizar a solicitação
        solicitacao.prazo_analise = dataPrazo;
        await this.solicitacaoRepository.save(solicitacao);
        return dataPrazo;
    }
    /**
     * Calcula e define o prazo para envio de documentos
     * @param solicitacaoId ID da solicitação
     * @returns Data do prazo para documentos
     */
    async definirPrazoDocumentos(solicitacaoId) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new exceptions_1.EntityNotFoundException('Solicitação', solicitacaoId);
        }
        // Calcular prazo com base na configuração
        let prazoEmDias = this.configuracaoPrazos.documentos;
        // Aplicar prioridade se for determinação judicial
        if (solicitacao.determinacao_judicial_flag) {
            prazoEmDias = Math.ceil(prazoEmDias * this.configuracaoPrazos.prioridadeJudicial);
            this.logger.log(`Prazo reduzido para determinação judicial: ${prazoEmDias} dias`);
        }
        // Calcular data do prazo
        const dataPrazo = new Date();
        dataPrazo.setDate(dataPrazo.getDate() + prazoEmDias);
        // Atualizar a solicitação
        solicitacao.prazo_documentos = dataPrazo;
        await this.solicitacaoRepository.save(solicitacao);
        return dataPrazo;
    }
    /**
     * Calcula e define o prazo de processamento
     * @param solicitacaoId ID da solicitação
     * @returns Data do prazo de processamento
     */
    async definirPrazoProcessamento(solicitacaoId) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new exceptions_1.EntityNotFoundException('Solicitação', solicitacaoId);
        }
        // Calcular prazo com base na configuração
        let prazoEmDias = this.configuracaoPrazos.processamento;
        // Aplicar prioridade se for determinação judicial
        if (solicitacao.determinacao_judicial_flag) {
            prazoEmDias = Math.ceil(prazoEmDias * this.configuracaoPrazos.prioridadeJudicial);
            this.logger.log(`Prazo reduzido para determinação judicial: ${prazoEmDias} dias`);
        }
        // Calcular data do prazo
        const dataPrazo = new Date();
        dataPrazo.setDate(dataPrazo.getDate() + prazoEmDias);
        // Atualizar a solicitação
        solicitacao.prazo_processamento = dataPrazo;
        await this.solicitacaoRepository.save(solicitacao);
        return dataPrazo;
    }
    /**
     * Atualiza os prazos da solicitação com base em sua transição de estado
     * @param solicitacaoId ID da solicitação
     * @param novoStatus Novo status da solicitação
     */
    async atualizarPrazosTransicao(solicitacaoId, novoStatus) {
        try {
            // Definir prazos com base no novo status
            switch (novoStatus) {
                case solicitacao_entity_1.StatusSolicitacao.EM_ANALISE:
                    await this.definirPrazoAnalise(solicitacaoId);
                    break;
                case solicitacao_entity_1.StatusSolicitacao.AGUARDANDO_DOCUMENTOS:
                    await this.definirPrazoDocumentos(solicitacaoId);
                    break;
                case solicitacao_entity_1.StatusSolicitacao.EM_PROCESSAMENTO:
                    await this.definirPrazoProcessamento(solicitacaoId);
                    break;
                // Para outros estados, os prazos anteriores são mantidos ou podem ser limpos
                case solicitacao_entity_1.StatusSolicitacao.APROVADA:
                case solicitacao_entity_1.StatusSolicitacao.INDEFERIDA:
                case solicitacao_entity_1.StatusSolicitacao.CANCELADA:
                case solicitacao_entity_1.StatusSolicitacao.CONCLUIDA:
                case solicitacao_entity_1.StatusSolicitacao.ARQUIVADA:
                    // Limpar prazos ativos pois não são mais relevantes
                    await this.limparPrazos(solicitacaoId);
                    break;
            }
        }
        catch (error) {
            this.logger.error(`Erro ao atualizar prazos: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Limpa os prazos ativos de uma solicitação
     * @param solicitacaoId ID da solicitação
     */
    async limparPrazos(solicitacaoId) {
        try {
            const solicitacao = await this.solicitacaoRepository.findOne({
                where: { id: solicitacaoId },
            });
            if (solicitacao) {
                solicitacao.prazo_analise = null;
                solicitacao.prazo_documentos = null;
                solicitacao.prazo_processamento = null;
                await this.solicitacaoRepository.save(solicitacao);
            }
        }
        catch (error) {
            this.logger.error(`Erro ao limpar prazos: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Verifica se os prazos da solicitação estão vencidos
     * @param solicitacaoId ID da solicitação
     * @returns Objeto com informações de vencimento de prazos
     */
    async verificarPrazosVencidos(solicitacaoId) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            throw new exceptions_1.EntityNotFoundException('Solicitação', solicitacaoId);
        }
        const agora = new Date();
        const resultado = {
            analiseVencida: false,
            documentosVencidos: false,
            processamentoVencido: false,
            diasAtraso: 0,
        };
        // Verificar prazo de análise
        if (solicitacao.prazo_analise && agora > solicitacao.prazo_analise) {
            resultado.analiseVencida = true;
            resultado.diasAtraso = Math.floor((agora.getTime() - solicitacao.prazo_analise.getTime()) /
                (1000 * 60 * 60 * 24));
        }
        // Verificar prazo de documentos
        if (solicitacao.prazo_documentos && agora > solicitacao.prazo_documentos) {
            resultado.documentosVencidos = true;
            const diasAtrasoDoc = Math.floor((agora.getTime() - solicitacao.prazo_documentos.getTime()) /
                (1000 * 60 * 60 * 24));
            resultado.diasAtraso = Math.max(resultado.diasAtraso, diasAtrasoDoc);
        }
        // Verificar prazo de processamento
        if (solicitacao.prazo_processamento &&
            agora > solicitacao.prazo_processamento) {
            resultado.processamentoVencido = true;
            const diasAtrasoProc = Math.floor((agora.getTime() - solicitacao.prazo_processamento.getTime()) /
                (1000 * 60 * 60 * 24));
            resultado.diasAtraso = Math.max(resultado.diasAtraso, diasAtrasoProc);
        }
        return resultado;
    }
    /**
     * Encontra solicitações com prazos vencidos
     * @param tiposPrazo Tipos de prazo a serem verificados
     * @returns Lista de solicitações com prazos vencidos
     */
    async listarSolicitacoesComPrazosVencidos(tiposPrazo = [
        'analise',
        'documentos',
        'processamento',
    ]) {
        const agora = new Date();
        const queryBuilder = this.solicitacaoRepository.createQueryBuilder('solicitacao');
        // Construir condições para a consulta
        const condicoesArray = [];
        if (tiposPrazo.includes('analise')) {
            condicoesArray.push('solicitacao.prazo_analise IS NOT NULL AND solicitacao.prazo_analise < :agora');
        }
        if (tiposPrazo.includes('documentos')) {
            condicoesArray.push('solicitacao.prazo_documentos IS NOT NULL AND solicitacao.prazo_documentos < :agora');
        }
        if (tiposPrazo.includes('processamento')) {
            condicoesArray.push('solicitacao.prazo_processamento IS NOT NULL AND solicitacao.prazo_processamento < :agora');
        }
        if (condicoesArray.length === 0) {
            return [];
        }
        // Combinar as condições com OR
        const whereCondition = `(${condicoesArray.join(' OR ')})`;
        // Aplicar a condição WHERE
        queryBuilder.where(whereCondition, { agora });
        // Priorizar determinações judiciais
        queryBuilder.orderBy('solicitacao.determinacao_judicial_flag', 'DESC');
        // Depois ordenar por data de prazo mais antiga
        const leastExpr = 'LEAST(' +
            'COALESCE(solicitacao.prazo_analise, :dataFutura), ' +
            'COALESCE(solicitacao.prazo_documentos, :dataFutura), ' +
            'COALESCE(solicitacao.prazo_processamento, :dataFutura))';
        queryBuilder.addOrderBy(leastExpr, 'ASC');
        queryBuilder.setParameter('dataFutura', new Date('2099-12-31'));
        return queryBuilder.getMany();
    }
};
exports.PrazoSolicitacaoService = PrazoSolicitacaoService;
exports.PrazoSolicitacaoService = PrazoSolicitacaoService = PrazoSolicitacaoService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(solicitacao_entity_1.Solicitacao)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _b : Object])
], PrazoSolicitacaoService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xccHJhem8tc29saWNpdGFjYW8uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFvRDtBQUNwRCw2Q0FBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLDZFQUc4QztBQUM5QywyREFBcUU7QUFDckUsMkNBQStDO0FBWS9DOzs7Ozs7OztHQVFHO0FBRUksSUFBTSx1QkFBdUIsK0JBQTdCLE1BQU0sdUJBQXVCO0lBTWY7SUFDQTtJQU5GLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyx5QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzRCxrQkFBa0IsQ0FBcUI7SUFFL0MsWUFFbUIscUJBQThDLEVBQzlDLGFBQTRCO1FBRDVCLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBeUI7UUFDOUMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFN0MseUNBQXlDO1FBQ3pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRztZQUN4QixPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLFVBQVUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyx1QkFBdUIsRUFBRSxFQUFFLENBQUM7WUFDdkUsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUNuQywwQkFBMEIsRUFDMUIsQ0FBQyxDQUNGO1lBQ0Qsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQ3hDLDJCQUEyQixFQUMzQixHQUFHLENBQ0o7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsYUFBcUI7UUFDN0MsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMs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dUI7SUFEbkMsSUFBQSxtQkFBVSxHQUFFO0lBTVIsV0FBQSxJQUFBLDBCQUFnQixFQUFDLGdDQUFXLENBQUMsQ0FBQTt5REFDVSxvQkFBVSxvQkFBVixvQkFBVSxvREFDbEIsc0JBQWEsb0JBQWIsc0JBQWE7R0FQcEMsdUJBQXVCLENBdVVuQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcc29saWNpdGFjYW9cXHNlcnZpY2VzXFxwcmF6by1zb2xpY2l0YWNhby5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHtcbiAgU29saWNpdGFjYW8sXG4gIFN0YXR1c1NvbGljaXRhY2FvLFxufSBmcm9tICcuLi8uLi8uLi9lbnRpdGllcy9zb2xpY2l0YWNhby5lbnRpdHknO1xuaW1wb3J0IHsgRW50aXR5Tm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvZXhjZXB0aW9ucyc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuXG4vKipcbiAqIEludGVyZmFjZSBwYXJhIGNvbmZpZ3VyYcOnw6NvIGRlIHByYXpvc1xuICovXG5pbnRlcmZhY2UgQ29uZmlndXJhY2FvUHJhem9zIHtcbiAgYW5hbGlzZTogbnVtYmVyOyAvLyBlbSBkaWFzXG4gIGRvY3VtZW50b3M6IG51bWJlcjsgLy8gZW0gZGlhc1xuICBwcm9jZXNzYW1lbnRvOiBudW1iZXI7IC8vIGVtIGRpYXNcbiAgcHJpb3JpZGFkZUp1ZGljaWFsOiBudW1iZXI7IC8vIGZhdG9yIG11bHRpcGxpY2Fkb3IgcGFyYSByZWR1w6fDo28gZGUgcHJhem8gKDAtMSlcbn1cblxuLyoqXG4gKiBTZXJ2acOnbyByZXNwb25zw6F2ZWwgcGVsbyBnZXJlbmNpYW1lbnRvIGRlIHByYXpvcyBkYXMgc29saWNpdGHDp8O1ZXNcbiAqXG4gKiBFc3RlIHNlcnZpw6dvIGltcGxlbWVudGEgZnVuY2lvbmFsaWRhZGVzIHBhcmE6XG4gKiAtIENhbGN1bGFyIGUgZGVmaW5pciBwcmF6b3MgY29tIGJhc2Ugbm8gdGlwbyBkZSBzb2xpY2l0YcOnw6NvIGUgc3RhdHVzXG4gKiAtIEF0dWFsaXphciBwcmF6b3MgcXVhbmRvIG9jb3JyZXJlbSBtdWRhbsOnYXMgZGUgc3RhdHVzXG4gKiAtIElkZW50aWZpY2FyIHNvbGljaXRhw6fDtWVzIGNvbSBwcmF6b3MgdmVuY2lkb3Mgb3UgcHLDs3hpbW9zIGRvIHZlbmNpbWVudG9cbiAqIC0gQXBsaWNhciByZWdyYXMgZXNwZWNpYWlzIHBhcmEgc29saWNpdGHDp8O1ZXMgY29tIGRldGVybWluYcOnw6NvIGp1ZGljaWFsXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcmF6b1NvbGljaXRhY2FvU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihQcmF6b1NvbGljaXRhY2FvU2VydmljZS5uYW1lKTtcbiAgcHJpdmF0ZSBjb25maWd1cmFjYW9QcmF6b3M6IENvbmZpZ3VyYWNhb1ByYXpvcztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShTb2xpY2l0YWNhbylcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNvbGljaXRhY2FvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxTb2xpY2l0YWNhbz4sXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxuICApIHtcbiAgICAvLyBDYXJyZWdhciBjb25maWd1cmHDp8OjbyBkZSBwcmF6b3MgcGFkcsOjb1xuICAgIHRoaXMuY29uZmlndXJhY2FvUHJhem9zID0ge1xuICAgICAgYW5hbGlzZTogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KCdQUkFaT19BTkFMSVNFX0RJQVMnLCA3KSxcbiAgICAgIGRvY3VtZW50b3M6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignUFJBWk9fRE9DVU1FTlRPU19ESUFTJywgMTUpLFxuICAgICAgcHJvY2Vzc2FtZW50bzogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxudW1iZXI+KFxuICAgICAgICAnUFJBWk9fUFJPQ0VTU0FNRU5UT19ESUFTJyxcbiAgICAgICAgNSxcbiAgICAgICksXG4gICAgICBwcmlvcmlkYWRlSnVkaWNpYWw6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPihcbiAgICAgICAgJ0ZBVE9SX1BSSU9SSURBREVfSlVESUNJQUwnLFxuICAgICAgICAwLjUsXG4gICAgICApLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBlIGRlZmluZSBvIHByYXpvIGRlIGFuw6FsaXNlIHBhcmEgdW1hIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcmV0dXJucyBEYXRhIGRvIHByYXpvIGRlIGFuw6FsaXNlXG4gICAqL1xuICBhc3luYyBkZWZpbmlyUHJhem9BbmFsaXNlKHNvbGljaXRhY2FvSWQ6IHN0cmluZyk6IFByb21pc2U8RGF0ZT4ge1xuICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBpZDogc29saWNpdGFjYW9JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzb2xpY2l0YWNhbykge1xuICAgICAgdGhyb3cgbmV3IEVudGl0eU5vdEZvdW5kRXhjZXB0aW9uKCdTb2xpY2l0YcOnw6NvJywgc29saWNpdGFjYW9JZCk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXIgcHJhem8gY29tIGJhc2UgbmEgY29uZmlndXJhw6fDo29cbiAgICBsZXQgcHJhem9FbURpYXMgPSB0aGlzLmNvbmZpZ3VyYWNhb1ByYXpvcy5hbmFsaXNlO1xuXG4gICAgLy8gQXBsaWNhciBwcmlvcmlkYWRlIHNlIGZvciBkZXRlcm1pbmHDp8OjbyBqdWRpY2lhbFxuICAgIGlmIChzb2xpY2l0YWNhby5kZXRlcm1pbmFjYW9fanVkaWNpYWxfZmxhZykge1xuICAgICAgcHJhem9FbURpYXMgPSBNYXRoLmNlaWwoXG4gICAgICAgIHByYXpvRW1EaWFzICogdGhpcy5jb25maWd1cmFjYW9QcmF6b3MucHJpb3JpZGFkZUp1ZGljaWFsLFxuICAgICAgKTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFByYXpvIHJlZHV6aWRvIHBhcmEgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWw6ICR7cHJhem9FbURpYXN9IGRpYXNgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhciBkYXRhIGRvIHByYXpvXG4gICAgY29uc3QgZGF0YVByYXpvID0gbmV3IERhdGUoKTtcbiAgICBkYXRhUHJhem8uc2V0RGF0ZShkYXRhUHJhem8uZ2V0RGF0ZSgpICsgcHJhem9FbURpYXMpO1xuXG4gICAgLy8gQXR1YWxpemFyIGEgc29saWNpdGHDp8Ojb1xuICAgIHNvbGljaXRhY2FvLnByYXpvX2FuYWxpc2UgPSBkYXRhUHJhem87XG4gICAgYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuc2F2ZShzb2xpY2l0YWNhbyk7XG5cbiAgICByZXR1cm4gZGF0YVByYXpvO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGEgZSBkZWZpbmUgbyBwcmF6byBwYXJhIGVudmlvIGRlIGRvY3VtZW50b3NcbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcmV0dXJucyBEYXRhIGRvIHByYXpvIHBhcmEgZG9jdW1lbnRvc1xuICAgKi9cbiAgYXN5bmMgZGVmaW5pclByYXpvRG9jdW1lbnRvcyhzb2xpY2l0YWNhb0lkOiBzdHJpbmcpOiBQcm9taXNlPERhdGU+IHtcbiAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghc29saWNpdGFjYW8pIHtcbiAgICAgIHRocm93IG5ldyBFbnRpdHlOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbycsIHNvbGljaXRhY2FvSWQpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGFyIHByYXpvIGNvbSBiYXNlIG5hIGNvbmZpZ3VyYcOnw6NvXG4gICAgbGV0IHByYXpvRW1EaWFzID0gdGhpcy5jb25maWd1cmFjYW9QcmF6b3MuZG9jdW1lbnRvcztcblxuICAgIC8vIEFwbGljYXIgcHJpb3JpZGFkZSBzZSBmb3IgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICBpZiAoc29saWNpdGFjYW8uZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2ZsYWcpIHtcbiAgICAgIHByYXpvRW1EaWFzID0gTWF0aC5jZWlsKFxuICAgICAgICBwcmF6b0VtRGlhcyAqIHRoaXMuY29uZmlndXJhY2FvUHJhem9zLnByaW9yaWRhZGVKdWRpY2lhbCxcbiAgICAgICk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBQcmF6byByZWR1emlkbyBwYXJhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsOiAke3ByYXpvRW1EaWFzfSBkaWFzYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXIgZGF0YSBkbyBwcmF6b1xuICAgIGNvbnN0IGRhdGFQcmF6byA9IG5ldyBEYXRlKCk7XG4gICAgZGF0YVByYXpvLnNldERhdGUoZGF0YVByYXpvLmdldERhdGUoKSArIHByYXpvRW1EaWFzKTtcblxuICAgIC8vIEF0dWFsaXphciBhIHNvbGljaXRhw6fDo29cbiAgICBzb2xpY2l0YWNhby5wcmF6b19kb2N1bWVudG9zID0gZGF0YVByYXpvO1xuICAgIGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LnNhdmUoc29saWNpdGFjYW8pO1xuXG4gICAgcmV0dXJuIGRhdGFQcmF6bztcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhIGUgZGVmaW5lIG8gcHJhem8gZGUgcHJvY2Vzc2FtZW50b1xuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEByZXR1cm5zIERhdGEgZG8gcHJhem8gZGUgcHJvY2Vzc2FtZW50b1xuICAgKi9cbiAgYXN5bmMgZGVmaW5pclByYXpvUHJvY2Vzc2FtZW50byhzb2xpY2l0YWNhb0lkOiBzdHJpbmcpOiBQcm9taXNlPERhdGU+IHtcbiAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghc29saWNpdGFjYW8pIHtcbiAgICAgIHRocm93IG5ldyBFbnRpdHlOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbycsIHNvbGljaXRhY2FvSWQpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGFyIHByYXpvIGNvbSBiYXNlIG5hIGNvbmZpZ3VyYcOnw6NvXG4gICAgbGV0IHByYXpvRW1EaWFzID0gdGhpcy5jb25maWd1cmFjYW9QcmF6b3MucHJvY2Vzc2FtZW50bztcblxuICAgIC8vIEFwbGljYXIgcHJpb3JpZGFkZSBzZSBmb3IgZGV0ZXJtaW5hw6fDo28ganVkaWNpYWxcbiAgICBpZiAoc29saWNpdGFjYW8uZGV0ZXJtaW5hY2FvX2p1ZGljaWFsX2ZsYWcpIHtcbiAgICAgIHByYXpvRW1EaWFzID0gTWF0aC5jZWlsKFxuICAgICAgICBwcmF6b0VtRGlhcyAqIHRoaXMuY29uZmlndXJhY2FvUHJhem9zLnByaW9yaWRhZGVKdWRpY2lhbCxcbiAgICAgICk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBQcmF6byByZWR1emlkbyBwYXJhIGRldGVybWluYcOnw6NvIGp1ZGljaWFsOiAke3ByYXpvRW1EaWFzfSBkaWFzYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXIgZGF0YSBkbyBwcmF6b1xuICAgIGNvbnN0IGRhdGFQcmF6byA9IG5ldyBEYXRlKCk7XG4gICAgZGF0YVByYXpvLnNldERhdGUoZGF0YVByYXpvLmdldERhdGUoKSArIHByYXpvRW1EaWFzKTtcblxuICAgIC8vIEF0dWFsaXphciBhIHNvbGljaXRhw6fDo29cbiAgICBzb2xpY2l0YWNhby5wcmF6b19wcm9jZXNzYW1lbnRvID0gZGF0YVByYXpvO1xuICAgIGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LnNhdmUoc29saWNpdGFjYW8pO1xuXG4gICAgcmV0dXJuIGRhdGFQcmF6bztcbiAgfVxuXG4gIC8qKlxuICAgKiBBdHVhbGl6YSBvcyBwcmF6b3MgZGEgc29saWNpdGHDp8OjbyBjb20gYmFzZSBlbSBzdWEgdHJhbnNpw6fDo28gZGUgZXN0YWRvXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIG5vdm9TdGF0dXMgTm92byBzdGF0dXMgZGEgc29saWNpdGHDp8Ojb1xuICAgKi9cbiAgYXN5bmMgYXR1YWxpemFyUHJhem9zVHJhbnNpY2FvKFxuICAgIHNvbGljaXRhY2FvSWQ6IHN0cmluZyxcbiAgICBub3ZvU3RhdHVzOiBTdGF0dXNTb2xpY2l0YWNhbyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIERlZmluaXIgcHJhem9zIGNvbSBiYXNlIG5vIG5vdm8gc3RhdHVzXG4gICAgICBzd2l0Y2ggKG5vdm9TdGF0dXMpIHtcbiAgICAgICAgY2FzZSBTdGF0dXNTb2xpY2l0YWNhby5FTV9BTkFMSVNFOlxuICAgICAgICAgIGF3YWl0IHRoaXMuZGVmaW5pclByYXpvQW5hbGlzZShzb2xpY2l0YWNhb0lkKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFN0YXR1c1NvbGljaXRhY2FvLkFHVUFSREFORE9fRE9DVU1FTlRPUzpcbiAgICAgICAgICBhd2FpdCB0aGlzLmRlZmluaXJQcmF6b0RvY3VtZW50b3Moc29saWNpdGFjYW9JZCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBTdGF0dXNTb2xpY2l0YWNhby5FTV9QUk9DRVNTQU1FTlRPOlxuICAgICAgICAgIGF3YWl0IHRoaXMuZGVmaW5pclByYXpvUHJvY2Vzc2FtZW50byhzb2xpY2l0YWNhb0lkKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICAvLyBQYXJhIG91dHJvcyBlc3RhZG9zLCBvcyBwcmF6b3MgYW50ZXJpb3JlcyBzw6NvIG1hbnRpZG9zIG91IHBvZGVtIHNlciBsaW1wb3NcbiAgICAgICAgY2FzZSBTdGF0dXNTb2xpY2l0YWNhby5BUFJPVkFEQTpcbiAgICAgICAgY2FzZSBTdGF0dXNTb2xpY2l0YWNhby5JTkRFRkVSSURBOlxuICAgICAgICBjYXNlIFN0YXR1c1NvbGljaXRhY2FvLkNBTkNFTEFEQTpcbiAgICAgICAgY2FzZSBTdGF0dXNTb2xpY2l0YWNhby5DT05DTFVJREE6XG4gICAgICAgIGNhc2UgU3RhdHVzU29saWNpdGFjYW8uQVJRVUlWQURBOlxuICAgICAgICAgIC8vIExpbXBhciBwcmF6b3MgYXRpdm9zIHBvaXMgbsOjbyBzw6NvIG1haXMgcmVsZXZhbnRlc1xuICAgICAgICAgIGF3YWl0IHRoaXMubGltcGFyUHJhem9zKHNvbGljaXRhY2FvSWQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gYXR1YWxpemFyIHByYXpvczogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMaW1wYSBvcyBwcmF6b3MgYXRpdm9zIGRlIHVtYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgbGltcGFyUHJhem9zKHNvbGljaXRhY2FvSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBpZDogc29saWNpdGFjYW9JZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChzb2xpY2l0YWNhbykge1xuICAgICAgICBzb2xpY2l0YWNhby5wcmF6b19hbmFsaXNlID0gbnVsbDtcbiAgICAgICAgc29saWNpdGFjYW8ucHJhem9fZG9jdW1lbnRvcyA9IG51bGw7XG4gICAgICAgIHNvbGljaXRhY2FvLnByYXpvX3Byb2Nlc3NhbWVudG8gPSBudWxsO1xuICAgICAgICBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5zYXZlKHNvbGljaXRhY2FvKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm8gYW8gbGltcGFyIHByYXpvczogJHtlcnJvci5tZXNzYWdlfWAsIGVycm9yLnN0YWNrKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBvcyBwcmF6b3MgZGEgc29saWNpdGHDp8OjbyBlc3TDo28gdmVuY2lkb3NcbiAgICogQHBhcmFtIHNvbGljaXRhY2FvSWQgSUQgZGEgc29saWNpdGHDp8Ojb1xuICAgKiBAcmV0dXJucyBPYmpldG8gY29tIGluZm9ybWHDp8O1ZXMgZGUgdmVuY2ltZW50byBkZSBwcmF6b3NcbiAgICovXG4gIGFzeW5jIHZlcmlmaWNhclByYXpvc1ZlbmNpZG9zKHNvbGljaXRhY2FvSWQ6IHN0cmluZyk6IFByb21pc2U8e1xuICAgIGFuYWxpc2VWZW5jaWRhOiBib29sZWFuO1xuICAgIGRvY3VtZW50b3NWZW5jaWRvczogYm9vbGVhbjtcbiAgICBwcm9jZXNzYW1lbnRvVmVuY2lkbzogYm9vbGVhbjtcbiAgICBkaWFzQXRyYXNvOiBudW1iZXI7XG4gIH0+IHtcbiAgICBjb25zdCBzb2xpY2l0YWNhbyA9IGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHNvbGljaXRhY2FvSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghc29saWNpdGFjYW8pIHtcbiAgICAgIHRocm93IG5ldyBFbnRpdHlOb3RGb3VuZEV4Y2VwdGlvbignU29saWNpdGHDp8OjbycsIHNvbGljaXRhY2FvSWQpO1xuICAgIH1cblxuICAgIGNvbnN0IGFnb3JhID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCByZXN1bHRhZG8gPSB7XG4gICAgICBhbmFsaXNlVmVuY2lkYTogZmFsc2UsXG4gICAgICBkb2N1bWVudG9zVmVuY2lkb3M6IGZhbHNlLFxuICAgICAgcHJvY2Vzc2FtZW50b1ZlbmNpZG86IGZhbHNlLFxuICAgICAgZGlhc0F0cmFzbzogMCxcbiAgICB9O1xuXG4gICAgLy8gVmVyaWZpY2FyIHByYXpvIGRlIGFuw6FsaXNlXG4gICAgaWYgKHNvbGljaXRhY2FvLnByYXpvX2FuYWxpc2UgJiYgYWdvcmEgPiBzb2xpY2l0YWNhby5wcmF6b19hbmFsaXNlKSB7XG4gICAgICByZXN1bHRhZG8uYW5hbGlzZVZlbmNpZGEgPSB0cnVlO1xuICAgICAgcmVzdWx0YWRvLmRpYXNBdHJhc28gPSBNYXRoLmZsb29yKFxuICAgICAgICAoYWdvcmEuZ2V0VGltZSgpIC0gc29saWNpdGFjYW8ucHJhem9fYW5hbGlzZS5nZXRUaW1lKCkpIC9cbiAgICAgICAgICAoMTAwMCAqIDYwICogNjAgKiAyNCksXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciBwcmF6byBkZSBkb2N1bWVudG9zXG4gICAgaWYgKHNvbGljaXRhY2FvLnByYXpvX2RvY3VtZW50b3MgJiYgYWdvcmEgPiBzb2xpY2l0YWNhby5wcmF6b19kb2N1bWVudG9zKSB7XG4gICAgICByZXN1bHRhZG8uZG9jdW1lbnRvc1ZlbmNpZG9zID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGRpYXNBdHJhc29Eb2MgPSBNYXRoLmZsb29yKFxuICAgICAgICAoYWdvcmEuZ2V0VGltZSgpIC0gc29saWNpdGFjYW8ucHJhem9fZG9jdW1lbnRvcy5nZXRUaW1lKCkpIC9cbiAgICAgICAgICAoMTAwMCAqIDYwICogNjAgKiAyNCksXG4gICAgICApO1xuICAgICAgcmVzdWx0YWRvLmRpYXNBdHJhc28gPSBNYXRoLm1heChyZXN1bHRhZG8uZGlhc0F0cmFzbywgZGlhc0F0cmFzb0RvYyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHByYXpvIGRlIHByb2Nlc3NhbWVudG9cbiAgICBpZiAoXG4gICAgICBzb2xpY2l0YWNhby5wcmF6b19wcm9jZXNzYW1lbnRvICYmXG4gICAgICBhZ29yYSA+IHNvbGljaXRhY2FvLnByYXpvX3Byb2Nlc3NhbWVudG9cbiAgICApIHtcbiAgICAgIHJlc3VsdGFkby5wcm9jZXNzYW1lbnRvVmVuY2lkbyA9IHRydWU7XG4gICAgICBjb25zdCBkaWFzQXRyYXNvUHJvYyA9IE1hdGguZmxvb3IoXG4gICAgICAgIChhZ29yYS5nZXRUaW1lKCkgLSBzb2xpY2l0YWNhby5wcmF6b19wcm9jZXNzYW1lbnRvLmdldFRpbWUoKSkgL1xuICAgICAgICAgICgxMDAwICogNjAgKiA2MCAqIDI0KSxcbiAgICAgICk7XG4gICAgICByZXN1bHRhZG8uZGlhc0F0cmFzbyA9IE1hdGgubWF4KHJlc3VsdGFkby5kaWFzQXRyYXNvLCBkaWFzQXRyYXNvUHJvYyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdGFkbztcbiAgfVxuXG4gIC8qKlxuICAgKiBFbmNvbnRyYSBzb2xpY2l0YcOnw7VlcyBjb20gcHJhem9zIHZlbmNpZG9zXG4gICAqIEBwYXJhbSB0aXBvc1ByYXpvIFRpcG9zIGRlIHByYXpvIGEgc2VyZW0gdmVyaWZpY2Fkb3NcbiAgICogQHJldHVybnMgTGlzdGEgZGUgc29saWNpdGHDp8O1ZXMgY29tIHByYXpvcyB2ZW5jaWRvc1xuICAgKi9cbiAgYXN5bmMgbGlzdGFyU29saWNpdGFjb2VzQ29tUHJhem9zVmVuY2lkb3MoXG4gICAgdGlwb3NQcmF6bzogKCdhbmFsaXNlJyB8ICdkb2N1bWVudG9zJyB8ICdwcm9jZXNzYW1lbnRvJylbXSA9IFtcbiAgICAgICdhbmFsaXNlJyxcbiAgICAgICdkb2N1bWVudG9zJyxcbiAgICAgICdwcm9jZXNzYW1lbnRvJyxcbiAgICBdLFxuICApOiBQcm9taXNlPFNvbGljaXRhY2FvW10+IHtcbiAgICBjb25zdCBhZ29yYSA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID1cbiAgICAgIHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmNyZWF0ZVF1ZXJ5QnVpbGRlcignc29saWNpdGFjYW8nKTtcblxuICAgIC8vIENvbnN0cnVpciBjb25kacOnw7VlcyBwYXJhIGEgY29uc3VsdGFcbiAgICBjb25zdCBjb25kaWNvZXNBcnJheTogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmICh0aXBvc1ByYXpvLmluY2x1ZGVzKCdhbmFsaXNlJykpIHtcbiAgICAgIGNvbmRpY29lc0FycmF5LnB1c2goXG4gICAgICAgICdzb2xpY2l0YWNhby5wcmF6b19hbmFsaXNlIElTIE5PVCBOVUxMIEFORCBzb2xpY2l0YWNhby5wcmF6b19hbmFsaXNlIDwgOmFnb3JhJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRpcG9zUHJhem8uaW5jbHVkZXMoJ2RvY3VtZW50b3MnKSkge1xuICAgICAgY29uZGljb2VzQXJyYXkucHVzaChcbiAgICAgICAgJ3NvbGljaXRhY2FvLnByYXpvX2RvY3VtZW50b3MgSVMgTk9UIE5VTEwgQU5EIHNvbGljaXRhY2FvLnByYXpvX2RvY3VtZW50b3MgPCA6YWdvcmEnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodGlwb3NQcmF6by5pbmNsdWRlcygncHJvY2Vzc2FtZW50bycpKSB7XG4gICAgICBjb25kaWNvZXNBcnJheS5wdXNoKFxuICAgICAgICAnc29saWNpdGFjYW8ucHJhem9fcHJvY2Vzc2FtZW50byBJUyBOT1QgTlVMTCBBTkQgc29saWNpdGFjYW8ucHJhem9fcHJvY2Vzc2FtZW50byA8IDphZ29yYScsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjb25kaWNvZXNBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBDb21iaW5hciBhcyBjb25kacOnw7VlcyBjb20gT1JcbiAgICBjb25zdCB3aGVyZUNvbmRpdGlvbiA9IGAoJHtjb25kaWNvZXNBcnJheS5qb2luKCcgT1IgJyl9KWA7XG5cbiAgICAvLyBBcGxpY2FyIGEgY29uZGnDp8OjbyBXSEVSRVxuICAgIHF1ZXJ5QnVpbGRlci53aGVyZSh3aGVyZUNvbmRpdGlvbiwgeyBhZ29yYSB9KTtcblxuICAgIC8vIFByaW9yaXphciBkZXRlcm1pbmHDp8O1ZXMganVkaWNpYWlzXG4gICAgcXVlcnlCdWlsZGVyLm9yZGVyQnkoJ3NvbGljaXRhY2FvLmRldGVybWluYWNhb19qdWRpY2lhbF9mbGFnJywgJ0RFU0MnKTtcblxuICAgIC8vIERlcG9pcyBvcmRlbmFyIHBvciBkYXRhIGRlIHByYXpvIG1haXMgYW50aWdhXG4gICAgY29uc3QgbGVhc3RFeHByID1cbiAgICAgICdMRUFTVCgnICtcbiAgICAgICdDT0FMRVNDRShzb2xpY2l0YWNhby5wcmF6b19hbmFsaXNlLCA6ZGF0YUZ1dHVyYSksICcgK1xuICAgICAgJ0NPQUxFU0NFKHNvbGljaXRhY2FvLnByYXpvX2RvY3VtZW50b3MsIDpkYXRhRnV0dXJhKSwgJyArXG4gICAgICAnQ09BTEVTQ0Uoc29saWNpdGFjYW8ucHJhem9fcHJvY2Vzc2FtZW50bywgOmRhdGFGdXR1cmEpKSc7XG5cbiAgICBxdWVyeUJ1aWxkZXIuYWRkT3JkZXJCeShsZWFzdEV4cHIsICdBU0MnKTtcbiAgICBxdWVyeUJ1aWxkZXIuc2V0UGFyYW1ldGVyKCdkYXRhRnV0dXJhJywgbmV3IERhdGUoJzIwOTktMTItMzEnKSk7XG5cbiAgICByZXR1cm4gcXVlcnlCdWlsZGVyLmdldE1hbnkoKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9