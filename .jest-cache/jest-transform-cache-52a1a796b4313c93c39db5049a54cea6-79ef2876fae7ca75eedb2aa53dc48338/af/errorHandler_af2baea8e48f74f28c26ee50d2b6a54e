bbb87b19573d36d3a74c74f9c383d240
"use strict";
/**
 * Middleware de tratamento de erros integrado ao catálogo
 *
 * Estende o filtro de exceções existente para suportar
 * o novo sistema de catálogo de erros, mantendo
 * compatibilidade com o sistema atual.
 *
 * @see docs/ADRs/catalogo-erros.md
 */
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var CatalogAwareExceptionFilter_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CatalogAwareExceptionFilter = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const constants_1 = require("../../constants");
const util_1 = require("../../request-context/util");
const base_api_exception_1 = require("../base-api.exception");
const unified_logger_service_1 = require("../../logging/unified-logger.service");
const AppError_1 = require("./AppError");
const catalog_1 = require("./catalog");
/**
 * Filtro de exceções aprimorado com suporte ao catálogo de erros
 *
 * Mantém compatibilidade total com o sistema existente enquanto
 * adiciona suporte completo para o novo catálogo de erros.
 */
let CatalogAwareExceptionFilter = CatalogAwareExceptionFilter_1 = class CatalogAwareExceptionFilter {
    config;
    logger;
    constructor(config, logger) {
        this.config = config;
        this.logger = logger;
        this.logger.setContext(CatalogAwareExceptionFilter_1.name);
    }
    catch(exception, host) {
        const ctx = host.switchToHttp();
        const req = ctx.getRequest();
        const res = ctx.getResponse();
        const path = req.url;
        const timestamp = new Date().toISOString();
        const requestId = req.headers[constants_1.REQUEST_ID_TOKEN_HEADER];
        const requestContext = (0, util_1.createRequestContext)(req);
        // Extrair idioma do header para localização (padrão: pt-BR)
        const acceptedLanguage = req.headers['accept-language']?.split(',')[0] || 'pt-BR';
        let stack;
        let statusCode;
        let errorName;
        let message;
        let details;
        let localizedMessage;
        let validationErrors;
        let errorCode;
        let category;
        let severity;
        let legalReference;
        // Tratamento estruturado por tipo de exceção
        switch (true) {
            case exception instanceof AppError_1.AppError:
                // Novo sistema de catálogo de erros
                const appError = exception;
                statusCode = appError.getStatus();
                errorName = appError.constructor.name;
                errorCode = appError.errorCode;
                message = appError.message;
                localizedMessage = appError.localizedMessage;
                category = appError.definition.category;
                severity = appError.definition.severity;
                legalReference = appError.definition.legalReference;
                details = appError.getApiResponse(this.shouldIncludeDetails());
                // Log estruturado específico para AppError
                this.logAppError(appError, requestContext, requestId);
                break;
            case exception instanceof base_api_exception_1.BaseApiException:
                // Sistema existente de exceções customizadas
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                message = exception.message;
                localizedMessage = exception.localizedMessage?.[acceptedLanguage];
                details = exception.details || exception.getResponse();
                break;
            case exception instanceof common_1.BadRequestException:
                // Tratamento de erros de validação
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                const response = exception.getResponse();
                if (response?.message && Array.isArray(response.message)) {
                    validationErrors = this.processValidationErrors(response.message);
                    message = 'Erro de validação';
                    details = { validationErrors };
                }
                else {
                    message = response?.message || exception.message;
                    details = response;
                }
                break;
            case exception instanceof common_1.HttpException:
                // Outras exceções HTTP do NestJS
                statusCode = exception.getStatus();
                errorName = exception.constructor.name;
                message = exception.message;
                details = exception.getResponse();
                break;
            case exception instanceof Error:
                // Erros genéricos do JavaScript
                statusCode = common_1.HttpStatus.INTERNAL_SERVER_ERROR;
                errorName = exception.constructor.name;
                message = exception.message;
                stack = exception.stack;
                // Tentar mapear para erro do catálogo se possível
                if (this.isDatabaseError(exception)) {
                    const mappedError = this.tryMapDatabaseError(exception, acceptedLanguage);
                    if (mappedError) {
                        statusCode = mappedError.getStatus();
                        errorCode = mappedError.errorCode;
                        message = mappedError.message;
                        localizedMessage = mappedError.localizedMessage;
                        category = mappedError.definition.category;
                        severity = mappedError.definition.severity;
                        details = mappedError.getApiResponse(this.shouldIncludeDetails());
                    }
                }
                break;
            default:
                // Erro desconhecido
                statusCode = common_1.HttpStatus.INTERNAL_SERVER_ERROR;
                errorName = 'UnknownException';
                message = 'Erro interno do servidor';
                break;
        }
        // Criar resposta de erro padronizada
        const errorResponse = {
            statusCode,
            message: localizedMessage || message,
            code: errorCode || errorName,
            details,
            errors: validationErrors,
            timestamp,
            path,
        };
        // Adicionar informações do catálogo se disponíveis
        if (category) {
            errorResponse.category = category;
        }
        if (severity) {
            errorResponse.severity = severity;
        }
        if (legalReference) {
            errorResponse.legalReference = legalReference;
        }
        // Log estruturado do erro (se não foi logado como AppError)
        if (!(exception instanceof AppError_1.AppError)) {
            const logLevel = this.getLogLevel(statusCode, severity);
            const logMessage = `${errorName}: ${message}`;
            const logMeta = {
                statusCode,
                errorName,
                errorCode,
                category,
                severity,
                path,
                requestId,
                userAgent: req.headers['user-agent'],
                ip: req.ip,
                method: req.method,
                stack: stack && this.config.get('NODE_ENV') === 'development'
                    ? stack
                    : undefined,
            };
            if (logLevel === 'error') {
                this.logger.error(requestContext, logMessage, logMeta);
            }
            else {
                this.logger.warn(requestContext, logMessage, logMeta);
            }
        }
        // Proteger dados sensíveis em produção
        const isProduction = this.config.get('NODE_ENV') === 'production';
        if (isProduction && statusCode === common_1.HttpStatus.INTERNAL_SERVER_ERROR) {
            errorResponse.message = 'Erro interno do servidor';
            if (!errorCode) {
                errorResponse.details = undefined;
            }
        }
        res.status(statusCode).json(errorResponse);
    }
    /**
     * Log específico para erros do catálogo
     */
    logAppError(appError, requestContext, requestId) {
        const logData = appError.getLogData();
        const logLevel = this.getLogLevel(appError.getStatus(), appError.definition.severity);
        const logMessage = `[${appError.errorCode}] ${appError.message}`;
        const logMeta = {
            ...logData,
            requestId,
            path: requestContext.path,
            method: requestContext.method,
            userAgent: requestContext.userAgent,
            ip: requestContext.ip,
        };
        if (logLevel === 'error') {
            this.logger.error(requestContext, logMessage, logMeta);
        }
        else {
            this.logger.warn(requestContext, logMessage, logMeta);
        }
        // Log adicional para erros críticos
        if (appError.isCritical()) {
            this.logger.error(requestContext, `CRITICAL ERROR: ${logMessage}`, {
                ...logMeta,
                alert: true,
                criticalError: true,
            });
        }
    }
    /**
     * Determina o nível de log baseado no status HTTP e severidade
     */
    getLogLevel(statusCode, severity) {
        if (severity === catalog_1.ErrorSeverity.CRITICAL ||
            severity === catalog_1.ErrorSeverity.HIGH) {
            return 'error';
        }
        return statusCode >= 500 ? 'error' : 'warn';
    }
    /**
     * Verifica se deve incluir detalhes na resposta
     */
    shouldIncludeDetails() {
        return this.config.get('NODE_ENV') !== 'production';
    }
    /**
     * Verifica se o erro é relacionado ao banco de dados
     */
    isDatabaseError(error) {
        const dbErrorIndicators = [
            'duplicate key',
            'foreign key',
            'check constraint',
            'not null',
            'violates',
            'constraint',
            'ECONNREFUSED',
            'ETIMEDOUT',
            'connection',
        ];
        const errorMessage = error.message.toLowerCase();
        return dbErrorIndicators.some((indicator) => errorMessage.includes(indicator.toLowerCase()));
    }
    /**
     * Tenta mapear erro de banco para erro do catálogo
     */
    tryMapDatabaseError(error, language) {
        try {
            // Extrair código PostgreSQL se disponível
            const postgresCodeMatch = error.message.match(/code:\s*(\d+)/);
            if (postgresCodeMatch) {
                const postgresCode = postgresCodeMatch[1];
                return AppError_1.AppError.fromPostgresError(postgresCode, {
                    cause: error,
                    metadata: {
                        originalMessage: error.message,
                    },
                }, language);
            }
            // Mapear por padrões na mensagem
            const message = error.message.toLowerCase();
            if (message.includes('duplicate key') ||
                message.includes('unique constraint')) {
                return AppError_1.AppError.fromPostgresError('23505', {
                    cause: error,
                    metadata: { originalMessage: error.message },
                }, language);
            }
            if (message.includes('foreign key') ||
                message.includes('violates foreign key')) {
                return AppError_1.AppError.fromPostgresError('23503', {
                    cause: error,
                    metadata: { originalMessage: error.message },
                }, language);
            }
            if (message.includes('check constraint')) {
                return AppError_1.AppError.fromPostgresError('23514', {
                    cause: error,
                    metadata: { originalMessage: error.message },
                }, language);
            }
            if (message.includes('not null')) {
                return AppError_1.AppError.fromPostgresError('23502', {
                    cause: error,
                    metadata: { originalMessage: error.message },
                }, language);
            }
            return null;
        }
        catch {
            return null;
        }
    }
    /**
     * Processa erros de validação do class-validator em formato estruturado
     */
    processValidationErrors(validationErrors) {
        const result = [];
        for (const error of validationErrors) {
            if (typeof error === 'string') {
                result.push({
                    field: 'unknown',
                    messages: [error],
                });
            }
            else if (error && typeof error === 'object' && 'property' in error) {
                const validationError = error;
                const messages = validationError.constraints
                    ? Object.values(validationError.constraints)
                    : ['Erro de validação'];
                result.push({
                    field: validationError.property,
                    messages,
                });
                if (validationError.children && validationError.children.length > 0) {
                    const childErrors = this.processValidationErrors(validationError.children);
                    result.push(...childErrors.map((childError) => ({
                        field: `${validationError.property}.${childError.field}`,
                        messages: childError.messages,
                    })));
                }
            }
        }
        return result;
    }
};
exports.CatalogAwareExceptionFilter = CatalogAwareExceptionFilter;
exports.CatalogAwareExceptionFilter = CatalogAwareExceptionFilter = CatalogAwareExceptionFilter_1 = __decorate([
    (0, common_1.Injectable)(),
    (0, common_1.Catch)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof unified_logger_service_1.UnifiedLoggerService !== "undefined" && unified_logger_service_1.UnifiedLoggerService) === "function" ? _b : Object])
], CatalogAwareExceptionFilter);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZXhjZXB0aW9uc1xcZXJyb3ItY2F0YWxvZ1xcZXJyb3JIYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7Ozs7Ozs7Ozs7Ozs7QUFFSCwyQ0FRd0I7QUFDeEIsMkNBQStDO0FBRy9DLCtDQUEwRDtBQUMxRCxxREFBa0U7QUFDbEUsOERBQXlEO0FBQ3pELGlGQUE0RTtBQUU1RSx5Q0FBc0M7QUFDdEMsdUNBQXlEO0FBRXpEOzs7OztHQUtHO0FBR0ksSUFBTSwyQkFBMkIsbUNBQWpDLE1BQU0sMkJBQTJCO0lBRW5CO0lBQ0E7SUFGbkIsWUFDbUIsTUFBcUIsRUFDckIsTUFBNEI7UUFENUIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUFzQjtRQUU3QyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyw2QkFBMkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVksRUFBRSxJQUFtQjtRQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDaEMsTUFBTSxHQUFHLEdBQVksR0FBRyxDQUFDLFVBQVUsRUFBVyxDQUFDO1FBQy9DLE1BQU0sR0FBRyxHQUFhLEdBQUcsQ0FBQyxXQUFXLEVBQVksQ0FBQztRQUVsRCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO1FBQ3JCLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDM0MsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxtQ0FBdUIsQ0FBVyxDQUFDO1FBQ2pFLE1BQU0sY0FBYyxHQUFHLElBQUEsMkJBQW9CLEVBQUMsR0FBRyxDQUFDLENBQUM7UUFFakQsNERBQTREO1FBQzVELE1BQU0s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QyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBQ2xDLEtBQUssRUFBRSxHQUFHLGVBQWUsQ0FBQyxRQUFRLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRTt3QkFDeEQsUUFBUSxFQUFFLFVBQVUsQ0FBQyxRQUFRO3FCQUM5QixDQUFDLENBQUMsQ0FDSixDQUFDO2dCQUNKLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FDRixDQUFBO0FBcllZLGtFQUEyQjtzQ0FBM0IsMkJBQTJCO0lBRnZDLElBQUEsbUJBQVUsR0FBRTtJQUNaLElBQUEsY0FBSyxHQUFFO3lEQUdxQixzQkFBYSxvQkFBYixzQkFBYSxvREFDYiw2Q0FBb0Isb0JBQXBCLDZDQUFvQjtHQUhwQywyQkFBMkIsQ0FxWXZDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXGV4Y2VwdGlvbnNcXGVycm9yLWNhdGFsb2dcXGVycm9ySGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE1pZGRsZXdhcmUgZGUgdHJhdGFtZW50byBkZSBlcnJvcyBpbnRlZ3JhZG8gYW8gY2F0w6Fsb2dvXG4gKlxuICogRXN0ZW5kZSBvIGZpbHRybyBkZSBleGNlw6fDtWVzIGV4aXN0ZW50ZSBwYXJhIHN1cG9ydGFyXG4gKiBvIG5vdm8gc2lzdGVtYSBkZSBjYXTDoWxvZ28gZGUgZXJyb3MsIG1hbnRlbmRvXG4gKiBjb21wYXRpYmlsaWRhZGUgY29tIG8gc2lzdGVtYSBhdHVhbC5cbiAqXG4gKiBAc2VlIGRvY3MvQURScy9jYXRhbG9nby1lcnJvcy5tZFxuICovXG5cbmltcG9ydCB7XG4gIEV4Y2VwdGlvbkZpbHRlcixcbiAgQ2F0Y2gsXG4gIEFyZ3VtZW50c0hvc3QsXG4gIEh0dHBFeGNlcHRpb24sXG4gIEh0dHBTdGF0dXMsXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIEluamVjdGFibGUsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnY2xhc3MtdmFsaWRhdG9yJztcbmltcG9ydCB7IFJFUVVFU1RfSURfVE9LRU5fSEVBREVSIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IGNyZWF0ZVJlcXVlc3RDb250ZXh0IH0gZnJvbSAnLi4vLi4vcmVxdWVzdC1jb250ZXh0L3V0aWwnO1xuaW1wb3J0IHsgQmFzZUFwaUV4Y2VwdGlvbiB9IGZyb20gJy4uL2Jhc2UtYXBpLmV4Y2VwdGlvbic7XG5pbXBvcnQgeyBVbmlmaWVkTG9nZ2VyU2VydmljZSB9IGZyb20gJy4uLy4uL2xvZ2dpbmcvdW5pZmllZC1sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBBcGlFcnJvclJlc3BvbnNlIH0gZnJvbSAnLi4vLi4vZHRvcy9hcGktZXJyb3ItcmVzcG9uc2UuZHRvJztcbmltcG9ydCB7IEFwcEVycm9yIH0gZnJvbSAnLi9BcHBFcnJvcic7XG5pbXBvcnQgeyBFcnJvckNhdGVnb3J5LCBFcnJvclNldmVyaXR5IH0gZnJvbSAnLi9jYXRhbG9nJztcblxuLyoqXG4gKiBGaWx0cm8gZGUgZXhjZcOnw7VlcyBhcHJpbW9yYWRvIGNvbSBzdXBvcnRlIGFvIGNhdMOhbG9nbyBkZSBlcnJvc1xuICpcbiAqIE1hbnTDqW0gY29tcGF0aWJpbGlkYWRlIHRvdGFsIGNvbSBvIHNpc3RlbWEgZXhpc3RlbnRlIGVucXVhbnRvXG4gKiBhZGljaW9uYSBzdXBvcnRlIGNvbXBsZXRvIHBhcmEgbyBub3ZvIGNhdMOhbG9nbyBkZSBlcnJvcy5cbiAqL1xuQEluamVjdGFibGUoKVxuQENhdGNoKClcbmV4cG9ydCBjbGFzcyBDYXRhbG9nQXdhcmVFeGNlcHRpb25GaWx0ZXI8VD4gaW1wbGVtZW50cyBFeGNlcHRpb25GaWx0ZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogQ29uZmlnU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogVW5pZmllZExvZ2dlclNlcnZpY2UsXG4gICkge1xuICAgIHRoaXMubG9nZ2VyLnNldENvbnRleHQoQ2F0YWxvZ0F3YXJlRXhjZXB0aW9uRmlsdGVyLm5hbWUpO1xuICB9XG5cbiAgY2F0Y2goZXhjZXB0aW9uOiBULCBob3N0OiBBcmd1bWVudHNIb3N0KTogYW55IHtcbiAgICBjb25zdCBjdHggPSBob3N0LnN3aXRjaFRvSHR0cCgpO1xuICAgIGNvbnN0IHJlcTogUmVxdWVzdCA9IGN0eC5nZXRSZXF1ZXN0PFJlcXVlc3Q+KCk7XG4gICAgY29uc3QgcmVzOiBSZXNwb25zZSA9IGN0eC5nZXRSZXNwb25zZTxSZXNwb25zZT4oKTtcblxuICAgIGNvbnN0IHBhdGggPSByZXEudXJsO1xuICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSByZXEuaGVhZGVyc1tSRVFVRVNUX0lEX1RPS0VOX0hFQURFUl0gYXMgc3RyaW5nO1xuICAgIGNvbnN0IHJlcXVlc3RDb250ZXh0ID0gY3JlYXRlUmVxdWVzdENvbnRleHQocmVxKTtcblxuICAgIC8vIEV4dHJhaXIgaWRpb21hIGRvIGhlYWRlciBwYXJhIGxvY2FsaXphw6fDo28gKHBhZHLDo286IHB0LUJSKVxuICAgIGNvbnN0IGFjY2VwdGVkTGFuZ3VhZ2UgPVxuICAgICAgcmVxLmhlYWRlcnNbJ2FjY2VwdC1sYW5ndWFnZSddPy5zcGxpdCgnLCcpWzBdIHx8ICdwdC1CUic7XG5cbiAgICBsZXQgc3RhY2s6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgc3RhdHVzQ29kZTogSHR0cFN0YXR1cztcbiAgICBsZXQgZXJyb3JOYW1lOiBzdHJpbmc7XG4gICAgbGV0IG1lc3NhZ2U6IHN0cmluZztcbiAgICBsZXQgZGV0YWlsczogYW55O1xuICAgIGxldCBsb2NhbGl6ZWRNZXNzYWdlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHZhbGlkYXRpb25FcnJvcnM6XG4gICAgICB8IEFycmF5PHsgZmllbGQ6IHN0cmluZzsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+XG4gICAgICB8IHVuZGVmaW5lZDtcbiAgICBsZXQgZXJyb3JDb2RlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5IHwgdW5kZWZpbmVkO1xuICAgIGxldCBzZXZlcml0eTogRXJyb3JTZXZlcml0eSB8IHVuZGVmaW5lZDtcbiAgICBsZXQgbGVnYWxSZWZlcmVuY2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIC8vIFRyYXRhbWVudG8gZXN0cnV0dXJhZG8gcG9yIHRpcG8gZGUgZXhjZcOnw6NvXG4gICAgc3dpdGNoICh0cnVlKSB7XG4gICAgICBjYXNlIGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEFwcEVycm9yOlxuICAgICAgICAvLyBOb3ZvIHNpc3RlbWEgZGUgY2F0w6Fsb2dvIGRlIGVycm9zXG4gICAgICAgIGNvbnN0IGFwcEVycm9yID0gZXhjZXB0aW9uIGFzIEFwcEVycm9yO1xuICAgICAgICBzdGF0dXNDb2RlID0gYXBwRXJyb3IuZ2V0U3RhdHVzKCk7XG4gICAgICAgIGVycm9yTmFtZSA9IGFwcEVycm9yLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgICAgIGVycm9yQ29kZSA9IGFwcEVycm9yLmVycm9yQ29kZTtcbiAgICAgICAgbWVzc2FnZSA9IGFwcEVycm9yLm1lc3NhZ2U7XG4gICAgICAgIGxvY2FsaXplZE1lc3NhZ2UgPSBhcHBFcnJvci5sb2NhbGl6ZWRNZXNzYWdlO1xuICAgICAgICBjYXRlZ29yeSA9IGFwcEVycm9yLmRlZmluaXRpb24uY2F0ZWdvcnk7XG4gICAgICAgIHNldmVyaXR5ID0gYXBwRXJyb3IuZGVmaW5pdGlvbi5zZXZlcml0eTtcbiAgICAgICAgbGVnYWxSZWZlcmVuY2UgPSBhcHBFcnJvci5kZWZpbml0aW9uLmxlZ2FsUmVmZXJlbmNlO1xuICAgICAgICBkZXRhaWxzID0gYXBwRXJyb3IuZ2V0QXBpUmVzcG9uc2UodGhpcy5zaG91bGRJbmNsdWRlRGV0YWlscygpKTtcblxuICAgICAgICAvLyBMb2cgZXN0cnV0dXJhZG8gZXNwZWPDrWZpY28gcGFyYSBBcHBFcnJvclxuICAgICAgICB0aGlzLmxvZ0FwcEVycm9yKGFwcEVycm9yLCByZXF1ZXN0Q29udGV4dCwgcmVxdWVzdElkKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgZXhjZXB0aW9uIGluc3RhbmNlb2YgQmFzZUFwaUV4Y2VwdGlvbjpcbiAgICAgICAgLy8gU2lzdGVtYSBleGlzdGVudGUgZGUgZXhjZcOnw7VlcyBjdXN0b21pemFkYXNcbiAgICAgICAgc3RhdHVzQ29kZSA9IGV4Y2VwdGlvbi5nZXRTdGF0dXMoKTtcbiAgICAgICAgZXJyb3JOYW1lID0gZXhjZXB0aW9uLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgICAgIG1lc3NhZ2UgPSBleGNlcHRpb24ubWVzc2FnZTtcbiAgICAgICAgbG9jYWxpemVkTWVzc2FnZSA9IGV4Y2VwdGlvbi5sb2NhbGl6ZWRNZXNzYWdlPy5bYWNjZXB0ZWRMYW5ndWFnZV07XG4gICAgICAgIGRldGFpbHMgPSBleGNlcHRpb24uZGV0YWlscyB8fCBleGNlcHRpb24uZ2V0UmVzcG9uc2UoKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgZXhjZXB0aW9uIGluc3RhbmNlb2YgQmFkUmVxdWVzdEV4Y2VwdGlvbjpcbiAgICAgICAgLy8gVHJhdGFtZW50byBkZSBlcnJvcyBkZSB2YWxpZGHDp8Ojb1xuICAgICAgICBzdGF0dXNDb2RlID0gZXhjZXB0aW9uLmdldFN0YXR1cygpO1xuICAgICAgICBlcnJvck5hbWUgPSBleGNlcHRpb24uY29uc3RydWN0b3IubmFtZTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBleGNlcHRpb24uZ2V0UmVzcG9uc2UoKSBhcyBhbnk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlPy5tZXNzYWdlICYmIEFycmF5LmlzQXJyYXkocmVzcG9uc2UubWVzc2FnZSkpIHtcbiAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JzID0gdGhpcy5wcm9jZXNzVmFsaWRhdGlvbkVycm9ycyhyZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICBtZXNzYWdlID0gJ0Vycm8gZGUgdmFsaWRhw6fDo28nO1xuICAgICAgICAgIGRldGFpbHMgPSB7IHZhbGlkYXRpb25FcnJvcnMgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtZXNzYWdlID0gcmVzcG9uc2U/Lm1lc3NhZ2UgfHwgZXhjZXB0aW9uLm1lc3NhZ2U7XG4gICAgICAgICAgZGV0YWlscyA9IHJlc3BvbnNlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEh0dHBFeGNlcHRpb246XG4gICAgICAgIC8vIE91dHJhcyBleGNlw6fDtWVzIEhUVFAgZG8gTmVzdEpTXG4gICAgICAgIHN0YXR1c0NvZGUgPSBleGNlcHRpb24uZ2V0U3RhdHVzKCk7XG4gICAgICAgIGVycm9yTmFtZSA9IGV4Y2VwdGlvbi5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICBtZXNzYWdlID0gZXhjZXB0aW9uLm1lc3NhZ2U7XG4gICAgICAgIGRldGFpbHMgPSBleGNlcHRpb24uZ2V0UmVzcG9uc2UoKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgZXhjZXB0aW9uIGluc3RhbmNlb2YgRXJyb3I6XG4gICAgICAgIC8vIEVycm9zIGdlbsOpcmljb3MgZG8gSmF2YVNjcmlwdFxuICAgICAgICBzdGF0dXNDb2RlID0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1I7XG4gICAgICAgIGVycm9yTmFtZSA9IGV4Y2VwdGlvbi5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICBtZXNzYWdlID0gZXhjZXB0aW9uLm1lc3NhZ2U7XG4gICAgICAgIHN0YWNrID0gZXhjZXB0aW9uLnN0YWNrO1xuXG4gICAgICAgIC8vIFRlbnRhciBtYXBlYXIgcGFyYSBlcnJvIGRvIGNhdMOhbG9nbyBzZSBwb3Nzw612ZWxcbiAgICAgICAgaWYgKHRoaXMuaXNEYXRhYmFzZUVycm9yKGV4Y2VwdGlvbikpIHtcbiAgICAgICAgICBjb25zdCBtYXBwZWRFcnJvciA9IHRoaXMudHJ5TWFwRGF0YWJhc2VFcnJvcihcbiAgICAgICAgICAgIGV4Y2VwdGlvbixcbiAgICAgICAgICAgIGFjY2VwdGVkTGFuZ3VhZ2UsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAobWFwcGVkRXJyb3IpIHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGUgPSBtYXBwZWRFcnJvci5nZXRTdGF0dXMoKTtcbiAgICAgICAgICAgIGVycm9yQ29kZSA9IG1hcHBlZEVycm9yLmVycm9yQ29kZTtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBtYXBwZWRFcnJvci5tZXNzYWdlO1xuICAgICAgICAgICAgbG9jYWxpemVkTWVzc2FnZSA9IG1hcHBlZEVycm9yLmxvY2FsaXplZE1lc3NhZ2U7XG4gICAgICAgICAgICBjYXRlZ29yeSA9IG1hcHBlZEVycm9yLmRlZmluaXRpb24uY2F0ZWdvcnk7XG4gICAgICAgICAgICBzZXZlcml0eSA9IG1hcHBlZEVycm9yLmRlZmluaXRpb24uc2V2ZXJpdHk7XG4gICAgICAgICAgICBkZXRhaWxzID0gbWFwcGVkRXJyb3IuZ2V0QXBpUmVzcG9uc2UodGhpcy5zaG91bGRJbmNsdWRlRGV0YWlscygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIC8vIEVycm8gZGVzY29uaGVjaWRvXG4gICAgICAgIHN0YXR1c0NvZGUgPSBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUjtcbiAgICAgICAgZXJyb3JOYW1lID0gJ1Vua25vd25FeGNlcHRpb24nO1xuICAgICAgICBtZXNzYWdlID0gJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcic7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIC8vIENyaWFyIHJlc3Bvc3RhIGRlIGVycm8gcGFkcm9uaXphZGFcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlOiBBcGlFcnJvclJlc3BvbnNlID0ge1xuICAgICAgc3RhdHVzQ29kZSxcbiAgICAgIG1lc3NhZ2U6IGxvY2FsaXplZE1lc3NhZ2UgfHwgbWVzc2FnZSxcbiAgICAgIGNvZGU6IGVycm9yQ29kZSB8fCBlcnJvck5hbWUsXG4gICAgICBkZXRhaWxzLFxuICAgICAgZXJyb3JzOiB2YWxpZGF0aW9uRXJyb3JzLFxuICAgICAgdGltZXN0YW1wLFxuICAgICAgcGF0aCxcbiAgICB9O1xuXG4gICAgLy8gQWRpY2lvbmFyIGluZm9ybWHDp8O1ZXMgZG8gY2F0w6Fsb2dvIHNlIGRpc3BvbsOtdmVpc1xuICAgIGlmIChjYXRlZ29yeSkge1xuICAgICAgKGVycm9yUmVzcG9uc2UgYXMgYW55KS5jYXRlZ29yeSA9IGNhdGVnb3J5O1xuICAgIH1cbiAgICBpZiAoc2V2ZXJpdHkpIHtcbiAgICAgIChlcnJvclJlc3BvbnNlIGFzIGFueSkuc2V2ZXJpdHkgPSBzZXZlcml0eTtcbiAgICB9XG4gICAgaWYgKGxlZ2FsUmVmZXJlbmNlKSB7XG4gICAgICAoZXJyb3JSZXNwb25zZSBhcyBhbnkpLmxlZ2FsUmVmZXJlbmNlID0gbGVnYWxSZWZlcmVuY2U7XG4gICAgfVxuXG4gICAgLy8gTG9nIGVzdHJ1dHVyYWRvIGRvIGVycm8gKHNlIG7Do28gZm9pIGxvZ2FkbyBjb21vIEFwcEVycm9yKVxuICAgIGlmICghKGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEFwcEVycm9yKSkge1xuICAgICAgY29uc3QgbG9nTGV2ZWwgPSB0aGlzLmdldExvZ0xldmVsKHN0YXR1c0NvZGUsIHNldmVyaXR5KTtcbiAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBgJHtlcnJvck5hbWV9OiAke21lc3NhZ2V9YDtcbiAgICAgIGNvbnN0IGxvZ01ldGEgPSB7XG4gICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICAgIGVycm9yTmFtZSxcbiAgICAgICAgZXJyb3JDb2RlLFxuICAgICAgICBjYXRlZ29yeSxcbiAgICAgICAgc2V2ZXJpdHksXG4gICAgICAgIHBhdGgsXG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgdXNlckFnZW50OiByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddLFxuICAgICAgICBpcDogcmVxLmlwLFxuICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICAgIHN0YWNrOlxuICAgICAgICAgIHN0YWNrICYmIHRoaXMuY29uZmlnLmdldDxzdHJpbmc+KCdOT0RFX0VOVicpID09PSAnZGV2ZWxvcG1lbnQnXG4gICAgICAgICAgICA/IHN0YWNrXG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIH07XG5cbiAgICAgIGlmIChsb2dMZXZlbCA9PT0gJ2Vycm9yJykge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihyZXF1ZXN0Q29udGV4dCwgbG9nTWVzc2FnZSwgbG9nTWV0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKHJlcXVlc3RDb250ZXh0LCBsb2dNZXNzYWdlLCBsb2dNZXRhKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQcm90ZWdlciBkYWRvcyBzZW5zw612ZWlzIGVtIHByb2R1w6fDo29cbiAgICBjb25zdCBpc1Byb2R1Y3Rpb24gPSB0aGlzLmNvbmZpZy5nZXQ8c3RyaW5nPignTk9ERV9FTlYnKSA9PT0gJ3Byb2R1Y3Rpb24nO1xuICAgIGlmIChpc1Byb2R1Y3Rpb24gJiYgc3RhdHVzQ29kZSA9PT0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpIHtcbiAgICAgIGVycm9yUmVzcG9uc2UubWVzc2FnZSA9ICdFcnJvIGludGVybm8gZG8gc2Vydmlkb3InO1xuICAgICAgaWYgKCFlcnJvckNvZGUpIHtcbiAgICAgICAgZXJyb3JSZXNwb25zZS5kZXRhaWxzID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbihlcnJvclJlc3BvbnNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2cgZXNwZWPDrWZpY28gcGFyYSBlcnJvcyBkbyBjYXTDoWxvZ29cbiAgICovXG4gIHByaXZhdGUgbG9nQXBwRXJyb3IoXG4gICAgYXBwRXJyb3I6IEFwcEVycm9yLFxuICAgIHJlcXVlc3RDb250ZXh0OiBhbnksXG4gICAgcmVxdWVzdElkOiBzdHJpbmcsXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGxvZ0RhdGEgPSBhcHBFcnJvci5nZXRMb2dEYXRhKCk7XG4gICAgY29uc3QgbG9nTGV2ZWwgPSB0aGlzLmdldExvZ0xldmVsKFxuICAgICAgYXBwRXJyb3IuZ2V0U3RhdHVzKCksXG4gICAgICBhcHBFcnJvci5kZWZpbml0aW9uLnNldmVyaXR5LFxuICAgICk7XG4gICAgY29uc3QgbG9nTWVzc2FnZSA9IGBbJHthcHBFcnJvci5lcnJvckNvZGV9XSAke2FwcEVycm9yLm1lc3NhZ2V9YDtcblxuICAgIGNvbnN0IGxvZ01ldGEgPSB7XG4gICAgICAuLi5sb2dEYXRhLFxuICAgICAgcmVxdWVzdElkLFxuICAgICAgcGF0aDogcmVxdWVzdENvbnRleHQucGF0aCxcbiAgICAgIG1ldGhvZDogcmVxdWVzdENvbnRleHQubWV0aG9kLFxuICAgICAgdXNlckFnZW50OiByZXF1ZXN0Q29udGV4dC51c2VyQWdlbnQsXG4gICAgICBpcDogcmVxdWVzdENvbnRleHQuaXAsXG4gICAgfTtcblxuICAgIGlmIChsb2dMZXZlbCA9PT0gJ2Vycm9yJykge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocmVxdWVzdENvbnRleHQsIGxvZ01lc3NhZ2UsIGxvZ01ldGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKHJlcXVlc3RDb250ZXh0LCBsb2dNZXNzYWdlLCBsb2dNZXRhKTtcbiAgICB9XG5cbiAgICAvLyBMb2cgYWRpY2lvbmFsIHBhcmEgZXJyb3MgY3LDrXRpY29zXG4gICAgaWYgKGFwcEVycm9yLmlzQ3JpdGljYWwoKSkge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocmVxdWVzdENvbnRleHQsIGBDUklUSUNBTCBFUlJPUjogJHtsb2dNZXNzYWdlfWAsIHtcbiAgICAgICAgLi4ubG9nTWV0YSxcbiAgICAgICAgYWxlcnQ6IHRydWUsXG4gICAgICAgIGNyaXRpY2FsRXJyb3I6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5hIG8gbsOtdmVsIGRlIGxvZyBiYXNlYWRvIG5vIHN0YXR1cyBIVFRQIGUgc2V2ZXJpZGFkZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRMb2dMZXZlbChcbiAgICBzdGF0dXNDb2RlOiBudW1iZXIsXG4gICAgc2V2ZXJpdHk/OiBFcnJvclNldmVyaXR5LFxuICApOiAnZXJyb3InIHwgJ3dhcm4nIHtcbiAgICBpZiAoXG4gICAgICBzZXZlcml0eSA9PT0gRXJyb3JTZXZlcml0eS5DUklUSUNBTCB8fFxuICAgICAgc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuSElHSFxuICAgICkge1xuICAgICAgcmV0dXJuICdlcnJvcic7XG4gICAgfVxuICAgIHJldHVybiBzdGF0dXNDb2RlID49IDUwMCA/ICdlcnJvcicgOiAnd2Fybic7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgZGV2ZSBpbmNsdWlyIGRldGFsaGVzIG5hIHJlc3Bvc3RhXG4gICAqL1xuICBwcml2YXRlIHNob3VsZEluY2x1ZGVEZXRhaWxzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5nZXQ8c3RyaW5nPignTk9ERV9FTlYnKSAhPT0gJ3Byb2R1Y3Rpb24nO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIG8gZXJybyDDqSByZWxhY2lvbmFkbyBhbyBiYW5jbyBkZSBkYWRvc1xuICAgKi9cbiAgcHJpdmF0ZSBpc0RhdGFiYXNlRXJyb3IoZXJyb3I6IEVycm9yKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZGJFcnJvckluZGljYXRvcnMgPSBbXG4gICAgICAnZHVwbGljYXRlIGtleScsXG4gICAgICAnZm9yZWlnbiBrZXknLFxuICAgICAgJ2NoZWNrIGNvbnN0cmFpbnQnLFxuICAgICAgJ25vdCBudWxsJyxcbiAgICAgICd2aW9sYXRlcycsXG4gICAgICAnY29uc3RyYWludCcsXG4gICAgICAnRUNPTk5SRUZVU0VEJyxcbiAgICAgICdFVElNRURPVVQnLFxuICAgICAgJ2Nvbm5lY3Rpb24nLFxuICAgIF07XG5cbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlLnRvTG93ZXJDYXNlKCk7XG4gICAgcmV0dXJuIGRiRXJyb3JJbmRpY2F0b3JzLnNvbWUoKGluZGljYXRvcikgPT5cbiAgICAgIGVycm9yTWVzc2FnZS5pbmNsdWRlcyhpbmRpY2F0b3IudG9Mb3dlckNhc2UoKSksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZW50YSBtYXBlYXIgZXJybyBkZSBiYW5jbyBwYXJhIGVycm8gZG8gY2F0w6Fsb2dvXG4gICAqL1xuICBwcml2YXRlIHRyeU1hcERhdGFiYXNlRXJyb3IoZXJyb3I6IEVycm9yLCBsYW5ndWFnZTogc3RyaW5nKTogQXBwRXJyb3IgfCBudWxsIHtcbiAgICB0cnkge1xuICAgICAgLy8gRXh0cmFpciBjw7NkaWdvIFBvc3RncmVTUUwgc2UgZGlzcG9uw612ZWxcbiAgICAgIGNvbnN0IHBvc3RncmVzQ29kZU1hdGNoID0gZXJyb3IubWVzc2FnZS5tYXRjaCgvY29kZTpcXHMqKFxcZCspLyk7XG4gICAgICBpZiAocG9zdGdyZXNDb2RlTWF0Y2gpIHtcbiAgICAgICAgY29uc3QgcG9zdGdyZXNDb2RlID0gcG9zdGdyZXNDb2RlTWF0Y2hbMV07XG4gICAgICAgIHJldHVybiBBcHBFcnJvci5mcm9tUG9zdGdyZXNFcnJvcihcbiAgICAgICAgICBwb3N0Z3Jlc0NvZGUsXG4gICAgICAgICAge1xuICAgICAgICAgICAgY2F1c2U6IGVycm9yLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgb3JpZ2luYWxNZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGxhbmd1YWdlLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBNYXBlYXIgcG9yIHBhZHLDtWVzIG5hIG1lbnNhZ2VtXG4gICAgICBjb25zdCBtZXNzYWdlID0gZXJyb3IubWVzc2FnZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICBpZiAoXG4gICAgICAgIG1lc3NhZ2UuaW5jbHVkZXMoJ2R1cGxpY2F0ZSBrZXknKSB8fFxuICAgICAgICBtZXNzYWdlLmluY2x1ZGVzKCd1bmlxdWUgY29uc3RyYWludCcpXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIEFwcEVycm9yLmZyb21Qb3N0Z3Jlc0Vycm9yKFxuICAgICAgICAgICcyMzUwNScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgY2F1c2U6IGVycm9yLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHsgb3JpZ2luYWxNZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBsYW5ndWFnZSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBtZXNzYWdlLmluY2x1ZGVzKCdmb3JlaWduIGtleScpIHx8XG4gICAgICAgIG1lc3NhZ2UuaW5jbHVkZXMoJ3Zpb2xhdGVzIGZvcmVpZ24ga2V5JylcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gQXBwRXJyb3IuZnJvbVBvc3RncmVzRXJyb3IoXG4gICAgICAgICAgJzIzNTAzJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjYXVzZTogZXJyb3IsXG4gICAgICAgICAgICBtZXRhZGF0YTogeyBvcmlnaW5hbE1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGxhbmd1YWdlLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAobWVzc2FnZS5pbmNsdWRlcygnY2hlY2sgY29uc3RyYWludCcpKSB7XG4gICAgICAgIHJldHVybiBBcHBFcnJvci5mcm9tUG9zdGdyZXNFcnJvcihcbiAgICAgICAgICAnMjM1MTQnLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNhdXNlOiBlcnJvcixcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7IG9yaWdpbmFsTWVzc2FnZTogZXJyb3IubWVzc2FnZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbGFuZ3VhZ2UsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtZXNzYWdlLmluY2x1ZGVzKCdub3QgbnVsbCcpKSB7XG4gICAgICAgIHJldHVybiBBcHBFcnJvci5mcm9tUG9zdGdyZXNFcnJvcihcbiAgICAgICAgICAnMjM1MDInLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNhdXNlOiBlcnJvcixcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7IG9yaWdpbmFsTWVzc2FnZTogZXJyb3IubWVzc2FnZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbGFuZ3VhZ2UsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3NhIGVycm9zIGRlIHZhbGlkYcOnw6NvIGRvIGNsYXNzLXZhbGlkYXRvciBlbSBmb3JtYXRvIGVzdHJ1dHVyYWRvXG4gICAqL1xuICBwcml2YXRlIHByb2Nlc3NWYWxpZGF0aW9uRXJyb3JzKFxuICAgIHZhbGlkYXRpb25FcnJvcnM6IHN0cmluZ1tdIHwgVmFsaWRhdGlvbkVycm9yW10sXG4gICk6IEFycmF5PHsgZmllbGQ6IHN0cmluZzsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+IHtcbiAgICBjb25zdCByZXN1bHQ6IEFycmF5PHsgZmllbGQ6IHN0cmluZzsgbWVzc2FnZXM6IHN0cmluZ1tdIH0+ID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGVycm9yIG9mIHZhbGlkYXRpb25FcnJvcnMpIHtcbiAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICBmaWVsZDogJ3Vua25vd24nLFxuICAgICAgICAgIG1lc3NhZ2VzOiBbZXJyb3JdLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAnb2JqZWN0JyAmJiAncHJvcGVydHknIGluIGVycm9yKSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IGVycm9yIGFzIFZhbGlkYXRpb25FcnJvcjtcbiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNcbiAgICAgICAgICA/IE9iamVjdC52YWx1ZXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKVxuICAgICAgICAgIDogWydFcnJvIGRlIHZhbGlkYcOnw6NvJ107XG5cbiAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgIGZpZWxkOiB2YWxpZGF0aW9uRXJyb3IucHJvcGVydHksXG4gICAgICAgICAgbWVzc2FnZXMsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4gJiYgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBjaGlsZEVycm9ycyA9IHRoaXMucHJvY2Vzc1ZhbGlkYXRpb25FcnJvcnMoXG4gICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4sXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXN1bHQucHVzaChcbiAgICAgICAgICAgIC4uLmNoaWxkRXJyb3JzLm1hcCgoY2hpbGRFcnJvcikgPT4gKHtcbiAgICAgICAgICAgICAgZmllbGQ6IGAke3ZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eX0uJHtjaGlsZEVycm9yLmZpZWxkfWAsXG4gICAgICAgICAgICAgIG1lc3NhZ2VzOiBjaGlsZEVycm9yLm1lc3NhZ2VzLFxuICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=