3dc6813b9190057dc34975f12f6de31a
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var InfoBancariaService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.InfoBancariaService = void 0;
const common_1 = require("@nestjs/common");
const info_bancaria_repository_1 = require("../repositories/info-bancaria.repository");
const cidadao_service_1 = require("./cidadao.service");
const info_bancaria_enum_1 = require("../../../enums/info-bancaria.enum");
const enum_normalizer_util_1 = require("../../../shared/utils/enum-normalizer.util");
/**
 * Service para gerenciamento de informações bancárias
 *
 * Responsável pela lógica de negócio relacionada às informações bancárias dos cidadãos,
 * incluindo validações específicas para contas poupança social do Banco do Brasil
 * e chaves PIX.
 */
let InfoBancariaService = InfoBancariaService_1 = class InfoBancariaService {
    infoBancariaRepository;
    cidadaoService;
    logger = new common_1.Logger(InfoBancariaService_1.name);
    constructor(infoBancariaRepository, cidadaoService) {
        this.infoBancariaRepository = infoBancariaRepository;
        this.cidadaoService = cidadaoService;
    }
    /**
     * Cria uma nova informação bancária
     * @param createInfoBancariaDto Dados para criação
     * @returns Informação bancária criada
     */
    async create(createInfoBancariaDto) {
        try {
            this.logger.log(`Criando informação bancária para cidadão ${createInfoBancariaDto.cidadao_id}`);
            // Verifica se o cidadão existe
            const cidadao = await this.cidadaoService.findById(createInfoBancariaDto.cidadao_id);
            if (!cidadao) {
                throw new common_1.NotFoundException('Cidadão não encontrado');
            }
            // Verifica se já existe informação bancária ativa para o cidadão
            const existingInfo = await this.infoBancariaRepository.existsActiveByCidadaoId(createInfoBancariaDto.cidadao_id);
            if (existingInfo) {
                throw new common_1.ConflictException('Cidadão já possui informação bancária ativa');
            }
            // Valida chave PIX se fornecida
            if (createInfoBancariaDto.chave_pix) {
                await this.validateChavePix(createInfoBancariaDto.chave_pix, createInfoBancariaDto.tipo_chave_pix);
                // Verifica se a chave PIX já está em uso
                const pixExists = await this.infoBancariaRepository.existsByChavePix(createInfoBancariaDto.chave_pix);
                if (pixExists) {
                    throw new common_1.ConflictException('Chave PIX já está em uso');
                }
            }
            // Valida dados específicos do Banco do Brasil se aplicável
            if (createInfoBancariaDto.banco === '001') {
                this.validateBancoBrasil(createInfoBancariaDto);
            }
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)(createInfoBancariaDto);
            const infoBancaria = await this.infoBancariaRepository.create(dadosNormalizados);
            this.logger.log(`Informação bancária criada com sucesso: ${infoBancaria.id}`);
            return this.mapToResponseDto(infoBancaria);
        }
        catch (error) {
            this.logger.error(`Erro ao criar informação bancária: ${error.message}`, error.stack);
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.ConflictException ||
                error instanceof common_1.BadRequestException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao criar informação bancária');
        }
    }
    /**
     * Busca todas as informações bancárias com filtros
     * @param options Opções de filtro e paginação
     * @returns Lista paginada de informações bancárias
     */
    async findAll(options) {
        try {
            const [infosBancarias, total] = await this.infoBancariaRepository.findAll({
                skip: options?.skip,
                take: options?.take,
                where: {
                    cidadao_id: options?.cidadao_id,
                    banco: options?.banco,
                    ativo: options?.ativo,
                },
                includeRelations: options?.includeRelations,
            });
            return {
                data: infosBancarias.map((info) => this.mapToResponseDto(info)),
                total,
            };
        }
        catch (error) {
            this.logger.error(`Erro ao buscar informações bancárias: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro interno ao buscar informações bancárias');
        }
    }
    /**
     * Busca informação bancária por ID
     * @param id ID da informação bancária
     * @param includeRelations Se deve incluir relações
     * @returns Informação bancária encontrada
     */
    async findById(id, includeRelations = false) {
        try {
            const infoBancaria = await this.infoBancariaRepository.findById(id, includeRelations);
            if (!infoBancaria) {
                throw new common_1.NotFoundException('Informação bancária não encontrada');
            }
            return this.mapToResponseDto(infoBancaria);
        }
        catch (error) {
            this.logger.error(`Erro ao buscar informação bancária ${id}: ${error.message}`, error.stack);
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao buscar informação bancária');
        }
    }
    /**
     * Busca informação bancária por ID do cidadão
     * @param cidadaoId ID do cidadão
     * @param includeRelations Se deve incluir relações
     * @returns Informação bancária do cidadão
     */
    async findByCidadaoId(cidadaoId, includeRelations = false) {
        try {
            const infoBancaria = await this.infoBancariaRepository.findByCidadaoId(cidadaoId, includeRelations);
            return infoBancaria ? this.mapToResponseDto(infoBancaria) : null;
        }
        catch (error) {
            this.logger.error(`Erro ao buscar informação bancária do cidadão ${cidadaoId}: ${error.message}`, error.stack);
            throw new common_1.InternalServerErrorException('Erro interno ao buscar informação bancária do cidadão');
        }
    }
    /**
     * Atualiza informação bancária
     * @param id ID da informação bancária
     * @param updateInfoBancariaDto Dados para atualização
     * @returns Informação bancária atualizada
     */
    async update(id, updateInfoBancariaDto) {
        try {
            this.logger.log(`Atualizando informação bancária ${id}`);
            // Verifica se a informação bancária existe
            const existingInfo = await this.infoBancariaRepository.findById(id);
            if (!existingInfo) {
                throw new common_1.NotFoundException('Informação bancária não encontrada');
            }
            // Valida chave PIX se fornecida
            if (updateInfoBancariaDto.chave_pix) {
                await this.validateChavePix(updateInfoBancariaDto.chave_pix, updateInfoBancariaDto.tipo_chave_pix);
                // Verifica se a chave PIX já está em uso (excluindo a atual)
                const pixExists = await this.infoBancariaRepository.existsByChavePix(updateInfoBancariaDto.chave_pix, id);
                if (pixExists) {
                    throw new common_1.ConflictException('Chave PIX já está em uso');
                }
            }
            // Valida dados específicos do Banco do Brasil se aplicável
            if (updateInfoBancariaDto.banco === '001') {
                this.validateBancoBrasil(updateInfoBancariaDto);
            }
            const dadosNormalizados = (0, enum_normalizer_util_1.normalizeEnumFields)(updateInfoBancariaDto);
            const updatedInfo = await this.infoBancariaRepository.update(id, dadosNormalizados);
            if (!updatedInfo) {
                throw new common_1.NotFoundException('Informação bancária não encontrada após atualização');
            }
            this.logger.log(`Informação bancária ${id} atualizada com sucesso`);
            return this.mapToResponseDto(updatedInfo);
        }
        catch (error) {
            this.logger.error(`Erro ao atualizar informação bancária ${id}: ${error.message}`, error.stack);
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.ConflictException ||
                error instanceof common_1.BadRequestException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao atualizar informação bancária');
        }
    }
    /**
     * Remove informação bancária (soft delete)
     * @param id ID da informação bancária
     */
    async remove(id) {
        try {
            this.logger.log(`Removendo informação bancária ${id}`);
            const exists = await this.infoBancariaRepository.findById(id);
            if (!exists) {
                throw new common_1.NotFoundException('Informação bancária não encontrada');
            }
            const removed = await this.infoBancariaRepository.remove(id);
            if (!removed) {
                throw new common_1.InternalServerErrorException('Falha ao remover informação bancária');
            }
            this.logger.log(`Informação bancária ${id} removida com sucesso`);
        }
        catch (error) {
            this.logger.error(`Erro ao remover informação bancária ${id}: ${error.message}`, error.stack);
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao remover informação bancária');
        }
    }
    /**
     * Desativa informação bancária
     * @param id ID da informação bancária
     * @returns Informação bancária desativada
     */
    async deactivate(id) {
        try {
            this.logger.log(`Desativando informação bancária ${id}`);
            const deactivated = await this.infoBancariaRepository.deactivate(id);
            if (!deactivated) {
                throw new common_1.NotFoundException('Informação bancária não encontrada');
            }
            this.logger.log(`Informação bancária ${id} desativada com sucesso`);
            return this.mapToResponseDto(deactivated);
        }
        catch (error) {
            this.logger.error(`Erro ao desativar informação bancária ${id}: ${error.message}`, error.stack);
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Erro interno ao desativar informação bancária');
        }
    }
    /**
     * Valida chave PIX
     * @param chavePix Chave PIX
     * @param tipoChave Tipo da chave PIX
     */
    async validateChavePix(chavePix, tipoChave) {
        if (!tipoChave) {
            throw new common_1.BadRequestException('Tipo de chave PIX é obrigatório quando chave PIX é fornecida');
        }
        switch (tipoChave) {
            case info_bancaria_enum_1.TipoChavePix.CPF:
                if (!/^\d{11}$/.test(chavePix)) {
                    throw new common_1.BadRequestException('Chave PIX CPF deve conter 11 dígitos');
                }
                break;
            case info_bancaria_enum_1.TipoChavePix.CNPJ:
                if (!/^\d{14}$/.test(chavePix)) {
                    throw new common_1.BadRequestException('Chave PIX CNPJ deve conter 14 dígitos');
                }
                break;
            case info_bancaria_enum_1.TipoChavePix.EMAIL:
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(chavePix)) {
                    throw new common_1.BadRequestException('Chave PIX email deve ter formato válido');
                }
                break;
            case info_bancaria_enum_1.TipoChavePix.TELEFONE:
                if (!/^\+?[1-9]\d{1,14}$/.test(chavePix.replace(/\D/g, ''))) {
                    throw new common_1.BadRequestException('Chave PIX telefone deve ter formato válido');
                }
                break;
            case info_bancaria_enum_1.TipoChavePix.ALEATORIA:
                if (chavePix.length !== 32) {
                    throw new common_1.BadRequestException('Chave PIX aleatória deve ter 32 caracteres');
                }
                break;
            default:
                throw new common_1.BadRequestException('Tipo de chave PIX inválido');
        }
    }
    /**
     * Valida dados específicos do Banco do Brasil
     * @param data Dados bancários
     */
    validateBancoBrasil(data) {
        // Validações específicas para o Banco do Brasil
        if (data.nome_banco &&
            !data.nome_banco.toLowerCase().includes('banco do brasil')) {
            throw new common_1.BadRequestException('Nome do banco inconsistente com código 001 (Banco do Brasil)');
        }
        // Validação de agência do BB (formato específico)
        if (data.agencia && !/^\d{4}(-\d)?$/.test(data.agencia)) {
            throw new common_1.BadRequestException('Formato de agência inválido para Banco do Brasil');
        }
    }
    /**
     * Mapeia entidade para DTO de resposta
     * @param infoBancaria Entidade de informação bancária
     * @returns DTO de resposta
     */
    mapToResponseDto(infoBancaria) {
        return {
            id: infoBancaria.id,
            cidadao_id: infoBancaria.cidadao_id,
            banco: infoBancaria.banco,
            nome_banco: infoBancaria.nome_banco,
            agencia: infoBancaria.agencia,
            conta: infoBancaria.conta,
            tipo_conta: infoBancaria.tipo_conta,
            chave_pix: infoBancaria.chave_pix,
            tipo_chave_pix: infoBancaria.tipo_chave_pix,
            ativo: infoBancaria.ativo,
            observacoes: infoBancaria.observacoes,
            created_at: infoBancaria.created_at,
            updated_at: infoBancaria.updated_at,
        };
    }
};
exports.InfoBancariaService = InfoBancariaService;
exports.InfoBancariaService = InfoBancariaService = InfoBancariaService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof info_bancaria_repository_1.InfoBancariaRepository !== "undefined" && info_bancaria_repository_1.InfoBancariaRepository) === "function" ? _a : Object, typeof (_b = typeof cidadao_service_1.CidadaoService !== "undefined" && cidadao_service_1.CidadaoService) === "function" ? _b : Object])
], InfoBancariaService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGNpZGFkYW9cXHNlcnZpY2VzXFxpbmZvLWJhbmNhcmlhLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FPd0I7QUFDeEIsdUZBQWtGO0FBQ2xGLHVEQUFtRDtBQUtuRCwwRUFBaUU7QUFDakUscUZBQWlGO0FBQ2pGOzs7Ozs7R0FNRztBQUVJLElBQU0sbUJBQW1CLDJCQUF6QixNQUFNLG1CQUFtQjtJQUlYO0lBQ0E7SUFKRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMscUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFL0QsWUFDbUIsc0JBQThDLEVBQzlDLGNBQThCO1FBRDlCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQzlDLENBQUM7SUFFSjs7OztPQUlHO0lBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FDVixxQkFBNEM7UUFFNUMsSUFBSSxDQUFDO1lBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsNENBQTRDLHFCQUFxQixDQUFDLFVBQVUsRUFBRSxDQUMvRSxDQUFDO1lBRUYsK0JBQStCO1lBQy9CLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQ2hELHFCQUFxQixDQUFDLFVBQVUsQ0FDakMsQ0FBQztZQUNGLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDYixNQUFNLElBQUksMEJBQWlCLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN4RCxDQUFDO1lBRUQsaUVBQWlFO1lBQ2pFLE1BQU0sWUFBWSxHQUNoQixNQUFNLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyx1QkFBdUIsQ0FDdkQscUJBQXFCLENBQUMsVUFBVSxDQUNqQyxDQUFDO1lBQ0osSUFBSSxZQUFZLEVBQUUsQ0FBQztnQkFDakIs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QUFVLEVBQUUsWUFBWSxDQUFDLFVBQVU7WUFDbkMsS0FBSyxFQUFFLFlBQVksQ0FBQyxLQUFLO1lBQ3pCLFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTtZQUNuQyxPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU87WUFDN0IsS0FBSyxFQUFFLFlBQVksQ0FBQyxLQUFLO1lBQ3pCLFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTtZQUNuQyxTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVM7WUFDakMsY0FBYyxFQUFFLFlBQVksQ0FBQyxjQUFjO1lBQzNDLEtBQUssRUFBRSxZQUFZLENBQUMsS0FBSztZQUN6QixXQUFXLEVBQUUsWUFBWSxDQUFDLFdBQVc7WUFDckMsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVO1lBQ25DLFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTtTQUNwQyxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUE1YVksa0RBQW1COzhCQUFuQixtQkFBbUI7SUFEL0IsSUFBQSxtQkFBVSxHQUFFO3lEQUtnQyxpREFBc0Isb0JBQXRCLGlEQUFzQixvREFDOUIsZ0NBQWMsb0JBQWQsZ0NBQWM7R0FMdEMsbUJBQW1CLENBNGEvQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcY2lkYWRhb1xcc2VydmljZXNcXGluZm8tYmFuY2FyaWEuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBMb2dnZXIsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBDb25mbGljdEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5mb0JhbmNhcmlhUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9pbmZvLWJhbmNhcmlhLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgQ2lkYWRhb1NlcnZpY2UgfSBmcm9tICcuL2NpZGFkYW8uc2VydmljZSc7XG5pbXBvcnQgeyBDcmVhdGVJbmZvQmFuY2FyaWFEdG8gfSBmcm9tICcuLi9kdG8vY3JlYXRlLWluZm8tYmFuY2FyaWEuZHRvJztcbmltcG9ydCB7IFVwZGF0ZUluZm9CYW5jYXJpYUR0byB9IGZyb20gJy4uL2R0by91cGRhdGUtaW5mby1iYW5jYXJpYS5kdG8nO1xuaW1wb3J0IHsgSW5mb0JhbmNhcmlhUmVzcG9uc2VEdG8gfSBmcm9tICcuLi9kdG8vaW5mby1iYW5jYXJpYS1yZXNwb25zZS5kdG8nO1xuaW1wb3J0IHsgSW5mb0JhbmNhcmlhIH0gZnJvbSAnLi4vLi4vLi4vZW50aXRpZXMvaW5mby1iYW5jYXJpYS5lbnRpdHknO1xuaW1wb3J0IHsgVGlwb0NoYXZlUGl4IH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvaW5mby1iYW5jYXJpYS5lbnVtJztcbmltcG9ydCB7IG5vcm1hbGl6ZUVudW1GaWVsZHMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvZW51bS1ub3JtYWxpemVyLnV0aWwnO1xuLyoqXG4gKiBTZXJ2aWNlIHBhcmEgZ2VyZW5jaWFtZW50byBkZSBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXNcbiAqXG4gKiBSZXNwb25zw6F2ZWwgcGVsYSBsw7NnaWNhIGRlIG5lZ8OzY2lvIHJlbGFjaW9uYWRhIMOgcyBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXMgZG9zIGNpZGFkw6NvcyxcbiAqIGluY2x1aW5kbyB2YWxpZGHDp8O1ZXMgZXNwZWPDrWZpY2FzIHBhcmEgY29udGFzIHBvdXBhbsOnYSBzb2NpYWwgZG8gQmFuY28gZG8gQnJhc2lsXG4gKiBlIGNoYXZlcyBQSVguXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJbmZvQmFuY2FyaWFTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEluZm9CYW5jYXJpYVNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbmZvQmFuY2FyaWFSZXBvc2l0b3J5OiBJbmZvQmFuY2FyaWFSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2lkYWRhb1NlcnZpY2U6IENpZGFkYW9TZXJ2aWNlLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyaWEgdW1hIG5vdmEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gY3JlYXRlSW5mb0JhbmNhcmlhRHRvIERhZG9zIHBhcmEgY3JpYcOnw6NvXG4gICAqIEByZXR1cm5zIEluZm9ybWHDp8OjbyBiYW5jw6FyaWEgY3JpYWRhXG4gICAqL1xuICBhc3luYyBjcmVhdGUoXG4gICAgY3JlYXRlSW5mb0JhbmNhcmlhRHRvOiBDcmVhdGVJbmZvQmFuY2FyaWFEdG8sXG4gICk6IFByb21pc2U8SW5mb0JhbmNhcmlhUmVzcG9uc2VEdG8+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgQ3JpYW5kbyBpbmZvcm1hw6fDo28gYmFuY8OhcmlhIHBhcmEgY2lkYWTDo28gJHtjcmVhdGVJbmZvQmFuY2FyaWFEdG8uY2lkYWRhb19pZH1gLFxuICAgICAgKTtcblxuICAgICAgLy8gVmVyaWZpY2Egc2UgbyBjaWRhZMOjbyBleGlzdGVcbiAgICAgIGNvbnN0IGNpZGFkYW8gPSBhd2FpdCB0aGlzLmNpZGFkYW9TZXJ2aWNlLmZpbmRCeUlkKFxuICAgICAgICBjcmVhdGVJbmZvQmFuY2FyaWFEdG8uY2lkYWRhb19pZCxcbiAgICAgICk7XG4gICAgICBpZiAoIWNpZGFkYW8pIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDaWRhZMOjbyBuw6NvIGVuY29udHJhZG8nKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZpY2Egc2UgasOhIGV4aXN0ZSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhIGF0aXZhIHBhcmEgbyBjaWRhZMOjb1xuICAgICAgY29uc3QgZXhpc3RpbmdJbmZvID1cbiAgICAgICAgYXdhaXQgdGhpcy5pbmZvQmFuY2FyaWFSZXBvc2l0b3J5LmV4aXN0c0FjdGl2ZUJ5Q2lkYWRhb0lkKFxuICAgICAgICAgIGNyZWF0ZUluZm9CYW5jYXJpYUR0by5jaWRhZGFvX2lkLFxuICAgICAgICApO1xuICAgICAgaWYgKGV4aXN0aW5nSW5mbykge1xuICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0NpZGFkw6NvIGrDoSBwb3NzdWkgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBhdGl2YScsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYSBjaGF2ZSBQSVggc2UgZm9ybmVjaWRhXG4gICAgICBpZiAoY3JlYXRlSW5mb0JhbmNhcmlhRHRvLmNoYXZlX3BpeCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlQ2hhdmVQaXgoXG4gICAgICAgICAgY3JlYXRlSW5mb0JhbmNhcmlhRHRvLmNoYXZlX3BpeCxcbiAgICAgICAgICBjcmVhdGVJbmZvQmFuY2FyaWFEdG8udGlwb19jaGF2ZV9waXgsXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2Egc2UgYSBjaGF2ZSBQSVggasOhIGVzdMOhIGVtIHVzb1xuICAgICAgICBjb25zdCBwaXhFeGlzdHMgPSBhd2FpdCB0aGlzLmluZm9CYW5jYXJpYVJlcG9zaXRvcnkuZXhpc3RzQnlDaGF2ZVBpeChcbiAgICAgICAgICBjcmVhdGVJbmZvQmFuY2FyaWFEdG8uY2hhdmVfcGl4LFxuICAgICAgICApO1xuICAgICAgICBpZiAocGl4RXhpc3RzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKCdDaGF2ZSBQSVggasOhIGVzdMOhIGVtIHVzbycpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYSBkYWRvcyBlc3BlY8OtZmljb3MgZG8gQmFuY28gZG8gQnJhc2lsIHNlIGFwbGljw6F2ZWxcbiAgICAgIGlmIChjcmVhdGVJbmZvQmFuY2FyaWFEdG8uYmFuY28gPT09ICcwMDEnKSB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVCYW5jb0JyYXNpbChjcmVhdGVJbmZvQmFuY2FyaWFEdG8pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYWRvc05vcm1hbGl6YWRvcyA9IG5vcm1hbGl6ZUVudW1GaWVsZHMoY3JlYXRlSW5mb0JhbmNhcmlhRHRvKTtcbiAgICAgIGNvbnN0IGluZm9CYW5jYXJpYSA9XG4gICAgICAgIGF3YWl0IHRoaXMuaW5mb0JhbmNhcmlhUmVwb3NpdG9yeS5jcmVhdGUoZGFkb3NOb3JtYWxpemFkb3MpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGNyaWFkYSBjb20gc3VjZXNzbzogJHtpbmZvQmFuY2FyaWEuaWR9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gdGhpcy5tYXBUb1Jlc3BvbnNlRHRvKGluZm9CYW5jYXJpYSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBjcmlhciBpbmZvcm1hw6fDo28gYmFuY8OhcmlhOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uIHx8XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQ29uZmxpY3RFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJubyBhbyBjcmlhciBpbmZvcm1hw6fDo28gYmFuY8OhcmlhJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHRvZGFzIGFzIGluZm9ybWHDp8O1ZXMgYmFuY8OhcmlhcyBjb20gZmlsdHJvc1xuICAgKiBAcGFyYW0gb3B0aW9ucyBPcMOnw7VlcyBkZSBmaWx0cm8gZSBwYWdpbmHDp8Ojb1xuICAgKiBAcmV0dXJucyBMaXN0YSBwYWdpbmFkYSBkZSBpbmZvcm1hw6fDtWVzIGJhbmPDoXJpYXNcbiAgICovXG4gIGFzeW5jIGZpbmRBbGwob3B0aW9ucz86IHtcbiAgICBza2lwPzogbnVtYmVyO1xuICAgIHRha2U/OiBudW1iZXI7XG4gICAgY2lkYWRhb19pZD86IHN0cmluZztcbiAgICBiYW5jbz86IHN0cmluZztcbiAgICBhdGl2bz86IGJvb2xlYW47XG4gICAgaW5jbHVkZVJlbGF0aW9ucz86IGJvb2xlYW47XG4gIH0pOiBQcm9taXNlPHsgZGF0YTogSW5mb0JhbmNhcmlhUmVzcG9uc2VEdG9bXTsgdG90YWw6IG51bWJlciB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtpbmZvc0JhbmNhcmlhcywgdG90YWxdID0gYXdhaXQgdGhpcy5pbmZvQmFuY2FyaWFSZXBvc2l0b3J5LmZpbmRBbGwoXG4gICAgICAgIHtcbiAgICAgICAgICBza2lwOiBvcHRpb25zPy5za2lwLFxuICAgICAgICAgIHRha2U6IG9wdGlvbnM/LnRha2UsXG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGNpZGFkYW9faWQ6IG9wdGlvbnM/LmNpZGFkYW9faWQsXG4gICAgICAgICAgICBiYW5jbzogb3B0aW9ucz8uYmFuY28sXG4gICAgICAgICAgICBhdGl2bzogb3B0aW9ucz8uYXRpdm8sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmNsdWRlUmVsYXRpb25zOiBvcHRpb25zPy5pbmNsdWRlUmVsYXRpb25zLFxuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGF0YTogaW5mb3NCYW5jYXJpYXMubWFwKChpbmZvKSA9PiB0aGlzLm1hcFRvUmVzcG9uc2VEdG8oaW5mbykpLFxuICAgICAgICB0b3RhbCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBidXNjYXIgaW5mb3JtYcOnw7VlcyBiYW5jw6FyaWFzOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdFcnJvIGludGVybm8gYW8gYnVzY2FyIGluZm9ybWHDp8O1ZXMgYmFuY8OhcmlhcycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCdXNjYSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhIHBvciBJRFxuICAgKiBAcGFyYW0gaWQgSUQgZGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gaW5jbHVkZVJlbGF0aW9ucyBTZSBkZXZlIGluY2x1aXIgcmVsYcOnw7Vlc1xuICAgKiBAcmV0dXJucyBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGVuY29udHJhZGFcbiAgICovXG4gIGFzeW5jIGZpbmRCeUlkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgaW5jbHVkZVJlbGF0aW9ucyA9IGZhbHNlLFxuICApOiBQcm9taXNlPEluZm9CYW5jYXJpYVJlc3BvbnNlRHRvPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGluZm9CYW5jYXJpYSA9IGF3YWl0IHRoaXMuaW5mb0JhbmNhcmlhUmVwb3NpdG9yeS5maW5kQnlJZChcbiAgICAgICAgaWQsXG4gICAgICAgIGluY2x1ZGVSZWxhdGlvbnMsXG4gICAgICApO1xuICAgICAgaWYgKCFpbmZvQmFuY2FyaWEpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdJbmZvcm1hw6fDo28gYmFuY8OhcmlhIG7Do28gZW5jb250cmFkYScpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMubWFwVG9SZXNwb25zZUR0byhpbmZvQmFuY2FyaWEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gYnVzY2FyIGluZm9ybWHDp8OjbyBiYW5jw6FyaWEgJHtpZH06ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRXJybyBpbnRlcm5vIGFvIGJ1c2NhciBpbmZvcm1hw6fDo28gYmFuY8OhcmlhJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIGluZm9ybWHDp8OjbyBiYW5jw6FyaWEgcG9yIElEIGRvIGNpZGFkw6NvXG4gICAqIEBwYXJhbSBjaWRhZGFvSWQgSUQgZG8gY2lkYWTDo29cbiAgICogQHBhcmFtIGluY2x1ZGVSZWxhdGlvbnMgU2UgZGV2ZSBpbmNsdWlyIHJlbGHDp8O1ZXNcbiAgICogQHJldHVybnMgSW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBkbyBjaWRhZMOjb1xuICAgKi9cbiAgYXN5bmMgZmluZEJ5Q2lkYWRhb0lkKFxuICAgIGNpZGFkYW9JZDogc3RyaW5nLFxuICAgIGluY2x1ZGVSZWxhdGlvbnMgPSBmYWxzZSxcbiAgKTogUHJvbWlzZTxJbmZvQmFuY2FyaWFSZXNwb25zZUR0byB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaW5mb0JhbmNhcmlhID0gYXdhaXQgdGhpcy5pbmZvQmFuY2FyaWFSZXBvc2l0b3J5LmZpbmRCeUNpZGFkYW9JZChcbiAgICAgICAgY2lkYWRhb0lkLFxuICAgICAgICBpbmNsdWRlUmVsYXRpb25zLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBpbmZvQmFuY2FyaWEgPyB0aGlzLm1hcFRvUmVzcG9uc2VEdG8oaW5mb0JhbmNhcmlhKSA6IG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBidXNjYXIgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBkbyBjaWRhZMOjbyAke2NpZGFkYW9JZH06ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJubyBhbyBidXNjYXIgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBkbyBjaWRhZMOjbycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBdHVhbGl6YSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhXG4gICAqIEBwYXJhbSBpZCBJRCBkYSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhXG4gICAqIEBwYXJhbSB1cGRhdGVJbmZvQmFuY2FyaWFEdG8gRGFkb3MgcGFyYSBhdHVhbGl6YcOnw6NvXG4gICAqIEByZXR1cm5zIEluZm9ybWHDp8OjbyBiYW5jw6FyaWEgYXR1YWxpemFkYVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlSW5mb0JhbmNhcmlhRHRvOiBVcGRhdGVJbmZvQmFuY2FyaWFEdG8sXG4gICk6IFByb21pc2U8SW5mb0JhbmNhcmlhUmVzcG9uc2VEdG8+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBBdHVhbGl6YW5kbyBpbmZvcm1hw6fDo28gYmFuY8OhcmlhICR7aWR9YCk7XG5cbiAgICAgIC8vIFZlcmlmaWNhIHNlIGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSBleGlzdGVcbiAgICAgIGNvbnN0IGV4aXN0aW5nSW5mbyA9IGF3YWl0IHRoaXMuaW5mb0JhbmNhcmlhUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG4gICAgICBpZiAoIWV4aXN0aW5nSW5mbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0luZm9ybWHDp8OjbyBiYW5jw6FyaWEgbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYSBjaGF2ZSBQSVggc2UgZm9ybmVjaWRhXG4gICAgICBpZiAodXBkYXRlSW5mb0JhbmNhcmlhRHRvLmNoYXZlX3BpeCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlQ2hhdmVQaXgoXG4gICAgICAgICAgdXBkYXRlSW5mb0JhbmNhcmlhRHRvLmNoYXZlX3BpeCxcbiAgICAgICAgICB1cGRhdGVJbmZvQmFuY2FyaWFEdG8udGlwb19jaGF2ZV9waXgsXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gVmVyaWZpY2Egc2UgYSBjaGF2ZSBQSVggasOhIGVzdMOhIGVtIHVzbyAoZXhjbHVpbmRvIGEgYXR1YWwpXG4gICAgICAgIGNvbnN0IHBpeEV4aXN0cyA9IGF3YWl0IHRoaXMuaW5mb0JhbmNhcmlhUmVwb3NpdG9yeS5leGlzdHNCeUNoYXZlUGl4KFxuICAgICAgICAgIHVwZGF0ZUluZm9CYW5jYXJpYUR0by5jaGF2ZV9waXgsXG4gICAgICAgICAgaWQsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChwaXhFeGlzdHMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oJ0NoYXZlIFBJWCBqw6EgZXN0w6EgZW0gdXNvJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhIGRhZG9zIGVzcGVjw61maWNvcyBkbyBCYW5jbyBkbyBCcmFzaWwgc2UgYXBsaWPDoXZlbFxuICAgICAgaWYgKHVwZGF0ZUluZm9CYW5jYXJpYUR0by5iYW5jbyA9PT0gJzAwMScpIHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZUJhbmNvQnJhc2lsKHVwZGF0ZUluZm9CYW5jYXJpYUR0byk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRhZG9zTm9ybWFsaXphZG9zID0gbm9ybWFsaXplRW51bUZpZWxkcyh1cGRhdGVJbmZvQmFuY2FyaWFEdG8pO1xuICAgICAgY29uc3QgdXBkYXRlZEluZm8gPSBhd2FpdCB0aGlzLmluZm9CYW5jYXJpYVJlcG9zaXRvcnkudXBkYXRlKFxuICAgICAgICBpZCxcbiAgICAgICAgZGFkb3NOb3JtYWxpemFkb3MsXG4gICAgICApO1xuICAgICAgaWYgKCF1cGRhdGVkSW5mbykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgICAgJ0luZm9ybWHDp8OjbyBiYW5jw6FyaWEgbsOjbyBlbmNvbnRyYWRhIGFww7NzIGF0dWFsaXphw6fDo28nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEluZm9ybWHDp8OjbyBiYW5jw6FyaWEgJHtpZH0gYXR1YWxpemFkYSBjb20gc3VjZXNzb2ApO1xuICAgICAgcmV0dXJuIHRoaXMubWFwVG9SZXNwb25zZUR0byh1cGRhdGVkSW5mbyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJybyBhbyBhdHVhbGl6YXIgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSAke2lkfTogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGVycm9yLnN0YWNrLFxuICAgICAgKTtcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIENvbmZsaWN0RXhjZXB0aW9uIHx8XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQmFkUmVxdWVzdEV4Y2VwdGlvblxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdFcnJvIGludGVybm8gYW8gYXR1YWxpemFyIGluZm9ybWHDp8OjbyBiYW5jw6FyaWEnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGluZm9ybWHDp8OjbyBiYW5jw6FyaWEgKHNvZnQgZGVsZXRlKVxuICAgKiBAcGFyYW0gaWQgSUQgZGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlKGlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBSZW1vdmVuZG8gaW5mb3JtYcOnw6NvIGJhbmPDoXJpYSAke2lkfWApO1xuXG4gICAgICBjb25zdCBleGlzdHMgPSBhd2FpdCB0aGlzLmluZm9CYW5jYXJpYVJlcG9zaXRvcnkuZmluZEJ5SWQoaWQpO1xuICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdJbmZvcm1hw6fDo28gYmFuY8OhcmlhIG7Do28gZW5jb250cmFkYScpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZW1vdmVkID0gYXdhaXQgdGhpcy5pbmZvQmFuY2FyaWFSZXBvc2l0b3J5LnJlbW92ZShpZCk7XG4gICAgICBpZiAoIXJlbW92ZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICAgJ0ZhbGhhIGFvIHJlbW92ZXIgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYScsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgSW5mb3JtYcOnw6NvIGJhbmPDoXJpYSAke2lkfSByZW1vdmlkYSBjb20gc3VjZXNzb2ApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gcmVtb3ZlciBpbmZvcm1hw6fDo28gYmFuY8OhcmlhICR7aWR9OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJubyBhbyByZW1vdmVyIGluZm9ybWHDp8OjbyBiYW5jw6FyaWEnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVzYXRpdmEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcGFyYW0gaWQgSUQgZGEgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYVxuICAgKiBAcmV0dXJucyBJbmZvcm1hw6fDo28gYmFuY8OhcmlhIGRlc2F0aXZhZGFcbiAgICovXG4gIGFzeW5jIGRlYWN0aXZhdGUoaWQ6IHN0cmluZyk6IFByb21pc2U8SW5mb0JhbmNhcmlhUmVzcG9uc2VEdG8+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBEZXNhdGl2YW5kbyBpbmZvcm1hw6fDo28gYmFuY8OhcmlhICR7aWR9YCk7XG5cbiAgICAgIGNvbnN0IGRlYWN0aXZhdGVkID0gYXdhaXQgdGhpcy5pbmZvQmFuY2FyaWFSZXBvc2l0b3J5LmRlYWN0aXZhdGUoaWQpO1xuICAgICAgaWYgKCFkZWFjdGl2YXRlZCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0luZm9ybWHDp8OjbyBiYW5jw6FyaWEgbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgSW5mb3JtYcOnw6NvIGJhbmPDoXJpYSAke2lkfSBkZXNhdGl2YWRhIGNvbSBzdWNlc3NvYCk7XG4gICAgICByZXR1cm4gdGhpcy5tYXBUb1Jlc3BvbnNlRHRvKGRlYWN0aXZhdGVkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvIGFvIGRlc2F0aXZhciBpbmZvcm1hw6fDo28gYmFuY8OhcmlhICR7aWR9OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0Vycm8gaW50ZXJubyBhbyBkZXNhdGl2YXIgaW5mb3JtYcOnw6NvIGJhbmPDoXJpYScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGEgY2hhdmUgUElYXG4gICAqIEBwYXJhbSBjaGF2ZVBpeCBDaGF2ZSBQSVhcbiAgICogQHBhcmFtIHRpcG9DaGF2ZSBUaXBvIGRhIGNoYXZlIFBJWFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZUNoYXZlUGl4KFxuICAgIGNoYXZlUGl4OiBzdHJpbmcsXG4gICAgdGlwb0NoYXZlPzogVGlwb0NoYXZlUGl4LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRpcG9DaGF2ZSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdUaXBvIGRlIGNoYXZlIFBJWCDDqSBvYnJpZ2F0w7NyaW8gcXVhbmRvIGNoYXZlIFBJWCDDqSBmb3JuZWNpZGEnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHRpcG9DaGF2ZSkge1xuICAgICAgY2FzZSBUaXBvQ2hhdmVQaXguQ1BGOlxuICAgICAgICBpZiAoIS9eXFxkezExfSQvLnRlc3QoY2hhdmVQaXgpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0NoYXZlIFBJWCBDUEYgZGV2ZSBjb250ZXIgMTEgZMOtZ2l0b3MnKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVGlwb0NoYXZlUGl4LkNOUEo6XG4gICAgICAgIGlmICghL15cXGR7MTR9JC8udGVzdChjaGF2ZVBpeCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdDaGF2ZSBQSVggQ05QSiBkZXZlIGNvbnRlciAxNCBkw61naXRvcycsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVGlwb0NoYXZlUGl4LkVNQUlMOlxuICAgICAgICBjb25zdCBlbWFpbFJlZ2V4ID0gL15bXlxcc0BdK0BbXlxcc0BdK1xcLlteXFxzQF0rJC87XG4gICAgICAgIGlmICghZW1haWxSZWdleC50ZXN0KGNoYXZlUGl4KSkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0NoYXZlIFBJWCBlbWFpbCBkZXZlIHRlciBmb3JtYXRvIHbDoWxpZG8nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRpcG9DaGF2ZVBpeC5URUxFRk9ORTpcbiAgICAgICAgaWYgKCEvXlxcKz9bMS05XVxcZHsxLDE0fSQvLnRlc3QoY2hhdmVQaXgucmVwbGFjZSgvXFxEL2csICcnKSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdDaGF2ZSBQSVggdGVsZWZvbmUgZGV2ZSB0ZXIgZm9ybWF0byB2w6FsaWRvJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUaXBvQ2hhdmVQaXguQUxFQVRPUklBOlxuICAgICAgICBpZiAoY2hhdmVQaXgubGVuZ3RoICE9PSAzMikge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ0NoYXZlIFBJWCBhbGVhdMOzcmlhIGRldmUgdGVyIDMyIGNhcmFjdGVyZXMnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVGlwbyBkZSBjaGF2ZSBQSVggaW52w6FsaWRvJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYSBkYWRvcyBlc3BlY8OtZmljb3MgZG8gQmFuY28gZG8gQnJhc2lsXG4gICAqIEBwYXJhbSBkYXRhIERhZG9zIGJhbmPDoXJpb3NcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVCYW5jb0JyYXNpbChkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICAvLyBWYWxpZGHDp8O1ZXMgZXNwZWPDrWZpY2FzIHBhcmEgbyBCYW5jbyBkbyBCcmFzaWxcbiAgICBpZiAoXG4gICAgICBkYXRhLm5vbWVfYmFuY28gJiZcbiAgICAgICFkYXRhLm5vbWVfYmFuY28udG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnYmFuY28gZG8gYnJhc2lsJylcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnTm9tZSBkbyBiYW5jbyBpbmNvbnNpc3RlbnRlIGNvbSBjw7NkaWdvIDAwMSAoQmFuY28gZG8gQnJhc2lsKScsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYcOnw6NvIGRlIGFnw6puY2lhIGRvIEJCIChmb3JtYXRvIGVzcGVjw61maWNvKVxuICAgIGlmIChkYXRhLmFnZW5jaWEgJiYgIS9eXFxkezR9KC1cXGQpPyQvLnRlc3QoZGF0YS5hZ2VuY2lhKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdGb3JtYXRvIGRlIGFnw6puY2lhIGludsOhbGlkbyBwYXJhIEJhbmNvIGRvIEJyYXNpbCcsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNYXBlaWEgZW50aWRhZGUgcGFyYSBEVE8gZGUgcmVzcG9zdGFcbiAgICogQHBhcmFtIGluZm9CYW5jYXJpYSBFbnRpZGFkZSBkZSBpbmZvcm1hw6fDo28gYmFuY8OhcmlhXG4gICAqIEByZXR1cm5zIERUTyBkZSByZXNwb3N0YVxuICAgKi9cbiAgcHJpdmF0ZSBtYXBUb1Jlc3BvbnNlRHRvKFxuICAgIGluZm9CYW5jYXJpYTogSW5mb0JhbmNhcmlhLFxuICApOiBJbmZvQmFuY2FyaWFSZXNwb25zZUR0byB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBpbmZvQmFuY2FyaWEuaWQsXG4gICAgICBjaWRhZGFvX2lkOiBpbmZvQmFuY2FyaWEuY2lkYWRhb19pZCxcbiAgICAgIGJhbmNvOiBpbmZvQmFuY2FyaWEuYmFuY28sXG4gICAgICBub21lX2JhbmNvOiBpbmZvQmFuY2FyaWEubm9tZV9iYW5jbyxcbiAgICAgIGFnZW5jaWE6IGluZm9CYW5jYXJpYS5hZ2VuY2lhLFxuICAgICAgY29udGE6IGluZm9CYW5jYXJpYS5jb250YSxcbiAgICAgIHRpcG9fY29udGE6IGluZm9CYW5jYXJpYS50aXBvX2NvbnRhLFxuICAgICAgY2hhdmVfcGl4OiBpbmZvQmFuY2FyaWEuY2hhdmVfcGl4LFxuICAgICAgdGlwb19jaGF2ZV9waXg6IGluZm9CYW5jYXJpYS50aXBvX2NoYXZlX3BpeCxcbiAgICAgIGF0aXZvOiBpbmZvQmFuY2FyaWEuYXRpdm8sXG4gICAgICBvYnNlcnZhY29lczogaW5mb0JhbmNhcmlhLm9ic2VydmFjb2VzLFxuICAgICAgY3JlYXRlZF9hdDogaW5mb0JhbmNhcmlhLmNyZWF0ZWRfYXQsXG4gICAgICB1cGRhdGVkX2F0OiBpbmZvQmFuY2FyaWEudXBkYXRlZF9hdCxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=