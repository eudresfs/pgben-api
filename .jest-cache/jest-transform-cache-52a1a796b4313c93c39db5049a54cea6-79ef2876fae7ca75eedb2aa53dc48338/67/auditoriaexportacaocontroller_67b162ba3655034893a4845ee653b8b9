7d141fef8beefd5d5aca38579b9e6b26
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var AuditoriaExportacaoController_1;
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditoriaExportacaoController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const express_1 = require("express");
const auditoria_exportacao_service_1 = require("../services/auditoria-exportacao.service");
const query_log_auditoria_dto_1 = require("../dto/query-log-auditoria.dto");
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
/**
 * DTO para solicitação de exportação
 */
class SolicitarExportacaoDto {
    /**
     * Formato de exportação
     */
    formato;
    /**
     * Indica se o arquivo deve ser comprimido
     */
    comprimido;
    /**
     * Campos a serem incluídos na exportação
     */
    campos;
}
/**
 * Controlador para exportação de logs de auditoria
 */
let AuditoriaExportacaoController = AuditoriaExportacaoController_1 = class AuditoriaExportacaoController {
    auditoriaExportacaoService;
    logger = new common_1.Logger(AuditoriaExportacaoController_1.name);
    constructor(auditoriaExportacaoService) {
        this.auditoriaExportacaoService = auditoriaExportacaoService;
    }
    /**
     * Exporta logs de auditoria para o formato especificado
     */
    async exportarLogs(filtros, opcoes, res) {
        try {
            this.logger.log(`Solicitação de exportação recebida: ${opcoes.formato}`);
            // Validar formato
            if (!Object.values(auditoria_exportacao_service_1.FormatoExportacao).includes(opcoes.formato)) {
                throw new common_1.HttpException(`Formato de exportação inválido. Formatos disponíveis: ${Object.values(auditoria_exportacao_service_1.FormatoExportacao).join(', ')}`, common_1.HttpStatus.BAD_REQUEST);
            }
            // Configurar opções de exportação
            const opcoesExportacao = {
                formato: opcoes.formato,
                comprimido: opcoes.comprimido || false,
                campos: opcoes.campos,
            };
            // Iniciar exportação assíncrona
            this.auditoriaExportacaoService
                .exportarLogs(filtros, opcoesExportacao)
                .then((resultado) => {
                this.logger.log(`Exportação concluída: ${resultado.caminhoArquivo}`);
            })
                .catch((error) => {
                this.logger.error(`Erro na exportação: ${error.message}`, error.stack);
            });
            // Retornar resposta imediata
            return res.status(common_1.HttpStatus.ACCEPTED).json({
                mensagem: 'Exportação iniciada com sucesso',
                formato: opcoes.formato,
                filtros,
            });
        }
        catch (error) {
            this.logger.error(`Erro ao iniciar exportação: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Baixa um arquivo de exportação pelo nome
     */
    async downloadArquivo(nomeArquivo, res) {
        try {
            const diretorioExportacao = process.env.AUDITORIA_EXPORT_DIR ||
                path.join(process.cwd(), 'exports', 'auditoria');
            const caminhoArquivo = path.join(diretorioExportacao, nomeArquivo);
            // Verificar se o arquivo existe
            if (!fs.existsSync(caminhoArquivo)) {
                throw new common_1.HttpException('Arquivo não encontrado', common_1.HttpStatus.NOT_FOUND);
            }
            // Determinar o tipo de conteúdo
            let contentType = 'application/octet-stream';
            if (nomeArquivo.endsWith('.json')) {
                contentType = 'application/json';
            }
            else if (nomeArquivo.endsWith('.csv')) {
                contentType = 'text/csv';
            }
            else if (nomeArquivo.endsWith('.xlsx')) {
                contentType =
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
            }
            else if (nomeArquivo.endsWith('.pdf')) {
                contentType = 'application/pdf';
            }
            else if (nomeArquivo.endsWith('.gz')) {
                contentType = 'application/gzip';
            }
            // Configurar cabeçalhos
            res.setHeader('Content-Type', contentType);
            res.setHeader('Content-Disposition', `attachment; filename="${nomeArquivo}"`);
            // Enviar arquivo
            const fileStream = fs.createReadStream(caminhoArquivo);
            fileStream.pipe(res);
        }
        catch (error) {
            this.logger.error(`Erro ao baixar arquivo: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Lista os arquivos de exportação disponíveis
     */
    async listarArquivos() {
        try {
            const diretorioExportacao = process.env.AUDITORIA_EXPORT_DIR ||
                path.join(process.cwd(), 'exports', 'auditoria');
            // Verificar se o diretório existe
            if (!fs.existsSync(diretorioExportacao)) {
                return { arquivos: [] };
            }
            // Listar arquivos
            const arquivos = fs
                .readdirSync(diretorioExportacao)
                .filter((arquivo) => {
                // Filtrar apenas arquivos de exportação
                return arquivo.startsWith('auditoria_export_');
            })
                .map((arquivo) => {
                const caminhoCompleto = path.join(diretorioExportacao, arquivo);
                const stats = fs.statSync(caminhoCompleto);
                return {
                    nome: arquivo,
                    tamanho: stats.size,
                    dataModificacao: stats.mtime,
                    formato: this.determinarFormato(arquivo),
                };
            })
                .sort((a, b) => b.dataModificacao.getTime() - a.dataModificacao.getTime());
            return { arquivos };
        }
        catch (error) {
            this.logger.error(`Erro ao listar arquivos: ${error.message}`, error.stack);
            throw error;
        }
    }
    /**
     * Determina o formato de um arquivo com base no nome
     *
     * @param nomeArquivo Nome do arquivo
     * @returns Formato do arquivo
     */
    determinarFormato(nomeArquivo) {
        if (nomeArquivo.endsWith('.json.gz')) {
            return 'JSON (comprimido)';
        }
        else if (nomeArquivo.endsWith('.json')) {
            return 'JSON';
        }
        else if (nomeArquivo.endsWith('.csv.gz')) {
            return 'CSV (comprimido)';
        }
        else if (nomeArquivo.endsWith('.csv')) {
            return 'CSV';
        }
        else if (nomeArquivo.endsWith('.xlsx')) {
            return 'Excel';
        }
        else if (nomeArquivo.endsWith('.pdf')) {
            return 'PDF';
        }
        else {
            return 'Desconhecido';
        }
    }
};
exports.AuditoriaExportacaoController = AuditoriaExportacaoController;
__decorate([
    (0, common_1.Post)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Exporta logs de auditoria para o formato especificado',
    }),
    (0, swagger_1.ApiBody)({ type: SolicitarExportacaoDto }),
    (0, swagger_1.ApiResponse)({ status: 201, description: 'Exportação iniciada com sucesso' }),
    __param(0, (0, common_1.Query)()),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_b = typeof query_log_auditoria_dto_1.QueryLogAuditoriaDto !== "undefined" && query_log_auditoria_dto_1.QueryLogAuditoriaDto) === "function" ? _b : Object, SolicitarExportacaoDto, typeof (_c = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _c : Object]),
    __metadata("design:returntype", Promise)
], AuditoriaExportacaoController.prototype, "exportarLogs", null);
__decorate([
    (0, common_1.Get)('download/:nomeArquivo'),
    (0, swagger_1.ApiOperation)({ summary: 'Baixa um arquivo de exportação pelo nome' }),
    (0, swagger_1.ApiParam)({
        name: 'nomeArquivo',
        description: 'Nome do arquivo de exportação',
    }),
    (0, swagger_1.ApiResponse)({ status: 200, description: 'Arquivo encontrado e enviado' }),
    (0, swagger_1.ApiResponse)({ status: 404, description: 'Arquivo não encontrado' }),
    __param(0, (0, common_1.Query)('nomeArquivo')),
    __param(1, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, typeof (_d = typeof express_1.Response !== "undefined" && express_1.Response) === "function" ? _d : Object]),
    __metadata("design:returntype", Promise)
], AuditoriaExportacaoController.prototype, "downloadArquivo", null);
__decorate([
    (0, common_1.Get)('arquivos'),
    (0, swagger_1.ApiOperation)({ summary: 'Lista os arquivos de exportação disponíveis' }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Lista de arquivos retornada com sucesso',
    }),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], AuditoriaExportacaoController.prototype, "listarArquivos", null);
exports.AuditoriaExportacaoController = AuditoriaExportacaoController = AuditoriaExportacaoController_1 = __decorate([
    (0, swagger_1.ApiTags)('Auditoria'),
    (0, common_1.Controller)('auditoria/exportacao'),
    __metadata("design:paramtypes", [typeof (_a = typeof auditoria_exportacao_service_1.AuditoriaExportacaoService !== "undefined" && auditoria_exportacao_service_1.AuditoriaExportacaoService) === "function" ? _a : Object])
], AuditoriaExportacaoController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXGF1ZGl0b3JpYVxcY29udHJvbGxlcnNcXGF1ZGl0b3JpYS1leHBvcnRhY2FvLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FVd0I7QUFDeEIsNkNBT3lCO0FBQ3pCLHFDQUFtQztBQUNuQywyRkFJa0Q7QUFDbEQsNEVBQXNFO0FBQ3RFLHVDQUF5QjtBQUN6QiwyQ0FBNkI7QUFFN0I7O0dBRUc7QUFDSCxNQUFNLHNCQUFzQjtJQUMxQjs7T0FFRztJQUNILE9BQU8sQ0FBb0I7SUFFM0I7O09BRUc7SUFDSCxVQUFVLENBQVc7SUFFckI7O09BRUc7SUFDSCxNQUFNLENBQVk7Q0FDbkI7QUFFRDs7R0FFRztBQUdJLElBQU0sNkJBQTZCLHFDQUFuQyxNQUFNLDZCQUE2QjtJQUlyQjtJQUhGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQywrQkFBNkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV6RSxZQUNtQiwwQkFBc0Q7UUFBdEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtJQUN0RSxDQUFDO0lBRUo7O09BRUc7SUFPRyxBQUFOLEtBQUssQ0FBQyxZQUFZLENBQ1AsT0FBNkIsRUFDOUIsTUFBOEIsRUFDL0IsR0FBYTtRQUVwQixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1Q0FBdUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFFekUsa0JBQWtCO1lBQ2xCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGdEQUFpQixDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUMvRCxNQUFNLElBQUksc0JBQWEsQ0FDckIseURBQXlELE1BQU0sQ0FB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QUFJLEVBQUUsYUFBYTtRQUNuQixXQUFXLEVBQUUsK0JBQStCO0tBQzdDLENBQUM7SUFDRCxJQUFBLHFCQUFXLEVBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSw4QkFBOEIsRUFBRSxDQUFDO0lBQ3pFLElBQUEscUJBQVcsRUFBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLHdCQUF3QixFQUFFLENBQUM7SUFFakUsV0FBQSxJQUFBLGNBQUssRUFBQyxhQUFhLENBQUMsQ0FBQTtJQUNwQixXQUFBLElBQUEsWUFBRyxHQUFFLENBQUE7O2lFQUFNLGtCQUFRLG9CQUFSLGtCQUFROztvRUErQ3JCO0FBV0s7SUFOTCxJQUFBLFlBQUcsRUFBQyxVQUFVLENBQUM7SUFDZixJQUFBLHNCQUFZLEVBQUMsRUFBRSxPQUFPLEVBQUUsNkNBQTZDLEVBQUUsQ0FBQztJQUN4RSxJQUFBLHFCQUFXLEVBQUM7UUFDWCxNQUFNLEVBQUUsR0FBRztRQUNYLFdBQVcsRUFBRSx5Q0FBeUM7S0FDdkQsQ0FBQzs7OzttRUEwQ0Q7d0NBbkxVLDZCQUE2QjtJQUZ6QyxJQUFBLGlCQUFPLEVBQUMsV0FBVyxDQUFDO0lBQ3BCLElBQUEsbUJBQVUsRUFBQyxzQkFBc0IsQ0FBQzt5REFLYyx5REFBMEIsb0JBQTFCLHlEQUEwQjtHQUo5RCw2QkFBNkIsQ0E0TXpDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxtb2R1bGVzXFxhdWRpdG9yaWFcXGNvbnRyb2xsZXJzXFxhdWRpdG9yaWEtZXhwb3J0YWNhby5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIEdldCxcbiAgUG9zdCxcbiAgUXVlcnksXG4gIEJvZHksXG4gIFJlcyxcbiAgSHR0cFN0YXR1cyxcbiAgSHR0cEV4Y2VwdGlvbixcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQge1xuICBBcGlUYWdzLFxuICBBcGlPcGVyYXRpb24sXG4gIEFwaVF1ZXJ5LFxuICBBcGlCb2R5LFxuICBBcGlSZXNwb25zZSxcbiAgQXBpUGFyYW0sXG59IGZyb20gJ0BuZXN0anMvc3dhZ2dlcic7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHtcbiAgQXVkaXRvcmlhRXhwb3J0YWNhb1NlcnZpY2UsXG4gIEZvcm1hdG9FeHBvcnRhY2FvLFxuICBPcGNvZXNFeHBvcnRhY2FvLFxufSBmcm9tICcuLi9zZXJ2aWNlcy9hdWRpdG9yaWEtZXhwb3J0YWNhby5zZXJ2aWNlJztcbmltcG9ydCB7IFF1ZXJ5TG9nQXVkaXRvcmlhRHRvIH0gZnJvbSAnLi4vZHRvL3F1ZXJ5LWxvZy1hdWRpdG9yaWEuZHRvJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbi8qKlxuICogRFRPIHBhcmEgc29saWNpdGHDp8OjbyBkZSBleHBvcnRhw6fDo29cbiAqL1xuY2xhc3MgU29saWNpdGFyRXhwb3J0YWNhb0R0byB7XG4gIC8qKlxuICAgKiBGb3JtYXRvIGRlIGV4cG9ydGHDp8Ojb1xuICAgKi9cbiAgZm9ybWF0bzogRm9ybWF0b0V4cG9ydGFjYW87XG5cbiAgLyoqXG4gICAqIEluZGljYSBzZSBvIGFycXVpdm8gZGV2ZSBzZXIgY29tcHJpbWlkb1xuICAgKi9cbiAgY29tcHJpbWlkbz86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIENhbXBvcyBhIHNlcmVtIGluY2x1w61kb3MgbmEgZXhwb3J0YcOnw6NvXG4gICAqL1xuICBjYW1wb3M/OiBzdHJpbmdbXTtcbn1cblxuLyoqXG4gKiBDb250cm9sYWRvciBwYXJhIGV4cG9ydGHDp8OjbyBkZSBsb2dzIGRlIGF1ZGl0b3JpYVxuICovXG5AQXBpVGFncygnQXVkaXRvcmlhJylcbkBDb250cm9sbGVyKCdhdWRpdG9yaWEvZXhwb3J0YWNhbycpXG5leHBvcnQgY2xhc3MgQXVkaXRvcmlhRXhwb3J0YWNhb0NvbnRyb2xsZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQXVkaXRvcmlhRXhwb3J0YWNhb0NvbnRyb2xsZXIubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdWRpdG9yaWFFeHBvcnRhY2FvU2VydmljZTogQXVkaXRvcmlhRXhwb3J0YWNhb1NlcnZpY2UsXG4gICkge31cblxuICAvKipcbiAgICogRXhwb3J0YSBsb2dzIGRlIGF1ZGl0b3JpYSBwYXJhIG8gZm9ybWF0byBlc3BlY2lmaWNhZG9cbiAgICovXG4gIEBQb3N0KClcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ0V4cG9ydGEgbG9ncyBkZSBhdWRpdG9yaWEgcGFyYSBvIGZvcm1hdG8gZXNwZWNpZmljYWRvJyxcbiAgfSlcbiAgQEFwaUJvZHkoeyB0eXBlOiBTb2xpY2l0YXJFeHBvcnRhY2FvRHRvIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogMjAxLCBkZXNjcmlwdGlvbjogJ0V4cG9ydGHDp8OjbyBpbmljaWFkYSBjb20gc3VjZXNzbycgfSlcbiAgYXN5bmMgZXhwb3J0YXJMb2dzKFxuICAgIEBRdWVyeSgpIGZpbHRyb3M6IFF1ZXJ5TG9nQXVkaXRvcmlhRHRvLFxuICAgIEBCb2R5KCkgb3Bjb2VzOiBTb2xpY2l0YXJFeHBvcnRhY2FvRHRvLFxuICAgIEBSZXMoKSByZXM6IFJlc3BvbnNlLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBTb2xpY2l0YcOnw6NvIGRlIGV4cG9ydGHDp8OjbyByZWNlYmlkYTogJHtvcGNvZXMuZm9ybWF0b31gKTtcblxuICAgICAgLy8gVmFsaWRhciBmb3JtYXRvXG4gICAgICBpZiAoIU9iamVjdC52YWx1ZXMoRm9ybWF0b0V4cG9ydGFjYW8pLmluY2x1ZGVzKG9wY29lcy5mb3JtYXRvKSkge1xuICAgICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgICBgRm9ybWF0byBkZSBleHBvcnRhw6fDo28gaW52w6FsaWRvLiBGb3JtYXRvcyBkaXNwb27DrXZlaXM6ICR7T2JqZWN0LnZhbHVlcyhGb3JtYXRvRXhwb3J0YWNhbykuam9pbignLCAnKX1gLFxuICAgICAgICAgIEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbmZpZ3VyYXIgb3DDp8O1ZXMgZGUgZXhwb3J0YcOnw6NvXG4gICAgICBjb25zdCBvcGNvZXNFeHBvcnRhY2FvOiBPcGNvZXNFeHBvcnRhY2FvID0ge1xuICAgICAgICBmb3JtYXRvOiBvcGNvZXMuZm9ybWF0byxcbiAgICAgICAgY29tcHJpbWlkbzogb3Bjb2VzLmNvbXByaW1pZG8gfHwgZmFsc2UsXG4gICAgICAgIGNhbXBvczogb3Bjb2VzLmNhbXBvcyxcbiAgICAgIH07XG5cbiAgICAgIC8vIEluaWNpYXIgZXhwb3J0YcOnw6NvIGFzc8OtbmNyb25hXG4gICAgICB0aGlzLmF1ZGl0b3JpYUV4cG9ydGFjYW9TZXJ2aWNlXG4gICAgICAgIC5leHBvcnRhckxvZ3MoZmlsdHJvcywgb3Bjb2VzRXhwb3J0YWNhbylcbiAgICAgICAgLnRoZW4oKHJlc3VsdGFkbykgPT4ge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgRXhwb3J0YcOnw6NvIGNvbmNsdcOtZGE6ICR7cmVzdWx0YWRvLmNhbWluaG9BcnF1aXZvfWApO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBgRXJybyBuYSBleHBvcnRhw6fDo286ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIC8vIFJldG9ybmFyIHJlc3Bvc3RhIGltZWRpYXRhXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkFDQ0VQVEVEKS5qc29uKHtcbiAgICAgICAgbWVuc2FnZW06ICdFeHBvcnRhw6fDo28gaW5pY2lhZGEgY29tIHN1Y2Vzc28nLFxuICAgICAgICBmb3JtYXRvOiBvcGNvZXMuZm9ybWF0byxcbiAgICAgICAgZmlsdHJvcyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gaW5pY2lhciBleHBvcnRhw6fDo286ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQmFpeGEgdW0gYXJxdWl2byBkZSBleHBvcnRhw6fDo28gcGVsbyBub21lXG4gICAqL1xuICBAR2V0KCdkb3dubG9hZC86bm9tZUFycXVpdm8nKVxuICBAQXBpT3BlcmF0aW9uKHsgc3VtbWFyeTogJ0JhaXhhIHVtIGFycXVpdm8gZGUgZXhwb3J0YcOnw6NvIHBlbG8gbm9tZScgfSlcbiAgQEFwaVBhcmFtKHtcbiAgICBuYW1lOiAnbm9tZUFycXVpdm8nLFxuICAgIGRlc2NyaXB0aW9uOiAnTm9tZSBkbyBhcnF1aXZvIGRlIGV4cG9ydGHDp8OjbycsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogMjAwLCBkZXNjcmlwdGlvbjogJ0FycXVpdm8gZW5jb250cmFkbyBlIGVudmlhZG8nIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogNDA0LCBkZXNjcmlwdGlvbjogJ0FycXVpdm8gbsOjbyBlbmNvbnRyYWRvJyB9KVxuICBhc3luYyBkb3dubG9hZEFycXVpdm8oXG4gICAgQFF1ZXJ5KCdub21lQXJxdWl2bycpIG5vbWVBcnF1aXZvOiBzdHJpbmcsXG4gICAgQFJlcygpIHJlczogUmVzcG9uc2UsXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkaXJldG9yaW9FeHBvcnRhY2FvID1cbiAgICAgICAgcHJvY2Vzcy5lbnYuQVVESVRPUklBX0VYUE9SVF9ESVIgfHxcbiAgICAgICAgcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICdleHBvcnRzJywgJ2F1ZGl0b3JpYScpO1xuXG4gICAgICBjb25zdCBjYW1pbmhvQXJxdWl2byA9IHBhdGguam9pbihkaXJldG9yaW9FeHBvcnRhY2FvLCBub21lQXJxdWl2byk7XG5cbiAgICAgIC8vIFZlcmlmaWNhciBzZSBvIGFycXVpdm8gZXhpc3RlXG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoY2FtaW5ob0FycXVpdm8pKSB7XG4gICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKCdBcnF1aXZvIG7Do28gZW5jb250cmFkbycsIEh0dHBTdGF0dXMuTk9UX0ZPVU5EKTtcbiAgICAgIH1cblxuICAgICAgLy8gRGV0ZXJtaW5hciBvIHRpcG8gZGUgY29udGXDumRvXG4gICAgICBsZXQgY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJztcblxuICAgICAgaWYgKG5vbWVBcnF1aXZvLmVuZHNXaXRoKCcuanNvbicpKSB7XG4gICAgICAgIGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICAgICAgfSBlbHNlIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLmNzdicpKSB7XG4gICAgICAgIGNvbnRlbnRUeXBlID0gJ3RleHQvY3N2JztcbiAgICAgIH0gZWxzZSBpZiAobm9tZUFycXVpdm8uZW5kc1dpdGgoJy54bHN4JykpIHtcbiAgICAgICAgY29udGVudFR5cGUgPVxuICAgICAgICAgICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCc7XG4gICAgICB9IGVsc2UgaWYgKG5vbWVBcnF1aXZvLmVuZHNXaXRoKCcucGRmJykpIHtcbiAgICAgICAgY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vcGRmJztcbiAgICAgIH0gZWxzZSBpZiAobm9tZUFycXVpdm8uZW5kc1dpdGgoJy5neicpKSB7XG4gICAgICAgIGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2d6aXAnO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmFyIGNhYmXDp2FsaG9zXG4gICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBjb250ZW50VHlwZSk7XG4gICAgICByZXMuc2V0SGVhZGVyKFxuICAgICAgICAnQ29udGVudC1EaXNwb3NpdGlvbicsXG4gICAgICAgIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cIiR7bm9tZUFycXVpdm99XCJgLFxuICAgICAgKTtcblxuICAgICAgLy8gRW52aWFyIGFycXVpdm9cbiAgICAgIGNvbnN0IGZpbGVTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGNhbWluaG9BcnF1aXZvKTtcbiAgICAgIGZpbGVTdHJlYW0ucGlwZShyZXMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gYmFpeGFyIGFycXVpdm86ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlzdGEgb3MgYXJxdWl2b3MgZGUgZXhwb3J0YcOnw6NvIGRpc3BvbsOtdmVpc1xuICAgKi9cbiAgQEdldCgnYXJxdWl2b3MnKVxuICBAQXBpT3BlcmF0aW9uKHsgc3VtbWFyeTogJ0xpc3RhIG9zIGFycXVpdm9zIGRlIGV4cG9ydGHDp8OjbyBkaXNwb27DrXZlaXMnIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdMaXN0YSBkZSBhcnF1aXZvcyByZXRvcm5hZGEgY29tIHN1Y2Vzc28nLFxuICB9KVxuICBhc3luYyBsaXN0YXJBcnF1aXZvcygpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGlyZXRvcmlvRXhwb3J0YWNhbyA9XG4gICAgICAgIHByb2Nlc3MuZW52LkFVRElUT1JJQV9FWFBPUlRfRElSIHx8XG4gICAgICAgIHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnZXhwb3J0cycsICdhdWRpdG9yaWEnKTtcblxuICAgICAgLy8gVmVyaWZpY2FyIHNlIG8gZGlyZXTDs3JpbyBleGlzdGVcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXJldG9yaW9FeHBvcnRhY2FvKSkge1xuICAgICAgICByZXR1cm4geyBhcnF1aXZvczogW10gfTtcbiAgICAgIH1cblxuICAgICAgLy8gTGlzdGFyIGFycXVpdm9zXG4gICAgICBjb25zdCBhcnF1aXZvcyA9IGZzXG4gICAgICAgIC5yZWFkZGlyU3luYyhkaXJldG9yaW9FeHBvcnRhY2FvKVxuICAgICAgICAuZmlsdGVyKChhcnF1aXZvKSA9PiB7XG4gICAgICAgICAgLy8gRmlsdHJhciBhcGVuYXMgYXJxdWl2b3MgZGUgZXhwb3J0YcOnw6NvXG4gICAgICAgICAgcmV0dXJuIGFycXVpdm8uc3RhcnRzV2l0aCgnYXVkaXRvcmlhX2V4cG9ydF8nKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcCgoYXJxdWl2bykgPT4ge1xuICAgICAgICAgIGNvbnN0IGNhbWluaG9Db21wbGV0byA9IHBhdGguam9pbihkaXJldG9yaW9FeHBvcnRhY2FvLCBhcnF1aXZvKTtcbiAgICAgICAgICBjb25zdCBzdGF0cyA9IGZzLnN0YXRTeW5jKGNhbWluaG9Db21wbGV0byk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbm9tZTogYXJxdWl2byxcbiAgICAgICAgICAgIHRhbWFuaG86IHN0YXRzLnNpemUsXG4gICAgICAgICAgICBkYXRhTW9kaWZpY2FjYW86IHN0YXRzLm10aW1lLFxuICAgICAgICAgICAgZm9ybWF0bzogdGhpcy5kZXRlcm1pbmFyRm9ybWF0byhhcnF1aXZvKSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgICAuc29ydChcbiAgICAgICAgICAoYSwgYikgPT4gYi5kYXRhTW9kaWZpY2FjYW8uZ2V0VGltZSgpIC0gYS5kYXRhTW9kaWZpY2FjYW8uZ2V0VGltZSgpLFxuICAgICAgICApO1xuXG4gICAgICByZXR1cm4geyBhcnF1aXZvcyB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gbGlzdGFyIGFycXVpdm9zOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgZXJyb3Iuc3RhY2ssXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluYSBvIGZvcm1hdG8gZGUgdW0gYXJxdWl2byBjb20gYmFzZSBubyBub21lXG4gICAqXG4gICAqIEBwYXJhbSBub21lQXJxdWl2byBOb21lIGRvIGFycXVpdm9cbiAgICogQHJldHVybnMgRm9ybWF0byBkbyBhcnF1aXZvXG4gICAqL1xuICBwcml2YXRlIGRldGVybWluYXJGb3JtYXRvKG5vbWVBcnF1aXZvOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLmpzb24uZ3onKSkge1xuICAgICAgcmV0dXJuICdKU09OIChjb21wcmltaWRvKSc7XG4gICAgfSBlbHNlIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgICAgcmV0dXJuICdKU09OJztcbiAgICB9IGVsc2UgaWYgKG5vbWVBcnF1aXZvLmVuZHNXaXRoKCcuY3N2Lmd6JykpIHtcbiAgICAgIHJldHVybiAnQ1NWIChjb21wcmltaWRvKSc7XG4gICAgfSBlbHNlIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLmNzdicpKSB7XG4gICAgICByZXR1cm4gJ0NTVic7XG4gICAgfSBlbHNlIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLnhsc3gnKSkge1xuICAgICAgcmV0dXJuICdFeGNlbCc7XG4gICAgfSBlbHNlIGlmIChub21lQXJxdWl2by5lbmRzV2l0aCgnLnBkZicpKSB7XG4gICAgICByZXR1cm4gJ1BERic7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAnRGVzY29uaGVjaWRvJztcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==