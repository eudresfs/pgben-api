163695f7d75d5c3cf65612d422520153
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const uuid_1 = require("uuid");
const constants_1 = require("../constants");
const logger_service_1 = require("../logger/logger.service");
const all_exceptions_filter_1 = require("./all-exceptions.filter");
const mockMessage1 = 'mock exception string';
const mockMessage2 = { hello: 'world', hi: 'joe' };
const mockMessage3 = 'Something is very wrong';
const mockException1 = new common_1.HttpException(mockMessage1, common_1.HttpStatus.NOT_FOUND);
const mockException2 = new common_1.HttpException(mockMessage2, common_1.HttpStatus.BAD_REQUEST);
const mockError = new Error(mockMessage3);
describe('AllExceptionsFilter', () => {
    let mockContext;
    let mockRequest;
    let mockResponse;
    const mockConfigService = {
        get: () => 'development',
    };
    const mockedLogger = {
        warn: jest.fn().mockReturnThis(),
        setContext: jest.fn().mockReturnThis(),
    };
    let filter;
    beforeEach(async () => {
        /** mock request object */
        mockRequest = {
            headers: {},
            url: 'mock-url',
            header: jest.fn(),
        };
        mockRequest.headers[constants_1.REQUEST_ID_TOKEN_HEADER] = (0, uuid_1.v4)();
        /** mock response object */
        mockResponse = {
            status: jest.fn().mockReturnThis(),
            json: jest.fn().mockReturnThis(),
        };
        /** mock execution context */
        mockContext = {
            switchToHttp: () => ({
                getRequest: () => mockRequest,
                getResponse: () => mockResponse,
            }),
        };
        const moduleRef = await testing_1.Test.createTestingModule({
            providers: [
                all_exceptions_filter_1.AllExceptionsFilter,
                { provide: config_1.ConfigService, useValue: mockConfigService },
                { provide: logger_service_1.AppLogger, useValue: mockedLogger },
            ],
        }).compile();
        // config = moduleRef.get<ConfigService>(ConfigService);
        filter = moduleRef.get(all_exceptions_filter_1.AllExceptionsFilter);
    });
    it('should be defined', async () => {
        expect(filter).toBeDefined();
    });
    it('should handle both HttpException and unhandled Error', async () => {
        filter.catch(mockException1, mockContext);
        expect(mockResponse.status).toBeCalled();
        expect(mockResponse.json).toBeCalled();
        filter.catch(mockError, mockContext);
        expect(mockResponse.status).toBeCalled();
        expect(mockResponse.json).toBeCalled();
    });
    it('should handle HttpException with right status code', async () => {
        filter.catch(mockException1, mockContext);
        expect(mockResponse.status).toBeCalledWith(common_1.HttpStatus.NOT_FOUND);
        filter.catch(mockException2, mockContext);
        expect(mockResponse.status).toBeCalledWith(common_1.HttpStatus.BAD_REQUEST);
    });
    it('should handle unhandled error with status code 500', async () => {
        filter.catch(mockError, mockContext);
        expect(mockResponse.status).toBeCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
    });
    it('should handle exception with plain string message', async () => {
        filter.catch(mockException1, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                statusCode: common_1.HttpStatus.NOT_FOUND,
                message: mockMessage1,
            }),
        }));
    });
    it('should handle exception with object type message', async () => {
        filter.catch(mockException2, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                statusCode: common_1.HttpStatus.BAD_REQUEST,
                details: mockMessage2,
            }),
        }));
    });
    it('should respond with Error message in development mode', async () => {
        // const configSpy = jest
        //   .spyOn(config, 'get')
        //   .mockImplementation(() => 'development');
        filter.catch(mockError, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                message: mockMessage3,
            }),
        }));
        // configSpy.mockClear();
    });
    it('should suppress Error message in production mode', async () => {
        const configSpy = jest
            .spyOn(mockConfigService, 'get')
            .mockImplementation(() => 'production');
        filter.catch(mockError, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                message: 'Internal server error',
            }),
        }));
        configSpy.mockClear();
    });
    it('should contain request id in response', async () => {
        filter.catch(mockMessage1, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                requestId: mockRequest.headers[constants_1.REQUEST_ID_TOKEN_HEADER],
            }),
        }));
    });
    it('should contain request path in response', async () => {
        filter.catch(mockMessage1, mockContext);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                path: mockRequest.url,
            }),
        }));
    });
    it('should contain timestamp in response', async () => {
        const mockDate = new Date();
        const dateSpy = jest
            .spyOn(global, 'Date')
            .mockImplementation(() => mockDate);
        filter.catch(mockException1, mockContext);
        expect(mockResponse.status).toBeCalledWith(common_1.HttpStatus.NOT_FOUND);
        expect(mockResponse.json).toBeCalledWith(expect.objectContaining({
            error: expect.objectContaining({
                timestamp: mockDate.toISOString(),
            }),
        }));
        dateSpy.mockClear();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXHNoYXJlZFxcZmlsdGVyc1xcYWxsLWV4Y2VwdGlvbnMuZmlsdGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBMkQ7QUFDM0QsMkNBQStDO0FBQy9DLDZDQUFzRDtBQUN0RCwrQkFBb0M7QUFFcEMsNENBQXVEO0FBQ3ZELDZEQUFxRDtBQUNyRCxtRUFBOEQ7QUFFOUQsTUFBTSxZQUFZLEdBQUcsdUJBQXVCLENBQUM7QUFDN0MsTUFBTSxZQUFZLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQztBQUNuRCxNQUFNLFlBQVksR0FBRyx5QkFBeUIsQ0FBQztBQUUvQyxNQUFNLGNBQWMsR0FBRyxJQUFJLHNCQUFhLENBQUMsWUFBWSxFQUFFLG1CQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDN0UsTUFBTSxjQUFjLEdBQUcsSUFBSSxzQkFBYSxDQUFDLFlBQVksRUFBRSxtQkFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQy9FLE1BQU0sU0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRTFDLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxXQUFnQixDQUFDO0lBQ3JCLElBQUksV0FBZ0IsQ0FBQztJQUNyQixJQUFJLFlBQWlCLENBQUM7SUFFdEIsTUFBTSxpQkFBaUIsR0FBRztRQUN4QixHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsYUFBYTtLQUN6QixDQUFDO0lBQ0YsTUFBTSxZQUFZLEdBQUc7UUFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7UUFDaEMsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7S0FDdkMsQ0FBQztJQUNGLElBQUksTUFBZ0MsQ0FBQztJQUVy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QUFLLElBQUksRUFBRTtRQUN2RCxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FDdEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ3RCLEtBQUssRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQzdCLElBQUksRUFBRSxXQUFXLENBQUMsR0FBRzthQUN0QixDQUFDO1NBQ0gsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNwRCxNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRTVCLE1BQU0sT0FBTyxHQUFHLElBQUk7YUFDakIsS0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7YUFDckIsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFdEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDMUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsbUJBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNqRSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FDdEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ3RCLEtBQUssRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQzdCLFNBQVMsRUFBRSxRQUFRLENBQUMsV0FBVyxFQUFFO2FBQ2xDLENBQUM7U0FDSCxDQUFDLENBQ0gsQ0FBQztRQUNGLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZXVkcmVcXE9uZURyaXZlXFxEZXNrdG9wXFxQcm9qZXRvc1xccGdiZW5cXHBnYmVuLXNlcnZlclxcc3JjXFxzaGFyZWRcXGZpbHRlcnNcXGFsbC1leGNlcHRpb25zLmZpbHRlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBFeGNlcHRpb24sIEh0dHBTdGF0dXMgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgUkVRVUVTVF9JRF9UT0tFTl9IRUFERVIgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgQXBwTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IEFsbEV4Y2VwdGlvbnNGaWx0ZXIgfSBmcm9tICcuL2FsbC1leGNlcHRpb25zLmZpbHRlcic7XG5cbmNvbnN0IG1vY2tNZXNzYWdlMSA9ICdtb2NrIGV4Y2VwdGlvbiBzdHJpbmcnO1xuY29uc3QgbW9ja01lc3NhZ2UyID0geyBoZWxsbzogJ3dvcmxkJywgaGk6ICdqb2UnIH07XG5jb25zdCBtb2NrTWVzc2FnZTMgPSAnU29tZXRoaW5nIGlzIHZlcnkgd3JvbmcnO1xuXG5jb25zdCBtb2NrRXhjZXB0aW9uMSA9IG5ldyBIdHRwRXhjZXB0aW9uKG1vY2tNZXNzYWdlMSwgSHR0cFN0YXR1cy5OT1RfRk9VTkQpO1xuY29uc3QgbW9ja0V4Y2VwdGlvbjIgPSBuZXcgSHR0cEV4Y2VwdGlvbihtb2NrTWVzc2FnZTIsIEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QpO1xuY29uc3QgbW9ja0Vycm9yID0gbmV3IEVycm9yKG1vY2tNZXNzYWdlMyk7XG5cbmRlc2NyaWJlKCdBbGxFeGNlcHRpb25zRmlsdGVyJywgKCkgPT4ge1xuICBsZXQgbW9ja0NvbnRleHQ6IGFueTtcbiAgbGV0IG1vY2tSZXF1ZXN0OiBhbnk7XG4gIGxldCBtb2NrUmVzcG9uc2U6IGFueTtcblxuICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICBnZXQ6ICgpID0+ICdkZXZlbG9wbWVudCcsXG4gIH07XG4gIGNvbnN0IG1vY2tlZExvZ2dlciA9IHtcbiAgICB3YXJuOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICBzZXRDb250ZXh0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgfTtcbiAgbGV0IGZpbHRlcjogQWxsRXhjZXB0aW9uc0ZpbHRlcjxhbnk+O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8qKiBtb2NrIHJlcXVlc3Qgb2JqZWN0ICovXG4gICAgbW9ja1JlcXVlc3QgPSB7XG4gICAgICBoZWFkZXJzOiB7fSxcbiAgICAgIHVybDogJ21vY2stdXJsJyxcbiAgICAgIGhlYWRlcjogamVzdC5mbigpLFxuICAgIH07XG4gICAgbW9ja1JlcXVlc3QuaGVhZGVyc1tSRVFVRVNUX0lEX1RPS0VOX0hFQURFUl0gPSB1dWlkdjQoKTtcblxuICAgIC8qKiBtb2NrIHJlc3BvbnNlIG9iamVjdCAqL1xuICAgIG1vY2tSZXNwb25zZSA9IHtcbiAgICAgIHN0YXR1czogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBqc29uOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICB9O1xuXG4gICAgLyoqIG1vY2sgZXhlY3V0aW9uIGNvbnRleHQgKi9cbiAgICBtb2NrQ29udGV4dCA9IHtcbiAgICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcbiAgICAgICAgZ2V0UmVxdWVzdDogKCkgPT4gbW9ja1JlcXVlc3QsXG4gICAgICAgIGdldFJlc3BvbnNlOiAoKSA9PiBtb2NrUmVzcG9uc2UsXG4gICAgICB9KSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9kdWxlUmVmOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBBbGxFeGNlcHRpb25zRmlsdGVyLFxuICAgICAgICB7IHByb3ZpZGU6IENvbmZpZ1NlcnZpY2UsIHVzZVZhbHVlOiBtb2NrQ29uZmlnU2VydmljZSB9LFxuICAgICAgICB7IHByb3ZpZGU6IEFwcExvZ2dlciwgdXNlVmFsdWU6IG1vY2tlZExvZ2dlciB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICAvLyBjb25maWcgPSBtb2R1bGVSZWYuZ2V0PENvbmZpZ1NlcnZpY2U+KENvbmZpZ1NlcnZpY2UpO1xuICAgIGZpbHRlciA9IG1vZHVsZVJlZi5nZXQ8QWxsRXhjZXB0aW9uc0ZpbHRlcjxhbnk+PihBbGxFeGNlcHRpb25zRmlsdGVyKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGV4cGVjdChmaWx0ZXIpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIGJvdGggSHR0cEV4Y2VwdGlvbiBhbmQgdW5oYW5kbGVkIEVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgIGZpbHRlci5jYXRjaChtb2NrRXhjZXB0aW9uMSwgbW9ja0NvbnRleHQpO1xuICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0JlQ2FsbGVkKCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0JlQ2FsbGVkKCk7XG5cbiAgICBmaWx0ZXIuY2F0Y2gobW9ja0Vycm9yLCBtb2NrQ29udGV4dCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvQmVDYWxsZWQoKTtcbiAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvQmVDYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgSHR0cEV4Y2VwdGlvbiB3aXRoIHJpZ2h0IHN0YXR1cyBjb2RlJywgYXN5bmMgKCkgPT4ge1xuICAgIGZpbHRlci5jYXRjaChtb2NrRXhjZXB0aW9uMSwgbW9ja0NvbnRleHQpO1xuICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0JlQ2FsbGVkV2l0aChIdHRwU3RhdHVzLk5PVF9GT1VORCk7XG5cbiAgICBmaWx0ZXIuY2F0Y2gobW9ja0V4Y2VwdGlvbjIsIG1vY2tDb250ZXh0KTtcbiAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9CZUNhbGxlZFdpdGgoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIHVuaGFuZGxlZCBlcnJvciB3aXRoIHN0YXR1cyBjb2RlIDUwMCcsIGFzeW5jICgpID0+IHtcbiAgICBmaWx0ZXIuY2F0Y2gobW9ja0Vycm9yLCBtb2NrQ29udGV4dCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvQmVDYWxsZWRXaXRoKFxuICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgZXhjZXB0aW9uIHdpdGggcGxhaW4gc3RyaW5nIG1lc3NhZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgZmlsdGVyLmNhdGNoKG1vY2tFeGNlcHRpb24xLCBtb2NrQ29udGV4dCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0JlQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzLk5PVF9GT1VORCxcbiAgICAgICAgICBtZXNzYWdlOiBtb2NrTWVzc2FnZTEsXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgZXhjZXB0aW9uIHdpdGggb2JqZWN0IHR5cGUgbWVzc2FnZScsIGFzeW5jICgpID0+IHtcbiAgICBmaWx0ZXIuY2F0Y2gobW9ja0V4Y2VwdGlvbjIsIG1vY2tDb250ZXh0KTtcbiAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvQmVDYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHN0YXR1c0NvZGU6IEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QsXG4gICAgICAgICAgZGV0YWlsczogbW9ja01lc3NhZ2UyLFxuICAgICAgICB9KSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmVzcG9uZCB3aXRoIEVycm9yIG1lc3NhZ2UgaW4gZGV2ZWxvcG1lbnQgbW9kZScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBjb25zdCBjb25maWdTcHkgPSBqZXN0XG4gICAgLy8gICAuc3B5T24oY29uZmlnLCAnZ2V0JylcbiAgICAvLyAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gJ2RldmVsb3BtZW50Jyk7XG5cbiAgICBmaWx0ZXIuY2F0Y2gobW9ja0Vycm9yLCBtb2NrQ29udGV4dCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0JlQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICAgICBtZXNzYWdlOiBtb2NrTWVzc2FnZTMsXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIGNvbmZpZ1NweS5tb2NrQ2xlYXIoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBzdXBwcmVzcyBFcnJvciBtZXNzYWdlIGluIHByb2R1Y3Rpb24gbW9kZScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBjb25maWdTcHkgPSBqZXN0XG4gICAgICAuc3B5T24obW9ja0NvbmZpZ1NlcnZpY2UsICdnZXQnKVxuICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAncHJvZHVjdGlvbicpO1xuXG4gICAgZmlsdGVyLmNhdGNoKG1vY2tFcnJvciwgbW9ja0NvbnRleHQpO1xuICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9CZUNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGNvbmZpZ1NweS5tb2NrQ2xlYXIoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjb250YWluIHJlcXVlc3QgaWQgaW4gcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgZmlsdGVyLmNhdGNoKG1vY2tNZXNzYWdlMSwgbW9ja0NvbnRleHQpO1xuICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9CZUNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgcmVxdWVzdElkOiBtb2NrUmVxdWVzdC5oZWFkZXJzW1JFUVVFU1RfSURfVE9LRU5fSEVBREVSXSxcbiAgICAgICAgfSksXG4gICAgICB9KSxcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNvbnRhaW4gcmVxdWVzdCBwYXRoIGluIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgIGZpbHRlci5jYXRjaChtb2NrTWVzc2FnZTEsIG1vY2tDb250ZXh0KTtcbiAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvQmVDYWxsZWRXaXRoKFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHBhdGg6IG1vY2tSZXF1ZXN0LnVybCxcbiAgICAgICAgfSksXG4gICAgICB9KSxcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNvbnRhaW4gdGltZXN0YW1wIGluIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tEYXRlID0gbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IGRhdGVTcHkgPSBqZXN0XG4gICAgICAuc3B5T24oZ2xvYmFsLCAnRGF0ZScpXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tEYXRlKTtcblxuICAgIGZpbHRlci5jYXRjaChtb2NrRXhjZXB0aW9uMSwgbW9ja0NvbnRleHQpO1xuICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0JlQ2FsbGVkV2l0aChIdHRwU3RhdHVzLk5PVF9GT1VORCk7XG4gICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0JlQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0aW1lc3RhbXA6IG1vY2tEYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBkYXRlU3B5Lm1vY2tDbGVhcigpO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9