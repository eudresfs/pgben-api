2af3985d5af5f6a98c47d874228dadd5
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var MonitoramentoAluguelSocialService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MonitoramentoAluguelSocialService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const solicitacao_entity_1 = require("../../../entities/solicitacao.entity");
const tipo_beneficio_enum_1 = require("../../../enums/tipo-beneficio.enum");
const schedule_1 = require("@nestjs/schedule");
const notificacao_service_1 = require("./notificacao.service");
/**
 * Serviço responsável pelo monitoramento obrigatório de solicitações de Aluguel Social
 *
 * Este serviço garante que as solicitações de Aluguel Social sejam monitoradas regularmente
 * de acordo com as regras de negócio estabelecidas.
 */
let MonitoramentoAluguelSocialService = MonitoramentoAluguelSocialService_1 = class MonitoramentoAluguelSocialService {
    solicitacaoRepository;
    notificacaoService;
    logger = new common_1.Logger(MonitoramentoAluguelSocialService_1.name);
    // Período padrão de monitoramento em dias
    PERIODO_MONITORAMENTO_DIAS = 90;
    // Dias de antecedência para alerta de monitoramento
    DIAS_ALERTA_ANTECEDENCIA = 15;
    constructor(solicitacaoRepository, notificacaoService) {
        this.solicitacaoRepository = solicitacaoRepository;
        this.notificacaoService = notificacaoService;
    }
    /**
     * Verifica se uma solicitação é do tipo Aluguel Social
     * @param solicitacao Solicitação a ser verificada
     * @returns Verdadeiro se for Aluguel Social, falso caso contrário
     */
    isAluguelSocial(solicitacao) {
        // Verificar pelo tipo_beneficio direto
        if (solicitacao.tipo_beneficio &&
            solicitacao.tipo_beneficio.nome === tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL) {
            return true;
        }
        // Verificar pelo tipo_beneficio_id através dos dados complementares
        if (solicitacao.dados_complementares &&
            solicitacao.dados_complementares.tipo_beneficio ===
                tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL) {
            return true;
        }
        return false;
    }
    /**
     * Verifica se a solicitação está em um estado que requer monitoramento
     * @param solicitacao Solicitação a ser verificada
     * @returns Verdadeiro se estiver em estado que requer monitoramento
     */
    requiresMonitoring(solicitacao) {
        // Solicitações aprovadas e em concessão requerem monitoramento
        const statusMonitorados = [
            solicitacao_entity_1.StatusSolicitacao.APROVADA,
            solicitacao_entity_1.StatusSolicitacao.EM_PROCESSAMENTO,
            solicitacao_entity_1.StatusSolicitacao.LIBERADA,
        ];
        return statusMonitorados.includes(solicitacao.status);
    }
    /**
     * Calcula a data da próxima visita de monitoramento
     * @param ultimaVisita Data da última visita ou null se não houver
     * @returns Data da próxima visita agendada
     */
    calcularProximaVisita(ultimaVisita) {
        const hoje = new Date();
        if (!ultimaVisita) {
            // Se não houver última visita, a próxima deve ser em 30 dias
            const proximaVisita = new Date(hoje);
            proximaVisita.setDate(proximaVisita.getDate() + 30);
            return proximaVisita;
        }
        // Caso contrário, próxima visita deve ser em PERIODO_MONITORAMENTO_DIAS
        const proximaVisita = new Date(ultimaVisita);
        proximaVisita.setDate(proximaVisita.getDate() + this.PERIODO_MONITORAMENTO_DIAS);
        return proximaVisita;
    }
    /**
     * Registra uma nova visita para uma solicitação
     * @param solicitacaoId ID da solicitação
     * @param dataVisita Data da visita
     * @param observacoes Observações da visita
     * @param usuario Usuário que realizou a visita
     */
    async registrarVisita(solicitacaoId, dataVisita, observacoes, usuario) {
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            this.logger.error(`Solicitação não encontrada: ${solicitacaoId}`);
            throw new Error('Solicitação não encontrada');
        }
        // Verifica se é aluguel social
        if (!this.isAluguelSocial(solicitacao)) {
            this.logger.error(`Tentativa de registrar visita para solicitação que não é de Aluguel Social: ${solicitacaoId}`);
            throw new Error('Solicitação não é de Aluguel Social');
        }
        // Inicializa o histórico de visitas se não existir
        if (!solicitacao.dados_complementares) {
            solicitacao.dados_complementares = {};
        }
        if (!solicitacao.dados_complementares.visitas_monitoramento) {
            solicitacao.dados_complementares.visitas_monitoramento = [];
        }
        // Calcula a data da próxima visita
        const proximaVisita = this.calcularProximaVisita(dataVisita);
        // Adiciona a nova visita ao histórico
        solicitacao.dados_complementares.visitas_monitoramento.push({
            data: dataVisita,
            observacoes,
            usuario_id: usuario.id,
            nome_usuario: usuario.nome || 'Sistema',
            proxima_visita: proximaVisita,
        });
        // Atualiza a data da próxima visita
        solicitacao.dados_complementares.proxima_visita_monitoramento =
            proximaVisita;
        // Salva as alterações
        await this.solicitacaoRepository.save(solicitacao);
        // Envia notificação sobre o registro da visita
        this.notificacaoService.notificarVisitaMonitoramentoRegistrada(solicitacao, dataVisita, proximaVisita);
        this.logger.log(`Visita registrada para solicitação ${solicitacaoId}`);
    }
    /**
     * Obtém as solicitações de Aluguel Social que precisam de monitoramento
     * @returns Lista de solicitações que precisam de monitoramento
     */
    async getSolicitacoesParaMonitoramento() {
        const hoje = new Date();
        const queryBuilder = this.solicitacaoRepository
            .createQueryBuilder('solicitacao')
            .leftJoinAndSelect('solicitacao.tipo_beneficio', 'tipo_beneficio')
            .where('solicitacao.status IN (:...statusMonitorados)', {
            statusMonitorados: [
                solicitacao_entity_1.StatusSolicitacao.APROVADA,
                solicitacao_entity_1.StatusSolicitacao.EM_PROCESSAMENTO,
                solicitacao_entity_1.StatusSolicitacao.LIBERADA,
            ],
        })
            .andWhere("(tipo_beneficio.nome = :tipoBeneficio OR solicitacao.dados_complementares->>'tipo_beneficio' = :tipoBeneficioStr)", {
            tipoBeneficio: tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL,
            tipoBeneficioStr: tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL,
        })
            .andWhere("(solicitacao.dados_complementares->'proxima_visita_monitoramento' IS NULL OR " +
            "CAST(solicitacao.dados_complementares->>'proxima_visita_monitoramento' AS TIMESTAMP) <= :dataLimite)", {
            dataLimite: hoje,
        })
            .orderBy('solicitacao.updated_at', 'ASC');
        return queryBuilder.getMany();
    }
    /**
     * Obtém as solicitações que estão próximas da data de monitoramento
     * @returns Lista de solicitações com alerta de monitoramento
     */
    async getSolicitacoesComAlertaMonitoramento() {
        const hoje = new Date();
        const dataLimiteAlerta = new Date(hoje);
        dataLimiteAlerta.setDate(hoje.getDate() + this.DIAS_ALERTA_ANTECEDENCIA);
        const queryBuilder = this.solicitacaoRepository
            .createQueryBuilder('solicitacao')
            .leftJoinAndSelect('solicitacao.tipo_beneficio', 'tipo_beneficio')
            .where('solicitacao.status IN (:...statusMonitorados)', {
            statusMonitorados: [
                solicitacao_entity_1.StatusSolicitacao.APROVADA,
                solicitacao_entity_1.StatusSolicitacao.EM_PROCESSAMENTO,
                solicitacao_entity_1.StatusSolicitacao.LIBERADA,
            ],
        })
            .andWhere("(tipo_beneficio.nome = :tipoBeneficio OR solicitacao.dados_complementares->>'tipo_beneficio' = :tipoBeneficioStr)", {
            tipoBeneficio: tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL,
            tipoBeneficioStr: tipo_beneficio_enum_1.TipoBeneficio.ALUGUEL_SOCIAL,
        })
            .andWhere("(solicitacao.dados_complementares->'proxima_visita_monitoramento' IS NOT NULL AND " +
            "CAST(solicitacao.dados_complementares->>'proxima_visita_monitoramento' AS TIMESTAMP) > :hoje AND " +
            "CAST(solicitacao.dados_complementares->>'proxima_visita_monitoramento' AS TIMESTAMP) <= :dataLimite)", {
            hoje: hoje,
            dataLimite: dataLimiteAlerta,
        })
            .orderBy("solicitacao.dados_complementares->>'proxima_visita_monitoramento'", 'ASC');
        return queryBuilder.getMany();
    }
    /**
     * Obtém uma solicitação pelo ID
     * @param id ID da solicitação
     * @returns Solicitação encontrada ou null
     */
    async getSolicitacaoById(id) {
        try {
            return await this.solicitacaoRepository.findOne({
                where: { id },
                relations: ['tipo_beneficio'],
            });
        }
        catch (error) {
            this.logger.error(`Erro ao buscar solicitação: ${error.message}`, error.stack);
            return null;
        }
    }
    /**
     * Atualiza uma visita de monitoramento existente
     * @param solicitacaoId ID da solicitação
     * @param indiceVisita Índice da visita no array de visitas
     * @param dadosAtualizacao Dados para atualização parcial da visita
     * @param usuario Usuário que está realizando a atualização
     * @returns A visita atualizada
     */
    async atualizarVisitaMonitoramento(solicitacaoId, indiceVisita, dadosAtualizacao, usuario) {
        // Buscar a solicitação
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            this.logger.error(`Solicitação não encontrada: ${solicitacaoId}`);
            throw new Error('Solicitação não encontrada');
        }
        // Verificar se é aluguel social
        if (!this.isAluguelSocial(solicitacao)) {
            this.logger.error(`Tentativa de atualizar visita para solicitação que não é de Aluguel Social: ${solicitacaoId}`);
            throw new Error('Solicitação não é de Aluguel Social');
        }
        // Verificar se existem visitas registradas
        if (!solicitacao.dados_complementares?.visitas_monitoramento ||
            !Array.isArray(solicitacao.dados_complementares.visitas_monitoramento) ||
            solicitacao.dados_complementares.visitas_monitoramento.length === 0) {
            throw new Error('Solicitação não possui visitas de monitoramento registradas');
        }
        // Verificar se o índice é válido
        if (indiceVisita < 0 ||
            indiceVisita >=
                solicitacao.dados_complementares.visitas_monitoramento.length) {
            throw new Error('Visita não encontrada com o índice fornecido');
        }
        // Obter a visita a ser atualizada
        const visita = solicitacao.dados_complementares.visitas_monitoramento[indiceVisita];
        // Registrar dados da atualização
        const dataAtualizacao = new Date();
        const dadosAtualizador = {
            usuario_id: usuario.id,
            nome_usuario: usuario.nome || 'Sistema',
            data_atualizacao: dataAtualizacao,
        };
        // Atualizar dados da visita
        if (dadosAtualizacao.data_visita) {
            visita.data = dadosAtualizacao.data_visita;
        }
        if (dadosAtualizacao.observacoes) {
            visita.observacoes = dadosAtualizacao.observacoes;
        }
        if (dadosAtualizacao.dados_adicionais) {
            visita.dados_adicionais = {
                ...(visita.dados_adicionais || {}),
                ...dadosAtualizacao.dados_adicionais,
            };
        }
        // Adicionar informações sobre a atualização
        if (!visita.historico_atualizacoes) {
            visita.historico_atualizacoes = [];
        }
        visita.historico_atualizacoes.push({
            ...dadosAtualizador,
            dados_anteriores: {
                data: visita.data,
                observacoes: visita.observacoes,
                dados_adicionais: visita.dados_adicionais,
            },
            campos_atualizados: Object.keys(dadosAtualizacao),
        });
        visita.ultima_atualizacao = dadosAtualizador;
        // Recalcular próxima visita apenas se a data for alterada
        if (dadosAtualizacao.data_visita) {
            const proximaVisita = this.calcularProximaVisita(dadosAtualizacao.data_visita);
            visita.proxima_visita = proximaVisita;
            // Atualizar a data da próxima visita na solicitação apenas se esta for a última visita
            if (indiceVisita ===
                solicitacao.dados_complementares.visitas_monitoramento.length - 1) {
                solicitacao.dados_complementares.proxima_visita_monitoramento =
                    proximaVisita;
            }
        }
        // Salvar as alterações
        await this.solicitacaoRepository.save(solicitacao);
        // Notificar sobre a atualização se a data foi alterada
        if (dadosAtualizacao.data_visita) {
            this.notificacaoService.notificarVisitaMonitoramentoRegistrada(solicitacao, visita.data, visita.proxima_visita);
        }
        this.logger.log(`Visita de monitoramento atualizada para solicitação ${solicitacaoId}, índice ${indiceVisita}`);
        return visita;
    }
    /**
     * Remove uma visita de monitoramento existente
     * @param solicitacaoId ID da solicitação
     * @param indiceVisita Índice da visita no array de visitas
     * @param usuario Usuário que está realizando a exclusão
     * @returns Informações sobre a operação
     */
    async removerVisitaMonitoramento(solicitacaoId, indiceVisita, usuario) {
        // Buscar a solicitação
        const solicitacao = await this.solicitacaoRepository.findOne({
            where: { id: solicitacaoId },
        });
        if (!solicitacao) {
            this.logger.error(`Solicitação não encontrada: ${solicitacaoId}`);
            throw new Error('Solicitação não encontrada');
        }
        // Verificar se é aluguel social
        if (!this.isAluguelSocial(solicitacao)) {
            this.logger.error(`Tentativa de remover visita para solicitação que não é de Aluguel Social: ${solicitacaoId}`);
            throw new Error('Solicitação não é de Aluguel Social');
        }
        // Verificar se existem visitas registradas
        if (!solicitacao.dados_complementares?.visitas_monitoramento ||
            !Array.isArray(solicitacao.dados_complementares.visitas_monitoramento) ||
            solicitacao.dados_complementares.visitas_monitoramento.length === 0) {
            throw new Error('Solicitação não possui visitas de monitoramento registradas');
        }
        // Verificar se o índice é válido
        if (indiceVisita < 0 ||
            indiceVisita >=
                solicitacao.dados_complementares.visitas_monitoramento.length) {
            throw new Error('Visita não encontrada com o índice fornecido');
        }
        // Armazenar informações da visita a ser removida para o log
        const visitaRemovida = solicitacao.dados_complementares.visitas_monitoramento[indiceVisita];
        // Inicializar o histórico de exclusões se não existir
        if (!solicitacao.dados_complementares.historico_exclusoes_visitas) {
            solicitacao.dados_complementares.historico_exclusoes_visitas = [];
        }
        // Registrar a exclusão no histórico
        solicitacao.dados_complementares.historico_exclusoes_visitas.push({
            visita: visitaRemovida,
            data_exclusao: new Date(),
            usuario_id: usuario.id,
            nome_usuario: usuario.nome || 'Sistema',
            motivo: 'Exclusão manual via API',
        });
        // Remover a visita do array
        solicitacao.dados_complementares.visitas_monitoramento.splice(indiceVisita, 1);
        const resultado = {
            success: true,
        };
        // Se for a última visita ou se não houver mais visitas, recalcular a próxima visita
        if (solicitacao.dados_complementares.visitas_monitoramento.length === 0) {
            // Se não houver mais visitas, a próxima visita deve ser calculada a partir da data atual
            const proximaVisita = this.calcularProximaVisita();
            solicitacao.dados_complementares.proxima_visita_monitoramento =
                proximaVisita;
            resultado.proximaVisitaAtualizada = proximaVisita;
        }
        else if (indiceVisita ===
            solicitacao.dados_complementares.visitas_monitoramento.length) {
            // Se a visita removida era a última, a próxima visita deve ser baseada na nova última visita
            const ultimaVisita = solicitacao.dados_complementares.visitas_monitoramento[solicitacao.dados_complementares.visitas_monitoramento.length - 1];
            const proximaVisita = this.calcularProximaVisita(new Date(ultimaVisita.data));
            solicitacao.dados_complementares.proxima_visita_monitoramento =
                proximaVisita;
            resultado.proximaVisitaAtualizada = proximaVisita;
        }
        // Salvar as alterações
        await this.solicitacaoRepository.save(solicitacao);
        this.logger.log(`Visita de monitoramento removida para solicitação ${solicitacaoId}, índice ${indiceVisita}`);
        return resultado;
    }
    /**
     * Tarefa agendada para executar diariamente e verificar solicitações que precisam de monitoramento
     */
    async verificarMonitoramentoObrigatorio() {
        this.logger.log('Iniciando verificação diária de monitoramento para Aluguel Social');
        try {
            // Obter solicitações que já ultrapassaram a data de monitoramento
            const solicitacoesParaMonitoramento = await this.getSolicitacoesParaMonitoramento();
            this.logger.log(`Encontradas ${solicitacoesParaMonitoramento.length} solicitações que precisam de monitoramento`);
            // Enviar notificações para solicitações com visitas pendentes
            for (const solicitacao of solicitacoesParaMonitoramento) {
                const dataLimite = new Date();
                this.notificacaoService.notificarMonitoramentoPendente(solicitacao, dataLimite);
            }
            // Obter solicitações com alertas de monitoramento próximo
            const solicitacoesComAlerta = await this.getSolicitacoesComAlertaMonitoramento();
            this.logger.log(`Encontradas ${solicitacoesComAlerta.length} solicitações com alerta de monitoramento próximo`);
            // Enviar notificações para solicitações com visitas programadas em breve
            for (const solicitacao of solicitacoesComAlerta) {
                if (solicitacao.dados_complementares?.proxima_visita_monitoramento) {
                    const dataProximaVisita = new Date(solicitacao.dados_complementares.proxima_visita_monitoramento);
                    const hoje = new Date();
                    const diasRestantes = Math.ceil((dataProximaVisita.getTime() - hoje.getTime()) /
                        (1000 * 60 * 60 * 24));
                    this.notificacaoService.notificarMonitoramentoProximo(solicitacao, dataProximaVisita, diasRestantes);
                }
            }
            this.logger.log('Verificação de monitoramento concluída com sucesso');
        }
        catch (error) {
            this.logger.error('Erro ao verificar monitoramento obrigatório', error.stack);
        }
    }
};
exports.MonitoramentoAluguelSocialService = MonitoramentoAluguelSocialService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_DAY_AT_MIDNIGHT),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], MonitoramentoAluguelSocialService.prototype, "verificarMonitoramentoObrigatorio", null);
exports.MonitoramentoAluguelSocialService = MonitoramentoAluguelSocialService = MonitoramentoAluguelSocialService_1 = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(solicitacao_entity_1.Solicitacao)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof notificacao_service_1.NotificacaoService !== "undefined" && notificacao_service_1.NotificacaoService) === "function" ? _b : Object])
], MonitoramentoAluguelSocialService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxldWRyZVxcT25lRHJpdmVcXERlc2t0b3BcXFByb2pldG9zXFxwZ2JlblxccGdiZW4tc2VydmVyXFxzcmNcXG1vZHVsZXNcXHNvbGljaXRhY2FvXFxzZXJ2aWNlc1xcbW9uaXRvcmFtZW50by1hbHVndWVsLXNvY2lhbC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELDZDQUFtRDtBQUNuRCxxQ0FBcUM7QUFDckMsNkVBRzhDO0FBQzlDLDRFQUFtRTtBQUNuRSwrQ0FBd0Q7QUFDeEQsK0RBQTJEO0FBRTNEOzs7OztHQUtHO0FBRUksSUFBTSxpQ0FBaUMseUNBQXZDLE1BQU0saUNBQWlDO0lBV3pCO0lBQ0E7SUFYRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsbUNBQWlDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0UsMENBQTBDO0lBQ3pCLDBCQUEwQixHQUFHLEVBQUUsQ0FBQztJQUVqRCxvREFBb0Q7SUFDbkMsd0JBQXdCLEdBQUcsRUFBRSxDQUFDO0lBRS9DLFlBRW1CLHFCQUE4QyxFQUM5QyxrQkFBc0M7UUFEdEMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF5QjtRQUM5Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0lBQ3RELENBQUM7SUFFSjs7OztPQUlHO0lBQ0gsZUFBZSxDQUFDLFdBQXdCO1FBQ3RDLHVDQUF1QztRQUN2QyxJQUNFLFdBQVcsQ0FBQyxjQUFjO1lBQzFCLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxLQUFLLG1DQUFhLENBQUMsY0FBYyxFQUNoRSxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsb0VBQW9FO1FBQ3BFLElBQ0UsV0FBVyxDQUFDLG9CQUFvQjtZQUNoQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsY0FBYztnQkFDN0MsbUNBQWEsQ0FBQyxjQUFjLEVBQzlCLENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxPQUFPLEtBQUss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SUFETCxJQUFBLGVBQUksRUFBQyx5QkFBYyxDQUFDLHFCQUFxQixDQUFDOzs7OzBGQTJEMUM7NENBOWlCVSxpQ0FBaUM7SUFEN0MsSUFBQSxtQkFBVSxHQUFFO0lBV1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLGdDQUFXLENBQUMsQ0FBQTt5REFDVSxvQkFBVSxvQkFBVixvQkFBVSxvREFDYix3Q0FBa0Isb0JBQWxCLHdDQUFrQjtHQVo5QyxpQ0FBaUMsQ0EraUI3QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGV1ZHJlXFxPbmVEcml2ZVxcRGVza3RvcFxcUHJvamV0b3NcXHBnYmVuXFxwZ2Jlbi1zZXJ2ZXJcXHNyY1xcbW9kdWxlc1xcc29saWNpdGFjYW9cXHNlcnZpY2VzXFxtb25pdG9yYW1lbnRvLWFsdWd1ZWwtc29jaWFsLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0UmVwb3NpdG9yeSB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XG5pbXBvcnQge1xuICBTb2xpY2l0YWNhbyxcbiAgU3RhdHVzU29saWNpdGFjYW8sXG59IGZyb20gJy4uLy4uLy4uL2VudGl0aWVzL3NvbGljaXRhY2FvLmVudGl0eSc7XG5pbXBvcnQgeyBUaXBvQmVuZWZpY2lvIH0gZnJvbSAnLi4vLi4vLi4vZW51bXMvdGlwby1iZW5lZmljaW8uZW51bSc7XG5pbXBvcnQgeyBDcm9uLCBDcm9uRXhwcmVzc2lvbiB9IGZyb20gJ0BuZXN0anMvc2NoZWR1bGUnO1xuaW1wb3J0IHsgTm90aWZpY2FjYW9TZXJ2aWNlIH0gZnJvbSAnLi9ub3RpZmljYWNhby5zZXJ2aWNlJztcblxuLyoqXG4gKiBTZXJ2acOnbyByZXNwb25zw6F2ZWwgcGVsbyBtb25pdG9yYW1lbnRvIG9icmlnYXTDs3JpbyBkZSBzb2xpY2l0YcOnw7VlcyBkZSBBbHVndWVsIFNvY2lhbFxuICpcbiAqIEVzdGUgc2VydmnDp28gZ2FyYW50ZSBxdWUgYXMgc29saWNpdGHDp8O1ZXMgZGUgQWx1Z3VlbCBTb2NpYWwgc2VqYW0gbW9uaXRvcmFkYXMgcmVndWxhcm1lbnRlXG4gKiBkZSBhY29yZG8gY29tIGFzIHJlZ3JhcyBkZSBuZWfDs2NpbyBlc3RhYmVsZWNpZGFzLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTW9uaXRvcmFtZW50b0FsdWd1ZWxTb2NpYWxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKE1vbml0b3JhbWVudG9BbHVndWVsU29jaWFsU2VydmljZS5uYW1lKTtcblxuICAvLyBQZXLDrW9kbyBwYWRyw6NvIGRlIG1vbml0b3JhbWVudG8gZW0gZGlhc1xuICBwcml2YXRlIHJlYWRvbmx5IFBFUklPRE9fTU9OSVRPUkFNRU5UT19ESUFTID0gOTA7XG5cbiAgLy8gRGlhcyBkZSBhbnRlY2Vkw6puY2lhIHBhcmEgYWxlcnRhIGRlIG1vbml0b3JhbWVudG9cbiAgcHJpdmF0ZSByZWFkb25seSBESUFTX0FMRVJUQV9BTlRFQ0VERU5DSUEgPSAxNTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0UmVwb3NpdG9yeShTb2xpY2l0YWNhbylcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNvbGljaXRhY2FvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxTb2xpY2l0YWNhbz4sXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYWNhb1NlcnZpY2U6IE5vdGlmaWNhY2FvU2VydmljZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSB1bWEgc29saWNpdGHDp8OjbyDDqSBkbyB0aXBvIEFsdWd1ZWwgU29jaWFsXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhbyBTb2xpY2l0YcOnw6NvIGEgc2VyIHZlcmlmaWNhZGFcbiAgICogQHJldHVybnMgVmVyZGFkZWlybyBzZSBmb3IgQWx1Z3VlbCBTb2NpYWwsIGZhbHNvIGNhc28gY29udHLDoXJpb1xuICAgKi9cbiAgaXNBbHVndWVsU29jaWFsKHNvbGljaXRhY2FvOiBTb2xpY2l0YWNhbyk6IGJvb2xlYW4ge1xuICAgIC8vIFZlcmlmaWNhciBwZWxvIHRpcG9fYmVuZWZpY2lvIGRpcmV0b1xuICAgIGlmIChcbiAgICAgIHNvbGljaXRhY2FvLnRpcG9fYmVuZWZpY2lvICYmXG4gICAgICBzb2xpY2l0YWNhby50aXBvX2JlbmVmaWNpby5ub21lID09PSBUaXBvQmVuZWZpY2lvLkFMVUdVRUxfU09DSUFMXG4gICAgKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgcGVsbyB0aXBvX2JlbmVmaWNpb19pZCBhdHJhdsOpcyBkb3MgZGFkb3MgY29tcGxlbWVudGFyZXNcbiAgICBpZiAoXG4gICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcyAmJlxuICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudGlwb19iZW5lZmljaW8gPT09XG4gICAgICAgIFRpcG9CZW5lZmljaW8uQUxVR1VFTF9TT0NJQUxcbiAgICApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBhIHNvbGljaXRhw6fDo28gZXN0w6EgZW0gdW0gZXN0YWRvIHF1ZSByZXF1ZXIgbW9uaXRvcmFtZW50b1xuICAgKiBAcGFyYW0gc29saWNpdGFjYW8gU29saWNpdGHDp8OjbyBhIHNlciB2ZXJpZmljYWRhXG4gICAqIEByZXR1cm5zIFZlcmRhZGVpcm8gc2UgZXN0aXZlciBlbSBlc3RhZG8gcXVlIHJlcXVlciBtb25pdG9yYW1lbnRvXG4gICAqL1xuICByZXF1aXJlc01vbml0b3Jpbmcoc29saWNpdGFjYW86IFNvbGljaXRhY2FvKTogYm9vbGVhbiB7XG4gICAgLy8gU29saWNpdGHDp8O1ZXMgYXByb3ZhZGFzIGUgZW0gY29uY2Vzc8OjbyByZXF1ZXJlbSBtb25pdG9yYW1lbnRvXG4gICAgY29uc3Qgc3RhdHVzTW9uaXRvcmFkb3MgPSBbXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5BUFJPVkFEQSxcbiAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkVNX1BST0NFU1NBTUVOVE8sXG4gICAgICBTdGF0dXNTb2xpY2l0YWNhby5MSUJFUkFEQSxcbiAgICBdO1xuXG4gICAgcmV0dXJuIHN0YXR1c01vbml0b3JhZG9zLmluY2x1ZGVzKHNvbGljaXRhY2FvLnN0YXR1cyk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYSBhIGRhdGEgZGEgcHLDs3hpbWEgdmlzaXRhIGRlIG1vbml0b3JhbWVudG9cbiAgICogQHBhcmFtIHVsdGltYVZpc2l0YSBEYXRhIGRhIMO6bHRpbWEgdmlzaXRhIG91IG51bGwgc2UgbsOjbyBob3V2ZXJcbiAgICogQHJldHVybnMgRGF0YSBkYSBwcsOzeGltYSB2aXNpdGEgYWdlbmRhZGFcbiAgICovXG4gIGNhbGN1bGFyUHJveGltYVZpc2l0YSh1bHRpbWFWaXNpdGE/OiBEYXRlKTogRGF0ZSB7XG4gICAgY29uc3QgaG9qZSA9IG5ldyBEYXRlKCk7XG5cbiAgICBpZiAoIXVsdGltYVZpc2l0YSkge1xuICAgICAgLy8gU2UgbsOjbyBob3V2ZXIgw7psdGltYSB2aXNpdGEsIGEgcHLDs3hpbWEgZGV2ZSBzZXIgZW0gMzAgZGlhc1xuICAgICAgY29uc3QgcHJveGltYVZpc2l0YSA9IG5ldyBEYXRlKGhvamUpO1xuICAgICAgcHJveGltYVZpc2l0YS5zZXREYXRlKHByb3hpbWFWaXNpdGEuZ2V0RGF0ZSgpICsgMzApO1xuICAgICAgcmV0dXJuIHByb3hpbWFWaXNpdGE7XG4gICAgfVxuXG4gICAgLy8gQ2FzbyBjb250csOhcmlvLCBwcsOzeGltYSB2aXNpdGEgZGV2ZSBzZXIgZW0gUEVSSU9ET19NT05JVE9SQU1FTlRPX0RJQVNcbiAgICBjb25zdCBwcm94aW1hVmlzaXRhID0gbmV3IERhdGUodWx0aW1hVmlzaXRhKTtcbiAgICBwcm94aW1hVmlzaXRhLnNldERhdGUoXG4gICAgICBwcm94aW1hVmlzaXRhLmdldERhdGUoKSArIHRoaXMuUEVSSU9ET19NT05JVE9SQU1FTlRPX0RJQVMsXG4gICAgKTtcbiAgICByZXR1cm4gcHJveGltYVZpc2l0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RyYSB1bWEgbm92YSB2aXNpdGEgcGFyYSB1bWEgc29saWNpdGHDp8Ojb1xuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBkYXRhVmlzaXRhIERhdGEgZGEgdmlzaXRhXG4gICAqIEBwYXJhbSBvYnNlcnZhY29lcyBPYnNlcnZhw6fDtWVzIGRhIHZpc2l0YVxuICAgKiBAcGFyYW0gdXN1YXJpbyBVc3XDoXJpbyBxdWUgcmVhbGl6b3UgYSB2aXNpdGFcbiAgICovXG4gIGFzeW5jIHJlZ2lzdHJhclZpc2l0YShcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgZGF0YVZpc2l0YTogRGF0ZSxcbiAgICBvYnNlcnZhY29lczogc3RyaW5nLFxuICAgIHVzdWFyaW86IGFueSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXNvbGljaXRhY2FvKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGE6ICR7c29saWNpdGFjYW9JZH1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGEnKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYSBzZSDDqSBhbHVndWVsIHNvY2lhbFxuICAgIGlmICghdGhpcy5pc0FsdWd1ZWxTb2NpYWwoc29saWNpdGFjYW8pKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFRlbnRhdGl2YSBkZSByZWdpc3RyYXIgdmlzaXRhIHBhcmEgc29saWNpdGHDp8OjbyBxdWUgbsOjbyDDqSBkZSBBbHVndWVsIFNvY2lhbDogJHtzb2xpY2l0YWNhb0lkfWAsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb2xpY2l0YcOnw6NvIG7Do28gw6kgZGUgQWx1Z3VlbCBTb2NpYWwnKTtcbiAgICB9XG5cbiAgICAvLyBJbmljaWFsaXphIG8gaGlzdMOzcmljbyBkZSB2aXNpdGFzIHNlIG7Do28gZXhpc3RpclxuICAgIGlmICghc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMpIHtcbiAgICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzID0ge307XG4gICAgfVxuXG4gICAgaWYgKCFzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy52aXNpdGFzX21vbml0b3JhbWVudG8pIHtcbiAgICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLnZpc2l0YXNfbW9uaXRvcmFtZW50byA9IFtdO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGEgYSBkYXRhIGRhIHByw7N4aW1hIHZpc2l0YVxuICAgIGNvbnN0IHByb3hpbWFWaXNpdGEgPSB0aGlzLmNhbGN1bGFyUHJveGltYVZpc2l0YShkYXRhVmlzaXRhKTtcblxuICAgIC8vIEFkaWNpb25hIGEgbm92YSB2aXNpdGEgYW8gaGlzdMOzcmljb1xuICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLnZpc2l0YXNfbW9uaXRvcmFtZW50by5wdXNoKHtcbiAgICAgIGRhdGE6IGRhdGFWaXNpdGEsXG4gICAgICBvYnNlcnZhY29lcyxcbiAgICAgIHVzdWFyaW9faWQ6IHVzdWFyaW8uaWQsXG4gICAgICBub21lX3VzdWFyaW86IHVzdWFyaW8ubm9tZSB8fCAnU2lzdGVtYScsXG4gICAgICBwcm94aW1hX3Zpc2l0YTogcHJveGltYVZpc2l0YSxcbiAgICB9KTtcblxuICAgIC8vIEF0dWFsaXphIGEgZGF0YSBkYSBwcsOzeGltYSB2aXNpdGFcbiAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy5wcm94aW1hX3Zpc2l0YV9tb25pdG9yYW1lbnRvID1cbiAgICAgIHByb3hpbWFWaXNpdGE7XG5cbiAgICAvLyBTYWx2YSBhcyBhbHRlcmHDp8O1ZXNcbiAgICBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5zYXZlKHNvbGljaXRhY2FvKTtcblxuICAgIC8vIEVudmlhIG5vdGlmaWNhw6fDo28gc29icmUgbyByZWdpc3RybyBkYSB2aXNpdGFcbiAgICB0aGlzLm5vdGlmaWNhY2FvU2VydmljZS5ub3RpZmljYXJWaXNpdGFNb25pdG9yYW1lbnRvUmVnaXN0cmFkYShcbiAgICAgIHNvbGljaXRhY2FvLFxuICAgICAgZGF0YVZpc2l0YSxcbiAgICAgIHByb3hpbWFWaXNpdGEsXG4gICAgKTtcblxuICAgIHRoaXMubG9nZ2VyLmxvZyhgVmlzaXRhIHJlZ2lzdHJhZGEgcGFyYSBzb2xpY2l0YcOnw6NvICR7c29saWNpdGFjYW9JZH1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnTDqW0gYXMgc29saWNpdGHDp8O1ZXMgZGUgQWx1Z3VlbCBTb2NpYWwgcXVlIHByZWNpc2FtIGRlIG1vbml0b3JhbWVudG9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgc29saWNpdGHDp8O1ZXMgcXVlIHByZWNpc2FtIGRlIG1vbml0b3JhbWVudG9cbiAgICovXG4gIGFzeW5jIGdldFNvbGljaXRhY29lc1BhcmFNb25pdG9yYW1lbnRvKCk6IFByb21pc2U8U29saWNpdGFjYW9bXT4ge1xuICAgIGNvbnN0IGhvamUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID0gdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnlcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoJ3NvbGljaXRhY2FvJylcbiAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdCgnc29saWNpdGFjYW8udGlwb19iZW5lZmljaW8nLCAndGlwb19iZW5lZmljaW8nKVxuICAgICAgLndoZXJlKCdzb2xpY2l0YWNhby5zdGF0dXMgSU4gKDouLi5zdGF0dXNNb25pdG9yYWRvcyknLCB7XG4gICAgICAgIHN0YXR1c01vbml0b3JhZG9zOiBbXG4gICAgICAgICAgU3RhdHVzU29saWNpdGFjYW8uQVBST1ZBREEsXG4gICAgICAgICAgU3RhdHVzU29saWNpdGFjYW8uRU1fUFJPQ0VTU0FNRU5UTyxcbiAgICAgICAgICBTdGF0dXNTb2xpY2l0YWNhby5MSUJFUkFEQSxcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgICAuYW5kV2hlcmUoXG4gICAgICAgIFwiKHRpcG9fYmVuZWZpY2lvLm5vbWUgPSA6dGlwb0JlbmVmaWNpbyBPUiBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy0+Pid0aXBvX2JlbmVmaWNpbycgPSA6dGlwb0JlbmVmaWNpb1N0cilcIixcbiAgICAgICAge1xuICAgICAgICAgIHRpcG9CZW5lZmljaW86IFRpcG9CZW5lZmljaW8uQUxVR1VFTF9TT0NJQUwsXG4gICAgICAgICAgdGlwb0JlbmVmaWNpb1N0cjogVGlwb0JlbmVmaWNpby5BTFVHVUVMX1NPQ0lBTCxcbiAgICAgICAgfSxcbiAgICAgIClcbiAgICAgIC5hbmRXaGVyZShcbiAgICAgICAgXCIoc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMtPidwcm94aW1hX3Zpc2l0YV9tb25pdG9yYW1lbnRvJyBJUyBOVUxMIE9SIFwiICtcbiAgICAgICAgICBcIkNBU1Qoc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMtPj4ncHJveGltYV92aXNpdGFfbW9uaXRvcmFtZW50bycgQVMgVElNRVNUQU1QKSA8PSA6ZGF0YUxpbWl0ZSlcIixcbiAgICAgICAge1xuICAgICAgICAgIGRhdGFMaW1pdGU6IGhvamUsXG4gICAgICAgIH0sXG4gICAgICApXG4gICAgICAub3JkZXJCeSgnc29saWNpdGFjYW8udXBkYXRlZF9hdCcsICdBU0MnKTtcblxuICAgIHJldHVybiBxdWVyeUJ1aWxkZXIuZ2V0TWFueSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idMOpbSBhcyBzb2xpY2l0YcOnw7VlcyBxdWUgZXN0w6NvIHByw7N4aW1hcyBkYSBkYXRhIGRlIG1vbml0b3JhbWVudG9cbiAgICogQHJldHVybnMgTGlzdGEgZGUgc29saWNpdGHDp8O1ZXMgY29tIGFsZXJ0YSBkZSBtb25pdG9yYW1lbnRvXG4gICAqL1xuICBhc3luYyBnZXRTb2xpY2l0YWNvZXNDb21BbGVydGFNb25pdG9yYW1lbnRvKCk6IFByb21pc2U8U29saWNpdGFjYW9bXT4ge1xuICAgIGNvbnN0IGhvamUgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGRhdGFMaW1pdGVBbGVydGEgPSBuZXcgRGF0ZShob2plKTtcbiAgICBkYXRhTGltaXRlQWxlcnRhLnNldERhdGUoaG9qZS5nZXREYXRlKCkgKyB0aGlzLkRJQVNfQUxFUlRBX0FOVEVDRURFTkNJQSk7XG5cbiAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeVxuICAgICAgLmNyZWF0ZVF1ZXJ5QnVpbGRlcignc29saWNpdGFjYW8nKVxuICAgICAgLmxlZnRKb2luQW5kU2VsZWN0KCdzb2xpY2l0YWNhby50aXBvX2JlbmVmaWNpbycsICd0aXBvX2JlbmVmaWNpbycpXG4gICAgICAud2hlcmUoJ3NvbGljaXRhY2FvLnN0YXR1cyBJTiAoOi4uLnN0YXR1c01vbml0b3JhZG9zKScsIHtcbiAgICAgICAgc3RhdHVzTW9uaXRvcmFkb3M6IFtcbiAgICAgICAgICBTdGF0dXNTb2xpY2l0YWNhby5BUFJPVkFEQSxcbiAgICAgICAgICBTdGF0dXNTb2xpY2l0YWNhby5FTV9QUk9DRVNTQU1FTlRPLFxuICAgICAgICAgIFN0YXR1c1NvbGljaXRhY2FvLkxJQkVSQURBLFxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICAgIC5hbmRXaGVyZShcbiAgICAgICAgXCIodGlwb19iZW5lZmljaW8ubm9tZSA9IDp0aXBvQmVuZWZpY2lvIE9SIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLT4+J3RpcG9fYmVuZWZpY2lvJyA9IDp0aXBvQmVuZWZpY2lvU3RyKVwiLFxuICAgICAgICB7XG4gICAgICAgICAgdGlwb0JlbmVmaWNpbzogVGlwb0JlbmVmaWNpby5BTFVHVUVMX1NPQ0lBTCxcbiAgICAgICAgICB0aXBvQmVuZWZpY2lvU3RyOiBUaXBvQmVuZWZpY2lvLkFMVUdVRUxfU09DSUFMLFxuICAgICAgICB9LFxuICAgICAgKVxuICAgICAgLmFuZFdoZXJlKFxuICAgICAgICBcIihzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy0+J3Byb3hpbWFfdmlzaXRhX21vbml0b3JhbWVudG8nIElTIE5PVCBOVUxMIEFORCBcIiArXG4gICAgICAgICAgXCJDQVNUKHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLT4+J3Byb3hpbWFfdmlzaXRhX21vbml0b3JhbWVudG8nIEFTIFRJTUVTVEFNUCkgPiA6aG9qZSBBTkQgXCIgK1xuICAgICAgICAgIFwiQ0FTVChzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy0+Pidwcm94aW1hX3Zpc2l0YV9tb25pdG9yYW1lbnRvJyBBUyBUSU1FU1RBTVApIDw9IDpkYXRhTGltaXRlKVwiLFxuICAgICAgICB7XG4gICAgICAgICAgaG9qZTogaG9qZSxcbiAgICAgICAgICBkYXRhTGltaXRlOiBkYXRhTGltaXRlQWxlcnRhLFxuICAgICAgICB9LFxuICAgICAgKVxuICAgICAgLm9yZGVyQnkoXG4gICAgICAgIFwic29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMtPj4ncHJveGltYV92aXNpdGFfbW9uaXRvcmFtZW50bydcIixcbiAgICAgICAgJ0FTQycsXG4gICAgICApO1xuXG4gICAgcmV0dXJuIHF1ZXJ5QnVpbGRlci5nZXRNYW55KCk7XG4gIH1cblxuICAvKipcbiAgICogT2J0w6ltIHVtYSBzb2xpY2l0YcOnw6NvIHBlbG8gSURcbiAgICogQHBhcmFtIGlkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHJldHVybnMgU29saWNpdGHDp8OjbyBlbmNvbnRyYWRhIG91IG51bGxcbiAgICovXG4gIGFzeW5jIGdldFNvbGljaXRhY2FvQnlJZChpZDogc3RyaW5nKTogUHJvbWlzZTxTb2xpY2l0YWNhbyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc29saWNpdGFjYW9SZXBvc2l0b3J5LmZpbmRPbmUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICByZWxhdGlvbnM6IFsndGlwb19iZW5lZmljaW8nXSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm8gYW8gYnVzY2FyIHNvbGljaXRhw6fDo286ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXR1YWxpemEgdW1hIHZpc2l0YSBkZSBtb25pdG9yYW1lbnRvIGV4aXN0ZW50ZVxuICAgKiBAcGFyYW0gc29saWNpdGFjYW9JZCBJRCBkYSBzb2xpY2l0YcOnw6NvXG4gICAqIEBwYXJhbSBpbmRpY2VWaXNpdGEgw41uZGljZSBkYSB2aXNpdGEgbm8gYXJyYXkgZGUgdmlzaXRhc1xuICAgKiBAcGFyYW0gZGFkb3NBdHVhbGl6YWNhbyBEYWRvcyBwYXJhIGF0dWFsaXphw6fDo28gcGFyY2lhbCBkYSB2aXNpdGFcbiAgICogQHBhcmFtIHVzdWFyaW8gVXN1w6FyaW8gcXVlIGVzdMOhIHJlYWxpemFuZG8gYSBhdHVhbGl6YcOnw6NvXG4gICAqIEByZXR1cm5zIEEgdmlzaXRhIGF0dWFsaXphZGFcbiAgICovXG4gIGFzeW5jIGF0dWFsaXphclZpc2l0YU1vbml0b3JhbWVudG8oXG4gICAgc29saWNpdGFjYW9JZDogc3RyaW5nLFxuICAgIGluZGljZVZpc2l0YTogbnVtYmVyLFxuICAgIGRhZG9zQXR1YWxpemFjYW86IHtcbiAgICAgIGRhdGFfdmlzaXRhPzogRGF0ZTtcbiAgICAgIG9ic2VydmFjb2VzPzogc3RyaW5nO1xuICAgICAgZGFkb3NfYWRpY2lvbmFpcz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgfSxcbiAgICB1c3VhcmlvOiBhbnksXG4gICk6IFByb21pc2U8YW55PiB7XG4gICAgLy8gQnVzY2FyIGEgc29saWNpdGHDp8Ojb1xuICAgIGNvbnN0IHNvbGljaXRhY2FvID0gYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBpZDogc29saWNpdGFjYW9JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFzb2xpY2l0YWNhbykge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYFNvbGljaXRhw6fDo28gbsOjbyBlbmNvbnRyYWRhOiAke3NvbGljaXRhY2FvSWR9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvbGljaXRhw6fDo28gbsOjbyBlbmNvbnRyYWRhJyk7XG4gICAgfVxuXG4gICAgLy8gVmVyaWZpY2FyIHNlIMOpIGFsdWd1ZWwgc29jaWFsXG4gICAgaWYgKCF0aGlzLmlzQWx1Z3VlbFNvY2lhbChzb2xpY2l0YWNhbykpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgVGVudGF0aXZhIGRlIGF0dWFsaXphciB2aXNpdGEgcGFyYSBzb2xpY2l0YcOnw6NvIHF1ZSBuw6NvIMOpIGRlIEFsdWd1ZWwgU29jaWFsOiAke3NvbGljaXRhY2FvSWR9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvbGljaXRhw6fDo28gbsOjbyDDqSBkZSBBbHVndWVsIFNvY2lhbCcpO1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciBzZSBleGlzdGVtIHZpc2l0YXMgcmVnaXN0cmFkYXNcbiAgICBpZiAoXG4gICAgICAhc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXM/LnZpc2l0YXNfbW9uaXRvcmFtZW50byB8fFxuICAgICAgIUFycmF5LmlzQXJyYXkoc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvKSB8fFxuICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aCA9PT0gMFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnU29saWNpdGHDp8OjbyBuw6NvIHBvc3N1aSB2aXNpdGFzIGRlIG1vbml0b3JhbWVudG8gcmVnaXN0cmFkYXMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyDDrW5kaWNlIMOpIHbDoWxpZG9cbiAgICBpZiAoXG4gICAgICBpbmRpY2VWaXNpdGEgPCAwIHx8XG4gICAgICBpbmRpY2VWaXNpdGEgPj1cbiAgICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdWaXNpdGEgbsOjbyBlbmNvbnRyYWRhIGNvbSBvIMOtbmRpY2UgZm9ybmVjaWRvJyk7XG4gICAgfVxuXG4gICAgLy8gT2J0ZXIgYSB2aXNpdGEgYSBzZXIgYXR1YWxpemFkYVxuICAgIGNvbnN0IHZpc2l0YSA9XG4gICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy52aXNpdGFzX21vbml0b3JhbWVudG9baW5kaWNlVmlzaXRhXTtcblxuICAgIC8vIFJlZ2lzdHJhciBkYWRvcyBkYSBhdHVhbGl6YcOnw6NvXG4gICAgY29uc3QgZGF0YUF0dWFsaXphY2FvID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBkYWRvc0F0dWFsaXphZG9yID0ge1xuICAgICAgdXN1YXJpb19pZDogdXN1YXJpby5pZCxcbiAgICAgIG5vbWVfdXN1YXJpbzogdXN1YXJpby5ub21lIHx8ICdTaXN0ZW1hJyxcbiAgICAgIGRhdGFfYXR1YWxpemFjYW86IGRhdGFBdHVhbGl6YWNhbyxcbiAgICB9O1xuXG4gICAgLy8gQXR1YWxpemFyIGRhZG9zIGRhIHZpc2l0YVxuICAgIGlmIChkYWRvc0F0dWFsaXphY2FvLmRhdGFfdmlzaXRhKSB7XG4gICAgICB2aXNpdGEuZGF0YSA9IGRhZG9zQXR1YWxpemFjYW8uZGF0YV92aXNpdGE7XG4gICAgfVxuXG4gICAgaWYgKGRhZG9zQXR1YWxpemFjYW8ub2JzZXJ2YWNvZXMpIHtcbiAgICAgIHZpc2l0YS5vYnNlcnZhY29lcyA9IGRhZG9zQXR1YWxpemFjYW8ub2JzZXJ2YWNvZXM7XG4gICAgfVxuXG4gICAgaWYgKGRhZG9zQXR1YWxpemFjYW8uZGFkb3NfYWRpY2lvbmFpcykge1xuICAgICAgdmlzaXRhLmRhZG9zX2FkaWNpb25haXMgPSB7XG4gICAgICAgIC4uLih2aXNpdGEuZGFkb3NfYWRpY2lvbmFpcyB8fCB7fSksXG4gICAgICAgIC4uLmRhZG9zQXR1YWxpemFjYW8uZGFkb3NfYWRpY2lvbmFpcyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQWRpY2lvbmFyIGluZm9ybWHDp8O1ZXMgc29icmUgYSBhdHVhbGl6YcOnw6NvXG4gICAgaWYgKCF2aXNpdGEuaGlzdG9yaWNvX2F0dWFsaXphY29lcykge1xuICAgICAgdmlzaXRhLmhpc3Rvcmljb19hdHVhbGl6YWNvZXMgPSBbXTtcbiAgICB9XG5cbiAgICB2aXNpdGEuaGlzdG9yaWNvX2F0dWFsaXphY29lcy5wdXNoKHtcbiAgICAgIC4uLmRhZG9zQXR1YWxpemFkb3IsXG4gICAgICBkYWRvc19hbnRlcmlvcmVzOiB7XG4gICAgICAgIGRhdGE6IHZpc2l0YS5kYXRhLFxuICAgICAgICBvYnNlcnZhY29lczogdmlzaXRhLm9ic2VydmFjb2VzLFxuICAgICAgICBkYWRvc19hZGljaW9uYWlzOiB2aXNpdGEuZGFkb3NfYWRpY2lvbmFpcyxcbiAgICAgIH0sXG4gICAgICBjYW1wb3NfYXR1YWxpemFkb3M6IE9iamVjdC5rZXlzKGRhZG9zQXR1YWxpemFjYW8pLFxuICAgIH0pO1xuXG4gICAgdmlzaXRhLnVsdGltYV9hdHVhbGl6YWNhbyA9IGRhZG9zQXR1YWxpemFkb3I7XG5cbiAgICAvLyBSZWNhbGN1bGFyIHByw7N4aW1hIHZpc2l0YSBhcGVuYXMgc2UgYSBkYXRhIGZvciBhbHRlcmFkYVxuICAgIGlmIChkYWRvc0F0dWFsaXphY2FvLmRhdGFfdmlzaXRhKSB7XG4gICAgICBjb25zdCBwcm94aW1hVmlzaXRhID0gdGhpcy5jYWxjdWxhclByb3hpbWFWaXNpdGEoXG4gICAgICAgIGRhZG9zQXR1YWxpemFjYW8uZGF0YV92aXNpdGEsXG4gICAgICApO1xuICAgICAgdmlzaXRhLnByb3hpbWFfdmlzaXRhID0gcHJveGltYVZpc2l0YTtcblxuICAgICAgLy8gQXR1YWxpemFyIGEgZGF0YSBkYSBwcsOzeGltYSB2aXNpdGEgbmEgc29saWNpdGHDp8OjbyBhcGVuYXMgc2UgZXN0YSBmb3IgYSDDumx0aW1hIHZpc2l0YVxuICAgICAgaWYgKFxuICAgICAgICBpbmRpY2VWaXNpdGEgPT09XG4gICAgICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLnZpc2l0YXNfbW9uaXRvcmFtZW50by5sZW5ndGggLSAxXG4gICAgICApIHtcbiAgICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMucHJveGltYV92aXNpdGFfbW9uaXRvcmFtZW50byA9XG4gICAgICAgICAgcHJveGltYVZpc2l0YTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTYWx2YXIgYXMgYWx0ZXJhw6fDtWVzXG4gICAgYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuc2F2ZShzb2xpY2l0YWNhbyk7XG5cbiAgICAvLyBOb3RpZmljYXIgc29icmUgYSBhdHVhbGl6YcOnw6NvIHNlIGEgZGF0YSBmb2kgYWx0ZXJhZGFcbiAgICBpZiAoZGFkb3NBdHVhbGl6YWNhby5kYXRhX3Zpc2l0YSkge1xuICAgICAgdGhpcy5ub3RpZmljYWNhb1NlcnZpY2Uubm90aWZpY2FyVmlzaXRhTW9uaXRvcmFtZW50b1JlZ2lzdHJhZGEoXG4gICAgICAgIHNvbGljaXRhY2FvLFxuICAgICAgICB2aXNpdGEuZGF0YSxcbiAgICAgICAgdmlzaXRhLnByb3hpbWFfdmlzaXRhLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgVmlzaXRhIGRlIG1vbml0b3JhbWVudG8gYXR1YWxpemFkYSBwYXJhIHNvbGljaXRhw6fDo28gJHtzb2xpY2l0YWNhb0lkfSwgw61uZGljZSAke2luZGljZVZpc2l0YX1gLFxuICAgICk7XG5cbiAgICByZXR1cm4gdmlzaXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1bWEgdmlzaXRhIGRlIG1vbml0b3JhbWVudG8gZXhpc3RlbnRlXG4gICAqIEBwYXJhbSBzb2xpY2l0YWNhb0lkIElEIGRhIHNvbGljaXRhw6fDo29cbiAgICogQHBhcmFtIGluZGljZVZpc2l0YSDDjW5kaWNlIGRhIHZpc2l0YSBubyBhcnJheSBkZSB2aXNpdGFzXG4gICAqIEBwYXJhbSB1c3VhcmlvIFVzdcOhcmlvIHF1ZSBlc3TDoSByZWFsaXphbmRvIGEgZXhjbHVzw6NvXG4gICAqIEByZXR1cm5zIEluZm9ybWHDp8O1ZXMgc29icmUgYSBvcGVyYcOnw6NvXG4gICAqL1xuICBhc3luYyByZW1vdmVyVmlzaXRhTW9uaXRvcmFtZW50byhcbiAgICBzb2xpY2l0YWNhb0lkOiBzdHJpbmcsXG4gICAgaW5kaWNlVmlzaXRhOiBudW1iZXIsXG4gICAgdXN1YXJpbzogYW55LFxuICApOiBQcm9taXNlPHsgc3VjY2VzczogYm9vbGVhbjsgcHJveGltYVZpc2l0YUF0dWFsaXphZGE/OiBEYXRlIH0+IHtcbiAgICAvLyBCdXNjYXIgYSBzb2xpY2l0YcOnw6NvXG4gICAgY29uc3Qgc29saWNpdGFjYW8gPSBhd2FpdCB0aGlzLnNvbGljaXRhY2FvUmVwb3NpdG9yeS5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzb2xpY2l0YWNhb0lkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXNvbGljaXRhY2FvKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGE6ICR7c29saWNpdGFjYW9JZH1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU29saWNpdGHDp8OjbyBuw6NvIGVuY29udHJhZGEnKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2Ugw6kgYWx1Z3VlbCBzb2NpYWxcbiAgICBpZiAoIXRoaXMuaXNBbHVndWVsU29jaWFsKHNvbGljaXRhY2FvKSkge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBUZW50YXRpdmEgZGUgcmVtb3ZlciB2aXNpdGEgcGFyYSBzb2xpY2l0YcOnw6NvIHF1ZSBuw6NvIMOpIGRlIEFsdWd1ZWwgU29jaWFsOiAke3NvbGljaXRhY2FvSWR9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvbGljaXRhw6fDo28gbsOjbyDDqSBkZSBBbHVndWVsIFNvY2lhbCcpO1xuICAgIH1cblxuICAgIC8vIFZlcmlmaWNhciBzZSBleGlzdGVtIHZpc2l0YXMgcmVnaXN0cmFkYXNcbiAgICBpZiAoXG4gICAgICAhc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXM/LnZpc2l0YXNfbW9uaXRvcmFtZW50byB8fFxuICAgICAgIUFycmF5LmlzQXJyYXkoc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvKSB8fFxuICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aCA9PT0gMFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnU29saWNpdGHDp8OjbyBuw6NvIHBvc3N1aSB2aXNpdGFzIGRlIG1vbml0b3JhbWVudG8gcmVnaXN0cmFkYXMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZmljYXIgc2UgbyDDrW5kaWNlIMOpIHbDoWxpZG9cbiAgICBpZiAoXG4gICAgICBpbmRpY2VWaXNpdGEgPCAwIHx8XG4gICAgICBpbmRpY2VWaXNpdGEgPj1cbiAgICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdWaXNpdGEgbsOjbyBlbmNvbnRyYWRhIGNvbSBvIMOtbmRpY2UgZm9ybmVjaWRvJyk7XG4gICAgfVxuXG4gICAgLy8gQXJtYXplbmFyIGluZm9ybWHDp8O1ZXMgZGEgdmlzaXRhIGEgc2VyIHJlbW92aWRhIHBhcmEgbyBsb2dcbiAgICBjb25zdCB2aXNpdGFSZW1vdmlkYSA9XG4gICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy52aXNpdGFzX21vbml0b3JhbWVudG9baW5kaWNlVmlzaXRhXTtcblxuICAgIC8vIEluaWNpYWxpemFyIG8gaGlzdMOzcmljbyBkZSBleGNsdXPDtWVzIHNlIG7Do28gZXhpc3RpclxuICAgIGlmICghc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMuaGlzdG9yaWNvX2V4Y2x1c29lc192aXNpdGFzKSB7XG4gICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy5oaXN0b3JpY29fZXhjbHVzb2VzX3Zpc2l0YXMgPSBbXTtcbiAgICB9XG5cbiAgICAvLyBSZWdpc3RyYXIgYSBleGNsdXPDo28gbm8gaGlzdMOzcmljb1xuICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLmhpc3Rvcmljb19leGNsdXNvZXNfdmlzaXRhcy5wdXNoKHtcbiAgICAgIHZpc2l0YTogdmlzaXRhUmVtb3ZpZGEsXG4gICAgICBkYXRhX2V4Y2x1c2FvOiBuZXcgRGF0ZSgpLFxuICAgICAgdXN1YXJpb19pZDogdXN1YXJpby5pZCxcbiAgICAgIG5vbWVfdXN1YXJpbzogdXN1YXJpby5ub21lIHx8ICdTaXN0ZW1hJyxcbiAgICAgIG1vdGl2bzogJ0V4Y2x1c8OjbyBtYW51YWwgdmlhIEFQSScsXG4gICAgfSk7XG5cbiAgICAvLyBSZW1vdmVyIGEgdmlzaXRhIGRvIGFycmF5XG4gICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLnNwbGljZShcbiAgICAgIGluZGljZVZpc2l0YSxcbiAgICAgIDEsXG4gICAgKTtcblxuICAgIGNvbnN0IHJlc3VsdGFkbzogeyBzdWNjZXNzOiBib29sZWFuOyBwcm94aW1hVmlzaXRhQXR1YWxpemFkYT86IERhdGUgfSA9IHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgfTtcblxuICAgIC8vIFNlIGZvciBhIMO6bHRpbWEgdmlzaXRhIG91IHNlIG7Do28gaG91dmVyIG1haXMgdmlzaXRhcywgcmVjYWxjdWxhciBhIHByw7N4aW1hIHZpc2l0YVxuICAgIGlmIChzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy52aXNpdGFzX21vbml0b3JhbWVudG8ubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBTZSBuw6NvIGhvdXZlciBtYWlzIHZpc2l0YXMsIGEgcHLDs3hpbWEgdmlzaXRhIGRldmUgc2VyIGNhbGN1bGFkYSBhIHBhcnRpciBkYSBkYXRhIGF0dWFsXG4gICAgICBjb25zdCBwcm94aW1hVmlzaXRhID0gdGhpcy5jYWxjdWxhclByb3hpbWFWaXNpdGEoKTtcbiAgICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLnByb3hpbWFfdmlzaXRhX21vbml0b3JhbWVudG8gPVxuICAgICAgICBwcm94aW1hVmlzaXRhO1xuICAgICAgcmVzdWx0YWRvLnByb3hpbWFWaXNpdGFBdHVhbGl6YWRhID0gcHJveGltYVZpc2l0YTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgaW5kaWNlVmlzaXRhID09PVxuICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aFxuICAgICkge1xuICAgICAgLy8gU2UgYSB2aXNpdGEgcmVtb3ZpZGEgZXJhIGEgw7psdGltYSwgYSBwcsOzeGltYSB2aXNpdGEgZGV2ZSBzZXIgYmFzZWFkYSBuYSBub3ZhIMO6bHRpbWEgdmlzaXRhXG4gICAgICBjb25zdCB1bHRpbWFWaXNpdGEgPVxuICAgICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy52aXNpdGFzX21vbml0b3JhbWVudG9bXG4gICAgICAgICAgc29saWNpdGFjYW8uZGFkb3NfY29tcGxlbWVudGFyZXMudmlzaXRhc19tb25pdG9yYW1lbnRvLmxlbmd0aCAtIDFcbiAgICAgICAgXTtcbiAgICAgIGNvbnN0IHByb3hpbWFWaXNpdGEgPSB0aGlzLmNhbGN1bGFyUHJveGltYVZpc2l0YShcbiAgICAgICAgbmV3IERhdGUodWx0aW1hVmlzaXRhLmRhdGEpLFxuICAgICAgKTtcbiAgICAgIHNvbGljaXRhY2FvLmRhZG9zX2NvbXBsZW1lbnRhcmVzLnByb3hpbWFfdmlzaXRhX21vbml0b3JhbWVudG8gPVxuICAgICAgICBwcm94aW1hVmlzaXRhO1xuICAgICAgcmVzdWx0YWRvLnByb3hpbWFWaXNpdGFBdHVhbGl6YWRhID0gcHJveGltYVZpc2l0YTtcbiAgICB9XG5cbiAgICAvLyBTYWx2YXIgYXMgYWx0ZXJhw6fDtWVzXG4gICAgYXdhaXQgdGhpcy5zb2xpY2l0YWNhb1JlcG9zaXRvcnkuc2F2ZShzb2xpY2l0YWNhbyk7XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgVmlzaXRhIGRlIG1vbml0b3JhbWVudG8gcmVtb3ZpZGEgcGFyYSBzb2xpY2l0YcOnw6NvICR7c29saWNpdGFjYW9JZH0sIMOtbmRpY2UgJHtpbmRpY2VWaXNpdGF9YCxcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlc3VsdGFkbztcbiAgfVxuXG4gIC8qKlxuICAgKiBUYXJlZmEgYWdlbmRhZGEgcGFyYSBleGVjdXRhciBkaWFyaWFtZW50ZSBlIHZlcmlmaWNhciBzb2xpY2l0YcOnw7VlcyBxdWUgcHJlY2lzYW0gZGUgbW9uaXRvcmFtZW50b1xuICAgKi9cbiAgQENyb24oQ3JvbkV4cHJlc3Npb24uRVZFUllfREFZX0FUX01JRE5JR0hUKVxuICBhc3luYyB2ZXJpZmljYXJNb25pdG9yYW1lbnRvT2JyaWdhdG9yaW8oKSB7XG4gICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgJ0luaWNpYW5kbyB2ZXJpZmljYcOnw6NvIGRpw6FyaWEgZGUgbW9uaXRvcmFtZW50byBwYXJhIEFsdWd1ZWwgU29jaWFsJyxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIE9idGVyIHNvbGljaXRhw6fDtWVzIHF1ZSBqw6EgdWx0cmFwYXNzYXJhbSBhIGRhdGEgZGUgbW9uaXRvcmFtZW50b1xuICAgICAgY29uc3Qgc29saWNpdGFjb2VzUGFyYU1vbml0b3JhbWVudG8gPVxuICAgICAgICBhd2FpdCB0aGlzLmdldFNvbGljaXRhY29lc1BhcmFNb25pdG9yYW1lbnRvKCk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYEVuY29udHJhZGFzICR7c29saWNpdGFjb2VzUGFyYU1vbml0b3JhbWVudG8ubGVuZ3RofSBzb2xpY2l0YcOnw7VlcyBxdWUgcHJlY2lzYW0gZGUgbW9uaXRvcmFtZW50b2AsXG4gICAgICApO1xuXG4gICAgICAvLyBFbnZpYXIgbm90aWZpY2HDp8O1ZXMgcGFyYSBzb2xpY2l0YcOnw7VlcyBjb20gdmlzaXRhcyBwZW5kZW50ZXNcbiAgICAgIGZvciAoY29uc3Qgc29saWNpdGFjYW8gb2Ygc29saWNpdGFjb2VzUGFyYU1vbml0b3JhbWVudG8pIHtcbiAgICAgICAgY29uc3QgZGF0YUxpbWl0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHRoaXMubm90aWZpY2FjYW9TZXJ2aWNlLm5vdGlmaWNhck1vbml0b3JhbWVudG9QZW5kZW50ZShcbiAgICAgICAgICBzb2xpY2l0YWNhbyxcbiAgICAgICAgICBkYXRhTGltaXRlLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBPYnRlciBzb2xpY2l0YcOnw7VlcyBjb20gYWxlcnRhcyBkZSBtb25pdG9yYW1lbnRvIHByw7N4aW1vXG4gICAgICBjb25zdCBzb2xpY2l0YWNvZXNDb21BbGVydGEgPVxuICAgICAgICBhd2FpdCB0aGlzLmdldFNvbGljaXRhY29lc0NvbUFsZXJ0YU1vbml0b3JhbWVudG8oKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgRW5jb250cmFkYXMgJHtzb2xpY2l0YWNvZXNDb21BbGVydGEubGVuZ3RofSBzb2xpY2l0YcOnw7VlcyBjb20gYWxlcnRhIGRlIG1vbml0b3JhbWVudG8gcHLDs3hpbW9gLFxuICAgICAgKTtcblxuICAgICAgLy8gRW52aWFyIG5vdGlmaWNhw6fDtWVzIHBhcmEgc29saWNpdGHDp8O1ZXMgY29tIHZpc2l0YXMgcHJvZ3JhbWFkYXMgZW0gYnJldmVcbiAgICAgIGZvciAoY29uc3Qgc29saWNpdGFjYW8gb2Ygc29saWNpdGFjb2VzQ29tQWxlcnRhKSB7XG4gICAgICAgIGlmIChzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcz8ucHJveGltYV92aXNpdGFfbW9uaXRvcmFtZW50bykge1xuICAgICAgICAgIGNvbnN0IGRhdGFQcm94aW1hVmlzaXRhID0gbmV3IERhdGUoXG4gICAgICAgICAgICBzb2xpY2l0YWNhby5kYWRvc19jb21wbGVtZW50YXJlcy5wcm94aW1hX3Zpc2l0YV9tb25pdG9yYW1lbnRvLFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgaG9qZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgY29uc3QgZGlhc1Jlc3RhbnRlcyA9IE1hdGguY2VpbChcbiAgICAgICAgICAgIChkYXRhUHJveGltYVZpc2l0YS5nZXRUaW1lKCkgLSBob2plLmdldFRpbWUoKSkgL1xuICAgICAgICAgICAgICAoMTAwMCAqIDYwICogNjAgKiAyNCksXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHRoaXMubm90aWZpY2FjYW9TZXJ2aWNlLm5vdGlmaWNhck1vbml0b3JhbWVudG9Qcm94aW1vKFxuICAgICAgICAgICAgc29saWNpdGFjYW8sXG4gICAgICAgICAgICBkYXRhUHJveGltYVZpc2l0YSxcbiAgICAgICAgICAgIGRpYXNSZXN0YW50ZXMsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coJ1ZlcmlmaWNhw6fDo28gZGUgbW9uaXRvcmFtZW50byBjb25jbHXDrWRhIGNvbSBzdWNlc3NvJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAnRXJybyBhbyB2ZXJpZmljYXIgbW9uaXRvcmFtZW50byBvYnJpZ2F0w7NyaW8nLFxuICAgICAgICBlcnJvci5zdGFjayxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=