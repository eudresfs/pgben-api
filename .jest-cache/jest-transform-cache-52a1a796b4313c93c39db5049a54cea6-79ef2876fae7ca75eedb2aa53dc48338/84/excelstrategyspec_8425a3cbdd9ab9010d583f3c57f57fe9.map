{"file":"C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\relatorios-unificado\\__tests__\\excel.strategy.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\eudre\\OneDrive\\Desktop\\Projetos\\pgben\\pgben-server\\src\\modules\\relatorios-unificado\\__tests__\\excel.strategy.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { ExcelStrategy } from '../strategies/excel.strategy';\nimport { TempFilesService } from '../services/temp-files.service';\nimport * as fs from 'fs';\n\n/**\n * Testes unitários para a estratégia de relatórios em Excel\n *\n * Este arquivo contém testes que validam a funcionalidade da estratégia\n * responsável por gerar relatórios em formato Excel\n */\ndescribe('ExcelStrategy', () => {\n  let strategy: ExcelStrategy;\n  let tempFilesService: TempFilesService;\n\n  // Mock para fs e Excel\n  const mockWorkbook = {\n    addWorksheet: jest.fn().mockImplementation(() => mockWorksheet),\n    xlsx: {\n      writeFile: jest.fn().mockImplementation((path, callback) => {\n        if (callback) {\n          callback();\n        }\n        return Promise.resolve();\n      }),\n    },\n  };\n\n  const mockWorksheet = {\n    columns: [],\n    addRow: jest.fn(),\n    addRows: jest.fn(),\n    mergeCells: jest.fn(),\n    getCell: jest.fn().mockReturnValue({\n      style: {},\n      value: null,\n      alignment: { vertical: null, horizontal: null },\n    }),\n    getRow: jest.fn().mockReturnValue({\n      font: { bold: false },\n      alignment: { vertical: null, horizontal: null },\n      eachCell: jest.fn().mockImplementation((options, callback) => {\n        callback(\n          {\n            style: {},\n            value: null,\n            alignment: { vertical: null, horizontal: null },\n          },\n          1,\n        );\n      }),\n    }),\n    eachRow: jest.fn().mockImplementation((options, callback) => {\n      callback(\n        {\n          eachCell: jest.fn().mockImplementation((options, callback) => {\n            callback(\n              {\n                style: {},\n                value: null,\n                alignment: { vertical: null, horizontal: null },\n              },\n              1,\n            );\n          }),\n          number: 1,\n        },\n        1,\n      );\n    }),\n  };\n\n  // Mock para ExcelJS\n  jest.mock('exceljs', () => {\n    return {\n      Workbook: jest.fn().mockImplementation(() => mockWorkbook),\n    };\n  });\n\n  jest.mock('fs', () => ({\n    readFileSync: jest.fn().mockReturnValue(Buffer.from('mock excel content')),\n    promises: {\n      unlink: jest.fn(),\n    },\n  }));\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        ExcelStrategy,\n        {\n          provide: TempFilesService,\n          useValue: {\n            getTempFilePath: jest\n              .fn()\n              .mockReturnValue('temp/relatorios/test-123.xlsx'),\n            cleanupTempFile: jest.fn().mockResolvedValue(undefined),\n          },\n        },\n      ],\n    }).compile();\n\n    strategy = module.get<ExcelStrategy>(ExcelStrategy);\n    tempFilesService = module.get<TempFilesService>(TempFilesService);\n\n    // Reset mocks antes de cada teste\n    jest.clearAllMocks();\n  });\n\n  it('deve ser definido', () => {\n    expect(strategy).toBeDefined();\n  });\n\n  describe('gerar', () => {\n    it('deve gerar um relatório Excel e retornar um buffer', async () => {\n      const tipo = 'beneficios';\n      const dados = {\n        titulo: 'Relatório de Benefícios',\n        cabecalho: { data: '01/01/2025' },\n        itens: [{ id: 1, nome: 'Benefício Teste', valor: 100 }],\n      };\n      const opcoes = { orientacao: 'retrato', tamanho: 'A4' };\n\n      const result = await strategy.gerar(tipo, dados, opcoes);\n\n      expect(result).toBeInstanceOf(Buffer);\n      expect(tempFilesService.getTempFilePath).toHaveBeenCalledWith(\n        expect.stringContaining('relatorio'),\n        'xlsx',\n      );\n      expect(tempFilesService.cleanupTempFile).toHaveBeenCalledWith(\n        expect.stringContaining('temp/relatorios/test-123.xlsx'),\n      );\n      expect(mockWorkbook.addWorksheet).toHaveBeenCalled();\n      expect(mockWorkbook.xlsx.writeFile).toHaveBeenCalledWith(\n        expect.stringContaining('temp/relatorios/test-123.xlsx'),\n        expect.anything(),\n      );\n    });\n\n    it('deve gerar relatório de benefícios corretamente', async () => {\n      const tipo = 'beneficios';\n      const dados = {\n        titulo: 'Relatório de Benefícios Concedidos',\n        periodo: '01/01/2025 a 31/01/2025',\n        unidade: 'Unidade Teste',\n        tipoBeneficio: 'Auxílio Moradia',\n        itens: [\n          { id: 1, nome: 'Benefício 1', data: '01/01/2025', valor: 100 },\n          { id: 2, nome: 'Benefício 2', data: '15/01/2025', valor: 200 },\n        ],\n        total: 300,\n      };\n      const opcoes = {};\n\n      await strategy.gerar(tipo, dados, opcoes);\n\n      expect(mockWorkbook.addWorksheet).toHaveBeenCalledWith(\n        'Benefícios Concedidos',\n      );\n      expect(mockWorksheet.addRow).toHaveBeenCalled();\n      expect(mockWorksheet.addRows).toHaveBeenCalled();\n    });\n\n    it('deve gerar relatório de solicitações corretamente', async () => {\n      const tipo = 'solicitacoes';\n      const dados = {\n        titulo: 'Relatório de Solicitações por Status',\n        periodo: '01/01/2025 a 31/01/2025',\n        unidade: 'Unidade Teste',\n        itens: [\n          { status: 'Pendente', quantidade: 10 },\n          { status: 'Aprovado', quantidade: 20 },\n          { status: 'Reprovado', quantidade: 5 },\n        ],\n        total: 35,\n      };\n      const opcoes = {};\n\n      await strategy.gerar(tipo, dados, opcoes);\n\n      expect(mockWorkbook.addWorksheet).toHaveBeenCalledWith(\n        'Solicitações por Status',\n      );\n      expect(mockWorksheet.addRow).toHaveBeenCalled();\n      expect(mockWorksheet.addRows).toHaveBeenCalled();\n    });\n\n    it('deve gerar relatório de atendimentos corretamente', async () => {\n      const tipo = 'atendimentos';\n      const dados = {\n        titulo: 'Relatório de Atendimentos por Unidade',\n        periodo: '01/01/2025 a 31/01/2025',\n        itens: [\n          {\n            unidade: 'Unidade A',\n            totalSolicitacoes: 15,\n            solicitacoesLiberadas: 10,\n            solicitacoesPendentes: 5,\n          },\n          {\n            unidade: 'Unidade B',\n            totalSolicitacoes: 20,\n            solicitacoesLiberadas: 15,\n            solicitacoesPendentes: 5,\n          },\n        ],\n        totais: {\n          totalSolicitacoes: 35,\n          solicitacoesLiberadas: 25,\n          solicitacoesPendentes: 10,\n        },\n      };\n      const opcoes = {};\n\n      await strategy.gerar(tipo, dados, opcoes);\n\n      expect(mockWorkbook.addWorksheet).toHaveBeenCalledWith(\n        'Atendimentos por Unidade',\n      );\n      expect(mockWorksheet.addRow).toHaveBeenCalled();\n      expect(mockWorksheet.addRows).toHaveBeenCalled();\n    });\n\n    it('deve lidar com erros corretamente', async () => {\n      const mockError = new Error('Erro ao gerar Excel');\n      mockWorkbook.xlsx.writeFile.mockRejectedValueOnce(mockError);\n\n      const tipo = 'beneficios';\n      const dados = { titulo: 'Teste', itens: [] };\n      const opcoes = {};\n\n      await expect(strategy.gerar(tipo, dados, opcoes)).rejects.toThrow(\n        'Erro ao gerar Excel',\n      );\n\n      expect(tempFilesService.cleanupTempFile).toHaveBeenCalledWith(\n        expect.stringContaining('temp/relatorios/test-123.xlsx'),\n      );\n    });\n  });\n});\n"],"version":3}