import { DataSource } from 'typeorm';
import {
  NotificationTemplate,
  CanalNotificacao,
} from '../../../entities/notification-template.entity';

/**
 * Seed para templates de notifica√ß√£o espec√≠ficos de solicita√ß√µes
 * 
 * Cria templates para eventos relacionados ao workflow de solicita√ß√µes:
 * - Aprova√ß√£o/Rejei√ß√£o de solicita√ß√µes
 * - Cria√ß√£o e resolu√ß√£o de pend√™ncias
 * - Cancelamento e suspens√£o
 */
export class SolicitacaoNotificationTemplateSeed {
  public static async run(dataSource: DataSource): Promise<void> {
    console.log('Iniciando seed de templates de notifica√ß√£o para solicita√ß√µes...');

    try {
      const templateRepository = dataSource.getRepository(NotificationTemplate);

      // Array com todos os templates de solicita√ß√£o
      const templates = [
        {
          codigo: 'solicitacao-aprovada',
          nome: 'Solicita√ß√£o Aprovada',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma solicita√ß√£o √© aprovada',
          assunto: 'Solicita√ß√£o {{numero_protocolo}} - Aprovada',
          corpo: 'Sua solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi aprovada. Observa√ß√µes: {{observacoes}}',
          corpo_html: `
            <h2>‚úÖ Solicita√ß√£o Aprovada!</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Temos uma √≥tima not√≠cia! Sua solicita√ß√£o foi <strong>aprovada</strong>.</p>
            <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Aprova√ß√£o:</strong> {{data_aprovacao}}</p>
              <p><strong>üë§ Aprovado por:</strong> {{nome_tecnico}}</p>
            </div>
            {{#if observacoes}}
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Observa√ß√µes:</strong></p>
              <p>{{observacoes}}</p>
            </div>
            {{/if}}
            <p><a href="{{link_solicitacao}}" style="background-color: #28a745; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Detalhes da Solicita√ß√£o</a></p>
            <p><small>Data de envio: {{data_envio}}</small></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio', 
            'data_aprovacao', 'nome_tecnico', 'observacoes', 
            'link_solicitacao', 'data_envio'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'alta'
        },
        {
          codigo: 'solicitacao-indeferida',
          nome: 'Solicita√ß√£o Indeferida',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma solicita√ß√£o √© indeferida',
          assunto: 'Solicita√ß√£o {{numero_protocolo}} - Indeferida',
          corpo: 'Sua solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi indeferida. Motivo: {{motivo_rejeicao}}',
          corpo_html: `
            <h2>‚ùå Solicita√ß√£o Indeferida</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Infelizmente, sua solicita√ß√£o foi <strong>indeferida</strong>.</p>
            <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Rejei√ß√£o:</strong> {{data_rejeicao}}</p>
              <p><strong>üë§ Rejeitado por:</strong> {{nome_tecnico}}</p>
            </div>
            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Motivo da Rejei√ß√£o:</strong></p>
              <p>{{motivo_rejeicao}}</p>
            </div>
            <p>Voc√™ pode entrar em contato conosco para esclarecimentos ou submeter uma nova solicita√ß√£o.</p>
            <p><a href="{{link_solicitacao}}" style="background-color: #dc3545; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Detalhes</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_rejeicao', 'nome_tecnico', 'motivo_rejeicao',
            'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'alta'
        },
        {
          codigo: 'solicitacao-cancelada',
          nome: 'Solicita√ß√£o Cancelada',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma solicita√ß√£o √© cancelada',
          assunto: 'Solicita√ß√£o {{numero_protocolo}} - Cancelada',
          corpo: 'Sua solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi cancelada. Motivo: {{motivo_cancelamento}}',
          corpo_html: `
            <h2>üö´ Solicita√ß√£o Cancelada</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Sua solicita√ß√£o foi <strong>cancelada</strong>.</p>
            <div style="background-color: #f8d7da; border-left: 4px solid #6c757d; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Cancelamento:</strong> {{data_cancelamento}}</p>
            </div>
            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Motivo do Cancelamento:</strong></p>
              <p>{{motivo_cancelamento}}</p>
            </div>
            <p><a href="{{link_solicitacao}}" style="background-color: #6c757d; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Detalhes</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_cancelamento', 'motivo_cancelamento', 'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'normal'
        },
        {
          codigo: 'solicitacao-suspensa',
          nome: 'Solicita√ß√£o Suspensa',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma solicita√ß√£o √© suspensa',
          assunto: 'Solicita√ß√£o {{numero_protocolo}} - Suspensa',
          corpo: 'Sua solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi suspensa. Motivo: {{motivo_suspensao}}',
          corpo_html: `
            <h2>‚è∏Ô∏è Solicita√ß√£o Suspensa</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Sua solicita√ß√£o foi <strong>suspensa temporariamente</strong>.</p>
            <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Suspens√£o:</strong> {{data_suspensao}}</p>
            </div>
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Motivo da Suspens√£o:</strong></p>
              <p>{{motivo_suspensao}}</p>
            </div>
            <p>Entre em contato conosco para mais informa√ß√µes sobre como proceder.</p>
            <p><a href="{{link_solicitacao}}" style="background-color: #ffc107; color: #212529; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Detalhes</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_suspensao', 'motivo_suspensao', 'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'alta'
        },
        {
          codigo: 'solicitacao-bloqueada',
          nome: 'Solicita√ß√£o Bloqueada',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma solicita√ß√£o √© bloqueada',
          assunto: 'Solicita√ß√£o {{numero_protocolo}} - Bloqueada',
          corpo: 'Sua solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi bloqueada. Motivo: {{motivo_bloqueio}}',
          corpo_html: `
            <h2>üîí Solicita√ß√£o Bloqueada</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Sua solicita√ß√£o foi <strong>bloqueada</strong>.</p>
            <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Bloqueio:</strong> {{data_bloqueio}}</p>
            </div>
            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Motivo do Bloqueio:</strong></p>
              <p>{{motivo_bloqueio}}</p>
            </div>
            <p>Entre em contato com nossa equipe para esclarecimentos.</p>
            <p><a href="{{link_solicitacao}}" style="background-color: #dc3545; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Detalhes</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_bloqueio', 'motivo_bloqueio', 'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'alta'
        },
        {
          codigo: 'solicitacao-pendencia',
          nome: 'Pend√™ncia em Solicita√ß√£o',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma pend√™ncia √© criada em uma solicita√ß√£o',
          assunto: 'Pend√™ncia na Solicita√ß√£o {{numero_protocolo}}',
          corpo: 'Foi identificada uma pend√™ncia na solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}}. Descri√ß√£o: {{descricao_pendencia}}',
          corpo_html: `
            <h2>‚ö†Ô∏è Pend√™ncia Identificada</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>Foi identificada uma <strong>pend√™ncia</strong> em sua solicita√ß√£o que precisa ser resolvida.</p>
            <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data da Pend√™ncia:</strong> {{data_pendencia}}</p>
              <p><strong>üë§ Identificado por:</strong> {{nome_tecnico}}</p>
            </div>
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Descri√ß√£o da Pend√™ncia:</strong></p>
              <p>{{descricao_pendencia}}</p>
              {{#if observacoes}}
              <p><strong>Observa√ß√µes:</strong> {{observacoes}}</p>
              {{/if}}
            </div>
            <p>Por favor, providencie a documenta√ß√£o ou informa√ß√£o solicitada o mais breve poss√≠vel.</p>
            <p><a href="{{link_solicitacao}}" style="background-color: #ffc107; color: #212529; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Resolver Pend√™ncia</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_pendencia', 'nome_tecnico', 'descricao_pendencia',
            'observacoes', 'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'alta'
        },
        {
          codigo: 'solicitacao-pendencia-resolvida',
          nome: 'Pend√™ncia Resolvida',
          tipo: 'solicitacao',
          descricao: 'Template para notificar quando uma pend√™ncia √© resolvida',
          assunto: 'Pend√™ncia Resolvida - Solicita√ß√£o {{numero_protocolo}}',
          corpo: 'A pend√™ncia da solicita√ß√£o {{numero_protocolo}} para {{tipo_beneficio}} foi resolvida. Observa√ß√µes: {{observacoes_resolucao}}',
          corpo_html: `
            <h2>‚úÖ Pend√™ncia Resolvida</h2>
            <p>Ol√° <strong>{{nome_cidadao}}</strong>,</p>
            <p>A pend√™ncia em sua solicita√ß√£o foi <strong>resolvida</strong> com sucesso!</p>
            <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0;">
              <p><strong>üìã Protocolo:</strong> {{numero_protocolo}}</p>
              <p><strong>üéØ Benef√≠cio:</strong> {{tipo_beneficio}}</p>
              <p><strong>üìÖ Data de Resolu√ß√£o:</strong> {{data_resolucao}}</p>
              <p><strong>üë§ Resolvido por:</strong> {{nome_tecnico}}</p>
            </div>
            {{#if observacoes_resolucao}}
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0;">
              <p><strong>üìù Observa√ß√µes da Resolu√ß√£o:</strong></p>
              <p>{{observacoes_resolucao}}</p>
            </div>
            {{/if}}
            <p>Sua solicita√ß√£o agora pode prosseguir no processo de an√°lise.</p>
            <p><a href="{{link_solicitacao}}" style="background-color: #28a745; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Ver Solicita√ß√£o</a></p>
          `,
          canais_disponiveis: ['email', 'in_app'],
          variaveis_requeridas: JSON.stringify([
            'nome_cidadao', 'numero_protocolo', 'tipo_beneficio',
            'data_resolucao', 'nome_tecnico', 'observacoes_resolucao',
            'link_solicitacao'
          ]),
          ativo: true,
          categoria: 'solicitacao',
          prioridade: 'normal'
        }
      ];

      // Processa cada template
      for (const templateData of templates) {
        // Verifica se o template j√° existe
        const existingTemplate = await templateRepository.findOne({
          where: { codigo: templateData.codigo }
        });

        if (existingTemplate) {
          console.log(`Template '${templateData.codigo}' j√° existe, atualizando...`);
          
          // Atualiza o template existente
          await templateRepository.update(
            { id: existingTemplate.id },
            templateData
          );
        } else {
          console.log(`Criando template '${templateData.codigo}'...`);
          
          // Cria novo template
          const template = templateRepository.create(templateData);
          await templateRepository.save(template);
        }
      }

      console.log(`‚úÖ Seed de templates de notifica√ß√£o para solicita√ß√µes conclu√≠da! ${templates.length} templates processados.`);
    } catch (error) {
      console.error('‚ùå Erro ao executar seed de templates de notifica√ß√£o para solicita√ß√µes:', error);
      throw error;
    }
  }
}